<html>
<head>
<title>test_morestats.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_morestats.py</font>
</center></td></tr></table>
<pre><span class="s0"># Author:  Travis Oliphant, 2002</span>
<span class="s0">#</span>
<span class="s0"># Further enhancements and tests added by numerous SciPy developers.</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">random </span><span class="s2">import </span><span class="s1">RandomState</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_array_equal</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">,</span>
                           <span class="s1">assert_array_less</span><span class="s3">, </span><span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
                           <span class="s1">assert_</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">,</span>
                           <span class="s1">suppress_warnings</span><span class="s3">)</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">optimize</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">, </span><span class="s1">special</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_morestats </span><span class="s2">import </span><span class="s1">_abw_state</span><span class="s3">, </span><span class="s1">_get_As_weibull</span><span class="s3">, </span><span class="s1">_Avals_weibull</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">common_tests </span><span class="s2">import </span><span class="s1">check_named_results</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">_hypotests </span><span class="s2">import </span><span class="s1">_get_wilcoxon_distr</span><span class="s3">, </span><span class="s1">_get_wilcoxon_distr2</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_binomtest </span><span class="s2">import </span><span class="s1">_binary_search_for_binom_tst</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_distr_params </span><span class="s2">import </span><span class="s1">distcont</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_axis_nan_policy </span><span class="s2">import </span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">too_small_nd_omit</span><span class="s3">,</span>
                                          <span class="s1">too_small_1d_omit</span><span class="s3">, </span><span class="s1">too_small_1d_not_omit</span><span class="s3">)</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">conftest </span><span class="s2">import </span><span class="s1">array_api_compatible</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_array_api </span><span class="s2">import </span><span class="s3">(</span><span class="s1">array_namespace</span><span class="s3">, </span><span class="s1">xp_assert_close</span><span class="s3">, </span><span class="s1">xp_assert_less</span><span class="s3">,</span>
                                   <span class="s1">xp_assert_equal</span><span class="s3">, </span><span class="s1">is_numpy</span><span class="s3">)</span>


<span class="s1">skip_xp_backends </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skip_xp_backends</span>

<span class="s1">distcont </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">distcont</span><span class="s3">)  </span><span class="s0"># type: ignore</span>

<span class="s0"># Matplotlib is not a scipy dependency but is optionally used in probplot, so</span>
<span class="s0"># check if it's available</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">matplotlib</span>
    <span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">rcParams</span><span class="s3">[</span><span class="s4">'backend'</span><span class="s3">] = </span><span class="s4">'Agg'</span>
    <span class="s2">import </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>
    <span class="s1">have_matplotlib </span><span class="s3">= </span><span class="s2">True</span>
<span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
    <span class="s1">have_matplotlib </span><span class="s3">= </span><span class="s2">False</span>


<span class="s0"># test data gear.dat from NIST for Levene and Bartlett test</span>
<span class="s0"># https://www.itl.nist.gov/div898/handbook/eda/section3/eda3581.htm</span>
<span class="s1">g1 </span><span class="s3">= [</span><span class="s5">1.006</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">0.992</span><span class="s3">, </span><span class="s5">0.993</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.999</span><span class="s3">, </span><span class="s5">0.994</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">]</span>
<span class="s1">g2 </span><span class="s3">= [</span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">1.006</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">1.006</span><span class="s3">, </span><span class="s5">0.988</span><span class="s3">]</span>
<span class="s1">g3 </span><span class="s3">= [</span><span class="s5">0.991</span><span class="s3">, </span><span class="s5">0.987</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">, </span><span class="s5">0.999</span><span class="s3">, </span><span class="s5">0.995</span><span class="s3">, </span><span class="s5">0.994</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">0.999</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">]</span>
<span class="s1">g4 </span><span class="s3">= [</span><span class="s5">1.005</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.994</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">0.995</span><span class="s3">, </span><span class="s5">0.994</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">]</span>
<span class="s1">g5 </span><span class="s3">= [</span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.982</span><span class="s3">, </span><span class="s5">0.990</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.984</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">0.993</span><span class="s3">, </span><span class="s5">0.980</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">]</span>
<span class="s1">g6 </span><span class="s3">= [</span><span class="s5">1.009</span><span class="s3">, </span><span class="s5">1.013</span><span class="s3">, </span><span class="s5">1.009</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">, </span><span class="s5">0.988</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.995</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.981</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">]</span>
<span class="s1">g7 </span><span class="s3">= [</span><span class="s5">0.990</span><span class="s3">, </span><span class="s5">1.004</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.001</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">1.018</span><span class="s3">, </span><span class="s5">1.010</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">]</span>
<span class="s1">g8 </span><span class="s3">= [</span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">1.006</span><span class="s3">, </span><span class="s5">1.000</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">1.006</span><span class="s3">]</span>
<span class="s1">g9 </span><span class="s3">= [</span><span class="s5">1.002</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">0.995</span><span class="s3">, </span><span class="s5">0.996</span><span class="s3">, </span><span class="s5">1.004</span><span class="s3">, </span><span class="s5">1.004</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">0.999</span><span class="s3">, </span><span class="s5">0.991</span><span class="s3">]</span>
<span class="s1">g10 </span><span class="s3">= [</span><span class="s5">0.991</span><span class="s3">, </span><span class="s5">0.995</span><span class="s3">, </span><span class="s5">0.984</span><span class="s3">, </span><span class="s5">0.994</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">, </span><span class="s5">0.991</span><span class="s3">, </span><span class="s5">0.998</span><span class="s3">, </span><span class="s5">1.004</span><span class="s3">, </span><span class="s5">0.997</span><span class="s3">]</span>


<span class="s0"># The loggamma RVS stream is changing due to gh-13349; this version</span>
<span class="s0"># preserves the old stream so that tests don't change.</span>
<span class="s2">def </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestBayes_mvs</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Expected values in this test simply taken from the function.  For</span>
        <span class="s0"># some checks regarding correctness of implementation, see review in</span>
        <span class="s0"># gh-674</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">6</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">13</span><span class="s3">]</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">std </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bayes_mvs</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">9.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">.</span><span class="s1">minmax</span><span class="s3">, (</span><span class="s5">7.103650222492964</span><span class="s3">, </span><span class="s5">10.896349777507034</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">minmax</span><span class="s3">, (</span><span class="s5">3.1767242068607087</span><span class="s3">, </span><span class="s5">24.45910381334018</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-09</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">std</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">2.9724954732045084</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">14</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">std</span><span class="s3">.</span><span class="s1">minmax</span><span class="s3">, (</span><span class="s5">1.7823367265645145</span><span class="s3">, </span><span class="s5">4.9456146050146312</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bayes_mvs</span><span class="s3">, [])</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">15</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'minmax'</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bayes_mvs</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">res</span><span class="s3">:</span>
            <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMvsdist</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">6</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">13</span><span class="s3">]</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">std </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mvsdist</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s5">9.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">.</span><span class="s1">interval</span><span class="s3">(</span><span class="s5">0.9</span><span class="s3">), (</span><span class="s5">7.103650222492964</span><span class="s3">,</span>
                                             <span class="s5">10.896349777507034</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s5">10.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">interval</span><span class="s3">(</span><span class="s5">0.9</span><span class="s3">), (</span><span class="s5">3.1767242068607087</span><span class="s3">,</span>
                                            <span class="s5">24.45910381334018</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-09</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">std</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s5">2.9724954732045084</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">14</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">std</span><span class="s3">.</span><span class="s1">interval</span><span class="s3">(</span><span class="s5">0.9</span><span class="s3">), (</span><span class="s5">1.7823367265645145</span><span class="s3">,</span>
                                            <span class="s5">4.9456146050146312</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mvsdist</span><span class="s3">, [])</span>

    <span class="s2">def </span><span class="s1">test_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError if fewer than two data points are given.</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mvsdist</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_warns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># regression test for gh-5270</span>
        <span class="s0"># make sure there are no spurious divide-by-zero warnings</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s4">'error'</span><span class="s3">, </span><span class="s1">RuntimeWarning</span><span class="s3">)</span>
            <span class="s3">[</span><span class="s1">x</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">() </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mvsdist</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])]</span>
            <span class="s3">[</span><span class="s1">x</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">() </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mvsdist</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])]</span>


<span class="s2">class </span><span class="s1">TestShapiro</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x1 </span><span class="s3">= [</span><span class="s5">0.11</span><span class="s3">, </span><span class="s5">7.87</span><span class="s3">, </span><span class="s5">4.61</span><span class="s3">, </span><span class="s5">10.14</span><span class="s3">, </span><span class="s5">7.95</span><span class="s3">, </span><span class="s5">3.14</span><span class="s3">, </span><span class="s5">0.46</span><span class="s3">,</span>
              <span class="s5">4.43</span><span class="s3">, </span><span class="s5">0.21</span><span class="s3">, </span><span class="s5">4.75</span><span class="s3">, </span><span class="s5">0.71</span><span class="s3">, </span><span class="s5">1.52</span><span class="s3">, </span><span class="s5">3.24</span><span class="s3">,</span>
              <span class="s5">0.93</span><span class="s3">, </span><span class="s5">0.42</span><span class="s3">, </span><span class="s5">4.97</span><span class="s3">, </span><span class="s5">9.53</span><span class="s3">, </span><span class="s5">4.55</span><span class="s3">, </span><span class="s5">0.47</span><span class="s3">, </span><span class="s5">6.66</span><span class="s3">]</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">0.90047299861907959</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.90047299861907959</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s5">0.042089745402336121</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.042089745402336121</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s1">x2 </span><span class="s3">= [</span><span class="s5">1.36</span><span class="s3">, </span><span class="s5">1.14</span><span class="s3">, </span><span class="s5">2.92</span><span class="s3">, </span><span class="s5">2.55</span><span class="s3">, </span><span class="s5">1.46</span><span class="s3">, </span><span class="s5">1.06</span><span class="s3">, </span><span class="s5">5.27</span><span class="s3">, -</span><span class="s5">1.11</span><span class="s3">,</span>
              <span class="s5">3.48</span><span class="s3">, </span><span class="s5">1.10</span><span class="s3">, </span><span class="s5">0.88</span><span class="s3">, -</span><span class="s5">0.51</span><span class="s3">, </span><span class="s5">1.46</span><span class="s3">, </span><span class="s5">0.52</span><span class="s3">, </span><span class="s5">6.20</span><span class="s3">, </span><span class="s5">1.69</span><span class="s3">,</span>
              <span class="s5">0.08</span><span class="s3">, </span><span class="s5">3.67</span><span class="s3">, </span><span class="s5">2.81</span><span class="s3">, </span><span class="s5">3.49</span><span class="s3">]</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">0.9590270</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.9590270</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s5">0.52460</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.52460</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>

        <span class="s0"># Verified against R</span>
        <span class="s1">x3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345678</span><span class="s3">)</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x3</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x3</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">0.9772805571556091</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.9772805571556091</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s5">0.08144091814756393</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.08144091814756393</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>

        <span class="s0"># Extracted from original paper</span>
        <span class="s1">x4 </span><span class="s3">= [</span><span class="s5">0.139</span><span class="s3">, </span><span class="s5">0.157</span><span class="s3">, </span><span class="s5">0.175</span><span class="s3">, </span><span class="s5">0.256</span><span class="s3">, </span><span class="s5">0.344</span><span class="s3">, </span><span class="s5">0.413</span><span class="s3">, </span><span class="s5">0.503</span><span class="s3">, </span><span class="s5">0.577</span><span class="s3">, </span><span class="s5">0.614</span><span class="s3">,</span>
              <span class="s5">0.655</span><span class="s3">, </span><span class="s5">0.954</span><span class="s3">, </span><span class="s5">1.392</span><span class="s3">, </span><span class="s5">1.557</span><span class="s3">, </span><span class="s5">1.648</span><span class="s3">, </span><span class="s5">1.690</span><span class="s3">, </span><span class="s5">1.994</span><span class="s3">, </span><span class="s5">2.174</span><span class="s3">, </span><span class="s5">2.206</span><span class="s3">,</span>
              <span class="s5">3.245</span><span class="s3">, </span><span class="s5">3.510</span><span class="s3">, </span><span class="s5">3.571</span><span class="s3">, </span><span class="s5">4.354</span><span class="s3">, </span><span class="s5">4.980</span><span class="s3">, </span><span class="s5">6.084</span><span class="s3">, </span><span class="s5">8.351</span><span class="s3">]</span>
        <span class="s1">W_expected </span><span class="s3">= </span><span class="s5">0.83467</span>
        <span class="s1">p_expected </span><span class="s3">= </span><span class="s5">0.000914</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x4</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x4</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">W_expected</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">W_expected</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s1">p_expected</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">p_expected</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x1 </span><span class="s3">= [[</span><span class="s5">0.11</span><span class="s3">, </span><span class="s5">7.87</span><span class="s3">, </span><span class="s5">4.61</span><span class="s3">, </span><span class="s5">10.14</span><span class="s3">, </span><span class="s5">7.95</span><span class="s3">, </span><span class="s5">3.14</span><span class="s3">, </span><span class="s5">0.46</span><span class="s3">,</span>
              <span class="s5">4.43</span><span class="s3">, </span><span class="s5">0.21</span><span class="s3">, </span><span class="s5">4.75</span><span class="s3">], [</span><span class="s5">0.71</span><span class="s3">, </span><span class="s5">1.52</span><span class="s3">, </span><span class="s5">3.24</span><span class="s3">,</span>
              <span class="s5">0.93</span><span class="s3">, </span><span class="s5">0.42</span><span class="s3">, </span><span class="s5">4.97</span><span class="s3">, </span><span class="s5">9.53</span><span class="s3">, </span><span class="s5">4.55</span><span class="s3">, </span><span class="s5">0.47</span><span class="s3">, </span><span class="s5">6.66</span><span class="s3">]]</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">0.90047299861907959</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.90047299861907959</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s5">0.042089745402336121</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.042089745402336121</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s1">x2 </span><span class="s3">= [[</span><span class="s5">1.36</span><span class="s3">, </span><span class="s5">1.14</span><span class="s3">, </span><span class="s5">2.92</span><span class="s3">, </span><span class="s5">2.55</span><span class="s3">, </span><span class="s5">1.46</span><span class="s3">, </span><span class="s5">1.06</span><span class="s3">, </span><span class="s5">5.27</span><span class="s3">, -</span><span class="s5">1.11</span><span class="s3">,</span>
              <span class="s5">3.48</span><span class="s3">, </span><span class="s5">1.10</span><span class="s3">], [</span><span class="s5">0.88</span><span class="s3">, -</span><span class="s5">0.51</span><span class="s3">, </span><span class="s5">1.46</span><span class="s3">, </span><span class="s5">0.52</span><span class="s3">, </span><span class="s5">6.20</span><span class="s3">, </span><span class="s5">1.69</span><span class="s3">,</span>
              <span class="s5">0.08</span><span class="s3">, </span><span class="s5">3.67</span><span class="s3">, </span><span class="s5">2.81</span><span class="s3">, </span><span class="s5">3.49</span><span class="s3">]]</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">0.9590270</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.9590270</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s5">0.52460</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.52460</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, ([], [</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]))</span>
    <span class="s2">def </span><span class="s1">test_not_enough_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nan_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10.</span><span class="s3">)</span>
        <span class="s1">x</span><span class="s3">[</span><span class="s5">9</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

        <span class="s1">w</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">shapiro_test </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s0"># Originally, shapiro returned a p-value of 1 in this case,</span>
        <span class="s0"># but there is no way to produce a numerical p-value if the</span>
        <span class="s0"># statistic is not a number. NaN is more appropriate.</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pw</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">shapiro_test</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gh14462</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># shapiro is theoretically location-invariant, but when the magnitude</span>
        <span class="s0"># of the values is much greater than the variance, there can be</span>
        <span class="s0"># numerical issues. Fixed by subtracting median from the data.</span>
        <span class="s0"># See gh-14462.</span>

        <span class="s1">trans_val</span><span class="s3">, </span><span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">([</span><span class="s5">122500</span><span class="s3">, </span><span class="s5">474400</span><span class="s3">, </span><span class="s5">110400</span><span class="s3">])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">trans_val</span><span class="s3">)</span>

        <span class="s0"># Reference from R:</span>
        <span class="s0"># options(digits=16)</span>
        <span class="s0"># x = c(0.00000000e+00, 3.39996924e-08, -6.35166875e-09)</span>
        <span class="s0"># shapiro.test(x)</span>
        <span class="s1">ref </span><span class="s3">= (</span><span class="s5">0.86468431705371</span><span class="s3">, </span><span class="s5">0.2805581751566</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_length_3_gh18322</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># gh-18322 reported that the p-value could be negative for input of</span>
        <span class="s0"># length 3. Check that this is resolved.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">([</span><span class="s5">0.6931471805599453</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue </span><span class="s3">&gt;= </span><span class="s5">0</span>

        <span class="s0"># R `shapiro.test` doesn't produce an accurate p-value in the case</span>
        <span class="s0"># above. Check that the formula used in `stats.shapiro` is not wrong.</span>
        <span class="s0"># options(digits=16)</span>
        <span class="s0"># x = c(-0.7746653110021126, -0.4344432067942129, 1.8157053280290931)</span>
        <span class="s0"># shapiro.test(x)</span>
        <span class="s1">x </span><span class="s3">= [-</span><span class="s5">0.7746653110021126</span><span class="s3">, -</span><span class="s5">0.4344432067942129</span><span class="s3">, </span><span class="s5">1.8157053280290931</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shapiro</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.84658770645509</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.2313666489882</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestAnderson</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_normal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234567890</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">standard_exponential</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">crit</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">:])</span>

        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">v</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0</span>
        <span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
        <span class="s0"># The expected statistic 3.208057 was computed independently of scipy.</span>
        <span class="s0"># For example, in R:</span>
        <span class="s0">#   &gt; library(nortest)</span>
        <span class="s0">#   &gt; v &lt;- rep(1, 10)</span>
        <span class="s0">#   &gt; v[1] &lt;- 0</span>
        <span class="s0">#   &gt; result &lt;- ad.test(v)</span>
        <span class="s0">#   &gt; result$statistic</span>
        <span class="s0">#          A</span>
        <span class="s0">#   3.208057</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s5">3.208057</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_expon</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234567890</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">standard_exponential</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s4">'expon'</span><span class="s3">)</span>
        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">:])</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
            <span class="s1">A</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s4">'expon'</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">A </span><span class="s3">&gt; </span><span class="s1">crit</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_gumbel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-6306.  Before that issue was fixed,</span>
        <span class="s0"># this case would return a2=inf.</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">v</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0.0</span>
        <span class="s1">a2</span><span class="s3">, </span><span class="s1">crit</span><span class="s3">, </span><span class="s1">sig </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s4">'gumbel'</span><span class="s3">)</span>
        <span class="s0"># A brief reimplementation of the calculation of the statistic.</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
        <span class="s1">xbar</span><span class="s3">, </span><span class="s1">s </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">gumbel_l</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
        <span class="s1">logcdf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">gumbel_l</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">xbar</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>
        <span class="s1">logsf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">gumbel_l</span><span class="s3">.</span><span class="s1">logsf</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">xbar</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">expected_a2 </span><span class="s3">= -</span><span class="s1">n </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">((</span><span class="s5">2</span><span class="s3">*</span><span class="s1">i </span><span class="s3">- </span><span class="s5">1</span><span class="s3">) * (</span><span class="s1">logcdf </span><span class="s3">+ </span><span class="s1">logsf</span><span class="s3">[::-</span><span class="s5">1</span><span class="s3">]))</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">a2</span><span class="s3">, </span><span class="s1">expected_a2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">], </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">'plate_of_shrimp'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234567890</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">standard_exponential</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'critical_values'</span><span class="s3">, </span><span class="s4">'significance_level'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gumbel_l</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># gh-2592, gh-6337</span>
        <span class="s0"># Adds support to 'gumbel_r' and 'gumbel_l' as valid inputs for dist.</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234567890</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">gumbel</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">A1</span><span class="s3">, </span><span class="s1">crit1</span><span class="s3">, </span><span class="s1">sig1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'gumbel'</span><span class="s3">)</span>
        <span class="s1">A2</span><span class="s3">, </span><span class="s1">crit2</span><span class="s3">, </span><span class="s1">sig2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'gumbel_l'</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">A2</span><span class="s3">, </span><span class="s1">A1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gumbel_r</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># gh-2592, gh-6337</span>
        <span class="s0"># Adds support to 'gumbel_r' and 'gumbel_l' as valid inputs for dist.</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234567890</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">gumbel</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s0"># A constant array is a degenerate case and breaks gumbel_r.fit, so</span>
        <span class="s0"># change one value in x2.</span>
        <span class="s1">x2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0.996</span>
        <span class="s1">A1</span><span class="s3">, </span><span class="s1">crit1</span><span class="s3">, </span><span class="s1">sig1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s4">'gumbel_r'</span><span class="s3">)</span>
        <span class="s1">A2</span><span class="s3">, </span><span class="s1">crit2</span><span class="s3">, </span><span class="s1">sig2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s4">'gumbel_r'</span><span class="s3">)</span>

        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">A1</span><span class="s3">, </span><span class="s1">crit1</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">:])</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">A2 </span><span class="s3">&gt; </span><span class="s1">crit2</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_weibull_min_case_A</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># data and reference values from `anderson` reference [7]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">225</span><span class="s3">, </span><span class="s5">171</span><span class="s3">, </span><span class="s5">198</span><span class="s3">, </span><span class="s5">189</span><span class="s3">, </span><span class="s5">189</span><span class="s3">, </span><span class="s5">135</span><span class="s3">, </span><span class="s5">162</span><span class="s3">, </span><span class="s5">135</span><span class="s3">, </span><span class="s5">117</span><span class="s3">, </span><span class="s5">162</span><span class="s3">])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'weibull_min'</span><span class="s3">)</span>
        <span class="s1">m</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">scale </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">fit_result</span><span class="s3">.</span><span class="s1">params</span>
        <span class="s1">assert_allclose</span><span class="s3">((</span><span class="s1">m</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">), (</span><span class="s5">2.38</span><span class="s3">, </span><span class="s5">99.02</span><span class="s3">, </span><span class="s5">78.23</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">2e-3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.260</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic </span><span class="s3">&lt; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">critical_values</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">c </span><span class="s3">= </span><span class="s5">1 </span><span class="s3">/ </span><span class="s1">m  </span><span class="s0"># ~0.42</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s5">1</span><span class="s3">/</span><span class="s5">2.38</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">2e-3</span><span class="s3">)</span>
        <span class="s0"># interpolate between rows for c=0.4 and c=0.45, indices -3 and -2</span>
        <span class="s1">As40 </span><span class="s3">= </span><span class="s1">_Avals_weibull</span><span class="s3">[-</span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">As45 </span><span class="s3">= </span><span class="s1">_Avals_weibull</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">As_ref </span><span class="s3">= </span><span class="s1">As40 </span><span class="s3">+ (</span><span class="s1">c </span><span class="s3">- </span><span class="s5">0.4</span><span class="s3">)/(</span><span class="s5">0.45 </span><span class="s3">- </span><span class="s5">0.4</span><span class="s3">) * (</span><span class="s1">As45 </span><span class="s3">- </span><span class="s1">As40</span><span class="s3">)</span>
        <span class="s0"># atol=1e-3 because results are rounded up to the next third decimal</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">critical_values </span><span class="s3">&gt; </span><span class="s1">As_ref</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">critical_values</span><span class="s3">, </span><span class="s1">As_ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_weibull_min_case_B</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># From `anderson` reference [7]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">74</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">48</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">502</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">70</span><span class="s3">, </span><span class="s5">21</span><span class="s3">,</span>
                      <span class="s5">29</span><span class="s3">, </span><span class="s5">386</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">27</span><span class="s3">, </span><span class="s5">153</span><span class="s3">, </span><span class="s5">26</span><span class="s3">, </span><span class="s5">326</span><span class="s3">])</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;Maximum likelihood estimation has converged to &quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'weibull_min'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_weibull_warning_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check for warning message when there are too few observations</span>
        <span class="s0"># This is also an example in which an error occurs during fitting</span>
        <span class="s1">x </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">225</span><span class="s3">, </span><span class="s5">75</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">168</span><span class="s3">, </span><span class="s5">107</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">61</span><span class="s3">, </span><span class="s5">43</span><span class="s3">, </span><span class="s5">29</span><span class="s3">])</span>
        <span class="s1">wmessage </span><span class="s3">= </span><span class="s4">&quot;Critical values of the test statistic are given for the...&quot;</span>
        <span class="s1">emessage </span><span class="s3">= </span><span class="s4">&quot;An error occurred while fitting the Weibull distribution...&quot;</span>
        <span class="s1">wcontext </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">wmessage</span><span class="s3">)</span>
        <span class="s1">econtext </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">emessage</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">wcontext</span><span class="s3">, </span><span class="s1">econtext</span><span class="s3">:</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'weibull_min'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'distname'</span><span class="s3">,</span>
                             <span class="s3">[</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s4">'expon'</span><span class="s3">, </span><span class="s4">'gumbel_l'</span><span class="s3">, </span><span class="s4">'extreme1'</span><span class="s3">,</span>
                              <span class="s4">'gumbel'</span><span class="s3">, </span><span class="s4">'gumbel_r'</span><span class="s3">, </span><span class="s4">'logistic'</span><span class="s3">, </span><span class="s4">'weibull_min'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_anderson_fit_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">distname</span><span class="s3">):</span>
        <span class="s0"># check that anderson now returns a FitResult</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">330691555377792039</span><span class="s3">)</span>
        <span class="s1">real_distname </span><span class="s3">= (</span><span class="s4">'gumbel_l' </span><span class="s2">if </span><span class="s1">distname </span><span class="s2">in </span><span class="s3">{</span><span class="s4">'extreme1'</span><span class="s3">, </span><span class="s4">'gumbel'</span><span class="s3">}</span>
                         <span class="s2">else </span><span class="s1">distname</span><span class="s3">)</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">, </span><span class="s1">real_distname</span><span class="s3">)</span>
        <span class="s1">params </span><span class="s3">= </span><span class="s1">distcont</span><span class="s3">[</span><span class="s1">real_distname</span><span class="s3">]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(*</span><span class="s1">params</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">distname</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">fit_result</span><span class="s3">.</span><span class="s1">success</span>

    <span class="s2">def </span><span class="s1">test_anderson_weibull_As</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s5">1  </span><span class="s0"># &quot;when mi &lt; 2, so that c &gt; 0.5, the last line...should be used&quot;</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">_get_As_weibull</span><span class="s3">(</span><span class="s5">1</span><span class="s3">/</span><span class="s1">m</span><span class="s3">), </span><span class="s1">_Avals_weibull</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">_get_As_weibull</span><span class="s3">(</span><span class="s5">1</span><span class="s3">/</span><span class="s1">m</span><span class="s3">), </span><span class="s1">_Avals_weibull</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">TestAndersonKSamp</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_example1a</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Example data from Scholz &amp; Stephens (1987), originally</span>
        <span class="s0"># published in Lehmann (1995, Nonparametrics, Statistical</span>
        <span class="s0"># Methods Based on Ranks, p. 309)</span>
        <span class="s0"># Pass a mixture of lists and arrays</span>
        <span class="s1">t1 </span><span class="s3">= [</span><span class="s5">38.7</span><span class="s3">, </span><span class="s5">41.5</span><span class="s3">, </span><span class="s5">43.8</span><span class="s3">, </span><span class="s5">44.5</span><span class="s3">, </span><span class="s5">45.5</span><span class="s3">, </span><span class="s5">46.0</span><span class="s3">, </span><span class="s5">47.7</span><span class="s3">, </span><span class="s5">58.0</span><span class="s3">]</span>
        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">39.2</span><span class="s3">, </span><span class="s5">39.3</span><span class="s3">, </span><span class="s5">39.7</span><span class="s3">, </span><span class="s5">41.4</span><span class="s3">, </span><span class="s5">41.8</span><span class="s3">, </span><span class="s5">42.9</span><span class="s3">, </span><span class="s5">43.3</span><span class="s3">, </span><span class="s5">45.8</span><span class="s3">])</span>
        <span class="s1">t3 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">34.0</span><span class="s3">, </span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">39.0</span><span class="s3">, </span><span class="s5">40.0</span><span class="s3">, </span><span class="s5">43.0</span><span class="s3">, </span><span class="s5">43.0</span><span class="s3">, </span><span class="s5">44.0</span><span class="s3">, </span><span class="s5">45.0</span><span class="s3">])</span>
        <span class="s1">t4 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">34.0</span><span class="s3">, </span><span class="s5">34.8</span><span class="s3">, </span><span class="s5">34.8</span><span class="s3">, </span><span class="s5">35.4</span><span class="s3">, </span><span class="s5">37.2</span><span class="s3">, </span><span class="s5">37.8</span><span class="s3">, </span><span class="s5">41.2</span><span class="s3">, </span><span class="s5">42.8</span><span class="s3">])</span>

        <span class="s1">Tk</span><span class="s3">, </span><span class="s1">tm</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">((</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">, </span><span class="s1">t3</span><span class="s3">, </span><span class="s1">t4</span><span class="s3">), </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Tk</span><span class="s3">, </span><span class="s5">4.449</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s5">0.4985</span><span class="s3">, </span><span class="s5">1.3237</span><span class="s3">, </span><span class="s5">1.9158</span><span class="s3">, </span><span class="s5">2.4930</span><span class="s3">, </span><span class="s5">3.2459</span><span class="s3">],</span>
                                  <span class="s1">tm</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">5</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0021</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.00025</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_example1b</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Example data from Scholz &amp; Stephens (1987), originally</span>
        <span class="s0"># published in Lehmann (1995, Nonparametrics, Statistical</span>
        <span class="s0"># Methods Based on Ranks, p. 309)</span>
        <span class="s0"># Pass arrays</span>
        <span class="s1">t1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">38.7</span><span class="s3">, </span><span class="s5">41.5</span><span class="s3">, </span><span class="s5">43.8</span><span class="s3">, </span><span class="s5">44.5</span><span class="s3">, </span><span class="s5">45.5</span><span class="s3">, </span><span class="s5">46.0</span><span class="s3">, </span><span class="s5">47.7</span><span class="s3">, </span><span class="s5">58.0</span><span class="s3">])</span>
        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">39.2</span><span class="s3">, </span><span class="s5">39.3</span><span class="s3">, </span><span class="s5">39.7</span><span class="s3">, </span><span class="s5">41.4</span><span class="s3">, </span><span class="s5">41.8</span><span class="s3">, </span><span class="s5">42.9</span><span class="s3">, </span><span class="s5">43.3</span><span class="s3">, </span><span class="s5">45.8</span><span class="s3">])</span>
        <span class="s1">t3 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">34.0</span><span class="s3">, </span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">39.0</span><span class="s3">, </span><span class="s5">40.0</span><span class="s3">, </span><span class="s5">43.0</span><span class="s3">, </span><span class="s5">43.0</span><span class="s3">, </span><span class="s5">44.0</span><span class="s3">, </span><span class="s5">45.0</span><span class="s3">])</span>
        <span class="s1">t4 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">34.0</span><span class="s3">, </span><span class="s5">34.8</span><span class="s3">, </span><span class="s5">34.8</span><span class="s3">, </span><span class="s5">35.4</span><span class="s3">, </span><span class="s5">37.2</span><span class="s3">, </span><span class="s5">37.8</span><span class="s3">, </span><span class="s5">41.2</span><span class="s3">, </span><span class="s5">42.8</span><span class="s3">])</span>
        <span class="s1">Tk</span><span class="s3">, </span><span class="s1">tm</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">((</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">, </span><span class="s1">t3</span><span class="s3">, </span><span class="s1">t4</span><span class="s3">), </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Tk</span><span class="s3">, </span><span class="s5">4.480</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s5">0.4985</span><span class="s3">, </span><span class="s5">1.3237</span><span class="s3">, </span><span class="s5">1.9158</span><span class="s3">, </span><span class="s5">2.4930</span><span class="s3">, </span><span class="s5">3.2459</span><span class="s3">],</span>
                                  <span class="s1">tm</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">5</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0020</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.00025</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xslow</span>
    <span class="s2">def </span><span class="s1">test_example2a</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Example data taken from an earlier technical report of</span>
        <span class="s0"># Scholz and Stephens</span>
        <span class="s0"># Pass lists instead of arrays</span>
        <span class="s1">t1 </span><span class="s3">= [</span><span class="s5">194</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">41</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">33</span><span class="s3">, </span><span class="s5">181</span><span class="s3">]</span>
        <span class="s1">t2 </span><span class="s3">= [</span><span class="s5">413</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">58</span><span class="s3">, </span><span class="s5">37</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">65</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">169</span><span class="s3">, </span><span class="s5">447</span><span class="s3">, </span><span class="s5">184</span><span class="s3">, </span><span class="s5">36</span><span class="s3">, </span><span class="s5">201</span><span class="s3">, </span><span class="s5">118</span><span class="s3">]</span>
        <span class="s1">t3 </span><span class="s3">= [</span><span class="s5">34</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">67</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">34</span><span class="s3">]</span>
        <span class="s1">t4 </span><span class="s3">= [</span><span class="s5">90</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">60</span><span class="s3">, </span><span class="s5">186</span><span class="s3">, </span><span class="s5">61</span><span class="s3">, </span><span class="s5">49</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">24</span><span class="s3">, </span><span class="s5">56</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">79</span><span class="s3">, </span><span class="s5">84</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">29</span><span class="s3">,</span>
              <span class="s5">118</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">156</span><span class="s3">, </span><span class="s5">310</span><span class="s3">, </span><span class="s5">76</span><span class="s3">, </span><span class="s5">26</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">23</span><span class="s3">, </span><span class="s5">62</span><span class="s3">]</span>
        <span class="s1">t5 </span><span class="s3">= [</span><span class="s5">130</span><span class="s3">, </span><span class="s5">208</span><span class="s3">, </span><span class="s5">70</span><span class="s3">, </span><span class="s5">101</span><span class="s3">, </span><span class="s5">208</span><span class="s3">]</span>
        <span class="s1">t6 </span><span class="s3">= [</span><span class="s5">74</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">48</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">502</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">70</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">386</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">27</span><span class="s3">]</span>
        <span class="s1">t7 </span><span class="s3">= [</span><span class="s5">55</span><span class="s3">, </span><span class="s5">320</span><span class="s3">, </span><span class="s5">56</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">220</span><span class="s3">, </span><span class="s5">239</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s5">246</span><span class="s3">, </span><span class="s5">176</span><span class="s3">, </span><span class="s5">182</span><span class="s3">, </span><span class="s5">33</span><span class="s3">]</span>
        <span class="s1">t8 </span><span class="s3">= [</span><span class="s5">23</span><span class="s3">, </span><span class="s5">261</span><span class="s3">, </span><span class="s5">87</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">120</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s5">225</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">246</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">42</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">5</span><span class="s3">,</span>
              <span class="s5">12</span><span class="s3">, </span><span class="s5">120</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">90</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">52</span><span class="s3">, </span><span class="s5">95</span><span class="s3">]</span>
        <span class="s1">t9 </span><span class="s3">= [</span><span class="s5">97</span><span class="s3">, </span><span class="s5">51</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">141</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">142</span><span class="s3">, </span><span class="s5">68</span><span class="s3">, </span><span class="s5">77</span><span class="s3">, </span><span class="s5">80</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">206</span><span class="s3">, </span><span class="s5">82</span><span class="s3">,</span>
              <span class="s5">54</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">216</span><span class="s3">, </span><span class="s5">46</span><span class="s3">, </span><span class="s5">111</span><span class="s3">, </span><span class="s5">39</span><span class="s3">, </span><span class="s5">63</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">191</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">163</span><span class="s3">, </span><span class="s5">24</span><span class="s3">]</span>
        <span class="s1">t10 </span><span class="s3">= [</span><span class="s5">50</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">72</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">39</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">197</span><span class="s3">, </span><span class="s5">188</span><span class="s3">, </span><span class="s5">79</span><span class="s3">, </span><span class="s5">88</span><span class="s3">, </span><span class="s5">46</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">36</span><span class="s3">,</span>
               <span class="s5">22</span><span class="s3">, </span><span class="s5">139</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">97</span><span class="s3">, </span><span class="s5">30</span><span class="s3">, </span><span class="s5">23</span><span class="s3">, </span><span class="s5">13</span><span class="s3">, </span><span class="s5">14</span><span class="s3">]</span>
        <span class="s1">t11 </span><span class="s3">= [</span><span class="s5">359</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">270</span><span class="s3">, </span><span class="s5">603</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">438</span><span class="s3">]</span>
        <span class="s1">t12 </span><span class="s3">= [</span><span class="s5">50</span><span class="s3">, </span><span class="s5">254</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">283</span><span class="s3">, </span><span class="s5">35</span><span class="s3">, </span><span class="s5">12</span><span class="s3">]</span>
        <span class="s1">t13 </span><span class="s3">= [</span><span class="s5">487</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">85</span><span class="s3">, </span><span class="s5">91</span><span class="s3">, </span><span class="s5">43</span><span class="s3">, </span><span class="s5">230</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">130</span><span class="s3">]</span>
        <span class="s1">t14 </span><span class="s3">= [</span><span class="s5">102</span><span class="s3">, </span><span class="s5">209</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">54</span><span class="s3">, </span><span class="s5">32</span><span class="s3">, </span><span class="s5">67</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">134</span><span class="s3">, </span><span class="s5">152</span><span class="s3">, </span><span class="s5">27</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">230</span><span class="s3">, </span><span class="s5">66</span><span class="s3">,</span>
               <span class="s5">61</span><span class="s3">, </span><span class="s5">34</span><span class="s3">]</span>

        <span class="s1">samples </span><span class="s3">= (</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">, </span><span class="s1">t3</span><span class="s3">, </span><span class="s1">t4</span><span class="s3">, </span><span class="s1">t5</span><span class="s3">, </span><span class="s1">t6</span><span class="s3">, </span><span class="s1">t7</span><span class="s3">, </span><span class="s1">t8</span><span class="s3">, </span><span class="s1">t9</span><span class="s3">, </span><span class="s1">t10</span><span class="s3">, </span><span class="s1">t11</span><span class="s3">, </span><span class="s1">t12</span><span class="s3">, </span><span class="s1">t13</span><span class="s3">, </span><span class="s1">t14</span><span class="s3">)</span>
        <span class="s1">Tk</span><span class="s3">, </span><span class="s1">tm</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Tk</span><span class="s3">, </span><span class="s5">3.288</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s5">0.5990</span><span class="s3">, </span><span class="s5">1.3269</span><span class="s3">, </span><span class="s5">1.8052</span><span class="s3">, </span><span class="s5">2.2486</span><span class="s3">, </span><span class="s5">2.8009</span><span class="s3">],</span>
                                  <span class="s1">tm</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">5</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0041</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.00025</span><span class="s3">)</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">6989860141921615054</span><span class="s3">)</span>
        <span class="s1">method </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">PermutationMethod</span><span class="s3">(</span><span class="s1">n_resamples</span><span class="s3">=</span><span class="s5">9999</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">Tk</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">critical_values</span><span class="s3">, </span><span class="s1">tm</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">6e-4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_example2b</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Example data taken from an earlier technical report of</span>
        <span class="s0"># Scholz and Stephens</span>
        <span class="s1">t1 </span><span class="s3">= [</span><span class="s5">194</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">41</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">33</span><span class="s3">, </span><span class="s5">181</span><span class="s3">]</span>
        <span class="s1">t2 </span><span class="s3">= [</span><span class="s5">413</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">58</span><span class="s3">, </span><span class="s5">37</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">65</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">169</span><span class="s3">, </span><span class="s5">447</span><span class="s3">, </span><span class="s5">184</span><span class="s3">, </span><span class="s5">36</span><span class="s3">, </span><span class="s5">201</span><span class="s3">, </span><span class="s5">118</span><span class="s3">]</span>
        <span class="s1">t3 </span><span class="s3">= [</span><span class="s5">34</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">67</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">34</span><span class="s3">]</span>
        <span class="s1">t4 </span><span class="s3">= [</span><span class="s5">90</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">60</span><span class="s3">, </span><span class="s5">186</span><span class="s3">, </span><span class="s5">61</span><span class="s3">, </span><span class="s5">49</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">24</span><span class="s3">, </span><span class="s5">56</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">79</span><span class="s3">, </span><span class="s5">84</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">29</span><span class="s3">,</span>
              <span class="s5">118</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">156</span><span class="s3">, </span><span class="s5">310</span><span class="s3">, </span><span class="s5">76</span><span class="s3">, </span><span class="s5">26</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">23</span><span class="s3">, </span><span class="s5">62</span><span class="s3">]</span>
        <span class="s1">t5 </span><span class="s3">= [</span><span class="s5">130</span><span class="s3">, </span><span class="s5">208</span><span class="s3">, </span><span class="s5">70</span><span class="s3">, </span><span class="s5">101</span><span class="s3">, </span><span class="s5">208</span><span class="s3">]</span>
        <span class="s1">t6 </span><span class="s3">= [</span><span class="s5">74</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">48</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">502</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">70</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">29</span><span class="s3">, </span><span class="s5">386</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">27</span><span class="s3">]</span>
        <span class="s1">t7 </span><span class="s3">= [</span><span class="s5">55</span><span class="s3">, </span><span class="s5">320</span><span class="s3">, </span><span class="s5">56</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">220</span><span class="s3">, </span><span class="s5">239</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s5">246</span><span class="s3">, </span><span class="s5">176</span><span class="s3">, </span><span class="s5">182</span><span class="s3">, </span><span class="s5">33</span><span class="s3">]</span>
        <span class="s1">t8 </span><span class="s3">= [</span><span class="s5">23</span><span class="s3">, </span><span class="s5">261</span><span class="s3">, </span><span class="s5">87</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">120</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s5">225</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">246</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">42</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">5</span><span class="s3">,</span>
              <span class="s5">12</span><span class="s3">, </span><span class="s5">120</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">90</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">52</span><span class="s3">, </span><span class="s5">95</span><span class="s3">]</span>
        <span class="s1">t9 </span><span class="s3">= [</span><span class="s5">97</span><span class="s3">, </span><span class="s5">51</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">141</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">142</span><span class="s3">, </span><span class="s5">68</span><span class="s3">, </span><span class="s5">77</span><span class="s3">, </span><span class="s5">80</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">206</span><span class="s3">, </span><span class="s5">82</span><span class="s3">,</span>
              <span class="s5">54</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">216</span><span class="s3">, </span><span class="s5">46</span><span class="s3">, </span><span class="s5">111</span><span class="s3">, </span><span class="s5">39</span><span class="s3">, </span><span class="s5">63</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">191</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">163</span><span class="s3">, </span><span class="s5">24</span><span class="s3">]</span>
        <span class="s1">t10 </span><span class="s3">= [</span><span class="s5">50</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">72</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">39</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">197</span><span class="s3">, </span><span class="s5">188</span><span class="s3">, </span><span class="s5">79</span><span class="s3">, </span><span class="s5">88</span><span class="s3">, </span><span class="s5">46</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">36</span><span class="s3">,</span>
               <span class="s5">22</span><span class="s3">, </span><span class="s5">139</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">97</span><span class="s3">, </span><span class="s5">30</span><span class="s3">, </span><span class="s5">23</span><span class="s3">, </span><span class="s5">13</span><span class="s3">, </span><span class="s5">14</span><span class="s3">]</span>
        <span class="s1">t11 </span><span class="s3">= [</span><span class="s5">359</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">12</span><span class="s3">, </span><span class="s5">270</span><span class="s3">, </span><span class="s5">603</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">438</span><span class="s3">]</span>
        <span class="s1">t12 </span><span class="s3">= [</span><span class="s5">50</span><span class="s3">, </span><span class="s5">254</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">283</span><span class="s3">, </span><span class="s5">35</span><span class="s3">, </span><span class="s5">12</span><span class="s3">]</span>
        <span class="s1">t13 </span><span class="s3">= [</span><span class="s5">487</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">85</span><span class="s3">, </span><span class="s5">91</span><span class="s3">, </span><span class="s5">43</span><span class="s3">, </span><span class="s5">230</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">130</span><span class="s3">]</span>
        <span class="s1">t14 </span><span class="s3">= [</span><span class="s5">102</span><span class="s3">, </span><span class="s5">209</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">57</span><span class="s3">, </span><span class="s5">54</span><span class="s3">, </span><span class="s5">32</span><span class="s3">, </span><span class="s5">67</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">134</span><span class="s3">, </span><span class="s5">152</span><span class="s3">, </span><span class="s5">27</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">230</span><span class="s3">, </span><span class="s5">66</span><span class="s3">,</span>
               <span class="s5">61</span><span class="s3">, </span><span class="s5">34</span><span class="s3">]</span>

        <span class="s1">Tk</span><span class="s3">, </span><span class="s1">tm</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">((</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">, </span><span class="s1">t3</span><span class="s3">, </span><span class="s1">t4</span><span class="s3">, </span><span class="s1">t5</span><span class="s3">, </span><span class="s1">t6</span><span class="s3">, </span><span class="s1">t7</span><span class="s3">, </span><span class="s1">t8</span><span class="s3">,</span>
                                          <span class="s1">t9</span><span class="s3">, </span><span class="s1">t10</span><span class="s3">, </span><span class="s1">t11</span><span class="s3">, </span><span class="s1">t12</span><span class="s3">, </span><span class="s1">t13</span><span class="s3">, </span><span class="s1">t14</span><span class="s3">),</span>
                                         <span class="s1">midrank</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Tk</span><span class="s3">, </span><span class="s5">3.294</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s5">0.5990</span><span class="s3">, </span><span class="s5">1.3269</span><span class="s3">, </span><span class="s5">1.8052</span><span class="s3">, </span><span class="s5">2.2486</span><span class="s3">, </span><span class="s5">2.8009</span><span class="s3">],</span>
                                  <span class="s1">tm</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">5</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0041</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.00025</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_R_kSamples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test values generates with R package kSamples</span>
        <span class="s0"># package version 1.2-6 (2017-06-14)</span>
        <span class="s0"># r1 = 1:100</span>
        <span class="s0"># continuous case (no ties) --&gt; version  1</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + 40.5)</span>
        <span class="s0"># res$ad[1, &quot;T.AD&quot;] #  41.105</span>
        <span class="s0"># res$ad[1, &quot; asympt. P-value&quot;] #  5.8399e-18</span>
        <span class="s0">#</span>
        <span class="s0"># discrete case (ties allowed) --&gt; version  2 (here: midrank=True)</span>
        <span class="s0"># res$ad[2, &quot;T.AD&quot;] #  41.235</span>
        <span class="s0">#</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + .5)</span>
        <span class="s0"># res$ad[1, &quot;T.AD&quot;] #  -1.2824</span>
        <span class="s0"># res$ad[1, &quot; asympt. P-value&quot;] #  1</span>
        <span class="s0"># res$ad[2, &quot;T.AD&quot;] #  -1.2944</span>
        <span class="s0">#</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + 7.5)</span>
        <span class="s0"># res$ad[1, &quot;T.AD&quot;] # 1.4923</span>
        <span class="s0"># res$ad[1, &quot; asympt. P-value&quot;] # 0.077501</span>
        <span class="s0">#</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + 6)</span>
        <span class="s0"># res$ad[2, &quot;T.AD&quot;] # 0.63892</span>
        <span class="s0"># res$ad[2, &quot; asympt. P-value&quot;] # 0.17981</span>
        <span class="s0">#</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + 11.5)</span>
        <span class="s0"># res$ad[1, &quot;T.AD&quot;] # 4.5042</span>
        <span class="s0"># res$ad[1, &quot; asympt. P-value&quot;] # 0.00545</span>
        <span class="s0">#</span>
        <span class="s0"># res &lt;- kSamples::ad.test(r1, r1 + 13.5)</span>
        <span class="s0"># res$ad[1, &quot;T.AD&quot;] # 6.2982</span>
        <span class="s0"># res$ad[1, &quot; asympt. P-value&quot;] # 0.00118</span>

        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
        <span class="s0"># test case: different distributions;p-value floored at 0.001</span>
        <span class="s0"># test case for issue #5493 / #8536</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">'p-value floored'</span><span class="s3">)</span>
            <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">40.5</span><span class="s3">], </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">41.105</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.001</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">'p-value floored'</span><span class="s3">)</span>
            <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">40.5</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">41.235</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.001</span><span class="s3">)</span>

        <span class="s0"># test case: similar distributions --&gt; p-value capped at 0.25</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">'p-value capped'</span><span class="s3">)</span>
            <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">.5</span><span class="s3">], </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, -</span><span class="s5">1.2824</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">'p-value capped'</span><span class="s3">)</span>
            <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">.5</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, -</span><span class="s5">1.2944</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>

        <span class="s0"># test case: check interpolated p-value in [0.01, 0.25] (no ties)</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">7.5</span><span class="s3">], </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">1.4923</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0775</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.005</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

        <span class="s0"># test case: check interpolated p-value in [0.01, 0.25] (w/ ties)</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">6</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">0.6389</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.1798</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.005</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

        <span class="s0"># test extended critical values for p=0.001 and p=0.005</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">11.5</span><span class="s3">], </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4.5042</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.00545</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.0005</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

        <span class="s1">s</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">([</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">+ </span><span class="s5">13.5</span><span class="s3">], </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">6.2982</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.00118</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.0001</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_not_enough_samples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_no_distinct_observations</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">,</span>
                      <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_empty_sample</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">, (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">), []))</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Pass a mixture of lists and arrays</span>
        <span class="s1">t1 </span><span class="s3">= [</span><span class="s5">38.7</span><span class="s3">, </span><span class="s5">41.5</span><span class="s3">, </span><span class="s5">43.8</span><span class="s3">, </span><span class="s5">44.5</span><span class="s3">, </span><span class="s5">45.5</span><span class="s3">, </span><span class="s5">46.0</span><span class="s3">, </span><span class="s5">47.7</span><span class="s3">, </span><span class="s5">58.0</span><span class="s3">]</span>
        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">39.2</span><span class="s3">, </span><span class="s5">39.3</span><span class="s3">, </span><span class="s5">39.7</span><span class="s3">, </span><span class="s5">41.4</span><span class="s3">, </span><span class="s5">41.8</span><span class="s3">, </span><span class="s5">42.9</span><span class="s3">, </span><span class="s5">43.3</span><span class="s3">, </span><span class="s5">45.8</span><span class="s3">])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">anderson_ksamp</span><span class="s3">((</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">), </span><span class="s1">midrank</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'critical_values'</span><span class="s3">, </span><span class="s4">'significance_level'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">significance_level</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestAnsari</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_small</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s4">&quot;Ties preclude use of exact statistic.&quot;</span><span class="s3">)</span>
            <span class="s1">W</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W</span><span class="s3">, </span><span class="s5">23.5</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s5">0.13499256881897437</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_approx</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ramsay </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">((</span><span class="s5">111</span><span class="s3">, </span><span class="s5">107</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">99</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">109</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">99</span><span class="s3">,</span>
                           <span class="s5">101</span><span class="s3">, </span><span class="s5">96</span><span class="s3">, </span><span class="s5">97</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">107</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">116</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">110</span><span class="s3">, </span><span class="s5">98</span><span class="s3">))</span>
        <span class="s1">parekh </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">((</span><span class="s5">107</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">105</span><span class="s3">, </span><span class="s5">103</span><span class="s3">, </span><span class="s5">110</span><span class="s3">, </span><span class="s5">105</span><span class="s3">, </span><span class="s5">104</span><span class="s3">,</span>
                           <span class="s5">100</span><span class="s3">, </span><span class="s5">96</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">103</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">108</span><span class="s3">,</span>
                           <span class="s5">106</span><span class="s3">, </span><span class="s5">99</span><span class="s3">))</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s4">&quot;Ties preclude use of exact statistic.&quot;</span><span class="s3">)</span>
            <span class="s1">W</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">ramsay</span><span class="s3">, </span><span class="s1">parekh</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W</span><span class="s3">, </span><span class="s5">185.5</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s5">0.18145819972867083</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exact</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">W</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">15</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">12</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s5">0.533333333333333333</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'args'</span><span class="s3">, [([], [</span><span class="s5">1</span><span class="s3">]), ([</span><span class="s5">1</span><span class="s3">], [])])</span>
    <span class="s2">def </span><span class="s1">test_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s4">&quot;Ties preclude use of exact statistic.&quot;</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'pvalue'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_alternative</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># invalid value for alternative must raise a ValueError</span>
        <span class="s1">x1 </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">x2 </span><span class="s3">= [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">]</span>
        <span class="s1">match </span><span class="s3">= </span><span class="s4">&quot;'alternative' must be 'two-sided'&quot;</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'foo'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alternative_exact</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x1 </span><span class="s3">= [-</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">25</span><span class="s3">]  </span><span class="s0"># high scale, loc=10</span>
        <span class="s1">x2 </span><span class="s3">= [</span><span class="s5">7.5</span><span class="s3">, </span><span class="s5">8.5</span><span class="s3">, </span><span class="s5">9.5</span><span class="s3">, </span><span class="s5">10.5</span><span class="s3">, </span><span class="s5">11.5</span><span class="s3">, </span><span class="s5">12.5</span><span class="s3">]  </span><span class="s0"># low scale, loc=10</span>
        <span class="s0"># ratio of scales is greater than 1. So, the</span>
        <span class="s0"># p-value must be high when `alternative='less'`</span>
        <span class="s0"># and low when `alternative='greater'`.</span>
        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">pval_l </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">pval_g </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s2">assert </span><span class="s1">pval_l </span><span class="s3">&gt; </span><span class="s5">0.95</span>
        <span class="s2">assert </span><span class="s1">pval_g </span><span class="s3">&lt; </span><span class="s5">0.05  </span><span class="s0"># level of significance.</span>
        <span class="s0"># also check if the p-values sum up to 1 plus the probability</span>
        <span class="s0"># mass under the calculated statistic.</span>
        <span class="s1">prob </span><span class="s3">= </span><span class="s1">_abw_state</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_g </span><span class="s3">+ </span><span class="s1">pval_l</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">+ </span><span class="s1">prob</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s0"># also check if one of the one-sided p-value equals half the</span>
        <span class="s0"># two-sided p-value and the other one-sided p-value is its</span>
        <span class="s0"># compliment.</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_g</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_l</span><span class="s3">, </span><span class="s5">1</span><span class="s3">+</span><span class="s1">prob</span><span class="s3">-</span><span class="s1">pval</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s0"># sanity check. The result should flip if</span>
        <span class="s0"># we exchange x and y.</span>
        <span class="s1">pval_l_reverse </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">pval_g_reverse </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s2">assert </span><span class="s1">pval_l_reverse </span><span class="s3">&lt; </span><span class="s5">0.05</span>
        <span class="s2">assert </span><span class="s1">pval_g_reverse </span><span class="s3">&gt; </span><span class="s5">0.95</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">'x, y, alternative, expected'</span><span class="s3">,</span>
        <span class="s0"># the tests are designed in such a way that the</span>
        <span class="s0"># if else statement in ansari test for exact</span>
        <span class="s0"># mode is covered.</span>
        <span class="s3">[([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">0.6285714285714</span><span class="s3">),</span>
         <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">0.6285714285714</span><span class="s3">),</span>
         <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">0.8928571428571</span><span class="s3">),</span>
         <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">0.2857142857143</span><span class="s3">),</span>
         <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">0.2857142857143</span><span class="s3">),</span>
         <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">0.8928571428571</span><span class="s3">)]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_alternative_exact_with_R</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s0"># testing with R on arbitrary data</span>
        <span class="s0"># Sample R code used for the third test case above:</span>
        <span class="s0"># ```R</span>
        <span class="s0"># &gt; options(digits=16)</span>
        <span class="s0"># &gt; x &lt;- c(1,2,3)</span>
        <span class="s0"># &gt; y &lt;- c(4,5,6,7,8)</span>
        <span class="s0"># &gt; ansari.test(x, y, alternative='less', exact=TRUE)</span>
        <span class="s0">#</span>
        <span class="s0">#     Ansari-Bradley test</span>
        <span class="s0">#</span>
        <span class="s0"># data:  x and y</span>
        <span class="s0"># AB = 6, p-value = 0.8928571428571</span>
        <span class="s0"># alternative hypothesis: true ratio of scales is less than 1</span>
        <span class="s0">#</span>
        <span class="s0"># ```</span>
        <span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alternative_approx</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># intuitive tests for approximation</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s0"># for m &gt; 55 or n &gt; 55, the test should automatically</span>
        <span class="s0"># switch to approximation.</span>
        <span class="s1">pval_l </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">pval_g </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_l</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_g</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s0"># also check if one of the one-sided p-value equals half the</span>
        <span class="s0"># two-sided p-value and the other one-sided p-value is its</span>
        <span class="s0"># compliment.</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">60</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">60</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">pval_l </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">pval_g </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ansari</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">).</span><span class="s1">pvalue</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_g</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pval_l</span><span class="s3">, </span><span class="s5">1</span><span class="s3">-</span><span class="s1">pval</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">array_api_compatible</span>
<span class="s2">class </span><span class="s1">TestBartlett</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># https://www.itl.nist.gov/div898/handbook/eda/section3/eda357.htm</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">g4</span><span class="s3">, </span><span class="s1">g5</span><span class="s3">, </span><span class="s1">g6</span><span class="s3">, </span><span class="s1">g7</span><span class="s3">, </span><span class="s1">g8</span><span class="s3">, </span><span class="s1">g9</span><span class="s3">, </span><span class="s1">g10</span><span class="s3">]</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">T</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bartlett</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">20.78587342806484</span><span class="s3">))</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">0.0136358632781</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_too_few_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;Must enter at least two input sample vectors.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">bartlett</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">]))</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">g4</span><span class="s3">, </span><span class="s1">g5</span><span class="s3">, </span><span class="s1">g6</span><span class="s3">, </span><span class="s1">g7</span><span class="s3">, </span><span class="s1">g8</span><span class="s3">, </span><span class="s1">g9</span><span class="s3">, </span><span class="s1">g10</span><span class="s3">]</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bartlett</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'pvalue'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skip_xp_backends</span><span class="s3">(</span>
        <span class="s4">&quot;jax.numpy&quot;</span><span class="s3">, </span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'`var` incorrect when `correction &gt; n` (google/jax#21330)'</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;skip_xp_backends&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_empty_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">args </span><span class="s3">= (</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">g4</span><span class="s3">, </span><span class="s1">g5</span><span class="s3">, </span><span class="s1">g6</span><span class="s3">, </span><span class="s1">g7</span><span class="s3">, </span><span class="s1">g8</span><span class="s3">, </span><span class="s1">g9</span><span class="s3">, </span><span class="s1">g10</span><span class="s3">, [])</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">is_numpy</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bartlett</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
                <span class="s0"># torch/array_api_strict</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s4">&quot;invalid value encountered&quot;</span><span class="s3">)</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s4">r&quot;var\(\): degrees of freedom is &lt;= 0.&quot;</span><span class="s3">)</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s4">&quot;Degrees of freedom &lt;= 0 for slice&quot;</span><span class="s3">)</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">bartlett</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">NaN </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">NaN</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">NaN</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestLevene</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># https://www.itl.nist.gov/div898/handbook/eda/section3/eda35a.htm</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">g4</span><span class="s3">, </span><span class="s1">g5</span><span class="s3">, </span><span class="s1">g6</span><span class="s3">, </span><span class="s1">g7</span><span class="s3">, </span><span class="s1">g8</span><span class="s3">, </span><span class="s1">g9</span><span class="s3">, </span><span class="s1">g10</span><span class="s3">]</span>
        <span class="s1">W</span><span class="s3">, </span><span class="s1">pval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W</span><span class="s3">, </span><span class="s5">1.7059176930008939</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval</span><span class="s3">, </span><span class="s5">0.0990829755522</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_trimmed1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test that center='trimmed' gives the same result as center='mean'</span>
        <span class="s0"># when proportiontocut=0.</span>
        <span class="s1">W1</span><span class="s3">, </span><span class="s1">pval1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">)</span>
        <span class="s1">W2</span><span class="s3">, </span><span class="s1">pval2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trimmed'</span><span class="s3">,</span>
                                 <span class="s1">proportiontocut</span><span class="s3">=</span><span class="s5">0.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W1</span><span class="s3">, </span><span class="s1">W2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval1</span><span class="s3">, </span><span class="s1">pval2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_trimmed2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">6.0</span><span class="s3">, </span><span class="s5">7.0</span><span class="s3">, </span><span class="s5">100.0</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">4.5</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">5.5</span><span class="s3">, </span><span class="s5">200.0</span><span class="s3">]</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s0"># Use center='trimmed'</span>
        <span class="s1">W0</span><span class="s3">, </span><span class="s1">pval0 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trimmed'</span><span class="s3">,</span>
                                 <span class="s1">proportiontocut</span><span class="s3">=</span><span class="s5">0.125</span><span class="s3">)</span>
        <span class="s1">W1</span><span class="s3">, </span><span class="s1">pval1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trimmed'</span><span class="s3">,</span>
                                 <span class="s1">proportiontocut</span><span class="s3">=</span><span class="s5">0.125</span><span class="s3">)</span>
        <span class="s0"># Trim the data here, and use center='mean'</span>
        <span class="s1">W2</span><span class="s3">, </span><span class="s1">pval2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">)</span>
        <span class="s0"># Result should be the same.</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W0</span><span class="s3">, </span><span class="s1">W2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W1</span><span class="s3">, </span><span class="s1">W2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval1</span><span class="s3">, </span><span class="s1">pval2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_equal_mean_median</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x</span><span class="s3">**</span><span class="s5">3</span>
        <span class="s1">W1</span><span class="s3">, </span><span class="s1">pval1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">)</span>
        <span class="s1">W2</span><span class="s3">, </span><span class="s1">pval2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'median'</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">W1</span><span class="s3">, </span><span class="s1">W2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval1</span><span class="s3">, </span><span class="s1">pval2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">portiontocut</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_center_value</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trim'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_too_few_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">g1</span><span class="s3">, </span><span class="s1">g2</span><span class="s3">, </span><span class="s1">g3</span><span class="s3">, </span><span class="s1">g4</span><span class="s3">, </span><span class="s1">g5</span><span class="s3">, </span><span class="s1">g6</span><span class="s3">, </span><span class="s1">g7</span><span class="s3">, </span><span class="s1">g8</span><span class="s3">, </span><span class="s1">g9</span><span class="s3">, </span><span class="s1">g10</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'pvalue'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>

    <span class="s0"># temporary fix for issue #9252: only accept 1d input</span>
    <span class="s2">def </span><span class="s1">test_1d_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">levene</span><span class="s3">, </span><span class="s1">g1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestBinomTest</span><span class="s3">:</span>
    <span class="s6">&quot;&quot;&quot;Tests for stats.binomtest.&quot;&quot;&quot;</span>

    <span class="s0"># Expected results here are from R binom.test, e.g.</span>
    <span class="s0"># options(digits=16)</span>
    <span class="s0"># binom.test(484, 967, p=0.48)</span>
    <span class="s0">#</span>
    <span class="s2">def </span><span class="s1">test_two_sided_pvalues1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># `tol` could be stricter on most architectures, but the value</span>
        <span class="s0"># here is limited by accuracy of `binom.cdf` for large inputs on</span>
        <span class="s0"># Linux_Python_37_32bit_full and aarch64</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s5">1e-10  </span><span class="s0"># aarch64 observed rtol: 1.5e-11</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">10079999</span><span class="s3">, </span><span class="s5">21000000</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">10079990</span><span class="s3">, </span><span class="s5">21000000</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.9966892187965</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">10080009</span><span class="s3">, </span><span class="s5">21000000</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.9970377203856</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">10080017</span><span class="s3">, </span><span class="s5">21000000</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.9940754817328</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-9</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_two_sided_pvalues2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s5">1e-10  </span><span class="s0"># no aarch64 failure with 1e-15, preemptive bump</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">21</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.6689672431939</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.008139563452106</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">11</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.8278629664608</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">0.48</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.1966772901718</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.34375</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.16</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">0.5884</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s5">1e-10  </span><span class="s0"># aarch64 observed rtol: 1.33e-15</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">484</span><span class="s3">, </span><span class="s5">967</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s5">3</span><span class="s3">/</span><span class="s5">47</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">13</span><span class="s3">, </span><span class="s5">46</span><span class="s3">, </span><span class="s5">13</span><span class="s3">/</span><span class="s5">46</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">15</span><span class="s3">, </span><span class="s5">44</span><span class="s3">, </span><span class="s5">15</span><span class="s3">/</span><span class="s5">44</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">13</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">6</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_binary_srch_for_binom_tst</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test that old behavior of binomtest is maintained</span>
        <span class="s0"># by the new binary search method in cases where d</span>
        <span class="s0"># exactly equals the input on one side.</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s5">0.5</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s0"># First test for the case where k &gt; mode of PMF</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">n</span><span class="s3">), </span><span class="s1">n</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>
        <span class="s0"># Old way of calculating y, probably consistent with R.</span>
        <span class="s1">y1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">) &lt;= </span><span class="s1">d</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s0"># New way with binary search.</span>
        <span class="s1">ix </span><span class="s3">= </span><span class="s1">_binary_search_for_binom_tst</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x1</span><span class="s3">:</span>
                                          <span class="s3">-</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">),</span>
                                          <span class="s3">-</span><span class="s1">d</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">n</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">y2 </span><span class="s3">= </span><span class="s1">n </span><span class="s3">- </span><span class="s1">ix </span><span class="s3">+ </span><span class="s1">int</span><span class="s3">(</span><span class="s1">d </span><span class="s3">== </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">ix</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-9</span><span class="s3">)</span>
        <span class="s0"># Now test for the other side.</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">n</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>
        <span class="s0"># Old way of calculating y.</span>
        <span class="s1">y1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">) &lt;= </span><span class="s1">d</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s0"># New way with binary search.</span>
        <span class="s1">ix </span><span class="s3">= </span><span class="s1">_binary_search_for_binom_tst</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x1</span><span class="s3">:</span>
                                          <span class="s1">stats</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">),</span>
                                          <span class="s1">d</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">y2 </span><span class="s3">= </span><span class="s1">ix </span><span class="s3">+ </span><span class="s5">1</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-9</span><span class="s3">)</span>

    <span class="s0"># Expected results here are from R 3.6.2 binom.test</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'alternative, pval, ci_low, ci_high'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">0.148831050443</span><span class="s3">,</span>
                               <span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.2772002496709138</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">0.9004695898947</span><span class="s3">,</span>
                               <span class="s5">0.1366613252458672</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s5">0.2983720970096</span><span class="s3">,</span>
                               <span class="s5">0.1266555521019559</span><span class="s3">, </span><span class="s5">0.2918426890886281</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_confidence_intervals1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.25</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">)</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s5">0.95</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">((</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">low</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">.</span><span class="s1">high</span><span class="s3">), (</span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s0"># Expected results here are from R 3.6.2 binom.test.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'alternative, pval, ci_low, ci_high'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s4">'less'</span><span class="s3">,</span>
                               <span class="s5">0.005656361</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.1872093</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'greater'</span><span class="s3">,</span>
                               <span class="s5">0.9987146</span><span class="s3">, </span><span class="s5">0.008860761</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'two-sided'</span><span class="s3">,</span>
                               <span class="s5">0.01191714</span><span class="s3">, </span><span class="s5">0.006872485</span><span class="s3">, </span><span class="s5">0.202706269</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_confidence_intervals2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.06</span><span class="s3">)</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s5">0.99</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">((</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">low</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">.</span><span class="s1">high</span><span class="s3">), (</span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s0"># Expected results here are from R 3.6.2 binom.test.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'alternative, pval, ci_high'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">0.05631351</span><span class="s3">, </span><span class="s5">0.2588656</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s5">0.07604122</span><span class="s3">, </span><span class="s5">0.3084971</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_confidence_interval_exact_k0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">):</span>
        <span class="s0"># Test with k=0, n = 10.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.25</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s5">0.95</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">low</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">high</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s0"># Expected results here are from R 3.6.2 binom.test.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'alternative, pval, ci_low'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s4">'less'</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'greater'</span><span class="s3">, </span><span class="s5">9.536743e-07</span><span class="s3">, </span><span class="s5">0.7411344</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s5">9.536743e-07</span><span class="s3">, </span><span class="s5">0.6915029</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_confidence_interval_exact_k_is_n</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">ci_low</span><span class="s3">):</span>
        <span class="s0"># Test with k = n = 10.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.25</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">pval</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s5">0.95</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">high</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">low</span><span class="s3">, </span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s0"># Expected results are from the prop.test function in R 3.6.2.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">'k, alternative, corr, conf, ci_low, ci_high'</span><span class="s3">,</span>
        <span class="s3">[[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.08094782</span><span class="s3">, </span><span class="s5">0.64632928</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.0586329</span><span class="s3">, </span><span class="s5">0.7169416</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.1077913</span><span class="s3">, </span><span class="s5">0.6032219</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.07956632</span><span class="s3">, </span><span class="s5">0.6799753</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.6043476</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.6901811</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.5583002</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.6507187</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.09644904</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.06659141</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.1268766</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">0.08974147</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>

         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.3445372</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.2775328</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.2847374</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.212942</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>

         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.6554628</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.7224672</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.7152626</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">],</span>
         <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.787058</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_ci_wilson_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">corr</span><span class="s3">, </span><span class="s1">conf</span><span class="s3">,</span>
                              <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">corr</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s4">'wilsoncc'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s4">'wilson'</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s1">conf</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">((</span><span class="s1">ci</span><span class="s3">.</span><span class="s1">low</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">.</span><span class="s1">high</span><span class="s3">), (</span><span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_high</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_estimate_equals_hypothesized_prop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test the special case where the estimated proportion equals</span>
        <span class="s0"># the hypothesized proportion.  When alternative is 'two-sided',</span>
        <span class="s0"># the p-value is 1.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'k, n'</span><span class="s3">, [(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), (-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_invalid_k_n</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                           <span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;must be an integer not less than&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_k_too_big</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                           <span class="s1">match</span><span class="s3">=</span><span class="s4">r&quot;k \(11\) must not be greater than n \(10\).&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">11</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_k_wrong_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">,</span>
                           <span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;k must be an integer.&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">([</span><span class="s5">10</span><span class="s3">, </span><span class="s5">11</span><span class="s3">], </span><span class="s5">21</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_p_range</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">r'p \(-0.5\) must be in range...'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=-</span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">r'p \(1.5\) must be in range...'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">1.5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_confidence_level</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">r&quot;confidence_level \(-1\) must be in the interval&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_ci_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">r&quot;method \('plate of shrimp'\) must be&quot;</span><span class="s3">):</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;plate of shrimp&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_alternative</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">r&quot;alternative \('ekki'\) not...&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'ekki'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alias</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_estimate</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">maxsize </span><span class="s3">&lt;= </span><span class="s5">2</span><span class="s3">**</span><span class="s5">32</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;32-bit does not overflow&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_boost_overflow_raises</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Boost.Math error policy should raise exceptions in Python</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">OverflowError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'Error in function...'</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">float_info</span><span class="s3">.</span><span class="s1">min</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestFligner</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># numbers from R: fligner.test in package stats</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">**</span><span class="s5">2</span><span class="s3">),</span>
                                  <span class="s3">(</span><span class="s5">3.2282229927203536</span><span class="s3">, </span><span class="s5">0.072379187848207877</span><span class="s3">),</span>
                                  <span class="s5">11</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_trimmed1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Perturb input to break ties in the transformed data</span>
        <span class="s0"># See https://github.com/scipy/scipy/pull/8042 for more details</span>
        <span class="s1">rs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">123</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">_perturb</span><span class="s3">(</span><span class="s1">g</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">g</span><span class="s3">) + </span><span class="s5">1e-10 </span><span class="s3">* </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">g</span><span class="s3">))).</span><span class="s1">tolist</span><span class="s3">()</span>

        <span class="s1">g1_ </span><span class="s3">= </span><span class="s1">_perturb</span><span class="s3">(</span><span class="s1">g1</span><span class="s3">)</span>
        <span class="s1">g2_ </span><span class="s3">= </span><span class="s1">_perturb</span><span class="s3">(</span><span class="s1">g2</span><span class="s3">)</span>
        <span class="s1">g3_ </span><span class="s3">= </span><span class="s1">_perturb</span><span class="s3">(</span><span class="s1">g3</span><span class="s3">)</span>
        <span class="s0"># Test that center='trimmed' gives the same result as center='mean'</span>
        <span class="s0"># when proportiontocut=0.</span>
        <span class="s1">Xsq1</span><span class="s3">, </span><span class="s1">pval1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">g1_</span><span class="s3">, </span><span class="s1">g2_</span><span class="s3">, </span><span class="s1">g3_</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">)</span>
        <span class="s1">Xsq2</span><span class="s3">, </span><span class="s1">pval2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">g1_</span><span class="s3">, </span><span class="s1">g2_</span><span class="s3">, </span><span class="s1">g3_</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trimmed'</span><span class="s3">,</span>
                                    <span class="s1">proportiontocut</span><span class="s3">=</span><span class="s5">0.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Xsq1</span><span class="s3">, </span><span class="s1">Xsq2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval1</span><span class="s3">, </span><span class="s1">pval2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_trimmed2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">6.0</span><span class="s3">, </span><span class="s5">7.0</span><span class="s3">, </span><span class="s5">100.0</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">4.5</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">5.5</span><span class="s3">, </span><span class="s5">200.0</span><span class="s3">]</span>
        <span class="s0"># Use center='trimmed'</span>
        <span class="s1">Xsq1</span><span class="s3">, </span><span class="s1">pval1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trimmed'</span><span class="s3">,</span>
                                    <span class="s1">proportiontocut</span><span class="s3">=</span><span class="s5">0.125</span><span class="s3">)</span>
        <span class="s0"># Trim the data here, and use center='mean'</span>
        <span class="s1">Xsq2</span><span class="s3">, </span><span class="s1">pval2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">)</span>
        <span class="s0"># Result should be the same.</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">Xsq1</span><span class="s3">, </span><span class="s1">Xsq2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pval1</span><span class="s3">, </span><span class="s1">pval2</span><span class="s3">)</span>

    <span class="s0"># The following test looks reasonable at first, but fligner() uses the</span>
    <span class="s0"># function stats.rankdata(), and in one of the cases in this test,</span>
    <span class="s0"># there are ties, while in the other (because of normal rounding</span>
    <span class="s0"># errors) there are not.  This difference leads to differences in the</span>
    <span class="s0"># third significant digit of W.</span>
    <span class="s0">#</span>
    <span class="s0">#def test_equal_mean_median(self):</span>
    <span class="s0">#    x = np.linspace(-1,1,21)</span>
    <span class="s0">#    y = x**3</span>
    <span class="s0">#    W1, pval1 = stats.fligner(x, y, center='mean')</span>
    <span class="s0">#    W2, pval2 = stats.fligner(x, y, center='median')</span>
    <span class="s0">#    assert_almost_equal(W1, W2)</span>
    <span class="s0">#    assert_almost_equal(pval1, pval2)</span>

    <span class="s2">def </span><span class="s1">test_bad_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">portiontocut</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_center_value</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">center</span><span class="s3">=</span><span class="s4">'trim'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_num_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Too few args raises ValueError.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_empty_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">fligner</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">**</span><span class="s5">2</span><span class="s3">, [])</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">mood_cases_with_ties</span><span class="s3">():</span>
    <span class="s0"># Generate random `x` and `y` arrays with ties both between and within the</span>
    <span class="s0"># samples. Expected results are (statistic, pvalue) from SAS.</span>
    <span class="s1">expected_results </span><span class="s3">= [(-</span><span class="s5">1.76658511464992</span><span class="s3">, </span><span class="s5">.0386488678399305</span><span class="s3">),</span>
                        <span class="s3">(-</span><span class="s5">.694031428192304</span><span class="s3">, </span><span class="s5">.2438312498647250</span><span class="s3">),</span>
                        <span class="s3">(-</span><span class="s5">1.15093525352151</span><span class="s3">, </span><span class="s5">.1248794365836150</span><span class="s3">)]</span>
    <span class="s1">seeds </span><span class="s3">= [</span><span class="s5">23453254</span><span class="s3">, </span><span class="s5">1298352315</span><span class="s3">, </span><span class="s5">987234597</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">si</span><span class="s3">, </span><span class="s1">seed </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">seeds</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">xy </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s0"># Generate random indices to make ties</span>
        <span class="s1">tie_ind </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">99</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s0"># Generate a random number of ties for each index.</span>
        <span class="s1">num_ties_per_ind </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s0"># At each `tie_ind`, mark the next `n` indices equal to that value.</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">n </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">tie_ind</span><span class="s3">, </span><span class="s1">num_ties_per_ind</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">i </span><span class="s3">+ </span><span class="s1">n</span><span class="s3">):</span>
                <span class="s1">xy</span><span class="s3">[</span><span class="s1">j</span><span class="s3">] = </span><span class="s1">xy</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
        <span class="s0"># scramble order of xy before splitting into `x, y`</span>
        <span class="s1">rng</span><span class="s3">.</span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">)</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, *</span><span class="s1">expected_results</span><span class="s3">[</span><span class="s1">si</span><span class="s3">]</span>


<span class="s2">class </span><span class="s1">TestMood</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x,y,alternative,stat_expect,p_expect&quot;</span><span class="s3">,</span>
                             <span class="s1">mood_cases_with_ties</span><span class="s3">())</span>
    <span class="s2">def </span><span class="s1">test_against_SAS</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">stat_expect</span><span class="s3">, </span><span class="s1">p_expect</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Example code used to generate SAS output: 
        DATA myData; 
        INPUT X Y; 
        CARDS; 
        1 0 
        1 1 
        1 2 
        1 3 
        1 4 
        2 0 
        2 1 
        2 4 
        2 9 
        2 16 
        ods graphics on; 
        proc npar1way mood data=myData ; 
           class X; 
            ods output  MoodTest=mt; 
        proc contents data=mt; 
        proc print data=mt; 
          format     Prob1 17.16 Prob2 17.16 Statistic 17.16 Z 17.16 ; 
            title &quot;Mood Two-Sample Test&quot;; 
        proc print data=myData; 
            title &quot;Data for above results&quot;; 
          run; 
        &quot;&quot;&quot;</span>
        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">pvalue </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">stat_expect</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-16</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p_expect</span><span class="s3">, </span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-16</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;alternative, expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s4">'two-sided'</span><span class="s3">, (</span><span class="s5">1.019938533549930</span><span class="s3">,</span>
                                             <span class="s5">.3077576129778760</span><span class="s3">)),</span>
                              <span class="s3">(</span><span class="s4">'less'</span><span class="s3">, (</span><span class="s5">1.019938533549930</span><span class="s3">,</span>
                                        <span class="s5">1 </span><span class="s3">- </span><span class="s5">.1538788064889380</span><span class="s3">)),</span>
                              <span class="s3">(</span><span class="s4">'greater'</span><span class="s3">, (</span><span class="s5">1.019938533549930</span><span class="s3">,</span>
                                           <span class="s5">.1538788064889380</span><span class="s3">))])</span>
    <span class="s2">def </span><span class="s1">test_against_SAS_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s0"># Code to run in SAS in above function</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">111</span><span class="s3">, </span><span class="s5">107</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">99</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">109</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">99</span><span class="s3">,</span>
             <span class="s5">101</span><span class="s3">, </span><span class="s5">96</span><span class="s3">, </span><span class="s5">97</span><span class="s3">, </span><span class="s5">102</span><span class="s3">, </span><span class="s5">107</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">116</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">110</span><span class="s3">, </span><span class="s5">98</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">107</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">105</span><span class="s3">, </span><span class="s5">103</span><span class="s3">, </span><span class="s5">110</span><span class="s3">, </span><span class="s5">105</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">100</span><span class="s3">,</span>
             <span class="s5">96</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">103</span><span class="s3">, </span><span class="s5">104</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">108</span><span class="s3">, </span><span class="s5">106</span><span class="s3">, </span><span class="s5">99</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mood_order_of_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># z should change sign when the order of arguments changes, pvalue</span>
        <span class="s0"># should not change</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">15</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">z1</span><span class="s3">, </span><span class="s1">p1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">z2</span><span class="s3">, </span><span class="s1">p2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s1">z1</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">], [-</span><span class="s1">z2</span><span class="s3">, </span><span class="s1">p2</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_mood_with_axis_none</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test with axis = None, compare with results from R</span>
        <span class="s1">x1 </span><span class="s3">= [-</span><span class="s5">0.626453810742332</span><span class="s3">, </span><span class="s5">0.183643324222082</span><span class="s3">, -</span><span class="s5">0.835628612410047</span><span class="s3">,</span>
              <span class="s5">1.59528080213779</span><span class="s3">, </span><span class="s5">0.329507771815361</span><span class="s3">, -</span><span class="s5">0.820468384118015</span><span class="s3">,</span>
              <span class="s5">0.487429052428485</span><span class="s3">, </span><span class="s5">0.738324705129217</span><span class="s3">, </span><span class="s5">0.575781351653492</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.305388387156356</span><span class="s3">, </span><span class="s5">1.51178116845085</span><span class="s3">, </span><span class="s5">0.389843236411431</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.621240580541804</span><span class="s3">, -</span><span class="s5">2.2146998871775</span><span class="s3">, </span><span class="s5">1.12493091814311</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.0449336090152309</span><span class="s3">, -</span><span class="s5">0.0161902630989461</span><span class="s3">, </span><span class="s5">0.943836210685299</span><span class="s3">,</span>
              <span class="s5">0.821221195098089</span><span class="s3">, </span><span class="s5">0.593901321217509</span><span class="s3">]</span>

        <span class="s1">x2 </span><span class="s3">= [-</span><span class="s5">0.896914546624981</span><span class="s3">, </span><span class="s5">0.184849184646742</span><span class="s3">, </span><span class="s5">1.58784533120882</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">1.13037567424629</span><span class="s3">, -</span><span class="s5">0.0802517565509893</span><span class="s3">, </span><span class="s5">0.132420284381094</span><span class="s3">,</span>
              <span class="s5">0.707954729271733</span><span class="s3">, -</span><span class="s5">0.23969802417184</span><span class="s3">, </span><span class="s5">1.98447393665293</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.138787012119665</span><span class="s3">, </span><span class="s5">0.417650750792556</span><span class="s3">, </span><span class="s5">0.981752777463662</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.392695355503813</span><span class="s3">, -</span><span class="s5">1.03966897694891</span><span class="s3">, </span><span class="s5">1.78222896030858</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">2.31106908460517</span><span class="s3">, </span><span class="s5">0.878604580921265</span><span class="s3">, </span><span class="s5">0.035806718015226</span><span class="s3">,</span>
              <span class="s5">1.01282869212708</span><span class="s3">, </span><span class="s5">0.432265154539617</span><span class="s3">, </span><span class="s5">2.09081920524915</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">1.19992581964387</span><span class="s3">, </span><span class="s5">1.58963820029007</span><span class="s3">, </span><span class="s5">1.95465164222325</span><span class="s3">,</span>
              <span class="s5">0.00493777682814261</span><span class="s3">, -</span><span class="s5">2.45170638784613</span><span class="s3">, </span><span class="s5">0.477237302613617</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s5">0.596558168631403</span><span class="s3">, </span><span class="s5">0.792203270299649</span><span class="s3">, </span><span class="s5">0.289636710177348</span><span class="s3">]</span>

        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">)</span>
        <span class="s1">x1</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">= (</span><span class="s5">10</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">x2</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">= (</span><span class="s5">15</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">),</span>
                                  <span class="s3">[-</span><span class="s5">1.31716607555</span><span class="s3">, </span><span class="s5">0.18778296257</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_mood_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test if the results of mood test in 2-D case are consistent with the</span>
        <span class="s0"># R result for the same inputs.  Numbers from R mood.test().</span>
        <span class="s1">ny </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">ny</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">15</span><span class="s3">, </span><span class="s1">ny</span><span class="s3">)</span>
        <span class="s1">z_vectest</span><span class="s3">, </span><span class="s1">pval_vectest </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ny</span><span class="s3">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s1">z_vectest</span><span class="s3">[</span><span class="s1">j</span><span class="s3">], </span><span class="s1">pval_vectest</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]],</span>
                                      <span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">[:, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">x2</span><span class="s3">[:, </span><span class="s1">j</span><span class="s3">]))</span>

        <span class="s0"># inverse order of dimensions</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">()</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">x2</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">()</span>
        <span class="s1">z_vectest</span><span class="s3">, </span><span class="s1">pval_vectest </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ny</span><span class="s3">):</span>
            <span class="s0"># check axis handling is self consistent</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s1">z_vectest</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">pval_vectest</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]],</span>
                                      <span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :], </span><span class="s1">x2</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :]))</span>

    <span class="s2">def </span><span class="s1">test_mood_3d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">shape </span><span class="s3">= (</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(*</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(*</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">z_vectest</span><span class="s3">, </span><span class="s1">pval_vectest </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s0"># Tests that result for 3-D arrays is equal to that for the</span>
            <span class="s0"># same calculation on a set of 1-D arrays taken from the</span>
            <span class="s0"># 3-D array</span>
            <span class="s1">axes_idx </span><span class="s3">= ([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])  </span><span class="s0"># the two axes != axis</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axes_idx</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]]):</span>
                <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axes_idx</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">][</span><span class="s5">1</span><span class="s3">]]):</span>
                    <span class="s2">if </span><span class="s1">axis </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s1">slice1 </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">]</span>
                        <span class="s1">slice2 </span><span class="s3">= </span><span class="s1">x2</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">]</span>
                    <span class="s2">elif </span><span class="s1">axis </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:</span>
                        <span class="s1">slice1 </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :, </span><span class="s1">j</span><span class="s3">]</span>
                        <span class="s1">slice2 </span><span class="s3">= </span><span class="s1">x2</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :, </span><span class="s1">j</span><span class="s3">]</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">slice1 </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">, :]</span>
                        <span class="s1">slice2 </span><span class="s3">= </span><span class="s1">x2</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">, :]</span>

                    <span class="s1">assert_array_almost_equal</span><span class="s3">([</span><span class="s1">z_vectest</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">],</span>
                                               <span class="s1">pval_vectest</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">]],</span>
                                              <span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">slice1</span><span class="s3">, </span><span class="s1">slice2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_mood_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Warns when the sum of the lengths of the args is less than 3</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], [])</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mood_alternative</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">=</span><span class="s5">0.75</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">=</span><span class="s5">1.25</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>

        <span class="s1">stat1</span><span class="s3">, </span><span class="s1">p1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'two-sided'</span><span class="s3">)</span>
        <span class="s1">stat2</span><span class="s3">, </span><span class="s1">p2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">)</span>
        <span class="s1">stat3</span><span class="s3">, </span><span class="s1">p3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">stat1 </span><span class="s3">== </span><span class="s1">stat2 </span><span class="s3">== </span><span class="s1">stat3</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p2</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p3</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">p1</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`alternative` must be...&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'ekki-ekki'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;alternative&quot;</span><span class="s3">, [</span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s4">'less'</span><span class="s3">, </span><span class="s4">'greater'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">265827767938813079281100964083953437622</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s5">15</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mood</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s1">alternative</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">((</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestProbplot</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345</span><span class="s3">)</span>
        <span class="s1">osm</span><span class="s3">, </span><span class="s1">osr </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">osm_expected </span><span class="s3">= [-</span><span class="s5">1.8241636</span><span class="s3">, -</span><span class="s5">1.38768012</span><span class="s3">, -</span><span class="s5">1.11829229</span><span class="s3">, -</span><span class="s5">0.91222575</span><span class="s3">,</span>
                        <span class="s3">-</span><span class="s5">0.73908135</span><span class="s3">, -</span><span class="s5">0.5857176</span><span class="s3">, -</span><span class="s5">0.44506467</span><span class="s3">, -</span><span class="s5">0.31273668</span><span class="s3">,</span>
                        <span class="s3">-</span><span class="s5">0.18568928</span><span class="s3">, -</span><span class="s5">0.06158146</span><span class="s3">, </span><span class="s5">0.06158146</span><span class="s3">, </span><span class="s5">0.18568928</span><span class="s3">,</span>
                        <span class="s5">0.31273668</span><span class="s3">, </span><span class="s5">0.44506467</span><span class="s3">, </span><span class="s5">0.5857176</span><span class="s3">, </span><span class="s5">0.73908135</span><span class="s3">,</span>
                        <span class="s5">0.91222575</span><span class="s3">, </span><span class="s5">1.11829229</span><span class="s3">, </span><span class="s5">1.38768012</span><span class="s3">, </span><span class="s5">1.8241636</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osr</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osm</span><span class="s3">, </span><span class="s1">osm_expected</span><span class="s3">)</span>

        <span class="s1">res</span><span class="s3">, </span><span class="s1">res_fit </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">res_fit_expected </span><span class="s3">= [</span><span class="s5">1.05361841</span><span class="s3">, </span><span class="s5">0.31297795</span><span class="s3">, </span><span class="s5">0.98741609</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res_fit</span><span class="s3">, </span><span class="s1">res_fit_expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sparams_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123456</span><span class="s3">)</span>
        <span class="s0"># Check that None, () and 0 (loc=0, for normal distribution) all work</span>
        <span class="s0"># and give the same results</span>
        <span class="s1">osm1</span><span class="s3">, </span><span class="s1">osr1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">osm2</span><span class="s3">, </span><span class="s1">osr2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">osm3</span><span class="s3">, </span><span class="s1">osr3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=(), </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osm1</span><span class="s3">, </span><span class="s1">osm2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osm1</span><span class="s3">, </span><span class="s1">osm3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osr1</span><span class="s3">, </span><span class="s1">osr2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osr1</span><span class="s3">, </span><span class="s1">osr3</span><span class="s3">)</span>
        <span class="s0"># Check giving (loc, scale) params for normal distribution</span>
        <span class="s1">osm</span><span class="s3">, </span><span class="s1">osr </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=(), </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dist_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345</span><span class="s3">)</span>
        <span class="s1">osm1</span><span class="s3">, </span><span class="s1">osr1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">'t'</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=(</span><span class="s5">3</span><span class="s3">,))</span>
        <span class="s1">osm2</span><span class="s3">, </span><span class="s1">osr2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">t</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=(</span><span class="s5">3</span><span class="s3">,))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osm1</span><span class="s3">, </span><span class="s1">osm2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osr1</span><span class="s3">, </span><span class="s1">osr2</span><span class="s3">)</span>

        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">'wrong-dist-name'</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=[])</span>

        <span class="s2">class </span><span class="s1">custom_dist</span><span class="s3">:</span>
            <span class="s6">&quot;&quot;&quot;Some class that looks just enough like a distribution.&quot;&quot;&quot;</span>
            <span class="s2">def </span><span class="s1">ppf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">q</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">ppf</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

        <span class="s1">osm1</span><span class="s3">, </span><span class="s1">osr1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">sparams</span><span class="s3">=(</span><span class="s5">2</span><span class="s3">,), </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">osm2</span><span class="s3">, </span><span class="s1">osr2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s1">custom_dist</span><span class="s3">(), </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osm1</span><span class="s3">, </span><span class="s1">osm2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">osr1</span><span class="s3">, </span><span class="s1">osr2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_plot_kwarg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">fig </span><span class="s3">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">t</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">7654321</span><span class="s3">)</span>
        <span class="s1">res1</span><span class="s3">, </span><span class="s1">fitres1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">plt</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">res2</span><span class="s3">, </span><span class="s1">fitres2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">res3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">plt</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">res4 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s0"># Check that results are consistent between combinations of `fit` and</span>
        <span class="s0"># `plot` keywords.</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res2</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res3</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">res4</span><span class="s3">) == </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res1</span><span class="s3">, </span><span class="s1">res4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">fitres1</span><span class="s3">, </span><span class="s1">fitres2</span><span class="s3">)</span>

        <span class="s0"># Check that a Matplotlib Axes object is accepted</span>
        <span class="s1">fig </span><span class="s3">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_probplot_bad_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError when given an invalid distribution.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">], </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">&quot;plate_of_shrimp&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">([], </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
                     <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([])))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">([], </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                     <span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([])),</span>
                      <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_array_of_size_one</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">probplot</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], </span><span class="s1">fit</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                         <span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">])),</span>
                          <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)))</span>


<span class="s2">class </span><span class="s1">TestWilcoxon</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_wilcoxon_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError when two args of different lengths are given or</span>
        <span class="s0"># zero_method is unknown.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">&quot;dummy&quot;</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                      <span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;dummy&quot;</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">]*</span><span class="s5">10</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;xyz&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_zero_diff</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)</span>
        <span class="s0"># pratt and wilcox do not work if x - y == 0</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s4">&quot;wilcox&quot;</span><span class="s3">,</span>
                      <span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s4">&quot;pratt&quot;</span><span class="s3">,</span>
                      <span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s0"># ranksum is n*(n+1)/2, split in half if zero_method == &quot;zsplit&quot;</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s4">&quot;zsplit&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">),</span>
                     <span class="s3">(</span><span class="s5">20</span><span class="s3">*</span><span class="s5">21</span><span class="s3">/</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_pratt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># regression test for gh-6805: p-value matches value from R package</span>
        <span class="s0"># coin (wilcoxsign_test) reported in the issue</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Sample size too small&quot;</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">zero_method</span><span class="s3">=</span><span class="s4">&quot;pratt&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, (</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.31731050786291415</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_wilcoxon_arg_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Should be able to accept list as arguments.</span>
        <span class="s0"># Address issue 6070.</span>
        <span class="s1">arr </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

        <span class="s1">_ </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">zero_method</span><span class="s3">=</span><span class="s4">&quot;pratt&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">_ </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">zero_method</span><span class="s3">=</span><span class="s4">&quot;zsplit&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">_ </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">zero_method</span><span class="s3">=</span><span class="s4">&quot;wilcox&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_accuracy_wilcoxon</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">freq </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">nums </span><span class="s3">= </span><span class="s1">range</span><span class="s3">(-</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([[</span><span class="s1">u</span><span class="s3">] * </span><span class="s1">v </span><span class="s2">for </span><span class="s1">u</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">nums</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>

        <span class="s1">T</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s4">&quot;pratt&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s5">423</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0031724568006762576</span><span class="s3">)</span>

        <span class="s1">T</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s4">&quot;zsplit&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s5">441</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.0032145343172473055</span><span class="s3">)</span>

        <span class="s1">T</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s4">&quot;wilcox&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s5">327</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.00641346115861</span><span class="s3">)</span>

        <span class="s0"># Test the 'correction' option, using values computed in R with:</span>
        <span class="s0"># &gt; wilcox.test(x, y, paired=TRUE, exact=FALSE, correct={FALSE,TRUE})</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">120</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">181</span><span class="s3">, </span><span class="s5">188</span><span class="s3">, </span><span class="s5">180</span><span class="s3">, </span><span class="s5">146</span><span class="s3">, </span><span class="s5">121</span><span class="s3">, </span><span class="s5">191</span><span class="s3">, </span><span class="s5">132</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">127</span><span class="s3">, </span><span class="s5">112</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">133</span><span class="s3">, </span><span class="s5">143</span><span class="s3">, </span><span class="s5">119</span><span class="s3">, </span><span class="s5">189</span><span class="s3">, </span><span class="s5">112</span><span class="s3">, </span><span class="s5">199</span><span class="s3">, </span><span class="s5">198</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">115</span><span class="s3">, </span><span class="s5">121</span><span class="s3">, </span><span class="s5">142</span><span class="s3">, </span><span class="s5">187</span><span class="s3">])</span>
        <span class="s1">T</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s5">34</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.6948866</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
        <span class="s1">T</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s5">34</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.7240817</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wilcoxon_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">120</span><span class="s3">, </span><span class="s5">114</span><span class="s3">, </span><span class="s5">181</span><span class="s3">, </span><span class="s5">188</span><span class="s3">, </span><span class="s5">180</span><span class="s3">, </span><span class="s5">146</span><span class="s3">, </span><span class="s5">121</span><span class="s3">, </span><span class="s5">191</span><span class="s3">, </span><span class="s5">132</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">127</span><span class="s3">, </span><span class="s5">112</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">133</span><span class="s3">, </span><span class="s5">143</span><span class="s3">, </span><span class="s5">119</span><span class="s3">, </span><span class="s5">189</span><span class="s3">, </span><span class="s5">112</span><span class="s3">, </span><span class="s5">199</span><span class="s3">, </span><span class="s5">198</span><span class="s3">, </span><span class="s5">113</span><span class="s3">, </span><span class="s5">115</span><span class="s3">, </span><span class="s5">121</span><span class="s3">, </span><span class="s5">142</span><span class="s3">, </span><span class="s5">187</span><span class="s3">])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">attributes </span><span class="s3">= (</span><span class="s4">'statistic'</span><span class="s3">, </span><span class="s4">'pvalue'</span><span class="s3">)</span>
        <span class="s1">check_named_results</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wilcoxon_has_zstatistic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">89426135444</span><span class="s3">)</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">15</span><span class="s3">), </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">15</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">ppf</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">zstatistic</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s4">'zstatistic'</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s4">'zstatistic'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wilcoxon_tie</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-2391.</span>
        <span class="s0"># Corresponding R code is:</span>
        <span class="s0">#   &gt; result = wilcox.test(rep(0.1, 10), exact=FALSE, correct=FALSE)</span>
        <span class="s0">#   &gt; result$p.value</span>
        <span class="s0">#   [1] 0.001565402</span>
        <span class="s0">#   &gt; result = wilcox.test(rep(0.1, 10), exact=FALSE, correct=TRUE)</span>
        <span class="s0">#   &gt; result$p.value</span>
        <span class="s0">#   [1] 0.001904195</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">expected_p </span><span class="s3">= </span><span class="s5">0.001565402</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">expected_p</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">expected_p </span><span class="s3">= </span><span class="s5">0.001904195</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">expected_p</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_onesided</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># tested against &quot;R version 3.4.1 (2017-06-30)&quot;</span>
        <span class="s0"># x &lt;- c(125, 115, 130, 140, 140, 115, 140, 125, 140, 135)</span>
        <span class="s0"># y &lt;- c(110, 122, 125, 120, 140, 124, 123, 137, 135, 145)</span>
        <span class="s0"># cfg &lt;- list(x = x, y = y, paired = TRUE, exact = FALSE)</span>
        <span class="s0"># do.call(wilcox.test, c(cfg, list(alternative = &quot;less&quot;, correct = FALSE)))</span>
        <span class="s0"># do.call(wilcox.test, c(cfg, list(alternative = &quot;less&quot;, correct = TRUE)))</span>
        <span class="s0"># do.call(wilcox.test, c(cfg, list(alternative = &quot;greater&quot;, correct = FALSE)))</span>
        <span class="s0"># do.call(wilcox.test, c(cfg, list(alternative = &quot;greater&quot;, correct = TRUE)))</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">125</span><span class="s3">, </span><span class="s5">115</span><span class="s3">, </span><span class="s5">130</span><span class="s3">, </span><span class="s5">140</span><span class="s3">, </span><span class="s5">140</span><span class="s3">, </span><span class="s5">115</span><span class="s3">, </span><span class="s5">140</span><span class="s3">, </span><span class="s5">125</span><span class="s3">, </span><span class="s5">140</span><span class="s3">, </span><span class="s5">135</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">110</span><span class="s3">, </span><span class="s5">122</span><span class="s3">, </span><span class="s5">125</span><span class="s3">, </span><span class="s5">120</span><span class="s3">, </span><span class="s5">140</span><span class="s3">, </span><span class="s5">124</span><span class="s3">, </span><span class="s5">123</span><span class="s3">, </span><span class="s5">137</span><span class="s3">, </span><span class="s5">135</span><span class="s3">, </span><span class="s5">145</span><span class="s3">]</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Sample size too small&quot;</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;less&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">27</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.7031847</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Sample size too small&quot;</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;less&quot;</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                                  <span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">27</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.7233656</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Sample size too small&quot;</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;greater&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">27</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.2968153</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Sample size too small&quot;</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;greater&quot;</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                                  <span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s5">27</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.3176447</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exact_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">51</span><span class="s3">):</span>
            <span class="s1">pmf1 </span><span class="s3">= </span><span class="s1">_get_wilcoxon_distr</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
            <span class="s1">pmf2 </span><span class="s3">= </span><span class="s1">_get_wilcoxon_distr2</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*(</span><span class="s1">n</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)/</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">pmf1</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">pmf1</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pmf1</span><span class="s3">, </span><span class="s1">pmf2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exact_pval</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># expected values computed with &quot;R version 3.4.1 (2017-06-30)&quot;</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.81</span><span class="s3">, </span><span class="s5">0.82</span><span class="s3">, </span><span class="s5">1.56</span><span class="s3">, -</span><span class="s5">0.48</span><span class="s3">, </span><span class="s5">0.81</span><span class="s3">, </span><span class="s5">1.28</span><span class="s3">, -</span><span class="s5">1.04</span><span class="s3">, </span><span class="s5">0.23</span><span class="s3">,</span>
                      <span class="s3">-</span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">0.14</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.71</span><span class="s3">, </span><span class="s5">0.65</span><span class="s3">, -</span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.85</span><span class="s3">, -</span><span class="s5">1.1</span><span class="s3">, -</span><span class="s5">0.45</span><span class="s3">, -</span><span class="s5">0.84</span><span class="s3">, -</span><span class="s5">0.24</span><span class="s3">,</span>
                      <span class="s3">-</span><span class="s5">0.68</span><span class="s3">, -</span><span class="s5">0.76</span><span class="s3">])</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;two-sided&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.1054688</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;less&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.9580078</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;greater&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.05273438</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">20</span><span class="s3">) + </span><span class="s5">0.5</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;two-sided&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.8694878</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;less&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.4347439</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">&quot;greater&quot;</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.5795889</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">6</span><span class="s3">)</span>

    <span class="s0"># These inputs were chosen to give a W statistic that is either the</span>
    <span class="s0"># center of the distribution (when the length of the support is odd), or</span>
    <span class="s0"># the value to the left of the center (when the length of the support is</span>
    <span class="s0"># even).  Also, the numbers are chosen so that the W statistic is the</span>
    <span class="s0"># sum of the positive values.</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [[-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
                                   <span class="s3">[-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, -</span><span class="s5">3</span><span class="s3">, -</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                                   <span class="s3">[-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, -</span><span class="s5">4</span><span class="s3">, -</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">]])</span>
    <span class="s2">def </span><span class="s1">test_exact_p_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">wtrue </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[</span><span class="s1">x </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">wtrue</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_auto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># auto default to exact if there are no ties and n&lt;= 25</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">25</span><span class="s3">) + </span><span class="s5">0.5</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">25</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">),</span>
                     <span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;exact&quot;</span><span class="s3">))</span>

        <span class="s0"># if there are ties (i.e. zeros in d = x-y), then switch to approx</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">13</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s4">&quot;Exact p-value calculation&quot;</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">), (</span><span class="s1">w</span><span class="s3">, </span><span class="s1">p</span><span class="s3">))</span>

        <span class="s0"># use approximation for samples &gt; 25</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">52</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">d</span><span class="s3">), </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;approx&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'size'</span><span class="s3">, [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_permutation_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">size</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">92348034828501345</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">PermutationMethod</span><span class="s3">())</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'exact'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">*</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">59234803482850134</span><span class="s3">)</span>
        <span class="s1">pm </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">PermutationMethod</span><span class="s3">(</span><span class="s1">n_resamples</span><span class="s3">=</span><span class="s5">99</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">pm</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">59234803482850134</span><span class="s3">)</span>
        <span class="s1">pm </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">PermutationMethod</span><span class="s3">(</span><span class="s1">n_resamples</span><span class="s3">=</span><span class="s5">99</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">pm</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">)  </span><span class="s0"># n_resamples used</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">)  </span><span class="s0"># random_state used</span>

    <span class="s2">def </span><span class="s1">test_method_auto_nan_propagate_ND_length_gt_50_gh20591</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># When method!='approx', nan_policy='propagate', and a slice of</span>
        <span class="s0"># a &gt;1 dimensional array input contained NaN, the result object of</span>
        <span class="s0"># `wilcoxon` could (under yet other conditions) return `zstatistic`</span>
        <span class="s0"># for some slices but not others. This resulted in an error because</span>
        <span class="s0"># `apply_along_axis` would have to create a ragged array.</span>
        <span class="s0"># Check that this is resolved.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">235889269872456</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">51</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))  </span><span class="s0"># length along slice &gt; exact threshold</span>
        <span class="s1">A</span><span class="s3">[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'approx'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">, </span><span class="s4">'zstatistic'</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s4">'zstatistic'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'method'</span><span class="s3">, [</span><span class="s4">'exact'</span><span class="s3">, </span><span class="s4">'approx'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_symmetry_gh19872_gh20752</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s0"># Check that one-sided exact tests obey required symmetry. Bug reported</span>
        <span class="s0"># in gh-19872 and again in gh-20752; example from gh-19872 is more concise:</span>
        <span class="s1">var1 </span><span class="s3">= [</span><span class="s5">62</span><span class="s3">, </span><span class="s5">66</span><span class="s3">, </span><span class="s5">61</span><span class="s3">, </span><span class="s5">68</span><span class="s3">, </span><span class="s5">74</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">68</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">55</span><span class="s3">, </span><span class="s5">59</span><span class="s3">]</span>
        <span class="s1">var2 </span><span class="s3">= [</span><span class="s5">71</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">69</span><span class="s3">, </span><span class="s5">61</span><span class="s3">, </span><span class="s5">75</span><span class="s3">, </span><span class="s5">71</span><span class="s3">, </span><span class="s5">77</span><span class="s3">, </span><span class="s5">72</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">65</span><span class="s3">]</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">var1</span><span class="s3">, </span><span class="s1">var2</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'less'</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">wilcoxon</span><span class="s3">(</span><span class="s1">var2</span><span class="s3">, </span><span class="s1">var1</span><span class="s3">, </span><span class="s1">alternative</span><span class="s3">=</span><span class="s4">'greater'</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">max_statistic </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">var1</span><span class="s3">) * (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">var1</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">) / </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">int</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">) != </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">max_statistic </span><span class="s3">- </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s0"># data for k-statistics tests from</span>
<span class="s0"># https://cran.r-project.org/web/packages/kStatistics/kStatistics.pdf</span>
<span class="s0"># see nKS &quot;Examples&quot;</span>
<span class="s1">x_kstat </span><span class="s3">= [</span><span class="s5">16.34</span><span class="s3">, </span><span class="s5">10.76</span><span class="s3">, </span><span class="s5">11.84</span><span class="s3">, </span><span class="s5">13.55</span><span class="s3">, </span><span class="s5">15.85</span><span class="s3">, </span><span class="s5">18.20</span><span class="s3">, </span><span class="s5">7.51</span><span class="s3">, </span><span class="s5">10.22</span><span class="s3">, </span><span class="s5">12.52</span><span class="s3">, </span><span class="s5">14.68</span><span class="s3">,</span>
           <span class="s5">16.08</span><span class="s3">, </span><span class="s5">19.43</span><span class="s3">, </span><span class="s5">8.12</span><span class="s3">, </span><span class="s5">11.20</span><span class="s3">, </span><span class="s5">12.95</span><span class="s3">, </span><span class="s5">14.77</span><span class="s3">, </span><span class="s5">16.83</span><span class="s3">, </span><span class="s5">19.80</span><span class="s3">, </span><span class="s5">8.55</span><span class="s3">, </span><span class="s5">11.58</span><span class="s3">,</span>
           <span class="s5">12.10</span><span class="s3">, </span><span class="s5">15.02</span><span class="s3">, </span><span class="s5">16.83</span><span class="s3">, </span><span class="s5">16.98</span><span class="s3">, </span><span class="s5">19.92</span><span class="s3">, </span><span class="s5">9.47</span><span class="s3">, </span><span class="s5">11.68</span><span class="s3">, </span><span class="s5">13.41</span><span class="s3">, </span><span class="s5">15.35</span><span class="s3">, </span><span class="s5">19.11</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">array_api_compatible</span>
<span class="s2">class </span><span class="s1">TestKstat</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_moments_normal_distribution</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">32149</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">12345</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">moments </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">n</span><span class="s3">) </span><span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">0.011315</span><span class="s3">, </span><span class="s5">1.017931</span><span class="s3">, </span><span class="s5">0.05811052</span><span class="s3">, </span><span class="s5">0.0754134</span><span class="s3">],</span>
                              <span class="s1">dtype</span><span class="s3">=</span><span class="s1">data</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">moments</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>

        <span class="s0"># test equivalence with `stats.moment`</span>
        <span class="s1">m1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">moment</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">moment</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">m3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">moment</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">((</span><span class="s1">m1</span><span class="s3">, </span><span class="s1">m2</span><span class="s3">, </span><span class="s1">m3</span><span class="s3">)), </span><span class="s1">expected</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.02</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">is_numpy</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([]))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):  </span><span class="s0"># for array_api_strict</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([]))</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_nan_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10.</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">data </span><span class="s3">== </span><span class="s5">6</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">), </span><span class="s1">data</span><span class="s3">)</span>

        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'n'</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4.001</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_kstat_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError if n &gt; 4 or n &lt; 1.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">'k-statistics only supported for 1&lt;=n&lt;=4'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'case'</span><span class="s3">, [(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">14.02166666666667</span><span class="s3">),</span>
                                      <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">12.65006954022974</span><span class="s3">),</span>
                                      <span class="s3">(</span><span class="s5">3</span><span class="s3">, -</span><span class="s5">1.447059503280798</span><span class="s3">),</span>
                                      <span class="s3">(</span><span class="s5">4</span><span class="s3">, -</span><span class="s5">141.6682291883626</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_against_R</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">case</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Test against reference values computed with R kStatistics, e.g.</span>
        <span class="s0"># options(digits=16)</span>
        <span class="s0"># library(kStatistics)</span>
        <span class="s0"># data &lt;-c (16.34, 10.76, 11.84, 13.55, 15.85, 18.20, 7.51, 10.22,</span>
        <span class="s0">#           12.52, 14.68, 16.08, 19.43, 8.12, 11.20, 12.95, 14.77,</span>
        <span class="s0">#           16.83, 19.80, 8.55, 11.58, 12.10, 15.02, 16.83, 16.98,</span>
        <span class="s0">#           19.92, 9.47, 11.68, 13.41, 15.35, 19.11)</span>
        <span class="s0"># nKS(4, data)</span>
        <span class="s1">n</span><span class="s3">, </span><span class="s1">ref </span><span class="s3">= </span><span class="s1">case</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x_kstat</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">array_api_compatible</span>
<span class="s2">class </span><span class="s1">TestKstatVar</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_empty_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([])</span>
        <span class="s2">if </span><span class="s1">is_numpy</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstatvar</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):  </span><span class="s0"># for array_api_strict</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstatvar</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_nan_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10.</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">data </span><span class="s3">== </span><span class="s5">6</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">), </span><span class="s1">data</span><span class="s3">)</span>

        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">np_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'input validation of `n` does not depend on backend'</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;skip_xp_backends&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError is n is not 1 or 2.</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">'Only n=1 or n=2 supported.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">kstatvar</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_against_R_mathworld</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Test against reference values computed using formulas exactly as</span>
        <span class="s0"># they appear at https://mathworld.wolfram.com/k-Statistic.html</span>
        <span class="s0"># This is *really* similar to how they appear in the implementation,</span>
        <span class="s0"># but that could change, and this should not.</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">x_kstat</span><span class="s3">)</span>
        <span class="s1">k2 </span><span class="s3">= </span><span class="s5">12.65006954022974  </span><span class="s0"># see source code in TestKstat</span>
        <span class="s1">k4 </span><span class="s3">= -</span><span class="s5">141.6682291883626</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstatvar</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x_kstat</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">k2 </span><span class="s3">/ </span><span class="s1">n</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstatvar</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x_kstat</span><span class="s3">), </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s0"># *unbiased estimator* for var(k2)</span>
        <span class="s1">ref </span><span class="s3">= (</span><span class="s5">2</span><span class="s3">*</span><span class="s1">k2</span><span class="s3">**</span><span class="s5">2</span><span class="s3">*</span><span class="s1">n </span><span class="s3">+ (</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)*</span><span class="s1">k4</span><span class="s3">) / (</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">n</span><span class="s3">+</span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestPpccPlot</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">500</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">7654321</span><span class="s3">) + </span><span class="s5">5</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">svals</span><span class="s3">, </span><span class="s1">ppcc </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s1">N</span><span class="s3">)</span>
        <span class="s1">ppcc_expected </span><span class="s3">= [</span><span class="s5">0.21139644</span><span class="s3">, </span><span class="s5">0.21384059</span><span class="s3">, </span><span class="s5">0.98766719</span><span class="s3">, </span><span class="s5">0.97980182</span><span class="s3">,</span>
                         <span class="s5">0.93519298</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svals</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s1">N</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ppcc</span><span class="s3">, </span><span class="s1">ppcc_expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test that we can specify distributions both by name and as objects.</span>
        <span class="s1">svals1</span><span class="s3">, </span><span class="s1">ppcc1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">'tukeylambda'</span><span class="s3">)</span>
        <span class="s1">svals2</span><span class="s3">, </span><span class="s1">ppcc2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">,</span>
                                        <span class="s1">dist</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">tukeylambda</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svals1</span><span class="s3">, </span><span class="s1">svals2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-20</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ppcc1</span><span class="s3">, </span><span class="s1">ppcc2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-20</span><span class="s3">)</span>
        <span class="s0"># Test that 'tukeylambda' is the default dist</span>
        <span class="s1">svals3</span><span class="s3">, </span><span class="s1">ppcc3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svals1</span><span class="s3">, </span><span class="s1">svals3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-20</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ppcc1</span><span class="s3">, </span><span class="s1">ppcc3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-20</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_plot_kwarg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check with the matplotlib.pyplot module</span>
        <span class="s1">fig </span><span class="s3">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">plt</span><span class="s3">)</span>
        <span class="s1">fig</span><span class="s3">.</span><span class="s1">delaxes</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>

        <span class="s0"># Check that a Matplotlib Axes object is accepted</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_invalid_inputs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># `b` has to be larger than `a`</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s0"># Raise ValueError when given an invalid distribution.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">,</span>
                      <span class="s1">dist</span><span class="s3">=</span><span class="s4">&quot;plate_of_shrimp&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># For consistency with probplot return for one empty array,</span>
        <span class="s0"># ppcc contains all zeros and svals is the same as for normal array</span>
        <span class="s0"># input.</span>
        <span class="s1">svals</span><span class="s3">, </span><span class="s1">ppcc </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_plot</span><span class="s3">([], </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svals</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s5">80</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ppcc</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">80</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestPpccMax</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_ppcc_max_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError when given an invalid distribution.</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">&quot;plate_of_shrimp&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ppcc_max_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">tukeylambda</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(-</span><span class="s5">0.7</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">,</span>
                                  <span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234567</span><span class="s3">) + </span><span class="s5">1e4</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), -</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">tukeylambda</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(-</span><span class="s5">0.7</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">,</span>
                                  <span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234567</span><span class="s3">) + </span><span class="s5">1e4</span>

        <span class="s0"># Test that we can specify distributions both by name and as objects.</span>
        <span class="s1">max1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s4">'tukeylambda'</span><span class="s3">)</span>
        <span class="s1">max2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">tukeylambda</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">max1</span><span class="s3">, -</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">max2</span><span class="s3">, -</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

        <span class="s0"># Test that 'tukeylambda' is the default dist</span>
        <span class="s1">max3 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">max3</span><span class="s3">, -</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_brack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">tukeylambda</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(-</span><span class="s5">0.7</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">,</span>
                                  <span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234567</span><span class="s3">) + </span><span class="s5">1e4</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=(</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">))</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)),</span>
                            <span class="s3">-</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ppcc_max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=(-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)),</span>
                            <span class="s3">-</span><span class="s5">0.71215366521264145</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestBoxcox_llf</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">llf_expected </span><span class="s3">= -</span><span class="s1">x</span><span class="s3">.</span><span class="s1">size </span><span class="s3">/ </span><span class="s5">2. </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">std</span><span class="s3">()**</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">llf</span><span class="s3">, </span><span class="s1">llf_expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">llf2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">llf</span><span class="s3">, </span><span class="s1">llf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_2d_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Note: boxcox_llf() was already working with 2-D input (sort of), so</span>
        <span class="s0"># keep it like that.  boxcox() doesn't work with 2-D input though, due</span>
        <span class="s0"># to brent() returning a scalar.</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">llf2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">]).</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">([</span><span class="s1">llf</span><span class="s3">, </span><span class="s1">llf</span><span class="s3">], </span><span class="s1">llf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, [])))</span>

    <span class="s2">def </span><span class="s1">test_gh_6873</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-6873.</span>
        <span class="s0"># This example was taken from gh-7534, a duplicate of gh-6873.</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">198.0</span><span class="s3">, </span><span class="s5">233.0</span><span class="s3">, </span><span class="s5">233.0</span><span class="s3">, </span><span class="s5">392.0</span><span class="s3">]</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(-</span><span class="s5">8</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
        <span class="s0"># The expected value was computed with mpmath.</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">llf</span><span class="s3">, -</span><span class="s5">17.93934208579061</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_instability_gh20021</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">2003</span><span class="s3">, </span><span class="s5">1950</span><span class="s3">, </span><span class="s5">1997</span><span class="s3">, </span><span class="s5">2000</span><span class="s3">, </span><span class="s5">2009</span><span class="s3">]</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_llf</span><span class="s3">(</span><span class="s5">1e-8</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
        <span class="s0"># The expected value was computed with mpsci, set mpmath.mp.dps=100</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">llf</span><span class="s3">, -</span><span class="s5">15.32401272869016598</span><span class="s3">)</span>


<span class="s0"># This is the data from github user Qukaiyi, given as an example</span>
<span class="s0"># of a data set that caused boxcox to fail.</span>
<span class="s1">_boxcox_data </span><span class="s3">= [</span>
    <span class="s5">15957</span><span class="s3">, </span><span class="s5">112079</span><span class="s3">, </span><span class="s5">1039553</span><span class="s3">, </span><span class="s5">711775</span><span class="s3">, </span><span class="s5">173111</span><span class="s3">, </span><span class="s5">307382</span><span class="s3">, </span><span class="s5">183155</span><span class="s3">, </span><span class="s5">53366</span><span class="s3">, </span><span class="s5">760875</span><span class="s3">,</span>
    <span class="s5">207500</span><span class="s3">, </span><span class="s5">160045</span><span class="s3">, </span><span class="s5">473714</span><span class="s3">, </span><span class="s5">40194</span><span class="s3">, </span><span class="s5">440319</span><span class="s3">, </span><span class="s5">133261</span><span class="s3">, </span><span class="s5">265444</span><span class="s3">, </span><span class="s5">155590</span><span class="s3">, </span><span class="s5">36660</span><span class="s3">,</span>
    <span class="s5">904939</span><span class="s3">, </span><span class="s5">55108</span><span class="s3">, </span><span class="s5">138391</span><span class="s3">, </span><span class="s5">339146</span><span class="s3">, </span><span class="s5">458053</span><span class="s3">, </span><span class="s5">63324</span><span class="s3">, </span><span class="s5">1377727</span><span class="s3">, </span><span class="s5">1342632</span><span class="s3">, </span><span class="s5">41575</span><span class="s3">,</span>
    <span class="s5">68685</span><span class="s3">, </span><span class="s5">172755</span><span class="s3">, </span><span class="s5">63323</span><span class="s3">, </span><span class="s5">368161</span><span class="s3">, </span><span class="s5">199695</span><span class="s3">, </span><span class="s5">538214</span><span class="s3">, </span><span class="s5">167760</span><span class="s3">, </span><span class="s5">388610</span><span class="s3">, </span><span class="s5">398855</span><span class="s3">,</span>
    <span class="s5">1001873</span><span class="s3">, </span><span class="s5">364591</span><span class="s3">, </span><span class="s5">1320518</span><span class="s3">, </span><span class="s5">194060</span><span class="s3">, </span><span class="s5">194324</span><span class="s3">, </span><span class="s5">2318551</span><span class="s3">, </span><span class="s5">196114</span><span class="s3">, </span><span class="s5">64225</span><span class="s3">, </span><span class="s5">272000</span><span class="s3">,</span>
    <span class="s5">198668</span><span class="s3">, </span><span class="s5">123585</span><span class="s3">, </span><span class="s5">86420</span><span class="s3">, </span><span class="s5">1925556</span><span class="s3">, </span><span class="s5">695798</span><span class="s3">, </span><span class="s5">88664</span><span class="s3">, </span><span class="s5">46199</span><span class="s3">, </span><span class="s5">759135</span><span class="s3">, </span><span class="s5">28051</span><span class="s3">,</span>
    <span class="s5">345094</span><span class="s3">, </span><span class="s5">1977752</span><span class="s3">, </span><span class="s5">51778</span><span class="s3">, </span><span class="s5">82746</span><span class="s3">, </span><span class="s5">638126</span><span class="s3">, </span><span class="s5">2560910</span><span class="s3">, </span><span class="s5">45830</span><span class="s3">, </span><span class="s5">140576</span><span class="s3">, </span><span class="s5">1603787</span><span class="s3">,</span>
    <span class="s5">57371</span><span class="s3">, </span><span class="s5">548730</span><span class="s3">, </span><span class="s5">5343629</span><span class="s3">, </span><span class="s5">2298913</span><span class="s3">, </span><span class="s5">998813</span><span class="s3">, </span><span class="s5">2156812</span><span class="s3">, </span><span class="s5">423966</span><span class="s3">, </span><span class="s5">68350</span><span class="s3">, </span><span class="s5">145237</span><span class="s3">,</span>
    <span class="s5">131935</span><span class="s3">, </span><span class="s5">1600305</span><span class="s3">, </span><span class="s5">342359</span><span class="s3">, </span><span class="s5">111398</span><span class="s3">, </span><span class="s5">1409144</span><span class="s3">, </span><span class="s5">281007</span><span class="s3">, </span><span class="s5">60314</span><span class="s3">, </span><span class="s5">242004</span><span class="s3">, </span><span class="s5">113418</span><span class="s3">,</span>
    <span class="s5">246211</span><span class="s3">, </span><span class="s5">61940</span><span class="s3">, </span><span class="s5">95858</span><span class="s3">, </span><span class="s5">957805</span><span class="s3">, </span><span class="s5">40909</span><span class="s3">, </span><span class="s5">307955</span><span class="s3">, </span><span class="s5">174159</span><span class="s3">, </span><span class="s5">124278</span><span class="s3">, </span><span class="s5">241193</span><span class="s3">,</span>
    <span class="s5">872614</span><span class="s3">, </span><span class="s5">304180</span><span class="s3">, </span><span class="s5">146719</span><span class="s3">, </span><span class="s5">64361</span><span class="s3">, </span><span class="s5">87478</span><span class="s3">, </span><span class="s5">509360</span><span class="s3">, </span><span class="s5">167169</span><span class="s3">, </span><span class="s5">933479</span><span class="s3">, </span><span class="s5">620561</span><span class="s3">,</span>
    <span class="s5">483333</span><span class="s3">, </span><span class="s5">97416</span><span class="s3">, </span><span class="s5">143518</span><span class="s3">, </span><span class="s5">286905</span><span class="s3">, </span><span class="s5">597837</span><span class="s3">, </span><span class="s5">2556043</span><span class="s3">, </span><span class="s5">89065</span><span class="s3">, </span><span class="s5">69944</span><span class="s3">, </span><span class="s5">196858</span><span class="s3">,</span>
    <span class="s5">88883</span><span class="s3">, </span><span class="s5">49379</span><span class="s3">, </span><span class="s5">916265</span><span class="s3">, </span><span class="s5">1527392</span><span class="s3">, </span><span class="s5">626954</span><span class="s3">, </span><span class="s5">54415</span><span class="s3">, </span><span class="s5">89013</span><span class="s3">, </span><span class="s5">2883386</span><span class="s3">, </span><span class="s5">106096</span><span class="s3">,</span>
    <span class="s5">402697</span><span class="s3">, </span><span class="s5">45578</span><span class="s3">, </span><span class="s5">349852</span><span class="s3">, </span><span class="s5">140379</span><span class="s3">, </span><span class="s5">34648</span><span class="s3">, </span><span class="s5">757343</span><span class="s3">, </span><span class="s5">1305442</span><span class="s3">, </span><span class="s5">2054757</span><span class="s3">, </span><span class="s5">121232</span><span class="s3">,</span>
    <span class="s5">606048</span><span class="s3">, </span><span class="s5">101492</span><span class="s3">, </span><span class="s5">51426</span><span class="s3">, </span><span class="s5">1820833</span><span class="s3">, </span><span class="s5">83412</span><span class="s3">, </span><span class="s5">136349</span><span class="s3">, </span><span class="s5">1379924</span><span class="s3">, </span><span class="s5">505977</span><span class="s3">, </span><span class="s5">1303486</span><span class="s3">,</span>
    <span class="s5">95853</span><span class="s3">, </span><span class="s5">146451</span><span class="s3">, </span><span class="s5">285422</span><span class="s3">, </span><span class="s5">2205423</span><span class="s3">, </span><span class="s5">259020</span><span class="s3">, </span><span class="s5">45864</span><span class="s3">, </span><span class="s5">684547</span><span class="s3">, </span><span class="s5">182014</span><span class="s3">, </span><span class="s5">784334</span><span class="s3">,</span>
    <span class="s5">174793</span><span class="s3">, </span><span class="s5">563068</span><span class="s3">, </span><span class="s5">170745</span><span class="s3">, </span><span class="s5">1195531</span><span class="s3">, </span><span class="s5">63337</span><span class="s3">, </span><span class="s5">71833</span><span class="s3">, </span><span class="s5">199978</span><span class="s3">, </span><span class="s5">2330904</span><span class="s3">, </span><span class="s5">227335</span><span class="s3">,</span>
    <span class="s5">898280</span><span class="s3">, </span><span class="s5">75294</span><span class="s3">, </span><span class="s5">2011361</span><span class="s3">, </span><span class="s5">116771</span><span class="s3">, </span><span class="s5">157489</span><span class="s3">, </span><span class="s5">807147</span><span class="s3">, </span><span class="s5">1321443</span><span class="s3">, </span><span class="s5">1148635</span><span class="s3">, </span><span class="s5">2456524</span><span class="s3">,</span>
    <span class="s5">81839</span><span class="s3">, </span><span class="s5">1228251</span><span class="s3">, </span><span class="s5">97488</span><span class="s3">, </span><span class="s5">1051892</span><span class="s3">, </span><span class="s5">75397</span><span class="s3">, </span><span class="s5">3009923</span><span class="s3">, </span><span class="s5">2732230</span><span class="s3">, </span><span class="s5">90923</span><span class="s3">, </span><span class="s5">39735</span><span class="s3">,</span>
    <span class="s5">132433</span><span class="s3">, </span><span class="s5">225033</span><span class="s3">, </span><span class="s5">337555</span><span class="s3">, </span><span class="s5">1204092</span><span class="s3">, </span><span class="s5">686588</span><span class="s3">, </span><span class="s5">1062402</span><span class="s3">, </span><span class="s5">40362</span><span class="s3">, </span><span class="s5">1361829</span><span class="s3">, </span><span class="s5">1497217</span><span class="s3">,</span>
    <span class="s5">150074</span><span class="s3">, </span><span class="s5">551459</span><span class="s3">, </span><span class="s5">2019128</span><span class="s3">, </span><span class="s5">39581</span><span class="s3">, </span><span class="s5">45349</span><span class="s3">, </span><span class="s5">1117187</span><span class="s3">, </span><span class="s5">87845</span><span class="s3">, </span><span class="s5">1877288</span><span class="s3">, </span><span class="s5">164448</span><span class="s3">,</span>
    <span class="s5">10338362</span><span class="s3">, </span><span class="s5">24942</span><span class="s3">, </span><span class="s5">64737</span><span class="s3">, </span><span class="s5">769946</span><span class="s3">, </span><span class="s5">2469124</span><span class="s3">, </span><span class="s5">2366997</span><span class="s3">, </span><span class="s5">259124</span><span class="s3">, </span><span class="s5">2667585</span><span class="s3">, </span><span class="s5">29175</span><span class="s3">,</span>
    <span class="s5">56250</span><span class="s3">, </span><span class="s5">74450</span><span class="s3">, </span><span class="s5">96697</span><span class="s3">, </span><span class="s5">5920978</span><span class="s3">, </span><span class="s5">838375</span><span class="s3">, </span><span class="s5">225914</span><span class="s3">, </span><span class="s5">119494</span><span class="s3">, </span><span class="s5">206004</span><span class="s3">, </span><span class="s5">430907</span><span class="s3">,</span>
    <span class="s5">244083</span><span class="s3">, </span><span class="s5">219495</span><span class="s3">, </span><span class="s5">322239</span><span class="s3">, </span><span class="s5">407426</span><span class="s3">, </span><span class="s5">618748</span><span class="s3">, </span><span class="s5">2087536</span><span class="s3">, </span><span class="s5">2242124</span><span class="s3">, </span><span class="s5">4736149</span><span class="s3">, </span><span class="s5">124624</span><span class="s3">,</span>
    <span class="s5">406305</span><span class="s3">, </span><span class="s5">240921</span><span class="s3">, </span><span class="s5">2675273</span><span class="s3">, </span><span class="s5">4425340</span><span class="s3">, </span><span class="s5">821457</span><span class="s3">, </span><span class="s5">578467</span><span class="s3">, </span><span class="s5">28040</span><span class="s3">, </span><span class="s5">348943</span><span class="s3">, </span><span class="s5">48795</span><span class="s3">,</span>
    <span class="s5">145531</span><span class="s3">, </span><span class="s5">52110</span><span class="s3">, </span><span class="s5">1645730</span><span class="s3">, </span><span class="s5">1768364</span><span class="s3">, </span><span class="s5">348363</span><span class="s3">, </span><span class="s5">85042</span><span class="s3">, </span><span class="s5">2673847</span><span class="s3">, </span><span class="s5">81935</span><span class="s3">, </span><span class="s5">169075</span><span class="s3">,</span>
    <span class="s5">367733</span><span class="s3">, </span><span class="s5">135474</span><span class="s3">, </span><span class="s5">383327</span><span class="s3">, </span><span class="s5">1207018</span><span class="s3">, </span><span class="s5">93481</span><span class="s3">, </span><span class="s5">5934183</span><span class="s3">, </span><span class="s5">352190</span><span class="s3">, </span><span class="s5">636533</span><span class="s3">, </span><span class="s5">145870</span><span class="s3">,</span>
    <span class="s5">55659</span><span class="s3">, </span><span class="s5">146215</span><span class="s3">, </span><span class="s5">73191</span><span class="s3">, </span><span class="s5">248681</span><span class="s3">, </span><span class="s5">376907</span><span class="s3">, </span><span class="s5">1606620</span><span class="s3">, </span><span class="s5">169381</span><span class="s3">, </span><span class="s5">81164</span><span class="s3">, </span><span class="s5">246390</span><span class="s3">,</span>
    <span class="s5">236093</span><span class="s3">, </span><span class="s5">885778</span><span class="s3">, </span><span class="s5">335969</span><span class="s3">, </span><span class="s5">49266</span><span class="s3">, </span><span class="s5">381430</span><span class="s3">, </span><span class="s5">307437</span><span class="s3">, </span><span class="s5">350077</span><span class="s3">, </span><span class="s5">34346</span><span class="s3">, </span><span class="s5">49340</span><span class="s3">,</span>
    <span class="s5">84715</span><span class="s3">, </span><span class="s5">527120</span><span class="s3">, </span><span class="s5">40163</span><span class="s3">, </span><span class="s5">46898</span><span class="s3">, </span><span class="s5">4609439</span><span class="s3">, </span><span class="s5">617038</span><span class="s3">, </span><span class="s5">2239574</span><span class="s3">, </span><span class="s5">159905</span><span class="s3">, </span><span class="s5">118337</span><span class="s3">,</span>
    <span class="s5">120357</span><span class="s3">, </span><span class="s5">430778</span><span class="s3">, </span><span class="s5">3799158</span><span class="s3">, </span><span class="s5">3516745</span><span class="s3">, </span><span class="s5">54198</span><span class="s3">, </span><span class="s5">2970796</span><span class="s3">, </span><span class="s5">729239</span><span class="s3">, </span><span class="s5">97848</span><span class="s3">, </span><span class="s5">6317375</span><span class="s3">,</span>
    <span class="s5">887345</span><span class="s3">, </span><span class="s5">58198</span><span class="s3">, </span><span class="s5">88111</span><span class="s3">, </span><span class="s5">867595</span><span class="s3">, </span><span class="s5">210136</span><span class="s3">, </span><span class="s5">1572103</span><span class="s3">, </span><span class="s5">1420760</span><span class="s3">, </span><span class="s5">574046</span><span class="s3">, </span><span class="s5">845988</span><span class="s3">,</span>
    <span class="s5">509743</span><span class="s3">, </span><span class="s5">397927</span><span class="s3">, </span><span class="s5">1119016</span><span class="s3">, </span><span class="s5">189955</span><span class="s3">, </span><span class="s5">3883644</span><span class="s3">, </span><span class="s5">291051</span><span class="s3">, </span><span class="s5">126467</span><span class="s3">, </span><span class="s5">1239907</span><span class="s3">, </span><span class="s5">2556229</span><span class="s3">,</span>
    <span class="s5">411058</span><span class="s3">, </span><span class="s5">657444</span><span class="s3">, </span><span class="s5">2025234</span><span class="s3">, </span><span class="s5">1211368</span><span class="s3">, </span><span class="s5">93151</span><span class="s3">, </span><span class="s5">577594</span><span class="s3">, </span><span class="s5">4842264</span><span class="s3">, </span><span class="s5">1531713</span><span class="s3">, </span><span class="s5">305084</span><span class="s3">,</span>
    <span class="s5">479251</span><span class="s3">, </span><span class="s5">20591</span><span class="s3">, </span><span class="s5">1466166</span><span class="s3">, </span><span class="s5">137417</span><span class="s3">, </span><span class="s5">897756</span><span class="s3">, </span><span class="s5">594767</span><span class="s3">, </span><span class="s5">3606337</span><span class="s3">, </span><span class="s5">32844</span><span class="s3">, </span><span class="s5">82426</span><span class="s3">,</span>
    <span class="s5">1294831</span><span class="s3">, </span><span class="s5">57174</span><span class="s3">, </span><span class="s5">290167</span><span class="s3">, </span><span class="s5">322066</span><span class="s3">, </span><span class="s5">813146</span><span class="s3">, </span><span class="s5">5671804</span><span class="s3">, </span><span class="s5">4425684</span><span class="s3">, </span><span class="s5">895607</span><span class="s3">, </span><span class="s5">450598</span><span class="s3">,</span>
    <span class="s5">1048958</span><span class="s3">, </span><span class="s5">232844</span><span class="s3">, </span><span class="s5">56871</span><span class="s3">, </span><span class="s5">46113</span><span class="s3">, </span><span class="s5">70366</span><span class="s3">, </span><span class="s5">701618</span><span class="s3">, </span><span class="s5">97739</span><span class="s3">, </span><span class="s5">157113</span><span class="s3">, </span><span class="s5">865047</span><span class="s3">,</span>
    <span class="s5">194810</span><span class="s3">, </span><span class="s5">1501615</span><span class="s3">, </span><span class="s5">1765727</span><span class="s3">, </span><span class="s5">38125</span><span class="s3">, </span><span class="s5">2733376</span><span class="s3">, </span><span class="s5">40642</span><span class="s3">, </span><span class="s5">437590</span><span class="s3">, </span><span class="s5">127337</span><span class="s3">, </span><span class="s5">106310</span><span class="s3">,</span>
    <span class="s5">4167579</span><span class="s3">, </span><span class="s5">665303</span><span class="s3">, </span><span class="s5">809250</span><span class="s3">, </span><span class="s5">1210317</span><span class="s3">, </span><span class="s5">45750</span><span class="s3">, </span><span class="s5">1853687</span><span class="s3">, </span><span class="s5">348954</span><span class="s3">, </span><span class="s5">156786</span><span class="s3">, </span><span class="s5">90793</span><span class="s3">,</span>
    <span class="s5">1885504</span><span class="s3">, </span><span class="s5">281501</span><span class="s3">, </span><span class="s5">3902273</span><span class="s3">, </span><span class="s5">359546</span><span class="s3">, </span><span class="s5">797540</span><span class="s3">, </span><span class="s5">623508</span><span class="s3">, </span><span class="s5">3672775</span><span class="s3">, </span><span class="s5">55330</span><span class="s3">, </span><span class="s5">648221</span><span class="s3">,</span>
    <span class="s5">266831</span><span class="s3">, </span><span class="s5">90030</span><span class="s3">, </span><span class="s5">7118372</span><span class="s3">, </span><span class="s5">735521</span><span class="s3">, </span><span class="s5">1009925</span><span class="s3">, </span><span class="s5">283901</span><span class="s3">, </span><span class="s5">806005</span><span class="s3">, </span><span class="s5">2434897</span><span class="s3">, </span><span class="s5">94321</span><span class="s3">,</span>
    <span class="s5">309571</span><span class="s3">, </span><span class="s5">4213597</span><span class="s3">, </span><span class="s5">2213280</span><span class="s3">, </span><span class="s5">120339</span><span class="s3">, </span><span class="s5">64403</span><span class="s3">, </span><span class="s5">8155209</span><span class="s3">, </span><span class="s5">1686948</span><span class="s3">, </span><span class="s5">4327743</span><span class="s3">,</span>
    <span class="s5">1868312</span><span class="s3">, </span><span class="s5">135670</span><span class="s3">, </span><span class="s5">3189615</span><span class="s3">, </span><span class="s5">1569446</span><span class="s3">, </span><span class="s5">706058</span><span class="s3">, </span><span class="s5">58056</span><span class="s3">, </span><span class="s5">2438625</span><span class="s3">, </span><span class="s5">520619</span><span class="s3">, </span><span class="s5">105201</span><span class="s3">,</span>
    <span class="s5">141961</span><span class="s3">, </span><span class="s5">179990</span><span class="s3">, </span><span class="s5">1351440</span><span class="s3">, </span><span class="s5">3148662</span><span class="s3">, </span><span class="s5">2804457</span><span class="s3">, </span><span class="s5">2760144</span><span class="s3">, </span><span class="s5">70775</span><span class="s3">, </span><span class="s5">33807</span><span class="s3">, </span><span class="s5">1926518</span><span class="s3">,</span>
    <span class="s5">2362142</span><span class="s3">, </span><span class="s5">186761</span><span class="s3">, </span><span class="s5">240941</span><span class="s3">, </span><span class="s5">97860</span><span class="s3">, </span><span class="s5">1040429</span><span class="s3">, </span><span class="s5">1431035</span><span class="s3">, </span><span class="s5">78892</span><span class="s3">, </span><span class="s5">484039</span><span class="s3">, </span><span class="s5">57845</span><span class="s3">,</span>
    <span class="s5">724126</span><span class="s3">, </span><span class="s5">3166209</span><span class="s3">, </span><span class="s5">175913</span><span class="s3">, </span><span class="s5">159211</span><span class="s3">, </span><span class="s5">1182095</span><span class="s3">, </span><span class="s5">86734</span><span class="s3">, </span><span class="s5">1921472</span><span class="s3">, </span><span class="s5">513546</span><span class="s3">, </span><span class="s5">326016</span><span class="s3">,</span>
    <span class="s5">1891609</span>
<span class="s3">]</span>


<span class="s2">class </span><span class="s1">TestBoxcox</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_fixed_lmbda</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345</span><span class="s3">) + </span><span class="s5">5</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">x </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">- </span><span class="s5">1</span><span class="s3">/</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>

        <span class="s0"># Also test that array_like input works</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>

        <span class="s0"># test that constant input is accepted; see gh-12225</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">10</span><span class="s3">), </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">10</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_lmbda_None</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Start from normal rv's, do inverse transform to check that</span>
        <span class="s0"># optimization function gets close to the right answer.</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">2.5</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50000</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1245</span><span class="s3">)</span>
        <span class="s1">x_inv </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">* </span><span class="s1">lmbda </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)**(-</span><span class="s1">lmbda</span><span class="s3">)</span>
        <span class="s1">xt</span><span class="s3">, </span><span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x_inv</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">maxlog</span><span class="s3">, -</span><span class="s5">1 </span><span class="s3">/ </span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alpha</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">) + </span><span class="s5">5</span>

        <span class="s0"># Some regular values for alpha, on a small sample size</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">interval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.75</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">interval</span><span class="s3">, [</span><span class="s5">4.004485780226041</span><span class="s3">, </span><span class="s5">5.138756355035744</span><span class="s3">])</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">interval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.05</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">interval</span><span class="s3">, [</span><span class="s5">1.2138178554857557</span><span class="s3">, </span><span class="s5">8.209033272375663</span><span class="s3">])</span>

        <span class="s0"># Try some extreme values, see we don't hit the N=500 limit</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">500</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">) + </span><span class="s5">15</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">interval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.001</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">interval</span><span class="s3">, [</span><span class="s5">0.3988867</span><span class="s3">, </span><span class="s5">11.40553131</span><span class="s3">])</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">interval </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.999</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">interval</span><span class="s3">, [</span><span class="s5">5.83316246</span><span class="s3">, </span><span class="s5">5.83735292</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_boxcox_bad_arg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Raise ValueError if any data value is negative.</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s0"># Raise ValueError if data is constant.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">]))</span>
        <span class="s0"># Raise ValueError if data is not 1-dimensional.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">]]))</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">([]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">,))</span>

    <span class="s2">def </span><span class="s1">test_gh_6873</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-6873.</span>
        <span class="s1">y</span><span class="s3">, </span><span class="s1">lam </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">)</span>
        <span class="s0"># The expected value of lam was computed with the function</span>
        <span class="s0"># powerTransform in the R library 'car'.  I trust that value</span>
        <span class="s0"># to only about five significant digits.</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lam</span><span class="s3">, -</span><span class="s5">0.051654</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;bounds&quot;</span><span class="s3">, [(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (-</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1.1</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_bounded_optimizer_within_bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">):</span>
        <span class="s0"># Define custom optimizer with bounds.</span>
        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">minimize_scalar</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">,</span>
                                            <span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;bounded&quot;</span><span class="s3">)</span>

        <span class="s1">_</span><span class="s3">, </span><span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">bounds</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &lt; </span><span class="s1">lmbda </span><span class="s3">&lt; </span><span class="s1">bounds</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_bounded_optimizer_against_unbounded_optimizer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test whether setting bounds on optimizer excludes solution from</span>
        <span class="s0"># unbounded optimizer.</span>

        <span class="s0"># Get unbounded solution.</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

        <span class="s0"># Set tolerance and bounds around solution.</span>
        <span class="s1">bounds </span><span class="s3">= (</span><span class="s1">lmbda </span><span class="s3">+ </span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">lmbda </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">options </span><span class="s3">= {</span><span class="s4">'xatol'</span><span class="s3">: </span><span class="s5">1e-12</span><span class="s3">}</span>

        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">minimize_scalar</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">,</span>
                                            <span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;bounded&quot;</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=</span><span class="s1">options</span><span class="s3">)</span>

        <span class="s0"># Check bounded solution. Lower bound should be active.</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">lmbda_bounded </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                                        <span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">lmbda_bounded </span><span class="s3">!= </span><span class="s1">lmbda</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lmbda_bounded</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;optimizer&quot;</span><span class="s3">, [</span><span class="s4">&quot;str&quot;</span><span class="s3">, (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s5">0.1</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_bad_optimizer_type_raises_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">):</span>
        <span class="s0"># Check if error is raised if string, tuple or float is passed</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`optimizer` must be a callable&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_optimizer_value_raises_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check if error is raised if `optimizer` function does not return</span>
        <span class="s0"># `OptimizeResult` object</span>

        <span class="s0"># Define test function that always returns 1</span>
        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">1</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;return an object containing the optimal `lmbda`&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">_boxcox_data</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
            <span class="s4">&quot;bad_x&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">42</span><span class="s3">, </span><span class="s5">12345.6</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">42</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])]</span>
        <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_negative_x_value_raises_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bad_x</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Test boxcox_normmax raises ValueError if x contains non-positive values.&quot;&quot;&quot;</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;only positive, finite, real numbers&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">bad_x</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [</span>
        <span class="s0"># Attempt to trigger overflow in power expressions.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">,</span>
                  <span class="s5">2009.0</span><span class="s3">, </span><span class="s5">1980.0</span><span class="s3">, </span><span class="s5">1999.0</span><span class="s3">, </span><span class="s5">2007.0</span><span class="s3">, </span><span class="s5">1991.0</span><span class="s3">]),</span>
        <span class="s0"># Attempt to trigger overflow with a large optimal lambda.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">]),</span>
        <span class="s0"># Attempt to trigger overflow with large data.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0e200</span><span class="s3">, </span><span class="s5">1950.0e200</span><span class="s3">, </span><span class="s5">1997.0e200</span><span class="s3">, </span><span class="s5">2000.0e200</span><span class="s3">, </span><span class="s5">2009.0e200</span><span class="s3">])</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_overflow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;The optimal lambda is&quot;</span><span class="s3">):</span>
            <span class="s1">xt_bc</span><span class="s3">, </span><span class="s1">lam_bc </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">xt_bc</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestBoxcoxNormmax</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345</span><span class="s3">) + </span><span class="s5">5</span>

    <span class="s2">def </span><span class="s1">test_pearsonr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog</span><span class="s3">, </span><span class="s5">1.804465</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'mle'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog</span><span class="s3">, </span><span class="s5">1.758101</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

        <span class="s0"># Check that boxcox() uses 'mle'</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">maxlog_boxcox </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog_boxcox</span><span class="s3">, </span><span class="s1">maxlog</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">maxlog_all </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'all'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog_all</span><span class="s3">, [</span><span class="s5">1.804465</span><span class="s3">, </span><span class="s5">1.758101</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s4">&quot;mle&quot;</span><span class="s3">, </span><span class="s4">&quot;pearsonr&quot;</span><span class="s3">, </span><span class="s4">&quot;all&quot;</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;bounds&quot;</span><span class="s3">, [(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (-</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1.1</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_bounded_optimizer_within_bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">minimize_scalar</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">,</span>
                                            <span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;bounded&quot;</span><span class="s3">)</span>

        <span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                                      <span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">bounds</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &lt; </span><span class="s1">maxlog</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">maxlog </span><span class="s3">&lt; </span><span class="s1">bounds</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_user_defined_optimizer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># tests an optimizer that is not based on scipy.optimize.minimize</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">lmbda_rounded </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">lmbda_range </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">lmbda_rounded</span><span class="s3">-</span><span class="s5">0.01</span><span class="s3">, </span><span class="s1">lmbda_rounded</span><span class="s3">+</span><span class="s5">0.01</span><span class="s3">, </span><span class="s5">1001</span><span class="s3">)</span>

        <span class="s2">class </span><span class="s1">MyResult</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">):</span>
            <span class="s0"># brute force minimum over the range</span>
            <span class="s1">objs </span><span class="s3">= []</span>
            <span class="s2">for </span><span class="s1">lmbda </span><span class="s2">in </span><span class="s1">lmbda_range</span><span class="s3">:</span>
                <span class="s1">objs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">))</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">MyResult</span><span class="s3">()</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">lmbda_range</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmin</span><span class="s3">(</span><span class="s1">objs</span><span class="s3">)]</span>
            <span class="s2">return </span><span class="s1">res</span>

        <span class="s1">lmbda2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">lmbda2 </span><span class="s3">!= </span><span class="s1">lmbda                 </span><span class="s0"># not identical</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lmbda2</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">, </span><span class="s5">1e-5</span><span class="s3">)   </span><span class="s0"># but as close as it should be</span>

    <span class="s2">def </span><span class="s1">test_user_defined_optimizer_and_brack_raises_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">optimizer </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">minimize_scalar</span>

        <span class="s0"># Using default `brack=None` with user-defined `optimizer` works as</span>
        <span class="s0"># expected.</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>

        <span class="s0"># Using user-defined `brack` with user-defined `optimizer` is expected</span>
        <span class="s0"># to throw an error. Instead, users should specify</span>
        <span class="s0"># optimizer-specific parameters in the optimizer function itself.</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`brack` must be None if &quot;</span>
                                             <span class="s4">&quot;`optimizer` is given&quot;</span><span class="s3">):</span>

            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=(-</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">),</span>
                                 <span class="s1">optimizer</span><span class="s3">=</span><span class="s1">optimizer</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">'x'</span><span class="s3">, ([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">],</span>
              <span class="s3">[</span><span class="s5">0.50000471</span><span class="s3">, </span><span class="s5">0.50004979</span><span class="s3">, </span><span class="s5">0.50005902</span><span class="s3">, </span><span class="s5">0.50009312</span><span class="s3">, </span><span class="s5">0.50001632</span><span class="s3">]))</span>
    <span class="s2">def </span><span class="s1">test_overflow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The optimal lambda is...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'mle'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">special</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">)).</span><span class="s1">all</span><span class="s3">()</span>
        <span class="s0"># 10000 is safety factor used in boxcox_normmax</span>
        <span class="s1">ymax </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">max </span><span class="s3">/ </span><span class="s5">10000</span>
        <span class="s1">x_treme </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">if </span><span class="s1">lmbda </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">y_extreme </span><span class="s3">= </span><span class="s1">special</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x_treme</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_extreme</span><span class="s3">, </span><span class="s1">ymax </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_negative_ymax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;`ymax` must be strictly positive&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">, [</span>
        <span class="s0"># positive overflow in float64</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">],</span>
                 <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s0"># negative overflow in float64</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.50000471</span><span class="s3">, </span><span class="s5">0.50004979</span><span class="s3">, </span><span class="s5">0.50005902</span><span class="s3">, </span><span class="s5">0.50009312</span><span class="s3">, </span><span class="s5">0.50001632</span><span class="s3">],</span>
                 <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s0"># positive overflow in float32</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">200.3</span><span class="s3">, </span><span class="s5">195.0</span><span class="s3">, </span><span class="s5">199.7</span><span class="s3">, </span><span class="s5">200.0</span><span class="s3">, </span><span class="s5">200.9</span><span class="s3">],</span>
                 <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
        <span class="s0"># negative overflow in float32</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">],</span>
                 <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
    <span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;ymax&quot;</span><span class="s3">, [</span><span class="s5">1e10</span><span class="s3">, </span><span class="s5">1e30</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>
    <span class="s0"># TODO: add method &quot;pearsonr&quot; after fix overflow issue</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s4">&quot;mle&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_user_defined_ymax_input_float64_32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s0"># Test the maximum of the transformed data close to ymax</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;The optimal lambda is&quot;</span><span class="s3">):</span>
            <span class="s1">kwarg </span><span class="s3">= {</span><span class="s4">'ymax'</span><span class="s3">: </span><span class="s1">ymax</span><span class="s3">} </span><span class="s2">if </span><span class="s1">ymax </span><span class="s2">is not None else </span><span class="s3">{}</span>
            <span class="s1">lmb </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, **</span><span class="s1">kwarg</span><span class="s3">)</span>
            <span class="s1">x_treme </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)]</span>
            <span class="s1">ymax_res </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x_treme</span><span class="s3">, </span><span class="s1">lmb</span><span class="s3">)))</span>
            <span class="s2">if </span><span class="s1">ymax </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s0"># 10000 is safety factor used in boxcox_normmax</span>
                <span class="s1">ymax </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">).</span><span class="s1">max </span><span class="s3">/ </span><span class="s5">10000</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ymax</span><span class="s3">, </span><span class="s1">ymax_res</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">, [</span>
        <span class="s0"># positive overflow in float32 but not float64</span>
        <span class="s3">[</span><span class="s5">200.3</span><span class="s3">, </span><span class="s5">195.0</span><span class="s3">, </span><span class="s5">199.7</span><span class="s3">, </span><span class="s5">200.0</span><span class="s3">, </span><span class="s5">200.9</span><span class="s3">],</span>
        <span class="s0"># negative overflow in float32 but not float64</span>
        <span class="s3">[</span><span class="s5">2e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">, </span><span class="s5">1e-30</span><span class="s3">],</span>
    <span class="s3">])</span>
    <span class="s0"># TODO: add method &quot;pearsonr&quot; after fix overflow issue</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s4">&quot;mle&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_user_defined_ymax_inf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">x_32 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">x_64 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

        <span class="s0"># assert overflow with float32 but not float64</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;The optimal lambda is&quot;</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x_32</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x_64</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>

        <span class="s0"># compute the true optimal lambda then compare them</span>
        <span class="s1">lmb_32 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x_32</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">lmb_64 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normmax</span><span class="s3">(</span><span class="s1">x_64</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lmb_32</span><span class="s3">, </span><span class="s1">lmb_64</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestBoxcoxNormplot</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">500</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">7654321</span><span class="s3">) + </span><span class="s5">5</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">lmbdas</span><span class="s3">, </span><span class="s1">ppcc </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s1">N</span><span class="s3">)</span>
        <span class="s1">ppcc_expected </span><span class="s3">= [</span><span class="s5">0.57783375</span><span class="s3">, </span><span class="s5">0.83610988</span><span class="s3">, </span><span class="s5">0.97524311</span><span class="s3">, </span><span class="s5">0.99756057</span><span class="s3">,</span>
                         <span class="s5">0.95843297</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lmbdas</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s1">N</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ppcc</span><span class="s3">, </span><span class="s1">ppcc_expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_plot_kwarg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check with the matplotlib.pyplot module</span>
        <span class="s1">fig </span><span class="s3">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">plt</span><span class="s3">)</span>
        <span class="s1">fig</span><span class="s3">.</span><span class="s1">delaxes</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>

        <span class="s0"># Check that a Matplotlib Axes object is accepted</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">111</span><span class="s3">)</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">plot</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_invalid_inputs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># `lb` has to be larger than `la`</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s0"># `x` can not contain negative values</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">, [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox_normplot</span><span class="s3">([], </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">).</span><span class="s1">size </span><span class="s3">== </span><span class="s5">0</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestYeojohnson_llf</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">llf2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">llf</span><span class="s3">, </span><span class="s1">llf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_2d_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">llf </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">llf2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_llf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">]).</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">([</span><span class="s1">llf</span><span class="s3">, </span><span class="s1">llf</span><span class="s3">], </span><span class="s1">llf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_llf</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, [])))</span>


<span class="s2">class </span><span class="s1">TestYeojohnson</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_fixed_lmbda</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">12345</span><span class="s3">)</span>

        <span class="s0"># Test positive input</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">) + </span><span class="s5">5</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">- </span><span class="s5">1 </span><span class="s3">/ (</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s0"># Test negative input</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">) - </span><span class="s5">5</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(-</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">/ (-</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s0"># test both positive and negative input</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">) - </span><span class="s5">2</span>
        <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">x </span><span class="s3">&gt;= </span><span class="s5">0</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">], </span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">])</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">], </span><span class="s5">1 </span><span class="s3">- </span><span class="s5">1 </span><span class="s3">/ (</span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">], </span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">])</span>

        <span class="s1">neg </span><span class="s3">= ~</span><span class="s1">pos</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">], -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">], </span><span class="s1">x</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">])</span>
        <span class="s1">xt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">], </span><span class="s5">1 </span><span class="s3">/ (-</span><span class="s1">x</span><span class="s3">[</span><span class="s1">neg</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'lmbda'</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_lmbda_None</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
        <span class="s0"># Start from normal rv's, do inverse transform to check that</span>
        <span class="s0"># optimization function gets close to the right answer.</span>

        <span class="s2">def </span><span class="s1">_inverse_transform</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
            <span class="s1">x_inv </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
            <span class="s1">pos </span><span class="s3">= </span><span class="s1">x </span><span class="s3">&gt;= </span><span class="s5">0</span>

            <span class="s0"># when x &gt;= 0</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">) &lt; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">spacing</span><span class="s3">(</span><span class="s5">1.</span><span class="s3">):</span>
                <span class="s1">x_inv</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">]) - </span><span class="s5">1</span>
            <span class="s2">else</span><span class="s3">:  </span><span class="s0"># lmbda != 0</span>
                <span class="s1">x_inv</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">pos</span><span class="s3">] * </span><span class="s1">lmbda </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">/ </span><span class="s1">lmbda</span><span class="s3">) - </span><span class="s5">1</span>

            <span class="s0"># when x &lt; 0</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">lmbda </span><span class="s3">- </span><span class="s5">2</span><span class="s3">) &gt; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">spacing</span><span class="s3">(</span><span class="s5">1.</span><span class="s3">):</span>
                <span class="s1">x_inv</span><span class="s3">[~</span><span class="s1">pos</span><span class="s3">] = </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(-(</span><span class="s5">2 </span><span class="s3">- </span><span class="s1">lmbda</span><span class="s3">) * </span><span class="s1">x</span><span class="s3">[~</span><span class="s1">pos</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">,</span>
                                           <span class="s5">1 </span><span class="s3">/ (</span><span class="s5">2 </span><span class="s3">- </span><span class="s1">lmbda</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:  </span><span class="s0"># lmbda == 2</span>
                <span class="s1">x_inv</span><span class="s3">[~</span><span class="s1">pos</span><span class="s3">] = </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">[~</span><span class="s1">pos</span><span class="s3">])</span>

            <span class="s2">return </span><span class="s1">x_inv</span>

        <span class="s1">n_samples </span><span class="s3">= </span><span class="s5">20000</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234567</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">))</span>

        <span class="s1">x_inv </span><span class="s3">= </span><span class="s1">_inverse_transform</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">)</span>
        <span class="s1">xt</span><span class="s3">, </span><span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x_inv</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">x </span><span class="s3">- </span><span class="s1">xt</span><span class="s3">) / </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xt</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">xt</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">([]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">,))</span>

    <span class="s2">def </span><span class="s1">test_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">54321</span><span class="s3">)</span>
        <span class="s1">xt1</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xt2</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt1</span><span class="s3">, </span><span class="s1">xt2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dtype'</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_input_dtype_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">6</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">err_msg </span><span class="s3">= (</span><span class="s4">'Yeo-Johnson transformation is not defined for complex '</span>
                   <span class="s4">'numbers.'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dtype'</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_input_dtype_integer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s1">x_int </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">x_float </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">xt_int</span><span class="s3">, </span><span class="s1">lmbda_int </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x_int</span><span class="s3">)</span>
        <span class="s1">xt_float</span><span class="s3">, </span><span class="s1">lmbda_float </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x_float</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt_int</span><span class="s3">, </span><span class="s1">xt_float</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lmbda_int</span><span class="s3">, </span><span class="s1">lmbda_float</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_input_high_variance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># non-regression test for gh-10821</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3251637.22</span><span class="s3">, </span><span class="s5">620695.44</span><span class="s3">, </span><span class="s5">11642969.00</span><span class="s3">, </span><span class="s5">2223468.22</span><span class="s3">,</span>
                      <span class="s5">85307500.00</span><span class="s3">, </span><span class="s5">16494389.89</span><span class="s3">, </span><span class="s5">917215.88</span><span class="s3">, </span><span class="s5">11642969.00</span><span class="s3">,</span>
                      <span class="s5">2145773.87</span><span class="s3">, </span><span class="s5">4962000.00</span><span class="s3">, </span><span class="s5">620695.44</span><span class="s3">, </span><span class="s5">651234.50</span><span class="s3">,</span>
                      <span class="s5">1907876.71</span><span class="s3">, </span><span class="s5">4053297.88</span><span class="s3">, </span><span class="s5">3251637.22</span><span class="s3">, </span><span class="s5">3259103.08</span><span class="s3">,</span>
                      <span class="s5">9547969.00</span><span class="s3">, </span><span class="s5">20631286.23</span><span class="s3">, </span><span class="s5">12807072.08</span><span class="s3">, </span><span class="s5">2383819.84</span><span class="s3">,</span>
                      <span class="s5">90114500.00</span><span class="s3">, </span><span class="s5">17209575.46</span><span class="s3">, </span><span class="s5">12852969.00</span><span class="s3">, </span><span class="s5">2414609.99</span><span class="s3">,</span>
                      <span class="s5">2170368.23</span><span class="s3">])</span>
        <span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">lam_yeo </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xt_box</span><span class="s3">, </span><span class="s1">lam_box </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">xt_box</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lam_yeo</span><span class="s3">, </span><span class="s1">lam_box</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;nan&quot;</span><span class="s3">), </span><span class="s5">2.0</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;inf&quot;</span><span class="s3">), </span><span class="s5">2.0</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, -</span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;inf&quot;</span><span class="s3">), </span><span class="s5">2.0</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;nan&quot;</span><span class="s3">), </span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;inf&quot;</span><span class="s3">), -</span><span class="s1">float</span><span class="s3">(</span><span class="s4">&quot;inf&quot;</span><span class="s3">), </span><span class="s5">1.0</span><span class="s3">])</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nonfinite_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'Yeo-Johnson input must be finite'</span><span class="s3">):</span>
            <span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">lam_yeo </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [</span>
        <span class="s0"># Attempt to trigger overflow in power expressions.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">,</span>
                  <span class="s5">2009.0</span><span class="s3">, </span><span class="s5">1980.0</span><span class="s3">, </span><span class="s5">1999.0</span><span class="s3">, </span><span class="s5">2007.0</span><span class="s3">, </span><span class="s5">1991.0</span><span class="s3">]),</span>
        <span class="s0"># Attempt to trigger overflow with a large optimal lambda.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">]),</span>
        <span class="s0"># Attempt to trigger overflow with large data.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0e200</span><span class="s3">, </span><span class="s5">1950.0e200</span><span class="s3">, </span><span class="s5">1997.0e200</span><span class="s3">, </span><span class="s5">2000.0e200</span><span class="s3">, </span><span class="s5">2009.0e200</span><span class="s3">])</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_overflow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s0"># non-regression test for gh-18389</span>

        <span class="s2">def </span><span class="s1">optimizer</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">, </span><span class="s1">lam_yeo</span><span class="s3">):</span>
            <span class="s1">out </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fminbound</span><span class="s3">(</span><span class="s1">fun</span><span class="s3">, -</span><span class="s1">lam_yeo</span><span class="s3">, </span><span class="s1">lam_yeo</span><span class="s3">, </span><span class="s1">xtol</span><span class="s3">=</span><span class="s5">1.48e-08</span><span class="s3">)</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">OptimizeResult</span><span class="s3">()</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">out</span>
            <span class="s2">return </span><span class="s1">result</span>

        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s4">&quot;raise&quot;</span><span class="s3">):</span>
            <span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">lam_yeo </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">xt_box</span><span class="s3">, </span><span class="s1">lam_box </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span>
                <span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">optimizer</span><span class="s3">=</span><span class="s1">partial</span><span class="s3">(</span><span class="s1">optimizer</span><span class="s3">, </span><span class="s1">lam_yeo</span><span class="s3">=</span><span class="s1">lam_yeo</span><span class="s3">))</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">xt_yeo</span><span class="s3">))</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">xt_box</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lam_yeo</span><span class="s3">, </span><span class="s1">lam_box</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">xt_box</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">,</span>
                  <span class="s5">2009.0</span><span class="s3">, </span><span class="s5">1980.0</span><span class="s3">, </span><span class="s5">1999.0</span><span class="s3">, </span><span class="s5">2007.0</span><span class="s3">, </span><span class="s5">1991.0</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2003.0</span><span class="s3">, </span><span class="s5">1950.0</span><span class="s3">, </span><span class="s5">1997.0</span><span class="s3">, </span><span class="s5">2000.0</span><span class="s3">, </span><span class="s5">2009.0</span><span class="s3">])</span>
    <span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'scale'</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1e-12</span><span class="s3">, </span><span class="s5">1e-32</span><span class="s3">, </span><span class="s5">1e-150</span><span class="s3">, </span><span class="s5">1e32</span><span class="s3">, </span><span class="s5">1e200</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'sign'</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_overflow_underflow_signed_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">sign</span><span class="s3">):</span>
        <span class="s0"># non-regression test for gh-18389</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s4">&quot;raise&quot;</span><span class="s3">):</span>
            <span class="s1">xt_yeo</span><span class="s3">, </span><span class="s1">lam_yeo </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">sign </span><span class="s3">* </span><span class="s1">x </span><span class="s3">* </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">sign </span><span class="s3">* </span><span class="s1">x</span><span class="s3">) == </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">xt_yeo</span><span class="s3">))</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">lam_yeo</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">xt_yeo</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, -</span><span class="s5">3</span><span class="s3">]),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>
    <span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'sign'</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'brack'</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, (-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_integer_signed_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">sign</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s4">&quot;raise&quot;</span><span class="s3">):</span>
            <span class="s1">x_int </span><span class="s3">= </span><span class="s1">sign </span><span class="s3">* </span><span class="s1">x</span>
            <span class="s1">x_float </span><span class="s3">= </span><span class="s1">x_int</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
            <span class="s1">lam_yeo_int </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_normmax</span><span class="s3">(</span><span class="s1">x_int</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=</span><span class="s1">brack</span><span class="s3">)</span>
            <span class="s1">xt_yeo_int </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x_int</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s1">lam_yeo_int</span><span class="s3">)</span>
            <span class="s1">lam_yeo_float </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_normmax</span><span class="s3">(</span><span class="s1">x_float</span><span class="s3">, </span><span class="s1">brack</span><span class="s3">=</span><span class="s1">brack</span><span class="s3">)</span>
            <span class="s1">xt_yeo_float </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson</span><span class="s3">(</span><span class="s1">x_float</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">=</span><span class="s1">lam_yeo_float</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">x_int</span><span class="s3">) == </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">xt_yeo_int</span><span class="s3">))</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">lam_yeo_int</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">xt_yeo_int</span><span class="s3">))</span>
            <span class="s2">assert </span><span class="s1">lam_yeo_int </span><span class="s3">== </span><span class="s1">lam_yeo_float</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">xt_yeo_int </span><span class="s3">== </span><span class="s1">xt_yeo_float</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestYeojohnsonNormmax</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">_old_loggamma_rvs</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">12345</span><span class="s3">) + </span><span class="s5">5</span>

    <span class="s2">def </span><span class="s1">test_mle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">maxlog </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_normmax</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">maxlog</span><span class="s3">, </span><span class="s5">1.876393</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_darwin_example</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test from original paper &quot;A new family of power transformations to</span>
        <span class="s0"># improve normality or symmetry&quot; by Yeo and Johnson.</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">6.1</span><span class="s3">, -</span><span class="s5">8.4</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">2.9</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">, </span><span class="s5">5.1</span><span class="s3">, </span><span class="s5">1.8</span><span class="s3">, </span><span class="s5">3.6</span><span class="s3">, </span><span class="s5">7.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">9.3</span><span class="s3">,</span>
             <span class="s5">7.5</span><span class="s3">, -</span><span class="s5">6.0</span><span class="s3">]</span>
        <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">yeojohnson_normmax</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s5">1.305</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">array_api_compatible</span>
<span class="s2">class </span><span class="s1">TestCircFuncs</span><span class="s3">:</span>
    <span class="s0"># In gh-5747, the R package `circular` was used to calculate reference</span>
    <span class="s0"># values for the circular variance, e.g.:</span>
    <span class="s0"># library(circular)</span>
    <span class="s0"># options(digits=16)</span>
    <span class="s0"># x = c(0, 2*pi/3, 5*pi/3)</span>
    <span class="s0"># var.circular(x)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func,expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s5">0.167690146</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">, </span><span class="s5">0.006455174000787767</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">, </span><span class="s5">6.520702116</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_circfuncs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">355.</span><span class="s3">, </span><span class="s5">5.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">359.</span><span class="s3">, </span><span class="s5">10.</span><span class="s3">, </span><span class="s5">350.</span><span class="s3">])</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_circfuncs_small</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Default tolerances won't work here because the reference values</span>
        <span class="s0"># are approximations. Ensure all array types work in float64 to</span>
        <span class="s0"># avoid needing separate float32 and float64 tolerances.</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">20</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">18</span><span class="s3">, </span><span class="s5">19</span><span class="s3">, </span><span class="s5">20.5</span><span class="s3">, </span><span class="s5">19.2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">M1 </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">M2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">M2</span><span class="s3">, </span><span class="s1">M1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

        <span class="s0"># plain torch var/std ddof=1, so we need array_api_compat torch</span>
        <span class="s1">xp_test </span><span class="s3">= </span><span class="s1">array_namespace</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">V1 </span><span class="s3">= </span><span class="s1">xp_test</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">x</span><span class="s3">*</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/</span><span class="s5">180</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s0"># for small variations, circvar is approximately half the</span>
        <span class="s0"># linear variance</span>
        <span class="s1">V1 </span><span class="s3">= </span><span class="s1">V1 </span><span class="s3">/ </span><span class="s5">2.</span>
        <span class="s1">V2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">V2</span><span class="s3">, </span><span class="s1">V1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>

        <span class="s1">S1 </span><span class="s3">= </span><span class="s1">xp_test</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">S2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">S2</span><span class="s3">, </span><span class="s1">S1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func, numpy_func&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">std</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_circfuncs_close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">numpy_func</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># circfuncs should handle very similar inputs (gh-12740)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">0.12675364631578953</span><span class="s3">] * </span><span class="s5">10 </span><span class="s3">+ [</span><span class="s5">0.12675365920187928</span><span class="s3">] * </span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">circstat </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">normal </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">numpy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">circstat</span><span class="s3">, </span><span class="s1">normal</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">2e-8</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'circfunc'</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">,</span>
                                          <span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                          <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_circmean_axis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">, </span><span class="s1">circfunc</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">351</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">352</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">349</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">357</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">358</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">356.</span><span class="s3">]])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (-</span><span class="s5">1</span><span class="s3">,)), </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= [</span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :], </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])]</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= [</span><span class="s1">circfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">], </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])]</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func,expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s5">0.167690146</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">, </span><span class="s5">0.006455174270186603</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">, </span><span class="s5">6.520702116</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_circfuncs_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350.</span><span class="s3">])</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">dtype </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">is_numpy</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_not_omit</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
                <span class="s0"># for array_api_strict</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s4">&quot;Mean of empty slice&quot;</span><span class="s3">)</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s4">&quot;invalid value encountered&quot;</span><span class="s3">)</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_propagate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func,expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">0</span><span class="s3">: </span><span class="s5">355.66582264</span><span class="s3">, </span><span class="s5">1</span><span class="s3">: </span><span class="s5">0.28725053</span><span class="s3">}),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">,</span>
                                <span class="s5">0</span><span class="s3">: </span><span class="s5">0.002570671054089924</span><span class="s3">,</span>
                                <span class="s5">1</span><span class="s3">: </span><span class="s5">0.005545914017677123</span><span class="s3">}),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">0</span><span class="s3">: </span><span class="s5">4.11093193</span><span class="s3">, </span><span class="s5">1</span><span class="s3">: </span><span class="s5">6.04265394</span><span class="s3">})])</span>
    <span class="s2">def </span><span class="s1">test_nan_propagate_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">351</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">352</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">349</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]])</span>
        <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s1">out </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">axis </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">out</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">]))</span>
                <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">out</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:], </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">full_like</span><span class="s3">(</span><span class="s1">out</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:], </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_circmean_scalar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">1.</span><span class="s3">)[()]</span>
        <span class="s1">M1 </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s1">M2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">M2</span><span class="s3">, </span><span class="s1">M1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_circmean_range</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># regression test for gh-6420: circmean(..., high, low) must be</span>
        <span class="s0"># between `high` and `low`</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, -</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
        <span class="s1">xp_assert_less</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
        <span class="s1">xp_assert_less</span><span class="s3">(-</span><span class="s1">m</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_circfuncs_uint8</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># regression test for gh-7255: overflow when working with</span>
        <span class="s0"># numpy uint8 data type</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">150</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">uint8</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">180</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">170.0</span><span class="s3">))</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">180</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">0.2339555554617</span><span class="s3">))</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">180</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">20.91551378</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestCircFuncsNanPolicy</span><span class="s3">:</span>
    <span class="s0"># `nan_policy` is implemented by the `_axis_nan_policy` decorator, which is</span>
    <span class="s0"># not yet array-API compatible. When it is array-API compatible, the generic</span>
    <span class="s0"># tests run on every function will be much stronger than these, so these</span>
    <span class="s0"># will not be necessary. So I don't see a need to make these array-API compatible;</span>
    <span class="s0"># when the time comes, they can just be removed.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func,expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s5">359.4178026893944</span><span class="s3">,</span>
                                <span class="s5">0</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">353.0</span><span class="s3">, </span><span class="s5">6.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">355.5</span><span class="s3">, </span><span class="s5">9.5</span><span class="s3">,</span>
                                             <span class="s5">349.5</span><span class="s3">]),</span>
                                <span class="s5">1</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.16769015</span><span class="s3">, </span><span class="s5">358.66510252</span><span class="s3">])}),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s5">0.008396678483192477</span><span class="s3">,</span>
                                <span class="s5">0</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.9997969</span><span class="s3">, </span><span class="s5">0.4999873</span><span class="s3">, </span><span class="s5">0.4999873</span><span class="s3">,</span>
                                             <span class="s5">6.1230956</span><span class="s3">, </span><span class="s5">0.1249992</span><span class="s3">, </span><span class="s5">0.1249992</span><span class="s3">]</span>
                                            <span class="s3">)*(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/</span><span class="s5">180</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">,</span>
                                <span class="s5">1</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.006455174270186603</span><span class="s3">,</span>
                                             <span class="s5">0.01016767581393285</span><span class="s3">])}),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">,</span>
                               <span class="s3">{</span><span class="s2">None</span><span class="s3">: </span><span class="s5">7.440570778057074</span><span class="s3">,</span>
                                <span class="s5">0</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.00020313</span><span class="s3">, </span><span class="s5">1.00002539</span><span class="s3">, </span><span class="s5">1.00002539</span><span class="s3">,</span>
                                             <span class="s5">3.50108929</span><span class="s3">, </span><span class="s5">0.50000317</span><span class="s3">,</span>
                                             <span class="s5">0.50000317</span><span class="s3">]),</span>
                                <span class="s5">1</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">6.52070212</span><span class="s3">, </span><span class="s5">8.19138093</span><span class="s3">])})])</span>
    <span class="s2">def </span><span class="s1">test_nan_omit_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">351</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">352</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">349</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]])</span>
        <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">axis </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">out </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_nd_omit</span><span class="s3">):</span>
                    <span class="s1">out </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
                    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">out</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">expected</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>
                    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">out</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func,expected&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s5">0.167690146</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">, </span><span class="s5">0.006455174270186603</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">, </span><span class="s5">6.520702116</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_nan_omit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">),</span>
                        <span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_omit_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_1d_omit</span><span class="s3">):</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">)))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_omit_all_axis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">SmallSampleWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">too_small_nd_omit</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]])</span>
            <span class="s1">out </span><span class="s3">= </span><span class="s1">test_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">out</span><span class="s3">).</span><span class="s1">all</span><span class="s3">())</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">out</span><span class="s3">) == </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">,</span>
                             <span class="s3">[[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                              <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                                        <span class="s3">[</span><span class="s5">351</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">352</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">349</span><span class="s3">]])])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_raise</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'raise'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">,</span>
                             <span class="s3">[[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                              <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">355</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">359</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">350</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">],</span>
                                        <span class="s3">[</span><span class="s5">351</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">352</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">349</span><span class="s3">]])])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;test_func&quot;</span><span class="s3">, [</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">,</span>
                                           <span class="s1">stats</span><span class="s3">.</span><span class="s1">circstd</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_bad_nan_policy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">test_func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">360</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'foobar'</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMedianTest</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_bad_n_samples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># median_test requires at least two samples.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_empty_sample</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Each sample must contain at least one value.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_empty_when_ties_ignored</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># The grand median is 1, and all values in the first argument are</span>
        <span class="s0"># equal to the grand median.  With ties=&quot;ignore&quot;, those values are</span>
        <span class="s0"># ignored, which results in the first sample being (in effect) empty.</span>
        <span class="s0"># This should raise a ValueError.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">,</span>
                      <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">ties</span><span class="s3">=</span><span class="s4">&quot;ignore&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_contingency_row</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># The grand median is 1, and with the default ties=&quot;below&quot;, all the</span>
        <span class="s0"># values in the samples are counted as being below the grand median.</span>
        <span class="s0"># This would result a row of zeros in the contingency table, which is</span>
        <span class="s0"># an error.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>

        <span class="s0"># With ties=&quot;above&quot;, all the values are counted as above the</span>
        <span class="s0"># grand median.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                      <span class="s1">ties</span><span class="s3">=</span><span class="s4">&quot;above&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_ties</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                      <span class="s1">ties</span><span class="s3">=</span><span class="s4">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_nan_policy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                      <span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'foobar'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bad_keyword</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                      <span class="s1">foo</span><span class="s3">=</span><span class="s4">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_simple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">med</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s0"># The median is floating point, but this equality test should be safe.</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">med</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">)</span>

        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

        <span class="s0"># The expected values of the contingency table equal the contingency</span>
        <span class="s0"># table, so the statistic should be 0 and the p-value should be 1.</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ties_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test the contingency table calculation.</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">z </span><span class="s3">= [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]</span>
        <span class="s0"># grand median is 5.</span>

        <span class="s0"># Default 'ties' option is &quot;below&quot;.</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">ties</span><span class="s3">=</span><span class="s4">&quot;ignore&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">ties</span><span class="s3">=</span><span class="s4">&quot;above&quot;</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>

    <span class="s2">def </span><span class="s1">test_nan_policy_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">mt1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'propagate'</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">t </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'omit'</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mt1</span><span class="s3">, (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">0.31250000000000006</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">0.57615012203057869</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s4">'raise'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># median_test calls chi2_contingency to compute the test statistic</span>
        <span class="s0"># and p-value.  Make sure it hasn't screwed up the call...</span>

        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">8</span><span class="s3">]</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

        <span class="s1">exp_stat</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">, </span><span class="s1">dof</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">chi2_contingency</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s1">exp_stat</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">)</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lambda_</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

        <span class="s1">exp_stat</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">, </span><span class="s1">dof</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">chi2_contingency</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">lambda_</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s1">exp_stat</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">)</span>

        <span class="s1">stat</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">tbl </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

        <span class="s1">exp_stat</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">, </span><span class="s1">dof</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">chi2_contingency</span><span class="s3">(</span><span class="s1">tbl</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s1">exp_stat</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">exp_p</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;correction&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">median_test</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">correction</span><span class="s3">=</span><span class="s1">correction</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">((</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">median</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">table</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestDirectionalStats</span><span class="s3">:</span>
    <span class="s0"># Reference implementations are not available</span>
    <span class="s2">def </span><span class="s1">test_directional_stats_correctness</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Data from Fisher: Dispersion on a sphere, 1953 and</span>
        <span class="s0"># Mardia and Jupp, Directional Statistics.</span>

        <span class="s1">decl </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">deg2rad</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">343.2</span><span class="s3">, </span><span class="s5">62.</span><span class="s3">, </span><span class="s5">36.9</span><span class="s3">, </span><span class="s5">27.</span><span class="s3">, </span><span class="s5">359.</span><span class="s3">,</span>
                                     <span class="s5">5.7</span><span class="s3">, </span><span class="s5">50.4</span><span class="s3">, </span><span class="s5">357.6</span><span class="s3">, </span><span class="s5">44.</span><span class="s3">]))</span>
        <span class="s1">incl </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">deg2rad</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">66.1</span><span class="s3">, </span><span class="s5">68.7</span><span class="s3">, </span><span class="s5">70.1</span><span class="s3">, </span><span class="s5">82.1</span><span class="s3">, </span><span class="s5">79.5</span><span class="s3">,</span>
                                     <span class="s5">73.</span><span class="s3">, </span><span class="s5">69.3</span><span class="s3">, </span><span class="s5">58.8</span><span class="s3">, </span><span class="s5">51.4</span><span class="s3">]))</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">incl</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">decl</span><span class="s3">),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">incl</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">decl</span><span class="s3">),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">incl</span><span class="s3">)),</span>
                        <span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">dirstats </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">directional_mean </span><span class="s3">= </span><span class="s1">dirstats</span><span class="s3">.</span><span class="s1">mean_direction</span>
        <span class="s1">mean_rounded </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">directional_mean</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>

        <span class="s1">reference_mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.2984</span><span class="s3">, -</span><span class="s5">0.1346</span><span class="s3">, -</span><span class="s5">0.9449</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean_rounded</span><span class="s3">, </span><span class="s1">reference_mean</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'angles, ref'</span><span class="s3">, [</span>
        <span class="s3">([-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/</span><span class="s5">2</span><span class="s3">], </span><span class="s5">1.</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">], </span><span class="s5">0.</span><span class="s3">)</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_directional_stats_2d_special_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">):</span>
            <span class="s1">ref </span><span class="s3">= </span><span class="s1">ref</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">)], </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data</span><span class="s3">).</span><span class="s1">mean_resultant_length</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_directional_stats_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test that for circular data directional_stats</span>
        <span class="s0"># yields the same result as circmean/circvar</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">0xec9a6899d5a2830e0d1af479dbe1fd0c</span><span class="s3">)</span>
        <span class="s1">testdata </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">1000</span><span class="s3">, ))</span>
        <span class="s1">testdata_vector </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">testdata</span><span class="s3">),</span>
                                    <span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">testdata</span><span class="s3">)),</span>
                                   <span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">dirstats </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">testdata_vector</span><span class="s3">)</span>
        <span class="s1">directional_mean </span><span class="s3">= </span><span class="s1">dirstats</span><span class="s3">.</span><span class="s1">mean_direction</span>
        <span class="s1">directional_mean_angle </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan2</span><span class="s3">(</span><span class="s1">directional_mean</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
                                            <span class="s1">directional_mean</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">directional_mean_angle </span><span class="s3">= </span><span class="s1">directional_mean_angle </span><span class="s3">% (</span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
        <span class="s1">circmean </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circmean</span><span class="s3">(</span><span class="s1">testdata</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">circmean</span><span class="s3">, </span><span class="s1">directional_mean_angle</span><span class="s3">)</span>

        <span class="s1">directional_var </span><span class="s3">= </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">dirstats</span><span class="s3">.</span><span class="s1">mean_resultant_length</span>
        <span class="s1">circular_var </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">circvar</span><span class="s3">(</span><span class="s1">testdata</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">directional_var</span><span class="s3">, </span><span class="s1">circular_var</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_directional_mean_higher_dim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test that directional_stats works for higher dimensions</span>
        <span class="s0"># here a 4D array is reduced over axis = 2</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.8660254</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">0.8660254</span><span class="s3">, -</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]])</span>
        <span class="s1">full_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">tile</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">],</span>
                              <span class="s3">[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]],</span>
                             <span class="s3">[[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">],</span>
                              <span class="s3">[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]]])</span>
        <span class="s1">dirstats </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">full_array</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">dirstats</span><span class="s3">.</span><span class="s1">mean_direction</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_directional_stats_list_ndarray_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test that list and numpy array inputs yield same results</span>
        <span class="s1">data </span><span class="s3">= [[</span><span class="s5">0.8660254</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.8660254</span><span class="s3">, -</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
        <span class="s1">data_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data_array</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">mean_direction</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">mean_direction</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">mean_resultant_length</span><span class="s3">,</span>
                        <span class="s1">res</span><span class="s3">.</span><span class="s1">mean_resultant_length</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_directional_stats_1d_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test that one-dimensional data raises ValueError</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, ))</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">r&quot;samples must at least be two-dimensional. &quot;</span>
                   <span class="s4">r&quot;Instead samples has shape: (5,)&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_directional_stats_normalize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test that directional stats calculations yield same results</span>
        <span class="s0"># for unnormalized input with normalize=True and normalized</span>
        <span class="s0"># input with normalize=False</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.8660254</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">1.7320508</span><span class="s3">, -</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">normalize</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">normalized_data </span><span class="s3">= </span><span class="s1">data </span><span class="s3">/ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">,</span>
                                                <span class="s1">keepdims</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">directional_stats</span><span class="s3">(</span><span class="s1">normalized_data</span><span class="s3">,</span>
                                      <span class="s1">normalize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">mean_direction</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">mean_direction</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">mean_resultant_length</span><span class="s3">,</span>
                        <span class="s1">ref</span><span class="s3">.</span><span class="s1">mean_resultant_length</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestFDRControl</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`ps` must include only numbers between 0 and 1&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;Unrecognized `method` 'YAK'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">], </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'YAK'</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`axis` must be an integer or `None`&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1.5</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_against_TileStats</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># See reference [3] of false_discovery_control</span>
        <span class="s1">ps </span><span class="s3">= [</span><span class="s5">0.005</span><span class="s3">, </span><span class="s5">0.009</span><span class="s3">, </span><span class="s5">0.019</span><span class="s3">, </span><span class="s5">0.022</span><span class="s3">, </span><span class="s5">0.051</span><span class="s3">, </span><span class="s5">0.101</span><span class="s3">, </span><span class="s5">0.361</span><span class="s3">, </span><span class="s5">0.387</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s1">ps</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= [</span><span class="s5">0.036</span><span class="s3">, </span><span class="s5">0.036</span><span class="s3">, </span><span class="s5">0.044</span><span class="s3">, </span><span class="s5">0.044</span><span class="s3">, </span><span class="s5">0.082</span><span class="s3">, </span><span class="s5">0.135</span><span class="s3">, </span><span class="s5">0.387</span><span class="s3">, </span><span class="s5">0.387</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;case&quot;</span><span class="s3">,</span>
                             <span class="s3">[([</span><span class="s5">0.24617028</span><span class="s3">, </span><span class="s5">0.01140030</span><span class="s3">, </span><span class="s5">0.05652047</span><span class="s3">, </span><span class="s5">0.06841983</span><span class="s3">,</span>
                                <span class="s5">0.07989886</span><span class="s3">, </span><span class="s5">0.01841490</span><span class="s3">, </span><span class="s5">0.17540784</span><span class="s3">, </span><span class="s5">0.06841983</span><span class="s3">,</span>
                                <span class="s5">0.06841983</span><span class="s3">, </span><span class="s5">0.25464082</span><span class="s3">], </span><span class="s4">'bh'</span><span class="s3">),</span>
                              <span class="s3">([</span><span class="s5">0.72102493</span><span class="s3">, </span><span class="s5">0.03339112</span><span class="s3">, </span><span class="s5">0.16554665</span><span class="s3">, </span><span class="s5">0.20039952</span><span class="s3">,</span>
                                <span class="s5">0.23402122</span><span class="s3">, </span><span class="s5">0.05393666</span><span class="s3">, </span><span class="s5">0.51376399</span><span class="s3">, </span><span class="s5">0.20039952</span><span class="s3">,</span>
                                <span class="s5">0.20039952</span><span class="s3">, </span><span class="s5">0.74583488</span><span class="s3">], </span><span class="s4">'by'</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_against_R</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">case</span><span class="s3">):</span>
        <span class="s0"># Test against p.adjust, e.g.</span>
        <span class="s0"># p = c(0.22155325, 0.00114003,..., 0.0364813 , 0.25464082)</span>
        <span class="s0"># p.adjust(p, &quot;BY&quot;)</span>
        <span class="s1">ref</span><span class="s3">, </span><span class="s1">method </span><span class="s3">= </span><span class="s1">case</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">6134137338861652935</span><span class="s3">)</span>
        <span class="s1">ps </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">loguniform</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">1e-3</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ps</span><span class="s3">[</span><span class="s5">3</span><span class="s3">] = </span><span class="s1">ps</span><span class="s3">[</span><span class="s5">7</span><span class="s3">]  </span><span class="s0"># force a tie</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s1">ps</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_axis_None</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">6134137338861652935</span><span class="s3">)</span>
        <span class="s1">ps </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">loguniform</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">1e-3</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">), </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s1">ps</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s1">ps</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">())</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;axis&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_axis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">6134137338861652935</span><span class="s3">)</span>
        <span class="s1">ps </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">loguniform</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">1e-3</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">), </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s1">ps</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">apply_along_axis</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, </span><span class="s1">ps</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([</span><span class="s5">0.25</span><span class="s3">]), [</span><span class="s5">0.25</span><span class="s3">])</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">(</span><span class="s5">0.25</span><span class="s3">), </span><span class="s5">0.25</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">false_discovery_control</span><span class="s3">([]), [])</span>


<span class="s3">@</span><span class="s1">array_api_compatible</span>
<span class="s2">class </span><span class="s1">TestCommonAxis</span><span class="s3">:</span>
    <span class="s0"># More thorough testing of `axis` in `test_axis_nan_policy`,</span>
    <span class="s0"># but those tests aren't run with array API yet. This class</span>
    <span class="s0"># is in `test_morestats` instead of `test_axis_nan_policy`</span>
    <span class="s0"># because there is no reason to run `test_axis_nan_policy`</span>
    <span class="s0"># with the array API CI job right now.</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'case'</span><span class="s3">, [(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">sem</span><span class="s3">, {}),</span>
                                      <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">, {</span><span class="s4">'n'</span><span class="s3">: </span><span class="s5">4</span><span class="s3">}),</span>
                                      <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">kstat</span><span class="s3">, {</span><span class="s4">'n'</span><span class="s3">: </span><span class="s5">2</span><span class="s3">}),</span>
                                      <span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">variation</span><span class="s3">, {})])</span>
    <span class="s2">def </span><span class="s1">test_axis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">case</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">fun</span><span class="s3">, </span><span class="s1">kwargs </span><span class="s3">= </span><span class="s1">case</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">24598245982345</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)))</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">fun</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">fun</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">], **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])])</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">fun</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">fun</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, :], **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])])</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">fun</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">fun</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (-</span><span class="s5">1</span><span class="s3">,)), **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>
</pre>
</body>
</html>