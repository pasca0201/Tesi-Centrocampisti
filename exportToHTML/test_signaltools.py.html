<html>
<head>
<title>test_signaltools.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_signaltools.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>

<span class="s0">from </span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">futures </span><span class="s0">import </span><span class="s1">ThreadPoolExecutor</span><span class="s2">, </span><span class="s1">as_completed</span>
<span class="s0">from </span><span class="s1">decimal </span><span class="s0">import </span><span class="s1">Decimal</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>
<span class="s0">from </span><span class="s1">math </span><span class="s0">import </span><span class="s1">gcd</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_equal</span><span class="s2">,</span>
    <span class="s1">assert_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_array_less</span><span class="s2">,</span>
    <span class="s1">suppress_warnings</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s1">array</span><span class="s2">, </span><span class="s1">arange</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">fft </span><span class="s0">import </span><span class="s1">fft</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">ndimage </span><span class="s0">import </span><span class="s1">correlate1d</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize </span><span class="s0">import </span><span class="s1">fmin</span><span class="s2">, </span><span class="s1">linear_sum_assignment</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">signal</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">correlate</span><span class="s2">, </span><span class="s1">correlate2d</span><span class="s2">, </span><span class="s1">correlation_lags</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">,</span>
    <span class="s1">fftconvolve</span><span class="s2">, </span><span class="s1">oaconvolve</span><span class="s2">, </span><span class="s1">choose_conv_method</span><span class="s2">,</span>
    <span class="s1">hilbert</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, </span><span class="s1">lfilter_zi</span><span class="s2">, </span><span class="s1">filtfilt</span><span class="s2">, </span><span class="s1">butter</span><span class="s2">, </span><span class="s1">zpk2tf</span><span class="s2">, </span><span class="s1">zpk2sos</span><span class="s2">,</span>
    <span class="s1">invres</span><span class="s2">, </span><span class="s1">invresz</span><span class="s2">, </span><span class="s1">vectorstrength</span><span class="s2">, </span><span class="s1">lfiltic</span><span class="s2">, </span><span class="s1">tf2sos</span><span class="s2">, </span><span class="s1">sosfilt</span><span class="s2">, </span><span class="s1">sosfiltfilt</span><span class="s2">,</span>
    <span class="s1">sosfilt_zi</span><span class="s2">, </span><span class="s1">tf2zpk</span><span class="s2">, </span><span class="s1">BadCoefficients</span><span class="s2">, </span><span class="s1">detrend</span><span class="s2">, </span><span class="s1">unique_roots</span><span class="s2">, </span><span class="s1">residue</span><span class="s2">,</span>
    <span class="s1">residuez</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">windows </span><span class="s0">import </span><span class="s1">hann</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_signaltools </span><span class="s0">import </span><span class="s2">(</span><span class="s1">_filtfilt_gust</span><span class="s2">, </span><span class="s1">_compute_factors</span><span class="s2">,</span>
                                      <span class="s1">_group_poles</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_upfirdn </span><span class="s0">import </span><span class="s1">_upfirdn_modes</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib </span><span class="s0">import </span><span class="s1">_testutils</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">ComplexWarning</span><span class="s2">, </span><span class="s1">np_long</span><span class="s2">, </span><span class="s1">np_ulong</span>


<span class="s0">class </span><span class="s1">_TestConvolve</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">22</span><span class="s2">, </span><span class="s3">28</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">23</span><span class="s2">, </span><span class="s3">12</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;same&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s3">10</span><span class="s2">, </span><span class="s3">22</span><span class="s2">, </span><span class="s3">34</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_same_eq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;same&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s3">10</span><span class="s2">, </span><span class="s3">22</span><span class="s2">, </span><span class="s3">22</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">6j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">8j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">5j</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_zero_rank</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">1289</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">4567</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_broadcastable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">27</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
            <span class="s1">b_shape </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">]*</span><span class="s3">3</span>
            <span class="s1">b_shape</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">3</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">b_shape</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">b_shape</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_element</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">4967</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3920</span><span class="s2">])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">58</span><span class="s2">, </span><span class="s3">38</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">12</span><span class="s2">, </span><span class="s3">31</span><span class="s2">, </span><span class="s3">58</span><span class="s2">, </span><span class="s3">49</span><span class="s2">, </span><span class="s3">30</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_input_swapping</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">small </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s3">8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">big </span><span class="s2">= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">arange</span><span class="s2">(</span><span class="s3">27</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">big </span><span class="s2">+= </span><span class="s1">arange</span><span class="s2">(</span><span class="s3">27</span><span class="s2">)[::-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>

        <span class="s1">out_array </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[[[</span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">26 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">25 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">24 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">52 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">151 </span><span class="s2">+ </span><span class="s3">5j</span><span class="s2">, </span><span class="s3">145 </span><span class="s2">+ </span><span class="s3">11j</span><span class="s2">, </span><span class="s3">93 </span><span class="s2">+ </span><span class="s3">11j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">46 </span><span class="s2">+ </span><span class="s3">6j</span><span class="s2">, </span><span class="s3">133 </span><span class="s2">+ </span><span class="s3">23j</span><span class="s2">, </span><span class="s3">127 </span><span class="s2">+ </span><span class="s3">29j</span><span class="s2">, </span><span class="s3">81 </span><span class="s2">+ </span><span class="s3">23j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">40 </span><span class="s2">+ </span><span class="s3">12j</span><span class="s2">, </span><span class="s3">98 </span><span class="s2">+ </span><span class="s3">32j</span><span class="s2">, </span><span class="s3">93 </span><span class="s2">+ </span><span class="s3">37j</span><span class="s2">, </span><span class="s3">54 </span><span class="s2">+ </span><span class="s3">24j</span><span class="s2">]],</span>

             <span class="s2">[[</span><span class="s3">104 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">247 </span><span class="s2">+ </span><span class="s3">13j</span><span class="s2">, </span><span class="s3">237 </span><span class="s2">+ </span><span class="s3">23j</span><span class="s2">, </span><span class="s3">135 </span><span class="s2">+ </span><span class="s3">21j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">282 </span><span class="s2">+ </span><span class="s3">30j</span><span class="s2">, </span><span class="s3">632 </span><span class="s2">+ </span><span class="s3">96j</span><span class="s2">, </span><span class="s3">604 </span><span class="s2">+ </span><span class="s3">124j</span><span class="s2">, </span><span class="s3">330 </span><span class="s2">+ </span><span class="s3">86j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">246 </span><span class="s2">+ </span><span class="s3">66j</span><span class="s2">, </span><span class="s3">548 </span><span class="s2">+ </span><span class="s3">180j</span><span class="s2">, </span><span class="s3">520 </span><span class="s2">+ </span><span class="s3">208j</span><span class="s2">, </span><span class="s3">282 </span><span class="s2">+ </span><span class="s3">134j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">142 </span><span class="s2">+ </span><span class="s3">66j</span><span class="s2">, </span><span class="s3">307 </span><span class="s2">+ </span><span class="s3">161j</span><span class="s2">, </span><span class="s3">289 </span><span class="s2">+ </span><span class="s3">179j</span><span class="s2">, </span><span class="s3">153 </span><span class="s2">+ </span><span class="s3">107j</span><span class="s2">]],</span>

             <span class="s2">[[</span><span class="s3">68 </span><span class="s2">+ </span><span class="s3">36j</span><span class="s2">, </span><span class="s3">157 </span><span class="s2">+ </span><span class="s3">103j</span><span class="s2">, </span><span class="s3">147 </span><span class="s2">+ </span><span class="s3">113j</span><span class="s2">, </span><span class="s3">81 </span><span class="s2">+ </span><span class="s3">75j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">174 </span><span class="s2">+ </span><span class="s3">138j</span><span class="s2">, </span><span class="s3">380 </span><span class="s2">+ </span><span class="s3">348j</span><span class="s2">, </span><span class="s3">352 </span><span class="s2">+ </span><span class="s3">376j</span><span class="s2">, </span><span class="s3">186 </span><span class="s2">+ </span><span class="s3">230j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">138 </span><span class="s2">+ </span><span class="s3">174j</span><span class="s2">, </span><span class="s3">296 </span><span class="s2">+ </span><span class="s3">432j</span><span class="s2">, </span><span class="s3">268 </span><span class="s2">+ </span><span class="s3">460j</span><span class="s2">, </span><span class="s3">138 </span><span class="s2">+ </span><span class="s3">278j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">70 </span><span class="s2">+ </span><span class="s3">138j</span><span class="s2">, </span><span class="s3">145 </span><span class="s2">+ </span><span class="s3">323j</span><span class="s2">, </span><span class="s3">127 </span><span class="s2">+ </span><span class="s3">341j</span><span class="s2">, </span><span class="s3">63 </span><span class="s2">+ </span><span class="s3">197j</span><span class="s2">]],</span>

             <span class="s2">[[</span><span class="s3">32 </span><span class="s2">+ </span><span class="s3">72j</span><span class="s2">, </span><span class="s3">68 </span><span class="s2">+ </span><span class="s3">166j</span><span class="s2">, </span><span class="s3">59 </span><span class="s2">+ </span><span class="s3">175j</span><span class="s2">, </span><span class="s3">30 </span><span class="s2">+ </span><span class="s3">100j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">68 </span><span class="s2">+ </span><span class="s3">192j</span><span class="s2">, </span><span class="s3">139 </span><span class="s2">+ </span><span class="s3">433j</span><span class="s2">, </span><span class="s3">117 </span><span class="s2">+ </span><span class="s3">455j</span><span class="s2">, </span><span class="s3">57 </span><span class="s2">+ </span><span class="s3">255j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">38 </span><span class="s2">+ </span><span class="s3">222j</span><span class="s2">, </span><span class="s3">73 </span><span class="s2">+ </span><span class="s3">499j</span><span class="s2">, </span><span class="s3">51 </span><span class="s2">+ </span><span class="s3">521j</span><span class="s2">, </span><span class="s3">21 </span><span class="s2">+ </span><span class="s3">291j</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s3">12 </span><span class="s2">+ </span><span class="s3">144j</span><span class="s2">, </span><span class="s3">20 </span><span class="s2">+ </span><span class="s3">318j</span><span class="s2">, </span><span class="s3">7 </span><span class="s2">+ </span><span class="s3">331j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">182j</span><span class="s2">]]])</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">small</span><span class="s2">, </span><span class="s1">big</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">), </span><span class="s1">out_array</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">big</span><span class="s2">, </span><span class="s1">small</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">), </span><span class="s1">out_array</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">small</span><span class="s2">, </span><span class="s1">big</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">),</span>
                           <span class="s1">out_array</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">big</span><span class="s2">, </span><span class="s1">small</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">),</span>
                           <span class="s1">out_array</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">small</span><span class="s2">, </span><span class="s1">big</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">),</span>
                           <span class="s1">out_array</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">big</span><span class="s2">, </span><span class="s1">small</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">),</span>
                           <span class="s1">out_array</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_invalid_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'spam'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'eggs'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'ham'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'bacon'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'bacon'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestConvolve</span><span class="s2">(</span><span class="s1">_TestConvolve</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_valid_mode2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># See gh-5897</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s3">70</span><span class="s2">, </span><span class="s3">78</span><span class="s2">, </span><span class="s3">73</span><span class="s2">, </span><span class="s3">65</span><span class="s2">]</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">5j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">8 </span><span class="s2">- </span><span class="s3">10j</span><span class="s2">]</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_same_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">57</span><span class="s2">, </span><span class="s3">61</span><span class="s2">, </span><span class="s3">63</span><span class="s2">, </span><span class="s3">57</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">36</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># By &quot;invalid,&quot; we mean that no one</span>
        <span class="s5"># array has dimensions that are all at</span>
        <span class="s5"># least as large as the corresponding</span>
        <span class="s5"># dimensions of the other array. This</span>
        <span class="s5"># setup should throw a ValueError.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, *(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, *(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>

    <span class="s0">def </span><span class="s1">test_convolve_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">100</span><span class="s2">):</span>
        <span class="s5"># this types data structure was manually encoded instead of</span>
        <span class="s5"># using custom filters on the soon-to-be-removed np.sctypes</span>
        <span class="s1">types </span><span class="s2">= {</span><span class="s4">'uint16'</span><span class="s2">, </span><span class="s4">'uint64'</span><span class="s2">, </span><span class="s4">'int64'</span><span class="s2">, </span><span class="s4">'int32'</span><span class="s2">,</span>
                 <span class="s4">'complex128'</span><span class="s2">, </span><span class="s4">'float64'</span><span class="s2">, </span><span class="s4">'float16'</span><span class="s2">,</span>
                 <span class="s4">'complex64'</span><span class="s2">, </span><span class="s4">'float32'</span><span class="s2">, </span><span class="s4">'int16'</span><span class="s2">,</span>
                 <span class="s4">'uint8'</span><span class="s2">, </span><span class="s4">'uint32'</span><span class="s2">, </span><span class="s4">'int8'</span><span class="s2">, </span><span class="s4">'bool'</span><span class="s2">}</span>
        <span class="s1">args </span><span class="s2">= [(</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t1 </span><span class="s0">in </span><span class="s1">types </span><span class="s0">for </span><span class="s1">t2 </span><span class="s0">in </span><span class="s1">types</span>
                               <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">]]</span>

        <span class="s5"># These are random arrays, which means test is much stronger than</span>
        <span class="s5"># convolving testing by convolving two np.ones arrays</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">array_types </span><span class="s2">= {</span><span class="s4">'i'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">),</span>
                       <span class="s4">'f'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)}</span>
        <span class="s1">array_types</span><span class="s2">[</span><span class="s4">'b'</span><span class="s2">] = </span><span class="s1">array_types</span><span class="s2">[</span><span class="s4">'u'</span><span class="s2">] = </span><span class="s1">array_types</span><span class="s2">[</span><span class="s4">'i'</span><span class="s2">]</span>
        <span class="s1">array_types</span><span class="s2">[</span><span class="s4">'c'</span><span class="s2">] = </span><span class="s1">array_types</span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">] + </span><span class="s3">0.5j</span><span class="s2">*</span><span class="s1">array_types</span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">t1</span><span class="s2">, </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">args</span><span class="s2">:</span>
            <span class="s1">x1 </span><span class="s2">= </span><span class="s1">array_types</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">).</span><span class="s1">kind</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">)</span>
            <span class="s1">x2 </span><span class="s2">= </span><span class="s1">array_types</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">).</span><span class="s1">kind</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">)</span>

            <span class="s1">results </span><span class="s2">= {</span><span class="s1">key</span><span class="s2">: </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">key</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
                       <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'fft'</span><span class="s2">, </span><span class="s4">'direct'</span><span class="s2">]}</span>

            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s4">'fft'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">results</span><span class="s2">[</span><span class="s4">'direct'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s4">'bool' </span><span class="s0">in </span><span class="s1">t1 </span><span class="s0">and </span><span class="s4">'bool' </span><span class="s0">in </span><span class="s1">t2</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">), </span><span class="s4">'direct'</span><span class="s2">)</span>
                <span class="s0">continue</span>

            <span class="s5"># Found by experiment. Found approx smallest value for (rtol, atol)</span>
            <span class="s5"># threshold to have tests pass.</span>
            <span class="s0">if </span><span class="s1">any</span><span class="s2">([</span><span class="s1">t </span><span class="s0">in </span><span class="s2">{</span><span class="s4">'complex64'</span><span class="s2">, </span><span class="s4">'float32'</span><span class="s2">} </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s2">[</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">t2</span><span class="s2">]]):</span>
                <span class="s1">kwargs </span><span class="s2">= {</span><span class="s4">'rtol'</span><span class="s2">: </span><span class="s3">1.0e-4</span><span class="s2">, </span><span class="s4">'atol'</span><span class="s2">: </span><span class="s3">1e-6</span><span class="s2">}</span>
            <span class="s0">elif </span><span class="s4">'float16' </span><span class="s0">in </span><span class="s2">[</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">t2</span><span class="s2">]:</span>
                <span class="s5"># atol is default for np.allclose</span>
                <span class="s1">kwargs </span><span class="s2">= {</span><span class="s4">'rtol'</span><span class="s2">: </span><span class="s3">1e-3</span><span class="s2">, </span><span class="s4">'atol'</span><span class="s2">: </span><span class="s3">1e-3</span><span class="s2">}</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># defaults for np.allclose (different from assert_allclose)</span>
                <span class="s1">kwargs </span><span class="s2">= {</span><span class="s4">'rtol'</span><span class="s2">: </span><span class="s3">1e-5</span><span class="s2">, </span><span class="s4">'atol'</span><span class="s2">: </span><span class="s3">1e-8</span><span class="s2">}</span>

            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s4">'fft'</span><span class="s2">], </span><span class="s1">results</span><span class="s2">[</span><span class="s4">'direct'</span><span class="s2">], **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_convolve_method_large_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This is really a test that convolving two large integers goes to the</span>
        <span class="s5"># direct method even if they're in the fft method.</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">51</span><span class="s2">, </span><span class="s3">52</span><span class="s2">, </span><span class="s3">53</span><span class="s2">, </span><span class="s3">54</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">62</span><span class="s2">]:</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s1">n</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
            <span class="s1">fft </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
            <span class="s1">direct </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>

            <span class="s5"># this is the case when integer precision gets to us</span>
            <span class="s5"># issue #6076 has more detail, hopefully more tests after resolved</span>
            <span class="s0">if </span><span class="s1">n </span><span class="s2">&lt; </span><span class="s3">50</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">fft</span><span class="s2">, </span><span class="s1">direct</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">fft</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">n</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">direct</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">n</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_mismatched_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Input arrays should have the same number of dimensions</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], [[</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_TestConvolve2d</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_2d_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">58</span><span class="s2">, </span><span class="s3">38</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">12</span><span class="s2">, </span><span class="s3">31</span><span class="s2">, </span><span class="s3">58</span><span class="s2">, </span><span class="s3">49</span><span class="s2">, </span><span class="s3">30</span><span class="s2">]])</span>
        <span class="s1">e </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">e </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]]</span>
        <span class="s1">f </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">62</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">98</span><span class="s2">, </span><span class="s3">116</span><span class="s2">, </span><span class="s3">134</span><span class="s2">]])</span>

        <span class="s1">g </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_mode_complx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">e </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]]</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">) + </span><span class="s3">1j</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">62.</span><span class="s2">+</span><span class="s3">24.j</span><span class="s2">, </span><span class="s3">80.</span><span class="s2">+</span><span class="s3">30.j</span><span class="s2">, </span><span class="s3">98.</span><span class="s2">+</span><span class="s3">36.j</span><span class="s2">, </span><span class="s3">116.</span><span class="s2">+</span><span class="s3">42.j</span><span class="s2">, </span><span class="s3">134.</span><span class="s2">+</span><span class="s3">48.j</span><span class="s2">]])</span>

        <span class="s1">g </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fillvalue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
        <span class="s1">fillval </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'fill'</span><span class="s2">, </span><span class="s1">fillval</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">24</span><span class="s2">, </span><span class="s3">26</span><span class="s2">, </span><span class="s3">31</span><span class="s2">, </span><span class="s3">34</span><span class="s2">, </span><span class="s3">32</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">28</span><span class="s2">, </span><span class="s3">40</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">52</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">32</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">67</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">48</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fillvalue_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;could not cast `fillvalue` directly to the output &quot;</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">ComplexWarning</span><span class="s2">, </span><span class="s4">&quot;Casting complex values&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">convolve2d</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]], </span><span class="s1">fillvalue</span><span class="s2">=</span><span class="s3">1j</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;`fillvalue` must be scalar or an array with &quot;</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">convolve2d</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]], </span><span class="s1">fillvalue</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_fillvalue_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that fillvalue being empty raises an error:</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]],</span>
                      <span class="s1">fillvalue</span><span class="s2">=[])</span>

    <span class="s0">def </span><span class="s1">test_wrap_boundary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'wrap'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">80</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">74</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">80</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">68</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">68</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">80</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">74</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">80</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sym_boundary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'symm'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">34</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s3">44</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">66</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">52</span><span class="s2">, </span><span class="s3">48</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">84</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">82</span><span class="s2">, </span><span class="s3">78</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">110</span><span class="s2">, </span><span class="s3">114</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'func'</span><span class="s2">, [</span><span class="s1">convolve2d</span><span class="s2">, </span><span class="s1">correlate2d</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'boundary, expected'</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s4">'symm'</span><span class="s2">, [[</span><span class="s3">37.0</span><span class="s2">, </span><span class="s3">42.0</span><span class="s2">, </span><span class="s3">44.0</span><span class="s2">, </span><span class="s3">45.0</span><span class="s2">]]),</span>
                              <span class="s2">(</span><span class="s4">'wrap'</span><span class="s2">, [[</span><span class="s3">43.0</span><span class="s2">, </span><span class="s3">44.0</span><span class="s2">, </span><span class="s3">42.0</span><span class="s2">, </span><span class="s3">39.0</span><span class="s2">]])])</span>
    <span class="s0">def </span><span class="s1">test_same_with_boundary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s5"># Test boundary='symm' and boundary='wrap' with a &quot;long&quot; kernel.</span>
        <span class="s5"># The size of the kernel requires that the values in the &quot;image&quot;</span>
        <span class="s5"># be extended more than once to handle the requested boundary method.</span>
        <span class="s5"># This is a regression test for gh-8684 and gh-8814.</span>
        <span class="s1">image </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">]])</span>
        <span class="s1">kernel </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">21</span><span class="s2">))</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">image</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">=</span><span class="s1">boundary</span><span class="s2">)</span>
        <span class="s5"># The expected results were calculated &quot;by hand&quot;.  Because the</span>
        <span class="s5"># kernel is all ones, the same result is expected for convolve2d</span>
        <span class="s5"># and correlate2d.</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_boundary_extension_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for gh-12686.</span>
        <span class="s5"># Use ndimage.convolve with appropriate arguments to create the</span>
        <span class="s5"># expected result.</span>
        <span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">ndimage </span><span class="s0">as </span><span class="s1">ndi</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">*</span><span class="s3">3</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">*</span><span class="s3">10</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">=</span><span class="s4">'wrap'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">ndi</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'wrap'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=(-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_boundary_extension_full</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for gh-12686.</span>
        <span class="s5"># Use ndimage.convolve with appropriate arguments to create the</span>
        <span class="s5"># expected result.</span>
        <span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">ndimage </span><span class="s0">as </span><span class="s1">ndi</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">*</span><span class="s3">3</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">*</span><span class="s3">6</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">=</span><span class="s4">'wrap'</span><span class="s2">)</span>
        <span class="s1">apad </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pad</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, ((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)), </span><span class="s4">'wrap'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">ndi</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">apad</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'wrap'</span><span class="s2">)[:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_invalid_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># By &quot;invalid,&quot; we mean that no one</span>
        <span class="s5"># array has dimensions that are all at</span>
        <span class="s5"># least as large as the corresponding</span>
        <span class="s5"># dimensions of the other array. This</span>
        <span class="s5"># setup should throw a ValueError.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, *(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, *(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>


<span class="s0">class </span><span class="s1">TestConvolve2d</span><span class="s2">(</span><span class="s1">_TestConvolve2d</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_same_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">e </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">f </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]]</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">22</span><span class="s2">, </span><span class="s3">28</span><span class="s2">, </span><span class="s3">34</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">80</span><span class="s2">, </span><span class="s3">98</span><span class="s2">, </span><span class="s3">116</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_mode2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># See gh-5897</span>
        <span class="s1">e </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">f </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]]</span>
        <span class="s1">expected </span><span class="s2">= [[</span><span class="s3">62</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">98</span><span class="s2">, </span><span class="s3">116</span><span class="s2">, </span><span class="s3">134</span><span class="s2">]]</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">e </span><span class="s2">= [[</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">], [</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">]]</span>
        <span class="s1">f </span><span class="s2">= [[</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">], [</span><span class="s3">4 </span><span class="s2">- </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">]]</span>
        <span class="s1">expected </span><span class="s2">= [[</span><span class="s3">27 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">46. </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">]]</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_consistency_convolve_funcs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Compare np.convolve, signal.convolve, signal.convolve2d</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">]:</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">),</span>
                                <span class="s1">signal</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">squeeze</span><span class="s2">(</span>
                <span class="s1">signal</span><span class="s2">.</span><span class="s1">convolve2d</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s1">b</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)),</span>
                <span class="s1">signal</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">convolve2d</span><span class="s2">, [[[</span><span class="s3">3</span><span class="s2">]]], [[[</span><span class="s3">4</span><span class="s2">]]])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail_on_32bit</span><span class="s2">(</span><span class="s4">&quot;Can't create large array for test&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_large_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test indexing doesn't overflow an int (gh-10761)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s3">2</span><span class="s2">**</span><span class="s3">31 </span><span class="s2">// (</span><span class="s3">1000 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">().</span><span class="s1">itemsize</span><span class="s2">)</span>
        <span class="s1">_testutils</span><span class="s2">.</span><span class="s1">check_free_memory</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">n </span><span class="s2">* </span><span class="s3">1001 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">().</span><span class="s1">itemsize </span><span class="s2">/ </span><span class="s3">1e6</span><span class="s2">)</span>

        <span class="s5"># Create a chequered pattern of 1s and 0s</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1001 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s3">1</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">stride_tricks</span><span class="s2">.</span><span class="s1">as_strided</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">), </span><span class="s1">strides</span><span class="s2">=(</span><span class="s3">8008</span><span class="s2">, </span><span class="s3">8</span><span class="s2">))</span>

        <span class="s1">count </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">fails </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">count </span><span class="s2">&gt; </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">fails</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span>


<span class="s0">class </span><span class="s1">TestFFTConvolve</span><span class="s2">:</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_real</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_real_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">3j</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">8j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">24j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">18j</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_complex_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">3j</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">8j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">24j</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s3">18j</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">,</span>
                                      <span class="s0">None</span><span class="s2">,</span>
                                      <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_2d_real_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">8</span><span class="s2">, </span><span class="s3">26</span><span class="s2">, </span><span class="s3">56</span><span class="s2">, </span><span class="s3">54</span><span class="s2">, </span><span class="s3">36</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">16</span><span class="s2">, </span><span class="s3">40</span><span class="s2">, </span><span class="s3">73</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">36</span><span class="s2">]])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_2d_real_same_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">8</span><span class="s2">, </span><span class="s3">26</span><span class="s2">, </span><span class="s3">56</span><span class="s2">, </span><span class="s3">54</span><span class="s2">, </span><span class="s3">36</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">16</span><span class="s2">, </span><span class="s3">40</span><span class="s2">, </span><span class="s3">73</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">36</span><span class="s2">]])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">,</span>
                                      <span class="s0">None</span><span class="s2">,</span>
                                      <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_2d_complex_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">6j</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">+ </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">+ </span><span class="s3">5j</span><span class="s2">]])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">[-</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, -</span><span class="s3">10 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, -</span><span class="s3">21 </span><span class="s2">+ </span><span class="s3">56j</span><span class="s2">, -</span><span class="s3">18 </span><span class="s2">+ </span><span class="s3">76j</span><span class="s2">, -</span><span class="s3">11 </span><span class="s2">+ </span><span class="s3">60j</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">10j</span><span class="s2">, </span><span class="s3">44j</span><span class="s2">, </span><span class="s3">118j</span><span class="s2">, </span><span class="s3">156j</span><span class="s2">, </span><span class="s3">122j</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, </span><span class="s3">10 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, </span><span class="s3">21 </span><span class="s2">+ </span><span class="s3">56j</span><span class="s2">, </span><span class="s3">18 </span><span class="s2">+ </span><span class="s3">76j</span><span class="s2">, </span><span class="s3">11 </span><span class="s2">+ </span><span class="s3">60j</span><span class="s2">]</span>
            <span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_2d_complex_same_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">6j</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">+ </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">+ </span><span class="s3">5j</span><span class="s2">]])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">[-</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, -</span><span class="s3">10 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, -</span><span class="s3">21 </span><span class="s2">+ </span><span class="s3">56j</span><span class="s2">, -</span><span class="s3">18 </span><span class="s2">+ </span><span class="s3">76j</span><span class="s2">, -</span><span class="s3">11 </span><span class="s2">+ </span><span class="s3">60j</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">10j</span><span class="s2">, </span><span class="s3">44j</span><span class="s2">, </span><span class="s3">118j</span><span class="s2">, </span><span class="s3">156j</span><span class="s2">, </span><span class="s3">122j</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4j</span><span class="s2">, </span><span class="s3">10 </span><span class="s2">+ </span><span class="s3">20j</span><span class="s2">, </span><span class="s3">21 </span><span class="s2">+ </span><span class="s3">56j</span><span class="s2">, </span><span class="s3">18 </span><span class="s2">+ </span><span class="s3">76j</span><span class="s2">, </span><span class="s3">11 </span><span class="s2">+ </span><span class="s3">60j</span><span class="s2">]</span>
            <span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_real_same_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected_1 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">35.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">47.</span><span class="s2">])</span>
        <span class="s1">expected_2 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">9.</span><span class="s2">, </span><span class="s3">20.</span><span class="s2">, </span><span class="s3">25.</span><span class="s2">, </span><span class="s3">35.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">47.</span><span class="s2">, </span><span class="s3">39.</span><span class="s2">, </span><span class="s3">28.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected_1</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected_2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_real_same_mode_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected_1 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">35.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">47.</span><span class="s2">])</span>
        <span class="s1">expected_2 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">9.</span><span class="s2">, </span><span class="s3">20.</span><span class="s2">, </span><span class="s3">25.</span><span class="s2">, </span><span class="s3">35.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">47.</span><span class="s2">, </span><span class="s3">39.</span><span class="s2">, </span><span class="s3">28.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected_1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected_1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected_2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected_2</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected_1</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected_2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_valid_mode_real</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s5"># See gh-5897</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">24.</span><span class="s2">, </span><span class="s3">31.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">43.</span><span class="s2">, </span><span class="s3">49.</span><span class="s2">, </span><span class="s3">25.</span><span class="s2">, </span><span class="s3">12.</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_valid_mode_real_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s5"># See gh-5897</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">24.</span><span class="s2">, </span><span class="s3">31.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">43.</span><span class="s2">, </span><span class="s3">49.</span><span class="s2">, </span><span class="s3">25.</span><span class="s2">, </span><span class="s3">12.</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_valid_mode_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">7j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">8 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">45. </span><span class="s2">+ </span><span class="s3">12.j</span><span class="s2">, </span><span class="s3">30. </span><span class="s2">+ </span><span class="s3">23.j</span><span class="s2">, </span><span class="s3">48 </span><span class="s2">+ </span><span class="s3">32.j</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_valid_mode_complex_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">7j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">5 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">8 </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">45. </span><span class="s2">+ </span><span class="s3">12.j</span><span class="s2">, </span><span class="s3">30. </span><span class="s2">+ </span><span class="s3">23.j</span><span class="s2">, </span><span class="s3">48 </span><span class="s2">+ </span><span class="s3">32.j</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_mode_ignore_nonaxes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># See gh-5897</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">24.</span><span class="s2">, </span><span class="s3">31.</span><span class="s2">, </span><span class="s3">41.</span><span class="s2">, </span><span class="s3">43.</span><span class="s2">, </span><span class="s3">49.</span><span class="s2">, </span><span class="s3">25.</span><span class="s2">, </span><span class="s3">12.</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for #1745: crashes with 0-length input.</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">fftconvolve</span><span class="s2">([], []).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">fftconvolve</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], []).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">fftconvolve</span><span class="s2">([], [</span><span class="s3">7</span><span class="s2">]).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_rank</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span><span class="s3">4967</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span><span class="s3">3920</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_element</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">4967</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3920</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_random_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1234</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1233</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1233</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1321</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1321</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">axes </span><span class="s2">== </span><span class="s4">''</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_random_data_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1234</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1233</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1233</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1321</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1321</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_random_data_multidim_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
        <span class="s1">a_shape</span><span class="s2">, </span><span class="s1">b_shape </span><span class="s2">= (</span><span class="s3">123</span><span class="s2">, </span><span class="s3">22</span><span class="s2">), (</span><span class="s3">132</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1234</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">a_shape</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">a_shape</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">b_shape</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">b_shape</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">convolve2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[:, :, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">[:, :, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[:, :, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">moveaxis</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">moveaxis</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">moveaxis</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>

        <span class="s5"># use 1 for dimension 2 in a and 3 in b to test broadcasting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">'n'</span><span class="s2">,</span>
        <span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)) +</span>
        <span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">1000</span><span class="s2">, </span><span class="s3">1500</span><span class="s2">)) +</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">1234</span><span class="s2">).</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">1001</span><span class="s2">, </span><span class="s3">10000</span><span class="s2">, </span><span class="s3">5</span><span class="s2">).</span><span class="s1">tolist</span><span class="s2">())</span>
    <span class="s0">def </span><span class="s1">test_many_sizes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fft_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s3">1000</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">43876432987</span><span class="s2">)</span>
        <span class="s1">sig_nan </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
            <span class="s1">sig_nan</span><span class="s2">[</span><span class="s3">100</span><span class="s2">] = </span><span class="s1">val</span>
            <span class="s1">coeffs </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">firwin</span><span class="s2">(</span><span class="s3">200</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">)</span>

            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Use of fft convolution.*|invalid value encountered.*&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">signal</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">sig_nan</span><span class="s2">, </span><span class="s1">coeffs</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">fftconvolve_err</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">'Fell back to fftconvolve'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">gen_oa_shapes</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">[(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">a </span><span class="s2">- </span><span class="s1">b</span><span class="s2">) &gt; </span><span class="s3">3</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">gen_oa_shapes_2d</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">):</span>
    <span class="s1">shapes0 </span><span class="s2">= </span><span class="s1">gen_oa_shapes</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">)</span>
    <span class="s1">shapes1 </span><span class="s2">= </span><span class="s1">gen_oa_shapes</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">)</span>
    <span class="s1">shapes </span><span class="s2">= [</span><span class="s1">ishapes0</span><span class="s2">+</span><span class="s1">ishapes1 </span><span class="s0">for </span><span class="s1">ishapes0</span><span class="s2">, </span><span class="s1">ishapes1 </span><span class="s0">in</span>
              <span class="s1">zip</span><span class="s2">(</span><span class="s1">shapes0</span><span class="s2">, </span><span class="s1">shapes1</span><span class="s2">)]</span>

    <span class="s1">modes </span><span class="s2">= [</span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s1">ishapes</span><span class="s2">+(</span><span class="s1">imode</span><span class="s2">,) </span><span class="s0">for </span><span class="s1">ishapes</span><span class="s2">, </span><span class="s1">imode </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">shapes</span><span class="s2">, </span><span class="s1">modes</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">imode </span><span class="s2">!= </span><span class="s4">'valid' </span><span class="s0">or</span>
            <span class="s2">(</span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] &gt; </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] </span><span class="s0">and </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">2</span><span class="s2">] &gt; </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">3</span><span class="s2">]) </span><span class="s0">or</span>
            <span class="s2">(</span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] &lt; </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] </span><span class="s0">and </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">2</span><span class="s2">] &lt; </span><span class="s1">ishapes</span><span class="s2">[</span><span class="s3">3</span><span class="s2">])]</span>


<span class="s0">def </span><span class="s1">gen_oa_shapes_eq</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">[(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">a </span><span class="s2">&gt;= </span><span class="s1">b</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">TestOAConvolve</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span><span class="s2">()</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_0, shape_b_0'</span><span class="s2">,</span>
                             <span class="s1">gen_oa_shapes_eq</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">100</span><span class="s2">)) +</span>
                                              <span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">, </span><span class="s3">23</span><span class="s2">)))</span>
                             <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_real_manylens</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_b_0</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_a_0</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_b_0</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_0, shape_b_0'</span><span class="s2">,</span>
                             <span class="s1">gen_oa_shapes</span><span class="s2">([</span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'is_complex'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'mode'</span><span class="s2">, [</span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_1d_noaxes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_b_0</span><span class="s2">,</span>
                       <span class="s1">is_complex</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_a_0</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_b_0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_complex</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_a_0</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_b_0</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_signaltools</span><span class="s2">, </span><span class="s4">'fftconvolve'</span><span class="s2">,</span>
                            <span class="s1">fftconvolve_err</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_0, shape_b_0'</span><span class="s2">,</span>
                             <span class="s1">gen_oa_shapes</span><span class="s2">([</span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_extra'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_b_extra'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'is_complex'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'mode'</span><span class="s2">, [</span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_1d_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">, </span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_b_0</span><span class="s2">,</span>
                     <span class="s1">shape_a_extra</span><span class="s2">, </span><span class="s1">shape_b_extra</span><span class="s2">,</span>
                     <span class="s1">is_complex</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">ax_a </span><span class="s2">= [</span><span class="s1">shape_a_extra</span><span class="s2">]*</span><span class="s3">2</span>
        <span class="s1">ax_b </span><span class="s2">= [</span><span class="s1">shape_b_extra</span><span class="s2">]*</span><span class="s3">2</span>
        <span class="s1">ax_a</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">] = </span><span class="s1">shape_a_0</span>
        <span class="s1">ax_b</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">] = </span><span class="s1">shape_b_0</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_a</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_b</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_complex</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_a</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_b</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_signaltools</span><span class="s2">, </span><span class="s4">'fftconvolve'</span><span class="s2">,</span>
                            <span class="s1">fftconvolve_err</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_0, shape_b_0, '</span>
                             <span class="s4">'shape_a_1, shape_b_1, mode'</span><span class="s2">,</span>
                             <span class="s1">gen_oa_shapes_2d</span><span class="s2">([</span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'is_complex'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_2d_noaxes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_b_0</span><span class="s2">,</span>
                       <span class="s1">shape_a_1</span><span class="s2">, </span><span class="s1">shape_b_1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">,</span>
                       <span class="s1">is_complex</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_a_1</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_b_0</span><span class="s2">, </span><span class="s1">shape_b_1</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_complex</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_a_1</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">shape_b_0</span><span class="s2">, </span><span class="s1">shape_b_1</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_signaltools</span><span class="s2">, </span><span class="s4">'fftconvolve'</span><span class="s2">,</span>
                            <span class="s1">fftconvolve_err</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axes'</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_0, shape_b_0, '</span>
                             <span class="s4">'shape_a_1, shape_b_1, mode'</span><span class="s2">,</span>
                             <span class="s1">gen_oa_shapes_2d</span><span class="s2">([</span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_a_extra'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape_b_extra'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'is_complex'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_2d_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">, </span><span class="s1">shape_a_0</span><span class="s2">, </span><span class="s1">shape_b_0</span><span class="s2">,</span>
                     <span class="s1">shape_a_1</span><span class="s2">, </span><span class="s1">shape_b_1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">,</span>
                     <span class="s1">shape_a_extra</span><span class="s2">, </span><span class="s1">shape_b_extra</span><span class="s2">,</span>
                     <span class="s1">is_complex</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">ax_a </span><span class="s2">= [</span><span class="s1">shape_a_extra</span><span class="s2">]*</span><span class="s3">3</span>
        <span class="s1">ax_b </span><span class="s2">= [</span><span class="s1">shape_b_extra</span><span class="s2">]*</span><span class="s3">3</span>
        <span class="s1">ax_a</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]] = </span><span class="s1">shape_a_0</span>
        <span class="s1">ax_b</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]] = </span><span class="s1">shape_b_0</span>
        <span class="s1">ax_a</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s1">shape_a_1</span>
        <span class="s1">ax_b</span><span class="s2">[</span><span class="s1">axes</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s1">shape_b_1</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_a</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_b</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_complex</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_a</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">ax_b</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_signaltools</span><span class="s2">, </span><span class="s4">'fftconvolve'</span><span class="s2">,</span>
                            <span class="s1">fftconvolve_err</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=</span><span class="s1">axes</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for #1745: crashes with 0-length input.</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">oaconvolve</span><span class="s2">([], []).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">oaconvolve</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], []).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">oaconvolve</span><span class="s2">([], [</span><span class="s3">7</span><span class="s2">]).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_rank</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span><span class="s3">4967</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(</span><span class="s3">3920</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_element</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">4967</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">3920</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">oaconvolve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAllFreqConvolves</span><span class="s2">:</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'convapproach'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s1">fftconvolve</span><span class="s2">, </span><span class="s1">oaconvolve</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">convapproach</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;For 'valid' mode, one must be at least &quot;</span>
                           <span class="s4">&quot;as large as the other in every dimension&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'valid'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'convapproach'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s1">fftconvolve</span><span class="s2">, </span><span class="s1">oaconvolve</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_shapes_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">convapproach</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;incompatible shapes for in1 and in2:&quot;</span>
                           <span class="s4">r&quot; \(5L?, 6L?, 2L?, 1L?\) and&quot;</span>
                           <span class="s4">r&quot; \(5L?, 6L?, 3L?, 1L?\)&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'a,b'</span><span class="s2">,</span>
                             <span class="s2">[([</span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">),</span>
                              <span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">]),</span>
                              <span class="s2">([</span><span class="s3">3</span><span class="s2">], [[</span><span class="s3">2</span><span class="s2">]])])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'convapproach'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s1">fftconvolve</span><span class="s2">, </span><span class="s1">oaconvolve</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_mismatched_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">convapproach</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;in1 and in2 should have the same&quot;</span>
                           <span class="s4">&quot; dimensionality&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'convapproach'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s1">fftconvolve</span><span class="s2">, </span><span class="s1">oaconvolve</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">convapproach</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;acceptable mode flags are 'valid',&quot;</span>
                           <span class="s4">&quot; 'same', or 'full'&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'chips'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;when provided, axes cannot be empty&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;axes must be a scalar or &quot;</span>
                           <span class="s4">&quot;iterable of integers&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;axes must be a scalar or &quot;</span>
                           <span class="s4">&quot;iterable of integers&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;axes exceeds dimensionality of input&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;axes exceeds dimensionality of input&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[-</span><span class="s3">2</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;all axes must be unique&quot;</span><span class="s2">):</span>
            <span class="s1">convapproach</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_longdtype_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s3">27</span><span class="s2">, </span><span class="s3">27</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iscomplexobj</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">()):</span>
            <span class="s1">x </span><span class="s2">+= </span><span class="s3">.1j</span>
            <span class="s1">y </span><span class="s2">-= </span><span class="s3">.1j</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">fftconvolve</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>


<span class="s0">class </span><span class="s1">TestMedFilt</span><span class="s2">:</span>

    <span class="s1">IN </span><span class="s2">= [[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">18</span><span class="s2">, </span><span class="s3">27</span><span class="s2">, </span><span class="s3">65</span><span class="s2">, </span><span class="s3">46</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">72</span><span class="s2">, </span><span class="s3">77</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">66</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">77</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">29</span><span class="s2">, </span><span class="s3">95</span><span class="s2">, </span><span class="s3">35</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">34</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">21</span><span class="s2">, </span><span class="s3">66</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">70</span><span class="s2">, </span><span class="s3">97</span><span class="s2">, </span><span class="s3">28</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">78</span><span class="s2">, </span><span class="s3">77</span><span class="s2">, </span><span class="s3">61</span><span class="s2">, </span><span class="s3">58</span><span class="s2">, </span><span class="s3">71</span><span class="s2">, </span><span class="s3">42</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">64</span><span class="s2">, </span><span class="s3">53</span><span class="s2">, </span><span class="s3">44</span><span class="s2">, </span><span class="s3">29</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">68</span><span class="s2">, </span><span class="s3">24</span><span class="s2">, </span><span class="s3">84</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s3">53</span><span class="s2">, </span><span class="s3">67</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">78</span><span class="s2">, </span><span class="s3">74</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">83</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">70</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">24</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">61</span><span class="s2">, </span><span class="s3">26</span><span class="s2">],</span>
          <span class="s2">[</span><span class="s3">32</span><span class="s2">, </span><span class="s3">61</span><span class="s2">, </span><span class="s3">88</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">39</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">61</span><span class="s2">]]</span>

    <span class="s1">OUT </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">18</span><span class="s2">, </span><span class="s3">27</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">21</span><span class="s2">, </span><span class="s3">29</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">34</span><span class="s2">, </span><span class="s3">34</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">35</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">42</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">35</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">33</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s3">26</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">32</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s3">26</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">7</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">47</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">46</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">21</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s3">39</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">43</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
           <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">24</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]</span>

    <span class="s1">KERNEL_SIZE </span><span class="s2">= [</span><span class="s3">7</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KERNEL_SIZE</span><span class="s2">)</span>
        <span class="s1">e </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt2d</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KERNEL_SIZE</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OUT</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ubyte</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">byte</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ushort</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">short</span><span class="s2">,</span>
                                       <span class="s1">np_ulong</span><span class="s2">, </span><span class="s1">np_long</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">,</span>
                                       <span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># volume input and output types match</span>
        <span class="s1">in_typed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt2d</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">,</span>
                                       <span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
                                       <span class="s4">&quot;float96&quot;</span><span class="s2">, </span><span class="s4">&quot;float128&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># We can only test this on platforms that support a native type of float96 or</span>
        <span class="s5"># float128; comparing to np.longdouble allows us to filter out non-native types</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;float96&quot;</span><span class="s2">, </span><span class="s4">&quot;float128&quot;</span><span class="s2">]</span>
                <span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">!= </span><span class="s1">dtype</span><span class="s2">):</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">f&quot;Platform does not support </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
        
        <span class="s1">in_typed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;not supported&quot;</span><span class="s2">):</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;not supported&quot;</span><span class="s2">):</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt2d</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># gh-1651, trac #1124. Ensure this does not segfault.</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dtype=object is not supported by medfilt&quot;</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_odd_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Avoid a regression with possible contiguous</span>
        <span class="s5"># numpy arrays that have odd strides. The stride value below gets</span>
        <span class="s5"># us into wrong memory if used (but it does not need to be used)</span>
        <span class="s1">dummy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">dummy</span><span class="s2">[</span><span class="s3">5</span><span class="s2">:</span><span class="s3">6</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">strides </span><span class="s2">= </span><span class="s3">16</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">) == </span><span class="s3">5.</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ubyte</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_medfilt2d_parallel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">in_typed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">OUT</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s5"># This is used to simplify the indexing calculations.</span>
        <span class="s0">assert </span><span class="s1">in_typed</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span>

        <span class="s5"># We'll do the calculation in four chunks. M1 and N1 are the dimensions</span>
        <span class="s5"># of the first output chunk. We have to extend the input by half the</span>
        <span class="s5"># kernel size to be able to calculate the full output chunk.</span>
        <span class="s1">M1 </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] // </span><span class="s3">2</span>
        <span class="s1">N1 </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] // </span><span class="s3">2</span>
        <span class="s1">offM </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KERNEL_SIZE</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] // </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">offN </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KERNEL_SIZE</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] // </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span>

        <span class="s0">def </span><span class="s1">apply</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">):</span>
            <span class="s5"># in = slice of in_typed to use.</span>
            <span class="s5"># sel = slice of output to crop it to the correct region.</span>
            <span class="s5"># out = slice of output array to store in.</span>
            <span class="s1">M</span><span class="s2">, </span><span class="s1">N </span><span class="s2">= </span><span class="s1">chunk</span>
            <span class="s0">if </span><span class="s1">M </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">Min </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">M1 </span><span class="s2">+ </span><span class="s1">offM</span><span class="s2">)</span>
                <span class="s1">Msel </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, -</span><span class="s1">offM</span><span class="s2">)</span>
                <span class="s1">Mout </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">M1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">Min </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">M1 </span><span class="s2">- </span><span class="s1">offM</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s1">Msel </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">offM</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s1">Mout </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">M1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">N </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">Nin </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">N1 </span><span class="s2">+ </span><span class="s1">offN</span><span class="s2">)</span>
                <span class="s1">Nsel </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, -</span><span class="s1">offN</span><span class="s2">)</span>
                <span class="s1">Nout </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">N1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">Nin </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">N1 </span><span class="s2">- </span><span class="s1">offN</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s1">Nsel </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">offN</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s1">Nout </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">N1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

            <span class="s5"># Do the calculation, but do not write to the output in the threads.</span>
            <span class="s1">chunk_data </span><span class="s2">= </span><span class="s1">in_typed</span><span class="s2">[</span><span class="s1">Min</span><span class="s2">, </span><span class="s1">Nin</span><span class="s2">]</span>
            <span class="s1">med </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">medfilt2d</span><span class="s2">(</span><span class="s1">chunk_data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KERNEL_SIZE</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">med</span><span class="s2">[</span><span class="s1">Msel</span><span class="s2">, </span><span class="s1">Nsel</span><span class="s2">], </span><span class="s1">Mout</span><span class="s2">, </span><span class="s1">Nout</span>

        <span class="s5"># Give each chunk to a different thread.</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">ThreadPoolExecutor</span><span class="s2">(</span><span class="s1">max_workers</span><span class="s2">=</span><span class="s3">4</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pool</span><span class="s2">:</span>
            <span class="s1">chunks </span><span class="s2">= {(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)}</span>
            <span class="s1">futures </span><span class="s2">= {</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">apply</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">) </span><span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">chunks</span><span class="s2">}</span>

            <span class="s5"># Store each result in the output as it arrives.</span>
            <span class="s0">for </span><span class="s1">future </span><span class="s0">in </span><span class="s1">as_completed</span><span class="s2">(</span><span class="s1">futures</span><span class="s2">):</span>
                <span class="s1">data</span><span class="s2">, </span><span class="s1">Mslice</span><span class="s2">, </span><span class="s1">Nslice </span><span class="s2">= </span><span class="s1">future</span><span class="s2">.</span><span class="s1">result</span><span class="s2">()</span>
                <span class="s1">output</span><span class="s2">[</span><span class="s1">Mslice</span><span class="s2">, </span><span class="s1">Nslice</span><span class="s2">] = </span><span class="s1">data</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestWiener</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">7</span><span class="s2">]], </span><span class="s4">'d'</span><span class="s2">)</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2.16374269</span><span class="s2">, </span><span class="s3">3.2222222222</span><span class="s2">, </span><span class="s3">2.8888888889</span><span class="s2">, </span><span class="s3">1.6666666667</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">2.666666667</span><span class="s2">, </span><span class="s3">4.33333333333</span><span class="s2">, </span><span class="s3">4.44444444444</span><span class="s2">, </span><span class="s3">2.8888888888</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">2.222222222</span><span class="s2">, </span><span class="s3">4.4444444444</span><span class="s2">, </span><span class="s3">5.4444444444</span><span class="s2">, </span><span class="s3">4.801066874837</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">1.33333333333</span><span class="s2">, </span><span class="s3">3.92735042735</span><span class="s2">, </span><span class="s3">6.0712560386</span><span class="s2">, </span><span class="s3">5.0404040404</span><span class="s2">]])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">wiener</span><span class="s2">(</span><span class="s1">g</span><span class="s2">), </span><span class="s1">h</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">wiener</span><span class="s2">(</span><span class="s1">g</span><span class="s2">, </span><span class="s1">mysize</span><span class="s2">=</span><span class="s3">3</span><span class="s2">), </span><span class="s1">h</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">6</span><span class="s2">)</span>


<span class="s1">padtype_options </span><span class="s2">= [</span><span class="s4">&quot;mean&quot;</span><span class="s2">, </span><span class="s4">&quot;median&quot;</span><span class="s2">, </span><span class="s4">&quot;minimum&quot;</span><span class="s2">, </span><span class="s4">&quot;maximum&quot;</span><span class="s2">, </span><span class="s4">&quot;line&quot;</span><span class="s2">]</span>
<span class="s1">padtype_options </span><span class="s2">+= </span><span class="s1">_upfirdn_modes</span>


<span class="s0">class </span><span class="s1">TestResample</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Some basic tests</span>

        <span class="s5"># Regression test for issue #3603.</span>
        <span class="s5"># window.shape must equal to sig.shape[0]</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">128</span><span class="s2">)</span>
        <span class="s1">num </span><span class="s2">= </span><span class="s3">256</span>
        <span class="s1">win </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">get_window</span><span class="s2">((</span><span class="s4">'kaiser'</span><span class="s2">, </span><span class="s3">8.0</span><span class="s2">), </span><span class="s3">160</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">win</span><span class="s2">)</span>

        <span class="s5"># Other degenerate conditions</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s4">'yo'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s4">''</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
                      <span class="s1">padtype</span><span class="s2">=</span><span class="s4">'mean'</span><span class="s2">, </span><span class="s1">cval</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>

        <span class="s5"># test for issue #6505 - should not modify window.shape when axis  0</span>
        <span class="s1">sig2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">160</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">sig2</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">win</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">win</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s3">160</span><span class="s2">,))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'window'</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">'hamming'</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'N'</span><span class="s2">, (</span><span class="s3">20</span><span class="s2">, </span><span class="s3">19</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'num'</span><span class="s2">, (</span><span class="s3">100</span><span class="s2">, </span><span class="s3">101</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_rfft</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">window</span><span class="s2">):</span>
        <span class="s5"># Make sure the speed up using rfft gives the same result as the normal</span>
        <span class="s5"># way using fft</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(-</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">/</span><span class="s3">6.0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">window</span><span class="s2">),</span>
                        <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">y </span><span class="s2">+ </span><span class="s3">0j</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">window</span><span class="s2">).</span><span class="s1">real</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(-</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">/</span><span class="s3">6.0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(-</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">/</span><span class="s3">6.0</span><span class="s2">)])</span>
        <span class="s1">y_complex </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s3">0j</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">window</span><span class="s2">),</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">y_complex</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">window</span><span class="s2">).</span><span class="s1">real</span><span class="s2">,</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_input_domain</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test if both input domain modes produce the same results.</span>
        <span class="s1">tsig </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">256</span><span class="s2">) + </span><span class="s3">0j</span>
        <span class="s1">fsig </span><span class="s2">= </span><span class="s1">fft</span><span class="s2">(</span><span class="s1">tsig</span><span class="s2">)</span>
        <span class="s1">num </span><span class="s2">= </span><span class="s3">256</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">fsig</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">domain</span><span class="s2">=</span><span class="s4">'freq'</span><span class="s2">),</span>
            <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">tsig</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">domain</span><span class="s2">=</span><span class="s4">'time'</span><span class="s2">),</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'nx'</span><span class="s2">, (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'ny'</span><span class="s2">, (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, (</span><span class="s4">'float'</span><span class="s2">, </span><span class="s4">'complex'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_dc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nx</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">nx</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">ny</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'padtype'</span><span class="s2">, </span><span class="s1">padtype_options</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_mutable_window</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">):</span>
        <span class="s5"># Test that a mutable window is not modified</span>
        <span class="s1">impulse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">window </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">window_orig </span><span class="s2">= </span><span class="s1">window</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">impulse</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">window</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s1">padtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">window</span><span class="s2">, </span><span class="s1">window_orig</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'padtype'</span><span class="s2">, </span><span class="s1">padtype_options</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_output_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">):</span>
        <span class="s5"># Test that float32 inputs yield a float32 output</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">h</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s1">padtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'padtype'</span><span class="s2">, </span><span class="s1">padtype_options</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_output_match_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># Test that the dtype of x is preserved per issue #14733</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s1">padtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">&quot;method, ext, padtype&quot;</span><span class="s2">,</span>
        <span class="s2">[(</span><span class="s4">&quot;fft&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s2">+ </span><span class="s1">list</span><span class="s2">(</span>
            <span class="s1">product</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s4">&quot;polyphase&quot;</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">padtype_options</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_resample_methods</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">ext</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">):</span>
        <span class="s5"># Test resampling of sinusoids and random noise (1-sec)</span>
        <span class="s1">rate </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">rates_to </span><span class="s2">= [</span><span class="s3">49</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">51</span><span class="s2">, </span><span class="s3">99</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">101</span><span class="s2">, </span><span class="s3">199</span><span class="s2">, </span><span class="s3">200</span><span class="s2">, </span><span class="s3">201</span><span class="s2">]</span>

        <span class="s5"># Sinusoids, windowed to avoid edge artifacts</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">)</span>
        <span class="s1">freqs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">, </span><span class="s3">40.</span><span class="s2">))[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">freqs </span><span class="s2">* </span><span class="s1">t</span><span class="s2">) * </span><span class="s1">hann</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">rate_to </span><span class="s0">in </span><span class="s1">rates_to</span><span class="s2">:</span>
            <span class="s1">t_to </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">)</span>
            <span class="s1">y_tos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">freqs </span><span class="s2">* </span><span class="s1">t_to</span><span class="s2">) * </span><span class="s1">hann</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'fft'</span><span class="s2">:</span>
                <span class="s1">y_resamps </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rate_to</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">ext </span><span class="s0">and </span><span class="s1">rate_to </span><span class="s2">!= </span><span class="s1">rate</span><span class="s2">:</span>
                    <span class="s5"># Match default window design</span>
                    <span class="s1">g </span><span class="s2">= </span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">)</span>
                    <span class="s1">up </span><span class="s2">= </span><span class="s1">rate_to </span><span class="s2">// </span><span class="s1">g</span>
                    <span class="s1">down </span><span class="s2">= </span><span class="s1">rate </span><span class="s2">// </span><span class="s1">g</span>
                    <span class="s1">max_rate </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">up</span><span class="s2">, </span><span class="s1">down</span><span class="s2">)</span>
                    <span class="s1">f_c </span><span class="s2">= </span><span class="s3">1. </span><span class="s2">/ </span><span class="s1">max_rate</span>
                    <span class="s1">half_len </span><span class="s2">= </span><span class="s3">10 </span><span class="s2">* </span><span class="s1">max_rate</span>
                    <span class="s1">window </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">firwin</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">half_len </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">, </span><span class="s1">f_c</span><span class="s2">,</span>
                                           <span class="s1">window</span><span class="s2">=(</span><span class="s4">'kaiser'</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">))</span>
                    <span class="s1">polyargs </span><span class="s2">= {</span><span class="s4">'window'</span><span class="s2">: </span><span class="s1">window</span><span class="s2">, </span><span class="s4">'padtype'</span><span class="s2">: </span><span class="s1">padtype</span><span class="s2">}</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">polyargs </span><span class="s2">= {</span><span class="s4">'padtype'</span><span class="s2">: </span><span class="s1">padtype</span><span class="s2">}</span>

                <span class="s1">y_resamps </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rate_to</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">,</span>
                                                 <span class="s2">**</span><span class="s1">polyargs</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s1">y_to</span><span class="s2">, </span><span class="s1">y_resamp</span><span class="s2">, </span><span class="s1">freq </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">y_tos</span><span class="s2">, </span><span class="s1">y_resamps</span><span class="s2">, </span><span class="s1">freqs</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">freq </span><span class="s2">&gt;= </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">rate_to</span><span class="s2">:</span>
                    <span class="s1">y_to</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">)  </span><span class="s5"># mostly low-passed away</span>
                    <span class="s0">if </span><span class="s1">padtype </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'minimum'</span><span class="s2">, </span><span class="s4">'maximum'</span><span class="s2">]:</span>
                        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_resamp</span><span class="s2">, </span><span class="s1">y_to</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">3e-1</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_resamp</span><span class="s2">, </span><span class="s1">y_to</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_to</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">y_resamp</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
                    <span class="s1">corr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">corrcoef</span><span class="s2">(</span><span class="s1">y_to</span><span class="s2">, </span><span class="s1">y_resamp</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
                    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">corr </span><span class="s2">&gt; </span><span class="s3">0.99</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=(</span><span class="s1">corr</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">rate_to</span><span class="s2">))</span>

        <span class="s5"># Random data</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">hann</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">))  </span><span class="s5"># low-pass, wind</span>
        <span class="s0">for </span><span class="s1">rate_to </span><span class="s0">in </span><span class="s1">rates_to</span><span class="s2">:</span>
            <span class="s5"># random data</span>
            <span class="s1">t_to </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">)</span>
            <span class="s1">y_to </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">interp</span><span class="s2">(</span><span class="s1">t_to</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'fft'</span><span class="s2">:</span>
                <span class="s1">y_resamp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rate_to</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">y_resamp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rate_to</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">,</span>
                                                <span class="s1">padtype</span><span class="s2">=</span><span class="s1">padtype</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_to</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">y_resamp</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">corr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">corrcoef</span><span class="s2">(</span><span class="s1">y_to</span><span class="s2">, </span><span class="s1">y_resamp</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">corr </span><span class="s2">&gt; </span><span class="s3">0.99</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">corr</span><span class="s2">)</span>

        <span class="s5"># More tests of fft method (Master 0.18.1 fails these)</span>
        <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'fft'</span><span class="s2">:</span>
            <span class="s1">x1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">])</span>
            <span class="s1">y1_test </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
            <span class="s5"># upsampling a complex array</span>
            <span class="s1">y1_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">])</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y1_test</span><span class="s2">, </span><span class="s1">y1_true</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-12</span><span class="s2">)</span>
            <span class="s1">x2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
            <span class="s1">y2_test </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)  </span><span class="s5"># downsampling a real array</span>
            <span class="s1">y2_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">])</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y2_test</span><span class="s2">, </span><span class="s1">y2_true</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-12</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_poly_vs_filtfilt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that up=1.0 gives same answer as filtfilt + slicing</span>
        <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">17</span><span class="s2">)</span>
        <span class="s1">try_types </span><span class="s2">= (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">)</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s3">10000</span>
        <span class="s1">down_factors </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">79</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">try_types</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">size</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">):</span>
                <span class="s1">x </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>

            <span class="s5"># resample_poly assumes zeros outside of signl, whereas filtfilt</span>
            <span class="s5"># can only constant-pad. Make them equivalent:</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">0</span>
            <span class="s1">x</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] = </span><span class="s3">0</span>

            <span class="s0">for </span><span class="s1">down </span><span class="s0">in </span><span class="s1">down_factors</span><span class="s2">:</span>
                <span class="s1">h </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">firwin</span><span class="s2">(</span><span class="s3">31</span><span class="s2">, </span><span class="s3">1. </span><span class="s2">/ </span><span class="s1">down</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s4">'hamming'</span><span class="s2">)</span>
                <span class="s1">yf </span><span class="s2">= </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s4">'constant'</span><span class="s2">)[::</span><span class="s1">down</span><span class="s2">]</span>

                <span class="s5"># Need to pass convolved version of filter to resample_poly,</span>
                <span class="s5"># since filtfilt does forward and backward, but resample_poly</span>
                <span class="s5"># only goes forward</span>
                <span class="s1">hc </span><span class="s2">= </span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">h</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">])</span>
                <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">down</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">hc</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_correlate1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">down </span><span class="s0">in </span><span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">nx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">40</span><span class="s2">, </span><span class="s1">down</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">nweights </span><span class="s0">in </span><span class="s2">(</span><span class="s3">32</span><span class="s2">, </span><span class="s3">33</span><span class="s2">):</span>
                    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">nx</span><span class="s2">,))</span>
                    <span class="s1">weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">nweights</span><span class="s2">,))</span>
                    <span class="s1">y_g </span><span class="s2">= </span><span class="s1">correlate1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'constant'</span><span class="s2">)</span>
                    <span class="s1">y_s </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span>
                        <span class="s1">x</span><span class="s2">, </span><span class="s1">up</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">down</span><span class="s2">=</span><span class="s1">down</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">)</span>
                    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_g</span><span class="s2">[::</span><span class="s1">down</span><span class="s2">], </span><span class="s1">y_s</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCSpline1DEval</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
        <span class="s1">dx </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] - </span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">cj </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">cspline1d</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y</span><span class="s2">) * </span><span class="s3">10.0</span><span class="s2">) / </span><span class="s3">10.0</span>
        <span class="s1">y2 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">cspline1d_eval</span><span class="s2">(</span><span class="s1">cj</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">dx</span><span class="s2">=</span><span class="s1">dx</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

        <span class="s5"># make sure interpolated values are on knot points</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">[::</span><span class="s3">10</span><span class="s2">], </span><span class="s1">y</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">#  create some smoothly varying complex signal to interpolate</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">T </span><span class="s2">= </span><span class="s3">10.0</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s3">1.0 </span><span class="s2">/ </span><span class="s1">T</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2.0J </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">f </span><span class="s2">* </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s5"># get the cspline transform</span>
        <span class="s1">cy </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">cspline1d</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s5"># determine new test x value and interpolate</span>
        <span class="s1">xnew </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">ynew </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">cspline1d_eval</span><span class="s2">(</span><span class="s1">cy</span><span class="s2">, </span><span class="s1">xnew</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ynew</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestOrderFilt</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">order_filter</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">_TestLinearFilter</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'O'</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">iter </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">out</span><span class="s2">], [</span><span class="s4">'refs_ok'</span><span class="s2">,</span><span class="s4">'zerosize_ok'</span><span class="s2">],</span>
                        <span class="s2">[[</span><span class="s4">'readonly'</span><span class="s2">],[</span><span class="s4">'writeonly'</span><span class="s2">]])</span>
            <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">iter</span><span class="s2">:</span>
                <span class="s1">y</span><span class="s2">[...] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[()])</span>
            <span class="s0">return </span><span class="s1">out</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_1_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">y_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_1_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">y_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_1_IIR_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">21</span><span class="s2">])</span>
        <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">13</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_1_FIR_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">12.</span><span class="s2">])</span>
        <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">9</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_2_IIR_axis_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">y_r2_a0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">],</span>
                                      <span class="s2">[</span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_2_IIR_axis_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">y_r2_a1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">12</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s3">18</span><span class="s2">, -</span><span class="s3">16</span><span class="s2">, </span><span class="s3">18</span><span class="s2">]])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_2_IIR_axis_0_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">4</span><span class="s2">,</span><span class="s3">1</span><span class="s2">)))</span>

        <span class="s1">y_r2_a0_1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [</span><span class="s3">13</span><span class="s2">, -</span><span class="s3">11</span><span class="s2">, </span><span class="s3">13</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s3">19</span><span class="s2">, -</span><span class="s3">17</span><span class="s2">, </span><span class="s3">19</span><span class="s2">]])</span>
        <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([-</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">17</span><span class="s2">, -</span><span class="s3">29</span><span class="s2">, -</span><span class="s3">41</span><span class="s2">])[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a0_1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_2_IIR_axis_1_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">,</span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">)))</span>

        <span class="s1">y_r2_a0_0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([[-</span><span class="s3">23</span><span class="s2">, -</span><span class="s3">23</span><span class="s2">, -</span><span class="s3">23</span><span class="s2">]])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a0_0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_3_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>

        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">):</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>
            <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">w</span><span class="s2">: </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_3_IIR_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>

        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">):</span>
            <span class="s1">zi_shape </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">zi_shape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s3">1</span>
            <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">zi_shape</span><span class="s2">))</span>
            <span class="s1">zi1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">lf0</span><span class="s2">(</span><span class="s1">w</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi1</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s0">def </span><span class="s1">lf1</span><span class="s2">(</span><span class="s1">w</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi1</span><span class="s2">)[</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">lf0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">lf1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_3_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">):</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>
            <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">w</span><span class="s2">: </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_3_FIR_init_cond</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">):</span>
            <span class="s1">zi_shape </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">zi_shape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s3">2</span>
            <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">zi_shape</span><span class="s2">))</span>
            <span class="s1">zi1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">lf0</span><span class="s2">(</span><span class="s1">w</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi1</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s0">def </span><span class="s1">lf1</span><span class="s2">(</span><span class="s1">w</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi1</span><span class="s2">)[</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">lf0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">zf_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">lf1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zf_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zi_pseudobroadcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>
        <span class="s1">b</span><span class="s2">,</span><span class="s1">a </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'ba'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">zi_size </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] - </span><span class="s3">1</span>

        <span class="s5"># lfilter requires x.ndim == zi.ndim exactly.  However, zi can have</span>
        <span class="s5"># length 1 dimensions.</span>
        <span class="s1">zi_full </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">zi_size</span><span class="s2">)))</span>
        <span class="s1">zi_sing </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi_size</span><span class="s2">)))</span>

        <span class="s1">y_full</span><span class="s2">, </span><span class="s1">zf_full </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi_full</span><span class="s2">)</span>
        <span class="s1">y_sing</span><span class="s2">, </span><span class="s1">zf_sing </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi_sing</span><span class="s2">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_sing</span><span class="s2">, </span><span class="s1">y_full</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf_full</span><span class="s2">, </span><span class="s1">zf_sing</span><span class="s2">)</span>

        <span class="s5"># lfilter does not prepend ones</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">zi_size</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_scalar_a</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># a can be a scalar.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zi_some_singleton_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># lfilter doesn't really broadcast (no prepending of 1's).  But does</span>
        <span class="s5"># do singleton expansion if x and zi have the same ndim.  This was</span>
        <span class="s5"># broken only if a subset of the axes were singletons (gh-4681).</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">5</span><span class="s2">), </span><span class="s4">'l'</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s4">'l'</span><span class="s2">))</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">,</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">]))</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">4</span><span class="s2">), </span><span class="s4">'l'</span><span class="s2">)</span>
        <span class="s1">zi</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,:,:] *= </span><span class="s3">2</span>
        <span class="s1">zi</span><span class="s2">[</span><span class="s3">2</span><span class="s2">,:,:] *= </span><span class="s3">3</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">zi</span><span class="s2">)</span>

        <span class="s1">zf_expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">4</span><span class="s2">), </span><span class="s4">'l'</span><span class="s2">))</span>
        <span class="s1">y_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">5</span><span class="s2">), </span><span class="s4">'l'</span><span class="s2">)</span>
        <span class="s1">y_expected</span><span class="s2">[:,:,:</span><span class="s3">4</span><span class="s2">] = [[[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">2</span><span class="s2">]], [[</span><span class="s3">3</span><span class="s2">]]]</span>
        <span class="s1">y_expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">y_expected</span><span class="s2">)</span>

        <span class="s5"># IIR</span>
        <span class="s1">y_iir</span><span class="s2">, </span><span class="s1">zf_iir </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_iir</span><span class="s2">, </span><span class="s1">y_expected</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf_iir</span><span class="s2">, </span><span class="s1">zf_expected</span><span class="s2">)</span>

        <span class="s5"># FIR</span>
        <span class="s1">y_fir</span><span class="s2">, </span><span class="s1">zf_fir </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_fir</span><span class="s2">, </span><span class="s1">y_expected</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf_fir</span><span class="s2">, </span><span class="s1">zf_expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">base_bad_size_zi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">(</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_size_zi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># rank 1</span>
        <span class="s1">x1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

        <span class="s5"># rank 2</span>
        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">4</span><span class="s2">,</span><span class="s3">3</span><span class="s2">))</span>
        <span class="s5"># for axis=0 zi.shape should == (max(len(a),len(b))-1, 3)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>

        <span class="s5"># for each of these there are 5 cases tested (in this order):</span>
        <span class="s5"># 1. not deep enough, right # elements</span>
        <span class="s5"># 2. too deep, right # elements</span>
        <span class="s5"># 3. right depth, right # elements, transposed</span>
        <span class="s5"># 4. right depth, too few elements</span>
        <span class="s5"># 5. right depth, too many elements</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>

        <span class="s5"># for axis=1 zi.shape should == (4, max(len(a),len(b))-1)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">],[</span><span class="s3">8</span><span class="s2">,</span><span class="s3">9</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">],[</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">],[</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">],[</span><span class="s3">8</span><span class="s2">,</span><span class="s3">9</span><span class="s2">]])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">,</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_bad_size_zi</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">x2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">],[</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">],[</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">],[</span><span class="s3">6</span><span class="s2">,</span><span class="s3">7</span><span class="s2">],[</span><span class="s3">8</span><span class="s2">,</span><span class="s3">9</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_empty_zi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for #880: empty array for zi crashes.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">5</span><span class="s2">,))</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lfiltic_bad_zi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for #3699: bad initial conditions</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s5"># &quot;y&quot; sets the datatype of zi, so it truncates if int</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">lfiltic</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">zi_1 </span><span class="s2">= </span><span class="s1">lfiltic</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">zi_2 </span><span class="s2">= </span><span class="s1">lfiltic</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">zi_1</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">zi_2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_short_x_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># regression test for #5116</span>
        <span class="s5"># x shorter than b, with non None zi fails</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">72</span><span class="s2">])</span>
        <span class="s1">ye </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">74</span><span class="s2">])</span>
        <span class="s1">zfe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">7</span><span class="s2">, -</span><span class="s3">72</span><span class="s2">])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">ye</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zfe</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_short_x_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># regression test for #5116</span>
        <span class="s5"># x shorter than b, with non None zi fails</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">72</span><span class="s2">])</span>
        <span class="s1">ye </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">74</span><span class="s2">])</span>
        <span class="s1">zfe </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([-</span><span class="s3">67</span><span class="s2">, -</span><span class="s3">72</span><span class="s2">])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">ye</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zfe</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_do_not_modify_a_b_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b0 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">a0 </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">])</span>
        <span class="s1">y_f </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_f</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_do_not_modify_a_b_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">((</span><span class="s3">6</span><span class="s2">,))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">b0 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">a0 </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dtype</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">])</span>
        <span class="s1">y_f </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_f</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a0</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;a&quot;</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">)])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;b&quot;</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_scalar_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">lfilter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">]), </span><span class="s1">data</span><span class="s2">),</span>
            <span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">data</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestLinearFilterFloat32</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLinearFilterFloat64</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'d'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLinearFilterFloatExtended</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'g'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLinearFilterComplex64</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLinearFilterComplex128</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'D'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLinearFilterComplexExtended</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'G'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestLinearFilterDecimal</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'O'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestLinearFilterObject</span><span class="s2">(</span><span class="s1">_TestLinearFilter</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'O'</span><span class="s2">)</span>
    <span class="s1">type </span><span class="s2">= </span><span class="s1">float</span>


<span class="s0">def </span><span class="s1">test_lfilter_bad_object</span><span class="s2">():</span>
    <span class="s5"># lfilter: object arrays with non-numeric objects raise TypeError.</span>
    <span class="s5"># Regression test for ticket #1452.</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">, </span><span class="s4">'abiflags'</span><span class="s2">) </span><span class="s0">and </span><span class="s4">'d' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">abiflags</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'test is flaky when run with python3-dbg'</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_lfilter_notimplemented_input</span><span class="s2">():</span>
    <span class="s5"># Should not crash, gh-7991</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dt'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ubyte</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">byte</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ushort</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">short</span><span class="s2">,</span>
                                <span class="s1">np_ulong</span><span class="s2">, </span><span class="s1">np_long</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">,</span>
                                <span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">,</span>
                                <span class="s1">Decimal</span><span class="s2">])</span>
<span class="s0">class </span><span class="s1">TestCorrelateReal</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r</span>

    <span class="s0">def </span><span class="s1">equal_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">res_dt</span><span class="s2">):</span>
        <span class="s5"># default value of keyword</span>
        <span class="s1">decimal </span><span class="s2">= </span><span class="s3">6</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">dt_info </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">res_dt</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dt_info</span><span class="s2">, </span><span class="s4">'resolution'</span><span class="s2">):</span>
                <span class="s1">decimal </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(-</span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">(</span><span class="s1">dt_info</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">decimal</span>

    <span class="s0">def </span><span class="s1">equal_tolerance_fft</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">res_dt</span><span class="s2">):</span>
        <span class="s5"># FFT implementations convert longdouble arguments down to</span>
        <span class="s5"># double so don't expect better precision, see gh-9520</span>
        <span class="s0">if </span><span class="s1">res_dt </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">equal_tolerance</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">equal_tolerance</span><span class="s2">(</span><span class="s1">res_dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dt </span><span class="s2">== </span><span class="s1">Decimal</span><span class="s2">:</span>
            <span class="s1">method </span><span class="s2">= </span><span class="s1">choose_conv_method</span><span class="s2">([</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)], [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank3</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">y_fft </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
            <span class="s1">y_direct </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>

            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r</span><span class="s2">,</span>
                                      <span class="s1">y_fft</span><span class="s2">,</span>
                                      <span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">equal_tolerance_fft</span><span class="s2">(</span><span class="s1">y_fft</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">),)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r</span><span class="s2">,</span>
                                      <span class="s1">y_direct</span><span class="s2">,</span>
                                      <span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">equal_tolerance</span><span class="s2">(</span><span class="s1">y_direct</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">),)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y_fft</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y_direct</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank1_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">4</span><span class="s2">][::-</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank1_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank1_full</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_setup_rank3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">39</span><span class="s2">, </span><span class="s3">40</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span>
            <span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">23</span><span class="s2">, </span><span class="s3">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span>
            <span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">184.</span><span class="s2">, </span><span class="s3">504.</span><span class="s2">, </span><span class="s3">912.</span><span class="s2">, </span><span class="s3">1360.</span><span class="s2">, </span><span class="s3">888.</span><span class="s2">, </span><span class="s3">472.</span><span class="s2">, </span><span class="s3">160.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">46.</span><span class="s2">, </span><span class="s3">432.</span><span class="s2">, </span><span class="s3">1062.</span><span class="s2">, </span><span class="s3">1840.</span><span class="s2">, </span><span class="s3">2672.</span><span class="s2">, </span><span class="s3">1698.</span><span class="s2">, </span><span class="s3">864.</span><span class="s2">, </span><span class="s3">266.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">134.</span><span class="s2">, </span><span class="s3">736.</span><span class="s2">, </span><span class="s3">1662.</span><span class="s2">, </span><span class="s3">2768.</span><span class="s2">, </span><span class="s3">3920.</span><span class="s2">, </span><span class="s3">2418.</span><span class="s2">, </span><span class="s3">1168.</span><span class="s2">, </span><span class="s3">314.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">260.</span><span class="s2">, </span><span class="s3">952.</span><span class="s2">, </span><span class="s3">1932.</span><span class="s2">, </span><span class="s3">3056.</span><span class="s2">, </span><span class="s3">4208.</span><span class="s2">, </span><span class="s3">2580.</span><span class="s2">, </span><span class="s3">1240.</span><span class="s2">, </span><span class="s3">332.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">202.</span><span class="s2">, </span><span class="s3">664.</span><span class="s2">, </span><span class="s3">1290.</span><span class="s2">, </span><span class="s3">1984.</span><span class="s2">, </span><span class="s3">2688.</span><span class="s2">, </span><span class="s3">1590.</span><span class="s2">, </span><span class="s3">712.</span><span class="s2">, </span><span class="s3">150.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">114.</span><span class="s2">, </span><span class="s3">344.</span><span class="s2">, </span><span class="s3">642.</span><span class="s2">, </span><span class="s3">960.</span><span class="s2">, </span><span class="s3">1280.</span><span class="s2">, </span><span class="s3">726.</span><span class="s2">, </span><span class="s3">296.</span><span class="s2">, </span><span class="s3">38.</span><span class="s2">]],</span>

                     <span class="s2">[[</span><span class="s3">23.</span><span class="s2">, </span><span class="s3">400.</span><span class="s2">, </span><span class="s3">1035.</span><span class="s2">, </span><span class="s3">1832.</span><span class="s2">, </span><span class="s3">2696.</span><span class="s2">, </span><span class="s3">1737.</span><span class="s2">, </span><span class="s3">904.</span><span class="s2">, </span><span class="s3">293.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">134.</span><span class="s2">, </span><span class="s3">920.</span><span class="s2">, </span><span class="s3">2166.</span><span class="s2">, </span><span class="s3">3680.</span><span class="s2">, </span><span class="s3">5280.</span><span class="s2">, </span><span class="s3">3306.</span><span class="s2">, </span><span class="s3">1640.</span><span class="s2">, </span><span class="s3">474.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">325.</span><span class="s2">, </span><span class="s3">1544.</span><span class="s2">, </span><span class="s3">3369.</span><span class="s2">, </span><span class="s3">5512.</span><span class="s2">, </span><span class="s3">7720.</span><span class="s2">, </span><span class="s3">4683.</span><span class="s2">, </span><span class="s3">2192.</span><span class="s2">, </span><span class="s3">535.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">571.</span><span class="s2">, </span><span class="s3">1964.</span><span class="s2">, </span><span class="s3">3891.</span><span class="s2">, </span><span class="s3">6064.</span><span class="s2">, </span><span class="s3">8272.</span><span class="s2">, </span><span class="s3">4989.</span><span class="s2">, </span><span class="s3">2324.</span><span class="s2">, </span><span class="s3">565.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">434.</span><span class="s2">, </span><span class="s3">1360.</span><span class="s2">, </span><span class="s3">2586.</span><span class="s2">, </span><span class="s3">3920.</span><span class="s2">, </span><span class="s3">5264.</span><span class="s2">, </span><span class="s3">3054.</span><span class="s2">, </span><span class="s3">1312.</span><span class="s2">, </span><span class="s3">230.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">241.</span><span class="s2">, </span><span class="s3">700.</span><span class="s2">, </span><span class="s3">1281.</span><span class="s2">, </span><span class="s3">1888.</span><span class="s2">, </span><span class="s3">2496.</span><span class="s2">, </span><span class="s3">1383.</span><span class="s2">, </span><span class="s3">532.</span><span class="s2">, </span><span class="s3">39.</span><span class="s2">]],</span>

                     <span class="s2">[[</span><span class="s3">22.</span><span class="s2">, </span><span class="s3">214.</span><span class="s2">, </span><span class="s3">528.</span><span class="s2">, </span><span class="s3">916.</span><span class="s2">, </span><span class="s3">1332.</span><span class="s2">, </span><span class="s3">846.</span><span class="s2">, </span><span class="s3">430.</span><span class="s2">, </span><span class="s3">132.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">86.</span><span class="s2">, </span><span class="s3">484.</span><span class="s2">, </span><span class="s3">1098.</span><span class="s2">, </span><span class="s3">1832.</span><span class="s2">, </span><span class="s3">2600.</span><span class="s2">, </span><span class="s3">1602.</span><span class="s2">, </span><span class="s3">772.</span><span class="s2">, </span><span class="s3">206.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">188.</span><span class="s2">, </span><span class="s3">802.</span><span class="s2">, </span><span class="s3">1698.</span><span class="s2">, </span><span class="s3">2732.</span><span class="s2">, </span><span class="s3">3788.</span><span class="s2">, </span><span class="s3">2256.</span><span class="s2">, </span><span class="s3">1018.</span><span class="s2">, </span><span class="s3">218.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">308.</span><span class="s2">, </span><span class="s3">1006.</span><span class="s2">, </span><span class="s3">1950.</span><span class="s2">, </span><span class="s3">2996.</span><span class="s2">, </span><span class="s3">4052.</span><span class="s2">, </span><span class="s3">2400.</span><span class="s2">, </span><span class="s3">1078.</span><span class="s2">, </span><span class="s3">230.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">230.</span><span class="s2">, </span><span class="s3">692.</span><span class="s2">, </span><span class="s3">1290.</span><span class="s2">, </span><span class="s3">1928.</span><span class="s2">, </span><span class="s3">2568.</span><span class="s2">, </span><span class="s3">1458.</span><span class="s2">, </span><span class="s3">596.</span><span class="s2">, </span><span class="s3">78.</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">126.</span><span class="s2">, </span><span class="s3">354.</span><span class="s2">, </span><span class="s3">636.</span><span class="s2">, </span><span class="s3">924.</span><span class="s2">, </span><span class="s3">1212.</span><span class="s2">, </span><span class="s3">654.</span><span class="s2">, </span><span class="s3">234.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">]]],</span>
                    <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r</span>

    <span class="s0">def </span><span class="s1">test_rank3_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank3</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">&quot;valid&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">:</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">:</span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">&quot;valid&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">:</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">:</span><span class="s3">5</span><span class="s2">][::-</span><span class="s3">1</span><span class="s2">, ::-</span><span class="s3">1</span><span class="s2">, ::-</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank3_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank3</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">&quot;same&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:-</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank3_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank3</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCorrelate</span><span class="s2">:</span>
    <span class="s5"># Tests that don't depend on dtype</span>

    <span class="s0">def </span><span class="s1">test_invalid_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># By &quot;invalid,&quot; we mean that no one</span>
        <span class="s5"># array has dimensions that are all at</span>
        <span class="s5"># least as large as the corresponding</span>
        <span class="s5"># dimensions of the other array. This</span>
        <span class="s5"># setup should throw a ValueError.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, *(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, *(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>

    <span class="s0">def </span><span class="s1">test_invalid_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'spam'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'eggs'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'ham'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'bacon'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'bacon'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mismatched_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Input arrays should have the same number of dimensions</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'direct'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fft'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], [[</span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">correlate</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_fastpath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">), [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">23</span><span class="s2">])</span>

        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'same'</span><span class="s2">), [</span><span class="s3">17</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">23</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">), [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">23</span><span class="s2">, </span><span class="s3">12</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'valid'</span><span class="s2">), [</span><span class="s3">32</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;mode&quot;</span><span class="s2">, [</span><span class="s4">&quot;valid&quot;</span><span class="s2">, </span><span class="s4">&quot;same&quot;</span><span class="s2">, </span><span class="s4">&quot;full&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;behind&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;input_size&quot;</span><span class="s2">, [</span><span class="s3">100</span><span class="s2">, </span><span class="s3">101</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">, </span><span class="s3">1001</span><span class="s2">, </span><span class="s3">10000</span><span class="s2">, </span><span class="s3">10001</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_correlation_lags</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">behind</span><span class="s2">, </span><span class="s1">input_size</span><span class="s2">):</span>
    <span class="s5"># generate random data</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">in1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">input_size</span><span class="s2">)</span>
    <span class="s1">offset </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">input_size</span><span class="s2">/</span><span class="s3">10</span><span class="s2">)</span>
    <span class="s5"># generate offset version of array to correlate with</span>
    <span class="s0">if </span><span class="s1">behind</span><span class="s2">:</span>
        <span class="s5"># y is behind x</span>
        <span class="s1">in2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">), </span><span class="s1">in1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= -</span><span class="s1">offset</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># y is ahead of x</span>
        <span class="s1">in2 </span><span class="s2">= </span><span class="s1">in1</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">offset</span>
    <span class="s5"># cross correlate, returning lag information</span>
    <span class="s1">correlation </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">in1</span><span class="s2">, </span><span class="s1">in2</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
    <span class="s1">lags </span><span class="s2">= </span><span class="s1">correlation_lags</span><span class="s2">(</span><span class="s1">in1</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">in2</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
    <span class="s5"># identify the peak</span>
    <span class="s1">lag_index </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">correlation</span><span class="s2">)</span>
    <span class="s5"># Check as expected</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">lags</span><span class="s2">[</span><span class="s1">lag_index</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s5"># Correlation and lags shape should match</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">lags</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">correlation</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dt'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">csingle</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cdouble</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">])</span>
<span class="s0">class </span><span class="s1">TestCorrelateComplex</span><span class="s2">:</span>
    <span class="s5"># The decimal precision to be used for comparing results.</span>
    <span class="s5"># This value will be passed as the 'decimal' keyword argument of</span>
    <span class="s5"># assert_array_almost_equal().</span>
    <span class="s5"># Since correlate may chose to use FFT method which converts</span>
    <span class="s5"># longdoubles to doubles internally don't expect better precision</span>
    <span class="s5"># for longdouble than for double (see gh-9520).</span>

    <span class="s0">def </span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dt </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">:</span>
            <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cdouble</span>
        <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">precision </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">9</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">8</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">8</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r </span><span class="s2">= (</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">) +</span>
               <span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y_r </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* (-</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">) +</span>
                     <span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r</span>

    <span class="s0">def </span><span class="s1">test_rank1_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># See gh-5897</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank1_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank1_full</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">y_r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_setup_rank1</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_swap_full</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">+</span><span class="s3">1.j</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">+</span><span class="s3">2.j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">+</span><span class="s3">3.j</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">+</span><span class="s3">4.j</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">+</span><span class="s3">5.j</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">+</span><span class="s3">6.j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s3">0.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">-</span><span class="s3">2.j</span><span class="s2">, </span><span class="s3">28.</span><span class="s2">-</span><span class="s3">6.j</span><span class="s2">, </span><span class="s3">22.</span><span class="s2">-</span><span class="s3">6.j</span><span class="s2">, </span><span class="s3">16.</span><span class="s2">-</span><span class="s3">6.j</span><span class="s2">, </span><span class="s3">8.</span><span class="s2">-</span><span class="s3">4.j</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_swap_same</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= [</span><span class="s3">0.</span><span class="s2">+</span><span class="s3">0.j</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">+</span><span class="s3">1.j</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">+</span><span class="s3">2.j</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">+</span><span class="s3">3.j</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">+</span><span class="s3">4.j</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">+</span><span class="s3">5.j</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">+</span><span class="s3">6.j</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;same&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s3">10.</span><span class="s2">-</span><span class="s3">2.j</span><span class="s2">, </span><span class="s3">28.</span><span class="s2">-</span><span class="s3">6.j</span><span class="s2">, </span><span class="s3">22.</span><span class="s2">-</span><span class="s3">6.j</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_rank3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r </span><span class="s2">= (</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)</span>
               <span class="s2">+ </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y_r </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* (-</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">) + </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">()).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">()).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">()).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">()).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r </span><span class="s2">= (</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)</span>
               <span class="s2">+ </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y_r </span><span class="s2">+= </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">) +</span>
                             <span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">real</span><span class="s2">))</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_r</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2j</span><span class="s2">]), </span><span class="s1">correlate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">([</span><span class="s3">2j</span><span class="s2">], [</span><span class="s3">3j</span><span class="s2">]), </span><span class="s1">correlate</span><span class="s2">(</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3j</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">correlate</span><span class="s2">([</span><span class="s3">3j</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">]), </span><span class="s1">correlate</span><span class="s2">(</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestCorrelate2d</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_consistency_correlate_funcs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Compare np.correlate, signal.correlate, signal.correlate2d</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'full'</span><span class="s2">, </span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">]:</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">),</span>
                                <span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">squeeze</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s1">b</span><span class="s2">],</span>
                                                              <span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)),</span>
                                <span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>

            <span class="s5"># See gh-5897</span>
            <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">'valid'</span><span class="s2">:</span>
                <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">),</span>
                                    <span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>
                <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">squeeze</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">([</span><span class="s1">b</span><span class="s2">], [</span><span class="s1">a</span><span class="s2">],</span>
                                                                  <span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)),</span>
                                    <span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># By &quot;invalid,&quot; we mean that no one</span>
        <span class="s5"># array has dimensions that are all at</span>
        <span class="s5"># least as large as the corresponding</span>
        <span class="s5"># dimensions of the other array. This</span>
        <span class="s5"># setup should throw a ValueError.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">, *(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">, *(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), **{</span><span class="s4">'mode'</span><span class="s2">: </span><span class="s4">'valid'</span><span class="s2">})</span>

    <span class="s0">def </span><span class="s1">test_complex_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">2j</span><span class="s2">]]), -</span><span class="s3">2j</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">([[</span><span class="s3">2j</span><span class="s2">]], [[</span><span class="s3">3j</span><span class="s2">]]), </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">correlate2d</span><span class="s2">([[</span><span class="s3">3j</span><span class="s2">]], [[</span><span class="s3">4</span><span class="s2">]]), </span><span class="s3">12j</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLFilterZI</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
        <span class="s1">zi_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">5.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">zi_expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_scale_invariance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test.  There was a bug in which b was not correctly</span>
        <span class="s5"># rescaled when a[0] was nonzero.</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">8</span><span class="s2">])</span>
        <span class="s1">zi1 </span><span class="s2">= </span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">zi2 </span><span class="s2">= </span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">b</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zi2</span><span class="s2">, </span><span class="s1">zi1</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-12</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">8</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">real</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)).</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFiltFilt</span><span class="s2">:</span>
    <span class="s1">filtfilt_kind </span><span class="s2">= </span><span class="s4">'tf'</span>

    <span class="s0">def </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">=</span><span class="s4">'odd'</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">method</span><span class="s2">=</span><span class="s4">'pad'</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt_kind </span><span class="s2">== </span><span class="s4">'tf'</span><span class="s2">:</span>
            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">zpk2tf</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt_kind </span><span class="s2">== </span><span class="s4">'sos'</span><span class="s2">:</span>
            <span class="s1">sos </span><span class="s2">= </span><span class="s1">zpk2sos</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">sosfiltfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">padtype</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">zpk </span><span class="s2">= </span><span class="s1">tf2zpk</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">5.28e-11</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rate </span><span class="s2">= </span><span class="s3">2000</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">rate </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s5"># A signal with low frequency and a high frequency.</span>
        <span class="s1">xlow </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">5 </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">xhigh </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">250 </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">xlow </span><span class="s2">+ </span><span class="s1">xhigh</span>

        <span class="s1">zpk </span><span class="s2">= </span><span class="s1">butter</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">0.125</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">)</span>
        <span class="s5"># r is the magnitude of the largest pole.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">max</span><span class="s2">()</span>
        <span class="s1">eps </span><span class="s2">= </span><span class="s3">1e-5</span>
        <span class="s5"># n estimates the number of steps for the</span>
        <span class="s5"># transient to decay by a factor of eps.</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">eps</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">r</span><span class="s2">)))</span>

        <span class="s5"># High order lowpass filter...</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s5"># Result should be just xlow.</span>
        <span class="s1">err </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y </span><span class="s2">- </span><span class="s1">xlow</span><span class="s2">).</span><span class="s1">max</span><span class="s2">()</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&lt; </span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s5"># A 2D case.</span>
        <span class="s1">x2d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">xlow</span><span class="s2">, </span><span class="s1">xlow </span><span class="s2">+ </span><span class="s1">xhigh</span><span class="s2">])</span>
        <span class="s1">y2d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">x2d</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">=</span><span class="s1">n</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y2d</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">x2d</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">err </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y2d </span><span class="s2">- </span><span class="s1">xlow</span><span class="s2">).</span><span class="s1">max</span><span class="s2">()</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&lt; </span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s5"># Use the previous result to check the use of the axis keyword.</span>
        <span class="s5"># (Regression test for ticket #1620)</span>
        <span class="s1">y2dt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">x2d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">=</span><span class="s1">n</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y2d</span><span class="s2">, </span><span class="s1">y2dt</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test the 'axis' keyword on a 3D array.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10.0 </span><span class="s2">* </span><span class="s3">11.0 </span><span class="s2">* </span><span class="s3">12.0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">zpk </span><span class="s2">= </span><span class="s1">butter</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0.125</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">)</span>
        <span class="s1">y0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">padlen</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">y1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">padlen</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">y2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">zpk</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">padlen</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_acoeff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt_kind </span><span class="s2">!= </span><span class="s4">'tf'</span><span class="s2">:</span>
            <span class="s0">return  </span><span class="s5"># only necessary for TF</span>
        <span class="s5"># test for 'a' coefficient as single number</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">([</span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gust_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt_kind </span><span class="s2">!= </span><span class="s4">'tf'</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'gust only implemented for TF systems'</span><span class="s2">)</span>
        <span class="s5"># The input array has length 2.  The exact solution for this case</span>
        <span class="s5"># was computed &quot;by hand&quot;.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">z1</span><span class="s2">, </span><span class="s1">z2 </span><span class="s2">= </span><span class="s1">_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">z1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">z2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]],</span>
                        <span class="s2">[</span><span class="s3">0.3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s3">0.2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s1">z1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.25</span><span class="s2">*</span><span class="s1">z2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.25</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.125</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">],</span>
                            <span class="s3">0.25</span><span class="s2">*</span><span class="s1">z1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s1">z2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.125</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">0.25</span><span class="s2">*</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_gust_scalars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filtfilt_kind </span><span class="s2">!= </span><span class="s4">'tf'</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'gust only implemented for TF systems'</span><span class="s2">)</span>
        <span class="s5"># The filter coefficients are both scalars, so the filter simply</span>
        <span class="s5"># multiplies its input by b/a.  When it is used in filtfilt, the</span>
        <span class="s5"># factor is (b/a)**2.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">3.0</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">2.0</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;gust&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= (</span><span class="s1">b</span><span class="s2">/</span><span class="s1">a</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSOSFiltFilt</span><span class="s2">(</span><span class="s1">TestFiltFilt</span><span class="s2">):</span>
    <span class="s1">filtfilt_kind </span><span class="s2">= </span><span class="s4">'sos'</span>

    <span class="s0">def </span><span class="s1">test_equivalence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Test equivalence between sosfiltfilt and filtfilt&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">1000</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">order </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s1">zpk </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s1">order</span><span class="s2">, </span><span class="s3">0.35</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">zpk2tf</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
            <span class="s1">sos </span><span class="s2">= </span><span class="s1">zpk2sos</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">y_sos </span><span class="s2">= </span><span class="s1">sosfiltfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_sos</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-12</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'order=%s' </span><span class="s2">% </span><span class="s1">order</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">filtfilt_gust_opt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    An alternative implementation of filtfilt with Gustafsson edges. 
 
    This function computes the same result as 
    `scipy.signal._signaltools._filtfilt_gust`, but only 1-d arrays 
    are accepted.  The problem is solved using `fmin` from `scipy.optimize`. 
    `_filtfilt_gust` is significantly faster than this implementation. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">filtfilt_gust_opt_func</span><span class="s2">(</span><span class="s1">ics</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Objective function used in filtfilt_gust_opt.&quot;&quot;&quot;</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)) - </span><span class="s3">1</span>
        <span class="s1">z0f </span><span class="s2">= </span><span class="s1">ics</span><span class="s2">[:</span><span class="s1">m</span><span class="s2">]</span>
        <span class="s1">z0b </span><span class="s2">= </span><span class="s1">ics</span><span class="s2">[</span><span class="s1">m</span><span class="s2">:]</span>
        <span class="s1">y_f </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0f</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">y_fb </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">y_f</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0b</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">][::-</span><span class="s3">1</span><span class="s2">]</span>

        <span class="s1">y_b </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0b</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">][::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">y_bf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">y_b</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0f</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">y_fb </span><span class="s2">- </span><span class="s1">y_bf</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s1">m </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)) - </span><span class="s3">1</span>
    <span class="s1">zi </span><span class="s2">= </span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">ics </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">x</span><span class="s2">[:</span><span class="s1">m</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">()*</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[-</span><span class="s1">m</span><span class="s2">:].</span><span class="s1">mean</span><span class="s2">()*</span><span class="s1">zi</span><span class="s2">))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">fmin</span><span class="s2">(</span><span class="s1">filtfilt_gust_opt_func</span><span class="s2">, </span><span class="s1">ics</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">),</span>
                  <span class="s1">xtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">ftol</span><span class="s2">=</span><span class="s3">1e-12</span><span class="s2">,</span>
                  <span class="s1">maxfun</span><span class="s2">=</span><span class="s3">10000</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">10000</span><span class="s2">,</span>
                  <span class="s1">full_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">disp</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">opt</span><span class="s2">, </span><span class="s1">fopt</span><span class="s2">, </span><span class="s1">niter</span><span class="s2">, </span><span class="s1">funcalls</span><span class="s2">, </span><span class="s1">warnflag </span><span class="s2">= </span><span class="s1">result</span>
    <span class="s0">if </span><span class="s1">warnflag </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;minimization failed in filtfilt_gust_opt: &quot;</span>
                           <span class="s4">&quot;warnflag=%d&quot; </span><span class="s2">% </span><span class="s1">warnflag</span><span class="s2">)</span>
    <span class="s1">z0f </span><span class="s2">= </span><span class="s1">opt</span><span class="s2">[:</span><span class="s1">m</span><span class="s2">]</span>
    <span class="s1">z0b </span><span class="s2">= </span><span class="s1">opt</span><span class="s2">[</span><span class="s1">m</span><span class="s2">:]</span>

    <span class="s5"># Apply the forward-backward filter using the computed initial</span>
    <span class="s5"># conditions.</span>
    <span class="s1">y_b </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0b</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">][::-</span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">y_b</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0f</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>

    <span class="s0">return </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z0f</span><span class="s2">, </span><span class="s1">z0b</span>


<span class="s0">def </span><span class="s1">check_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5"># Generate x, the data to be filtered.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">123</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">)</span>

    <span class="s5"># Apply filtfilt to x. This is the main calculation to be checked.</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">filtfilt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;gust&quot;</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">=</span><span class="s1">irlen</span><span class="s2">)</span>

    <span class="s5"># Also call the private function so we can test the ICs.</span>
    <span class="s1">yg</span><span class="s2">, </span><span class="s1">zg1</span><span class="s2">, </span><span class="s1">zg2 </span><span class="s2">= </span><span class="s1">_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">=</span><span class="s1">irlen</span><span class="s2">)</span>

    <span class="s5"># filtfilt_gust_opt is an independent implementation that gives the</span>
    <span class="s5"># expected result, but it only handles 1-D arrays, so use some looping</span>
    <span class="s5"># and reshaping shenanigans to create the expected output arrays.</span>
    <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">out_shape </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">yo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty_like</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">)</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)) - </span><span class="s3">1</span>
    <span class="s1">zo1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">out_shape </span><span class="s2">+ (</span><span class="s1">m</span><span class="s2">,))</span>
    <span class="s1">zo2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">out_shape </span><span class="s2">+ (</span><span class="s1">m</span><span class="s2">,))</span>
    <span class="s0">for </span><span class="s1">indx </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(*[</span><span class="s1">range</span><span class="s2">(</span><span class="s1">d</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">out_shape</span><span class="s2">]):</span>
        <span class="s1">yo</span><span class="s2">[</span><span class="s1">indx</span><span class="s2">], </span><span class="s1">zo1</span><span class="s2">[</span><span class="s1">indx</span><span class="s2">], </span><span class="s1">zo2</span><span class="s2">[</span><span class="s1">indx</span><span class="s2">] = </span><span class="s1">filtfilt_gust_opt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">xx</span><span class="s2">[</span><span class="s1">indx</span><span class="s2">])</span>
    <span class="s1">yo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">yo</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">zo1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">zo1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">zo2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">zo2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yg</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zg1</span><span class="s2">, </span><span class="s1">zo1</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zg2</span><span class="s2">, </span><span class="s1">zo2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-9</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_choose_conv_method</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'valid'</span><span class="s2">, </span><span class="s4">'same'</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">]:</span>
        <span class="s0">for </span><span class="s1">ndim </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]:</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">true_method </span><span class="s2">= </span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s4">'direct'</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(*((</span><span class="s1">n</span><span class="s2">,) * </span><span class="s1">ndim</span><span class="s2">))</span>
            <span class="s1">h </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(*((</span><span class="s1">k</span><span class="s2">,) * </span><span class="s1">ndim</span><span class="s2">))</span>

            <span class="s1">method </span><span class="s2">= </span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">true_method</span><span class="s2">)</span>

            <span class="s1">method_try</span><span class="s2">, </span><span class="s1">times </span><span class="s2">= </span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">, </span><span class="s1">measure</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">method_try </span><span class="s0">in </span><span class="s2">{</span><span class="s4">'fft'</span><span class="s2">, </span><span class="s4">'direct'</span><span class="s2">})</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">times</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s4">'fft' </span><span class="s0">in </span><span class="s1">times</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">() </span><span class="s0">and </span><span class="s4">'direct' </span><span class="s0">in </span><span class="s1">times</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

        <span class="s1">n </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s0">for </span><span class="s1">not_fft_conv_supp </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;complex256&quot;</span><span class="s2">, </span><span class="s4">&quot;complex192&quot;</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s1">not_fft_conv_supp</span><span class="s2">):</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">not_fft_conv_supp</span><span class="s2">)</span>
                <span class="s1">h </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">), </span><span class="s4">'direct'</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s3">51</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">), </span><span class="s4">'direct'</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)]</span>
        <span class="s1">h </span><span class="s2">= [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">choose_conv_method</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">), </span><span class="s4">'direct'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_filtfilt_gust</span><span class="s2">():</span>
    <span class="s5"># Design a filter.</span>
    <span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">ellip</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">120</span><span class="s2">, </span><span class="s3">0.0875</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">)</span>

    <span class="s5"># Find the approximate impulse response length of the filter.</span>
    <span class="s1">eps </span><span class="s2">= </span><span class="s3">1e-10</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">p</span><span class="s2">))</span>
    <span class="s1">approx_impulse_len </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">eps</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">r</span><span class="s2">)))</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">123</span><span class="s2">)</span>

    <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">zpk2tf</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">irlen </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">approx_impulse_len</span><span class="s2">]:</span>
        <span class="s1">signal_len </span><span class="s2">= </span><span class="s3">5 </span><span class="s2">* </span><span class="s1">approx_impulse_len</span>

        <span class="s5"># 1-d test case</span>
        <span class="s1">check_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, (</span><span class="s1">signal_len</span><span class="s2">,), </span><span class="s3">0</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">)</span>

        <span class="s5"># 3-d test case; test each axis.</span>
        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
            <span class="s1">shape </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
            <span class="s1">shape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s1">signal_len</span>
            <span class="s1">check_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">irlen</span><span class="s2">)</span>

    <span class="s5"># Test case with length less than 2*approx_impulse_len.</span>
    <span class="s5"># In this case, `filtfilt_gust` should behave the same as if</span>
    <span class="s5"># `irlen=None` was given.</span>
    <span class="s1">length </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">approx_impulse_len </span><span class="s2">- </span><span class="s3">50</span>
    <span class="s1">check_filtfilt_gust</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, (</span><span class="s1">length</span><span class="s2">,), </span><span class="s3">0</span><span class="s2">, </span><span class="s1">approx_impulse_len</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDecimate</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_bad_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">q</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">q</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s4">'iir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">round</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_basic_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s4">'fir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">round</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for ticket #1480.</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">30</span><span class="s2">, </span><span class="s3">30</span><span class="s2">))</span>
        <span class="s1">d0 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d0</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">15</span><span class="s2">, </span><span class="s3">30</span><span class="s2">))</span>
        <span class="s1">d1 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">30</span><span class="s2">, </span><span class="s3">15</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_phaseshift_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">BadCoefficients</span><span class="s2">, </span><span class="s4">&quot;Badly conditioned filter&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_phaseshift</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_phase_FIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">BadCoefficients</span><span class="s2">, </span><span class="s4">&quot;Badly conditioned filter&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_phaseshift</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s4">'fir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_phaseshift_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_phaseshift</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s4">'iir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_phase_IIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_phaseshift</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s4">'iir'</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_phaseshift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">):</span>
        <span class="s1">rate </span><span class="s2">= </span><span class="s3">120</span>
        <span class="s1">rates_to </span><span class="s2">= [</span><span class="s3">15</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s3">40</span><span class="s2">]  </span><span class="s5"># q = 8, 6, 4, 3</span>

        <span class="s1">t_tot </span><span class="s2">= </span><span class="s3">100  </span><span class="s5"># Need to let antialiasing filters settle</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">*</span><span class="s1">t_tot</span><span class="s2">+</span><span class="s3">1</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">)</span>

        <span class="s5"># Sinusoids at 0.8*nyquist, windowed to avoid edge artifacts</span>
        <span class="s1">freqs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">rates_to</span><span class="s2">) * </span><span class="s3">0.8 </span><span class="s2">/ </span><span class="s3">2</span>
        <span class="s1">d </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">1j </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">freqs</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">] * </span><span class="s1">t</span><span class="s2">)</span>
             <span class="s2">* </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">windows</span><span class="s2">.</span><span class="s1">tukey</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">rate_to </span><span class="s0">in </span><span class="s1">rates_to</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">rate </span><span class="s2">// </span><span class="s1">rate_to</span>
            <span class="s1">t_to </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">*</span><span class="s1">t_tot</span><span class="s2">+</span><span class="s3">1</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">rate_to</span><span class="s2">)</span>
            <span class="s1">d_tos </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">1j </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">freqs</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">] * </span><span class="s1">t_to</span><span class="s2">)</span>
                     <span class="s2">* </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">windows</span><span class="s2">.</span><span class="s1">tukey</span><span class="s2">(</span><span class="s1">t_to</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">))</span>

            <span class="s5"># Set up downsampling filters, match v0.17 defaults</span>
            <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'fir'</span><span class="s2">:</span>
                <span class="s1">n </span><span class="s2">= </span><span class="s3">30</span>
                <span class="s1">system </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">dlti</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">firwin</span><span class="s2">(</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1. </span><span class="s2">/ </span><span class="s1">q</span><span class="s2">,</span>
                                                   <span class="s1">window</span><span class="s2">=</span><span class="s4">'hamming'</span><span class="s2">), </span><span class="s3">1.</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'iir'</span><span class="s2">:</span>
                <span class="s1">n </span><span class="s2">= </span><span class="s3">8</span>
                <span class="s1">wc </span><span class="s2">= </span><span class="s3">0.8</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s1">q</span>
                <span class="s1">system </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">dlti</span><span class="s2">(*</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">cheby1</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">wc</span><span class="s2">/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">))</span>

            <span class="s5"># Calculate expected phase response, as unit complex vector</span>
            <span class="s0">if </span><span class="s1">zero_phase </span><span class="s0">is False</span><span class="s2">:</span>
                <span class="s1">_</span><span class="s2">, </span><span class="s1">h_resps </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">freqz</span><span class="s2">(</span><span class="s1">system</span><span class="s2">.</span><span class="s1">num</span><span class="s2">, </span><span class="s1">system</span><span class="s2">.</span><span class="s1">den</span><span class="s2">,</span>
                                          <span class="s1">freqs</span><span class="s2">/</span><span class="s1">rate</span><span class="s2">*</span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
                <span class="s1">h_resps </span><span class="s2">/= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">h_resps</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">h_resps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">freqs</span><span class="s2">)</span>

            <span class="s1">y_resamps </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s1">system</span><span class="s2">,</span>
                                        <span class="s1">zero_phase</span><span class="s2">=</span><span class="s1">zero_phase</span><span class="s2">)</span>

            <span class="s5"># Get phase from complex inner product, like CSD</span>
            <span class="s1">h_resamps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">d_tos</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">() * </span><span class="s1">y_resamps</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">h_resamps </span><span class="s2">/= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">h_resamps</span><span class="s2">)</span>
            <span class="s1">subnyq </span><span class="s2">= </span><span class="s1">freqs </span><span class="s2">&lt; </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">rate_to</span>

            <span class="s5"># Complex vectors should be aligned, only compare below nyquist</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">angle</span><span class="s2">(</span><span class="s1">h_resps</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">()*</span><span class="s1">h_resamps</span><span class="s2">)[</span><span class="s1">subnyq</span><span class="s2">], </span><span class="s3">0</span><span class="s2">,</span>
                            <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_auto_n</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test that our value of n is a reasonable choice (depends on</span>
        <span class="s5"># the downsampling factor)</span>
        <span class="s1">sfreq </span><span class="s2">= </span><span class="s3">100.</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s3">1000</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) / </span><span class="s1">sfreq</span>
        <span class="s5"># will alias for decimations (&gt;= 15)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2. </span><span class="s2">/ </span><span class="s1">n</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* (</span><span class="s1">sfreq </span><span class="s2">/ </span><span class="s3">30.</span><span class="s2">) * </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
        <span class="s1">x_out </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s4">'fir'</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x_out</span><span class="s2">), </span><span class="s3">0.01</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_long_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># regression: gh-15072.  With 32-bit float and either lfilter</span>
        <span class="s5"># or filtfilt, this is numerically unstable</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10_000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">any</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_float16_upcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># float16 must be upcast to float64</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>

    <span class="s0">def </span><span class="s1">test_complex_iir_dlti</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># regression: gh-17845</span>
        <span class="s5"># centre frequency for filter [Hz]</span>
        <span class="s1">fcentre </span><span class="s2">= </span><span class="s3">50</span>
        <span class="s5"># filter passband width [Hz]</span>
        <span class="s1">fwidth </span><span class="s2">= </span><span class="s3">5</span>
        <span class="s5"># sample rate [Hz]</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s3">1e3</span>

        <span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">*</span><span class="s1">fwidth</span><span class="s2">/</span><span class="s3">2</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">, </span><span class="s1">fs</span><span class="s2">=</span><span class="s1">fs</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">z</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre</span><span class="s2">/</span><span class="s1">fs</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">p</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre</span><span class="s2">/</span><span class="s1">fs</span><span class="s2">)</span>
        <span class="s1">system </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">dlti</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">200</span><span class="s2">) / </span><span class="s1">fs</span>

        <span class="s5"># input</span>
        <span class="s1">u </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
             <span class="s2">+ </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre </span><span class="s2">* </span><span class="s1">t</span><span class="s2">))</span>

        <span class="s1">ynzp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s1">system</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ynzpref </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">lfilter</span><span class="s2">(*</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">zpk2tf</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">),</span>
                                 <span class="s1">u</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">]</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ynzp</span><span class="s2">, </span><span class="s1">ynzpref</span><span class="s2">)</span>

        <span class="s1">yzp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s1">system</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">yzpref </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">filtfilt</span><span class="s2">(*</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">zpk2tf</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">),</span>
                                 <span class="s1">u</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">]</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yzp</span><span class="s2">, </span><span class="s1">yzpref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_fir_dlti</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># centre frequency for filter [Hz]</span>
        <span class="s1">fcentre </span><span class="s2">= </span><span class="s3">50</span>
        <span class="s5"># filter passband width [Hz]</span>
        <span class="s1">fwidth </span><span class="s2">= </span><span class="s3">5</span>
        <span class="s5"># sample rate [Hz]</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s3">1e3</span>
        <span class="s1">numtaps </span><span class="s2">= </span><span class="s3">20</span>

        <span class="s5"># FIR filter about 0Hz</span>
        <span class="s1">bbase </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">firwin</span><span class="s2">(</span><span class="s1">numtaps</span><span class="s2">, </span><span class="s1">fwidth</span><span class="s2">/</span><span class="s3">2</span><span class="s2">, </span><span class="s1">fs</span><span class="s2">=</span><span class="s1">fs</span><span class="s2">)</span>

        <span class="s5"># rotate these to desired frequency</span>
        <span class="s1">zbase </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">roots</span><span class="s2">(</span><span class="s1">bbase</span><span class="s2">)</span>
        <span class="s1">zrot </span><span class="s2">= </span><span class="s1">zbase </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre</span><span class="s2">/</span><span class="s1">fs</span><span class="s2">)</span>
        <span class="s5"># FIR filter about 50Hz, maintaining passband gain of 0dB</span>
        <span class="s1">bz </span><span class="s2">= </span><span class="s1">bbase</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">(</span><span class="s1">zrot</span><span class="s2">)</span>

        <span class="s1">system </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">dlti</span><span class="s2">(</span><span class="s1">bz</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">200</span><span class="s2">) / </span><span class="s1">fs</span>

        <span class="s5"># input</span>
        <span class="s1">u </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
             <span class="s2">+ </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s3">2j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">fcentre </span><span class="s2">* </span><span class="s1">t</span><span class="s2">))</span>

        <span class="s1">ynzp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s1">system</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ynzpref </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">upfirdn</span><span class="s2">(</span><span class="s1">bz</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">up</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">down</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)[:</span><span class="s3">100</span><span class="s2">]</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ynzp</span><span class="s2">, </span><span class="s1">ynzpref</span><span class="s2">)</span>

        <span class="s1">yzp </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">decimate</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">=</span><span class="s1">system</span><span class="s2">, </span><span class="s1">zero_phase</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">yzpref </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">resample_poly</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s1">bz</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">yzp</span><span class="s2">, </span><span class="s1">yzpref</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestHilbert</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_bad_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">0.0j</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">8.0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_hilbert_theoretical</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test cases by Ariel Rokem</span>
        <span class="s1">decimal </span><span class="s2">= </span><span class="s3">14</span>

        <span class="s1">pi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">pi</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">256</span><span class="s2">)</span>
        <span class="s1">a0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">a2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">a3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">, </span><span class="s1">a3</span><span class="s2">])</span>

        <span class="s1">h </span><span class="s2">= </span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">h_abs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">h</span><span class="s2">)</span>
        <span class="s1">h_angle </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">angle</span><span class="s2">(</span><span class="s1">h</span><span class="s2">)</span>
        <span class="s1">h_real </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">real</span><span class="s2">(</span><span class="s1">h</span><span class="s2">)</span>

        <span class="s5"># The real part should be equal to the original signals:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">h_real</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">)</span>
        <span class="s5"># The absolute value should be one everywhere, for this input:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">h_abs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">)</span>
        <span class="s5"># For the 'slow' sine - the phase should go from -pi/2 to pi/2 in</span>
        <span class="s5"># the first 256 bins:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">h_angle</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, :</span><span class="s3">256</span><span class="s2">],</span>
                            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">256</span><span class="s2">),</span>
                            <span class="s1">decimal</span><span class="s2">)</span>
        <span class="s5"># For the 'slow' cosine - the phase should go from 0 to pi in the</span>
        <span class="s5"># same interval:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">h_angle</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, :</span><span class="s3">256</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">pi</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">256</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">)</span>
        <span class="s5"># The 'fast' sine should make this phase transition in half the time:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">h_angle</span><span class="s2">[</span><span class="s3">2</span><span class="s2">, :</span><span class="s3">128</span><span class="s2">],</span>
                            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">128</span><span class="s2">),</span>
                            <span class="s1">decimal</span><span class="s2">)</span>
        <span class="s5"># Ditto for the 'fast' cosine:</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">h_angle</span><span class="s2">[</span><span class="s3">3</span><span class="s2">, :</span><span class="s3">128</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">pi</span><span class="s2">, </span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">128</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">)</span>

        <span class="s5"># The imaginary part of hilbert(cos(t)) = sin(t) Wikipedia</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">a0</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_hilbert_axisN</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># tests for axis and N arguments</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">18</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s5"># test axis</span>
        <span class="s1">aa </span><span class="s2">= </span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">), </span><span class="s1">aa</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>
        <span class="s5"># test 1d</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">aa</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">14</span><span class="s2">)</span>

        <span class="s5"># test N</span>
        <span class="s1">aan </span><span class="s2">= </span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=</span><span class="s3">20</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">aan</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">20</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=</span><span class="s3">20</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">, [</span><span class="s3">20</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s5"># the next test is just a regression test,</span>
        <span class="s5"># no idea whether numbers make sense</span>
        <span class="s1">a0hilb </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.000000000000000e+00 </span><span class="s2">- </span><span class="s3">1.72015830311905j</span><span class="s2">,</span>
                           <span class="s3">1.000000000000000e+00 </span><span class="s2">- </span><span class="s3">2.047794505137069j</span><span class="s2">,</span>
                           <span class="s3">1.999999999999999e+00 </span><span class="s2">- </span><span class="s3">2.244055555687583j</span><span class="s2">,</span>
                           <span class="s3">3.000000000000000e+00 </span><span class="s2">- </span><span class="s3">1.262750302935009j</span><span class="s2">,</span>
                           <span class="s3">4.000000000000000e+00 </span><span class="s2">- </span><span class="s3">1.066489252384493j</span><span class="s2">,</span>
                           <span class="s3">5.000000000000000e+00 </span><span class="s2">+ </span><span class="s3">2.918022706971047j</span><span class="s2">,</span>
                           <span class="s3">8.881784197001253e-17 </span><span class="s2">+ </span><span class="s3">3.845658908989067j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">9.444121133484362e-17 </span><span class="s2">+ </span><span class="s3">0.985044202202061j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">1.776356839400251e-16 </span><span class="s2">+ </span><span class="s3">1.332257797702019j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">3.996802888650564e-16 </span><span class="s2">+ </span><span class="s3">0.501905089898885j</span><span class="s2">,</span>
                           <span class="s3">1.332267629550188e-16 </span><span class="s2">+ </span><span class="s3">0.668696078880782j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">1.192678053963799e-16 </span><span class="s2">+ </span><span class="s3">0.235487067862679j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">1.776356839400251e-16 </span><span class="s2">+ </span><span class="s3">0.286439612812121j</span><span class="s2">,</span>
                           <span class="s3">3.108624468950438e-16 </span><span class="s2">+ </span><span class="s3">0.031676888064907j</span><span class="s2">,</span>
                           <span class="s3">1.332267629550188e-16 </span><span class="s2">- </span><span class="s3">0.019275656884536j</span><span class="s2">,</span>
                          <span class="s2">-</span><span class="s3">2.360035624836702e-16 </span><span class="s2">- </span><span class="s3">0.1652588660287j</span><span class="s2">,</span>
                           <span class="s3">0.000000000000000e+00 </span><span class="s2">- </span><span class="s3">0.332049855010597j</span><span class="s2">,</span>
                           <span class="s3">3.552713678800501e-16 </span><span class="s2">- </span><span class="s3">0.403810179797771j</span><span class="s2">,</span>
                           <span class="s3">8.881784197001253e-17 </span><span class="s2">- </span><span class="s3">0.751023775297729j</span><span class="s2">,</span>
                           <span class="s3">9.444121133484362e-17 </span><span class="s2">- </span><span class="s3">0.79252210110103j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">aan</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a0hilb</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s4">'N regression'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_hilbert_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">in_typed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">real</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">hilbert</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">)).</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestHilbert2</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_bad_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># x must be real.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">0.0j</span><span class="s2">]])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s5"># x must be rank 2.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s5"># Bad value for N.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">16</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">hilbert2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">,))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_hilbert2_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">in_typed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">32</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">real</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">hilbert2</span><span class="s2">(</span><span class="s1">in_typed</span><span class="s2">)).</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPartialFractionExpansion</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">r_true</span><span class="s2">, </span><span class="s1">p_true</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">7</span><span class="s2">):</span>
        <span class="s1">r_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">r_true</span><span class="s2">)</span>
        <span class="s1">p_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">p_true</span><span class="s2">)</span>

        <span class="s1">distance </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] - </span><span class="s1">p_true</span><span class="s2">),</span>
                            <span class="s1">abs</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] - </span><span class="s1">r_true</span><span class="s2">))</span>

        <span class="s1">rows</span><span class="s2">, </span><span class="s1">cols </span><span class="s2">= </span><span class="s1">linear_sum_assignment</span><span class="s2">(</span><span class="s1">distance</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[</span><span class="s1">rows</span><span class="s2">], </span><span class="s1">p_true</span><span class="s2">[</span><span class="s1">cols</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">decimal</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s1">rows</span><span class="s2">], </span><span class="s1">r_true</span><span class="s2">[</span><span class="s1">cols</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">decimal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_compute_factors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">factors</span><span class="s2">, </span><span class="s1">poly </span><span class="s2">= </span><span class="s1">_compute_factors</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">), </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">poly</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>

        <span class="s1">factors</span><span class="s2">, </span><span class="s1">poly </span><span class="s2">= </span><span class="s1">_compute_factors</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                                         <span class="s1">include_powers</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">), </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">factors</span><span class="s2">[</span><span class="s3">5</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">poly</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">poly</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_group_poles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">_group_poles</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.001</span><span class="s2">, </span><span class="s3">1.003</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.003</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], </span><span class="s3">0.1</span><span class="s2">, </span><span class="s4">'min'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_residue_general</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test are taken from issue #4464, note that poles in scipy are</span>
        <span class="s5"># in increasing by absolute value order, opposite to MATLAB.</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">1.3320</span><span class="s2">, -</span><span class="s3">0.6653</span><span class="s2">, -</span><span class="s3">1.4167</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">0.4093</span><span class="s2">, -</span><span class="s3">1.1644</span><span class="s2">, </span><span class="s3">1.5737</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [-</span><span class="s3">1.2500</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">8</span><span class="s2">, -</span><span class="s3">12</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3.4</span><span class="s2">, </span><span class="s3">1.98</span><span class="s2">, -</span><span class="s3">0.406</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">18.125 </span><span class="s2">- </span><span class="s3">13.125j</span><span class="s2">, -</span><span class="s3">18.125 </span><span class="s2">+ </span><span class="s3">13.125j</span><span class="s2">, </span><span class="s3">36.25</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">0.2j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">0.2j</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">0.88</span><span class="s2">, -</span><span class="s3">2.396</span><span class="s2">, </span><span class="s3">1.348</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">0.7</span><span class="s2">, -</span><span class="s3">0.14</span><span class="s2">, </span><span class="s3">0.048</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">0.2</span><span class="s2">, -</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0.25</span><span class="s2">, -</span><span class="s3">0.25</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">,</span>
                                    <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5j</span><span class="s2">, -</span><span class="s3">1.5j</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">13</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">7</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">11</span><span class="s2">, </span><span class="s3">69</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">23</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">3.5j</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">3.5j</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_residue_leading_zeros</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Leading zeros in numerator or denominator must not affect the answer.</span>
        <span class="s1">r0</span><span class="s2">, </span><span class="s1">p0</span><span class="s2">, </span><span class="s1">k0 </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">r1</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">, </span><span class="s1">k1 </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">r2</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">, </span><span class="s1">k2 </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">r3</span><span class="s2">, </span><span class="s1">p3</span><span class="s2">, </span><span class="s1">k3 </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_resiude_degenerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Several tests for zero numerator and denominator.</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residue</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Denominator `a` is zero.&quot;</span><span class="s2">):</span>
            <span class="s1">residue</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_residuez_general</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -(</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">), (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">), -</span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">+</span><span class="s3">2.5j</span><span class="s2">, </span><span class="s3">7.5</span><span class="s2">+</span><span class="s3">7.5j</span><span class="s2">, -</span><span class="s3">4.5</span><span class="s2">-</span><span class="s3">12j</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">2j</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.3561</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">,</span>
                                    <span class="s2">[-</span><span class="s3">0.9041 </span><span class="s2">- </span><span class="s3">5.9928j</span><span class="s2">, -</span><span class="s3">0.9041 </span><span class="s2">+ </span><span class="s3">5.9928j</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">0.3257j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">0.3257j</span><span class="s2">],</span>
                                    <span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">2.8082</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">1.5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">18</span><span class="s2">], [</span><span class="s3">18</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">,</span>
                                    <span class="s2">[</span><span class="s3">0.36</span><span class="s2">, </span><span class="s3">0.24</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">], [</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">polymul</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">/</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/</span><span class="s3">4</span><span class="s2">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">10</span><span class="s2">/</span><span class="s3">3</span><span class="s2">, </span><span class="s3">16</span><span class="s2">/</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">.125</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">10</span><span class="s2">, </span><span class="s3">9</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">8</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [-</span><span class="s3">24</span><span class="s2">, </span><span class="s3">15</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_rp_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">,</span>
                                    <span class="s2">[</span><span class="s3">0.2618 </span><span class="s2">+ </span><span class="s3">0.1902j</span><span class="s2">, </span><span class="s3">0.2618 </span><span class="s2">- </span><span class="s3">0.1902j</span><span class="s2">,</span>
                                     <span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.0382 </span><span class="s2">- </span><span class="s3">0.1176j</span><span class="s2">, </span><span class="s3">0.0382 </span><span class="s2">+ </span><span class="s3">0.1176j</span><span class="s2">],</span>
                                    <span class="s2">[-</span><span class="s3">0.8090 </span><span class="s2">+ </span><span class="s3">0.5878j</span><span class="s2">, -</span><span class="s3">0.8090 </span><span class="s2">- </span><span class="s3">0.5878j</span><span class="s2">,</span>
                                     <span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.3090 </span><span class="s2">+ </span><span class="s3">0.9511j</span><span class="s2">, </span><span class="s3">0.3090 </span><span class="s2">- </span><span class="s3">0.9511j</span><span class="s2">],</span>
                                    <span class="s1">decimal</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_residuez_trailing_zeros</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Trailing zeros in numerator or denominator must not affect the</span>
        <span class="s5"># answer.</span>
        <span class="s1">r0</span><span class="s2">, </span><span class="s1">p0</span><span class="s2">, </span><span class="s1">k0 </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">r1</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">, </span><span class="s1">k1 </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">r2</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">, </span><span class="s1">k2 </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">r3</span><span class="s2">, </span><span class="s1">p3</span><span class="s2">, </span><span class="s1">k3 </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r0</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">p3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">k0</span><span class="s2">, </span><span class="s1">k3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_residuez_degenerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">residuez</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Denominator `a` is zero.&quot;</span><span class="s2">):</span>
            <span class="s1">residuez</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                           <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;First coefficient of determinant `a` must &quot;</span>
                                 <span class="s4">&quot;be non-zero.&quot;</span><span class="s2">):</span>
            <span class="s1">residuez</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inverse_unique_roots_different_rtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This test was inspired by github issue 2496.</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s3">3 </span><span class="s2">/ </span><span class="s3">10</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">/ </span><span class="s3">6</span><span class="s2">, -</span><span class="s3">2 </span><span class="s2">/ </span><span class="s3">15</span><span class="s2">]</span>
        <span class="s1">p </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= []</span>
        <span class="s1">b_expected </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">a_expected </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>

        <span class="s5"># With the default tolerance, the rtype does not matter</span>
        <span class="s5"># for this example.</span>
        <span class="s0">for </span><span class="s1">rtype </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'avg'</span><span class="s2">, </span><span class="s4">'mean'</span><span class="s2">, </span><span class="s4">'min'</span><span class="s2">, </span><span class="s4">'minimum'</span><span class="s2">, </span><span class="s4">'max'</span><span class="s2">, </span><span class="s4">'maximum'</span><span class="s2">):</span>
            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s1">rtype</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b_expected</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_expected</span><span class="s2">)</span>

            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s1">rtype</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b_expected</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inverse_repeated_roots_different_rtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s3">3 </span><span class="s2">/ </span><span class="s3">20</span><span class="s2">, -</span><span class="s3">7 </span><span class="s2">/ </span><span class="s3">36</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">/ </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">/ </span><span class="s3">45</span><span class="s2">]</span>
        <span class="s1">p </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= []</span>
        <span class="s1">b_expected </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">b_expected_z </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">/</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">/</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">/</span><span class="s3">6</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">a_expected </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">24</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">rtype </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'avg'</span><span class="s2">, </span><span class="s4">'mean'</span><span class="s2">, </span><span class="s4">'min'</span><span class="s2">, </span><span class="s4">'minimum'</span><span class="s2">, </span><span class="s4">'max'</span><span class="s2">, </span><span class="s4">'maximum'</span><span class="s2">):</span>
            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s1">rtype</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_expected</span><span class="s2">)</span>

            <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s1">rtype</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b_expected_z</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inverse_bad_rtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s3">3 </span><span class="s2">/ </span><span class="s3">20</span><span class="s2">, -</span><span class="s3">7 </span><span class="s2">/ </span><span class="s3">36</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">/ </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">/ </span><span class="s3">45</span><span class="s2">]</span>
        <span class="s1">p </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= []</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;`rtype` must be one of&quot;</span><span class="s2">):</span>
            <span class="s1">invres</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'median'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;`rtype` must be one of&quot;</span><span class="s2">):</span>
            <span class="s1">invresz</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'median'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invresz_one_coefficient_bug</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Regression test for issue in gh-4646.</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">p </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_invres</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">3.5 </span><span class="s2">- </span><span class="s3">4j</span><span class="s2">, -</span><span class="s3">8.5 </span><span class="s2">+ </span><span class="s3">0.25j</span><span class="s2">, </span><span class="s3">3.5 </span><span class="s2">+ </span><span class="s3">3.25j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1.5j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">0.5j</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">- </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">10</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">4 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, -</span><span class="s3">28 </span><span class="s2">+ </span><span class="s3">16j</span><span class="s2">, </span><span class="s3">40 </span><span class="s2">- </span><span class="s3">62j</span><span class="s2">, </span><span class="s3">100 </span><span class="s2">+ </span><span class="s3">24j</span><span class="s2">,</span>
                                <span class="s2">-</span><span class="s3">292 </span><span class="s2">+ </span><span class="s3">219j</span><span class="s2">, </span><span class="s3">192 </span><span class="s2">- </span><span class="s3">268j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">12 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">53 </span><span class="s2">- </span><span class="s3">20j</span><span class="s2">, -</span><span class="s3">96 </span><span class="s2">+ </span><span class="s3">68j</span><span class="s2">, </span><span class="s3">27 </span><span class="s2">- </span><span class="s3">72j</span><span class="s2">,</span>
                                <span class="s3">108 </span><span class="s2">- </span><span class="s3">54j</span><span class="s2">, -</span><span class="s3">81 </span><span class="s2">+ </span><span class="s3">108j</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_invresz</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">([</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">3.5 </span><span class="s2">- </span><span class="s3">4j</span><span class="s2">, -</span><span class="s3">8.5 </span><span class="s2">+ </span><span class="s3">0.25j</span><span class="s2">, </span><span class="s3">3.5 </span><span class="s2">+ </span><span class="s3">3.25j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1.5j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s3">0.5j</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">- </span><span class="s3">2j</span><span class="s2">, -</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">, </span><span class="s3">12</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">],</span>
                       <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">50 </span><span class="s2">+ </span><span class="s3">11j</span><span class="s2">, </span><span class="s3">100 </span><span class="s2">- </span><span class="s3">72j</span><span class="s2">, </span><span class="s3">80 </span><span class="s2">+ </span><span class="s3">58j</span><span class="s2">,</span>
                                <span class="s2">-</span><span class="s3">354 </span><span class="s2">+ </span><span class="s3">228j</span><span class="s2">, </span><span class="s3">234 </span><span class="s2">- </span><span class="s3">297j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">12 </span><span class="s2">+ </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">53 </span><span class="s2">- </span><span class="s3">20j</span><span class="s2">, -</span><span class="s3">96 </span><span class="s2">+ </span><span class="s3">68j</span><span class="s2">, </span><span class="s3">27 </span><span class="s2">- </span><span class="s3">72j</span><span class="s2">,</span>
                                <span class="s3">108 </span><span class="s2">- </span><span class="s3">54j</span><span class="s2">, -</span><span class="s3">81 </span><span class="s2">+ </span><span class="s3">108j</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inverse_scalar_arguments</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invres</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">invresz</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestVectorstrength</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_single_1dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.5</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">5.</span>
        <span class="s1">targ_strength </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s3">.1</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_2dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.5</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">]</span>
        <span class="s1">targ_strength </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">] * </span><span class="s3">3</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.1</span><span class="s2">])</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_1dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">2</span>
        <span class="s1">targ_strength </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s3">.125</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_2dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, ]</span>
        <span class="s1">targ_strength </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">] * </span><span class="s3">2</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.125</span><span class="s2">])</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_spaced_1dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">, </span><span class="s3">4.1</span><span class="s2">, </span><span class="s3">10.1</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">targ_strength </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s3">.1</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_spaced_2dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">, </span><span class="s3">4.1</span><span class="s2">, </span><span class="s3">10.1</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">]</span>
        <span class="s1">targ_strength </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">] * </span><span class="s3">2</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.1</span><span class="s2">, </span><span class="s3">.2</span><span class="s2">])</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_partial_1dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.75</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">targ_strength </span><span class="s2">= </span><span class="s3">1. </span><span class="s2">/ </span><span class="s3">3.</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s3">.5</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_partial_2dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.75</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]</span>
        <span class="s1">targ_strength </span><span class="s2">= [</span><span class="s3">1. </span><span class="s2">/ </span><span class="s3">3.</span><span class="s2">] * </span><span class="s3">4</span>
        <span class="s1">targ_phase </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">])</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">targ_phase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_opposite_1dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.75</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">targ_strength </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_opposite_2dperiod</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.75</span><span class="s2">])</span>
        <span class="s1">period </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">] * </span><span class="s3">10</span>
        <span class="s1">targ_strength </span><span class="s2">= [</span><span class="s3">0.</span><span class="s2">] * </span><span class="s3">10</span>

        <span class="s1">strength</span><span class="s2">, </span><span class="s1">phase </span><span class="s2">= </span><span class="s1">vectorstrength</span><span class="s2">(</span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">phase</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">strength</span><span class="s2">, </span><span class="s1">targ_strength</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_events_ValueError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">vectorstrength</span><span class="s2">, </span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_period_ValueError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">vectorstrength</span><span class="s2">, </span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_period_ValueError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">period </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">vectorstrength</span><span class="s2">, </span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_period_ValueError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">events </span><span class="s2">= </span><span class="s3">1.</span>
        <span class="s1">period </span><span class="s2">= -</span><span class="s3">1</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">vectorstrength</span><span class="s2">, </span><span class="s1">events</span><span class="s2">, </span><span class="s1">period</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-7</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Wrap assert_allclose while casting object arrays.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">actual</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s4">'O'</span><span class="s2">:</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]).</span><span class="s1">dtype</span>
        <span class="s1">actual</span><span class="s2">, </span><span class="s1">desired </span><span class="s2">= </span><span class="s1">actual</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">desired</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'func'</span><span class="s2">, (</span><span class="s1">sosfilt</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_nonnumeric_dtypes</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">2</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)]</span>
    <span class="s1">b </span><span class="s2">= [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">2</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= [</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">2</span><span class="s2">), </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)]</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s4">'O'</span>
    <span class="s1">desired </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">func </span><span class="s0">is </span><span class="s1">sosfilt</span><span class="s2">:</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">([</span><span class="s1">b </span><span class="s2">+ </span><span class="s1">a</span><span class="s2">], </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">Decimal</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">actual</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">), </span><span class="s1">desired</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">))</span>
    <span class="s5"># Degenerate cases</span>
    <span class="s0">if </span><span class="s1">func </span><span class="s0">is </span><span class="s1">lfilter</span><span class="s2">:</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">)]</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'must be at least 1-D'</span><span class="s2">):</span>
        <span class="s1">func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s3">1.</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dt'</span><span class="s2">, </span><span class="s4">'fdFD'</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestSOSFilt</span><span class="s2">:</span>

    <span class="s5"># The test_rank* tests are pulled from _TestLinearFilter</span>
    <span class="s0">def </span><span class="s1">test_rank1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># Test simple IIR</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s1">x</span><span class="s2">), </span><span class="s1">y_r</span><span class="s2">)</span>

        <span class="s5"># Test simple FIR</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s5"># NOTE: This was changed (rel. to TestLinear...) to add a pole @zero:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y_r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s1">x</span><span class="s2">), </span><span class="s1">y_r</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">a </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">sos</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_rank2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r2_a0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]],</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y_r2_a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">12</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s3">18</span><span class="s2">, -</span><span class="s3">16</span><span class="s2">, </span><span class="s3">18</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_r2_a1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># Test last axis</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">tf2sos</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
                <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">], </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_initial_conditions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">b1</span><span class="s2">, </span><span class="s1">a1 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s4">'low'</span><span class="s2">)</span>
        <span class="s1">b2</span><span class="s2">, </span><span class="s1">a2 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s4">'low'</span><span class="s2">)</span>
        <span class="s1">b3</span><span class="s2">, </span><span class="s1">a3 </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s4">'low'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">), </span><span class="s1">b3</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">), </span><span class="s1">a3</span><span class="s2">)</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">b1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">b2</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">b3</span><span class="s2">, </span><span class="s1">a3</span><span class="s2">]))</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">50</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># Stopping filtering and continuing</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">zi </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[:</span><span class="s3">20</span><span class="s2">], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">6</span><span class="s2">))</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[</span><span class="s3">20</span><span class="s2">:], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]]</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>

        <span class="s1">y_sos</span><span class="s2">, </span><span class="s1">zi </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[:</span><span class="s3">20</span><span class="s2">], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)))</span>
        <span class="s1">y_sos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">y_sos</span><span class="s2">, </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[</span><span class="s3">20</span><span class="s2">:], </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]]</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_sos</span><span class="s2">)</span>

        <span class="s5"># Use a step function</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">sosfilt_zi</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>

        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">)</span>

        <span class="s5"># Initial condition shape matching</span>
        <span class="s1">x</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">) + </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape  </span><span class="s5"># 3D</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">sosfilt</span><span class="s2">, </span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">zi_nd </span><span class="s2">= </span><span class="s1">zi</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">zi_nd</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s1">zi</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">sosfilt</span><span class="s2">, </span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">,</span>
                      <span class="s1">zi</span><span class="s2">=</span><span class="s1">zi_nd</span><span class="s2">[:, :, :, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi_nd</span><span class="s2">)</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, :], </span><span class="s1">zi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_initial_conditions_3d_axis1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s5"># Test the use of zi when sosfilt is applied to axis 1 of a 3-d input.</span>

        <span class="s5"># Input array is x.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">159</span><span class="s2">).</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s5"># Design a filter in ZPK format and convert to SOS</span>
        <span class="s1">zpk </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0.35</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'zpk'</span><span class="s2">)</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">zpk2sos</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
        <span class="s1">nsections </span><span class="s2">= </span><span class="s1">sos</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>

        <span class="s5"># Filter along this axis.</span>
        <span class="s1">axis </span><span class="s2">= </span><span class="s3">1</span>

        <span class="s5"># Initial conditions, all zeros.</span>
        <span class="s1">shp </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">shp</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s3">2</span>
        <span class="s1">shp </span><span class="s2">= [</span><span class="s1">nsections</span><span class="s2">] + </span><span class="s1">shp</span>
        <span class="s1">z0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shp</span><span class="s2">)</span>

        <span class="s5"># Apply the filter to x.</span>
        <span class="s1">yf</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0</span><span class="s2">)</span>

        <span class="s5"># Apply the filter to x in two stages.</span>
        <span class="s1">y1</span><span class="s2">, </span><span class="s1">z1 </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[:, :</span><span class="s3">5</span><span class="s2">, :], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z0</span><span class="s2">)</span>
        <span class="s1">y2</span><span class="s2">, </span><span class="s1">z2 </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[:, </span><span class="s3">5</span><span class="s2">:, :], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">z1</span><span class="s2">)</span>

        <span class="s5"># y should equal yf, and z2 should equal zf.</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">yf</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">, </span><span class="s1">zf</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>

        <span class="s5"># let's try the &quot;step&quot; initial condition</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">sosfilt_zi</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">)</span>
        <span class="s1">zi</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= [</span><span class="s1">nsections</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">zi </span><span class="s2">* </span><span class="s1">x</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">, :]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s5"># check it against the TF form</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">zpk2tf</span><span class="s2">(*</span><span class="s1">zpk</span><span class="s2">)</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">lfilter_zi</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">zi</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">zi </span><span class="s2">* </span><span class="s1">x</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">, :]</span>
        <span class="s1">y_tf </span><span class="s2">= </span><span class="s1">lfilter</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_tf</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_zi_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s5"># The shape of zi is checked before using any values in the</span>
        <span class="s5"># arguments, so np.empty is fine for creating the arguments.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">))</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))  </span><span class="s5"># Correct shape is (4, 3, 2, 3)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'should be all ones'</span><span class="s2">):</span>
            <span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">sos</span><span class="s2">[:, </span><span class="s3">3</span><span class="s2">] = </span><span class="s3">1.</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'Invalid zi shape'</span><span class="s2">):</span>
            <span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sosfilt_zi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">sos </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">butter</span><span class="s2">(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s4">'sos'</span><span class="s2">)</span>
        <span class="s1">zi </span><span class="s2">= </span><span class="s1">sosfilt_zi</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">)</span>

        <span class="s1">y</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">40</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">), </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">)</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>

        <span class="s5"># Expected steady state value of the step response of this filter:</span>
        <span class="s1">ss </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">[:, :</span><span class="s3">3</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">) / </span><span class="s1">sos</span><span class="s2">[:, </span><span class="s3">3</span><span class="s2">:].</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">ss</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>

        <span class="s5"># zi as array-like</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">zf </span><span class="s2">= </span><span class="s1">sosfilt</span><span class="s2">(</span><span class="s1">sos</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">40</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">), </span><span class="s1">zi</span><span class="s2">=</span><span class="s1">zi</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">())</span>
        <span class="s1">assert_allclose_cast</span><span class="s2">(</span><span class="s1">zf</span><span class="s2">, </span><span class="s1">zi</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-13</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDeconvolve</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># From docstring example</span>
        <span class="s1">original </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">impulse_response </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">recorded </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">recovered</span><span class="s2">, </span><span class="s1">remainder </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">deconvolve</span><span class="s2">(</span><span class="s1">recorded</span><span class="s2">, </span><span class="s1">impulse_response</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">recovered</span><span class="s2">, </span><span class="s1">original</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_n_dimensional_signal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">recorded </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]</span>
        <span class="s1">impulse_response </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;signal must be 1-D.&quot;</span><span class="s2">):</span>
            <span class="s1">quotient</span><span class="s2">, </span><span class="s1">remainder </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">deconvolve</span><span class="s2">(</span><span class="s1">recorded</span><span class="s2">, </span><span class="s1">impulse_response</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_n_dimensional_divisor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">recorded </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">impulse_response </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divisor must be 1-D.&quot;</span><span class="s2">):</span>
            <span class="s1">quotient</span><span class="s2">, </span><span class="s1">remainder </span><span class="s2">= </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">deconvolve</span><span class="s2">(</span><span class="s1">recorded</span><span class="s2">, </span><span class="s1">impulse_response</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDetrend</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">detrended </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">detrended_exact </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">detrended</span><span class="s2">, </span><span class="s1">detrended_exact</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.6</span><span class="s2">, </span><span class="s3">2.4</span><span class="s2">])</span>
        <span class="s1">copy_array </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">overwrite_data</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">inplace </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">overwrite_data</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">copy_array</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'kind'</span><span class="s2">, [</span><span class="s4">'linear'</span><span class="s2">, </span><span class="s4">'constant'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'axis'</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">*</span><span class="s3">6</span><span class="s2">*</span><span class="s3">7</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">)</span>
        <span class="s1">detrended </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">detrended</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s0">def </span><span class="s1">test_bp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">] + [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">]</span>
        <span class="s1">detrended </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">'linear'</span><span class="s2">, </span><span class="s1">bp</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">detrended</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>

        <span class="s5"># repeat with ndim &gt; 1 and axis</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)[</span><span class="s0">None</span><span class="s2">, :, </span><span class="s0">None</span><span class="s2">]</span>

        <span class="s1">detrended </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">&quot;linear&quot;</span><span class="s2">, </span><span class="s1">bp</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">detrended</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>

        <span class="s5"># breakpoint index &gt; shape[axis]: raises</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">detrend</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">&quot;linear&quot;</span><span class="s2">, </span><span class="s1">bp</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'bp'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]), [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_detrend_array_bp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bp</span><span class="s2">):</span>
        <span class="s5"># regression test for https://github.com/scipy/scipy/issues/18675</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">12345</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
       <span class="s5"># bp = np.array([0, 2])</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">detrend</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">bp</span><span class="s2">=</span><span class="s1">bp</span><span class="s2">)</span>
        <span class="s1">res_scipy_191 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.44089210e-16</span><span class="s2">, -</span><span class="s3">2.22044605e-16</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s3">1.11128506e-01</span><span class="s2">, -</span><span class="s3">1.69470553e-01</span><span class="s2">,  </span><span class="s3">1.14710683e-01</span><span class="s2">,  </span><span class="s3">6.35468419e-02</span><span class="s2">,</span>
            <span class="s3">3.53533144e-01</span><span class="s2">, -</span><span class="s3">3.67877935e-02</span><span class="s2">, -</span><span class="s3">2.00417675e-02</span><span class="s2">, -</span><span class="s3">1.94362049e-01</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">res_scipy_191</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUniqueRoots</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_real_no_repeat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">]</span>
        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_real_repeat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.95</span><span class="s2">, -</span><span class="s3">0.89</span><span class="s2">, -</span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">]</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'min'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.89</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'max'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [-</span><span class="s3">0.95</span><span class="s2">, -</span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'avg'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [-</span><span class="s3">0.975</span><span class="s2">, -</span><span class="s3">0.845</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.025</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_complex_no_repeat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= [-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0j</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">0.5j</span><span class="s2">, -</span><span class="s3">1.0 </span><span class="s2">- </span><span class="s3">1.0j</span><span class="s2">, </span><span class="s3">3.0 </span><span class="s2">+ </span><span class="s3">2.0j</span><span class="s2">]</span>
        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_complex_repeat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">0.05j</span><span class="s2">, -</span><span class="s3">0.95 </span><span class="s2">+ </span><span class="s3">0.15j</span><span class="s2">, -</span><span class="s3">0.90 </span><span class="s2">+ </span><span class="s3">0.15j</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">,</span>
             <span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">0.5j</span><span class="s2">, </span><span class="s3">0.45 </span><span class="s2">+ </span><span class="s3">0.55j</span><span class="s2">]</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'min'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.95 </span><span class="s2">+ </span><span class="s3">0.15j</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.45 </span><span class="s2">+ </span><span class="s3">0.55j</span><span class="s2">],</span>
                            <span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'max'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">,</span>
                            <span class="s2">[-</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">0.05j</span><span class="s2">, -</span><span class="s3">0.90 </span><span class="s2">+ </span><span class="s3">0.15j</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">+ </span><span class="s3">0.5j</span><span class="s2">],</span>
                            <span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">, </span><span class="s1">rtype</span><span class="s2">=</span><span class="s4">'avg'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">unique</span><span class="s2">, [-</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">0.025j</span><span class="s2">, -</span><span class="s3">0.925 </span><span class="s2">+ </span><span class="s3">0.15j</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.475 </span><span class="s2">+ </span><span class="s3">0.525j</span><span class="s2">],</span>
            <span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_gh_4915</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">roots</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">convolve</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">5</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)))</span>
        <span class="s1">true_roots </span><span class="s2">= [-(-</span><span class="s3">1</span><span class="s2">)**(</span><span class="s3">1</span><span class="s2">/</span><span class="s3">5</span><span class="s2">), (-</span><span class="s3">1</span><span class="s2">)**(</span><span class="s3">4</span><span class="s2">/</span><span class="s3">5</span><span class="s2">), -(-</span><span class="s3">1</span><span class="s2">)**(</span><span class="s3">3</span><span class="s2">/</span><span class="s3">5</span><span class="s2">), (-</span><span class="s3">1</span><span class="s2">)**(</span><span class="s3">2</span><span class="s2">/</span><span class="s3">5</span><span class="s2">)]</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">unique </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">)</span>

        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">), </span><span class="s1">true_roots</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">7</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_complex_roots_extra</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0j</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0j</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">2e-9</span><span class="s2">, </span><span class="s3">1e-9 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">], </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1e-9 </span><span class="s2">+ </span><span class="s3">1.0j</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_single_unique_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">100</span><span class="s2">) + </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s1">unique</span><span class="s2">, </span><span class="s1">multiplicity </span><span class="s2">= </span><span class="s1">unique_roots</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">unique</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">multiplicity</span><span class="s2">, [</span><span class="s3">100</span><span class="s2">])</span>
</pre>
</body>
</html>