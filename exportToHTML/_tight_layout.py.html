<html>
<head>
<title>_tight_layout.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_tight_layout.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Routines to adjust subplot params so that subplots are 
nicely fit in the figure. In doing so, only axis labels, tick labels, Axes 
titles and offsetboxes that are anchored to Axes are currently considered. 
 
Internally, this module assumes that the margins (left margin, etc.) which are 
differences between ``Axes.get_tightbbox`` and ``Axes.bbox`` are independent of 
Axes position. This may fail if ``Axes.adjustable`` is ``datalim`` as well as 
such cases as when left or right margin are affected by xlabel. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">import </span><span class="s1">matplotlib </span><span class="s2">as </span><span class="s1">mpl</span>
<span class="s2">from </span><span class="s1">matplotlib </span><span class="s2">import </span><span class="s1">_api</span><span class="s3">, </span><span class="s1">artist </span><span class="s2">as </span><span class="s1">martist</span>
<span class="s2">from </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">font_manager </span><span class="s2">import </span><span class="s1">FontProperties</span>
<span class="s2">from </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">transforms </span><span class="s2">import </span><span class="s1">Bbox</span>


<span class="s2">def </span><span class="s1">_auto_adjust_subplotpars</span><span class="s3">(</span>
        <span class="s1">fig</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">span_pairs</span><span class="s3">, </span><span class="s1">subplot_list</span><span class="s3">,</span>
        <span class="s1">ax_bbox_list</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">pad</span><span class="s3">=</span><span class="s4">1.08</span><span class="s3">, </span><span class="s1">h_pad</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">w_pad</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">rect</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Return a dict of subplot parameters to adjust spacing between subplots 
    or ``None`` if resulting Axes would have zero height or width. 
 
    Note that this function ignores geometry information of subplot itself, but 
    uses what is given by the *shape* and *subplot_list* parameters.  Also, the 
    results could be incorrect if some subplots have ``adjustable=datalim``. 
 
    Parameters 
    ---------- 
    shape : tuple[int, int] 
        Number of rows and columns of the grid. 
    span_pairs : list[tuple[slice, slice]] 
        List of rowspans and colspans occupied by each subplot. 
    subplot_list : list of subplots 
        List of subplots that will be used to calculate optimal subplot_params. 
    pad : float 
        Padding between the figure edge and the edges of subplots, as a 
        fraction of the font size. 
    h_pad, w_pad : float 
        Padding (height/width) between edges of adjacent subplots, as a 
        fraction of the font size.  Defaults to *pad*. 
    rect : tuple 
        (left, bottom, right, top), default: None. 
    &quot;&quot;&quot;</span>
    <span class="s1">rows</span><span class="s3">, </span><span class="s1">cols </span><span class="s3">= </span><span class="s1">shape</span>

    <span class="s1">font_size_inch </span><span class="s3">= (</span><span class="s1">FontProperties</span><span class="s3">(</span>
        <span class="s1">size</span><span class="s3">=</span><span class="s1">mpl</span><span class="s3">.</span><span class="s1">rcParams</span><span class="s3">[</span><span class="s5">&quot;font.size&quot;</span><span class="s3">]).</span><span class="s1">get_size_in_points</span><span class="s3">() / </span><span class="s4">72</span><span class="s3">)</span>
    <span class="s1">pad_inch </span><span class="s3">= </span><span class="s1">pad </span><span class="s3">* </span><span class="s1">font_size_inch</span>
    <span class="s1">vpad_inch </span><span class="s3">= </span><span class="s1">h_pad </span><span class="s3">* </span><span class="s1">font_size_inch </span><span class="s2">if </span><span class="s1">h_pad </span><span class="s2">is not None else </span><span class="s1">pad_inch</span>
    <span class="s1">hpad_inch </span><span class="s3">= </span><span class="s1">w_pad </span><span class="s3">* </span><span class="s1">font_size_inch </span><span class="s2">if </span><span class="s1">w_pad </span><span class="s2">is not None else </span><span class="s1">pad_inch</span>

    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">span_pairs</span><span class="s3">) != </span><span class="s1">len</span><span class="s3">(</span><span class="s1">subplot_list</span><span class="s3">) </span><span class="s2">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">subplot_list</span><span class="s3">) == </span><span class="s4">0</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span>

    <span class="s2">if </span><span class="s1">rect </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">margin_left </span><span class="s3">= </span><span class="s1">margin_bottom </span><span class="s3">= </span><span class="s1">margin_right </span><span class="s3">= </span><span class="s1">margin_top </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">margin_left</span><span class="s3">, </span><span class="s1">margin_bottom</span><span class="s3">, </span><span class="s1">_right</span><span class="s3">, </span><span class="s1">_top </span><span class="s3">= </span><span class="s1">rect</span>
        <span class="s1">margin_right </span><span class="s3">= </span><span class="s4">1 </span><span class="s3">- </span><span class="s1">_right </span><span class="s2">if </span><span class="s1">_right </span><span class="s2">else None</span>
        <span class="s1">margin_top </span><span class="s3">= </span><span class="s4">1 </span><span class="s3">- </span><span class="s1">_top </span><span class="s2">if </span><span class="s1">_top </span><span class="s2">else None</span>

    <span class="s1">vspaces </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">rows </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">, </span><span class="s1">cols</span><span class="s3">))</span>
    <span class="s1">hspaces </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">rows</span><span class="s3">, </span><span class="s1">cols </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">ax_bbox_list </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">ax_bbox_list </span><span class="s3">= [</span>
            <span class="s1">Bbox</span><span class="s3">.</span><span class="s1">union</span><span class="s3">([</span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_position</span><span class="s3">(</span><span class="s1">original</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">for </span><span class="s1">ax </span><span class="s2">in </span><span class="s1">subplots</span><span class="s3">])</span>
            <span class="s2">for </span><span class="s1">subplots </span><span class="s2">in </span><span class="s1">subplot_list</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">subplots</span><span class="s3">, </span><span class="s1">ax_bbox</span><span class="s3">, (</span><span class="s1">rowspan</span><span class="s3">, </span><span class="s1">colspan</span><span class="s3">) </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span>
            <span class="s1">subplot_list</span><span class="s3">, </span><span class="s1">ax_bbox_list</span><span class="s3">, </span><span class="s1">span_pairs</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">all</span><span class="s3">(</span><span class="s2">not </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_visible</span><span class="s3">() </span><span class="s2">for </span><span class="s1">ax </span><span class="s2">in </span><span class="s1">subplots</span><span class="s3">):</span>
            <span class="s2">continue</span>

        <span class="s1">bb </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">ax </span><span class="s2">in </span><span class="s1">subplots</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_visible</span><span class="s3">():</span>
                <span class="s1">bb </span><span class="s3">+= [</span><span class="s1">martist</span><span class="s3">.</span><span class="s1">_get_tightbbox_for_layout_only</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">)]</span>

        <span class="s1">tight_bbox_raw </span><span class="s3">= </span><span class="s1">Bbox</span><span class="s3">.</span><span class="s1">union</span><span class="s3">(</span><span class="s1">bb</span><span class="s3">)</span>
        <span class="s1">tight_bbox </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">transFigure</span><span class="s3">.</span><span class="s1">inverted</span><span class="s3">().</span><span class="s1">transform_bbox</span><span class="s3">(</span><span class="s1">tight_bbox_raw</span><span class="s3">)</span>

        <span class="s1">hspaces</span><span class="s3">[</span><span class="s1">rowspan</span><span class="s3">, </span><span class="s1">colspan</span><span class="s3">.</span><span class="s1">start</span><span class="s3">] += </span><span class="s1">ax_bbox</span><span class="s3">.</span><span class="s1">xmin </span><span class="s3">- </span><span class="s1">tight_bbox</span><span class="s3">.</span><span class="s1">xmin  </span><span class="s6"># l</span>
        <span class="s1">hspaces</span><span class="s3">[</span><span class="s1">rowspan</span><span class="s3">, </span><span class="s1">colspan</span><span class="s3">.</span><span class="s1">stop</span><span class="s3">] += </span><span class="s1">tight_bbox</span><span class="s3">.</span><span class="s1">xmax </span><span class="s3">- </span><span class="s1">ax_bbox</span><span class="s3">.</span><span class="s1">xmax  </span><span class="s6"># r</span>
        <span class="s1">vspaces</span><span class="s3">[</span><span class="s1">rowspan</span><span class="s3">.</span><span class="s1">start</span><span class="s3">, </span><span class="s1">colspan</span><span class="s3">] += </span><span class="s1">tight_bbox</span><span class="s3">.</span><span class="s1">ymax </span><span class="s3">- </span><span class="s1">ax_bbox</span><span class="s3">.</span><span class="s1">ymax  </span><span class="s6"># t</span>
        <span class="s1">vspaces</span><span class="s3">[</span><span class="s1">rowspan</span><span class="s3">.</span><span class="s1">stop</span><span class="s3">, </span><span class="s1">colspan</span><span class="s3">] += </span><span class="s1">ax_bbox</span><span class="s3">.</span><span class="s1">ymin </span><span class="s3">- </span><span class="s1">tight_bbox</span><span class="s3">.</span><span class="s1">ymin  </span><span class="s6"># b</span>

    <span class="s1">fig_width_inch</span><span class="s3">, </span><span class="s1">fig_height_inch </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">get_size_inches</span><span class="s3">()</span>

    <span class="s6"># margins can be negative for Axes with aspect applied, so use max(, 0) to</span>
    <span class="s6"># make them nonnegative.</span>
    <span class="s2">if not </span><span class="s1">margin_left</span><span class="s3">:</span>
        <span class="s1">margin_left </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">hspaces</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">].</span><span class="s1">max</span><span class="s3">(), </span><span class="s4">0</span><span class="s3">) + </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_width_inch</span>
        <span class="s1">suplabel </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">_supylabel</span>
        <span class="s2">if </span><span class="s1">suplabel </span><span class="s2">and </span><span class="s1">suplabel</span><span class="s3">.</span><span class="s1">get_in_layout</span><span class="s3">():</span>
            <span class="s1">rel_width </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">transFigure</span><span class="s3">.</span><span class="s1">inverted</span><span class="s3">().</span><span class="s1">transform_bbox</span><span class="s3">(</span>
                <span class="s1">suplabel</span><span class="s3">.</span><span class="s1">get_window_extent</span><span class="s3">(</span><span class="s1">renderer</span><span class="s3">)).</span><span class="s1">width</span>
            <span class="s1">margin_left </span><span class="s3">+= </span><span class="s1">rel_width </span><span class="s3">+ </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_width_inch</span>
    <span class="s2">if not </span><span class="s1">margin_right</span><span class="s3">:</span>
        <span class="s1">margin_right </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">hspaces</span><span class="s3">[:, -</span><span class="s4">1</span><span class="s3">].</span><span class="s1">max</span><span class="s3">(), </span><span class="s4">0</span><span class="s3">) + </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_width_inch</span>
    <span class="s2">if not </span><span class="s1">margin_top</span><span class="s3">:</span>
        <span class="s1">margin_top </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">vspaces</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, :].</span><span class="s1">max</span><span class="s3">(), </span><span class="s4">0</span><span class="s3">) + </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_height_inch</span>
        <span class="s2">if </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">_suptitle </span><span class="s2">and </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">_suptitle</span><span class="s3">.</span><span class="s1">get_in_layout</span><span class="s3">():</span>
            <span class="s1">rel_height </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">transFigure</span><span class="s3">.</span><span class="s1">inverted</span><span class="s3">().</span><span class="s1">transform_bbox</span><span class="s3">(</span>
                <span class="s1">fig</span><span class="s3">.</span><span class="s1">_suptitle</span><span class="s3">.</span><span class="s1">get_window_extent</span><span class="s3">(</span><span class="s1">renderer</span><span class="s3">)).</span><span class="s1">height</span>
            <span class="s1">margin_top </span><span class="s3">+= </span><span class="s1">rel_height </span><span class="s3">+ </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_height_inch</span>
    <span class="s2">if not </span><span class="s1">margin_bottom</span><span class="s3">:</span>
        <span class="s1">margin_bottom </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">vspaces</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">, :].</span><span class="s1">max</span><span class="s3">(), </span><span class="s4">0</span><span class="s3">) + </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_height_inch</span>
        <span class="s1">suplabel </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">_supxlabel</span>
        <span class="s2">if </span><span class="s1">suplabel </span><span class="s2">and </span><span class="s1">suplabel</span><span class="s3">.</span><span class="s1">get_in_layout</span><span class="s3">():</span>
            <span class="s1">rel_height </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">transFigure</span><span class="s3">.</span><span class="s1">inverted</span><span class="s3">().</span><span class="s1">transform_bbox</span><span class="s3">(</span>
                <span class="s1">suplabel</span><span class="s3">.</span><span class="s1">get_window_extent</span><span class="s3">(</span><span class="s1">renderer</span><span class="s3">)).</span><span class="s1">height</span>
            <span class="s1">margin_bottom </span><span class="s3">+= </span><span class="s1">rel_height </span><span class="s3">+ </span><span class="s1">pad_inch</span><span class="s3">/</span><span class="s1">fig_height_inch</span>

    <span class="s2">if </span><span class="s1">margin_left </span><span class="s3">+ </span><span class="s1">margin_right </span><span class="s3">&gt;= </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'Tight layout not applied. The left and right '</span>
                           <span class="s5">'margins cannot be made large enough to '</span>
                           <span class="s5">'accommodate all Axes decorations.'</span><span class="s3">)</span>
        <span class="s2">return None</span>
    <span class="s2">if </span><span class="s1">margin_bottom </span><span class="s3">+ </span><span class="s1">margin_top </span><span class="s3">&gt;= </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'Tight layout not applied. The bottom and top '</span>
                           <span class="s5">'margins cannot be made large enough to '</span>
                           <span class="s5">'accommodate all Axes decorations.'</span><span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">left</span><span class="s3">=</span><span class="s1">margin_left</span><span class="s3">,</span>
                  <span class="s1">right</span><span class="s3">=</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">margin_right</span><span class="s3">,</span>
                  <span class="s1">bottom</span><span class="s3">=</span><span class="s1">margin_bottom</span><span class="s3">,</span>
                  <span class="s1">top</span><span class="s3">=</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">margin_top</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">cols </span><span class="s3">&gt; </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">hspace </span><span class="s3">= </span><span class="s1">hspaces</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">:-</span><span class="s4">1</span><span class="s3">].</span><span class="s1">max</span><span class="s3">() + </span><span class="s1">hpad_inch </span><span class="s3">/ </span><span class="s1">fig_width_inch</span>
        <span class="s6"># axes widths:</span>
        <span class="s1">h_axes </span><span class="s3">= (</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">margin_right </span><span class="s3">- </span><span class="s1">margin_left </span><span class="s3">- </span><span class="s1">hspace </span><span class="s3">* (</span><span class="s1">cols </span><span class="s3">- </span><span class="s4">1</span><span class="s3">)) / </span><span class="s1">cols</span>
        <span class="s2">if </span><span class="s1">h_axes </span><span class="s3">&lt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'Tight layout not applied. tight_layout '</span>
                               <span class="s5">'cannot make Axes width small enough to '</span>
                               <span class="s5">'accommodate all Axes decorations'</span><span class="s3">)</span>
            <span class="s2">return None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;wspace&quot;</span><span class="s3">] = </span><span class="s1">hspace </span><span class="s3">/ </span><span class="s1">h_axes</span>
    <span class="s2">if </span><span class="s1">rows </span><span class="s3">&gt; </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">vspace </span><span class="s3">= </span><span class="s1">vspaces</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:-</span><span class="s4">1</span><span class="s3">, :].</span><span class="s1">max</span><span class="s3">() + </span><span class="s1">vpad_inch </span><span class="s3">/ </span><span class="s1">fig_height_inch</span>
        <span class="s1">v_axes </span><span class="s3">= (</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">margin_top </span><span class="s3">- </span><span class="s1">margin_bottom </span><span class="s3">- </span><span class="s1">vspace </span><span class="s3">* (</span><span class="s1">rows </span><span class="s3">- </span><span class="s4">1</span><span class="s3">)) / </span><span class="s1">rows</span>
        <span class="s2">if </span><span class="s1">v_axes </span><span class="s3">&lt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'Tight layout not applied. tight_layout '</span>
                               <span class="s5">'cannot make Axes height small enough to '</span>
                               <span class="s5">'accommodate all Axes decorations.'</span><span class="s3">)</span>
            <span class="s2">return None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;hspace&quot;</span><span class="s3">] = </span><span class="s1">vspace </span><span class="s3">/ </span><span class="s1">v_axes</span>

    <span class="s2">return </span><span class="s1">kwargs</span>


<span class="s2">def </span><span class="s1">get_subplotspec_list</span><span class="s3">(</span><span class="s1">axes_list</span><span class="s3">, </span><span class="s1">grid_spec</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Return a list of subplotspec from the given list of Axes. 
 
    For an instance of Axes that does not support subplotspec, None is inserted 
    in the list. 
 
    If grid_spec is given, None is inserted for those not from the given 
    grid_spec. 
    &quot;&quot;&quot;</span>
    <span class="s1">subplotspec_list </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">ax </span><span class="s2">in </span><span class="s1">axes_list</span><span class="s3">:</span>
        <span class="s1">axes_or_locator </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_axes_locator</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">axes_or_locator </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">axes_or_locator </span><span class="s3">= </span><span class="s1">ax</span>

        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">axes_or_locator</span><span class="s3">, </span><span class="s5">&quot;get_subplotspec&quot;</span><span class="s3">):</span>
            <span class="s1">subplotspec </span><span class="s3">= </span><span class="s1">axes_or_locator</span><span class="s3">.</span><span class="s1">get_subplotspec</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">subplotspec </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">subplotspec </span><span class="s3">= </span><span class="s1">subplotspec</span><span class="s3">.</span><span class="s1">get_topmost_subplotspec</span><span class="s3">()</span>
                <span class="s1">gs </span><span class="s3">= </span><span class="s1">subplotspec</span><span class="s3">.</span><span class="s1">get_gridspec</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">grid_spec </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">gs </span><span class="s3">!= </span><span class="s1">grid_spec</span><span class="s3">:</span>
                        <span class="s1">subplotspec </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s2">elif </span><span class="s1">gs</span><span class="s3">.</span><span class="s1">locally_modified_subplot_params</span><span class="s3">():</span>
                    <span class="s1">subplotspec </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">subplotspec </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">subplotspec_list</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">subplotspec</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">subplotspec_list</span>


<span class="s2">def </span><span class="s1">get_tight_layout_figure</span><span class="s3">(</span><span class="s1">fig</span><span class="s3">, </span><span class="s1">axes_list</span><span class="s3">, </span><span class="s1">subplotspec_list</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">,</span>
                            <span class="s1">pad</span><span class="s3">=</span><span class="s4">1.08</span><span class="s3">, </span><span class="s1">h_pad</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">w_pad</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">rect</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Return subplot parameters for tight-layouted-figure with specified padding. 
 
    Parameters 
    ---------- 
    fig : Figure 
    axes_list : list of Axes 
    subplotspec_list : list of `.SubplotSpec` 
        The subplotspecs of each Axes. 
    renderer : renderer 
    pad : float 
        Padding between the figure edge and the edges of subplots, as a 
        fraction of the font size. 
    h_pad, w_pad : float 
        Padding (height/width) between edges of adjacent subplots.  Defaults to 
        *pad*. 
    rect : tuple (left, bottom, right, top), default: None. 
        rectangle in normalized figure coordinates 
        that the whole subplots area (including labels) will fit into. 
        Defaults to using the entire figure. 
 
    Returns 
    ------- 
    subplotspec or None 
        subplotspec kwargs to be passed to `.Figure.subplots_adjust` or 
        None if tight_layout could not be accomplished. 
    &quot;&quot;&quot;</span>

    <span class="s6"># Multiple Axes can share same subplotspec (e.g., if using axes_grid1);</span>
    <span class="s6"># we need to group them together.</span>
    <span class="s1">ss_to_subplots </span><span class="s3">= {</span><span class="s1">ss</span><span class="s3">: [] </span><span class="s2">for </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">subplotspec_list</span><span class="s3">}</span>
    <span class="s2">for </span><span class="s1">ax</span><span class="s3">, </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">axes_list</span><span class="s3">, </span><span class="s1">subplotspec_list</span><span class="s3">):</span>
        <span class="s1">ss_to_subplots</span><span class="s3">[</span><span class="s1">ss</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ss_to_subplots</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span>
            <span class="s5">&quot;This figure includes Axes that are not compatible with &quot;</span>
            <span class="s5">&quot;tight_layout, so results might be incorrect.&quot;</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">ss_to_subplots</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s3">{}</span>
    <span class="s1">subplot_list </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">ss_to_subplots</span><span class="s3">.</span><span class="s1">values</span><span class="s3">())</span>
    <span class="s1">ax_bbox_list </span><span class="s3">= [</span><span class="s1">ss</span><span class="s3">.</span><span class="s1">get_position</span><span class="s3">(</span><span class="s1">fig</span><span class="s3">) </span><span class="s2">for </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">ss_to_subplots</span><span class="s3">]</span>

    <span class="s1">max_nrows </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">.</span><span class="s1">get_gridspec</span><span class="s3">().</span><span class="s1">nrows </span><span class="s2">for </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">ss_to_subplots</span><span class="s3">)</span>
    <span class="s1">max_ncols </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">.</span><span class="s1">get_gridspec</span><span class="s3">().</span><span class="s1">ncols </span><span class="s2">for </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">ss_to_subplots</span><span class="s3">)</span>

    <span class="s1">span_pairs </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">ss </span><span class="s2">in </span><span class="s1">ss_to_subplots</span><span class="s3">:</span>
        <span class="s6"># The intent here is to support Axes from different gridspecs where</span>
        <span class="s6"># one's nrows (or ncols) is a multiple of the other (e.g. 2 and 4),</span>
        <span class="s6"># but this doesn't actually work because the computed wspace, in</span>
        <span class="s6"># relative-axes-height, corresponds to different physical spacings for</span>
        <span class="s6"># the 2-row grid and the 4-row grid.  Still, this code is left, mostly</span>
        <span class="s6"># for backcompat.</span>
        <span class="s1">rows</span><span class="s3">, </span><span class="s1">cols </span><span class="s3">= </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">get_gridspec</span><span class="s3">().</span><span class="s1">get_geometry</span><span class="s3">()</span>
        <span class="s1">div_row</span><span class="s3">, </span><span class="s1">mod_row </span><span class="s3">= </span><span class="s1">divmod</span><span class="s3">(</span><span class="s1">max_nrows</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">)</span>
        <span class="s1">div_col</span><span class="s3">, </span><span class="s1">mod_col </span><span class="s3">= </span><span class="s1">divmod</span><span class="s3">(</span><span class="s1">max_ncols</span><span class="s3">, </span><span class="s1">cols</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">mod_row </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'tight_layout not applied: number of rows '</span>
                               <span class="s5">'in subplot specifications must be '</span>
                               <span class="s5">'multiples of one another.'</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s3">{}</span>
        <span class="s2">if </span><span class="s1">mod_col </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">_api</span><span class="s3">.</span><span class="s1">warn_external</span><span class="s3">(</span><span class="s5">'tight_layout not applied: number of '</span>
                               <span class="s5">'columns in subplot specifications must be '</span>
                               <span class="s5">'multiples of one another.'</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s3">{}</span>
        <span class="s1">span_pairs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span>
            <span class="s1">slice</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">.</span><span class="s1">rowspan</span><span class="s3">.</span><span class="s1">start </span><span class="s3">* </span><span class="s1">div_row</span><span class="s3">, </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">rowspan</span><span class="s3">.</span><span class="s1">stop </span><span class="s3">* </span><span class="s1">div_row</span><span class="s3">),</span>
            <span class="s1">slice</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">.</span><span class="s1">colspan</span><span class="s3">.</span><span class="s1">start </span><span class="s3">* </span><span class="s1">div_col</span><span class="s3">, </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">colspan</span><span class="s3">.</span><span class="s1">stop </span><span class="s3">* </span><span class="s1">div_col</span><span class="s3">)))</span>

    <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">_auto_adjust_subplotpars</span><span class="s3">(</span><span class="s1">fig</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">,</span>
                                      <span class="s1">shape</span><span class="s3">=(</span><span class="s1">max_nrows</span><span class="s3">, </span><span class="s1">max_ncols</span><span class="s3">),</span>
                                      <span class="s1">span_pairs</span><span class="s3">=</span><span class="s1">span_pairs</span><span class="s3">,</span>
                                      <span class="s1">subplot_list</span><span class="s3">=</span><span class="s1">subplot_list</span><span class="s3">,</span>
                                      <span class="s1">ax_bbox_list</span><span class="s3">=</span><span class="s1">ax_bbox_list</span><span class="s3">,</span>
                                      <span class="s1">pad</span><span class="s3">=</span><span class="s1">pad</span><span class="s3">, </span><span class="s1">h_pad</span><span class="s3">=</span><span class="s1">h_pad</span><span class="s3">, </span><span class="s1">w_pad</span><span class="s3">=</span><span class="s1">w_pad</span><span class="s3">)</span>

    <span class="s6"># kwargs can be none if tight_layout fails...</span>
    <span class="s2">if </span><span class="s1">rect </span><span class="s2">is not None and </span><span class="s1">kwargs </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s6"># if rect is given, the whole subplots area (including</span>
        <span class="s6"># labels) will fit into the rect instead of the</span>
        <span class="s6"># figure. Note that the rect argument of</span>
        <span class="s6"># *auto_adjust_subplotpars* specify the area that will be</span>
        <span class="s6"># covered by the total area of axes.bbox. Thus we call</span>
        <span class="s6"># auto_adjust_subplotpars twice, where the second run</span>
        <span class="s6"># with adjusted rect parameters.</span>

        <span class="s1">left</span><span class="s3">, </span><span class="s1">bottom</span><span class="s3">, </span><span class="s1">right</span><span class="s3">, </span><span class="s1">top </span><span class="s3">= </span><span class="s1">rect</span>
        <span class="s2">if </span><span class="s1">left </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">left </span><span class="s3">+= </span><span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;left&quot;</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">bottom </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">bottom </span><span class="s3">+= </span><span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;bottom&quot;</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">right </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">right </span><span class="s3">-= (</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;right&quot;</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">top </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">top </span><span class="s3">-= (</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;top&quot;</span><span class="s3">])</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">_auto_adjust_subplotpars</span><span class="s3">(</span><span class="s1">fig</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">,</span>
                                          <span class="s1">shape</span><span class="s3">=(</span><span class="s1">max_nrows</span><span class="s3">, </span><span class="s1">max_ncols</span><span class="s3">),</span>
                                          <span class="s1">span_pairs</span><span class="s3">=</span><span class="s1">span_pairs</span><span class="s3">,</span>
                                          <span class="s1">subplot_list</span><span class="s3">=</span><span class="s1">subplot_list</span><span class="s3">,</span>
                                          <span class="s1">ax_bbox_list</span><span class="s3">=</span><span class="s1">ax_bbox_list</span><span class="s3">,</span>
                                          <span class="s1">pad</span><span class="s3">=</span><span class="s1">pad</span><span class="s3">, </span><span class="s1">h_pad</span><span class="s3">=</span><span class="s1">h_pad</span><span class="s3">, </span><span class="s1">w_pad</span><span class="s3">=</span><span class="s1">w_pad</span><span class="s3">,</span>
                                          <span class="s1">rect</span><span class="s3">=(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">bottom</span><span class="s3">, </span><span class="s1">right</span><span class="s3">, </span><span class="s1">top</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">kwargs</span>
</pre>
</body>
</html>