<html>
<head>
<title>test_stacking.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_stacking.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Test the stacking classifier and regressor.&quot;&quot;&quot;</span>

<span class="s2"># Authors: Guillaume Lemaitre &lt;g.lemaitre58@gmail.com&gt;</span>
<span class="s2"># License: BSD 3 clause</span>

<span class="s3">from </span><span class="s1">unittest</span><span class="s4">.</span><span class="s1">mock </span><span class="s3">import </span><span class="s1">Mock</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">testing </span><span class="s3">import </span><span class="s1">assert_array_equal</span>
<span class="s3">from </span><span class="s1">scipy </span><span class="s3">import </span><span class="s1">sparse</span>

<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">BaseEstimator</span><span class="s4">, </span><span class="s1">ClassifierMixin</span><span class="s4">, </span><span class="s1">RegressorMixin</span><span class="s4">, </span><span class="s1">clone</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">datasets </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">load_breast_cancer</span><span class="s4">,</span>
    <span class="s1">load_diabetes</span><span class="s4">,</span>
    <span class="s1">load_iris</span><span class="s4">,</span>
    <span class="s1">make_classification</span><span class="s4">,</span>
    <span class="s1">make_multilabel_classification</span><span class="s4">,</span>
    <span class="s1">make_regression</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">dummy </span><span class="s3">import </span><span class="s1">DummyClassifier</span><span class="s4">, </span><span class="s1">DummyRegressor</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">ensemble </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">RandomForestClassifier</span><span class="s4">,</span>
    <span class="s1">RandomForestRegressor</span><span class="s4">,</span>
    <span class="s1">StackingClassifier</span><span class="s4">,</span>
    <span class="s1">StackingRegressor</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">exceptions </span><span class="s3">import </span><span class="s1">ConvergenceWarning</span><span class="s4">, </span><span class="s1">NotFittedError</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">linear_model </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">LinearRegression</span><span class="s4">,</span>
    <span class="s1">LogisticRegression</span><span class="s4">,</span>
    <span class="s1">Ridge</span><span class="s4">,</span>
    <span class="s1">RidgeClassifier</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">model_selection </span><span class="s3">import </span><span class="s1">KFold</span><span class="s4">, </span><span class="s1">StratifiedKFold</span><span class="s4">, </span><span class="s1">train_test_split</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">neighbors </span><span class="s3">import </span><span class="s1">KNeighborsClassifier</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">neural_network </span><span class="s3">import </span><span class="s1">MLPClassifier</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">preprocessing </span><span class="s3">import </span><span class="s1">scale</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">svm </span><span class="s3">import </span><span class="s1">SVC</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">, </span><span class="s1">LinearSVR</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">_mocking </span><span class="s3">import </span><span class="s1">CheckingClassifier</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">_testing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">assert_allclose</span><span class="s4">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s4">,</span>
    <span class="s1">ignore_warnings</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">fixes </span><span class="s3">import </span><span class="s1">COO_CONTAINERS</span><span class="s4">, </span><span class="s1">CSC_CONTAINERS</span><span class="s4">, </span><span class="s1">CSR_CONTAINERS</span>

<span class="s1">diabetes </span><span class="s4">= </span><span class="s1">load_diabetes</span><span class="s4">()</span>
<span class="s1">X_diabetes</span><span class="s4">, </span><span class="s1">y_diabetes </span><span class="s4">= </span><span class="s1">diabetes</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">diabetes</span><span class="s4">.</span><span class="s1">target</span>
<span class="s1">iris </span><span class="s4">= </span><span class="s1">load_iris</span><span class="s4">()</span>
<span class="s1">X_iris</span><span class="s4">, </span><span class="s1">y_iris </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>
<span class="s1">X_multilabel</span><span class="s4">, </span><span class="s1">y_multilabel </span><span class="s4">= </span><span class="s1">make_multilabel_classification</span><span class="s4">(</span>
    <span class="s1">n_classes</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
<span class="s4">)</span>
<span class="s1">X_binary</span><span class="s4">, </span><span class="s1">y_binary </span><span class="s4">= </span><span class="s1">make_classification</span><span class="s4">(</span><span class="s1">n_classes</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;cv&quot;</span><span class="s4">, [</span><span class="s5">3</span><span class="s4">, </span><span class="s1">StratifiedKFold</span><span class="s4">(</span><span class="s1">n_splits</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)]</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;final_estimator&quot;</span><span class="s4">, [</span><span class="s3">None</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)]</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;passthrough&quot;</span><span class="s4">, [</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_stacking_classifier_iris</span><span class="s4">(</span><span class="s1">cv</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">, </span><span class="s1">passthrough</span><span class="s4">):</span>
    <span class="s2"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="s2"># for later assert</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">), </span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()), (</span><span class="s6">&quot;svc&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">())]</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">,</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">final_estimator</span><span class="s4">,</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s1">cv</span><span class="s4">,</span>
        <span class="s1">passthrough</span><span class="s4">=</span><span class="s1">passthrough</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">) &gt; </span><span class="s5">0.8</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">expected_column_count </span><span class="s4">= </span><span class="s5">10 </span><span class="s3">if </span><span class="s1">passthrough </span><span class="s3">else </span><span class="s5">6</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">expected_column_count</span>
    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">4</span><span class="s4">:])</span>

    <span class="s1">clf</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">lr</span><span class="s4">=</span><span class="s6">&quot;drop&quot;</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">final_estimator </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s2"># LogisticRegression has decision_function method</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">decision_function</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">expected_column_count_drop </span><span class="s4">= </span><span class="s5">7 </span><span class="s3">if </span><span class="s1">passthrough </span><span class="s3">else </span><span class="s5">3</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">expected_column_count_drop</span>
    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">4</span><span class="s4">:])</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_drop_column_binary_classification</span><span class="s4">():</span>
    <span class="s2"># check that a column is dropped in binary classification</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">load_breast_cancer</span><span class="s4">(</span><span class="s1">return_X_y</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>

    <span class="s2"># both classifiers implement 'predict_proba' and will both drop one column</span>
    <span class="s1">estimators </span><span class="s4">= [</span>
        <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
        <span class="s4">(</span><span class="s6">&quot;rf&quot;</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
    <span class="s4">]</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">3</span><span class="s4">)</span>

    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s5">2</span>

    <span class="s2"># LinearSVC does not implement 'predict_proba' and will not drop one column</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()), (</span><span class="s6">&quot;svc&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">())]</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">)</span>

    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s5">2</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_drop_estimator</span><span class="s4">():</span>
    <span class="s2"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="s2"># for later assert</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">), </span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s6">&quot;drop&quot;</span><span class="s4">), (</span><span class="s6">&quot;svc&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">))]</span>
    <span class="s1">rf </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;svc&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">))],</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">,</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">clf_drop </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">)</span>

    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">clf_drop</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">), </span><span class="s1">clf_drop</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">), </span><span class="s1">clf_drop</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">), </span><span class="s1">clf_drop</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">test_stacking_regressor_drop_estimator</span><span class="s4">():</span>
    <span class="s2"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="s2"># for later assert</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X_diabetes</span><span class="s4">), </span><span class="s1">y_diabetes</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s6">&quot;drop&quot;</span><span class="s4">), (</span><span class="s6">&quot;svr&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">))]</span>
    <span class="s1">rf </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">reg </span><span class="s4">= </span><span class="s1">StackingRegressor</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;svr&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">))],</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">,</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">reg_drop </span><span class="s4">= </span><span class="s1">StackingRegressor</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">)</span>

    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">reg_drop</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">reg</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">), </span><span class="s1">reg_drop</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">reg</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">), </span><span class="s1">reg_drop</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;cv&quot;</span><span class="s4">, [</span><span class="s5">3</span><span class="s4">, </span><span class="s1">KFold</span><span class="s4">(</span><span class="s1">n_splits</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;final_estimator, predict_params&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s3">None</span><span class="s4">, {}),</span>
        <span class="s4">(</span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">), {}),</span>
        <span class="s4">(</span><span class="s1">DummyRegressor</span><span class="s4">(), {</span><span class="s6">&quot;return_std&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;passthrough&quot;</span><span class="s4">, [</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_stacking_regressor_diabetes</span><span class="s4">(</span><span class="s1">cv</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">, </span><span class="s1">predict_params</span><span class="s4">, </span><span class="s1">passthrough</span><span class="s4">):</span>
    <span class="s2"># prescale the data to avoid convergence warning without using a pipeline</span>
    <span class="s2"># for later assert</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X_diabetes</span><span class="s4">), </span><span class="s1">y_diabetes</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()), (</span><span class="s6">&quot;svr&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">())]</span>
    <span class="s1">reg </span><span class="s4">= </span><span class="s1">StackingRegressor</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">,</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">final_estimator</span><span class="s4">,</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s1">cv</span><span class="s4">,</span>
        <span class="s1">passthrough</span><span class="s4">=</span><span class="s1">passthrough</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">result </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, **</span><span class="s1">predict_params</span><span class="s4">)</span>
    <span class="s1">expected_result_length </span><span class="s4">= </span><span class="s5">2 </span><span class="s3">if </span><span class="s1">predict_params </span><span class="s3">else </span><span class="s5">1</span>
    <span class="s3">if </span><span class="s1">predict_params</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">result</span><span class="s4">) == </span><span class="s1">expected_result_length</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">expected_column_count </span><span class="s4">= </span><span class="s5">12 </span><span class="s3">if </span><span class="s1">passthrough </span><span class="s3">else </span><span class="s5">2</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">expected_column_count</span>
    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">10</span><span class="s4">:])</span>

    <span class="s1">reg</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">lr</span><span class="s4">=</span><span class="s6">&quot;drop&quot;</span><span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">expected_column_count_drop </span><span class="s4">= </span><span class="s5">11 </span><span class="s3">if </span><span class="s1">passthrough </span><span class="s3">else </span><span class="s5">1</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">expected_column_count_drop</span>
    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">10</span><span class="s4">:])</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;sparse_container&quot;</span><span class="s4">, </span><span class="s1">COO_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSR_CONTAINERS</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_regressor_sparse_passthrough</span><span class="s4">(</span><span class="s1">sparse_container</span><span class="s4">):</span>
    <span class="s2"># Check passthrough behavior on a sparse X matrix</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">sparse_container</span><span class="s4">(</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X_diabetes</span><span class="s4">)), </span><span class="s1">y_diabetes</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()), (</span><span class="s6">&quot;svr&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">())]</span>
    <span class="s1">rf </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingRegressor</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">passthrough</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">10</span><span class="s4">:])</span>
    <span class="s3">assert </span><span class="s1">sparse</span><span class="s4">.</span><span class="s1">issparse</span><span class="s4">(</span><span class="s1">X_trans</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_test</span><span class="s4">.</span><span class="s1">format </span><span class="s4">== </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">format</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;sparse_container&quot;</span><span class="s4">, </span><span class="s1">COO_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSR_CONTAINERS</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_classifier_sparse_passthrough</span><span class="s4">(</span><span class="s1">sparse_container</span><span class="s4">):</span>
    <span class="s2"># Check passthrough behavior on a sparse X matrix</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">sparse_container</span><span class="s4">(</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">)), </span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()), (</span><span class="s6">&quot;svc&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">())]</span>
    <span class="s1">rf </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">rf</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">passthrough</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">X_trans</span><span class="s4">[:, -</span><span class="s5">4</span><span class="s4">:])</span>
    <span class="s3">assert </span><span class="s1">sparse</span><span class="s4">.</span><span class="s1">issparse</span><span class="s4">(</span><span class="s1">X_trans</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_test</span><span class="s4">.</span><span class="s1">format </span><span class="s4">== </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">format</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_drop_binary_prob</span><span class="s4">():</span>
    <span class="s2"># check that classifier will drop one of the probability column for</span>
    <span class="s2"># binary classification problem</span>

    <span class="s2"># Select only the 2 first classes</span>
    <span class="s1">X_</span><span class="s4">, </span><span class="s1">y_ </span><span class="s4">= </span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">]), </span><span class="s1">y_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">]</span>

    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()), (</span><span class="s6">&quot;rf&quot;</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">())]</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_</span><span class="s4">, </span><span class="s1">y_</span><span class="s4">)</span>
    <span class="s1">X_meta </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_meta</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s5">2</span>


<span class="s3">class </span><span class="s1">NoWeightRegressor</span><span class="s4">(</span><span class="s1">RegressorMixin</span><span class="s4">, </span><span class="s1">BaseEstimator</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">reg </span><span class="s4">= </span><span class="s1">DummyRegressor</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>


<span class="s3">class </span><span class="s1">NoWeightClassifier</span><span class="s4">(</span><span class="s1">ClassifierMixin</span><span class="s4">, </span><span class="s1">BaseEstimator</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">clf </span><span class="s4">= </span><span class="s1">DummyClassifier</span><span class="s4">(</span><span class="s1">strategy</span><span class="s4">=</span><span class="s6">&quot;stratified&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;y, params, type_err, msg_err&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s1">y_iris</span><span class="s4">, {</span><span class="s6">&quot;estimators&quot;</span><span class="s4">: []}, </span><span class="s1">ValueError</span><span class="s4">, </span><span class="s6">&quot;Invalid 'estimators' attribute,&quot;</span><span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
            <span class="s4">{</span>
                <span class="s6">&quot;estimators&quot;</span><span class="s4">: [</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">SVC</span><span class="s4">(</span><span class="s1">max_iter</span><span class="s4">=</span><span class="s5">50_000</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s6">&quot;stack_method&quot;</span><span class="s4">: </span><span class="s6">&quot;predict_proba&quot;</span><span class="s4">,</span>
            <span class="s4">},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s6">&quot;does not implement the method predict_proba&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
            <span class="s4">{</span>
                <span class="s6">&quot;estimators&quot;</span><span class="s4">: [</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;cor&quot;</span><span class="s4">, </span><span class="s1">NoWeightClassifier</span><span class="s4">()),</span>
                <span class="s4">]</span>
            <span class="s4">},</span>
            <span class="s1">TypeError</span><span class="s4">,</span>
            <span class="s6">&quot;does not support sample weight&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
            <span class="s4">{</span>
                <span class="s6">&quot;estimators&quot;</span><span class="s4">: [</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;cor&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">max_iter</span><span class="s4">=</span><span class="s5">50_000</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s6">&quot;final_estimator&quot;</span><span class="s4">: </span><span class="s1">NoWeightClassifier</span><span class="s4">(),</span>
            <span class="s4">},</span>
            <span class="s1">TypeError</span><span class="s4">,</span>
            <span class="s6">&quot;does not support sample weight&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_classifier_error</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">params</span><span class="s4">, </span><span class="s1">type_err</span><span class="s4">, </span><span class="s1">msg_err</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">type_err</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg_err</span><span class="s4">):</span>
        <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(**</span><span class="s1">params</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">3</span><span class="s4">)</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">), </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;y, params, type_err, msg_err&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s1">y_diabetes</span><span class="s4">, {</span><span class="s6">&quot;estimators&quot;</span><span class="s4">: []}, </span><span class="s1">ValueError</span><span class="s4">, </span><span class="s6">&quot;Invalid 'estimators' attribute,&quot;</span><span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
            <span class="s4">{</span><span class="s6">&quot;estimators&quot;</span><span class="s4">: [(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()), (</span><span class="s6">&quot;cor&quot;</span><span class="s4">, </span><span class="s1">NoWeightRegressor</span><span class="s4">())]},</span>
            <span class="s1">TypeError</span><span class="s4">,</span>
            <span class="s6">&quot;does not support sample weight&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
            <span class="s4">{</span>
                <span class="s6">&quot;estimators&quot;</span><span class="s4">: [</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;cor&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">()),</span>
                <span class="s4">],</span>
                <span class="s6">&quot;final_estimator&quot;</span><span class="s4">: </span><span class="s1">NoWeightRegressor</span><span class="s4">(),</span>
            <span class="s4">},</span>
            <span class="s1">TypeError</span><span class="s4">,</span>
            <span class="s6">&quot;does not support sample weight&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_regressor_error</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">params</span><span class="s4">, </span><span class="s1">type_err</span><span class="s4">, </span><span class="s1">msg_err</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">type_err</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg_err</span><span class="s4">):</span>
        <span class="s1">reg </span><span class="s4">= </span><span class="s1">StackingRegressor</span><span class="s4">(**</span><span class="s1">params</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">3</span><span class="s4">)</span>
        <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X_diabetes</span><span class="s4">), </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">X_diabetes</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;estimator, X, y&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">X_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">],</span>
            <span class="s1">y_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">],</span>
        <span class="s4">),  </span><span class="s2"># keep only classes 0 and 1</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
    <span class="s1">ids</span><span class="s4">=[</span><span class="s6">&quot;StackingClassifier&quot;</span><span class="s4">, </span><span class="s6">&quot;StackingRegressor&quot;</span><span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_randomness</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
    <span class="s2"># checking that fixing the random state of the CV will lead to the same</span>
    <span class="s2"># results</span>
    <span class="s1">estimator_full </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">)</span>
    <span class="s1">estimator_full</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s1">KFold</span><span class="s4">(</span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">))</span>
    <span class="s4">)</span>

    <span class="s1">estimator_drop </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">)</span>
    <span class="s1">estimator_drop</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">lr</span><span class="s4">=</span><span class="s6">&quot;drop&quot;</span><span class="s4">)</span>
    <span class="s1">estimator_drop</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span>
        <span class="s1">cv</span><span class="s4">=</span><span class="s1">KFold</span><span class="s4">(</span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">))</span>
    <span class="s4">)</span>

    <span class="s1">assert_allclose</span><span class="s4">(</span>
        <span class="s1">estimator_full</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)[:, </span><span class="s5">1</span><span class="s4">:],</span>
        <span class="s1">estimator_drop</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">),</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_stratify_default</span><span class="s4">():</span>
    <span class="s2"># check that we stratify the classes for the default CV</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=[</span>
            <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">(</span><span class="s1">max_iter</span><span class="s4">=</span><span class="s5">10_000</span><span class="s4">)),</span>
            <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">max_iter</span><span class="s4">=</span><span class="s5">10_000</span><span class="s4">)),</span>
        <span class="s4">]</span>
    <span class="s4">)</span>
    <span class="s2"># since iris is not shuffled, a simple k-fold would not contain the</span>
    <span class="s2"># 3 classes during training</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">, </span><span class="s1">y_iris</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;stacker, X, y&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">LogisticRegression</span><span class="s4">(),</span>
                <span class="s1">cv</span><span class="s4">=</span><span class="s1">KFold</span><span class="s4">(</span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">),</span>
            <span class="s4">),</span>
            <span class="s4">*</span><span class="s1">load_breast_cancer</span><span class="s4">(</span><span class="s1">return_X_y</span><span class="s4">=</span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">LinearRegression</span><span class="s4">(),</span>
                <span class="s1">cv</span><span class="s4">=</span><span class="s1">KFold</span><span class="s4">(</span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">),</span>
            <span class="s4">),</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
    <span class="s1">ids</span><span class="s4">=[</span><span class="s6">&quot;StackingClassifier&quot;</span><span class="s4">, </span><span class="s6">&quot;StackingRegressor&quot;</span><span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_with_sample_weight</span><span class="s4">(</span><span class="s1">stacker</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
    <span class="s2"># check that sample weights has an influence on the fitting</span>
    <span class="s2"># note: ConvergenceWarning are catch since we are not worrying about the</span>
    <span class="s2"># convergence here</span>
    <span class="s1">n_half_samples </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">y</span><span class="s4">) // </span><span class="s5">2</span>
    <span class="s1">total_sample_weight </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span>
        <span class="s4">[</span><span class="s5">0.1</span><span class="s4">] * </span><span class="s1">n_half_samples </span><span class="s4">+ [</span><span class="s5">0.9</span><span class="s4">] * (</span><span class="s1">len</span><span class="s4">(</span><span class="s1">y</span><span class="s4">) - </span><span class="s1">n_half_samples</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">sample_weight_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">total_sample_weight</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>

    <span class="s3">with </span><span class="s1">ignore_warnings</span><span class="s4">(</span><span class="s1">category</span><span class="s4">=</span><span class="s1">ConvergenceWarning</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">y_pred_no_weight </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">ignore_warnings</span><span class="s4">(</span><span class="s1">category</span><span class="s4">=</span><span class="s1">ConvergenceWarning</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">y_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">))</span>
    <span class="s1">y_pred_unit_weight </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">y_pred_no_weight</span><span class="s4">, </span><span class="s1">y_pred_unit_weight</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">ignore_warnings</span><span class="s4">(</span><span class="s1">category</span><span class="s4">=</span><span class="s1">ConvergenceWarning</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">sample_weight_train</span><span class="s4">)</span>
    <span class="s1">y_pred_biased </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">y_pred_no_weight </span><span class="s4">- </span><span class="s1">y_pred_biased</span><span class="s4">).</span><span class="s1">sum</span><span class="s4">() &gt; </span><span class="s5">0</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_sample_weight_fit_param</span><span class="s4">():</span>
    <span class="s2"># check sample_weight is passed to all invocations of fit</span>
    <span class="s1">stacker </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">CheckingClassifier</span><span class="s4">(</span><span class="s1">expected_sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">))],</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">CheckingClassifier</span><span class="s4">(</span><span class="s1">expected_sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">, </span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">filterwarnings</span><span class="s4">(</span><span class="s6">&quot;ignore::sklearn.exceptions.ConvergenceWarning&quot;</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;stacker, X, y&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">LogisticRegression</span><span class="s4">(),</span>
            <span class="s4">),</span>
            <span class="s4">*</span><span class="s1">load_breast_cancer</span><span class="s4">(</span><span class="s1">return_X_y</span><span class="s4">=</span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
                <span class="s4">],</span>
                <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">LinearRegression</span><span class="s4">(),</span>
            <span class="s4">),</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
    <span class="s1">ids</span><span class="s4">=[</span><span class="s6">&quot;StackingClassifier&quot;</span><span class="s4">, </span><span class="s6">&quot;StackingRegressor&quot;</span><span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_cv_influence</span><span class="s4">(</span><span class="s1">stacker</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
    <span class="s2"># check that the stacking affects the fit of the final estimator but not</span>
    <span class="s2"># the fit of the base estimators</span>
    <span class="s2"># note: ConvergenceWarning are catch since we are not worrying about the</span>
    <span class="s2"># convergence here</span>
    <span class="s1">stacker_cv_3 </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">stacker</span><span class="s4">)</span>
    <span class="s1">stacker_cv_5 </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">stacker</span><span class="s4">)</span>

    <span class="s1">stacker_cv_3</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">cv</span><span class="s4">=</span><span class="s5">3</span><span class="s4">)</span>
    <span class="s1">stacker_cv_5</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">cv</span><span class="s4">=</span><span class="s5">5</span><span class="s4">)</span>

    <span class="s1">stacker_cv_3</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">stacker_cv_5</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s2"># the base estimators should be identical</span>
    <span class="s3">for </span><span class="s1">est_cv_3</span><span class="s4">, </span><span class="s1">est_cv_5 </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">stacker_cv_3</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">, </span><span class="s1">stacker_cv_5</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">):</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">est_cv_3</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">est_cv_5</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">)</span>

    <span class="s2"># the final estimator should be different</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AssertionError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Not equal&quot;</span><span class="s4">):</span>
        <span class="s1">assert_allclose</span><span class="s4">(</span>
            <span class="s1">stacker_cv_3</span><span class="s4">.</span><span class="s1">final_estimator_</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">stacker_cv_5</span><span class="s4">.</span><span class="s1">final_estimator_</span><span class="s4">.</span><span class="s1">coef_</span>
        <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;Stacker, Estimator, stack_method, final_estimator, X, y&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">,</span>
            <span class="s1">DummyClassifier</span><span class="s4">,</span>
            <span class="s6">&quot;predict_proba&quot;</span><span class="s4">,</span>
            <span class="s1">LogisticRegression</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">),</span>
            <span class="s1">X_iris</span><span class="s4">,</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">,</span>
            <span class="s1">DummyRegressor</span><span class="s4">,</span>
            <span class="s6">&quot;predict&quot;</span><span class="s4">,</span>
            <span class="s1">LinearRegression</span><span class="s4">(),</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_prefit</span><span class="s4">(</span><span class="s1">Stacker</span><span class="s4">, </span><span class="s1">Estimator</span><span class="s4">, </span><span class="s1">stack_method</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of stacking when `cv='prefit'`&quot;&quot;&quot;</span>
    <span class="s1">X_train1</span><span class="s4">, </span><span class="s1">X_train2</span><span class="s4">, </span><span class="s1">y_train1</span><span class="s4">, </span><span class="s1">y_train2 </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">, </span><span class="s1">test_size</span><span class="s4">=</span><span class="s5">0.5</span>
    <span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= [</span>
        <span class="s4">(</span><span class="s6">&quot;d0&quot;</span><span class="s4">, </span><span class="s1">Estimator</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train1</span><span class="s4">, </span><span class="s1">y_train1</span><span class="s4">)),</span>
        <span class="s4">(</span><span class="s6">&quot;d1&quot;</span><span class="s4">, </span><span class="s1">Estimator</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train1</span><span class="s4">, </span><span class="s1">y_train1</span><span class="s4">)),</span>
    <span class="s4">]</span>

    <span class="s2"># mock out fit and stack_method to be asserted later</span>
    <span class="s3">for </span><span class="s1">_</span><span class="s4">, </span><span class="s1">estimator </span><span class="s3">in </span><span class="s1">estimators</span><span class="s4">:</span>
        <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit </span><span class="s4">= </span><span class="s1">Mock</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
        <span class="s1">stack_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">, </span><span class="s1">stack_method</span><span class="s4">)</span>
        <span class="s1">predict_method_mocked </span><span class="s4">= </span><span class="s1">Mock</span><span class="s4">(</span><span class="s1">side_effect</span><span class="s4">=</span><span class="s1">stack_func</span><span class="s4">)</span>
        <span class="s2"># Mocking a method will not provide a `__name__` while Python methods</span>
        <span class="s2"># do and we are using it in `_get_response_method`.</span>
        <span class="s1">predict_method_mocked</span><span class="s4">.</span><span class="s1">__name__ </span><span class="s4">= </span><span class="s1">stack_method</span>
        <span class="s1">setattr</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">, </span><span class="s1">stack_method</span><span class="s4">, </span><span class="s1">predict_method_mocked</span><span class="s4">)</span>

    <span class="s1">stacker </span><span class="s4">= </span><span class="s1">Stacker</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s6">&quot;prefit&quot;</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">final_estimator</span>
    <span class="s4">)</span>
    <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train2</span><span class="s4">, </span><span class="s1">y_train2</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">estimators_ </span><span class="s4">== [</span><span class="s1">estimator </span><span class="s3">for </span><span class="s1">_</span><span class="s4">, </span><span class="s1">estimator </span><span class="s3">in </span><span class="s1">estimators</span><span class="s4">]</span>
    <span class="s2"># fit was not called again</span>
    <span class="s3">assert </span><span class="s1">all</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">call_count </span><span class="s4">== </span><span class="s5">0 </span><span class="s3">for </span><span class="s1">estimator </span><span class="s3">in </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">)</span>

    <span class="s2"># stack method is called with the proper inputs</span>
    <span class="s3">for </span><span class="s1">estimator </span><span class="s3">in </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">:</span>
        <span class="s1">stack_func_mock </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">, </span><span class="s1">stack_method</span><span class="s4">)</span>
        <span class="s1">stack_func_mock</span><span class="s4">.</span><span class="s1">assert_called_with</span><span class="s4">(</span><span class="s1">X_train2</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;stacker, X, y&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()), (</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">SVC</span><span class="s4">())],</span>
                <span class="s1">cv</span><span class="s4">=</span><span class="s6">&quot;prefit&quot;</span><span class="s4">,</span>
            <span class="s4">),</span>
            <span class="s1">X_iris</span><span class="s4">,</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">()),</span>
                <span class="s4">],</span>
                <span class="s1">cv</span><span class="s4">=</span><span class="s6">&quot;prefit&quot;</span><span class="s4">,</span>
            <span class="s4">),</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_prefit_error</span><span class="s4">(</span><span class="s1">stacker</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
    <span class="s2"># check that NotFittedError is raised</span>
    <span class="s2"># if base estimators are not fitted when cv=&quot;prefit&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">NotFittedError</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;make_dataset, Stacking, Estimator&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s1">make_classification</span><span class="s4">, </span><span class="s1">StackingClassifier</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s1">make_regression</span><span class="s4">, </span><span class="s1">StackingRegressor</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_without_n_features_in</span><span class="s4">(</span><span class="s1">make_dataset</span><span class="s4">, </span><span class="s1">Stacking</span><span class="s4">, </span><span class="s1">Estimator</span><span class="s4">):</span>
    <span class="s2"># Stacking supports estimators without `n_features_in_`. Regression test</span>
    <span class="s2"># for #17353</span>

    <span class="s3">class </span><span class="s1">MyEstimator</span><span class="s4">(</span><span class="s1">Estimator</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Estimator without n_features_in_&quot;&quot;&quot;</span>

        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">super</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">n_features_in_</span>

    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_dataset</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">100</span><span class="s4">)</span>
    <span class="s1">stacker </span><span class="s4">= </span><span class="s1">Stacking</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">MyEstimator</span><span class="s4">())])</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">Stacking</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">} </span><span class="s6">object has no attribute n_features_in_&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">n_features_in_</span>

    <span class="s2"># Does not raise</span>
    <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s6">&quot;'MyEstimator' object has no attribute 'n_features_in_'&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">stacker</span><span class="s4">.</span><span class="s1">n_features_in_</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;estimator&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s2"># output a 2D array of the probability of the positive class for each output</span>
        <span class="s1">MLPClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">),</span>
        <span class="s2"># output a list of 2D array containing the probability of each class</span>
        <span class="s2"># for each output</span>
        <span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">),</span>
    <span class="s4">],</span>
    <span class="s1">ids</span><span class="s4">=[</span><span class="s6">&quot;MLPClassifier&quot;</span><span class="s4">, </span><span class="s6">&quot;RandomForestClassifier&quot;</span><span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_stacking_classifier_multilabel_predict_proba</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour for the multilabel classification case and the 
    `predict_proba` stacking method. 
 
    Estimators are not consistent with the output arrays and we need to ensure that 
    we handle all cases. 
    &quot;&quot;&quot;</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_multilabel</span><span class="s4">, </span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">n_outputs </span><span class="s4">= </span><span class="s5">3</span>

    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;est&quot;</span><span class="s4">, </span><span class="s1">estimator</span><span class="s4">)]</span>
    <span class="s1">stacker </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">,</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">KNeighborsClassifier</span><span class="s4">(),</span>
        <span class="s1">stack_method</span><span class="s4">=</span><span class="s6">&quot;predict_proba&quot;</span><span class="s4">,</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== (</span><span class="s1">X_test</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">n_outputs</span><span class="s4">)</span>
    <span class="s2"># we should not have any collinear classes and thus nothing should sum to 1</span>
    <span class="s3">assert not </span><span class="s1">any</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">isclose</span><span class="s4">(</span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">axis</span><span class="s4">=</span><span class="s5">1</span><span class="s4">), </span><span class="s5">1.0</span><span class="s4">))</span>

    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">y_pred</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">y_test</span><span class="s4">.</span><span class="s1">shape</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_multilabel_decision_function</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour for the multilabel classification case and the 
    `decision_function` stacking method. Only `RidgeClassifier` supports this 
    case. 
    &quot;&quot;&quot;</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_multilabel</span><span class="s4">, </span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">n_outputs </span><span class="s4">= </span><span class="s5">3</span>

    <span class="s1">estimators </span><span class="s4">= [(</span><span class="s6">&quot;est&quot;</span><span class="s4">, </span><span class="s1">RidgeClassifier</span><span class="s4">())]</span>
    <span class="s1">stacker </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">,</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">KNeighborsClassifier</span><span class="s4">(),</span>
        <span class="s1">stack_method</span><span class="s4">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s4">,</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== (</span><span class="s1">X_test</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">n_outputs</span><span class="s4">)</span>

    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">y_pred</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">y_test</span><span class="s4">.</span><span class="s1">shape</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;stack_method&quot;</span><span class="s4">, [</span><span class="s6">&quot;auto&quot;</span><span class="s4">, </span><span class="s6">&quot;predict&quot;</span><span class="s4">])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;passthrough&quot;</span><span class="s4">, [</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_stacking_classifier_multilabel_auto_predict</span><span class="s4">(</span><span class="s1">stack_method</span><span class="s4">, </span><span class="s1">passthrough</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour for the multilabel classification case for stack methods 
    supported for all estimators or automatically picked up. 
    &quot;&quot;&quot;</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_multilabel</span><span class="s4">, </span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_multilabel</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">y_train_before_fit </span><span class="s4">= </span><span class="s1">y_train</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
    <span class="s1">n_outputs </span><span class="s4">= </span><span class="s5">3</span>

    <span class="s1">estimators </span><span class="s4">= [</span>
        <span class="s4">(</span><span class="s6">&quot;mlp&quot;</span><span class="s4">, </span><span class="s1">MLPClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
        <span class="s4">(</span><span class="s6">&quot;rf&quot;</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
        <span class="s4">(</span><span class="s6">&quot;ridge&quot;</span><span class="s4">, </span><span class="s1">RidgeClassifier</span><span class="s4">()),</span>
    <span class="s4">]</span>
    <span class="s1">final_estimator </span><span class="s4">= </span><span class="s1">KNeighborsClassifier</span><span class="s4">()</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">,</span>
        <span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">final_estimator</span><span class="s4">,</span>
        <span class="s1">passthrough</span><span class="s4">=</span><span class="s1">passthrough</span><span class="s4">,</span>
        <span class="s1">stack_method</span><span class="s4">=</span><span class="s1">stack_method</span><span class="s4">,</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s2"># make sure we don't change `y_train` inplace</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">y_train_before_fit</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">y_pred</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">y_test</span><span class="s4">.</span><span class="s1">shape</span>

    <span class="s3">if </span><span class="s1">stack_method </span><span class="s4">== </span><span class="s6">&quot;auto&quot;</span><span class="s4">:</span>
        <span class="s1">expected_stack_methods </span><span class="s4">= [</span><span class="s6">&quot;predict_proba&quot;</span><span class="s4">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s4">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">expected_stack_methods </span><span class="s4">= [</span><span class="s6">&quot;predict&quot;</span><span class="s4">] * </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">stack_method_ </span><span class="s4">== </span><span class="s1">expected_stack_methods</span>

    <span class="s1">n_features_X_trans </span><span class="s4">= </span><span class="s1">n_outputs </span><span class="s4">* </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">n_features_X_trans </span><span class="s4">+= </span><span class="s1">X_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
    <span class="s1">X_trans </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">X_trans</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== (</span><span class="s1">X_test</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">n_features_X_trans</span><span class="s4">)</span>

    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">classes_</span><span class="s4">, [</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])] * </span><span class="s1">n_outputs</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;stacker, feature_names, X, y, expected_names&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">iris</span><span class="s4">.</span><span class="s1">feature_names</span><span class="s4">,</span>
            <span class="s1">X_iris</span><span class="s4">,</span>
            <span class="s1">y_iris</span><span class="s4">,</span>
            <span class="s4">[</span>
                <span class="s6">&quot;stackingclassifier_lr0&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_lr1&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_lr2&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_svm0&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_svm1&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_svm2&quot;</span><span class="s4">,</span>
            <span class="s4">],</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingClassifier</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                    <span class="s4">(</span><span class="s6">&quot;other&quot;</span><span class="s4">, </span><span class="s6">&quot;drop&quot;</span><span class="s4">),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVC</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">iris</span><span class="s4">.</span><span class="s1">feature_names</span><span class="s4">,</span>
            <span class="s1">X_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">],</span>
            <span class="s1">y_iris</span><span class="s4">[:</span><span class="s5">100</span><span class="s4">],  </span><span class="s2"># keep only classes 0 and 1</span>
            <span class="s4">[</span>
                <span class="s6">&quot;stackingclassifier_lr&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingclassifier_svm&quot;</span><span class="s4">,</span>
            <span class="s4">],</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">StackingRegressor</span><span class="s4">(</span>
                <span class="s1">estimators</span><span class="s4">=[</span>
                    <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LinearRegression</span><span class="s4">()),</span>
                    <span class="s4">(</span><span class="s6">&quot;svm&quot;</span><span class="s4">, </span><span class="s1">LinearSVR</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)),</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">diabetes</span><span class="s4">.</span><span class="s1">feature_names</span><span class="s4">,</span>
            <span class="s1">X_diabetes</span><span class="s4">,</span>
            <span class="s1">y_diabetes</span><span class="s4">,</span>
            <span class="s4">[</span>
                <span class="s6">&quot;stackingregressor_lr&quot;</span><span class="s4">,</span>
                <span class="s6">&quot;stackingregressor_svm&quot;</span><span class="s4">,</span>
            <span class="s4">],</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
    <span class="s1">ids</span><span class="s4">=[</span>
        <span class="s6">&quot;StackingClassifier_multiclass&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;StackingClassifier_binary&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;StackingRegressor&quot;</span><span class="s4">,</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;passthrough&quot;</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_get_feature_names_out</span><span class="s4">(</span>
    <span class="s1">stacker</span><span class="s4">, </span><span class="s1">feature_names</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">expected_names</span><span class="s4">, </span><span class="s1">passthrough</span>
<span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check get_feature_names_out works for stacking.&quot;&quot;&quot;</span>

    <span class="s1">stacker</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">passthrough</span><span class="s4">=</span><span class="s1">passthrough</span><span class="s4">)</span>
    <span class="s1">stacker</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">passthrough</span><span class="s4">:</span>
        <span class="s1">expected_names </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">concatenate</span><span class="s4">((</span><span class="s1">expected_names</span><span class="s4">, </span><span class="s1">feature_names</span><span class="s4">))</span>

    <span class="s1">names_out </span><span class="s4">= </span><span class="s1">stacker</span><span class="s4">.</span><span class="s1">get_feature_names_out</span><span class="s4">(</span><span class="s1">feature_names</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">names_out</span><span class="s4">, </span><span class="s1">expected_names</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_stacking_classifier_base_regressor</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Check that a regressor can be used as the first layer in `StackingClassifier`.&quot;&quot;&quot;</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">scale</span><span class="s4">(</span><span class="s1">X_iris</span><span class="s4">), </span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_iris</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span>
    <span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">=[(</span><span class="s6">&quot;ridge&quot;</span><span class="s4">, </span><span class="s1">Ridge</span><span class="s4">())])</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">) &gt; </span><span class="s5">0.8</span>


<span class="s3">def </span><span class="s1">test_stacking_final_estimator_attribute_error</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise the proper AttributeError when the final estimator 
    does not implement the `decision_function` method, which is decorated with 
    `available_if`. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/28108 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_classification</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>

    <span class="s1">estimators </span><span class="s4">= [</span>
        <span class="s4">(</span><span class="s6">&quot;lr&quot;</span><span class="s4">, </span><span class="s1">LogisticRegression</span><span class="s4">()),</span>
        <span class="s4">(</span><span class="s6">&quot;rf&quot;</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)),</span>
    <span class="s4">]</span>
    <span class="s2"># RandomForestClassifier does not implement 'decision_function' and should raise</span>
    <span class="s2"># an AttributeError</span>
    <span class="s1">final_estimator </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">StackingClassifier</span><span class="s4">(</span>
        <span class="s1">estimators</span><span class="s4">=</span><span class="s1">estimators</span><span class="s4">, </span><span class="s1">final_estimator</span><span class="s4">=</span><span class="s1">final_estimator</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">3</span>
    <span class="s4">)</span>

    <span class="s1">outer_msg </span><span class="s4">= </span><span class="s6">&quot;This 'StackingClassifier' has no attribute 'decision_function'&quot;</span>
    <span class="s1">inner_msg </span><span class="s4">= </span><span class="s6">&quot;'RandomForestClassifier' object has no attribute 'decision_function'&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">outer_msg</span><span class="s4">) </span><span class="s3">as </span><span class="s1">exec_info</span><span class="s4">:</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">decision_function</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">exec_info</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">__cause__</span><span class="s4">, </span><span class="s1">AttributeError</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">inner_msg </span><span class="s3">in </span><span class="s1">str</span><span class="s4">(</span><span class="s1">exec_info</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">__cause__</span><span class="s4">)</span>
</pre>
</body>
</html>