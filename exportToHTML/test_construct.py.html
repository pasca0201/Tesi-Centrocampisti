<html>
<head>
<title>test_construct.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_construct.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;test sparse matrix construction functions&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">array</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_</span><span class="s3">,</span>
        <span class="s1">assert_array_equal</span><span class="s3">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s3">)</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_testutils </span><span class="s2">import </span><span class="s1">check_free_memory</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_util </span><span class="s2">import </span><span class="s1">check_random_state</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse </span><span class="s2">import </span><span class="s3">(</span><span class="s1">csr_matrix</span><span class="s3">, </span><span class="s1">coo_matrix</span><span class="s3">,</span>
                          <span class="s1">csr_array</span><span class="s3">, </span><span class="s1">coo_array</span><span class="s3">,</span>
                          <span class="s1">csc_array</span><span class="s3">, </span><span class="s1">bsr_array</span><span class="s3">,</span>
                          <span class="s1">dia_array</span><span class="s3">, </span><span class="s1">dok_array</span><span class="s3">,</span>
                          <span class="s1">lil_array</span><span class="s3">, </span><span class="s1">csc_matrix</span><span class="s3">,</span>
                          <span class="s1">bsr_matrix</span><span class="s3">, </span><span class="s1">dia_matrix</span><span class="s3">,</span>
                          <span class="s1">lil_matrix</span><span class="s3">, </span><span class="s1">sparray</span><span class="s3">, </span><span class="s1">spmatrix</span><span class="s3">,</span>
                          <span class="s1">_construct </span><span class="s2">as </span><span class="s1">construct</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">_construct </span><span class="s2">import </span><span class="s1">rand </span><span class="s2">as </span><span class="s1">sprand</span>

<span class="s1">sparse_formats </span><span class="s3">= [</span><span class="s4">'csr'</span><span class="s3">,</span><span class="s4">'csc'</span><span class="s3">,</span><span class="s4">'coo'</span><span class="s3">,</span><span class="s4">'bsr'</span><span class="s3">,</span><span class="s4">'dia'</span><span class="s3">,</span><span class="s4">'lil'</span><span class="s3">,</span><span class="s4">'dok'</span><span class="s3">]</span>

<span class="s5">#TODO check whether format=XXX is respected</span>


<span class="s2">def </span><span class="s1">_sprandn</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;coo&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s5"># Helper function for testing.</span>
    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">)</span>
    <span class="s1">data_rvs </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">standard_normal</span>
    <span class="s2">return </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">density</span><span class="s3">, </span><span class="s1">format</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">,</span>
                            <span class="s1">random_state</span><span class="s3">, </span><span class="s1">data_rvs</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_sprandn_array</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;coo&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s5"># Helper function for testing.</span>
    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">)</span>
    <span class="s1">data_sampler </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">standard_normal</span>
    <span class="s2">return </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">random_array</span><span class="s3">((</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">density</span><span class="s3">=</span><span class="s1">density</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">format</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">,</span>
                                  <span class="s1">random_state</span><span class="s3">=</span><span class="s1">random_state</span><span class="s3">, </span><span class="s1">data_sampler</span><span class="s3">=</span><span class="s1">data_sampler</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestConstructUtils</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cls&quot;</span><span class="s3">, [</span>
        <span class="s1">csc_array</span><span class="s3">, </span><span class="s1">csr_array</span><span class="s3">, </span><span class="s1">coo_array</span><span class="s3">, </span><span class="s1">bsr_array</span><span class="s3">,</span>
        <span class="s1">dia_array</span><span class="s3">, </span><span class="s1">dok_array</span><span class="s3">, </span><span class="s1">lil_array</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_singleton_array_constructor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s1">match</span><span class="s3">=(</span>
                <span class="s4">'scipy sparse array classes do not support '</span>
                <span class="s4">'instantiation from a scalar'</span>
            <span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">cls</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cls&quot;</span><span class="s3">, [</span>
        <span class="s1">csc_matrix</span><span class="s3">, </span><span class="s1">csr_matrix</span><span class="s3">, </span><span class="s1">coo_matrix</span><span class="s3">,</span>
        <span class="s1">bsr_matrix</span><span class="s3">, </span><span class="s1">dia_matrix</span><span class="s3">, </span><span class="s1">lil_matrix</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_singleton_matrix_constructor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        This test is for backwards compatibility post scipy 1.13. 
        The behavior observed here is what is to be expected 
        with the older matrix classes. This test comes with the 
        exception of dok_matrix, which was not working pre scipy1.12 
        (unlike the rest of these). 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">cls</span><span class="s3">(</span><span class="s6">0</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spdiags</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">diags1 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]])</span>
        <span class="s1">diags2 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">,</span><span class="s6">10</span><span class="s3">]])</span>
        <span class="s1">diags3 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">,</span><span class="s6">10</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s6">11</span><span class="s3">,</span><span class="s6">12</span><span class="s3">,</span><span class="s6">13</span><span class="s3">,</span><span class="s6">14</span><span class="s3">,</span><span class="s6">15</span><span class="s3">]])</span>

        <span class="s1">cases </span><span class="s3">= []</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">], </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">], </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">], </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">], </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">,[-</span><span class="s6">1</span><span class="s3">], </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">], </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">,[-</span><span class="s6">1</span><span class="s3">], </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">3</span><span class="s3">], </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">], </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">], </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags1</span><span class="s3">, [</span><span class="s6">2</span><span class="s3">], </span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">4</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">5</span><span class="s3">]]))</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags2</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">], </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">8</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags2</span><span class="s3">, [-</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">], </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, [[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">7</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags2</span><span class="s3">, [</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">3</span><span class="s3">], </span><span class="s6">6</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                              <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">4</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                              <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">5</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                              <span class="s3">[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                              <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">7</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                              <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags3</span><span class="s3">, [-</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">], </span><span class="s6">6</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, [[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">12</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">7</span><span class="s3">,</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">8</span><span class="s3">,</span><span class="s6">14</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">9</span><span class="s3">,</span><span class="s6">15</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">,</span><span class="s6">10</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags3</span><span class="s3">, [-</span><span class="s6">4</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], </span><span class="s6">6</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                 <span class="s3">[</span><span class="s6">11</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                 <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">12</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">10</span><span class="s3">],</span>
                                                 <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                 <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">14</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                 <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">15</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">diags3</span><span class="s3">, [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], </span><span class="s1">len</span><span class="s3">(</span><span class="s1">diags3</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">diags3</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]),</span>
                      <span class="s3">[[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">15</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">10</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]))</span>

        <span class="s2">for </span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">result </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) == </span><span class="s1">m </span><span class="s2">and </span><span class="s1">m </span><span class="s3">== </span><span class="s1">n</span><span class="s3">:</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">spdiags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">result</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">spdiags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">result</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">spdiags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">, (</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_diags</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">10</span><span class="s3">])</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">11</span><span class="s3">, </span><span class="s6">12</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">15</span><span class="s3">])</span>

        <span class="s1">cases </span><span class="s3">= []</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">], </span><span class="s6">0</span><span class="s3">, (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]],[-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [-</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]], [-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]], [</span><span class="s6">3</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">4</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [-</span><span class="s6">4</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]], [-</span><span class="s6">3</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]], [</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">],</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">6</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">],</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">), [[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">7</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">],</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">3</span><span class="s3">], (</span><span class="s6">6</span><span class="s3">, </span><span class="s6">6</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                                     <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                                     <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                                     <span class="s3">[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">4</span><span class="s3">],</span>
                                                     <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">7</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],</span>
                                                     <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">],</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">]], [-</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">11</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                            <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">7</span><span class="s3">,</span><span class="s6">12</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                            <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">8</span><span class="s3">,</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                            <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">9</span><span class="s3">,</span><span class="s6">14</span><span class="s3">],</span>
                                                            <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">,</span><span class="s6">10</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">],</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">],</span><span class="s1">c</span><span class="s3">], [-</span><span class="s6">4</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">6</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), [[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                          <span class="s3">[</span><span class="s6">11</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                          <span class="s3">[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">12</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">8</span><span class="s3">],</span>
                                                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                          <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">14</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">,</span><span class="s6">15</span><span class="s3">]]))</span>

        <span class="s5"># too long arrays are OK</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">],</span><span class="s1">b</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]),</span>
            <span class="s3">[</span><span class="s6">0</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">],</span>
            <span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
            <span class="s3">[[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]]</span>
        <span class="s3">))</span>

        <span class="s5"># scalar case: broadcasting</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">2</span><span class="s3">,</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), [[-</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                                                    <span class="s3">[</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">],</span>
                                                    <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">]]))</span>

        <span class="s2">for </span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">result </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">err_msg </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">d</span><span class="s2">!r} {</span><span class="s1">o</span><span class="s2">!r} {</span><span class="s1">shape</span><span class="s2">!r} {</span><span class="s1">result</span><span class="s2">!r}</span><span class="s4">&quot;</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">o</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(),</span>
                         <span class="s1">result</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s3">(</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
                <span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s4">'__len__'</span><span class="s3">)</span>
                <span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) &lt;= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)):</span>
                <span class="s5"># should be able to find the shape automatically</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">o</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">result</span><span class="s3">,</span>
                             <span class="s1">err_msg</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_diags_default</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">a</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">a</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_diags_default_bad</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_diags_bad</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">10</span><span class="s3">])</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s6">11</span><span class="s3">, </span><span class="s6">12</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">15</span><span class="s3">])</span>

        <span class="s1">cases </span><span class="s3">= []</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">0</span><span class="s3">]], </span><span class="s6">0</span><span class="s3">, (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">],</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">],</span><span class="s1">c</span><span class="s3">,</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">4</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], (</span><span class="s6">6</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">],</span><span class="s1">c</span><span class="s3">,</span><span class="s1">b</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]], [-</span><span class="s6">4</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([], [-</span><span class="s6">4</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">], </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s6">1</span><span class="s3">], [-</span><span class="s6">5</span><span class="s3">], (</span><span class="s6">4</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(([</span><span class="s1">a</span><span class="s3">], </span><span class="s6">0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">d</span><span class="s3">, </span><span class="s1">o</span><span class="s3">, </span><span class="s1">shape </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">o</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">, [[</span><span class="s2">None</span><span class="s3">]], </span><span class="s1">offsets</span><span class="s3">=[</span><span class="s6">0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_diags_vs_diag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Check that</span>
        <span class="s5">#</span>
        <span class="s5">#    diags([a, b, ...], [i, j, ...]) == diag(a, i) + diag(b, j) + ...</span>
        <span class="s5">#</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s6">1234</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">n_diags </span><span class="s2">in </span><span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]:</span>
            <span class="s1">n </span><span class="s3">= </span><span class="s6">1 </span><span class="s3">+ </span><span class="s1">n_diags</span><span class="s3">//</span><span class="s6">2 </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)</span>

            <span class="s1">offsets </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s1">n</span><span class="s3">+</span><span class="s6">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">-</span><span class="s6">1</span><span class="s3">)</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">offsets</span><span class="s3">)</span>
            <span class="s1">offsets </span><span class="s3">= </span><span class="s1">offsets</span><span class="s3">[:</span><span class="s1">n_diags</span><span class="s3">]</span>

            <span class="s1">diagonals </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n </span><span class="s3">- </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">q</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">q </span><span class="s2">in </span><span class="s1">offsets</span><span class="s3">]</span>

            <span class="s1">mat </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">diagonals</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">offsets</span><span class="s3">)</span>
            <span class="s1">dense_mat </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">j</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">j </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">diagonals</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">)])</span>

            <span class="s1">assert_array_almost_equal_nulp</span><span class="s3">(</span><span class="s1">mat</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">dense_mat</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">offsets</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">mat </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">diagonals</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">offsets</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
                <span class="s1">dense_mat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">diagonals</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">offsets</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s3">(</span><span class="s1">mat</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">dense_mat</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_diags_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">([</span><span class="s6">2.2</span><span class="s3">], </span><span class="s1">offsets</span><span class="s3">=[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">int</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]])</span>

    <span class="s2">def </span><span class="s1">test_diags_one_diagonal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">5</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">):</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">k</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(),</span>
                         <span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">([</span><span class="s1">d</span><span class="s3">], </span><span class="s1">offsets</span><span class="s3">=[</span><span class="s1">k</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">test_diags_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">([])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;identity&quot;</span><span class="s3">, [</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye_array</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_identity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">identity</span><span class="s3">):</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">identity</span><span class="s3">(</span><span class="s6">1</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">identity</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]])</span>

        <span class="s1">I </span><span class="s3">= </span><span class="s1">identity</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'int8'</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s4">'dia'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s4">'int8'</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s4">'dia'</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">sparse_formats</span><span class="s3">:</span>
            <span class="s1">I </span><span class="s3">= </span><span class="s1">identity</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;eye&quot;</span><span class="s3">, [</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye_array</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_eye</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">eye</span><span class="s3">):</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">1</span><span class="s3">,</span><span class="s6">1</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">,</span><span class="s6">2</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">,</span><span class="s6">3</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]])</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'int16'</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s4">'int16'</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">m </span><span class="s2">in </span><span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]:</span>
                <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">,</span><span class="s6">6</span><span class="s3">):</span>
                    <span class="s5"># scipy.sparse.eye deviates from np.eye here. np.eye will</span>
                    <span class="s5"># create arrays of all 0's when the diagonal offset is</span>
                    <span class="s5"># greater than the size of the array. For sparse arrays</span>
                    <span class="s5"># this makes less sense, especially as it results in dia</span>
                    <span class="s5"># arrays with negative diagonals. Therefore sp.sparse.eye</span>
                    <span class="s5"># validates that diagonal offsets fall within the shape of</span>
                    <span class="s5"># the array. See gh-18555.</span>
                    <span class="s2">if </span><span class="s3">(</span><span class="s1">k </span><span class="s3">&gt; </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">k </span><span class="s3">&gt; </span><span class="s1">n</span><span class="s3">) </span><span class="s2">or </span><span class="s3">(</span><span class="s1">k </span><span class="s3">&lt; </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">k</span><span class="s3">) &gt; </span><span class="s1">m</span><span class="s3">):</span>
                        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                            <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Offset.*out of bounds&quot;</span>
                        <span class="s3">):</span>
                            <span class="s1">eye</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s1">k</span><span class="s3">)</span>

                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">assert_equal</span><span class="s3">(</span>
                            <span class="s1">eye</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s1">k</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(),</span>
                            <span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s1">k</span><span class="s3">)</span>
                        <span class="s3">)</span>
                        <span class="s2">if </span><span class="s1">m </span><span class="s3">== </span><span class="s1">n</span><span class="s3">:</span>
                            <span class="s1">assert_equal</span><span class="s3">(</span>
                                <span class="s1">eye</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s1">k</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(),</span>
                                <span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s1">k</span><span class="s3">)</span>
                            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;eye&quot;</span><span class="s3">, [</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye_array</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_eye_one</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">eye</span><span class="s3">):</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">1</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]])</span>

        <span class="s1">I </span><span class="s3">= </span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'int8'</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s4">'dia'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s4">'int8'</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s4">'dia'</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">sparse_formats</span><span class="s3">:</span>
            <span class="s1">I </span><span class="s3">= </span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">I</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">]])</span>

    <span class="s2">def </span><span class="s1">test_eye_array_vs_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye_array</span><span class="s3">(</span><span class="s6">3</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_kron</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cases </span><span class="s3">= []</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[-</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">4</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">10</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">6</span><span class="s3">],[</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">14</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">4</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">4</span><span class="s3">,</span><span class="s6">4</span><span class="s3">],[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">8</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">5</span><span class="s3">,</span><span class="s6">8</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.5</span><span class="s3">,</span><span class="s6">0.125</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3.25</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2.5</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>

        <span class="s5"># test all cases with some formats</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">ca </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
                <span class="s1">cb </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
                <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">sparse_formats</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:</span><span class="s6">4</span><span class="s3">]:</span>
                    <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">ca</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
                    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>
                    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
                    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">sparray</span><span class="s3">)</span>

        <span class="s5"># test one case with all formats</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">cases</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">cases</span><span class="s3">[-</span><span class="s6">3</span><span class="s3">]</span>
        <span class="s1">ca </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">cb </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">sparse_formats</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">ca</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">sparray</span><span class="s3">)</span>

        <span class="s5"># check that spmatrix returned when both inputs are spmatrix</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">b</span><span class="s3">), </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">spmatrix</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_kron_ndim_exceptions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'requires 2D input'</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">csr_array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'requires 2D input'</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">csr_array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), [[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]])</span>
        <span class="s5"># no exception if sparse arrays are not input (spmatrix inferred)</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_kron_large</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s6">2</span><span class="s3">**</span><span class="s6">16</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags_array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">offsets</span><span class="s3">=</span><span class="s1">n</span><span class="s3">-</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags_array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">offsets</span><span class="s3">=</span><span class="s6">1</span><span class="s3">-</span><span class="s1">n</span><span class="s3">)</span>

        <span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_kronsum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cases </span><span class="s3">= []</span>

        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[-</span><span class="s6">1</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">4</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">10</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">6</span><span class="s3">],[</span><span class="s6">8</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">14</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">,</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">0</span><span class="s3">],[</span><span class="s6">0</span><span class="s3">,</span><span class="s6">5</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">],[</span><span class="s6">4</span><span class="s3">,-</span><span class="s6">2</span><span class="s3">,</span><span class="s6">8</span><span class="s3">]]))</span>

        <span class="s5"># test all cases with default format</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
                <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">kronsum</span><span class="s3">(</span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">()</span>
                <span class="s1">expected </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">b</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]), </span><span class="s1">a</span><span class="s3">)</span>
                            <span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])))</span>
                <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s5"># check that spmatrix returned when both inputs are spmatrix</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">kronsum</span><span class="s3">(</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">()</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_kronsum_ndim_exceptions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'requires 2D input'</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">kronsum</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">csr_array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">'requires 2D input'</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">kronsum</span><span class="s3">(</span><span class="s1">csr_array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), [[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]])</span>
        <span class="s5"># no exception if sparse arrays are not input (spmatrix inferred)</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">kronsum</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]], [</span><span class="s6">2</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;coo_cls&quot;</span><span class="s3">, [</span><span class="s1">coo_matrix</span><span class="s3">, </span><span class="s1">coo_array</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_vstack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">coo_cls</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_cls</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_cls</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">6</span><span class="s3">]])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">,</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">todok</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">todok</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()],</span>
                                  <span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()],</span>
                                  <span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csc&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_vstack_matrix_or_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]]</span>
        <span class="s1">B </span><span class="s3">= [[</span><span class="s6">5</span><span class="s3">,</span><span class="s6">6</span><span class="s3">]]</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">spmatrix</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_vstack_1d_with_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># fixes gh-21064</span>
        <span class="s1">arr </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]])</span>
        <span class="s1">arr1d </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
        <span class="s1">arr1dcoo </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">]])]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">arr1d</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">6</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">arr1d</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>

        <span class="s5"># check csr specialty stacking code like _stack_along_minor_axis</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">arr</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">6</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">arr1d</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">6</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">arr1dcoo</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">6</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">arr1dcoo</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">arr1d</span><span class="s3">, </span><span class="s1">arr1dcoo</span><span class="s3">]).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;incompatible row dimensions&quot;</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])])</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;incompatible column dimensions&quot;</span><span class="s3">):</span>
            <span class="s1">construct</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;coo_cls&quot;</span><span class="s3">, [</span><span class="s1">coo_matrix</span><span class="s3">, </span><span class="s1">coo_array</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_hstack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">coo_cls</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_cls</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_cls</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">]])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">,</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">todok</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">todok</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()],</span>
                                      <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">,</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()],</span>
                                      <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">,</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_hstack_matrix_or_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]]</span>
        <span class="s1">B </span><span class="s3">= [[</span><span class="s6">5</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">]]</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_array</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">B</span><span class="s3">)]), </span><span class="s1">spmatrix</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;block_array&quot;</span><span class="s3">, (</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">bmat</span><span class="s3">, </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_array</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_block_creation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">block_array</span><span class="s3">):</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">]])</span>
        <span class="s1">C </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">7</span><span class="s3">]])</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">((</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">], [</span><span class="s2">None</span><span class="s3">, </span><span class="s1">C</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">E </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">E</span><span class="s3">, </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">E</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], [</span><span class="s2">None</span><span class="s3">, </span><span class="s1">C</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">E</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">E</span><span class="s3">, </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">E</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">E</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">Z </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">6</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">7</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">B</span><span class="s3">], [</span><span class="s1">C</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">E</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">Z</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s1">E</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()],</span>
                                  <span class="s3">[</span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Z</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">D</span><span class="s3">], [</span><span class="s1">D</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>

        <span class="s5"># test bug reported in gh-5976</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">7</span><span class="s3">]])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">block_array</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">D</span><span class="s3">], [</span><span class="s1">C</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">expected</span><span class="s3">)</span>

        <span class="s5"># test failure cases</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">], [</span><span class="s1">B</span><span class="s3">]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'Got blocks\[1,0\]\.shape\[1\] == 1, expected 2'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()], [</span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'incompatible dimensions for axis 1'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()], [</span><span class="s1">B</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'Mismatching dimensions along axis 1: ({1, 2}|{2, 1})'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">, </span><span class="s1">C</span><span class="s3">]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'Got blocks\[0,1\]\.shape\[0\] == 1, expected 2'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">(), </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsr</span><span class="s3">()]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'Mismatching dimensions along axis 0: ({1, 2}|{2, 1})'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">excinfo</span><span class="s3">:</span>
            <span class="s1">block_array</span><span class="s3">([[</span><span class="s1">A</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">C</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]])</span>
        <span class="s1">excinfo</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'incompatible dimensions for axis 0'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_block_return_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">block </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_array</span>

        <span class="s5"># csr format ensures we hit _compressed_sparse_stack</span>
        <span class="s5"># shape of F,G ensure we hit _stack_along_minor_axis</span>
        <span class="s5"># list version ensure we hit the path with neither helper function</span>
        <span class="s1">Fl</span><span class="s3">, </span><span class="s1">Gl </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], [[</span><span class="s6">7</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">]]</span>
        <span class="s1">Fm</span><span class="s3">, </span><span class="s1">Gm </span><span class="s3">= </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">Fl</span><span class="s3">), </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">Gl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fl</span><span class="s3">], [</span><span class="s1">Gl</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fm</span><span class="s3">], [</span><span class="s1">Gm</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">([[</span><span class="s1">Fm</span><span class="s3">, </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bmat_return_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;This can be removed after sparse matrix is removed&quot;&quot;&quot;</span>
        <span class="s1">bmat </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">bmat</span>
        <span class="s5"># check return type. if any input _is_array output array, else matrix</span>
        <span class="s1">Fl</span><span class="s3">, </span><span class="s1">Gl </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], [[</span><span class="s6">7</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">]]</span>
        <span class="s1">Fm</span><span class="s3">, </span><span class="s1">Gm </span><span class="s3">= </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">Fl</span><span class="s3">), </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">Gl</span><span class="s3">)</span>
        <span class="s1">Fa</span><span class="s3">, </span><span class="s1">Ga </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">Fl</span><span class="s3">), </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">Gl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fa</span><span class="s3">, </span><span class="s1">Ga</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fm</span><span class="s3">, </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fa</span><span class="s3">], [</span><span class="s1">Ga</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fm</span><span class="s3">], [</span><span class="s1">Ga</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fm</span><span class="s3">], [</span><span class="s1">Gm</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Fl</span><span class="s3">], [</span><span class="s1">Gl</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>

        <span class="s5"># type returned by _compressed_sparse_stack (all csr)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Ga</span><span class="s3">, </span><span class="s1">Ga</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">, </span><span class="s1">Ga</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Ga</span><span class="s3">, </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">, </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>
        <span class="s5"># shape is 2x2 so no _stack_along_minor_axis</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fa</span><span class="s3">, </span><span class="s1">Fm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fm</span><span class="s3">, </span><span class="s1">Fm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>

        <span class="s5"># type returned by _compressed_sparse_stack (all csc)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Ga</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csc&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Gm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csc&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>
        <span class="s5"># shape is 2x2 so no _stack_along_minor_axis</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fa</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Fm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Fm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Fm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">()]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>

        <span class="s5"># type returned when mixed input</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gl</span><span class="s3">, </span><span class="s1">Ga</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Ga</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csr&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bmat</span><span class="s3">([[</span><span class="s1">Gm</span><span class="s3">, </span><span class="s1">Gm</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csc&quot;</span><span class="s3">), </span><span class="s1">spmatrix</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail_on_32bit</span><span class="s3">(</span><span class="s4">&quot;Can't create large array for test&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_concatenate_int32_overflow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; test for indptr overflow when concatenating matrices &quot;&quot;&quot;</span>
        <span class="s1">check_free_memory</span><span class="s3">(</span><span class="s6">30000</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s6">33000</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">C </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">_compressed_sparse_stack</span><span class="s3">((</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                                               <span class="s1">return_spmatrix</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diff</span><span class="s3">(</span><span class="s1">C</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">C</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">C</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_block_diag_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; basic test for block_diag &quot;&quot;&quot;</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">],[</span><span class="s6">3</span><span class="s3">,</span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">5</span><span class="s3">],[</span><span class="s6">6</span><span class="s3">]])</span>
        <span class="s1">C </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">7</span><span class="s3">]])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">]])</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">((</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">C</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_block_diag_scalar_1d_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; block_diag with scalar and 1d arguments &quot;&quot;&quot;</span>
        <span class="s5"># one 1d matrix and a scalar</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">], </span><span class="s6">4</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                           <span class="s3">[[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s5"># 1d sparse arrays</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">,</span><span class="s6">0</span><span class="s3">,</span><span class="s6">3</span><span class="s3">])</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">,</span><span class="s6">4</span><span class="s3">])</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                           <span class="s3">[[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]])</span>


    <span class="s2">def </span><span class="s1">test_block_diag_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; block_diag with one matrix &quot;&quot;&quot;</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([[[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([[[</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">]]]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">]]))</span>
        <span class="s5"># just on scalar</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s6">1</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">]]))</span>

    <span class="s2">def </span><span class="s1">test_block_diag_sparse_arrays</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; block_diag with sparse arrays &quot;&quot;&quot;</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]]))</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">]], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">1</span><span class="s3">))</span>
        <span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">4</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">]], </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]).</span><span class="s1">toarray</span><span class="s3">(),</span>
                     <span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]]))</span>

    <span class="s2">def </span><span class="s1">test_block_diag_return_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">A</span><span class="s3">, </span><span class="s1">B </span><span class="s3">= </span><span class="s1">coo_array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]]), </span><span class="s1">coo_matrix</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]])</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">A</span><span class="s3">]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">B</span><span class="s3">, </span><span class="s1">A</span><span class="s3">]), </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">block_diag</span><span class="s3">([</span><span class="s1">B</span><span class="s3">, </span><span class="s1">B</span><span class="s3">]), </span><span class="s1">spmatrix</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_random_sampling</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Simple sanity checks for sparse random sampling.</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">sprand</span><span class="s3">, </span><span class="s1">_sprandn</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">longdouble</span><span class="s3">,</span>
                      <span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">]:</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">t</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">t</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">))</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">nnz</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)</span>

            <span class="s1">x1 </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">4321</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

            <span class="s1">x2 </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">,</span>
                   <span class="s1">random_state</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">4321</span><span class="s3">))</span>

            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">row</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">.</span><span class="s1">row</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">col</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">.</span><span class="s1">col</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">density </span><span class="s2">in </span><span class="s3">[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">]:</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s1">density</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">nnz</span><span class="s3">, </span><span class="s1">int</span><span class="s3">(</span><span class="s1">density </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)))</span>

            <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'coo'</span><span class="s3">, </span><span class="s4">'csc'</span><span class="s3">, </span><span class="s4">'csr'</span><span class="s3">, </span><span class="s4">'lil'</span><span class="s3">]:</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">fmt</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">)</span>

            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s2">lambda</span><span class="s3">: </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">))</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s2">lambda</span><span class="s3">: </span><span class="s1">f</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, -</span><span class="s6">0.1</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_rand</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Simple distributional checks for sparse.rand.</span>
        <span class="s1">random_states </span><span class="s3">= [</span><span class="s2">None</span><span class="s3">, </span><span class="s6">4321</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">()]</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">gen </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">()</span>
            <span class="s1">random_states</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">gen</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">for </span><span class="s1">random_state </span><span class="s2">in </span><span class="s1">random_states</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">sprand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">,</span>
                       <span class="s1">random_state</span><span class="s3">=</span><span class="s1">random_state</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less_equal</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)))</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_randn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Simple distributional checks for sparse.randn.</span>
        <span class="s5"># Statistically, some of these should be negative</span>
        <span class="s5"># and some should be greater than 1.</span>
        <span class="s1">random_states </span><span class="s3">= [</span><span class="s2">None</span><span class="s3">, </span><span class="s6">4321</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">()]</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">gen </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">()</span>
            <span class="s1">random_states</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">gen</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">for </span><span class="s1">rs </span><span class="s2">in </span><span class="s1">random_states</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">_sprandn</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rs</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)))</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)))</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">_sprandn_array</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rs</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)))</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">less</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_random_accept_str_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># anything that np.dtype can convert to a dtype should be accepted</span>
        <span class="s5"># for the dtype</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'d'</span><span class="s3">)</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">random_array</span><span class="s3">((</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'d'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_random_sparse_matrix_returns_correct_number_of_non_zero_elements</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># A 10 x 10 matrix, with density of 12.65%, should have 13 nonzero elements.</span>
        <span class="s5"># 10 x 10 x 0.1265 = 12.65, which should be rounded up to 13, not 12.</span>
        <span class="s1">sparse_matrix </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.1265</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sparse_matrix</span><span class="s3">.</span><span class="s1">count_nonzero</span><span class="s3">(),</span><span class="s6">13</span><span class="s3">)</span>
        <span class="s5"># check random_array</span>
        <span class="s1">sparse_array </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">random_array</span><span class="s3">((</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s1">density</span><span class="s3">=</span><span class="s6">0.1265</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sparse_array</span><span class="s3">.</span><span class="s1">count_nonzero</span><span class="s3">(),</span><span class="s6">13</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">sparse_array</span><span class="s3">, </span><span class="s1">sparray</span><span class="s3">)</span>
        <span class="s5"># check big size</span>
        <span class="s1">shape </span><span class="s3">= (</span><span class="s6">2</span><span class="s3">**</span><span class="s6">33</span><span class="s3">, </span><span class="s6">2</span><span class="s3">**</span><span class="s6">33</span><span class="s3">)</span>
        <span class="s1">sparse_array </span><span class="s3">= </span><span class="s1">construct</span><span class="s3">.</span><span class="s1">random_array</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s6">2.7105e-17</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sparse_array</span><span class="s3">.</span><span class="s1">count_nonzero</span><span class="s3">(),</span><span class="s6">2000</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_diags_array</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Tests of diags_array that do not rely on diags wrapper.&quot;&quot;&quot;</span>
    <span class="s1">diag </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">construct</span><span class="s3">.</span><span class="s1">diags_array</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">))</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">diags_array</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s6">2</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">diags_array</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">, </span><span class="s1">offsets</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">4</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">(),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">diag</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)[:</span><span class="s6">4</span><span class="s3">, :</span><span class="s6">4</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s5"># Offset outside bounds when shape specified</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;.*out of bounds&quot;</span><span class="s3">):</span>
        <span class="s1">construct</span><span class="s3">.</span><span class="s1">diags</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), </span><span class="s6">5</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">4</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))</span>
</pre>
</body>
</html>