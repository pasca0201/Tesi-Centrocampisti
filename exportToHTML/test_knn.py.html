<html>
<head>
<title>test_knn.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_knn.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">config_context</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">impute </span><span class="s0">import </span><span class="s1">KNNImputer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise </span><span class="s0">import </span><span class="s1">nan_euclidean_distances</span><span class="s2">, </span><span class="s1">pairwise_distances</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">neighbors </span><span class="s0">import </span><span class="s1">KNeighborsRegressor</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;weights&quot;</span><span class="s2">, [</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s3">&quot;distance&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_neighbors&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_shape</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">):</span>
    <span class="s5"># Verify the shapes of the imputed matrix for different weights and</span>
    <span class="s5"># number of neighbors.</span>
    <span class="s1">n_rows </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">n_cols </span><span class="s2">= </span><span class="s4">2</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_rows</span><span class="s2">, </span><span class="s1">n_cols</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">)</span>
    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_imputed</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_rows</span><span class="s2">, </span><span class="s1">n_cols</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_default_with_invalid_input</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s5"># Test imputation with default values and invalid input</span>

    <span class="s5"># Test with inf present</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">13</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Input X contains (infinity|NaN)&quot;</span><span class="s2">):</span>
        <span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s5"># Test with inf present in matrix passed in transform()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">13</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">X_fit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">13</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_fit</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Input X contains (infinity|NaN)&quot;</span><span class="s2">):</span>
        <span class="s1">imputer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s5"># Test with missing_values=0 when NaN present</span>
    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;uniform&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">13</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Input X contains NaN&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_removes_all_na_features</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">knn </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">X_transform</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_transform</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>
    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">[:, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]], </span><span class="s1">X_transform</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_zero_nan_imputes_the_same</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s5"># Test with an imputable matrix and compare with different missing_values</span>
    <span class="s1">X_zero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">X_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer_zero </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;uniform&quot;</span><span class="s2">)</span>

    <span class="s1">imputer_nan </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;uniform&quot;</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer_zero</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_zero</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">imputer_zero</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_zero</span><span class="s2">), </span><span class="s1">imputer_nan</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_nan</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_verify</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s5"># Test with an imputable matrix</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">16</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">18</span><span class="s2">, </span><span class="s4">19</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">16</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">18</span><span class="s2">, </span><span class="s4">19</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>

    <span class="s5"># Test when there is not enough neighbors</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s5"># Not enough neighbors, use column mean from training</span>
    <span class="s1">X_impute_value </span><span class="s2">= (</span><span class="s4">20 </span><span class="s2">+ </span><span class="s4">22</span><span class="s2">) / </span><span class="s4">2</span>
    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s1">X_impute_value</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">22</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>

    <span class="s5"># Test when data in fit() and transform() are different</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">16</span><span class="s2">]])</span>

    <span class="s1">X1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s1">na</span><span class="s2">]])</span>

    <span class="s1">X_2_1 </span><span class="s2">= (</span><span class="s4">0 </span><span class="s2">+ </span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">6 </span><span class="s2">+ </span><span class="s4">7 </span><span class="s2">+ </span><span class="s4">8</span><span class="s2">) / </span><span class="s4">5</span>
    <span class="s1">X1_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s1">X_2_1</span><span class="s2">]])</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X1</span><span class="s2">), </span><span class="s1">X1_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_one_n_neighbors</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s1">na</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">14</span><span class="s2">, </span><span class="s4">13</span><span class="s2">]])</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">14</span><span class="s2">, </span><span class="s4">13</span><span class="s2">]])</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_all_samples_are_neighbors</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s1">na</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">14</span><span class="s2">, </span><span class="s4">13</span><span class="s2">]])</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">14</span><span class="s2">, </span><span class="s4">13</span><span class="s2">]])</span>

    <span class="s1">n_neighbors </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] - </span><span class="s4">1</span>
    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>

    <span class="s1">n_neighbors </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">imputer_plus1 </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer_plus1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_weight_uniform</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]])</span>

    <span class="s5"># Test with &quot;uniform&quot; weight (or unweighted)</span>
    <span class="s1">X_imputed_uniform </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed_uniform</span><span class="s2">)</span>

    <span class="s5"># Test with &quot;callable&quot; weight</span>
    <span class="s0">def </span><span class="s1">no_weight</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">return None</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">no_weight</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed_uniform</span><span class="s2">)</span>

    <span class="s5"># Test with &quot;callable&quot; uniform weight</span>
    <span class="s0">def </span><span class="s1">uniform_weight</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">uniform_weight</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed_uniform</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_weight_distance</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]])</span>

    <span class="s5"># Test with &quot;distance&quot; weight</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s3">&quot;euclidean&quot;</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">X_rows_idx </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]</span>
    <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">X_rows_idx</span><span class="s2">, </span><span class="s4">1</span><span class="s2">:], </span><span class="s1">X</span><span class="s2">[</span><span class="s1">X_rows_idx</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">knn_imputed_value </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">:])[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s5"># Manual calculation</span>
    <span class="s1">X_neighbors_idx </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">nan_euclidean_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:</span><span class="s4">2</span><span class="s2">, :], </span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">weights </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[:, </span><span class="s1">X_neighbors_idx</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">manual_imputed_value </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">X_neighbors_idx</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">)</span>

    <span class="s1">X_imputed_distance1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">manual_imputed_value</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s5"># NearestNeighbor calculation</span>
    <span class="s1">X_imputed_distance2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">knn_imputed_value</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed_distance1</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed_distance2</span><span class="s2">)</span>

    <span class="s5"># Test with weights = &quot;distance&quot; and n_neighbors=2</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s5"># neighbors are rows 1, 2, the nan_euclidean_distances are:</span>
    <span class="s1">dist_0_1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s4">3 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">) * ((</span><span class="s4">1 </span><span class="s2">- </span><span class="s4">0</span><span class="s2">) ** </span><span class="s4">2 </span><span class="s2">+ (</span><span class="s4">2 </span><span class="s2">- </span><span class="s4">0</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">dist_0_2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s4">3 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">) * ((</span><span class="s4">2 </span><span class="s2">- </span><span class="s4">0</span><span class="s2">) ** </span><span class="s4">2 </span><span class="s2">+ (</span><span class="s4">3 </span><span class="s2">- </span><span class="s4">0</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">imputed_value </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=[</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist_0_1</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist_0_2</span><span class="s2">])</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">imputed_value</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>

    <span class="s5"># Test with varying missingness patterns</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s5"># Get weights of donor neighbors</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">nan_euclidean_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">r1c1_nbor_dists </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
    <span class="s1">r1c3_nbor_dists </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
    <span class="s1">r1c1_nbor_wt </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">r1c1_nbor_dists</span>
    <span class="s1">r1c3_nbor_wt </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">r1c3_nbor_dists</span>

    <span class="s1">r2c3_nbor_dists </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
    <span class="s1">r2c3_nbor_wt </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">r2c3_nbor_dists</span>

    <span class="s5"># Collect donor values</span>
    <span class="s1">col1_donor_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_invalid</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], </span><span class="s4">1</span><span class="s2">]).</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">col3_donor_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_invalid</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s5"># Final imputed values</span>
    <span class="s1">r1c1_imp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">col1_donor_values</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r1c1_nbor_wt</span><span class="s2">)</span>
    <span class="s1">r1c3_imp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">col3_donor_values</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r1c3_nbor_wt</span><span class="s2">)</span>
    <span class="s1">r2c3_imp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">col3_donor_values</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r2c3_nbor_wt</span><span class="s2">)</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">r1c1_imp</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">r1c3_imp</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">r2c3_imp</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">dist </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s3">&quot;nan_euclidean&quot;</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span>
    <span class="s2">)</span>

    <span class="s5"># Calculate weights</span>
    <span class="s1">r0c3_w </span><span class="s2">= </span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">r1c3_w </span><span class="s2">= </span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">r2c2_w </span><span class="s2">= </span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)]</span>
    <span class="s1">r7c0_w </span><span class="s2">= </span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">7</span><span class="s2">, </span><span class="s4">2</span><span class="s2">:</span><span class="s4">7</span><span class="s2">]</span>

    <span class="s5"># Calculate weighted averages</span>
    <span class="s1">r0c3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r0c3_w</span><span class="s2">)</span>
    <span class="s1">r1c3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r1c3_w</span><span class="s2">)</span>
    <span class="s1">r2c2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), </span><span class="s4">2</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r2c2_w</span><span class="s2">)</span>
    <span class="s1">r7c0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:</span><span class="s4">7</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">r7c0_w</span><span class="s2">)</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">r0c3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">r1c3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">r2c2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">r7c0</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">imputer_comp_wt </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer_comp_wt</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_knn_imputer_callable_metric</span><span class="s2">():</span>
    <span class="s5"># Define callable metric that returns the l1 norm:</span>
    <span class="s0">def </span><span class="s1">custom_callable</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nansum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">y</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">dist</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">10.0</span><span class="s2">]])</span>

    <span class="s1">X_0_3 </span><span class="s2">= (</span><span class="s4">9 </span><span class="s2">+ </span><span class="s4">9</span><span class="s2">) / </span><span class="s4">2</span>
    <span class="s1">X_3_0 </span><span class="s2">= (</span><span class="s4">6 </span><span class="s2">+ </span><span class="s4">4</span><span class="s2">) / </span><span class="s4">2</span>
    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">X_0_3</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s1">X_3_0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">10.0</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s1">imputer </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">custom_callable</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;working_memory&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s5"># Note that we use working_memory=0 to ensure that chunking is tested, even</span>
<span class="s5"># for a small dataset. However, it should raise a UserWarning that we ignore.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore:adhere to working_memory&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_with_simple_example</span><span class="s2">(</span><span class="s1">na</span><span class="s2">, </span><span class="s1">working_memory</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">na</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">r0c1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:</span><span class="s4">6</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">r0c3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">r1c3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">r2c2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">r7c0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>

    <span class="s1">X_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">r0c1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">r0c3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">r1c3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">r2c2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">r7c0</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">working_memory</span><span class="s2">=</span><span class="s1">working_memory</span><span class="s2">):</span>
        <span class="s1">imputer_comp </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">imputer_comp</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;weights&quot;</span><span class="s2">, [</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s3">&quot;distance&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_not_enough_valid_distances</span><span class="s2">(</span><span class="s1">na</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
    <span class="s5"># Samples with needed feature has nan distance</span>
    <span class="s1">X1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">]])</span>
    <span class="s1">X1_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>

    <span class="s1">knn </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X1</span><span class="s2">), </span><span class="s1">X1_imputed</span><span class="s2">)</span>

    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s1">na</span><span class="s2">]])</span>
    <span class="s1">X2_imputed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">X2_imputed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_drops_all_nan_features</span><span class="s2">(</span><span class="s1">na</span><span class="s2">):</span>
    <span class="s1">X1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">na</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
    <span class="s1">knn </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">X1_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X1</span><span class="s2">), </span><span class="s1">X1_expected</span><span class="s2">)</span>

    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">]])</span>
    <span class="s1">X2_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1.5</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">X2_expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;working_memory&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na&quot;</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_distance_weighted_not_enough_neighbors</span><span class="s2">(</span><span class="s1">na</span><span class="s2">, </span><span class="s1">working_memory</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s1">na</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">na</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s1">na</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>

    <span class="s1">dist </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s3">&quot;nan_euclidean&quot;</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span>
    <span class="s2">)</span>

    <span class="s1">X_01 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">])</span>
    <span class="s1">X_11 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">])</span>
    <span class="s1">X_20 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">])</span>
    <span class="s1">X_50 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">weights</span><span class="s2">=</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">dist</span><span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">:</span><span class="s4">5</span><span class="s2">])</span>

    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s1">X_01</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">X_11</span><span class="s2">], [</span><span class="s1">X_20</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s1">X_50</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>

    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">working_memory</span><span class="s2">=</span><span class="s1">working_memory</span><span class="s2">):</span>
        <span class="s1">knn_3 </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn_3</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>

        <span class="s1">knn_4 </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;distance&quot;</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">knn_4</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;na, allow_nan&quot;</span><span class="s2">, [(-</span><span class="s4">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_knn_tags</span><span class="s2">(</span><span class="s1">na</span><span class="s2">, </span><span class="s1">allow_nan</span><span class="s2">):</span>
    <span class="s1">knn </span><span class="s2">= </span><span class="s1">KNNImputer</span><span class="s2">(</span><span class="s1">missing_values</span><span class="s2">=</span><span class="s1">na</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">_get_tags</span><span class="s2">()[</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">] == </span><span class="s1">allow_nan</span>
</pre>
</body>
</html>