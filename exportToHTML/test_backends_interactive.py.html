<html>
<head>
<title>test_backends_interactive.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backends_interactive.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">importlib</span>
<span class="s0">import </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">signal</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">tempfile</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request</span>

<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_c_internal_utils</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_tools </span><span class="s0">import </span><span class="s1">ToolToggleBase</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">subprocess_run_helper </span><span class="s0">as </span><span class="s1">_run_helper</span><span class="s2">, </span><span class="s1">is_ci_environment</span>


<span class="s0">class </span><span class="s1">_WaitForStringPopen</span><span class="s2">(</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">Popen</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    A Popen that passes flags that allow triggering KeyboardInterrupt. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'win32'</span><span class="s2">:</span>
            <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'creationflags'</span><span class="s2">] = </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CREATE_NEW_CONSOLE</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s2">*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">,</span>
            <span class="s5"># Force Agg so that each test can switch to its desired backend.</span>
            <span class="s1">env</span><span class="s2">={**</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">, </span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;Agg&quot;</span><span class="s2">, </span><span class="s4">&quot;SOURCE_DATE_EPOCH&quot;</span><span class="s2">: </span><span class="s4">&quot;0&quot;</span><span class="s2">},</span>
            <span class="s1">stdout</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">PIPE</span><span class="s2">, </span><span class="s1">universal_newlines</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">wait_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">terminator</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Read until the terminator is reached.&quot;&quot;&quot;</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s4">''</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">c</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span>
                    <span class="s4">f'Subprocess died before emitting expected </span><span class="s0">{</span><span class="s1">terminator</span><span class="s0">!r}</span><span class="s4">'</span><span class="s2">)</span>
            <span class="s1">buf </span><span class="s2">+= </span><span class="s1">c</span>
            <span class="s0">if </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">terminator</span><span class="s2">):</span>
                <span class="s0">return</span>


<span class="s5"># Minimal smoke-testing of the backends for which the dependencies are</span>
<span class="s5"># PyPI-installable on CI.  They are not available for all tested Python</span>
<span class="s5"># versions so we don't fail on missing backends.</span>

<span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">lru_cache</span>
<span class="s0">def </span><span class="s1">_get_available_interactive_backends</span><span class="s2">():</span>
    <span class="s1">_is_linux_and_display_invalid </span><span class="s2">= (</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;linux&quot; </span><span class="s0">and</span>
                                     <span class="s0">not </span><span class="s1">_c_internal_utils</span><span class="s2">.</span><span class="s1">display_is_valid</span><span class="s2">())</span>
    <span class="s1">envs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">deps</span><span class="s2">, </span><span class="s1">env </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">*[([</span><span class="s1">qt_api</span><span class="s2">],</span>
               <span class="s2">{</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;qtagg&quot;</span><span class="s2">, </span><span class="s4">&quot;QT_API&quot;</span><span class="s2">: </span><span class="s1">qt_api</span><span class="s2">})</span>
              <span class="s0">for </span><span class="s1">qt_api </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;PyQt6&quot;</span><span class="s2">, </span><span class="s4">&quot;PySide6&quot;</span><span class="s2">, </span><span class="s4">&quot;PyQt5&quot;</span><span class="s2">, </span><span class="s4">&quot;PySide2&quot;</span><span class="s2">]],</span>
            <span class="s2">*[([</span><span class="s1">qt_api</span><span class="s2">, </span><span class="s4">&quot;cairocffi&quot;</span><span class="s2">],</span>
               <span class="s2">{</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;qtcairo&quot;</span><span class="s2">, </span><span class="s4">&quot;QT_API&quot;</span><span class="s2">: </span><span class="s1">qt_api</span><span class="s2">})</span>
              <span class="s0">for </span><span class="s1">qt_api </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;PyQt6&quot;</span><span class="s2">, </span><span class="s4">&quot;PySide6&quot;</span><span class="s2">, </span><span class="s4">&quot;PyQt5&quot;</span><span class="s2">, </span><span class="s4">&quot;PySide2&quot;</span><span class="s2">]],</span>
            <span class="s2">*[([</span><span class="s4">&quot;cairo&quot;</span><span class="s2">, </span><span class="s4">&quot;gi&quot;</span><span class="s2">], {</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">f&quot;gtk</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}{</span><span class="s1">renderer</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">})</span>
              <span class="s0">for </span><span class="s1">version </span><span class="s0">in </span><span class="s2">[</span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">] </span><span class="s0">for </span><span class="s1">renderer </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;agg&quot;</span><span class="s2">, </span><span class="s4">&quot;cairo&quot;</span><span class="s2">]],</span>
            <span class="s2">([</span><span class="s4">&quot;tkinter&quot;</span><span class="s2">], {</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;tkagg&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;wx&quot;</span><span class="s2">], {</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;wx&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;wx&quot;</span><span class="s2">], {</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;wxagg&quot;</span><span class="s2">}),</span>
            <span class="s2">([</span><span class="s4">&quot;matplotlib.backends._macosx&quot;</span><span class="s2">], {</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;macosx&quot;</span><span class="s2">}),</span>
    <span class="s2">]:</span>
        <span class="s1">reason </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">missing </span><span class="s2">= [</span><span class="s1">dep </span><span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s1">deps </span><span class="s0">if not </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">_is_linux_and_display_invalid</span><span class="s2">:</span>
            <span class="s1">reason </span><span class="s2">= </span><span class="s4">&quot;$DISPLAY and $WAYLAND_DISPLAY are unset&quot;</span>
        <span class="s0">elif </span><span class="s1">missing</span><span class="s2">:</span>
            <span class="s1">reason </span><span class="s2">= </span><span class="s4">&quot;{} cannot be imported&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">missing</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">] == </span><span class="s4">'macosx' </span><span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">'TF_BUILD'</span><span class="s2">):</span>
            <span class="s1">reason </span><span class="s2">= </span><span class="s4">&quot;macosx backend fails on Azure&quot;</span>
        <span class="s0">elif </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'gtk'</span><span class="s2">):</span>
            <span class="s0">import </span><span class="s1">gi  </span><span class="s5"># type: ignore</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">][</span><span class="s6">3</span><span class="s2">]</span>
            <span class="s1">repo </span><span class="s2">= </span><span class="s1">gi</span><span class="s2">.</span><span class="s1">Repository</span><span class="s2">.</span><span class="s1">get_default</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s4">f'</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s4">.0' </span><span class="s0">not in </span><span class="s1">repo</span><span class="s2">.</span><span class="s1">enumerate_versions</span><span class="s2">(</span><span class="s4">'Gtk'</span><span class="s2">):</span>
                <span class="s1">reason </span><span class="s2">= </span><span class="s4">&quot;no usable GTK bindings&quot;</span>
        <span class="s1">marks </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">reason</span><span class="s2">:</span>
            <span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">f&quot;Skipping </span><span class="s0">{</span><span class="s1">env</span><span class="s0">} </span><span class="s4">because </span><span class="s0">{</span><span class="s1">reason</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'wx'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'darwin'</span><span class="s2">:</span>
            <span class="s5"># ignore on macosx because that's currently broken (github #16849)</span>
            <span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">'github #16849'</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s2">(</span><span class="s1">env</span><span class="s2">[</span><span class="s4">'MPLBACKEND'</span><span class="s2">] == </span><span class="s4">'tkagg' </span><span class="s0">and</span>
              <span class="s2">(</span><span class="s4">'TF_BUILD' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ </span><span class="s0">or </span><span class="s4">'GITHUB_ACTION' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">) </span><span class="s0">and</span>
              <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'darwin' </span><span class="s0">and</span>
              <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] &lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">11</span><span class="s2">)</span>
              <span class="s2">):</span>
            <span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(  </span><span class="s5"># https://github.com/actions/setup-python/issues/649</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">'Tk version mismatch on Azure macOS CI'</span><span class="s2">))</span>
        <span class="s1">envs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(({**</span><span class="s1">env</span><span class="s2">, </span><span class="s4">'BACKEND_DEPS'</span><span class="s2">: </span><span class="s4">','</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">deps</span><span class="s2">)}, </span><span class="s1">marks</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">envs</span>


<span class="s0">def </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">():</span>
    <span class="s5"># We re-create this because some of the callers below might modify the markers.</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">({**</span><span class="s1">env</span><span class="s2">}, </span><span class="s1">marks</span><span class="s2">=[*</span><span class="s1">marks</span><span class="s2">],</span>
                         <span class="s1">id</span><span class="s2">=</span><span class="s4">'-'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s4">=</span><span class="s0">{</span><span class="s1">v</span><span class="s0">}</span><span class="s4">' </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">env</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()))</span>
            <span class="s0">for </span><span class="s1">env</span><span class="s2">, </span><span class="s1">marks </span><span class="s0">in </span><span class="s1">_get_available_interactive_backends</span><span class="s2">()]</span>


<span class="s5"># Reasonable safe values for slower CI/Remote and local architectures.</span>
<span class="s1">_test_timeout </span><span class="s2">= </span><span class="s6">120 </span><span class="s0">if </span><span class="s1">is_ci_environment</span><span class="s2">() </span><span class="s0">else </span><span class="s6">20</span>


<span class="s0">def </span><span class="s1">_test_toolbar_button_la_mode_icon</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">):</span>
    <span class="s5"># test a toolbar button icon using an image in LA mode (GH issue 25174)</span>
    <span class="s5"># create an icon in LA mode</span>
    <span class="s0">with </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">TemporaryDirectory</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tempdir</span><span class="s2">:</span>
        <span class="s1">img </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">new</span><span class="s2">(</span><span class="s4">&quot;LA&quot;</span><span class="s2">, (</span><span class="s6">26</span><span class="s2">, </span><span class="s6">26</span><span class="s2">))</span>
        <span class="s1">tmp_img_path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tempdir</span><span class="s2">, </span><span class="s4">&quot;test_la_icon.png&quot;</span><span class="s2">)</span>
        <span class="s1">img</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">tmp_img_path</span><span class="s2">)</span>

        <span class="s0">class </span><span class="s1">CustomTool</span><span class="s2">(</span><span class="s1">ToolToggleBase</span><span class="s2">):</span>
            <span class="s1">image </span><span class="s2">= </span><span class="s1">tmp_img_path</span>
            <span class="s1">description </span><span class="s2">= </span><span class="s4">&quot;&quot;  </span><span class="s5"># gtk3 backend does not allow None</span>

        <span class="s1">toolmanager </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span>
        <span class="s1">toolbar </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolbar</span>
        <span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">add_tool</span><span class="s2">(</span><span class="s4">&quot;test&quot;</span><span class="s2">, </span><span class="s1">CustomTool</span><span class="s2">)</span>
        <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">add_tool</span><span class="s2">(</span><span class="s4">&quot;test&quot;</span><span class="s2">, </span><span class="s4">&quot;group&quot;</span><span class="s2">)</span>


<span class="s5"># The source of this function gets extracted and run in another process, so it</span>
<span class="s5"># must be fully self-contained.</span>
<span class="s5"># Using a timer not only allows testing of timers (on other backends), but is</span>
<span class="s5"># also necessary on gtk3 and wx, where directly processing a KeyEvent() for &quot;q&quot;</span>
<span class="s5"># from draw_event causes breakage as the canvas widget gets deleted too early.</span>
<span class="s0">def </span><span class="s1">_test_interactive_impl</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span>
    <span class="s0">import </span><span class="s1">io</span>
    <span class="s0">import </span><span class="s1">json</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s0">import </span><span class="s1">pytest</span>

    <span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
    <span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s1">KeyEvent</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span>
        <span class="s4">&quot;webagg.open_in_browser&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s4">&quot;webagg.port_retries&quot;</span><span class="s2">: </span><span class="s6">1</span><span class="s2">,</span>
    <span class="s2">})</span>

    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">json</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]))</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;backend&quot;</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;agg&quot;</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s4">&quot;gtk&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">)):</span>
        <span class="s5"># Force interactive framework setup.</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

        <span class="s5"># Check that we cannot switch to a backend using another interactive</span>
        <span class="s5"># framework, but can switch to a backend using cairo instead of agg,</span>
        <span class="s5"># or a non-interactive backend.  In the first case, we use tkagg as</span>
        <span class="s5"># the &quot;other&quot; interactive backend as it is (essentially) guaranteed</span>
        <span class="s5"># to be present.  Moreover, don't test switching away from gtk3 (as</span>
        <span class="s5"># Gtk.main_level() is not set up at this point yet) and webagg (which</span>
        <span class="s5"># uses no interactive framework).</span>

        <span class="s0">if </span><span class="s1">backend </span><span class="s2">!= </span><span class="s4">&quot;tkagg&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">):</span>
                <span class="s1">mpl</span><span class="s2">.</span><span class="s1">use</span><span class="s2">(</span><span class="s4">&quot;tkagg&quot;</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">check_alt_backend</span><span class="s2">(</span><span class="s1">alt_backend</span><span class="s2">):</span>
            <span class="s1">mpl</span><span class="s2">.</span><span class="s1">use</span><span class="s2">(</span><span class="s1">alt_backend</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">).</span><span class="s1">__module__ </span><span class="s2">==</span>
                    <span class="s4">f&quot;matplotlib.backends.backend_</span><span class="s0">{</span><span class="s1">alt_backend</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">&quot;all&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s4">&quot;cairocffi&quot;</span><span class="s2">):</span>
            <span class="s1">check_alt_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">[:-</span><span class="s6">3</span><span class="s2">] + </span><span class="s4">&quot;cairo&quot;</span><span class="s2">)</span>
        <span class="s1">check_alt_backend</span><span class="s2">(</span><span class="s4">&quot;svg&quot;</span><span class="s2">)</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">use</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">).</span><span class="s1">__module__ </span><span class="s2">== </span><span class="s4">f&quot;matplotlib.backends.backend_</span><span class="s0">{</span><span class="s1">backend</span><span class="s0">}</span><span class="s4">&quot;</span>

    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">get_window_title</span><span class="s2">() == </span><span class="s4">&quot;Figure 1&quot;</span>

    <span class="s0">if </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;toolbar&quot;</span><span class="s2">] == </span><span class="s4">&quot;toolmanager&quot;</span><span class="s2">:</span>
        <span class="s5"># test toolbar button icon LA mode see GH issue 25174</span>
        <span class="s1">_test_toolbar_button_la_mode_icon</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">:  </span><span class="s5"># i.e toolbar2.</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">.</span><span class="s1">draw_rubberband</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s6">1.</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2.</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>

    <span class="s1">timer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">new_timer</span><span class="s2">(</span><span class="s6">1.</span><span class="s2">)  </span><span class="s5"># Test that floats are cast to int.</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">add_callback</span><span class="s2">(</span><span class="s1">KeyEvent</span><span class="s2">(</span><span class="s4">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s4">&quot;q&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">)</span>
    <span class="s5"># Trigger quitting upon draw.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s4">&quot;draw_event&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">event</span><span class="s2">: </span><span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">())</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s4">&quot;close_event&quot;</span><span class="s2">, </span><span class="s1">print</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'png'</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>

    <span class="s5"># Ensure that the window is really closed.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s6">0.5</span><span class="s2">)</span>

    <span class="s5"># Test that saving works after interactive window is closed, but the figure</span>
    <span class="s5"># is not deleted.</span>
    <span class="s1">result_after </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">result_after</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'png'</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'qt5'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'darwin'</span><span class="s2">:</span>
        <span class="s5"># FIXME: This should be enabled everywhere once Qt5 is fixed on macOS</span>
        <span class="s5"># to not resize incorrectly.</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">() == </span><span class="s1">result_after</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">())</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;toolbar&quot;</span><span class="s2">, [</span><span class="s4">&quot;toolbar2&quot;</span><span class="s2">, </span><span class="s4">&quot;toolmanager&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">flaky</span><span class="s2">(</span><span class="s1">reruns</span><span class="s2">=</span><span class="s6">3</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_interactive_backend</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">toolbar</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">] == </span><span class="s4">&quot;macosx&quot;</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">toolbar </span><span class="s2">== </span><span class="s4">&quot;toolmanager&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;toolmanager is not implemented for macosx.&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">] == </span><span class="s4">&quot;wx&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;wx backend is deprecated; tests failed on appveyor&quot;</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">proc </span><span class="s2">= </span><span class="s1">_run_helper</span><span class="s2">(</span>
            <span class="s1">_test_interactive_impl</span><span class="s2">,</span>
            <span class="s1">json</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">({</span><span class="s4">&quot;toolbar&quot;</span><span class="s2">: </span><span class="s1">toolbar</span><span class="s2">}),</span>
            <span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">,</span>
            <span class="s1">extra_env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError </span><span class="s0">as </span><span class="s1">err</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span>
            <span class="s4">&quot;Subprocess failed to test intended behavior</span><span class="s0">\n</span><span class="s4">&quot;</span>
            <span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">stderr</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s4">&quot;CloseEvent&quot;</span><span class="s2">) == </span><span class="s6">1</span>


<span class="s0">def </span><span class="s1">_test_thread_impl</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">futures </span><span class="s0">import </span><span class="s1">ThreadPoolExecutor</span>

    <span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
    <span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span>
        <span class="s4">&quot;webagg.open_in_browser&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s4">&quot;webagg.port_retries&quot;</span><span class="s2">: </span><span class="s6">1</span><span class="s2">,</span>
    <span class="s2">})</span>

    <span class="s5"># Test artist creation and drawing does not crash from thread</span>
    <span class="s5"># No other guarantees!</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s5"># plt.pause needed vs plt.show(block=False) at least on toolbar2-tkagg</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s6">0.5</span><span class="s2">)</span>

    <span class="s1">future </span><span class="s2">= </span><span class="s1">ThreadPoolExecutor</span><span class="s2">().</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">, [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">6</span><span class="s2">])</span>
    <span class="s1">future</span><span class="s2">.</span><span class="s1">result</span><span class="s2">()  </span><span class="s5"># Joins the thread; rethrows any exception.</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s4">&quot;close_event&quot;</span><span class="s2">, </span><span class="s1">print</span><span class="s2">)</span>
    <span class="s1">future </span><span class="s2">= </span><span class="s1">ThreadPoolExecutor</span><span class="s2">().</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s6">0.5</span><span class="s2">)  </span><span class="s5"># flush_events fails here on at least Tkagg (bpo-41176)</span>
    <span class="s1">future</span><span class="s2">.</span><span class="s1">result</span><span class="s2">()  </span><span class="s5"># Joins the thread; rethrows any exception.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()  </span><span class="s5"># backend is responsible for flushing any events here</span>
    <span class="s0">if </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;backend&quot;</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;wx&quot;</span><span class="s2">):</span>
        <span class="s5"># TODO: debug why WX needs this only on py &gt;= 3.8</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">flush_events</span><span class="s2">()</span>


<span class="s1">_thread_safe_backends </span><span class="s2">= </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">()</span>
<span class="s5"># Known unsafe backends. Remove the xfails if they start to pass!</span>
<span class="s0">for </span><span class="s1">param </span><span class="s0">in </span><span class="s1">_thread_safe_backends</span><span class="s2">:</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">param</span><span class="s2">.</span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s4">&quot;cairo&quot; </span><span class="s0">in </span><span class="s1">backend</span><span class="s2">:</span>
        <span class="s5"># Cairo backends save a cairo_t on the graphics context, and sharing</span>
        <span class="s5"># these is not threadsafe.</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;wx&quot;</span><span class="s2">:</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;macosx&quot;</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">parse</span>
        <span class="s1">mac_ver </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">mac_ver</span><span class="s2">()[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s5"># Note, macOS Big Sur is both 11 and 10.16, depending on SDK that</span>
        <span class="s5"># Python was compiled against.</span>
        <span class="s0">if </span><span class="s1">mac_ver </span><span class="s0">and </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">mac_ver</span><span class="s2">) &lt; </span><span class="s1">parse</span><span class="s2">(</span><span class="s4">'10.16'</span><span class="s2">):</span>
            <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">TimeoutExpired</span><span class="s2">,</span>
                                  <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">param</span><span class="s2">.</span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;QT_API&quot;</span><span class="s2">) == </span><span class="s4">&quot;PySide2&quot;</span><span class="s2">:</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;tkagg&quot; </span><span class="s0">and </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">python_implementation</span><span class="s2">() != </span><span class="s4">'CPython'</span><span class="s2">:</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s4">'PyPy does not support Tkinter threading: '</span>
                       <span class="s4">'https://foss.heptapod.net/pypy/pypy/-/issues/1929'</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s2">(</span><span class="s1">backend </span><span class="s2">== </span><span class="s4">'tkagg' </span><span class="s0">and</span>
          <span class="s2">(</span><span class="s4">'TF_BUILD' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ </span><span class="s0">or </span><span class="s4">'GITHUB_ACTION' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">) </span><span class="s0">and</span>
          <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'darwin' </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] &lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">11</span><span class="s2">)):</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(  </span><span class="s5"># https://github.com/actions/setup-python/issues/649</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s4">'Tk version mismatch on Azure macOS CI'</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_thread_safe_backends</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">flaky</span><span class="s2">(</span><span class="s1">reruns</span><span class="s2">=</span><span class="s6">3</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_interactive_thread_safety</span><span class="s2">(</span><span class="s1">env</span><span class="s2">):</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_test_thread_impl</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">, </span><span class="s1">extra_env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s4">&quot;CloseEvent&quot;</span><span class="s2">) == </span><span class="s6">1</span>


<span class="s0">def </span><span class="s1">_impl_test_lazy_auto_backend_selection</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">matplotlib</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s5"># just importing pyplot should not be enough to trigger resolution</span>
    <span class="s1">bk </span><span class="s2">= </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">_get</span><span class="s2">(</span><span class="s4">'backend'</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bk</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">_backend_mod </span><span class="s0">is None</span>
    <span class="s5"># but actually plotting should</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s6">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">_backend_mod </span><span class="s0">is not None</span>
    <span class="s1">bk </span><span class="s2">= </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">_get</span><span class="s2">(</span><span class="s4">'backend'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bk</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_lazy_auto_backend_selection</span><span class="s2">():</span>
    <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_impl_test_lazy_auto_backend_selection</span><span class="s2">,</span>
                <span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_implqt5agg</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_qt5agg  </span><span class="s5"># noqa</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s0">assert </span><span class="s4">'PyQt6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'pyside6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'PyQt5' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules </span><span class="s0">or </span><span class="s4">'pyside2' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>


<span class="s0">def </span><span class="s1">_implcairo</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_qt5cairo  </span><span class="s5"># noqa</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s0">assert </span><span class="s4">'PyQt6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'pyside6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'PyQt5' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules </span><span class="s0">or </span><span class="s4">'pyside2' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>


<span class="s0">def </span><span class="s1">_implcore</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_qt5  </span><span class="s5"># noqa</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s0">assert </span><span class="s4">'PyQt6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'pyside6' </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>
    <span class="s0">assert </span><span class="s4">'PyQt5' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules </span><span class="s0">or </span><span class="s4">'pyside2' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>


<span class="s0">def </span><span class="s1">test_qt5backends_uses_qt5</span><span class="s2">():</span>
    <span class="s1">qt5_bindings </span><span class="s2">= [</span>
        <span class="s1">dep </span><span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'PyQt5'</span><span class="s2">, </span><span class="s4">'pyside2'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">) </span><span class="s0">is not None</span>
    <span class="s2">]</span>
    <span class="s1">qt6_bindings </span><span class="s2">= [</span>
        <span class="s1">dep </span><span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'PyQt6'</span><span class="s2">, </span><span class="s4">'pyside6'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">) </span><span class="s0">is not None</span>
    <span class="s2">]</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">qt5_bindings</span><span class="s2">) == </span><span class="s6">0 </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">qt6_bindings</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'need both QT6 and QT5 bindings'</span><span class="s2">)</span>
    <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_implqt5agg</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s4">'pycairo'</span><span class="s2">) </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_implcairo</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>
    <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_implcore</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_impl_missing</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">sys</span>
    <span class="s5"># Simulate uninstalled</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s4">&quot;PyQt6&quot;</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s4">&quot;PyQt5&quot;</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s4">&quot;PySide2&quot;</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s4">&quot;PySide6&quot;</span><span class="s2">] = </span><span class="s0">None</span>

    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Failed to import any of the following Qt&quot;</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">switch_backend</span><span class="s2">(</span><span class="s4">&quot;qtagg&quot;</span><span class="s2">)</span>
    <span class="s5"># Specifically ensure that Pyside6/Pyqt6 are not in the error message for qt5agg</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;^(?:(?!(PySide6|PyQt6)).)*$&quot;</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">switch_backend</span><span class="s2">(</span><span class="s4">&quot;qt5agg&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_qt_missing</span><span class="s2">():</span>
    <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_impl_missing</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_impl_test_cross_Qt_imports</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">importlib</span>
    <span class="s0">import </span><span class="s1">sys</span>
    <span class="s0">import </span><span class="s1">warnings</span>

    <span class="s1">_</span><span class="s2">, </span><span class="s1">host_binding</span><span class="s2">, </span><span class="s1">mpl_binding </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span>
    <span class="s5"># import the mpl binding.  This will force us to use that binding</span>
    <span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">mpl_binding</span><span class="s0">}</span><span class="s4">.QtCore'</span><span class="s2">)</span>
    <span class="s1">mpl_binding_qwidgets </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">mpl_binding</span><span class="s0">}</span><span class="s4">.QtWidgets'</span><span class="s2">)</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_qt</span>
    <span class="s1">host_qwidgets </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">host_binding</span><span class="s0">}</span><span class="s4">.QtWidgets'</span><span class="s2">)</span>

    <span class="s1">host_app </span><span class="s2">= </span><span class="s1">host_qwidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">([</span><span class="s4">&quot;mpl testing&quot;</span><span class="s2">])</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">=</span><span class="s4">r&quot;.*Mixing Qt major.*&quot;</span><span class="s2">,</span>
                            <span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
    <span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_qt</span><span class="s2">.</span><span class="s1">_create_qApp</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">qt5_and_qt6_pairs</span><span class="s2">():</span>
    <span class="s1">qt5_bindings </span><span class="s2">= [</span>
        <span class="s1">dep </span><span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'PyQt5'</span><span class="s2">, </span><span class="s4">'PySide2'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">) </span><span class="s0">is not None</span>
    <span class="s2">]</span>
    <span class="s1">qt6_bindings </span><span class="s2">= [</span>
        <span class="s1">dep </span><span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'PyQt6'</span><span class="s2">, </span><span class="s4">'PySide6'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">find_spec</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">) </span><span class="s0">is not None</span>
    <span class="s2">]</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">qt5_bindings</span><span class="s2">) == </span><span class="s6">0 </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">qt6_bindings</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">,</span>
                           <span class="s1">marks</span><span class="s2">=[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'need both QT6 and QT5 bindings'</span><span class="s2">)])</span>
        <span class="s0">return</span>

    <span class="s0">for </span><span class="s1">qt5 </span><span class="s0">in </span><span class="s1">qt5_bindings</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">qt6 </span><span class="s0">in </span><span class="s1">qt6_bindings</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">pair </span><span class="s0">in </span><span class="s2">([</span><span class="s1">qt5</span><span class="s2">, </span><span class="s1">qt6</span><span class="s2">], [</span><span class="s1">qt6</span><span class="s2">, </span><span class="s1">qt5</span><span class="s2">]):</span>
                <span class="s0">yield </span><span class="s1">pair</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'host, mpl'</span><span class="s2">, [*</span><span class="s1">qt5_and_qt6_pairs</span><span class="s2">()])</span>
<span class="s0">def </span><span class="s1">test_cross_Qt_imports</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">mpl</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">proc </span><span class="s2">= </span><span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_impl_test_cross_Qt_imports</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">mpl</span><span class="s2">,</span>
                           <span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError </span><span class="s0">as </span><span class="s1">ex</span><span class="s2">:</span>
        <span class="s5"># We do try to warn the user they are doing something that we do not</span>
        <span class="s5"># expect to work, so we're going to ignore if the subprocess crashes or</span>
        <span class="s5"># is killed, and just check that the warning is printed.</span>
        <span class="s1">stderr </span><span class="s2">= </span><span class="s1">ex</span><span class="s2">.</span><span class="s1">stderr</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">stderr </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">stderr</span>
    <span class="s0">assert </span><span class="s4">&quot;Mixing Qt major versions may not work as expected.&quot; </span><span class="s0">in </span><span class="s1">stderr</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s4">'TF_BUILD' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;this test fails an azure for unknown reasons&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;win32&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Cannot send SIGINT on Windows.&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_webagg</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;tornado&quot;</span><span class="s2">)</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">Popen</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">&quot;-c&quot;</span><span class="s2">,</span>
         <span class="s1">inspect</span><span class="s2">.</span><span class="s1">getsource</span><span class="s2">(</span><span class="s1">_test_interactive_impl</span><span class="s2">)</span>
         <span class="s2">+ </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">_test_interactive_impl()&quot;</span><span class="s2">, </span><span class="s4">&quot;{}&quot;</span><span class="s2">],</span>
        <span class="s1">env</span><span class="s2">={**</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">, </span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">: </span><span class="s4">&quot;webagg&quot;</span><span class="s2">, </span><span class="s4">&quot;SOURCE_DATE_EPOCH&quot;</span><span class="s2">: </span><span class="s4">&quot;0&quot;</span><span class="s2">})</span>
    <span class="s1">url </span><span class="s2">= </span><span class="s4">f'http://</span><span class="s0">{</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;webagg.address&quot;</span><span class="s2">]</span><span class="s0">}</span><span class="s4">:</span><span class="s0">{</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;webagg.port&quot;</span><span class="s2">]</span><span class="s0">}</span><span class="s4">'</span>
    <span class="s1">timeout </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">perf_counter</span><span class="s2">() + </span><span class="s1">_test_timeout</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">retcode </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">poll</span><span class="s2">()</span>
                <span class="s5"># check that the subprocess for the server is not dead</span>
                <span class="s0">assert </span><span class="s1">retcode </span><span class="s0">is None</span>
                <span class="s1">conn </span><span class="s2">= </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request</span><span class="s2">.</span><span class="s1">urlopen</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>
                <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">error</span><span class="s2">.</span><span class="s1">URLError</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">time</span><span class="s2">.</span><span class="s1">perf_counter</span><span class="s2">() &gt; </span><span class="s1">timeout</span><span class="s2">:</span>
                    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s4">&quot;Failed to connect to the webagg server.&quot;</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">continue</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">send_signal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGINT</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">) == </span><span class="s6">0</span>
    <span class="s0">finally</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">poll</span><span class="s2">() </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">proc</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_lazy_headless</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">os</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s1">backend</span><span class="s2">, </span><span class="s1">deps </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
    <span class="s1">deps </span><span class="s2">= </span><span class="s1">deps</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">','</span><span class="s2">)</span>

    <span class="s5"># make it look headless</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">'DISPLAY'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">'WAYLAND_DISPLAY'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s1">deps</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">dep </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>

    <span class="s5"># we should fast-track to Agg</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">get_backend</span><span class="s2">() == </span><span class="s4">'agg'</span>
    <span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s1">deps</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">dep </span><span class="s0">not in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>

    <span class="s5"># make sure we really have dependencies installed</span>
    <span class="s0">for </span><span class="s1">dep </span><span class="s0">in </span><span class="s1">deps</span><span class="s2">:</span>
        <span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">dep </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span>

    <span class="s5"># try to switch and make sure we fail with ImportError</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">switch_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;linux&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;this a linux-only test&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_lazy_linux_headless</span><span class="s2">(</span><span class="s1">env</span><span class="s2">):</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">_run_helper</span><span class="s2">(</span>
        <span class="s1">_lazy_headless</span><span class="s2">,</span>
        <span class="s1">env</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">'MPLBACKEND'</span><span class="s2">), </span><span class="s1">env</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;BACKEND_DEPS&quot;</span><span class="s2">),</span>
        <span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">,</span>
        <span class="s1">extra_env</span><span class="s2">={**</span><span class="s1">env</span><span class="s2">, </span><span class="s4">'DISPLAY'</span><span class="s2">: </span><span class="s4">''</span><span class="s2">, </span><span class="s4">'WAYLAND_DISPLAY'</span><span class="s2">: </span><span class="s4">''</span><span class="s2">}</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_test_number_of_draws_script</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s5"># animated=True tells matplotlib to only draw the artist when we</span>
    <span class="s5"># explicitly request it</span>
    <span class="s1">ln</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s1">animated</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s5"># make sure the window is raised, but the script keeps going</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">show</span><span class="s2">(</span><span class="s1">block</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s6">0.3</span><span class="s2">)</span>
    <span class="s5"># Connect to draw_event to count the occurrences</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s4">'draw_event'</span><span class="s2">, </span><span class="s1">print</span><span class="s2">)</span>

    <span class="s5"># get copy of entire figure (everything inside fig.bbox)</span>
    <span class="s5"># sans animated artist</span>
    <span class="s1">bg </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">copy_from_bbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">)</span>
    <span class="s5"># draw the animated artist, this uses a cached renderer</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">draw_artist</span><span class="s2">(</span><span class="s1">ln</span><span class="s2">)</span>
    <span class="s5"># show the result to the screen</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">blit</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">10</span><span class="s2">):</span>
        <span class="s5"># reset the background back in the canvas state, screen unchanged</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">restore_region</span><span class="s2">(</span><span class="s1">bg</span><span class="s2">)</span>
        <span class="s5"># Create a **new** artist here, this is poor usage of blitting</span>
        <span class="s5"># but good for testing to make sure that this doesn't create</span>
        <span class="s5"># excessive draws</span>
        <span class="s1">ln</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">])</span>
        <span class="s5"># render the artist, updating the canvas state, but not the screen</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">draw_artist</span><span class="s2">(</span><span class="s1">ln</span><span class="s2">)</span>
        <span class="s5"># copy the image to the GUI state, but screen might not changed yet</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">blit</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">)</span>
        <span class="s5"># flush any pending GUI events, re-painting the screen if needed</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">flush_events</span><span class="s2">()</span>

    <span class="s5"># Let the event loop process everything before leaving</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">)</span>


<span class="s1">_blit_backends </span><span class="s2">= </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">()</span>
<span class="s0">for </span><span class="s1">param </span><span class="s0">in </span><span class="s1">_blit_backends</span><span class="s2">:</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">param</span><span class="s2">.</span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;gtk3cairo&quot;</span><span class="s2">:</span>
        <span class="s5"># copy_from_bbox only works when rendering to an ImageSurface</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;gtk3cairo does not support blitting&quot;</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;gtk4cairo&quot;</span><span class="s2">:</span>
        <span class="s5"># copy_from_bbox only works when rendering to an ImageSurface</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;gtk4cairo does not support blitting&quot;</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;wx&quot;</span><span class="s2">:</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;wx does not support blitting&quot;</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s2">(</span><span class="s1">backend </span><span class="s2">== </span><span class="s4">'tkagg' </span><span class="s0">and</span>
          <span class="s2">(</span><span class="s4">'TF_BUILD' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ </span><span class="s0">or </span><span class="s4">'GITHUB_ACTION' </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">) </span><span class="s0">and</span>
          <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'darwin' </span><span class="s0">and</span>
          <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] &lt; (</span><span class="s6">3</span><span class="s2">, </span><span class="s6">11</span><span class="s2">)</span>
          <span class="s2">):</span>
        <span class="s1">param</span><span class="s2">.</span><span class="s1">marks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(  </span><span class="s5"># https://github.com/actions/setup-python/issues/649</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s4">'Tk version mismatch on Azure macOS CI'</span><span class="s2">)</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_blit_backends</span><span class="s2">)</span>
<span class="s5"># subprocesses can struggle to get the display, so rerun a few times</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">flaky</span><span class="s2">(</span><span class="s1">reruns</span><span class="s2">=</span><span class="s6">4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_blitting_events</span><span class="s2">(</span><span class="s1">env</span><span class="s2">):</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">_run_helper</span><span class="s2">(</span>
        <span class="s1">_test_number_of_draws_script</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">, </span><span class="s1">extra_env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>
    <span class="s5"># Count the number of draw_events we got. We could count some initial</span>
    <span class="s5"># canvas draws (which vary in number by backend), but the critical</span>
    <span class="s5"># check here is that it isn't 10 draws, which would be called if</span>
    <span class="s5"># blitting is not properly implemented</span>
    <span class="s1">ndraws </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s4">&quot;DrawEvent&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s6">0 </span><span class="s2">&lt; </span><span class="s1">ndraws </span><span class="s2">&lt; </span><span class="s6">5</span>


<span class="s0">def </span><span class="s1">_impl_test_interactive_timers</span><span class="s2">():</span>
    <span class="s5"># A timer with &lt;1 millisecond gets converted to int and therefore 0</span>
    <span class="s5"># milliseconds, which the mac framework interprets as singleshot.</span>
    <span class="s5"># We only want singleshot if we specify that ourselves, otherwise we want</span>
    <span class="s5"># a repeating timer</span>
    <span class="s0">import </span><span class="s1">os</span>
    <span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">Mock</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s5"># increase pause duration on CI to let things spin up</span>
    <span class="s5"># particularly relevant for gtk3cairo</span>
    <span class="s1">pause_time </span><span class="s2">= </span><span class="s6">2 </span><span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s4">&quot;CI&quot;</span><span class="s2">) </span><span class="s0">else </span><span class="s6">0.5</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s1">pause_time</span><span class="s2">)</span>
    <span class="s1">timer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">new_timer</span><span class="s2">(</span><span class="s6">0.1</span><span class="s2">)</span>
    <span class="s1">mock </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">()</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">add_callback</span><span class="s2">(</span><span class="s1">mock</span><span class="s2">)</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s1">pause_time</span><span class="s2">)</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">call_count </span><span class="s2">&gt; </span><span class="s6">1</span>

    <span class="s5"># Now turn it into a single shot timer and verify only one gets triggered</span>
    <span class="s1">mock</span><span class="s2">.</span><span class="s1">call_count </span><span class="s2">= </span><span class="s6">0</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">single_shot </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s1">pause_time</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">call_count </span><span class="s2">== </span><span class="s6">1</span>

    <span class="s5"># Make sure we can start the timer a second time</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">(</span><span class="s1">pause_time</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mock</span><span class="s2">.</span><span class="s1">call_count </span><span class="s2">== </span><span class="s6">2</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">&quot;all&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_interactive_timers</span><span class="s2">(</span><span class="s1">env</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">] == </span><span class="s4">&quot;gtk3cairo&quot; </span><span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s4">&quot;CI&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;gtk3cairo timers do not work in remote CI&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">] == </span><span class="s4">&quot;wx&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;wx backend is deprecated; tests failed on appveyor&quot;</span><span class="s2">)</span>
    <span class="s1">_run_helper</span><span class="s2">(</span><span class="s1">_impl_test_interactive_timers</span><span class="s2">,</span>
                <span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">, </span><span class="s1">extra_env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_test_sigint_impl</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">target_name</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">sys</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
    <span class="s0">import </span><span class="s1">os</span>
    <span class="s0">import </span><span class="s1">threading</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">switch_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">interrupter</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'win32'</span><span class="s2">:</span>
            <span class="s0">import </span><span class="s1">win32api</span>
            <span class="s1">win32api</span><span class="s2">.</span><span class="s1">GenerateConsoleCtrlEvent</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">import </span><span class="s1">signal</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">getpid</span><span class="s2">(), </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGINT</span><span class="s2">)</span>

    <span class="s1">target </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">, </span><span class="s1">target_name</span><span class="s2">)</span>
    <span class="s1">timer </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Timer</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">interrupter</span><span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span>
        <span class="s4">'draw_event'</span><span class="s2">,</span>
        <span class="s0">lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">print</span><span class="s2">(</span><span class="s4">'DRAW'</span><span class="s2">, </span><span class="s1">flush</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span>
        <span class="s4">'draw_event'</span><span class="s2">,</span>
        <span class="s0">lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">target</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">KeyboardInterrupt</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'SUCCESS'</span><span class="s2">, </span><span class="s1">flush</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">())</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;target, kwargs&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s4">'show'</span><span class="s2">, {</span><span class="s4">'block'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}),</span>
    <span class="s2">(</span><span class="s4">'pause'</span><span class="s2">, {</span><span class="s4">'interval'</span><span class="s2">: </span><span class="s6">10</span><span class="s2">})</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_sigint</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">env</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s4">&quot;qt&quot;</span><span class="s2">, </span><span class="s4">&quot;macosx&quot;</span><span class="s2">)):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;SIGINT currently only tested on qt and macosx&quot;</span><span class="s2">)</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">_WaitForStringPopen</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">&quot;-c&quot;</span><span class="s2">,</span>
         <span class="s1">inspect</span><span class="s2">.</span><span class="s1">getsource</span><span class="s2">(</span><span class="s1">_test_sigint_impl</span><span class="s2">) +</span>
         <span class="s4">f&quot;</span><span class="s0">\n</span><span class="s4">_test_sigint_impl(</span><span class="s0">{</span><span class="s1">backend</span><span class="s0">!r}</span><span class="s4">, </span><span class="s0">{</span><span class="s1">target</span><span class="s0">!r}</span><span class="s4">, </span><span class="s0">{</span><span class="s1">kwargs</span><span class="s0">!r}</span><span class="s4">)&quot;</span><span class="s2">])</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">wait_for</span><span class="s2">(</span><span class="s4">'DRAW'</span><span class="s2">)</span>
        <span class="s1">stdout</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">()</span>
        <span class="s1">stdout</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">()</span>
        <span class="s0">raise</span>
    <span class="s0">assert </span><span class="s4">'SUCCESS' </span><span class="s0">in </span><span class="s1">stdout</span>


<span class="s0">def </span><span class="s1">_test_other_signal_before_sigint_impl</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">target_name</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">signal</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">switch_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">)</span>

    <span class="s1">target </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">, </span><span class="s1">target_name</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s4">'draw_event'</span><span class="s2">, </span><span class="s0">lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">print</span><span class="s2">(</span><span class="s4">'DRAW'</span><span class="s2">, </span><span class="s1">flush</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>

    <span class="s1">timer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">new_timer</span><span class="s2">(</span><span class="s1">interval</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">single_shot </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">timer</span><span class="s2">.</span><span class="s1">add_callback</span><span class="s2">(</span><span class="s1">print</span><span class="s2">, </span><span class="s4">'SIGUSR1'</span><span class="s2">, </span><span class="s1">flush</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">custom_signal_handler</span><span class="s2">(</span><span class="s1">signum</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">):</span>
        <span class="s1">timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s1">signal</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGUSR1</span><span class="s2">, </span><span class="s1">custom_signal_handler</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">target</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">KeyboardInterrupt</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">'SUCCESS'</span><span class="s2">, </span><span class="s1">flush</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">'win32'</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">'No other signal available to send on Windows'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;env&quot;</span><span class="s2">, </span><span class="s1">_get_testable_interactive_backends</span><span class="s2">())</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;target, kwargs&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s4">'show'</span><span class="s2">, {</span><span class="s4">'block'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}),</span>
    <span class="s2">(</span><span class="s4">'pause'</span><span class="s2">, {</span><span class="s4">'interval'</span><span class="s2">: </span><span class="s6">10</span><span class="s2">})</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_other_signal_before_sigint</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">backend </span><span class="s2">= </span><span class="s1">env</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;MPLBACKEND&quot;</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">((</span><span class="s4">&quot;qt&quot;</span><span class="s2">, </span><span class="s4">&quot;macosx&quot;</span><span class="s2">)):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;SIGINT currently only tested on qt and macosx&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">backend </span><span class="s2">== </span><span class="s4">&quot;macosx&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;macosx backend is buggy&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;darwin&quot; </span><span class="s0">and </span><span class="s1">target </span><span class="s2">== </span><span class="s4">&quot;show&quot;</span><span class="s2">:</span>
        <span class="s5"># We've not previously had these toolkits installed on CI, and so were never</span>
        <span class="s5"># aware that this was crashing. However, we've had little luck reproducing it</span>
        <span class="s5"># locally, so mark it xfail for now. For more information, see</span>
        <span class="s5"># https://github.com/matplotlib/matplotlib/issues/27984</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Qt backend is buggy on macOS&quot;</span><span class="s2">))</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">_WaitForStringPopen</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">&quot;-c&quot;</span><span class="s2">,</span>
         <span class="s1">inspect</span><span class="s2">.</span><span class="s1">getsource</span><span class="s2">(</span><span class="s1">_test_other_signal_before_sigint_impl</span><span class="s2">) +</span>
         <span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">_test_other_signal_before_sigint_impl(&quot;</span>
            <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">backend</span><span class="s0">!r}</span><span class="s4">, </span><span class="s0">{</span><span class="s1">target</span><span class="s0">!r}</span><span class="s4">, </span><span class="s0">{</span><span class="s1">kwargs</span><span class="s0">!r}</span><span class="s4">)&quot;</span><span class="s2">])</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">wait_for</span><span class="s2">(</span><span class="s4">'DRAW'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">(</span><span class="s1">proc</span><span class="s2">.</span><span class="s1">pid</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGUSR1</span><span class="s2">)</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">wait_for</span><span class="s2">(</span><span class="s4">'SIGUSR1'</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">(</span><span class="s1">proc</span><span class="s2">.</span><span class="s1">pid</span><span class="s2">, </span><span class="s1">signal</span><span class="s2">.</span><span class="s1">SIGINT</span><span class="s2">)</span>
        <span class="s1">stdout</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">_test_timeout</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s1">proc</span><span class="s2">.</span><span class="s1">kill</span><span class="s2">()</span>
        <span class="s1">stdout</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">proc</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">()</span>
        <span class="s0">raise</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">stdout</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">'SUCCESS' </span><span class="s0">in </span><span class="s1">stdout</span>
</pre>
</body>
</html>