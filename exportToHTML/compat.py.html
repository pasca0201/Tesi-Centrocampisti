<html>
<head>
<title>compat.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
compat.py</font>
</center></td></tr></table>
<pre><span class="s0"># util/compat.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: allow-untyped-defs, allow-untyped-calls</span>

<span class="s2">&quot;&quot;&quot;Handle Python version/platform incompatibilities.&quot;&quot;&quot;</span>

<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">import </span><span class="s1">base64</span>
<span class="s3">import </span><span class="s1">dataclasses</span>
<span class="s3">import </span><span class="s1">hashlib</span>
<span class="s3">import </span><span class="s1">inspect</span>
<span class="s3">import </span><span class="s1">operator</span>
<span class="s3">import </span><span class="s1">platform</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">typing</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Dict</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Iterable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">List</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Mapping</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Optional</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Sequence</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Set</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Tuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Type</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TypeVar</span>


<span class="s1">py312 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">12</span><span class="s4">)</span>
<span class="s1">py311 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">11</span><span class="s4">)</span>
<span class="s1">py310 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">10</span><span class="s4">)</span>
<span class="s1">py39 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">9</span><span class="s4">)</span>
<span class="s1">py38 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s5">3</span><span class="s4">, </span><span class="s5">8</span><span class="s4">)</span>
<span class="s1">pypy </span><span class="s4">= </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">python_implementation</span><span class="s4">() == </span><span class="s6">&quot;PyPy&quot;</span>
<span class="s1">cpython </span><span class="s4">= </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">python_implementation</span><span class="s4">() == </span><span class="s6">&quot;CPython&quot;</span>

<span class="s1">win32 </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s6">&quot;win&quot;</span><span class="s4">)</span>
<span class="s1">osx </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s6">&quot;darwin&quot;</span><span class="s4">)</span>
<span class="s1">arm </span><span class="s4">= </span><span class="s6">&quot;aarch&quot; </span><span class="s3">in </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">machine</span><span class="s4">().</span><span class="s1">lower</span><span class="s4">()</span>
<span class="s1">is64bit </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">maxsize </span><span class="s4">&gt; </span><span class="s5">2</span><span class="s4">**</span><span class="s5">32</span>

<span class="s1">has_refcount_gc </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">cpython</span><span class="s4">)</span>

<span class="s1">dottedgetter </span><span class="s4">= </span><span class="s1">operator</span><span class="s4">.</span><span class="s1">attrgetter</span>

<span class="s1">_T_co </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s6">&quot;_T_co&quot;</span><span class="s4">, </span><span class="s1">covariant</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">FullArgSpec</span><span class="s4">(</span><span class="s1">typing</span><span class="s4">.</span><span class="s1">NamedTuple</span><span class="s4">):</span>
    <span class="s1">args</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>
    <span class="s1">varargs</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>
    <span class="s1">varkw</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>
    <span class="s1">defaults</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, ...]]</span>
    <span class="s1">kwonlyargs</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>
    <span class="s1">kwonlydefaults</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s1">annotations</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">inspect_getfullargspec</span><span class="s4">(</span><span class="s1">func</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[..., </span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; FullArgSpec</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Fully vendored version of getfullargspec from Python 3.3.&quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">ismethod</span><span class="s4">(</span><span class="s1">func</span><span class="s4">):</span>
        <span class="s1">func </span><span class="s4">= </span><span class="s1">func</span><span class="s4">.</span><span class="s1">__func__</span>
    <span class="s3">if not </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">isfunction</span><span class="s4">(</span><span class="s1">func</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">func</span><span class="s3">!r} </span><span class="s6">is not a Python function&quot;</span><span class="s4">)</span>

    <span class="s1">co </span><span class="s4">= </span><span class="s1">func</span><span class="s4">.</span><span class="s1">__code__</span>
    <span class="s3">if not </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">iscode</span><span class="s4">(</span><span class="s1">co</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">co</span><span class="s3">!r} </span><span class="s6">is not a code object&quot;</span><span class="s4">)</span>

    <span class="s1">nargs </span><span class="s4">= </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_argcount</span>
    <span class="s1">names </span><span class="s4">= </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_varnames</span>
    <span class="s1">nkwargs </span><span class="s4">= </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_kwonlyargcount</span>
    <span class="s1">args </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">names</span><span class="s4">[:</span><span class="s1">nargs</span><span class="s4">])</span>
    <span class="s1">kwonlyargs </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">names</span><span class="s4">[</span><span class="s1">nargs </span><span class="s4">: </span><span class="s1">nargs </span><span class="s4">+ </span><span class="s1">nkwargs</span><span class="s4">])</span>

    <span class="s1">nargs </span><span class="s4">+= </span><span class="s1">nkwargs</span>
    <span class="s1">varargs </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_flags </span><span class="s4">&amp; </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">CO_VARARGS</span><span class="s4">:</span>
        <span class="s1">varargs </span><span class="s4">= </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_varnames</span><span class="s4">[</span><span class="s1">nargs</span><span class="s4">]</span>
        <span class="s1">nargs </span><span class="s4">= </span><span class="s1">nargs </span><span class="s4">+ </span><span class="s5">1</span>
    <span class="s1">varkw </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_flags </span><span class="s4">&amp; </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">CO_VARKEYWORDS</span><span class="s4">:</span>
        <span class="s1">varkw </span><span class="s4">= </span><span class="s1">co</span><span class="s4">.</span><span class="s1">co_varnames</span><span class="s4">[</span><span class="s1">nargs</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">FullArgSpec</span><span class="s4">(</span>
        <span class="s1">args</span><span class="s4">,</span>
        <span class="s1">varargs</span><span class="s4">,</span>
        <span class="s1">varkw</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">.</span><span class="s1">__defaults__</span><span class="s4">,</span>
        <span class="s1">kwonlyargs</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">.</span><span class="s1">__kwdefaults__</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">.</span><span class="s1">__annotations__</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">if </span><span class="s1">py39</span><span class="s4">:</span>
    <span class="s0"># python stubs don't have a public type for this. not worth</span>
    <span class="s0"># making a protocol</span>
    <span class="s3">def </span><span class="s1">md5_not_for_security</span><span class="s4">() </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">md5</span><span class="s4">(</span><span class="s1">usedforsecurity</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

<span class="s3">else</span><span class="s4">:</span>

    <span class="s3">def </span><span class="s1">md5_not_for_security</span><span class="s4">() </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">md5</span><span class="s4">()</span>


<span class="s3">if </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">TYPE_CHECKING </span><span class="s3">or </span><span class="s1">py38</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s1">importlib </span><span class="s3">import </span><span class="s1">metadata </span><span class="s3">as </span><span class="s1">importlib_metadata</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">importlib_metadata  </span><span class="s0"># noqa</span>


<span class="s3">if </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">TYPE_CHECKING </span><span class="s3">or </span><span class="s1">py39</span><span class="s4">:</span>
    <span class="s0"># pep 584 dict union</span>
    <span class="s1">dict_union </span><span class="s4">= </span><span class="s1">operator</span><span class="s4">.</span><span class="s1">or_  </span><span class="s0"># noqa</span>
<span class="s3">else</span><span class="s4">:</span>

    <span class="s3">def </span><span class="s1">dict_union</span><span class="s4">(</span><span class="s1">a</span><span class="s4">: </span><span class="s1">dict</span><span class="s4">, </span><span class="s1">b</span><span class="s4">: </span><span class="s1">dict</span><span class="s4">) </span><span class="s1">-&gt; dict</span><span class="s4">:</span>
        <span class="s1">a </span><span class="s4">= </span><span class="s1">a</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">a</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">b</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">a</span>


<span class="s3">if </span><span class="s1">py310</span><span class="s4">:</span>
    <span class="s1">anext_ </span><span class="s4">= </span><span class="s1">anext</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s1">_NOT_PROVIDED </span><span class="s4">= </span><span class="s1">object</span><span class="s4">()</span>
    <span class="s3">from </span><span class="s1">collections</span><span class="s4">.</span><span class="s1">abc </span><span class="s3">import </span><span class="s1">AsyncIterator</span>

    <span class="s3">async def </span><span class="s1">anext_</span><span class="s4">(</span><span class="s1">async_iterator</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">_NOT_PROVIDED</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;vendored from https://github.com/python/cpython/pull/8895&quot;&quot;&quot;</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">async_iterator</span><span class="s4">, </span><span class="s1">AsyncIterator</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span>
                <span class="s6">f&quot;anext expected an AsyncIterator, got </span><span class="s3">{</span><span class="s1">type</span><span class="s4">(</span><span class="s1">async_iterator</span><span class="s4">)</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s4">)</span>
        <span class="s1">anxt </span><span class="s4">= </span><span class="s1">type</span><span class="s4">(</span><span class="s1">async_iterator</span><span class="s4">).</span><span class="s1">__anext__</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return await </span><span class="s1">anxt</span><span class="s4">(</span><span class="s1">async_iterator</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">StopAsyncIteration</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">default </span><span class="s3">is </span><span class="s1">_NOT_PROVIDED</span><span class="s4">:</span>
                <span class="s3">raise</span>
            <span class="s3">return </span><span class="s1">default</span>


<span class="s3">def </span><span class="s1">importlib_metadata_get</span><span class="s4">(</span><span class="s1">group</span><span class="s4">):</span>
    <span class="s1">ep </span><span class="s4">= </span><span class="s1">importlib_metadata</span><span class="s4">.</span><span class="s1">entry_points</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">TYPE_CHECKING </span><span class="s3">or </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">ep</span><span class="s4">, </span><span class="s6">&quot;select&quot;</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">ep</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(</span><span class="s1">group</span><span class="s4">=</span><span class="s1">group</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">ep</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, ())</span>


<span class="s3">def </span><span class="s1">b</span><span class="s4">(</span><span class="s1">s</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">s</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">b64decode</span><span class="s4">(</span><span class="s1">x</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s1">base64</span><span class="s4">.</span><span class="s1">b64decode</span><span class="s4">(</span><span class="s1">x</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s6">&quot;ascii&quot;</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">x</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s1">base64</span><span class="s4">.</span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">x</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">(</span><span class="s6">&quot;ascii&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">decode_backslashreplace</span><span class="s4">(</span><span class="s1">text</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">encoding</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s1">text</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s6">&quot;backslashreplace&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">cmp</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">a </span><span class="s4">&gt; </span><span class="s1">b</span><span class="s4">) - (</span><span class="s1">a </span><span class="s4">&lt; </span><span class="s1">b</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_formatannotation</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">, </span><span class="s1">base_module</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;vendored from python 3.7&quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">annotation</span>

    <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">, </span><span class="s6">&quot;__module__&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">) == </span><span class="s6">&quot;typing&quot;</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;typing.&quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;~&quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">, </span><span class="s1">type</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">annotation</span><span class="s4">.</span><span class="s1">__module__ </span><span class="s3">in </span><span class="s4">(</span><span class="s6">&quot;builtins&quot;</span><span class="s4">, </span><span class="s1">base_module</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">.</span><span class="s1">__qualname__</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">annotation</span><span class="s4">.</span><span class="s1">__module__ </span><span class="s4">+ </span><span class="s6">&quot;.&quot; </span><span class="s4">+ </span><span class="s1">annotation</span><span class="s4">.</span><span class="s1">__qualname__</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">, </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">TypeVar</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;~&quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">annotation</span><span class="s4">).</span><span class="s1">replace</span><span class="s4">(</span><span class="s6">&quot;~&quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">inspect_formatargspec</span><span class="s4">(</span>
    <span class="s1">args</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">varargs</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">varkw</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">defaults</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">kwonlyargs</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]] = (),</span>
    <span class="s1">kwonlydefaults</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapping</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]] = {},</span>
    <span class="s1">annotations</span><span class="s4">: </span><span class="s1">Mapping</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {},</span>
    <span class="s1">formatarg</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">formatvarargs</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">lambda </span><span class="s1">name</span><span class="s4">: </span><span class="s6">&quot;*&quot; </span><span class="s4">+ </span><span class="s1">name</span><span class="s4">,</span>
    <span class="s1">formatvarkw</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">lambda </span><span class="s1">name</span><span class="s4">: </span><span class="s6">&quot;**&quot; </span><span class="s4">+ </span><span class="s1">name</span><span class="s4">,</span>
    <span class="s1">formatvalue</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">lambda </span><span class="s1">value</span><span class="s4">: </span><span class="s6">&quot;=&quot; </span><span class="s4">+ </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">value</span><span class="s4">),</span>
    <span class="s1">formatreturns</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">lambda </span><span class="s1">text</span><span class="s4">: </span><span class="s6">&quot; -&gt; &quot; </span><span class="s4">+ </span><span class="s1">str</span><span class="s4">(</span><span class="s1">text</span><span class="s4">),</span>
    <span class="s1">formatannotation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">_formatannotation</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Copy formatargspec from python 3.7 standard library. 
 
    Python 3 has deprecated formatargspec and requested that Signature 
    be used instead, however this requires a full reimplementation 
    of formatargspec() in terms of creating Parameter objects and such. 
    Instead of introducing all the object-creation overhead and having 
    to reinvent from scratch, just copy their compatibility routine. 
 
    Ultimately we would need to rewrite our &quot;decorator&quot; routine completely 
    which is not really worth it right now, until all Python 2.x support 
    is dropped. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">kwonlydefaults </span><span class="s4">= </span><span class="s1">kwonlydefaults </span><span class="s3">or </span><span class="s4">{}</span>
    <span class="s1">annotations </span><span class="s4">= </span><span class="s1">annotations </span><span class="s3">or </span><span class="s4">{}</span>

    <span class="s3">def </span><span class="s1">formatargandannotation</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">formatarg</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">annotations</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">+= </span><span class="s6">&quot;: &quot; </span><span class="s4">+ </span><span class="s1">formatannotation</span><span class="s4">(</span><span class="s1">annotations</span><span class="s4">[</span><span class="s1">arg</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s1">specs </span><span class="s4">= []</span>
    <span class="s3">if </span><span class="s1">defaults</span><span class="s4">:</span>
        <span class="s1">firstdefault </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">args</span><span class="s4">) - </span><span class="s1">len</span><span class="s4">(</span><span class="s1">defaults</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">firstdefault </span><span class="s4">= -</span><span class="s5">1</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">args</span><span class="s4">):</span>
        <span class="s1">spec </span><span class="s4">= </span><span class="s1">formatargandannotation</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">defaults </span><span class="s3">and </span><span class="s1">i </span><span class="s4">&gt;= </span><span class="s1">firstdefault</span><span class="s4">:</span>
            <span class="s1">spec </span><span class="s4">= </span><span class="s1">spec </span><span class="s4">+ </span><span class="s1">formatvalue</span><span class="s4">(</span><span class="s1">defaults</span><span class="s4">[</span><span class="s1">i </span><span class="s4">- </span><span class="s1">firstdefault</span><span class="s4">])</span>
        <span class="s1">specs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">varargs </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">specs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">formatvarargs</span><span class="s4">(</span><span class="s1">formatargandannotation</span><span class="s4">(</span><span class="s1">varargs</span><span class="s4">)))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">kwonlyargs</span><span class="s4">:</span>
            <span class="s1">specs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s6">&quot;*&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">kwonlyargs</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">kwonlyarg </span><span class="s3">in </span><span class="s1">kwonlyargs</span><span class="s4">:</span>
            <span class="s1">spec </span><span class="s4">= </span><span class="s1">formatargandannotation</span><span class="s4">(</span><span class="s1">kwonlyarg</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">kwonlydefaults </span><span class="s3">and </span><span class="s1">kwonlyarg </span><span class="s3">in </span><span class="s1">kwonlydefaults</span><span class="s4">:</span>
                <span class="s1">spec </span><span class="s4">+= </span><span class="s1">formatvalue</span><span class="s4">(</span><span class="s1">kwonlydefaults</span><span class="s4">[</span><span class="s1">kwonlyarg</span><span class="s4">])</span>
            <span class="s1">specs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">varkw </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">specs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">formatvarkw</span><span class="s4">(</span><span class="s1">formatargandannotation</span><span class="s4">(</span><span class="s1">varkw</span><span class="s4">)))</span>

    <span class="s1">result </span><span class="s4">= </span><span class="s6">&quot;(&quot; </span><span class="s4">+ </span><span class="s6">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">specs</span><span class="s4">) + </span><span class="s6">&quot;)&quot;</span>
    <span class="s3">if </span><span class="s6">&quot;return&quot; </span><span class="s3">in </span><span class="s1">annotations</span><span class="s4">:</span>
        <span class="s1">result </span><span class="s4">+= </span><span class="s1">formatreturns</span><span class="s4">(</span><span class="s1">formatannotation</span><span class="s4">(</span><span class="s1">annotations</span><span class="s4">[</span><span class="s6">&quot;return&quot;</span><span class="s4">]))</span>
    <span class="s3">return </span><span class="s1">result</span>


<span class="s3">def </span><span class="s1">dataclass_fields</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; Iterable</span><span class="s4">[</span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">Field</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
    <span class="s2">&quot;&quot;&quot;Return a sequence of all dataclasses.Field objects associated 
    with a class as an already processed dataclass. 
 
    The class must **already be a dataclass** for Field objects to be returned. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">is_dataclass</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">[]</span>


<span class="s3">def </span><span class="s1">local_dataclass_fields</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; Iterable</span><span class="s4">[</span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">Field</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
    <span class="s2">&quot;&quot;&quot;Return a sequence of all dataclasses.Field objects associated with 
    an already processed dataclass, excluding those that originate from a 
    superclass. 
 
    The class must **already be a dataclass** for Field objects to be returned. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">is_dataclass</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">):</span>
        <span class="s1">super_fields</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">Field</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">set</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">sup </span><span class="s3">in </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">__bases__</span><span class="s4">:</span>
            <span class="s1">super_fields</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">dataclass_fields</span><span class="s4">(</span><span class="s1">sup</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">f </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">dataclasses</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">) </span><span class="s3">if </span><span class="s1">f </span><span class="s3">not in </span><span class="s1">super_fields</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">[]</span>
</pre>
</body>
</html>