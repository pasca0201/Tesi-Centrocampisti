<html>
<head>
<title>minres.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
minres.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s1">inner</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s1">finfo</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">norm</span>
<span class="s0">from </span><span class="s1">math </span><span class="s0">import </span><span class="s1">sqrt</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">make_system</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'minres'</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">minres</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-5</span><span class="s2">, </span><span class="s1">shift</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
           <span class="s1">M</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">show</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">check</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Use MINimum RESidual iteration to solve Ax=b 
 
    MINRES minimizes norm(Ax - b) for a real symmetric matrix A.  Unlike 
    the Conjugate Gradient method, A can be indefinite or singular. 
 
    If shift != 0 then the method solves (A - shift*I)x = b 
 
    Parameters 
    ---------- 
    A : {sparse matrix, ndarray, LinearOperator} 
        The real symmetric N-by-N matrix of the linear system 
        Alternatively, ``A`` can be a linear operator which can 
        produce ``Ax`` using, e.g., 
        ``scipy.sparse.linalg.LinearOperator``. 
    b : ndarray 
        Right hand side of the linear system. Has shape (N,) or (N,1). 
 
    Returns 
    ------- 
    x : ndarray 
        The converged solution. 
    info : integer 
        Provides convergence information: 
            0  : successful exit 
            &gt;0 : convergence to tolerance not achieved, number of iterations 
            &lt;0 : illegal input or breakdown 
 
    Other Parameters 
    ---------------- 
    x0 : ndarray 
        Starting guess for the solution. 
    shift : float 
        Value to apply to the system ``(A - shift * I)x = b``. Default is 0. 
    rtol : float 
        Tolerance to achieve. The algorithm terminates when the relative 
        residual is below ``rtol``. 
    maxiter : integer 
        Maximum number of iterations.  Iteration will stop after maxiter 
        steps even if the specified tolerance has not been achieved. 
    M : {sparse matrix, ndarray, LinearOperator} 
        Preconditioner for A.  The preconditioner should approximate the 
        inverse of A.  Effective preconditioning dramatically improves the 
        rate of convergence, which implies that fewer iterations are needed 
        to reach a given error tolerance. 
    callback : function 
        User-supplied function to call after each iteration.  It is called 
        as callback(xk), where xk is the current solution vector. 
    show : bool 
        If ``True``, print out a summary and metrics related to the solution 
        during iterations. Default is ``False``. 
    check : bool 
        If ``True``, run additional input validation to check that `A` and 
        `M` (if specified) are symmetric. Default is ``False``. 
 
    Examples 
    -------- 
    &gt;&gt;&gt; import numpy as np 
    &gt;&gt;&gt; from scipy.sparse import csc_matrix 
    &gt;&gt;&gt; from scipy.sparse.linalg import minres 
    &gt;&gt;&gt; A = csc_matrix([[3, 2, 0], [1, -1, 0], [0, 5, 1]], dtype=float) 
    &gt;&gt;&gt; A = A + A.T 
    &gt;&gt;&gt; b = np.array([2, 4, -1], dtype=float) 
    &gt;&gt;&gt; x, exitCode = minres(A, b) 
    &gt;&gt;&gt; print(exitCode)            # 0 indicates successful convergence 
    0 
    &gt;&gt;&gt; np.allclose(A.dot(x), b) 
    True 
 
    References 
    ---------- 
    Solution of sparse indefinite systems of linear equations, 
        C. C. Paige and M. A. Saunders (1975), 
        SIAM J. Numer. Anal. 12(4), pp. 617-629. 
        https://web.stanford.edu/group/SOL/software/minres/ 
 
    This file is a translation of the following MATLAB implementation: 
        https://web.stanford.edu/group/SOL/software/minres/minres-matlab.zip 
 
    &quot;&quot;&quot;</span>
    <span class="s1">A</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">postprocess </span><span class="s2">= </span><span class="s1">make_system</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s1">matvec </span><span class="s2">= </span><span class="s1">A</span><span class="s2">.</span><span class="s1">matvec</span>
    <span class="s1">psolve </span><span class="s2">= </span><span class="s1">M</span><span class="s2">.</span><span class="s1">matvec</span>

    <span class="s1">first </span><span class="s2">= </span><span class="s3">'Enter minres.   '</span>
    <span class="s1">last </span><span class="s2">= </span><span class="s3">'Exit  minres.   '</span>

    <span class="s1">n </span><span class="s2">= </span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">maxiter </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">maxiter </span><span class="s2">= </span><span class="s4">5 </span><span class="s2">* </span><span class="s1">n</span>

    <span class="s1">msg </span><span class="s2">= [</span><span class="s3">' beta2 = 0.  If M = I, b and x are eigenvectors    '</span><span class="s2">,   </span><span class="s6"># -1</span>
            <span class="s3">' beta1 = 0.  The exact solution is x0          '</span><span class="s2">,   </span><span class="s6"># 0</span>
            <span class="s3">' A solution to Ax = b was found, given rtol        '</span><span class="s2">,   </span><span class="s6"># 1</span>
            <span class="s3">' A least-squares solution was found, given rtol    '</span><span class="s2">,   </span><span class="s6"># 2</span>
            <span class="s3">' Reasonable accuracy achieved, given eps           '</span><span class="s2">,   </span><span class="s6"># 3</span>
            <span class="s3">' x has converged to an eigenvector                 '</span><span class="s2">,   </span><span class="s6"># 4</span>
            <span class="s3">' acond has exceeded 0.1/eps                        '</span><span class="s2">,   </span><span class="s6"># 5</span>
            <span class="s3">' The iteration limit was reached                   '</span><span class="s2">,   </span><span class="s6"># 6</span>
            <span class="s3">' A  does not define a symmetric matrix             '</span><span class="s2">,   </span><span class="s6"># 7</span>
            <span class="s3">' M  does not define a symmetric matrix             '</span><span class="s2">,   </span><span class="s6"># 8</span>
            <span class="s3">' M  does not define a pos-def preconditioner       '</span><span class="s2">]   </span><span class="s6"># 9</span>

    <span class="s0">if </span><span class="s1">show</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">first </span><span class="s2">+ </span><span class="s3">'Solution of symmetric Ax = b'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">first </span><span class="s2">+ </span><span class="s3">f'n      =  </span><span class="s0">{</span><span class="s1">n</span><span class="s0">:</span><span class="s3">3g</span><span class="s0">}     </span><span class="s3">shift  =  </span><span class="s0">{</span><span class="s1">shift</span><span class="s0">:</span><span class="s3">23.14e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">first </span><span class="s2">+ </span><span class="s3">f'itnlim =  </span><span class="s0">{</span><span class="s1">maxiter</span><span class="s0">:</span><span class="s3">3g</span><span class="s0">}     </span><span class="s3">rtol   =  </span><span class="s0">{</span><span class="s1">rtol</span><span class="s0">:</span><span class="s3">11.2e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">()</span>

    <span class="s1">istop </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">itn </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">Anorm </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">Acond </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">rnorm </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">ynorm </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s1">xtype </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span>

    <span class="s1">eps </span><span class="s2">= </span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">xtype</span><span class="s2">).</span><span class="s1">eps</span>

    <span class="s6"># Set up y and v for the first Lanczos vector v1.</span>
    <span class="s6"># y  =  beta1 P' v1,  where  P = C**(-1).</span>
    <span class="s6"># v is really P' v1.</span>

    <span class="s0">if </span><span class="s1">x0 </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">b </span><span class="s2">- </span><span class="s1">A</span><span class="s2">@</span><span class="s1">x</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">psolve</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">)</span>

    <span class="s1">beta1 </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">beta1 </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'indefinite preconditioner'</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">beta1 </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">postprocess</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">bnorm </span><span class="s2">= </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">bnorm </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">b</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">postprocess</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">beta1 </span><span class="s2">= </span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">beta1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">check</span><span class="s2">:</span>
        <span class="s6"># are these too strict?</span>

        <span class="s6"># see if A is symmetric</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">matvec</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">matvec</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">w</span><span class="s2">,</span><span class="s1">w</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">y</span><span class="s2">,</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">s </span><span class="s2">- </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">epsa </span><span class="s2">= (</span><span class="s1">s </span><span class="s2">+ </span><span class="s1">eps</span><span class="s2">) * </span><span class="s1">eps</span><span class="s2">**(</span><span class="s4">1.0</span><span class="s2">/</span><span class="s4">3.0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">z </span><span class="s2">&gt; </span><span class="s1">epsa</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'non-symmetric matrix'</span><span class="s2">)</span>

        <span class="s6"># see if M is symmetric</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">psolve</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">y</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">,</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">s </span><span class="s2">- </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">epsa </span><span class="s2">= (</span><span class="s1">s </span><span class="s2">+ </span><span class="s1">eps</span><span class="s2">) * </span><span class="s1">eps</span><span class="s2">**(</span><span class="s4">1.0</span><span class="s2">/</span><span class="s4">3.0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">z </span><span class="s2">&gt; </span><span class="s1">epsa</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'non-symmetric preconditioner'</span><span class="s2">)</span>

    <span class="s6"># Initialize other quantities</span>
    <span class="s1">oldb </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">beta </span><span class="s2">= </span><span class="s1">beta1</span>
    <span class="s1">dbar </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">epsln </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">qrnorm </span><span class="s2">= </span><span class="s1">beta1</span>
    <span class="s1">phibar </span><span class="s2">= </span><span class="s1">beta1</span>
    <span class="s1">rhs1 </span><span class="s2">= </span><span class="s1">beta1</span>
    <span class="s1">rhs2 </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">tnorm2 </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">gmax </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">gmin </span><span class="s2">= </span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">xtype</span><span class="s2">).</span><span class="s1">max</span>
    <span class="s1">cs </span><span class="s2">= -</span><span class="s4">1</span>
    <span class="s1">sn </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xtype</span><span class="s2">)</span>
    <span class="s1">w2 </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xtype</span><span class="s2">)</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s1">r1</span>

    <span class="s0">if </span><span class="s1">show</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">()</span>
        <span class="s1">print</span><span class="s2">()</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'   Itn     x(1)     Compatible    LS       norm(A)  cond(A) gbar/|A|'</span><span class="s2">)</span>

    <span class="s0">while </span><span class="s1">itn </span><span class="s2">&lt; </span><span class="s1">maxiter</span><span class="s2">:</span>
        <span class="s1">itn </span><span class="s2">+= </span><span class="s4">1</span>

        <span class="s1">s </span><span class="s2">= </span><span class="s4">1.0</span><span class="s2">/</span><span class="s1">beta</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">s</span><span class="s2">*</span><span class="s1">y</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">matvec</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">y </span><span class="s2">- </span><span class="s1">shift </span><span class="s2">* </span><span class="s1">v</span>

        <span class="s0">if </span><span class="s1">itn </span><span class="s2">&gt;= </span><span class="s4">2</span><span class="s2">:</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">y </span><span class="s2">- (</span><span class="s1">beta</span><span class="s2">/</span><span class="s1">oldb</span><span class="s2">)*</span><span class="s1">r1</span>

        <span class="s1">alfa </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">v</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">y </span><span class="s2">- (</span><span class="s1">alfa</span><span class="s2">/</span><span class="s1">beta</span><span class="s2">)*</span><span class="s1">r2</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">r2</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">y</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">psolve</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">oldb </span><span class="s2">= </span><span class="s1">beta</span>
        <span class="s1">beta </span><span class="s2">= </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">beta </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'non-symmetric matrix'</span><span class="s2">)</span>
        <span class="s1">beta </span><span class="s2">= </span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">beta</span><span class="s2">)</span>
        <span class="s1">tnorm2 </span><span class="s2">+= </span><span class="s1">alfa</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">oldb</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">beta</span><span class="s2">**</span><span class="s4">2</span>

        <span class="s0">if </span><span class="s1">itn </span><span class="s2">== </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">beta</span><span class="s2">/</span><span class="s1">beta1 </span><span class="s2">&lt;= </span><span class="s4">10</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= -</span><span class="s4">1  </span><span class="s6"># Terminate later</span>

        <span class="s6"># Apply previous rotation Qk-1 to get</span>
        <span class="s6">#   [deltak epslnk+1] = [cs  sn][dbark    0   ]</span>
        <span class="s6">#   [gbar k dbar k+1]   [sn -cs][alfak betak+1].</span>

        <span class="s1">oldeps </span><span class="s2">= </span><span class="s1">epsln</span>
        <span class="s1">delta </span><span class="s2">= </span><span class="s1">cs </span><span class="s2">* </span><span class="s1">dbar </span><span class="s2">+ </span><span class="s1">sn </span><span class="s2">* </span><span class="s1">alfa   </span><span class="s6"># delta1 = 0         deltak</span>
        <span class="s1">gbar </span><span class="s2">= </span><span class="s1">sn </span><span class="s2">* </span><span class="s1">dbar </span><span class="s2">- </span><span class="s1">cs </span><span class="s2">* </span><span class="s1">alfa   </span><span class="s6"># gbar 1 = alfa1     gbar k</span>
        <span class="s1">epsln </span><span class="s2">= </span><span class="s1">sn </span><span class="s2">* </span><span class="s1">beta     </span><span class="s6"># epsln2 = 0         epslnk+1</span>
        <span class="s1">dbar </span><span class="s2">= - </span><span class="s1">cs </span><span class="s2">* </span><span class="s1">beta   </span><span class="s6"># dbar 2 = beta2     dbar k+1</span>
        <span class="s1">root </span><span class="s2">= </span><span class="s1">norm</span><span class="s2">([</span><span class="s1">gbar</span><span class="s2">, </span><span class="s1">dbar</span><span class="s2">])</span>
        <span class="s1">Arnorm </span><span class="s2">= </span><span class="s1">phibar </span><span class="s2">* </span><span class="s1">root</span>

        <span class="s6"># Compute the next plane rotation Qk</span>

        <span class="s1">gamma </span><span class="s2">= </span><span class="s1">norm</span><span class="s2">([</span><span class="s1">gbar</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">])       </span><span class="s6"># gammak</span>
        <span class="s1">gamma </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">gamma</span><span class="s2">, </span><span class="s1">eps</span><span class="s2">)</span>
        <span class="s1">cs </span><span class="s2">= </span><span class="s1">gbar </span><span class="s2">/ </span><span class="s1">gamma             </span><span class="s6"># ck</span>
        <span class="s1">sn </span><span class="s2">= </span><span class="s1">beta </span><span class="s2">/ </span><span class="s1">gamma             </span><span class="s6"># sk</span>
        <span class="s1">phi </span><span class="s2">= </span><span class="s1">cs </span><span class="s2">* </span><span class="s1">phibar              </span><span class="s6"># phik</span>
        <span class="s1">phibar </span><span class="s2">= </span><span class="s1">sn </span><span class="s2">* </span><span class="s1">phibar              </span><span class="s6"># phibark+1</span>

        <span class="s6"># Update  x.</span>

        <span class="s1">denom </span><span class="s2">= </span><span class="s4">1.0</span><span class="s2">/</span><span class="s1">gamma</span>
        <span class="s1">w1 </span><span class="s2">= </span><span class="s1">w2</span>
        <span class="s1">w2 </span><span class="s2">= </span><span class="s1">w</span>
        <span class="s1">w </span><span class="s2">= (</span><span class="s1">v </span><span class="s2">- </span><span class="s1">oldeps</span><span class="s2">*</span><span class="s1">w1 </span><span class="s2">- </span><span class="s1">delta</span><span class="s2">*</span><span class="s1">w2</span><span class="s2">) * </span><span class="s1">denom</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">phi</span><span class="s2">*</span><span class="s1">w</span>

        <span class="s6"># Go round again.</span>

        <span class="s1">gmax </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">gmax</span><span class="s2">, </span><span class="s1">gamma</span><span class="s2">)</span>
        <span class="s1">gmin </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">gmin</span><span class="s2">, </span><span class="s1">gamma</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">rhs1 </span><span class="s2">/ </span><span class="s1">gamma</span>
        <span class="s1">rhs1 </span><span class="s2">= </span><span class="s1">rhs2 </span><span class="s2">- </span><span class="s1">delta</span><span class="s2">*</span><span class="s1">z</span>
        <span class="s1">rhs2 </span><span class="s2">= - </span><span class="s1">epsln</span><span class="s2">*</span><span class="s1">z</span>

        <span class="s6"># Estimate various norms and test for convergence.</span>

        <span class="s1">Anorm </span><span class="s2">= </span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">tnorm2</span><span class="s2">)</span>
        <span class="s1">ynorm </span><span class="s2">= </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">epsa </span><span class="s2">= </span><span class="s1">Anorm </span><span class="s2">* </span><span class="s1">eps</span>
        <span class="s1">epsx </span><span class="s2">= </span><span class="s1">Anorm </span><span class="s2">* </span><span class="s1">ynorm </span><span class="s2">* </span><span class="s1">eps</span>
        <span class="s1">epsr </span><span class="s2">= </span><span class="s1">Anorm </span><span class="s2">* </span><span class="s1">ynorm </span><span class="s2">* </span><span class="s1">rtol</span>
        <span class="s1">diag </span><span class="s2">= </span><span class="s1">gbar</span>

        <span class="s0">if </span><span class="s1">diag </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">diag </span><span class="s2">= </span><span class="s1">epsa</span>

        <span class="s1">qrnorm </span><span class="s2">= </span><span class="s1">phibar</span>
        <span class="s1">rnorm </span><span class="s2">= </span><span class="s1">qrnorm</span>
        <span class="s0">if </span><span class="s1">ynorm </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">or </span><span class="s1">Anorm </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">test1 </span><span class="s2">= </span><span class="s1">inf</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">test1 </span><span class="s2">= </span><span class="s1">rnorm </span><span class="s2">/ (</span><span class="s1">Anorm</span><span class="s2">*</span><span class="s1">ynorm</span><span class="s2">)    </span><span class="s6"># ||r||  / (||A|| ||x||)</span>
        <span class="s0">if </span><span class="s1">Anorm </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">test2 </span><span class="s2">= </span><span class="s1">inf</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">test2 </span><span class="s2">= </span><span class="s1">root </span><span class="s2">/ </span><span class="s1">Anorm            </span><span class="s6"># ||Ar|| / (||A|| ||r||)</span>

        <span class="s6"># Estimate  cond(A).</span>
        <span class="s6"># In this version we look at the diagonals of  R  in the</span>
        <span class="s6"># factorization of the lower Hessenberg matrix,  Q @ H = R,</span>
        <span class="s6"># where H is the tridiagonal matrix from Lanczos with one</span>
        <span class="s6"># extra row, beta(k+1) e_k^T.</span>

        <span class="s1">Acond </span><span class="s2">= </span><span class="s1">gmax</span><span class="s2">/</span><span class="s1">gmin</span>

        <span class="s6"># See if any of the stopping criteria are satisfied.</span>
        <span class="s6"># In rare cases, istop is already -1 from above (Abar = const*I).</span>

        <span class="s0">if </span><span class="s1">istop </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">t1 </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">test1      </span><span class="s6"># These tests work if rtol &lt; eps</span>
            <span class="s1">t2 </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">test2</span>
            <span class="s0">if </span><span class="s1">t2 </span><span class="s2">&lt;= </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">2</span>
            <span class="s0">if </span><span class="s1">t1 </span><span class="s2">&lt;= </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">1</span>

            <span class="s0">if </span><span class="s1">itn </span><span class="s2">&gt;= </span><span class="s1">maxiter</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">6</span>
            <span class="s0">if </span><span class="s1">Acond </span><span class="s2">&gt;= </span><span class="s4">0.1</span><span class="s2">/</span><span class="s1">eps</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">4</span>
            <span class="s0">if </span><span class="s1">epsx </span><span class="s2">&gt;= </span><span class="s1">beta1</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">3</span>
            <span class="s6"># if rnorm &lt;= epsx   : istop = 2</span>
            <span class="s6"># if rnorm &lt;= epsr   : istop = 1</span>
            <span class="s0">if </span><span class="s1">test2 </span><span class="s2">&lt;= </span><span class="s1">rtol</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">2</span>
            <span class="s0">if </span><span class="s1">test1 </span><span class="s2">&lt;= </span><span class="s1">rtol</span><span class="s2">:</span>
                <span class="s1">istop </span><span class="s2">= </span><span class="s4">1</span>

        <span class="s6"># See if it is time to print something.</span>

        <span class="s1">prnt </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">n </span><span class="s2">&lt;= </span><span class="s4">40</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">itn </span><span class="s2">&lt;= </span><span class="s4">10</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">itn </span><span class="s2">&gt;= </span><span class="s1">maxiter</span><span class="s2">-</span><span class="s4">10</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">itn </span><span class="s2">% </span><span class="s4">10 </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">qrnorm </span><span class="s2">&lt;= </span><span class="s4">10</span><span class="s2">*</span><span class="s1">epsx</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">qrnorm </span><span class="s2">&lt;= </span><span class="s4">10</span><span class="s2">*</span><span class="s1">epsr</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">Acond </span><span class="s2">&lt;= </span><span class="s4">1e-2</span><span class="s2">/</span><span class="s1">eps</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">istop </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">prnt </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">show </span><span class="s0">and </span><span class="s1">prnt</span><span class="s2">:</span>
            <span class="s1">str1 </span><span class="s2">= </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">itn</span><span class="s0">:</span><span class="s3">6g</span><span class="s0">} {</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span><span class="s0">:</span><span class="s3">12.5e</span><span class="s0">} {</span><span class="s1">test1</span><span class="s0">:</span><span class="s3">10.3e</span><span class="s0">}</span><span class="s3">'</span>
            <span class="s1">str2 </span><span class="s2">= </span><span class="s3">f' </span><span class="s0">{</span><span class="s1">test2</span><span class="s0">:</span><span class="s3">10.3e</span><span class="s0">}</span><span class="s3">'</span>
            <span class="s1">str3 </span><span class="s2">= </span><span class="s3">f' </span><span class="s0">{</span><span class="s1">Anorm</span><span class="s0">:</span><span class="s3">8.1e</span><span class="s0">} {</span><span class="s1">Acond</span><span class="s0">:</span><span class="s3">8.1e</span><span class="s0">} {</span><span class="s1">gbar</span><span class="s2">/</span><span class="s1">Anorm</span><span class="s0">:</span><span class="s3">8.1e</span><span class="s0">}</span><span class="s3">'</span>

            <span class="s1">print</span><span class="s2">(</span><span class="s1">str1 </span><span class="s2">+ </span><span class="s1">str2 </span><span class="s2">+ </span><span class="s1">str3</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">itn </span><span class="s2">% </span><span class="s4">10 </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">callback </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">callback</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">istop </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">break  </span><span class="s6"># TODO check this</span>

    <span class="s0">if </span><span class="s1">show</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">()</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">last </span><span class="s2">+ </span><span class="s3">f' istop   =  </span><span class="s0">{</span><span class="s1">istop</span><span class="s0">:</span><span class="s3">3g</span><span class="s0">}               </span><span class="s3">itn   =</span><span class="s0">{</span><span class="s1">itn</span><span class="s0">:</span><span class="s3">5g</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">last </span><span class="s2">+ </span><span class="s3">f' Anorm   =  </span><span class="s0">{</span><span class="s1">Anorm</span><span class="s0">:</span><span class="s3">12.4e</span><span class="s0">}      </span><span class="s3">Acond =  </span><span class="s0">{</span><span class="s1">Acond</span><span class="s0">:</span><span class="s3">12.4e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">last </span><span class="s2">+ </span><span class="s3">f' rnorm   =  </span><span class="s0">{</span><span class="s1">rnorm</span><span class="s0">:</span><span class="s3">12.4e</span><span class="s0">}      </span><span class="s3">ynorm =  </span><span class="s0">{</span><span class="s1">ynorm</span><span class="s0">:</span><span class="s3">12.4e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">last </span><span class="s2">+ </span><span class="s3">f' Arnorm  =  </span><span class="s0">{</span><span class="s1">Arnorm</span><span class="s0">:</span><span class="s3">12.4e</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">last </span><span class="s2">+ </span><span class="s1">msg</span><span class="s2">[</span><span class="s1">istop</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">istop </span><span class="s2">== </span><span class="s4">6</span><span class="s2">:</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s1">maxiter</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">return </span><span class="s2">(</span><span class="s1">postprocess</span><span class="s2">(</span><span class="s1">x</span><span class="s2">),</span><span class="s1">info</span><span class="s2">)</span>
</pre>
</body>
</html>