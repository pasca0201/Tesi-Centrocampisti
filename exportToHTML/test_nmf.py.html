<html>
<head>
<title>test_nmf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_nmf.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">linalg</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">clone</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition </span><span class="s0">import </span><span class="s1">NMF</span><span class="s2">, </span><span class="s1">MiniBatchNMF</span><span class="s2">, </span><span class="s1">non_negative_factorization</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition </span><span class="s0">import </span><span class="s1">_nmf </span><span class="s0">as </span><span class="s1">nmf  </span><span class="s3"># For testing internals</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ConvergenceWarning</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">ignore_warnings</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">extmath </span><span class="s0">import </span><span class="s1">squared_norm</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSC_CONTAINERS</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_convergence_warning</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s1">convergence_warning </span><span class="s2">= (</span>
        <span class="s4">&quot;Maximum number of iterations 1 reached. Increase it to improve convergence.&quot;</span>
    <span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">ConvergenceWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">convergence_warning</span><span class="s2">):</span>
        <span class="s1">Estimator</span><span class="s2">(</span><span class="s1">max_iter</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">, **</span><span class="s1">solver</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_initialize_nn_output</span><span class="s2">():</span>
    <span class="s3"># Test that initialization does not return negative values</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">init </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvda&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">):</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s2">((</span><span class="s1">W </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">any</span><span class="s2">() </span><span class="s0">or </span><span class="s2">(</span><span class="s1">H </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">any</span><span class="s2">())</span>


<span class="s3"># TODO(1.6): remove the warning filter for `n_components`</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">r&quot;ignore:The multiplicative update \('mu'\) solver cannot update zeros present in&quot;</span>
    <span class="s4">r&quot; the initialization&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_parameter_checking</span><span class="s2">():</span>
    <span class="s3"># Here we only check for invalid parameter values that are not already</span>
    <span class="s3"># automatically tested in the common tests.</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Invalid beta_loss parameter: solver 'cd' does not handle beta_loss = 1.0&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">NMF</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;cd&quot;</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Negative values in data passed to&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">NMF</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(-</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">0.1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(-</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(-</span><span class="s1">A</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">init </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvda&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">]:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s4">&quot;init = '{}' can only be used when &quot;</span>
            <span class="s4">&quot;n_components &lt;= min(n_samples, n_features)&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">init</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">NMF</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">MiniBatchNMF</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">init</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_initialize_close</span><span class="s2">():</span>
    <span class="s3"># Test NNDSVD error</span>
    <span class="s3"># Test that _initialize_nmf error is less than the standard deviation of</span>
    <span class="s3"># the entries in the matrix.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">) - </span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">sdev </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">A </span><span class="s2">- </span><span class="s1">A</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">error </span><span class="s2">&lt;= </span><span class="s1">sdev</span>


<span class="s0">def </span><span class="s1">test_initialize_variants</span><span class="s2">():</span>
    <span class="s3"># Test NNDSVD variants correctness</span>
    <span class="s3"># Test that the variants 'nndsvda' and 'nndsvdar' differ from basic</span>
    <span class="s3"># 'nndsvd' only where the basic version has zeros.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">W0</span><span class="s2">, </span><span class="s1">H0 </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">)</span>
    <span class="s1">Wa</span><span class="s2">, </span><span class="s1">Ha </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvda&quot;</span><span class="s2">)</span>
    <span class="s1">War</span><span class="s2">, </span><span class="s1">Har </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">evl </span><span class="s0">in </span><span class="s2">((</span><span class="s1">W0</span><span class="s2">, </span><span class="s1">Wa</span><span class="s2">), (</span><span class="s1">W0</span><span class="s2">, </span><span class="s1">War</span><span class="s2">), (</span><span class="s1">H0</span><span class="s2">, </span><span class="s1">Ha</span><span class="s2">), (</span><span class="s1">H0</span><span class="s2">, </span><span class="s1">Har</span><span class="s2">)):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">evl</span><span class="s2">[</span><span class="s1">ref </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">[</span><span class="s1">ref </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">])</span>


<span class="s3"># ignore UserWarning raised when both solver='mu' and init='nndsvd'</span>
<span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;init&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvda&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">, </span><span class="s4">&quot;random&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_W&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_H&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s4">&quot;same&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_nmf_fit_nn_output</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">init</span><span class="s2">, </span><span class="s1">alpha_W</span><span class="s2">, </span><span class="s1">alpha_H</span><span class="s2">):</span>
    <span class="s3"># Test that the decomposition does not contain negative values</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s5">5.0 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">), </span><span class="s5">5.0 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)]</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha_W</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s1">alpha_H</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">transf </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s2">((</span><span class="s1">model</span><span class="s2">.</span><span class="s1">components_ </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">any</span><span class="s2">() </span><span class="s0">or </span><span class="s2">(</span><span class="s1">transf </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">any</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_fit_close</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s3"># Test that the fit is not too far away</span>
    <span class="s1">pnmf </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s5">5</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">600</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">pnmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">reconstruction_err_ </span><span class="s2">&lt; </span><span class="s5">0.1</span>


<span class="s0">def </span><span class="s1">test_nmf_true_reconstruction</span><span class="s2">():</span>
    <span class="s3"># Test that the fit is not too far away from an exact solution</span>
    <span class="s3"># (by construction)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">15</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">beta_loss </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">batch_size </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">max_iter </span><span class="s2">= </span><span class="s5">1000</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">W_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">])</span>
    <span class="s1">W_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">):</span>
        <span class="s1">W_true</span><span class="s2">[</span><span class="s1">j </span><span class="s2">% </span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">W_array</span><span class="s2">[</span><span class="s1">j </span><span class="s2">% </span><span class="s1">n_samples</span><span class="s2">]</span>
    <span class="s1">H_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">])</span>
    <span class="s1">H_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">):</span>
        <span class="s1">H_true</span><span class="s2">[</span><span class="s1">j </span><span class="s2">% </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">H_array</span><span class="s2">[</span><span class="s1">j </span><span class="s2">% </span><span class="s1">n_components</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">W_true</span><span class="s2">, </span><span class="s1">H_true</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
        <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">transf </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_calc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">transf</span><span class="s2">, </span><span class="s1">model</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">reconstruction_err_ </span><span class="s2">&lt; </span><span class="s5">0.1</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_calc</span><span class="s2">)</span>

    <span class="s1">mbmodel </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
        <span class="s1">batch_size</span><span class="s2">=</span><span class="s1">batch_size</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">transf </span><span class="s2">= </span><span class="s1">mbmodel</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_calc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">transf</span><span class="s2">, </span><span class="s1">mbmodel</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">mbmodel</span><span class="s2">.</span><span class="s1">reconstruction_err_ </span><span class="s2">&lt; </span><span class="s5">0.1</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_calc</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;solver&quot;</span><span class="s2">, [</span><span class="s4">&quot;cd&quot;</span><span class="s2">, </span><span class="s4">&quot;mu&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_nmf_transform</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># Test that fit_transform is equivalent to fit.transform for NMF</span>
    <span class="s3"># Test that NMF.transform returns close values</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">ft </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ft</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_minibatch_nmf_transform</span><span class="s2">():</span>
    <span class="s3"># Test that fit_transform is equivalent to fit.transform for MiniBatchNMF</span>
    <span class="s3"># Only guaranteed with fresh restarts</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">,</span>
        <span class="s1">fresh_restarts</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">ft </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ft</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_transform_custom_init</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># Smoke test that checks if NMF.transform works with custom initialization</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">4</span>
    <span class="s1">avg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() / </span><span class="s1">n_components</span><span class="s2">)</span>
    <span class="s1">H_init </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">avg </span><span class="s2">* </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W_init </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">avg </span><span class="s2">* </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">))</span>

    <span class="s1">m </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">, **</span><span class="s1">solver</span>
    <span class="s2">)</span>
    <span class="s1">m</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W_init</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_init</span><span class="s2">)</span>
    <span class="s1">m</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;solver&quot;</span><span class="s2">, (</span><span class="s4">&quot;cd&quot;</span><span class="s2">, </span><span class="s4">&quot;mu&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_nmf_inverse_transform</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># Test that NMF.inverse_transform returns close values</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">4</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">1000</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">ft </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">A_new </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">ft</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">A_new</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mbnmf_inverse_transform</span><span class="s2">():</span>
    <span class="s3"># Test that MiniBatchNMF.transform followed by MiniBatchNMF.inverse_transform</span>
    <span class="s3"># is close to the identity</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">500</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;nndsvdar&quot;</span><span class="s2">,</span>
        <span class="s1">fresh_restarts</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">ft </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">A_new </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">ft</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">A_new</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, [</span><span class="s1">NMF</span><span class="s2">, </span><span class="s1">MiniBatchNMF</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_n_components_greater_n_features</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s3"># Smoke test for the case of more components than features.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">30</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">Estimator</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">15</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSC_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_W&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_H&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s4">&quot;same&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_nmf_sparse_input</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">sparse_container</span><span class="s2">, </span><span class="s1">alpha_W</span><span class="s2">, </span><span class="s1">alpha_H</span><span class="s2">):</span>
    <span class="s3"># Test that sparse matrices are accepted as input</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">A</span><span class="s2">[:, </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)] = </span><span class="s5">0</span>
    <span class="s1">A_sparse </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>

    <span class="s1">est1 </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha_W</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s1">alpha_H</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">100</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">est2 </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">est1</span><span class="s2">)</span>

    <span class="s1">W1 </span><span class="s2">= </span><span class="s1">est1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">W2 </span><span class="s2">= </span><span class="s1">est2</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A_sparse</span><span class="s2">)</span>
    <span class="s1">H1 </span><span class="s2">= </span><span class="s1">est1</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s1">H2 </span><span class="s2">= </span><span class="s1">est2</span><span class="s2">.</span><span class="s1">components_</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W1</span><span class="s2">, </span><span class="s1">W2</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">H1</span><span class="s2">, </span><span class="s1">H2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csc_container&quot;</span><span class="s2">, </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_sparse_transform</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">csc_container</span><span class="s2">):</span>
    <span class="s3"># Test that transform works on sparse data.  Issue #2124</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">A</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_container</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s5">400</span><span class="s2">, **</span><span class="s1">solver</span><span class="s2">)</span>
    <span class="s1">A_fit_tr </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">A_tr </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A_fit_tr</span><span class="s2">, </span><span class="s1">A_tr</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-1</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;init&quot;</span><span class="s2">, [</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s4">&quot;nndsvd&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;solver&quot;</span><span class="s2">, (</span><span class="s4">&quot;cd&quot;</span><span class="s2">, </span><span class="s4">&quot;mu&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_W&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;alpha_H&quot;</span><span class="s2">, (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s4">&quot;same&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_non_negative_factorization_consistency</span><span class="s2">(</span><span class="s1">init</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">alpha_W</span><span class="s2">, </span><span class="s1">alpha_H</span><span class="s2">):</span>
    <span class="s3"># Test that the function is called in the same way, either directly</span>
    <span class="s3"># or through the NMF class</span>
    <span class="s1">max_iter </span><span class="s2">= </span><span class="s5">500</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">A</span><span class="s2">[:, </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)] = </span><span class="s5">0</span>

    <span class="s1">W_nmf</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
        <span class="s1">A</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">,</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha_W</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s1">alpha_H</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">W_nmf_2</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
        <span class="s1">A</span><span class="s2">,</span>
        <span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">,</span>
        <span class="s1">update_H</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">,</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha_W</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s1">alpha_H</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">model_class </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s1">init</span><span class="s2">,</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha_W</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s1">alpha_H</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">W_cls </span><span class="s2">= </span><span class="s1">model_class</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">W_cls_2 </span><span class="s2">= </span><span class="s1">model_class</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W_nmf</span><span class="s2">, </span><span class="s1">W_cls</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W_nmf_2</span><span class="s2">, </span><span class="s1">W_cls_2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_non_negative_factorization_checking</span><span class="s2">():</span>
    <span class="s3"># Note that the validity of parameter types and range of possible values</span>
    <span class="s3"># for scalar numerical or str parameters is already checked in the common</span>
    <span class="s3"># tests. Here we only check for problems that cannot be captured by simple</span>
    <span class="s3"># declarative constraints on the valid parameter values.</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s3"># Test parameters checking in public function</span>
    <span class="s1">nnmf </span><span class="s2">= </span><span class="s1">non_negative_factorization</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;Negative values in data passed to NMF (input H)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nnmf</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, -</span><span class="s1">A</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;Negative values in data passed to NMF (input W)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nnmf</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, -</span><span class="s1">A</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;Array passed to NMF (input H) is full of zeros&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nnmf</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s5">0 </span><span class="s2">* </span><span class="s1">A</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_beta_divergence_dense</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Compute the beta-divergence of X and W.H for dense array only. 
 
    Used as a reference for testing nmf._beta_divergence. 
    &quot;&quot;&quot;</span>
    <span class="s1">WH </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">beta </span><span class="s2">== </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">squared_norm</span><span class="s2">(</span><span class="s1">X </span><span class="s2">- </span><span class="s1">WH</span><span class="s2">) / </span><span class="s5">2</span>

    <span class="s1">WH_Xnonzero </span><span class="s2">= </span><span class="s1">WH</span><span class="s2">[</span><span class="s1">X </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">X_nonzero </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s1">X </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">WH_Xnonzero</span><span class="s2">, </span><span class="s5">1e-9</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">WH_Xnonzero</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">beta </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">X_nonzero </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">X_nonzero </span><span class="s2">/ </span><span class="s1">WH_Xnonzero</span><span class="s2">))</span>
        <span class="s1">res </span><span class="s2">+= </span><span class="s1">WH</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() - </span><span class="s1">X</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s0">elif </span><span class="s1">beta </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">div </span><span class="s2">= </span><span class="s1">X_nonzero </span><span class="s2">/ </span><span class="s1">WH_Xnonzero</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">div</span><span class="s2">) - </span><span class="s1">X</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">div</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= (</span><span class="s1">X_nonzero</span><span class="s2">**</span><span class="s1">beta</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">+= (</span><span class="s1">beta </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">WH</span><span class="s2">**</span><span class="s1">beta</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">-= </span><span class="s1">beta </span><span class="s2">* (</span><span class="s1">X_nonzero </span><span class="s2">* (</span><span class="s1">WH_Xnonzero </span><span class="s2">** (</span><span class="s1">beta </span><span class="s2">- </span><span class="s5">1</span><span class="s2">))).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">/= </span><span class="s1">beta </span><span class="s2">* (</span><span class="s1">beta </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">res</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_beta_divergence</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3"># Compare _beta_divergence with the reference _beta_divergence_dense</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">beta_losses </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">]</span>

    <span class="s3"># initialization</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">clip</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">beta </span><span class="s0">in </span><span class="s1">beta_losses</span><span class="s2">:</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">_beta_divergence_dense</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">)</span>
        <span class="s1">loss </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_beta_divergence</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">)</span>
        <span class="s1">loss_csr </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_beta_divergence</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">)</span>

        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">7</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">loss_csr</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">7</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_special_sparse_dot</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3"># Test the function that computes np.dot(W, H), only where X is non zero.</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">clip</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">W </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">))</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>

    <span class="s1">WH_safe </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_special_sparse_dot</span><span class="s2">(</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">)</span>
    <span class="s1">WH </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_special_sparse_dot</span><span class="s2">(</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s3"># test that both results have same values, in X_csr nonzero elements</span>
    <span class="s1">ii</span><span class="s2">, </span><span class="s1">jj </span><span class="s2">= </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()</span>
    <span class="s1">WH_safe_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">WH_safe</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">, </span><span class="s1">jj</span><span class="s2">]).</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">WH_safe_data</span><span class="s2">, </span><span class="s1">WH</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">, </span><span class="s1">jj</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s3"># test that WH_safe and X_csr have the same sparse structure</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">WH_safe</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">WH_safe</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">WH_safe</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">ConvergenceWarning</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_multiplicative_update_sparse</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3"># Compare sparse and dense input in multiplicative update NMF</span>
    <span class="s3"># Also test continuity of the results with respect to beta_loss parameter</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s5">0.1</span>
    <span class="s1">l1_ratio </span><span class="s2">= </span><span class="s5">0.5</span>
    <span class="s1">n_iter </span><span class="s2">= </span><span class="s5">20</span>

    <span class="s3"># initialization</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1337</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">W0</span><span class="s2">, </span><span class="s1">H0 </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">beta_loss </span><span class="s0">in </span><span class="s2">(-</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">):</span>
        <span class="s3"># Reference with dense array X</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">W0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">H0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">W1</span><span class="s2">, </span><span class="s1">H1</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">,</span>
            <span class="s1">W</span><span class="s2">,</span>
            <span class="s1">H</span><span class="s2">,</span>
            <span class="s1">n_components</span><span class="s2">,</span>
            <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
            <span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
            <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
            <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">n_iter</span><span class="s2">,</span>
            <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s3"># Compare with sparse X</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">W0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">H0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">W2</span><span class="s2">, </span><span class="s1">H2</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X_csr</span><span class="s2">,</span>
            <span class="s1">W</span><span class="s2">,</span>
            <span class="s1">H</span><span class="s2">,</span>
            <span class="s1">n_components</span><span class="s2">,</span>
            <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
            <span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
            <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
            <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">n_iter</span><span class="s2">,</span>
            <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W1</span><span class="s2">, </span><span class="s1">W2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">H1</span><span class="s2">, </span><span class="s1">H2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-7</span><span class="s2">)</span>

        <span class="s3"># Compare with almost same beta_loss, since some values have a specific</span>
        <span class="s3"># behavior, but the results should be continuous w.r.t beta_loss</span>
        <span class="s1">beta_loss </span><span class="s2">-= </span><span class="s5">1.0e-5</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">W0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">H0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">W3</span><span class="s2">, </span><span class="s1">H3</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X_csr</span><span class="s2">,</span>
            <span class="s1">W</span><span class="s2">,</span>
            <span class="s1">H</span><span class="s2">,</span>
            <span class="s1">n_components</span><span class="s2">,</span>
            <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
            <span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
            <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
            <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">n_iter</span><span class="s2">,</span>
            <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W1</span><span class="s2">, </span><span class="s1">W3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">H1</span><span class="s2">, </span><span class="s1">H3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-4</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_negative_beta_loss</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3"># Test that an error is raised if beta_loss &lt; 0 and X contains zeros.</span>
    <span class="s3"># Test that the output has not NaN values when the input contains zeros.</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">6</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">3</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">clip</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_assert_nmf_no_nan</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">):</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">,</span>
            <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">,</span>
            <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
            <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
            <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
            <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">1000</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">W</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">H</span><span class="s2">))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;When beta_loss &lt;= 0 and X contains zeros, the solver may diverge.&quot;</span>
    <span class="s0">for </span><span class="s1">beta_loss </span><span class="s0">in </span><span class="s2">(-</span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">_assert_nmf_no_nan</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">)</span>
        <span class="s1">_assert_nmf_no_nan</span><span class="s2">(</span><span class="s1">X </span><span class="s2">+ </span><span class="s5">1e-9</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">beta_loss </span><span class="s0">in </span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">):</span>
        <span class="s1">_assert_nmf_no_nan</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">)</span>
        <span class="s1">_assert_nmf_no_nan</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;beta_loss&quot;</span><span class="s2">, [-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_minibatch_nmf_negative_beta_loss</span><span class="s2">(</span><span class="s1">beta_loss</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that an error is raised if beta_loss &lt; 0 and X contains zeros.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s1">X </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>

    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span><span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;When beta_loss &lt;= 0 and X contains zeros, the solver may diverge.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_regularization</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># Test the effect of L1 and L2 regularizations</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">6</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>

    <span class="s3"># L1 regularization should increase the number of zeros</span>
    <span class="s1">l1_ratio </span><span class="s2">= </span><span class="s5">1.0</span>
    <span class="s1">regul </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">,</span>
        <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">,</span>
        <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">W_regul </span><span class="s2">= </span><span class="s1">regul</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">W_model </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">H_regul </span><span class="s2">= </span><span class="s1">regul</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s1">H_model </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">components_</span>

    <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">eps</span>
    <span class="s1">W_regul_n_zeros </span><span class="s2">= </span><span class="s1">W_regul</span><span class="s2">[</span><span class="s1">W_regul </span><span class="s2">&lt;= </span><span class="s1">eps</span><span class="s2">].</span><span class="s1">size</span>
    <span class="s1">W_model_n_zeros </span><span class="s2">= </span><span class="s1">W_model</span><span class="s2">[</span><span class="s1">W_model </span><span class="s2">&lt;= </span><span class="s1">eps</span><span class="s2">].</span><span class="s1">size</span>
    <span class="s1">H_regul_n_zeros </span><span class="s2">= </span><span class="s1">H_regul</span><span class="s2">[</span><span class="s1">H_regul </span><span class="s2">&lt;= </span><span class="s1">eps</span><span class="s2">].</span><span class="s1">size</span>
    <span class="s1">H_model_n_zeros </span><span class="s2">= </span><span class="s1">H_model</span><span class="s2">[</span><span class="s1">H_model </span><span class="s2">&lt;= </span><span class="s1">eps</span><span class="s2">].</span><span class="s1">size</span>

    <span class="s0">assert </span><span class="s1">W_regul_n_zeros </span><span class="s2">&gt; </span><span class="s1">W_model_n_zeros</span>
    <span class="s0">assert </span><span class="s1">H_regul_n_zeros </span><span class="s2">&gt; </span><span class="s1">H_model_n_zeros</span>

    <span class="s3"># L2 regularization should decrease the sum of the squared norm</span>
    <span class="s3"># of the matrices W and H</span>
    <span class="s1">l1_ratio </span><span class="s2">= </span><span class="s5">0.0</span>
    <span class="s1">regul </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">,</span>
        <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">,</span>
        <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">W_regul </span><span class="s2">= </span><span class="s1">regul</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">W_model </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">H_regul </span><span class="s2">= </span><span class="s1">regul</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s1">H_model </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">components_</span>

    <span class="s0">assert </span><span class="s2">(</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">W_model</span><span class="s2">)) ** </span><span class="s5">2.0 </span><span class="s2">+ (</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">H_model</span><span class="s2">)) ** </span><span class="s5">2.0 </span><span class="s2">&gt; (</span>
        <span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">W_regul</span><span class="s2">)</span>
    <span class="s2">) ** </span><span class="s5">2.0 </span><span class="s2">+ (</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">H_regul</span><span class="s2">)) ** </span><span class="s5">2.0</span>


<span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">ConvergenceWarning</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;solver&quot;</span><span class="s2">, (</span><span class="s4">&quot;cd&quot;</span><span class="s2">, </span><span class="s4">&quot;mu&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_nmf_decreasing</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># test that the objective function is decreasing at each iteration</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">15</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s5">0.1</span>
    <span class="s1">l1_ratio </span><span class="s2">= </span><span class="s5">0.5</span>
    <span class="s1">tol </span><span class="s2">= </span><span class="s5">0.0</span>

    <span class="s3"># initialization</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">W0</span><span class="s2">, </span><span class="s1">H0 </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">beta_loss </span><span class="s0">in </span><span class="s2">(-</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">solver </span><span class="s2">!= </span><span class="s4">&quot;mu&quot; </span><span class="s0">and </span><span class="s1">beta_loss </span><span class="s2">!= </span><span class="s5">2</span><span class="s2">:</span>
            <span class="s3"># not implemented</span>
            <span class="s0">continue</span>
        <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">W0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">H0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">previous_loss </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">30</span><span class="s2">):</span>
            <span class="s3"># one more iteration starting from the previous results</span>
            <span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
                <span class="s1">X</span><span class="s2">,</span>
                <span class="s1">W</span><span class="s2">,</span>
                <span class="s1">H</span><span class="s2">,</span>
                <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
                <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
                <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
                <span class="s1">max_iter</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
                <span class="s1">alpha_W</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
                <span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
                <span class="s1">tol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">,</span>
                <span class="s1">l1_ratio</span><span class="s2">=</span><span class="s1">l1_ratio</span><span class="s2">,</span>
                <span class="s1">verbose</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                <span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>

            <span class="s1">loss </span><span class="s2">= (</span>
                <span class="s1">nmf</span><span class="s2">.</span><span class="s1">_beta_divergence</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta_loss</span><span class="s2">)</span>
                <span class="s2">+ </span><span class="s1">alpha </span><span class="s2">* </span><span class="s1">l1_ratio </span><span class="s2">* </span><span class="s1">n_features </span><span class="s2">* </span><span class="s1">W</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
                <span class="s2">+ </span><span class="s1">alpha </span><span class="s2">* </span><span class="s1">l1_ratio </span><span class="s2">* </span><span class="s1">n_samples </span><span class="s2">* </span><span class="s1">H</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
                <span class="s2">+ </span><span class="s1">alpha </span><span class="s2">* (</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">l1_ratio</span><span class="s2">) * </span><span class="s1">n_features </span><span class="s2">* (</span><span class="s1">W</span><span class="s2">**</span><span class="s5">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
                <span class="s2">+ </span><span class="s1">alpha </span><span class="s2">* (</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">l1_ratio</span><span class="s2">) * </span><span class="s1">n_samples </span><span class="s2">* (</span><span class="s1">H</span><span class="s2">**</span><span class="s5">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">previous_loss </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">previous_loss </span><span class="s2">&gt; </span><span class="s1">loss</span>
            <span class="s1">previous_loss </span><span class="s2">= </span><span class="s1">loss</span>


<span class="s0">def </span><span class="s1">test_nmf_underflow</span><span class="s2">():</span>
    <span class="s3"># Regression test for an underflow issue in _beta_divergence</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">n_components </span><span class="s2">= </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)) * </span><span class="s5">10</span>
    <span class="s1">W </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">)) * </span><span class="s5">10</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>

    <span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_beta_divergence</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">1e-323</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_beta_divergence</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;dtype_in, dtype_out&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_dtype_match</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">dtype_in</span><span class="s2">, </span><span class="s1">dtype_out</span><span class="s2">):</span>
    <span class="s3"># Check that NMF preserves dtype (float32 and float64)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">20</span><span class="s2">, </span><span class="s5">15</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype_in</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">alpha_W</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">,</span>
        <span class="s1">alpha_H</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">solver</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype_out</span>
    <span class="s0">assert </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype_out</span>
    <span class="s0">assert </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype_out</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;solver&quot;</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;cd&quot;</span><span class="s2">}], [</span><span class="s1">NMF</span><span class="s2">, {</span><span class="s4">&quot;solver&quot;</span><span class="s2">: </span><span class="s4">&quot;mu&quot;</span><span class="s2">}], [</span><span class="s1">MiniBatchNMF</span><span class="s2">, {}]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nmf_float32_float64_consistency</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
    <span class="s3"># Check that the result of NMF is the same between float32 and float64</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">50</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">nmf32 </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">, **</span><span class="s1">solver</span><span class="s2">)</span>
    <span class="s1">W32 </span><span class="s2">= </span><span class="s1">nmf32</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>
    <span class="s1">nmf64 </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">, **</span><span class="s1">solver</span><span class="s2">)</span>
    <span class="s1">W64 </span><span class="s2">= </span><span class="s1">nmf64</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W32</span><span class="s2">, </span><span class="s1">W64</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-5</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, [</span><span class="s1">NMF</span><span class="s2">, </span><span class="s1">MiniBatchNMF</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_nmf_custom_init_dtype_error</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s3"># Check that an error is raise if custom H and/or W don't have the same</span>
    <span class="s3"># dtype as X.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">20</span><span class="s2">, </span><span class="s5">15</span><span class="s2">))</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">15</span><span class="s2">, </span><span class="s5">15</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
    <span class="s1">W </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">20</span><span class="s2">, </span><span class="s5">15</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;should have the same dtype as X&quot;</span><span class="s2">):</span>
        <span class="s1">Estimator</span><span class="s2">(</span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;should have the same dtype as X&quot;</span><span class="s2">):</span>
        <span class="s1">non_negative_factorization</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">, </span><span class="s1">update_H</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;beta_loss&quot;</span><span class="s2">, [-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_nmf_minibatchnmf_equivalence</span><span class="s2">(</span><span class="s1">beta_loss</span><span class="s2">):</span>
    <span class="s3"># Test that MiniBatchNMF is equivalent to NMF when batch_size = n_samples and</span>
    <span class="s3"># forget_factor 0.0 (stopping criterion put aside)</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">48</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>

    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
        <span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;mu&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">mbnmf </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">beta_loss</span><span class="s2">=</span><span class="s1">beta_loss</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_no_improvement</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">batch_size</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s1">forget_factor</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">W </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">mbW </span><span class="s2">= </span><span class="s1">mbnmf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">W</span><span class="s2">, </span><span class="s1">mbW</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_minibatch_nmf_partial_fit</span><span class="s2">():</span>
    <span class="s3"># Check fit / partial_fit equivalence. Applicable only with fresh restarts.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">mtrand</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>

    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">batch_size </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">max_iter </span><span class="s2">= </span><span class="s5">2</span>

    <span class="s1">mbnmf1 </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_iter</span><span class="s2">=</span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">batch_size</span><span class="s2">=</span><span class="s1">batch_size</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_no_improvement</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">fresh_restarts</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">mbnmf2 </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># Force the same init of H (W is recomputed anyway) to be able to compare results.</span>
    <span class="s1">W</span><span class="s2">, </span><span class="s1">H </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">_initialize_nmf</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s2">)</span>

    <span class="s1">mbnmf1</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">max_iter</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">batch_size</span><span class="s2">):</span>
            <span class="s1">mbnmf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">j </span><span class="s2">: </span><span class="s1">j </span><span class="s2">+ </span><span class="s1">batch_size</span><span class="s2">], </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W</span><span class="s2">[:</span><span class="s1">batch_size</span><span class="s2">], </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">mbnmf1</span><span class="s2">.</span><span class="s1">n_steps_ </span><span class="s2">== </span><span class="s1">mbnmf2</span><span class="s2">.</span><span class="s1">n_steps_</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">mbnmf1</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">mbnmf2</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_feature_names_out</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check feature names out for NMF.&quot;&quot;&quot;</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">names </span><span class="s2">= </span><span class="s1">nmf</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s4">f&quot;nmf</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">)</span>


<span class="s3"># TODO(1.6): remove the warning filter</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:The default value of `n_components` will change&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_minibatch_nmf_verbose</span><span class="s2">():</span>
    <span class="s3"># Check verbose mode of MiniBatchNMF for better coverage.</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">MiniBatchNMF</span><span class="s2">(</span><span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">old_stdout </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">()</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
    <span class="s0">finally</span><span class="s2">:</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout </span><span class="s2">= </span><span class="s1">old_stdout</span>


<span class="s3"># TODO(1.7): remove this test</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, [</span><span class="s1">NMF</span><span class="s2">, </span><span class="s1">MiniBatchNMF</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_NMF_inverse_transform_Xt_deprecation</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Missing required positional argument&quot;</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Cannot use both X and Xt. Use X only&quot;</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Xt</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">)</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Xt was renamed X in version 1.5&quot;</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Estimator&quot;</span><span class="s2">, [</span><span class="s1">NMF</span><span class="s2">, </span><span class="s1">MiniBatchNMF</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_nmf_n_components_auto</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s3"># Check that n_components is correctly inferred</span>
    <span class="s3"># from the provided custom initialization.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">,</span>
        <span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">tol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est</span><span class="s2">.</span><span class="s1">_n_components </span><span class="s2">== </span><span class="s1">H</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_nmf_non_negative_factorization_n_components_auto</span><span class="s2">():</span>
    <span class="s3"># Check that n_components is correctly inferred from the provided</span>
    <span class="s3"># custom initialization.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W_init </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">H_init </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W_init</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_init</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">H</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">H_init</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">W</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">W_init</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s3"># TODO(1.6): remove</span>
<span class="s0">def </span><span class="s1">test_nmf_n_components_default_value_warning</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
        <span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;The default value of `n_components` will change from&quot;</span>
    <span class="s2">):</span>
        <span class="s1">non_negative_factorization</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nmf_n_components_auto_no_h_update</span><span class="s2">():</span>
    <span class="s3"># Tests that non_negative_factorization does not fail when setting</span>
    <span class="s3"># n_components=&quot;auto&quot; also tests that the inferred n_component</span>
    <span class="s3"># value is the right one.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">H_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W</span><span class="s2">, </span><span class="s1">H</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">non_negative_factorization</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_true</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">update_H</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)  </span><span class="s3"># should not fail</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">H_true</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">W</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">H_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_nmf_w_h_not_used_warning</span><span class="s2">():</span>
    <span class="s3"># Check that warnings are raised if user provided W and H are not used</span>
    <span class="s3"># and initialization overrides value of W or H</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">W_init </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">H_init </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
        <span class="s1">RuntimeWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;When init!='custom', provided W or H are ignored&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">non_negative_factorization</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_init</span><span class="s2">, </span><span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
        <span class="s1">RuntimeWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;When init!='custom', provided W or H are ignored&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W_init</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_init</span><span class="s2">, </span><span class="s1">update_H</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
        <span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;When update_H=False, the provided initial W is not used.&quot;</span>
    <span class="s2">):</span>
        <span class="s3"># When update_H is False, W is ignored regardless of init</span>
        <span class="s3"># TODO: use the provided W when init=&quot;custom&quot;.</span>
        <span class="s1">non_negative_factorization</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">W_init</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H_init</span><span class="s2">, </span><span class="s1">update_H</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nmf_custom_init_shape_error</span><span class="s2">():</span>
    <span class="s3"># Check that an informative error is raised when custom initialization does not</span>
    <span class="s3"># have the right shape</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">nmf </span><span class="s2">= </span><span class="s1">NMF</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">init</span><span class="s2">=</span><span class="s4">&quot;custom&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Array with wrong first dimension passed&quot;</span><span class="s2">):</span>
        <span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Array with wrong second dimension passed&quot;</span><span class="s2">):</span>
        <span class="s1">nmf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">H</span><span class="s2">=</span><span class="s1">H</span><span class="s2">, </span><span class="s1">W</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)))</span>
</pre>
</body>
</html>