<html>
<head>
<title>test_netcdf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_netcdf.py</font>
</center></td></tr></table>
<pre><span class="s0">''' Tests for netcdf '''</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">join </span><span class="s2">as </span><span class="s1">pjoin</span><span class="s3">, </span><span class="s1">dirname</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">BytesIO</span>
<span class="s2">from </span><span class="s1">glob </span><span class="s2">import </span><span class="s1">glob</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">contextmanager</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">,</span>
                           <span class="s1">break_cycles</span><span class="s3">, </span><span class="s1">suppress_warnings</span><span class="s3">, </span><span class="s1">IS_PYPY</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">io </span><span class="s2">import </span><span class="s1">netcdf_file</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_tmpdirs </span><span class="s2">import </span><span class="s1">in_tempdir</span>

<span class="s1">TEST_DATA_PATH </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">__file__</span><span class="s3">), </span><span class="s4">'data'</span><span class="s3">)</span>

<span class="s1">N_EG_ELS </span><span class="s3">= </span><span class="s5">11  </span><span class="s6"># number of elements for example variable</span>
<span class="s1">VARTYPE_EG </span><span class="s3">= </span><span class="s4">'b'  </span><span class="s6"># var type for example variable</span>


<span class="s3">@</span><span class="s1">contextmanager</span>
<span class="s2">def </span><span class="s1">make_simple</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">history </span><span class="s3">= </span><span class="s4">'Created for a test'</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'time'</span><span class="s3">, </span><span class="s1">N_EG_ELS</span><span class="s3">)</span>
    <span class="s1">time </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'time'</span><span class="s3">, </span><span class="s1">VARTYPE_EG</span><span class="s3">, (</span><span class="s4">'time'</span><span class="s3">,))</span>
    <span class="s1">time</span><span class="s3">[:] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">N_EG_ELS</span><span class="s3">)</span>
    <span class="s1">time</span><span class="s3">.</span><span class="s1">units </span><span class="s3">= </span><span class="s4">'days since 2008-01-01'</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
    <span class="s2">yield </span><span class="s1">f</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">check_simple</span><span class="s3">(</span><span class="s1">ncfileobj</span><span class="s3">):</span>
    <span class="s0">'''Example fileobj tests '''</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">ncfileobj</span><span class="s3">.</span><span class="s1">history</span><span class="s3">, </span><span class="s7">b'Created for a test'</span><span class="s3">)</span>
    <span class="s1">time </span><span class="s3">= </span><span class="s1">ncfileobj</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'time'</span><span class="s3">]</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">time</span><span class="s3">.</span><span class="s1">units</span><span class="s3">, </span><span class="s7">b'days since 2008-01-01'</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">time</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">N_EG_ELS</span><span class="s3">,))</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">time</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">N_EG_ELS</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">expected_mask</span><span class="s3">):</span>
    <span class="s0">''' 
    Asserts that the mask of arr is effectively the same as expected_mask. 
 
    In contrast to numpy.ma.testutils.assert_mask_equal, this function allows 
    testing the 'mask' of a standard numpy array (the mask in this case is treated 
    as all False). 
 
    Parameters 
    ---------- 
    arr : ndarray or MaskedArray 
        Array to test. 
    expected_mask : array_like of booleans 
        A list giving the expected mask. 
    '''</span>

    <span class="s1">mask </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">getmaskarray</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mask</span><span class="s3">, </span><span class="s1">expected_mask</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_write_files</span><span class="s3">():</span>
    <span class="s6"># test round trip for example file</span>
    <span class="s1">cwd </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">()</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">tmpdir </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">mkdtemp</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s6"># read the file we just created in 'a' mode</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'a'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s6"># add something</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'appendRan'</span><span class="s3">] = </span><span class="s5">1</span>

        <span class="s6"># To read the NetCDF file we just created::</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s6"># Using mmap is the default (but not on pypy)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">, </span><span class="s2">not </span><span class="s1">IS_PYPY</span><span class="s3">)</span>
            <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'appendRan'</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Read it in append (and check mmap is off)</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'a'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">)</span>
            <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'appendRan'</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Now without mmap</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s6"># Using mmap is the default</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">)</span>
            <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

        <span class="s6"># To read the NetCDF file we just created, as file object, no</span>
        <span class="s6"># mmap.  When n * n_bytes(var_type) is not divisible by 4, this</span>
        <span class="s6"># raised an error in pupynere 1.0.12 and scipy rev 5893, because</span>
        <span class="s6"># calculated vsize was rounding up in units of 4 - see</span>
        <span class="s6"># https://www.unidata.ucar.edu/software/netcdf/guide_toc.html</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fobj</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fobj</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s6"># by default, don't use mmap for file-like</span>
                <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">)</span>
                <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

        <span class="s6"># Read file from fileobj, with mmap</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">IS_PYPY</span><span class="s3">:</span>
                <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">,</span>
                           <span class="s4">&quot;Cannot close a netcdf_file opened with mmap=True.*&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'rb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fobj</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fobj</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">)</span>
                    <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

        <span class="s6"># Again read it in append mode (adding another att)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">, </span><span class="s4">'r+b'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fobj</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fobj</span><span class="s3">, </span><span class="s4">'a'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">f</span><span class="s3">.</span><span class="s1">use_mmap</span><span class="s3">)</span>
                <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'app_dim'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'app_var'</span><span class="s3">, </span><span class="s4">'i'</span><span class="s3">, (</span><span class="s4">'app_dim'</span><span class="s3">,))</span>
                <span class="s1">var</span><span class="s3">[:] = </span><span class="s5">42</span>

        <span class="s6"># And... check that app_var made it in...</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'simple.nc'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'app_var'</span><span class="s3">][:], </span><span class="s5">42</span><span class="s3">)</span>

    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">IS_PYPY</span><span class="s3">:</span>
            <span class="s6"># windows cannot remove a dead file held by a mmap</span>
            <span class="s6"># that has not been collected in PyPy</span>
            <span class="s1">break_cycles</span><span class="s3">()</span>
            <span class="s1">break_cycles</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">cwd</span><span class="s3">)</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_write_sio</span><span class="s3">():</span>
    <span class="s1">eg_sio1 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">eg_sio1</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">):</span>
        <span class="s1">str_val </span><span class="s3">= </span><span class="s1">eg_sio1</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

    <span class="s1">eg_sio2 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">str_val</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">eg_sio2</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f2</span><span class="s3">:</span>
        <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f2</span><span class="s3">)</span>

    <span class="s6"># Test that error is raised if attempting mmap for sio</span>
    <span class="s1">eg_sio3 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">str_val</span><span class="s3">)</span>
    <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">netcdf_file</span><span class="s3">, </span><span class="s1">eg_sio3</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s6"># Test 64-bit offset write / read</span>
    <span class="s1">eg_sio_64 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">eg_sio_64</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">version</span><span class="s3">=</span><span class="s5">2</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f_64</span><span class="s3">:</span>
        <span class="s1">str_val </span><span class="s3">= </span><span class="s1">eg_sio_64</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

    <span class="s1">eg_sio_64 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">str_val</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">eg_sio_64</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f_64</span><span class="s3">:</span>
        <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f_64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f_64</span><span class="s3">.</span><span class="s1">version_byte</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s6"># also when version 2 explicitly specified</span>
    <span class="s1">eg_sio_64 </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">str_val</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">eg_sio_64</span><span class="s3">, </span><span class="s1">version</span><span class="s3">=</span><span class="s5">2</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f_64</span><span class="s3">:</span>
        <span class="s1">check_simple</span><span class="s3">(</span><span class="s1">f_64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f_64</span><span class="s3">.</span><span class="s1">version_byte</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_bytes</span><span class="s3">():</span>
    <span class="s1">raw_file </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
    <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">raw_file</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">)</span>
    <span class="s6"># Dataset only has a single variable, dimension and attribute to avoid</span>
    <span class="s6"># any ambiguity related to order.</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s4">'b'</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'dim'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'var'</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">, (</span><span class="s4">'dim'</span><span class="s3">,))</span>
    <span class="s1">var</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = -</span><span class="s5">9999</span>
    <span class="s1">var</span><span class="s3">.</span><span class="s1">c </span><span class="s3">= </span><span class="s4">'d'</span>
    <span class="s1">f</span><span class="s3">.</span><span class="s1">sync</span><span class="s3">()</span>

    <span class="s1">actual </span><span class="s3">= </span><span class="s1">raw_file</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

    <span class="s1">expected </span><span class="s3">= (</span><span class="s7">b'CDF</span><span class="s2">\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x0a</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s7">'</span>
                <span class="s7">b'dim</span><span class="s2">\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x0c</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'a</span><span class="s2">\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x02</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'b</span><span class="s2">\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x0b</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s7">'</span>
                <span class="s7">b'var</span><span class="s2">\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x0c</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'c</span><span class="s2">\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x02</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s7">'</span>
                <span class="s7">b'd</span><span class="s2">\x00\x00\x00</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x04</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\x00\x00\x00\x78</span><span class="s7">'</span>
                <span class="s7">b'</span><span class="s2">\xd8\xf1\x80\x01</span><span class="s7">'</span><span class="s3">)</span>

    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_encoded_fill_value</span><span class="s3">():</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(), </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'var'</span><span class="s3">, </span><span class="s4">'S1'</span><span class="s3">, (</span><span class="s4">'x'</span><span class="s3">,))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">_get_encoded_fill_value</span><span class="s3">(), </span><span class="s7">b'</span><span class="s2">\x00</span><span class="s7">'</span><span class="s3">)</span>
        <span class="s1">var</span><span class="s3">.</span><span class="s1">_FillValue </span><span class="s3">= </span><span class="s7">b'</span><span class="s2">\x01</span><span class="s7">'</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">_get_encoded_fill_value</span><span class="s3">(), </span><span class="s7">b'</span><span class="s2">\x01</span><span class="s7">'</span><span class="s3">)</span>
        <span class="s1">var</span><span class="s3">.</span><span class="s1">_FillValue </span><span class="s3">= </span><span class="s7">b'</span><span class="s2">\x00\x00</span><span class="s7">'  </span><span class="s6"># invalid, wrong size</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">.</span><span class="s1">_get_encoded_fill_value</span><span class="s3">(), </span><span class="s7">b'</span><span class="s2">\x00</span><span class="s7">'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_example_data</span><span class="s3">():</span>
    <span class="s6"># read any example data files</span>
    <span class="s2">for </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">glob</span><span class="s3">(</span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'*.nc'</span><span class="s3">)):</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">):</span>
            <span class="s2">pass</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">test_itemset_no_segfault_on_readonly</span><span class="s3">():</span>
    <span class="s6"># Regression test for ticket #1202.</span>
    <span class="s6"># Open the test file in read-only mode.</span>

    <span class="s1">filename </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_1.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">&quot;Cannot close a netcdf_file opened with mmap=True, when &quot;</span>
                   <span class="s4">&quot;netcdf_variables or arrays referring to its data still exist&quot;</span><span class="s3">)</span>
        <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">time_var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'time'</span><span class="s3">]</span>

    <span class="s6"># time_var.assignValue(42) should raise a RuntimeError--not seg. fault!</span>
    <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">RuntimeError</span><span class="s3">, </span><span class="s1">time_var</span><span class="s3">.</span><span class="s1">assignValue</span><span class="s3">, </span><span class="s5">42</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_appending_issue_gh_8625</span><span class="s3">():</span>
    <span class="s1">stream </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, (</span><span class="s4">'x'</span><span class="s3">,))</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'x'</span><span class="s3">][...] = </span><span class="s5">1</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">contents </span><span class="s3">= </span><span class="s1">stream</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

    <span class="s1">stream </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">contents</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'a'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'x'</span><span class="s3">][...] = </span><span class="s5">2</span>


<span class="s2">def </span><span class="s1">test_write_invalid_dtype</span><span class="s3">():</span>
    <span class="s1">dtypes </span><span class="s3">= [</span><span class="s4">'int64'</span><span class="s3">, </span><span class="s4">'uint64'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s4">'int'</span><span class="s3">).</span><span class="s1">itemsize </span><span class="s3">== </span><span class="s5">8</span><span class="s3">:   </span><span class="s6"># 64-bit machines</span>
        <span class="s1">dtypes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'int'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s4">'uint'</span><span class="s3">).</span><span class="s1">itemsize </span><span class="s3">== </span><span class="s5">8</span><span class="s3">:   </span><span class="s6"># 64-bit machines</span>
        <span class="s1">dtypes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'uint'</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(), </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'time'</span><span class="s3">, </span><span class="s1">N_EG_ELS</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">dt </span><span class="s2">in </span><span class="s1">dtypes</span><span class="s3">:</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">, </span><span class="s4">'time'</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">, (</span><span class="s4">'time'</span><span class="s3">,))</span>


<span class="s2">def </span><span class="s1">test_flush_rewind</span><span class="s3">():</span>
    <span class="s1">stream </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">,</span><span class="s5">4</span><span class="s3">)  </span><span class="s6"># x is used in createVariable</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'v'</span><span class="s3">, </span><span class="s4">'i2'</span><span class="s3">, [</span><span class="s4">'x'</span><span class="s3">])</span>
        <span class="s1">v</span><span class="s3">[:] = </span><span class="s5">1</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">len_single </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">())</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">len_double </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">())</span>

    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">len_single </span><span class="s3">== </span><span class="s1">len_double</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_dtype_specifiers</span><span class="s3">():</span>
    <span class="s6"># Numpy 1.7.0-dev had a bug where 'i2' wouldn't work.</span>
    <span class="s6"># Specifying np.int16 or similar only works from the same commit as this</span>
    <span class="s6"># comment was made.</span>
    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(), </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">,</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'v1'</span><span class="s3">, </span><span class="s4">'i2'</span><span class="s3">, [</span><span class="s4">'x'</span><span class="s3">])</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'v2'</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">, [</span><span class="s4">'x'</span><span class="s3">])</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'v3'</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">), [</span><span class="s4">'x'</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_ticket_1720</span><span class="s3">():</span>
    <span class="s1">io </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>

    <span class="s1">items </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0.1</span><span class="s3">,</span><span class="s5">0.2</span><span class="s3">,</span><span class="s5">0.3</span><span class="s3">,</span><span class="s5">0.4</span><span class="s3">,</span><span class="s5">0.5</span><span class="s3">,</span><span class="s5">0.6</span><span class="s3">,</span><span class="s5">0.7</span><span class="s3">,</span><span class="s5">0.8</span><span class="s3">,</span><span class="s5">0.9</span><span class="s3">]</span>

    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">io</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">history </span><span class="s3">= </span><span class="s4">'Created for a test'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'float_var'</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">float_var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'float_var'</span><span class="s3">, </span><span class="s4">'f'</span><span class="s3">, (</span><span class="s4">'float_var'</span><span class="s3">,))</span>
        <span class="s1">float_var</span><span class="s3">[:] = </span><span class="s1">items</span>
        <span class="s1">float_var</span><span class="s3">.</span><span class="s1">units </span><span class="s3">= </span><span class="s4">'metres'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">contents </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

    <span class="s1">io </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">contents</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">io</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">history</span><span class="s3">, </span><span class="s7">b'Created for a test'</span><span class="s3">)</span>
        <span class="s1">float_var </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'float_var'</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">float_var</span><span class="s3">.</span><span class="s1">units</span><span class="s3">, </span><span class="s7">b'metres'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">float_var</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s5">10</span><span class="s3">,))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">float_var</span><span class="s3">[:], </span><span class="s1">items</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_mmaps_segfault</span><span class="s3">():</span>
    <span class="s1">filename </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_1.nc'</span><span class="s3">)</span>

    <span class="s2">if not </span><span class="s1">IS_PYPY</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'lat'</span><span class="s3">][:]</span>
                <span class="s6"># should not raise warnings</span>
                <span class="s2">del </span><span class="s1">x</span>

    <span class="s2">def </span><span class="s1">doit</span><span class="s3">():</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'lat'</span><span class="s3">][:]</span>

    <span class="s6"># should not crash</span>
    <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">&quot;Cannot close a netcdf_file opened with mmap=True, when &quot;</span>
                   <span class="s4">&quot;netcdf_variables or arrays referring to its data still exist&quot;</span><span class="s3">)</span>
        <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s1">message</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">doit</span><span class="s3">()</span>
    <span class="s1">x</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_zero_dimensional_var</span><span class="s3">():</span>
    <span class="s1">io </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">make_simple</span><span class="s3">(</span><span class="s1">io</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'zerodim'</span><span class="s3">, </span><span class="s4">'i2'</span><span class="s3">, [])</span>
        <span class="s6"># This is checking that .isrec returns a boolean - don't simplify it</span>
        <span class="s6"># to 'assert not ...'</span>
        <span class="s2">assert </span><span class="s1">v</span><span class="s3">.</span><span class="s1">isrec </span><span class="s2">is False</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">isrec</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_byte_gatts</span><span class="s3">():</span>
    <span class="s6"># Check that global &quot;string&quot; atts work like they did before py3k</span>
    <span class="s6"># unicode and general bytes confusion</span>
    <span class="s2">with </span><span class="s1">in_tempdir</span><span class="s3">():</span>
        <span class="s1">filename </span><span class="s3">= </span><span class="s4">'g_byte_atts.nc'</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'holy'</span><span class="s3">] = </span><span class="s7">b'grail'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'witch'</span><span class="s3">] = </span><span class="s4">'floats'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'holy'</span><span class="s3">], </span><span class="s7">b'grail'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'witch'</span><span class="s3">], </span><span class="s7">b'floats'</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_open_append</span><span class="s3">():</span>
    <span class="s6"># open 'w' put one attr</span>
    <span class="s2">with </span><span class="s1">in_tempdir</span><span class="s3">():</span>
        <span class="s1">filename </span><span class="s3">= </span><span class="s4">'append_dat.nc'</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'Kilroy'</span><span class="s3">] = </span><span class="s4">'was here'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s6"># open again in 'a', read the att and a new one</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'a'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'Kilroy'</span><span class="s3">], </span><span class="s7">b'was here'</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'naughty'</span><span class="s3">] = </span><span class="s7">b'Zoot'</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s6"># open yet again in 'r' and check both atts</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'Kilroy'</span><span class="s3">], </span><span class="s7">b'was here'</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'naughty'</span><span class="s3">], </span><span class="s7">b'Zoot'</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_append_recordDimension</span><span class="s3">():</span>
    <span class="s1">dataSize </span><span class="s3">= </span><span class="s5">100</span>

    <span class="s2">with </span><span class="s1">in_tempdir</span><span class="s3">():</span>
        <span class="s6"># Create file with record time dimension</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'withRecordDimension.nc'</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'time'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'time'</span><span class="s3">, </span><span class="s4">'d'</span><span class="s3">, (</span><span class="s4">'time'</span><span class="s3">,))</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, </span><span class="s1">dataSize</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">, </span><span class="s4">'d'</span><span class="s3">, (</span><span class="s4">'x'</span><span class="s3">,))</span>
            <span class="s1">x</span><span class="s3">[:] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">dataSize</span><span class="s3">))</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'y'</span><span class="s3">, </span><span class="s1">dataSize</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'y'</span><span class="s3">, </span><span class="s4">'d'</span><span class="s3">, (</span><span class="s4">'y'</span><span class="s3">,))</span>
            <span class="s1">y</span><span class="s3">[:] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">dataSize</span><span class="s3">))</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'testData'</span><span class="s3">, </span><span class="s4">'i'</span><span class="s3">, (</span><span class="s4">'time'</span><span class="s3">, </span><span class="s4">'x'</span><span class="s3">, </span><span class="s4">'y'</span><span class="s3">))</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">):</span>
            <span class="s6"># Open the file in append mode and add data</span>
            <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'withRecordDimension.nc'</span><span class="s3">, </span><span class="s4">'a'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'time'</span><span class="s3">].</span><span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">&quot;time&quot;</span><span class="s3">].</span><span class="s1">data</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'testData'</span><span class="s3">][</span><span class="s1">i</span><span class="s3">, :, :] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dataSize</span><span class="s3">, </span><span class="s1">dataSize</span><span class="s3">), </span><span class="s1">i</span><span class="s3">)</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>

            <span class="s6"># Read the file and check that append worked</span>
            <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'withRecordDimension.nc'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'time'</span><span class="s3">][-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">i</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'testData'</span><span class="s3">][-</span><span class="s5">1</span><span class="s3">, :, :].</span><span class="s1">copy</span><span class="s3">(),</span>
                             <span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dataSize</span><span class="s3">, </span><span class="s1">dataSize</span><span class="s3">), </span><span class="s1">i</span><span class="s3">))</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'time'</span><span class="s3">].</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'testData'</span><span class="s3">].</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Read the file and check that 'data' was not saved as user defined</span>
        <span class="s6"># attribute of testData variable during append operation</span>
        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s4">'withRecordDimension.nc'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">ar</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'testData'</span><span class="s3">].</span><span class="s1">_attributes</span><span class="s3">[</span><span class="s4">'data'</span><span class="s3">]</span>
            <span class="s1">ex </span><span class="s3">= </span><span class="s1">ar</span><span class="s3">.</span><span class="s1">value</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">ex</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s4">'data'</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">test_maskandscale</span><span class="s3">():</span>
    <span class="s1">t </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">30</span><span class="s3">, </span><span class="s5">15</span><span class="s3">)</span>
    <span class="s1">t</span><span class="s3">[</span><span class="s5">3</span><span class="s3">] = </span><span class="s5">100</span>
    <span class="s1">tm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">masked_greater</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s5">99</span><span class="s3">)</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_2.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">Temp </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'Temperature'</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">missing_value</span><span class="s3">, </span><span class="s5">9999</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">add_offset</span><span class="s3">, </span><span class="s5">20</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">scale_factor</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s5">0.01</span><span class="s3">))</span>
        <span class="s1">found </span><span class="s3">= </span><span class="s1">Temp</span><span class="s3">[:].</span><span class="s1">compressed</span><span class="s3">()</span>
        <span class="s2">del </span><span class="s1">Temp  </span><span class="s6"># Remove ref to mmap, so file can be closed.</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">tm</span><span class="s3">.</span><span class="s1">compressed</span><span class="s3">(), </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">found</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">in_tempdir</span><span class="s3">():</span>
        <span class="s1">newfname </span><span class="s3">= </span><span class="s4">'ms.nc'</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">newfname</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">createDimension</span><span class="s3">(</span><span class="s4">'Temperature'</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">tm</span><span class="s3">))</span>
        <span class="s1">temp </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">createVariable</span><span class="s3">(</span><span class="s4">'Temperature'</span><span class="s3">, </span><span class="s4">'i'</span><span class="s3">, (</span><span class="s4">'Temperature'</span><span class="s3">,))</span>
        <span class="s1">temp</span><span class="s3">.</span><span class="s1">missing_value </span><span class="s3">= </span><span class="s5">9999</span>
        <span class="s1">temp</span><span class="s3">.</span><span class="s1">scale_factor </span><span class="s3">= </span><span class="s5">0.01</span>
        <span class="s1">temp</span><span class="s3">.</span><span class="s1">add_offset </span><span class="s3">= </span><span class="s5">20</span>
        <span class="s1">temp</span><span class="s3">[:] = </span><span class="s1">tm</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">newfname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">Temp </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'Temperature'</span><span class="s3">]</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">missing_value</span><span class="s3">, </span><span class="s5">9999</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">add_offset</span><span class="s3">, </span><span class="s5">20</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">Temp</span><span class="s3">.</span><span class="s1">scale_factor</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s5">0.01</span><span class="s3">))</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">tm</span><span class="s3">.</span><span class="s1">compressed</span><span class="s3">(), </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">found </span><span class="s3">= </span><span class="s1">Temp</span><span class="s3">[:].</span><span class="s1">compressed</span><span class="s3">()</span>
            <span class="s2">del </span><span class="s1">Temp</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">found</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s6"># ------------------------------------------------------------------------</span>
<span class="s6"># Test reading with masked values (_FillValue / missing_value)</span>
<span class="s6"># ------------------------------------------------------------------------</span>

<span class="s2">def </span><span class="s1">test_read_withValuesNearFillValue</span><span class="s3">():</span>
    <span class="s6"># Regression test for ticket #5626</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var1_fillval0'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_withNoFillValue</span><span class="s3">():</span>
    <span class="s6"># For a variable with no fill value, reading data with maskandscale=True</span>
    <span class="s6"># should return unmasked data</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var2_noFillval'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_withFillValueAndMissingValue</span><span class="s3">():</span>
    <span class="s6"># For a variable with both _FillValue and missing_value, the _FillValue</span>
    <span class="s6"># should be used</span>
    <span class="s1">IRRELEVANT_VALUE </span><span class="s3">= </span><span class="s5">9999</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var3_fillvalAndMissingValue'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s1">IRRELEVANT_VALUE</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_withMissingValue</span><span class="s3">():</span>
    <span class="s6"># For a variable with missing_value but not _FillValue, the missing_value</span>
    <span class="s6"># should be used</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var4_missingValue'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_withFillValNaN</span><span class="s3">():</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var5_fillvalNaN'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_withChar</span><span class="s3">():</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var6_char'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">test_read_with2dVar</span><span class="s3">():</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var7_2d'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]])</span>

<span class="s2">def </span><span class="s1">test_read_withMaskAndScaleFalse</span><span class="s3">():</span>
    <span class="s6"># If a variable has a _FillValue (or missing_value) attribute, but is read</span>
    <span class="s6"># with maskandscale set to False, the result should be unmasked</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">pjoin</span><span class="s3">(</span><span class="s1">TEST_DATA_PATH</span><span class="s3">, </span><span class="s4">'example_3_maskedvals.nc'</span><span class="s3">)</span>
    <span class="s6"># Open file with mmap=False to avoid problems with closing a mmap'ed file</span>
    <span class="s6"># when arrays referring to its data still exist:</span>
    <span class="s2">with </span><span class="s1">netcdf_file</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">maskandscale</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">vardata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">[</span><span class="s4">'var3_fillvalAndMissingValue'</span><span class="s3">][:]</span>
        <span class="s1">assert_mask_matches</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">vardata</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
</pre>
</body>
</html>