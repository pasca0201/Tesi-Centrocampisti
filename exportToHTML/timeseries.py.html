<html>
<head>
<title>timeseries.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
timeseries.py</font>
</center></td></tr></table>
<pre><span class="s0"># TODO: Use the fact that axis can have units to simplify the process</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">functools</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">TYPE_CHECKING</span><span class="s3">,</span>
    <span class="s1">Any</span><span class="s3">,</span>
    <span class="s1">cast</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">warnings</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_libs</span><span class="s3">.</span><span class="s1">tslibs </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">BaseOffset</span><span class="s3">,</span>
    <span class="s1">Period</span><span class="s3">,</span>
    <span class="s1">to_offset</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_libs</span><span class="s3">.</span><span class="s1">tslibs</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">OFFSET_TO_PERIOD_FREQSTR</span><span class="s3">,</span>
    <span class="s1">FreqGroup</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">generic </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ABCDatetimeIndex</span><span class="s3">,</span>
    <span class="s1">ABCPeriodIndex</span><span class="s3">,</span>
    <span class="s1">ABCTimedeltaIndex</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">printing </span><span class="s2">import </span><span class="s1">pprint_thing</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">plotting</span><span class="s3">.</span><span class="s1">_matplotlib</span><span class="s3">.</span><span class="s1">converter </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">TimeSeries_DateFormatter</span><span class="s3">,</span>
    <span class="s1">TimeSeries_DateLocator</span><span class="s3">,</span>
    <span class="s1">TimeSeries_TimedeltaFormatter</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">tseries</span><span class="s3">.</span><span class="s1">frequencies </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">get_period_alias</span><span class="s3">,</span>
    <span class="s1">is_subperiod</span><span class="s3">,</span>
    <span class="s1">is_superperiod</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s1">timedelta</span>

    <span class="s2">from </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">axes </span><span class="s2">import </span><span class="s1">Axes</span>

    <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_typing </span><span class="s2">import </span><span class="s1">NDFrameT</span>

    <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
        <span class="s1">DataFrame</span><span class="s3">,</span>
        <span class="s1">DatetimeIndex</span><span class="s3">,</span>
        <span class="s1">Index</span><span class="s3">,</span>
        <span class="s1">PeriodIndex</span><span class="s3">,</span>
        <span class="s1">Series</span><span class="s3">,</span>
    <span class="s3">)</span>

<span class="s0"># ---------------------------------------------------------------------</span>
<span class="s0"># Plotting functions and monkey patches</span>


<span class="s2">def </span><span class="s1">maybe_resample</span><span class="s3">(</span><span class="s1">series</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">, </span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]):</span>
    <span class="s0"># resample against axes freq if necessary</span>

    <span class="s2">if </span><span class="s4">&quot;how&quot; </span><span class="s2">in </span><span class="s1">kwargs</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;'how' is not a valid keyword for plotting functions. If plotting &quot;</span>
            <span class="s4">&quot;multiple objects on shared axes, resample manually first.&quot;</span>
        <span class="s3">)</span>

    <span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">_get_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">series</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Cannot use dynamic axis without frequency info&quot;</span><span class="s3">)</span>

    <span class="s0"># Convert DatetimeIndex to PeriodIndex</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCDatetimeIndex</span><span class="s3">):</span>
        <span class="s1">series </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">to_period</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s1">freq</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">ax_freq </span><span class="s2">is not None and </span><span class="s1">freq </span><span class="s3">!= </span><span class="s1">ax_freq</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">is_superperiod</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq</span><span class="s3">):  </span><span class="s0"># upsample input</span>
            <span class="s1">series </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
            <span class="s0"># error: &quot;Index&quot; has no attribute &quot;asfreq&quot;</span>
            <span class="s1">series</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">asfreq</span><span class="s3">(  </span><span class="s0"># type: ignore[attr-defined]</span>
                <span class="s1">ax_freq</span><span class="s3">, </span><span class="s1">how</span><span class="s3">=</span><span class="s4">&quot;s&quot;</span>
            <span class="s3">)</span>
            <span class="s1">freq </span><span class="s3">= </span><span class="s1">ax_freq</span>
        <span class="s2">elif </span><span class="s1">_is_sup</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq</span><span class="s3">):  </span><span class="s0"># one is weekly</span>
            <span class="s0"># Resampling with PeriodDtype is deprecated, so we convert to</span>
            <span class="s0">#  DatetimeIndex, resample, then convert back.</span>
            <span class="s1">ser_ts </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">to_timestamp</span><span class="s3">()</span>
            <span class="s1">ser_d </span><span class="s3">= </span><span class="s1">ser_ts</span><span class="s3">.</span><span class="s1">resample</span><span class="s3">(</span><span class="s4">&quot;D&quot;</span><span class="s3">).</span><span class="s1">last</span><span class="s3">().</span><span class="s1">dropna</span><span class="s3">()</span>
            <span class="s1">ser_freq </span><span class="s3">= </span><span class="s1">ser_d</span><span class="s3">.</span><span class="s1">resample</span><span class="s3">(</span><span class="s1">ax_freq</span><span class="s3">).</span><span class="s1">last</span><span class="s3">().</span><span class="s1">dropna</span><span class="s3">()</span>
            <span class="s1">series </span><span class="s3">= </span><span class="s1">ser_freq</span><span class="s3">.</span><span class="s1">to_period</span><span class="s3">(</span><span class="s1">ax_freq</span><span class="s3">)</span>
            <span class="s1">freq </span><span class="s3">= </span><span class="s1">ax_freq</span>
        <span class="s2">elif </span><span class="s1">is_subperiod</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq</span><span class="s3">) </span><span class="s2">or </span><span class="s1">_is_sub</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq</span><span class="s3">):</span>
            <span class="s1">_upsample_others</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Incompatible frequency conversion&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">freq</span><span class="s3">, </span><span class="s1">series</span>


<span class="s2">def </span><span class="s1">_is_sub</span><span class="s3">(</span><span class="s1">f1</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">f1</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;W&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">is_subperiod</span><span class="s3">(</span><span class="s4">&quot;D&quot;</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">)) </span><span class="s2">or </span><span class="s3">(</span>
        <span class="s1">f2</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;W&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">is_subperiod</span><span class="s3">(</span><span class="s1">f1</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_is_sup</span><span class="s3">(</span><span class="s1">f1</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">f1</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;W&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">is_superperiod</span><span class="s3">(</span><span class="s4">&quot;D&quot;</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">)) </span><span class="s2">or </span><span class="s3">(</span>
        <span class="s1">f2</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;W&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">is_superperiod</span><span class="s3">(</span><span class="s1">f1</span><span class="s3">, </span><span class="s4">&quot;D&quot;</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_upsample_others</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">: </span><span class="s1">BaseOffset</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">legend </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_legend</span><span class="s3">()</span>
    <span class="s1">lines</span><span class="s3">, </span><span class="s1">labels </span><span class="s3">= </span><span class="s1">_replot_ax</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)</span>
    <span class="s1">_replot_ax</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)</span>

    <span class="s1">other_ax </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;left_ax&quot;</span><span class="s3">):</span>
        <span class="s1">other_ax </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">left_ax</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;right_ax&quot;</span><span class="s3">):</span>
        <span class="s1">other_ax </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">right_ax</span>

    <span class="s2">if </span><span class="s1">other_ax </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">rlines</span><span class="s3">, </span><span class="s1">rlabels </span><span class="s3">= </span><span class="s1">_replot_ax</span><span class="s3">(</span><span class="s1">other_ax</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)</span>
        <span class="s1">lines</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">rlines</span><span class="s3">)</span>
        <span class="s1">labels</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">rlabels</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">legend </span><span class="s2">is not None and </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;legend&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s1">title</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s1">legend</span><span class="s3">.</span><span class="s1">get_title</span><span class="s3">().</span><span class="s1">get_text</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">title </span><span class="s3">== </span><span class="s4">&quot;None&quot;</span><span class="s3">:</span>
            <span class="s1">title </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">ax</span><span class="s3">.</span><span class="s1">legend</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s4">&quot;best&quot;</span><span class="s3">, </span><span class="s1">title</span><span class="s3">=</span><span class="s1">title</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_replot_ax</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">: </span><span class="s1">BaseOffset</span><span class="s3">):</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;_plot_data&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s0"># clear current axes and data</span>
    <span class="s0"># TODO #54485</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">_plot_data </span><span class="s3">= []  </span><span class="s0"># type: ignore[attr-defined]</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

    <span class="s1">decorate_axes</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)</span>

    <span class="s1">lines </span><span class="s3">= []</span>
    <span class="s1">labels </span><span class="s3">= []</span>
    <span class="s2">if </span><span class="s1">data </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">series</span><span class="s3">, </span><span class="s1">plotf</span><span class="s3">, </span><span class="s1">kwds </span><span class="s2">in </span><span class="s1">data</span><span class="s3">:</span>
            <span class="s1">series </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
            <span class="s1">idx </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">asfreq</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">how</span><span class="s3">=</span><span class="s4">&quot;S&quot;</span><span class="s3">)</span>
            <span class="s1">series</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">idx</span>
            <span class="s0"># TODO #54485</span>
            <span class="s1">ax</span><span class="s3">.</span><span class="s1">_plot_data</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">series</span><span class="s3">, </span><span class="s1">plotf</span><span class="s3">, </span><span class="s1">kwds</span><span class="s3">))  </span><span class="s0"># type: ignore[attr-defined]</span>

            <span class="s0"># for tsplot</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">plotf</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">plotting</span><span class="s3">.</span><span class="s1">_matplotlib </span><span class="s2">import </span><span class="s1">PLOT_CLASSES</span>

                <span class="s1">plotf </span><span class="s3">= </span><span class="s1">PLOT_CLASSES</span><span class="s3">[</span><span class="s1">plotf</span><span class="s3">].</span><span class="s1">_plot</span>

            <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">plotf</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">_mpl_repr</span><span class="s3">(), </span><span class="s1">series</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, **</span><span class="s1">kwds</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">])</span>
            <span class="s1">labels</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">pprint_thing</span><span class="s3">(</span><span class="s1">series</span><span class="s3">.</span><span class="s1">name</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">labels</span>


<span class="s2">def </span><span class="s1">decorate_axes</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">: </span><span class="s1">BaseOffset</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s6">&quot;&quot;&quot;Initialize axes for time-series plotting&quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;_plot_data&quot;</span><span class="s3">):</span>
        <span class="s0"># TODO #54485</span>
        <span class="s1">ax</span><span class="s3">.</span><span class="s1">_plot_data </span><span class="s3">= []  </span><span class="s0"># type: ignore[attr-defined]</span>

    <span class="s0"># TODO #54485</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">freq </span><span class="s3">= </span><span class="s1">freq  </span><span class="s0"># type: ignore[attr-defined]</span>
    <span class="s1">xaxis </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_xaxis</span><span class="s3">()</span>
    <span class="s0"># TODO #54485</span>
    <span class="s1">xaxis</span><span class="s3">.</span><span class="s1">freq </span><span class="s3">= </span><span class="s1">freq  </span><span class="s0"># type: ignore[attr-defined]</span>


<span class="s2">def </span><span class="s1">_get_ax_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Get the freq attribute of the ax object if set. 
    Also checks shared axes (eg when using secondary yaxis, sharex=True 
    or twinx) 
    &quot;&quot;&quot;</span>
    <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ax_freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s0"># check for left/right ax in case of secondary yaxis</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;left_ax&quot;</span><span class="s3">):</span>
            <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">.</span><span class="s1">left_ax</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">, </span><span class="s4">&quot;right_ax&quot;</span><span class="s3">):</span>
            <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">.</span><span class="s1">right_ax</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ax_freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s0"># check if a shared ax (sharex/twinx) has already freq set</span>
        <span class="s1">shared_axes </span><span class="s3">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_shared_x_axes</span><span class="s3">().</span><span class="s1">get_siblings</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">shared_axes</span><span class="s3">) &gt; </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">shared_ax </span><span class="s2">in </span><span class="s1">shared_axes</span><span class="s3">:</span>
                <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">shared_ax</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">ax_freq </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s2">break</span>
    <span class="s2">return </span><span class="s1">ax_freq</span>


<span class="s2">def </span><span class="s1">_get_period_alias</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">: </span><span class="s1">timedelta </span><span class="s3">| </span><span class="s1">BaseOffset </span><span class="s3">| </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">BaseOffset</span><span class="s3">):</span>
        <span class="s1">freqstr </span><span class="s3">= </span><span class="s1">freq</span><span class="s3">.</span><span class="s1">name</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">freqstr </span><span class="s3">= </span><span class="s1">to_offset</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">is_period</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">rule_code</span>

    <span class="s2">return </span><span class="s1">get_period_alias</span><span class="s3">(</span><span class="s1">freqstr</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_get_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">series</span><span class="s3">: </span><span class="s1">Series</span><span class="s3">):</span>
    <span class="s0"># get frequency from data</span>
    <span class="s1">freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">series</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s4">&quot;inferred_freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">freq </span><span class="s3">= </span><span class="s1">to_offset</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">is_period</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">_get_ax_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>

    <span class="s0"># use axes freq if no data freq</span>
    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">freq </span><span class="s3">= </span><span class="s1">ax_freq</span>

    <span class="s0"># get the period frequency</span>
    <span class="s1">freq </span><span class="s3">= </span><span class="s1">_get_period_alias</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">freq</span><span class="s3">, </span><span class="s1">ax_freq</span>


<span class="s2">def </span><span class="s1">use_dynamic_x</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">DataFrame </span><span class="s3">| </span><span class="s1">Series</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s1">freq </span><span class="s3">= </span><span class="s1">_get_index_freq</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
    <span class="s1">ax_freq </span><span class="s3">= </span><span class="s1">_get_ax_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:  </span><span class="s0"># convert irregular if axes has freq info</span>
        <span class="s1">freq </span><span class="s3">= </span><span class="s1">ax_freq</span>
    <span class="s0"># do not use tsplot if irregular was plotted first</span>
    <span class="s2">elif </span><span class="s3">(</span><span class="s1">ax_freq </span><span class="s2">is None</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_lines</span><span class="s3">()) &gt; </span><span class="s5">0</span><span class="s3">):</span>
        <span class="s2">return False</span>

    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">return False</span>

    <span class="s1">freq_str </span><span class="s3">= </span><span class="s1">_get_period_alias</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">freq_str </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">return False</span>

    <span class="s0"># FIXME: hack this for 0.10.1, creating more technical debt...sigh</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCDatetimeIndex</span><span class="s3">):</span>
        <span class="s0"># error: &quot;BaseOffset&quot; has no attribute &quot;_period_dtype_code&quot;</span>
        <span class="s1">freq_str </span><span class="s3">= </span><span class="s1">OFFSET_TO_PERIOD_FREQSTR</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">freq_str</span><span class="s3">, </span><span class="s1">freq_str</span><span class="s3">)</span>
        <span class="s1">base </span><span class="s3">= </span><span class="s1">to_offset</span><span class="s3">(</span>
            <span class="s1">freq_str</span><span class="s3">, </span><span class="s1">is_period</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">).</span><span class="s1">_period_dtype_code  </span><span class="s0"># type: ignore[attr-defined]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span>
        <span class="s2">if </span><span class="s1">base </span><span class="s3">&lt;= </span><span class="s1">FreqGroup</span><span class="s3">.</span><span class="s1">FR_DAY</span><span class="s3">.</span><span class="s1">value</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">[:</span><span class="s5">1</span><span class="s3">].</span><span class="s1">is_normalized</span>
        <span class="s1">period </span><span class="s3">= </span><span class="s1">Period</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">freq_str</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">period</span><span class="s3">, </span><span class="s1">Period</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">period</span><span class="s3">.</span><span class="s1">to_timestamp</span><span class="s3">().</span><span class="s1">tz_localize</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">tz</span><span class="s3">) == </span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">return True</span>


<span class="s2">def </span><span class="s1">_get_index_freq</span><span class="s3">(</span><span class="s1">index</span><span class="s3">: </span><span class="s1">Index</span><span class="s3">) </span><span class="s1">-&gt; BaseOffset </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s4">&quot;freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">freq </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s4">&quot;inferred_freq&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">freq </span><span class="s3">== </span><span class="s4">&quot;B&quot;</span><span class="s3">:</span>
            <span class="s0"># error: &quot;Index&quot; has no attribute &quot;dayofweek&quot;</span>
            <span class="s1">weekdays </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">index</span><span class="s3">.</span><span class="s1">dayofweek</span><span class="s3">)  </span><span class="s0"># type: ignore[attr-defined]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s5">5 </span><span class="s2">in </span><span class="s1">weekdays</span><span class="s3">) </span><span class="s2">or </span><span class="s3">(</span><span class="s5">6 </span><span class="s2">in </span><span class="s1">weekdays</span><span class="s3">):</span>
                <span class="s1">freq </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">freq </span><span class="s3">= </span><span class="s1">to_offset</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">freq</span>


<span class="s2">def </span><span class="s1">maybe_convert_index</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">: </span><span class="s1">Axes</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">NDFrameT</span><span class="s3">) </span><span class="s1">-&gt; NDFrameT</span><span class="s3">:</span>
    <span class="s0"># tsplot converts automatically, but don't want to convert index</span>
    <span class="s0"># over and over for DataFrames</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, (</span><span class="s1">ABCDatetimeIndex</span><span class="s3">, </span><span class="s1">ABCPeriodIndex</span><span class="s3">)):</span>
        <span class="s1">freq</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">BaseOffset </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">freq</span>

        <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s0"># We only get here for DatetimeIndex</span>
            <span class="s1">data</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s4">&quot;DatetimeIndex&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
            <span class="s1">freq </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">inferred_freq</span>
            <span class="s1">freq </span><span class="s3">= </span><span class="s1">to_offset</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">freq </span><span class="s3">= </span><span class="s1">_get_ax_freq</span><span class="s3">(</span><span class="s1">ax</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">freq </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Could not get frequency alias for plotting&quot;</span><span class="s3">)</span>

        <span class="s1">freq_str </span><span class="s3">= </span><span class="s1">_get_period_alias</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s0"># suppress Period[B] deprecation warning</span>
            <span class="s0"># TODO: need to find an alternative to this before the deprecation</span>
            <span class="s0">#  is enforced!</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span>
                <span class="s4">&quot;ignore&quot;</span><span class="s3">,</span>
                <span class="s4">r&quot;PeriodDtype\[B\] is deprecated&quot;</span><span class="s3">,</span>
                <span class="s1">category</span><span class="s3">=</span><span class="s1">FutureWarning</span><span class="s3">,</span>
            <span class="s3">)</span>

            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCDatetimeIndex</span><span class="s3">):</span>
                <span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">tz_localize</span><span class="s3">(</span><span class="s2">None</span><span class="s3">).</span><span class="s1">to_period</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s1">freq_str</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCPeriodIndex</span><span class="s3">):</span>
                <span class="s1">data</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">asfreq</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s1">freq_str</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">data</span>


<span class="s0"># Patch methods for subplot.</span>


<span class="s2">def </span><span class="s1">_format_coord</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s1">time_period </span><span class="s3">= </span><span class="s1">Period</span><span class="s3">(</span><span class="s1">ordinal</span><span class="s3">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">t</span><span class="s3">), </span><span class="s1">freq</span><span class="s3">=</span><span class="s1">freq</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s4">f&quot;t = </span><span class="s2">{</span><span class="s1">time_period</span><span class="s2">}  </span><span class="s4">y = </span><span class="s2">{</span><span class="s1">y</span><span class="s2">:</span><span class="s4">8f</span><span class="s2">}</span><span class="s4">&quot;</span>


<span class="s2">def </span><span class="s1">format_dateaxis</span><span class="s3">(</span>
    <span class="s1">subplot</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">: </span><span class="s1">BaseOffset</span><span class="s3">, </span><span class="s1">index</span><span class="s3">: </span><span class="s1">DatetimeIndex </span><span class="s3">| </span><span class="s1">PeriodIndex</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s6">&quot;&quot;&quot; 
    Pretty-formats the date axis (x-axis). 
 
    Major and minor ticks are automatically set for the frequency of the 
    current underlying series.  As the dynamic mode is activated by 
    default, changing the limits of the x axis will intelligently change 
    the positions of the ticks. 
    &quot;&quot;&quot;</span>
    <span class="s2">from </span><span class="s1">matplotlib </span><span class="s2">import </span><span class="s1">pylab</span>

    <span class="s0"># handle index specific formatting</span>
    <span class="s0"># Note: DatetimeIndex does not use this</span>
    <span class="s0"># interface. DatetimeIndex uses matplotlib.date directly</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCPeriodIndex</span><span class="s3">):</span>
        <span class="s1">majlocator </span><span class="s3">= </span><span class="s1">TimeSeries_DateLocator</span><span class="s3">(</span>
            <span class="s1">freq</span><span class="s3">, </span><span class="s1">dynamic_mode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">minor_locator</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">plot_obj</span><span class="s3">=</span><span class="s1">subplot</span>
        <span class="s3">)</span>
        <span class="s1">minlocator </span><span class="s3">= </span><span class="s1">TimeSeries_DateLocator</span><span class="s3">(</span>
            <span class="s1">freq</span><span class="s3">, </span><span class="s1">dynamic_mode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">minor_locator</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">plot_obj</span><span class="s3">=</span><span class="s1">subplot</span>
        <span class="s3">)</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">xaxis</span><span class="s3">.</span><span class="s1">set_major_locator</span><span class="s3">(</span><span class="s1">majlocator</span><span class="s3">)</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">xaxis</span><span class="s3">.</span><span class="s1">set_minor_locator</span><span class="s3">(</span><span class="s1">minlocator</span><span class="s3">)</span>

        <span class="s1">majformatter </span><span class="s3">= </span><span class="s1">TimeSeries_DateFormatter</span><span class="s3">(</span>
            <span class="s1">freq</span><span class="s3">, </span><span class="s1">dynamic_mode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">minor_locator</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">plot_obj</span><span class="s3">=</span><span class="s1">subplot</span>
        <span class="s3">)</span>
        <span class="s1">minformatter </span><span class="s3">= </span><span class="s1">TimeSeries_DateFormatter</span><span class="s3">(</span>
            <span class="s1">freq</span><span class="s3">, </span><span class="s1">dynamic_mode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">minor_locator</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">plot_obj</span><span class="s3">=</span><span class="s1">subplot</span>
        <span class="s3">)</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">xaxis</span><span class="s3">.</span><span class="s1">set_major_formatter</span><span class="s3">(</span><span class="s1">majformatter</span><span class="s3">)</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">xaxis</span><span class="s3">.</span><span class="s1">set_minor_formatter</span><span class="s3">(</span><span class="s1">minformatter</span><span class="s3">)</span>

        <span class="s0"># x and y coord info</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">format_coord </span><span class="s3">= </span><span class="s1">functools</span><span class="s3">.</span><span class="s1">partial</span><span class="s3">(</span><span class="s1">_format_coord</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s1">ABCTimedeltaIndex</span><span class="s3">):</span>
        <span class="s1">subplot</span><span class="s3">.</span><span class="s1">xaxis</span><span class="s3">.</span><span class="s1">set_major_formatter</span><span class="s3">(</span><span class="s1">TimeSeries_TimedeltaFormatter</span><span class="s3">())</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">&quot;index type not supported&quot;</span><span class="s3">)</span>

    <span class="s1">pylab</span><span class="s3">.</span><span class="s1">draw_if_interactive</span><span class="s3">()</span>
</pre>
</body>
</html>