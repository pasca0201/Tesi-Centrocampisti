<html>
<head>
<title>test_einsum.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_einsum.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">platform</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_raises</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">, </span><span class="s1">assert_raises_regex</span><span class="s2">, </span><span class="s1">assert_allclose</span>
    <span class="s2">)</span>

<span class="s3"># Setup for optimize einsum</span>
<span class="s1">chars </span><span class="s2">= </span><span class="s4">'abcdefghij'</span>
<span class="s1">sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
<span class="s1">global_size_dict </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">chars</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestEinsum</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;do_opt&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;einsum_fn&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_einsum_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">do_opt</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">):</span>
        <span class="s3"># Need enough arguments</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># subscripts must be a string</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># issue 4528 revealed a segfault with this call</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, *(</span><span class="s0">None</span><span class="s2">,)*</span><span class="s5">63</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># number of operands must match count in subscripts string</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;,&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">],</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;,&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># can't have more subscripts than dimensions in the operand</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;ij&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;...i&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i...j&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i...&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;ij...&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># invalid ellipsis</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i..&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;.i...&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;j-&gt;..j&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;j-&gt;.j...&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># invalid subscript character</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i%...&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;...j$&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i-&gt;&amp;&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># output subscripts must appear in input</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;i-&gt;ij&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># output subscripts may only be specified once</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;ij-&gt;jij&quot;</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]],</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># dimensions must match when being collapsed</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;ii&quot;</span><span class="s2">,</span>
                      <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">einsum_fn</span><span class="s2">, </span><span class="s4">&quot;ii-&gt;i&quot;</span><span class="s2">,</span>
                      <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;'b'&quot;</span><span class="s2">):</span>
            <span class="s3"># gh-11221 - 'c' erroneously appeared in the error message</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
            <span class="s1">einsum_fn</span><span class="s2">(</span><span class="s4">'aabcb,abc'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;do_opt&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_einsum_specific_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">do_opt</span><span class="s2">):</span>
        <span class="s3"># out parameter must be an array</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'test'</span><span class="s2">,</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># order parameter must be a valid order</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'W'</span><span class="s2">,</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># casting parameter must be a valid casting</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'blah'</span><span class="s2">,</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># dtype parameter must be a valid dtype</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'bad_data_type'</span><span class="s2">,</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># other keyword arguments are rejected</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">bad_arg</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># broadcasting to new dimensions must be enabled explicitly</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
                      <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;i-&gt;i&quot;</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]],</span>
                      <span class="s1">out</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>

        <span class="s3"># Check order kwarg, asanyarray allows 1d to pass through</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;i-&gt;i&quot;</span><span class="s2">,</span>
                      <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'d'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_object_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Exceptions created by object arithmetic should</span>
        <span class="s3"># successfully propagate</span>

        <span class="s0">class </span><span class="s1">CustomException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">class </span><span class="s1">DestructoBox</span><span class="s2">:</span>

            <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">destruct</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_val </span><span class="s2">= </span><span class="s1">value</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_destruct </span><span class="s2">= </span><span class="s1">destruct</span>

            <span class="s0">def </span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s1">tmp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_val </span><span class="s2">+ </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_val</span>
                <span class="s0">if </span><span class="s1">tmp </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_destruct</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">CustomException</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_val </span><span class="s2">= </span><span class="s1">tmp</span>
                    <span class="s0">return </span><span class="s1">self</span>

            <span class="s0">def </span><span class="s1">__radd__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">other </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">self</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__mul__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s1">tmp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_val </span><span class="s2">* </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_val</span>
                <span class="s0">if </span><span class="s1">tmp </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_destruct</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">CustomException</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_val </span><span class="s2">= </span><span class="s1">tmp</span>
                    <span class="s0">return </span><span class="s1">self</span>

            <span class="s0">def </span><span class="s1">__rmul__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">other </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">self</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__mul__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">DestructoBox</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s5">5</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'object'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

        <span class="s3"># raised from unbuffered_loop_nop1_ndim2</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">CustomException</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;ij-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s3"># raised from unbuffered_loop_nop1_ndim3</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">DestructoBox</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s5">100</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">27</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'object'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">CustomException</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;i...k-&gt;...&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># raised from unbuffered_loop_nop2_ndim2</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">DestructoBox</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s5">55</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'object'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">CustomException</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;ij, j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># raised from unbuffered_loop_nop2_ndim3</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">CustomException</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;ij, jh&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s3"># raised from PyArray_EinsteinSum</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">CustomException</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, </span><span class="s4">&quot;ij-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># pass-through</span>
        <span class="s0">for </span><span class="s1">do_opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

            <span class="s3"># output is writeable whenever input is writeable</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s4">'WRITEABLE'</span><span class="s2">])</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s4">'WRITEABLE'</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">b</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s4">'WRITEABLE'</span><span class="s2">])</span>

            <span class="s3"># transpose</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ji&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

            <span class="s3"># diagonal</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ii-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s3"># diagonal with various ways of broadcasting an additional dimension</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">27</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...ii-&gt;...i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ii...-&gt;...i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...ii-&gt;i...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;jii-&gt;ij&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ii...-&gt;i...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i...i-&gt;i...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i...i-&gt;...i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [[</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)]</span>
                             <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>

            <span class="s3"># triple diagonal</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">27</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;iii-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)])</span>

            <span class="s3"># swap axes</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ijk-&gt;jik&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">_no_nep50_warning</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">do_opt</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s3"># Check various sums.  Does many sizes to exercise unrolled loops.</span>

        <span class="s3"># sum(a, axis=-1)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'astype'</span><span class="s2">):</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], [], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s5">3</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'astype'</span><span class="s2">):</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...i-&gt;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># sum(a, axis=0)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'astype'</span><span class="s2">):</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i...-&gt;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s5">3</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'astype'</span><span class="s2">):</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i...-&gt;...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># trace(a)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">trace</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'astype'</span><span class="s2">):</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ii&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

            <span class="s3"># gh-15961: should accept numpy int64 type in subscript list</span>
            <span class="s1">np_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np_array</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">list</span><span class="s2">(</span><span class="s1">np_array</span><span class="s2">), </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># multiply(a, b)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;..., ...&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), </span><span class="s5">12</span><span class="s2">)  </span><span class="s3"># scalar case</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;..., ...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

        <span class="s3"># inner(a,b)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...i, ...i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inner</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s1">Ellipsis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">inner</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">11</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i..., i...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">inner</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">).</span><span class="s1">T</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">Ellipsis</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">inner</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">).</span><span class="s1">T</span><span class="s2">)</span>

        <span class="s3"># outer(a,b)</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)+</span><span class="s5">1</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)+</span><span class="s5">1</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                         <span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

        <span class="s3"># Suppress the complex warnings for the 'as f8' tests</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">.</span><span class="s1">ComplexWarning</span><span class="s2">)</span>

            <span class="s3"># matvec(a,b) / a.dot(b) where a is matrix, b is vector</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij, j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

                <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
                <span class="s1">c</span><span class="s2">[...] = </span><span class="s5">0</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ji,j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>

                <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ji,j&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
                <span class="s1">c</span><span class="s2">[...] = </span><span class="s5">0</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

            <span class="s3"># matmat(a,b) / a.dot(b) where a is matrix, b is matrix</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">n </span><span class="s2">&lt; </span><span class="s5">8 </span><span class="s0">or </span><span class="s1">dtype </span><span class="s2">!= </span><span class="s4">'f2'</span><span class="s2">:</span>
                    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
                    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,jk&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                                 <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                                 <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">17</span><span class="s2">):</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">*</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
                <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,jk&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">,</span>
                          <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
                <span class="s1">c</span><span class="s2">[...] = </span><span class="s5">0</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                                    <span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

            <span class="s3"># matrix triple product (note this is not currently an efficient</span>
            <span class="s3"># way to multiply 3 matrices)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">20</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">30</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">dtype </span><span class="s2">!= </span><span class="s4">'f2'</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,jk,kl&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">a</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">).</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">c</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
                                       <span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">).</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>

            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">18</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,jk,kl&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">,</span>
                      <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">tgt </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">).</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">))</span>
            <span class="s1">tgt </span><span class="s2">= </span><span class="s1">tgt</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>

            <span class="s1">d</span><span class="s2">[...] = </span><span class="s5">0</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">c</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">,</span>
                      <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
            <span class="s1">tgt </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">).</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">))</span>
            <span class="s1">tgt </span><span class="s2">= </span><span class="s1">tgt</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>

            <span class="s3"># tensordot(a, b)</span>
            <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) != </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'f2'</span><span class="s2">):</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">60</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ijk, jil -&gt; kl&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])))</span>

                <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ijk,jil-&gt;kl&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">), </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                             <span class="s1">axes</span><span class="s2">=([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
                <span class="s1">c</span><span class="s2">[...] = </span><span class="s5">0</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">), </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">),</span>
                             <span class="s1">axes</span><span class="s2">=([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s3"># logical_and(logical_and(a!=0, b!=0), c!=0)</span>
        <span class="s1">neg_val </span><span class="s2">= -</span><span class="s5">2 </span><span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">!= </span><span class="s4">&quot;u&quot; </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">max </span><span class="s2">- </span><span class="s5">1</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">,   </span><span class="s5">3</span><span class="s2">,   </span><span class="s1">neg_val</span><span class="s2">, </span><span class="s5">0</span><span class="s2">,  </span><span class="s5">12</span><span class="s2">,  </span><span class="s5">13</span><span class="s2">,   </span><span class="s5">0</span><span class="s2">,   </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">,   </span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s1">neg_val</span><span class="s2">,  </span><span class="s5">0</span><span class="s2">,   </span><span class="s5">1</span><span class="s2">,    </span><span class="s5">3</span><span class="s2">,   </span><span class="s5">12</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,i,i-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">,</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'?'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">(</span><span class="s1">a </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">, </span><span class="s1">b </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">), </span><span class="s1">c </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">c</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'?'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">(</span><span class="s1">a </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">, </span><span class="s1">b </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">), </span><span class="s1">c </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;,i-&gt;&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s5">3</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, [], </span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], []), </span><span class="s5">3</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s5">3</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], </span><span class="s5">3</span><span class="s2">, [], []), </span><span class="s5">3</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>

        <span class="s3"># Various stride0, contiguous, and SSE aligned variants</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">25</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...,...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;,i-&gt;i&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;,i-&gt;&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>

                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...,...&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,-&gt;i&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s5">2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;,i-&gt;i&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">), </span><span class="s5">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s5">2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;,i-&gt;&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">do_opt</span><span class="s2">),</span>
                             <span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]))</span>

        <span class="s3"># An object array, summed as the data type</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i-&gt;&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">&quot;dtype&quot;</span><span class="s2">):</span>
            <span class="s3"># Can be a python object when dtype is object</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">], [], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s4">'unsafe'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s4">&quot;dtype&quot;</span><span class="s2">):</span>
            <span class="s3"># Can be a python object when dtype is object</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s3"># A case which was failing (ticket #1885)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">) + </span><span class="s5">1</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">) + </span><span class="s5">3</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">) + </span><span class="s5">7</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'z,mz,zm-&gt;'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">), </span><span class="s5">253</span><span class="s2">)</span>

        <span class="s3"># singleton dimensions broadcast (gh-10343)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">10</span><span class="s2">,</span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">,</span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,ij-&gt;j'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,ij-&gt;j'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,ij-&gt;j'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s5">10.</span><span class="s2">] * </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s3"># a blas-compatible contraction broadcasting case which was failing</span>
        <span class="s3"># for optimize=True (ticket #10930)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">4.</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i, i&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s5">20.</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i, i&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s5">20.</span><span class="s2">)</span>

        <span class="s3"># all-ones array was bypassing bug (ticket #10930)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)) / </span><span class="s5">2</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)) / </span><span class="s5">2</span>
        <span class="s0">for </span><span class="s1">optimize </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">p</span><span class="s2">,</span>
                                         <span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">),</span>
                               <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">,</span>
                                         <span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">))</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;...ij,...jk-&gt;...ik&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">q</span><span class="s2">,</span>
                                         <span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">),</span>
                               <span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), </span><span class="s5">1.25</span><span class="s2">))</span>

        <span class="s3"># Cases which were failing (gh-10899)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ji,i-&gt;&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s5">2.</span><span class="s2">])  </span><span class="s3"># contig_contig_outstride0_two</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,ij-&gt;&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s5">2.</span><span class="s2">])  </span><span class="s3"># stride0_contig_outstride0_two</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;ij,i-&gt;&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">optimize</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s5">2.</span><span class="s2">])  </span><span class="s3"># contig_stride0_outstride0_two</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'i1'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'u1'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int16</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'i2'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint16</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'u2'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'i4'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'i4'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'u4'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'u4'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_int64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'i8'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_uint64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'u8'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float16</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'f2'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'f4'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_float64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_longdouble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_cfloat64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'c8'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'c8'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_cfloat128</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'c16'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_clongdouble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_sums_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'object'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_einsum_sums</span><span class="s2">(</span><span class="s4">'object'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_misc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># This call used to crash because of a bug in</span>
        <span class="s3"># PyArray_AssignZero</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,j...-&gt;i...'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [[[</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,j...-&gt;i...'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), [[[</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]])</span>

        <span class="s3"># Regression test for issue #10369 (test unicode inputs with Python 2)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,j...-&gt;i...'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [[[</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...i,...i'</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]), </span><span class="s5">20</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...i,...i'</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
                               <span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">), </span><span class="s5">20</span><span class="s2">)</span>

        <span class="s3"># The iterator had an issue with buffering this reduction</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">11</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijklm,ijn,ijn-&gt;'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijklm,ijn-&gt;'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijklm,ijn,ijn-&gt;'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijklm,ijn-&gt;'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>

        <span class="s3"># Issue #2027, was a problem in the contiguous 3-argument</span>
        <span class="s3"># inner loop implementation</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'x,yx,zx-&gt;xzy'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">),</span>
                     <span class="s2">[[[</span><span class="s5">1</span><span class="s2">,  </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">,  </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">15</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">21</span><span class="s2">]],</span>
                     <span class="s2">[[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">16</span><span class="s2">], [</span><span class="s5">16</span><span class="s2">, </span><span class="s5">32</span><span class="s2">], [</span><span class="s5">24</span><span class="s2">, </span><span class="s5">48</span><span class="s2">], [</span><span class="s5">32</span><span class="s2">, </span><span class="s5">64</span><span class="s2">]]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'x,yx,zx-&gt;xzy'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                     <span class="s2">[[[</span><span class="s5">1</span><span class="s2">,  </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">,  </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">15</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">21</span><span class="s2">]],</span>
                     <span class="s2">[[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">16</span><span class="s2">], [</span><span class="s5">16</span><span class="s2">, </span><span class="s5">32</span><span class="s2">], [</span><span class="s5">24</span><span class="s2">, </span><span class="s5">48</span><span class="s2">], [</span><span class="s5">32</span><span class="s2">, </span><span class="s5">64</span><span class="s2">]]])</span>

        <span class="s3"># Ensure explicitly setting out=None does not cause an error</span>
        <span class="s3"># see issue gh-15776 and issue gh-15256</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,j'</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">), [[</span><span class="s5">2</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_object_loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">Mult</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__mul__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s5">42</span>

        <span class="s1">objMult </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">Mult</span><span class="s2">()])</span>
        <span class="s1">objNULL </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">buffer </span><span class="s2">= </span><span class="s6">b'</span><span class="s0">\0</span><span class="s6">' </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,j&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">], </span><span class="s1">objNULL</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,j&quot;</span><span class="s2">, </span><span class="s1">objNULL</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">&quot;i,j&quot;</span><span class="s2">, </span><span class="s1">objMult</span><span class="s2">, </span><span class="s1">objMult</span><span class="s2">) == </span><span class="s5">42</span>

    <span class="s0">def </span><span class="s1">test_subscript_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issue #7741, make sure that all letters of Latin alphabet (both uppercase &amp; lowercase) can be used</span>
        <span class="s3"># when creating a subscript from arrays</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">20</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">27</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">27</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">51</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">51</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">52</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">52</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], </span><span class="s1">b</span><span class="s2">, [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_einsum_broadcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issue #2455 change in handling ellipsis</span>
        <span class="s3"># remove the 'middle broadcast' error</span>
        <span class="s3"># only use the 'RIGHT' iteration in prepare_op_axes</span>
        <span class="s3"># adds auto broadcast on left where it belongs</span>
        <span class="s3"># broadcast on right has to be explicit</span>
        <span class="s3"># We need to test the optimized parsing as well</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijk,j-&gt;ijk'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,j...-&gt;ij...'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,...j-&gt;ij...'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij...,j-&gt;ij...'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)  </span><span class="s3"># used to raise error</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ik,kj-&gt;ij'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ik...,k...-&gt;i...'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ik...,...kj-&gt;i...j'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...k,kj'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)  </span><span class="s3"># used to raise error</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ik,k...-&gt;i...'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)  </span><span class="s3"># used to raise error</span>

        <span class="s1">dims </span><span class="s2">= [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">dims</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">dims</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">dims</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijkl,k-&gt;ijl'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijkl,k'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...kl,k'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)  </span><span class="s3"># used to raise error</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...kl,k...'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>

        <span class="s1">J</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">M </span><span class="s2">= </span><span class="s5">160</span><span class="s2">, </span><span class="s5">160</span><span class="s2">, </span><span class="s5">120</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">J </span><span class="s2">* </span><span class="s1">K </span><span class="s2">* </span><span class="s1">M</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">J</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">M</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">J </span><span class="s2">* </span><span class="s1">K </span><span class="s2">* </span><span class="s1">M </span><span class="s2">* </span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">J</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...lmn,...lmno-&gt;...o'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...lmn,lmno-&gt;...o'</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">,</span>
                                   <span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)  </span><span class="s3"># used to raise error</span>

    <span class="s0">def </span><span class="s1">test_einsum_fixedstridebug</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issue #4485 obscure einsum bug</span>
        <span class="s3"># This case revealed a bug in nditer where it reported a stride</span>
        <span class="s3"># as 'fixed' (0) when it was in fact not fixed during processing</span>
        <span class="s3"># (0 or 4). The reason for the bug was that the check for a fixed</span>
        <span class="s3"># stride was using the information from the 2D inner loop reuse</span>
        <span class="s3"># to restrict the iteration dimensions it had to validate to be</span>
        <span class="s3"># the same, but that 2D inner loop reuse logic is only triggered</span>
        <span class="s3"># during the buffer copying step, and hence it was invalid to</span>
        <span class="s3"># rely on those values. The fix is to check all the dimensions</span>
        <span class="s3"># of the stride in question, which in the test case reveals that</span>
        <span class="s3"># the stride is not fixed.</span>
        <span class="s3">#</span>
        <span class="s3"># NOTE: This test is triggered by the fact that the default buffersize,</span>
        <span class="s3">#       used by einsum, is 8192, and 3*2731 = 8193, is larger than that</span>
        <span class="s3">#       and results in a mismatch between the buffering and the</span>
        <span class="s3">#       striding for operand A.</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">2731</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2731</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">es </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'cl, cpx-&gt;lpx'</span><span class="s2">,  </span><span class="s1">A</span><span class="s2">,  </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">tp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">A</span><span class="s2">,  </span><span class="s1">B</span><span class="s2">,  </span><span class="s1">axes</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">,  </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">es</span><span class="s2">,  </span><span class="s1">tp</span><span class="s2">)</span>
        <span class="s3"># The following is the original test case from the bug report,</span>
        <span class="s3"># made repeatable by changing random arrays to aranges.</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">* </span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">* </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">64 </span><span class="s2">* </span><span class="s5">64</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">64</span><span class="s2">, </span><span class="s5">64</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">es </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'cl, cpxy-&gt;lpxy'</span><span class="s2">,  </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">tp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tensordot</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">,  </span><span class="s1">axes</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">es</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_fixed_collapsingbug</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issue #5147.</span>
        <span class="s3"># The bug only occurred when output argument of einssum was used.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'aabb-&gt;ab'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">y1</span><span class="s2">)</span>
        <span class="s1">idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
        <span class="s1">y2 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">idx</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_failed_on_p9_and_s390x</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issues gh-14692 and gh-12689</span>
        <span class="s3"># Bug with signed vs unsigned char errored on power9 and s390x Linux</span>
        <span class="s1">tensor </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ijij-&gt;'</span><span class="s2">, </span><span class="s1">tensor</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">tensor</span><span class="s2">.</span><span class="s1">trace</span><span class="s2">(</span><span class="s1">axis1</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">axis2</span><span class="s2">=</span><span class="s5">2</span><span class="s2">).</span><span class="s1">trace</span><span class="s2">()</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_einsum_all_contig_non_contig_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Issue gh-5907, tests that the all contiguous special case</span>
        <span class="s3"># actually checks the contiguity of the output</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">]</span>
        <span class="s1">correct_base </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">correct_base</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">] = </span><span class="s5">5</span>
        <span class="s3"># Always worked (inner iteration is done with 0-stride):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'mi,mi,mi-&gt;m'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">base</span><span class="s2">, </span><span class="s1">correct_base</span><span class="s2">)</span>
        <span class="s3"># Example 1:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">]</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'im,im,im-&gt;m'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">base</span><span class="s2">, </span><span class="s1">correct_base</span><span class="s2">)</span>
        <span class="s3"># Example 2, buffering causes x to be contiguous but</span>
        <span class="s3"># special cases do not catch the operation before:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))[..., </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">correct_base </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">correct_base</span><span class="s2">[..., </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">2</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,jk-&gt;ik'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">base</span><span class="s2">, </span><span class="s1">correct_base</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">,</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;AllFloat&quot;</span><span class="s2">] + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;AllInteger&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_different_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s3"># Test originally added to cover broken float16 path: gh-20305</span>
        <span class="s3"># Likely most are covered elsewhere, at least partially.</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s3"># Simple test, designed to exercise most specialized code paths,</span>
        <span class="s3"># note the +0.5 for floats.  This makes sure we use a float value</span>
        <span class="s3"># where the results must be exact.</span>
        <span class="s1">arr </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">7</span><span class="s2">) + </span><span class="s5">0.5</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">scalar </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s3"># contig -&gt; scalar:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i-&gt;'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s3"># contig, contig -&gt; contig:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,i-&gt;i'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s3"># noncontig, noncontig -&gt; contig:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,i-&gt;i'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">], </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s3"># contig + contig -&gt; scalar</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,i-&gt;'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">) == (</span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s3"># contig + scalar -&gt; contig (with out)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">7</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,-&gt;i'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
        <span class="s3"># scalar + contig -&gt; contig (with out)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">',i-&gt;i'</span><span class="s2">, </span><span class="s1">scalar</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
        <span class="s3"># scalar + contig -&gt; scalar</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">',i-&gt;'</span><span class="s2">, </span><span class="s1">scalar</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s3"># Use einsum to compare to not have difference due to sum round-offs:</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i-&gt;'</span><span class="s2">, </span><span class="s1">scalar </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s3"># contig + scalar -&gt; scalar</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,-&gt;'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">scalar</span><span class="s2">)</span>
        <span class="s3"># Use einsum to compare to not have difference due to sum round-offs:</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i-&gt;'</span><span class="s2">, </span><span class="s1">scalar </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s3"># contig + contig + contig -&gt; scalar</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">4.5</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,i,i-&gt;'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, (</span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">())</span>
        <span class="s3"># four arrays:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'i,i,i,i-&gt;'</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, (</span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_small_boolean_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># See gh-5946.</span>
        <span class="s3"># Use array of True embedded in False.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">16</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">)[:</span><span class="s5">2</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">[...] = </span><span class="s0">True</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">16</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">)[:</span><span class="s5">2</span><span class="s2">]</span>
        <span class="s1">tgt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ij,...jk-&gt;...ik'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_out_is_res</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ij,...jk-&gt;...ik'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res </span><span class="s0">is </span><span class="s1">a</span>

    <span class="s0">def </span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subscripts</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3"># Tests all paths of the optimization function against</span>
        <span class="s3"># conventional einsum</span>
        <span class="s0">if </span><span class="s1">operands </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= [</span><span class="s1">subscripts</span><span class="s2">]</span>
            <span class="s1">terms </span><span class="s2">= </span><span class="s1">subscripts</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'-&gt;'</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s4">','</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">term </span><span class="s0">in </span><span class="s1">terms</span><span class="s2">:</span>
                <span class="s1">dims </span><span class="s2">= [</span><span class="s1">global_size_dict</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">term</span><span class="s2">]</span>
                <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">dims</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= [</span><span class="s1">subscripts</span><span class="s2">] + </span><span class="s1">operands</span>

        <span class="s1">noopt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s1">noopt</span><span class="s2">)</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">opt</span><span class="s2">, </span><span class="s1">noopt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_hadamard_like_products</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Hadamard outer products</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'a,ab,abc-&gt;abc'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'a,b,ab-&gt;ab'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_index_transformations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Simple index transformation cases</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ea,fb,gc,hd,abcd-&gt;efgh'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ea,fb,abcd,gc,hd-&gt;efgh'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abcd,ea,fb,gc,hd-&gt;efgh'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Long test cases</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'cd,bdhe,aidb,hgca,gc,hgibcd,hgac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abhe,hidj,jgba,hiab,gab'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bde,cdh,agdb,hica,ibd,hgicd,hiac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'chd,bde,agbc,hiad,hgc,hgi,hiad'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'chd,bde,agbc,hiad,bdi,cgh,agdb'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bdhe,acad,hiab,agac,hibd'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_collapse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Inner products</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,c-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,c-&gt;c'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,cd,cd-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,cd,cd-&gt;ac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,cd,cd-&gt;cd'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab,cd,cd,ef,ef-&gt;'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_expand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Outer products</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,cd,ef-&gt;abcdef'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,cd,ef-&gt;acdf'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,cd,de-&gt;abcde'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,cd,de-&gt;be'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,bcd,cd-&gt;abcd'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,bcd,cd-&gt;abd'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_edge_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Difficult edge cases for optimization</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'eb,cb,fb-&gt;cef'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'dd,fb,be,cdb-&gt;cef'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bca,cdb,dbf,afc-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'fdf,cdd,ccd,afe-&gt;ae'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abcd,ad'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ed,fcd,ff,bcf-&gt;be'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'baa,dcf,af,cde-&gt;be'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bd,db,eac-&gt;ace'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'fff,fae,bef,def-&gt;abd'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'efc,dbc,acf,fd-&gt;abe'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ba,ac,da-&gt;bcd'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inner_product</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Inner products</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ab'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ab,ba'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abc,abc'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abc,bac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abc,cba'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Randomly built test cases</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'aab,fa,df,ecc-&gt;bde'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ecb,fef,bad,ed-&gt;ac'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bcf,bbb,fbf,fc-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bb,ff,be-&gt;e'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bcb,bb,fc,fff-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'fbb,dfd,fc,fc-&gt;'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'afd,ba,cc,dc-&gt;bf'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'adb,bc,fa,cfc-&gt;d'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'bbd,bda,fc,db-&gt;acf'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'dba,ead,cad-&gt;bce'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'aef,fbc,dca-&gt;bde'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_combined_views_mapping</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># gh-10792</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'bbcdc-&gt;d'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s5">12</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_broadcasting_dot_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Ensures broadcasting cases are not mistaken for GEMM</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ijk,kl,jl'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=[</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'ijk,kl,jl,i-&gt;i'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=[</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">])</span>

        <span class="s1">e </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">7</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abjk,kl,jl'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=[</span><span class="s1">e</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'abjk,kl,jl,ab-&gt;ab'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=[</span><span class="s1">e</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">f</span><span class="s2">])</span>

        <span class="s3"># Edge case found in gh-11308</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">64</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">optimize_compare</span><span class="s2">(</span><span class="s4">'obk,ijk-&gt;ioj'</span><span class="s2">, </span><span class="s1">operands</span><span class="s2">=[</span><span class="s1">g</span><span class="s2">, </span><span class="s1">g</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_output_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Ensure output order is respected for optimize cases, the below</span>
        <span class="s3"># conraction should yield a reshaped tensor view</span>
        <span class="s3"># gh-16415</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>

            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>

            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'c'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>

            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'k'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">is False</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous </span><span class="s0">is False</span><span class="s2">)</span>

            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">is False</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous </span><span class="s0">is False</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">opt </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'...ft,mf-&gt;...mt'</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">opt</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestEinsumPath</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">build_operands</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">string</span><span class="s2">, </span><span class="s1">size_dict</span><span class="s2">=</span><span class="s1">global_size_dict</span><span class="s2">):</span>

        <span class="s3"># Builds views based off initial operands</span>
        <span class="s1">operands </span><span class="s2">= [</span><span class="s1">string</span><span class="s2">]</span>
        <span class="s1">terms </span><span class="s2">= </span><span class="s1">string</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'-&gt;'</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s4">','</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">term </span><span class="s0">in </span><span class="s1">terms</span><span class="s2">:</span>
            <span class="s1">dims </span><span class="s2">= [</span><span class="s1">size_dict</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">term</span><span class="s2">]</span>
            <span class="s1">operands</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">dims</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">operands</span>

    <span class="s0">def </span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">comp</span><span class="s2">, </span><span class="s1">benchmark</span><span class="s2">):</span>
        <span class="s3"># Checks if list of tuples are equivalent</span>
        <span class="s1">ret </span><span class="s2">= (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">benchmark</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">ret </span><span class="s2">&amp;= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">], </span><span class="s1">tuple</span><span class="s2">)</span>
            <span class="s1">ret </span><span class="s2">&amp;= (</span><span class="s1">comp</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] == </span><span class="s1">benchmark</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_memory_contraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Ensure memory constraints are satisfied</span>

        <span class="s1">outer_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'a,b,c-&gt;abc'</span><span class="s2">)</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">outer_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=(</span><span class="s4">'greedy'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">outer_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=(</span><span class="s4">'optimal'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>

        <span class="s1">long_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'acdf,jbje,gihb,hfac'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=(</span><span class="s4">'greedy'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=(</span><span class="s4">'optimal'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_long_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Long complex cases</span>

        <span class="s3"># Long test 1</span>
        <span class="s1">long_test1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'acdf,jbje,gihb,hfac,gfac,gifabc,hfac'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test1</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">,</span>
                                      <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test1</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">,</span>
                                      <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s3"># Long test 2</span>
        <span class="s1">long_test2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'chd,bde,agbc,hiad,bdi,cgh,agdb'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">,</span>
                                      <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">long_test2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">,</span>
                                      <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_edge_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Difficult edge cases</span>

        <span class="s3"># Edge test1</span>
        <span class="s1">edge_test1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'eb,cb,fb-&gt;cef'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test1</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test1</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s3"># Edge test2</span>
        <span class="s1">edge_test2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'dd,fb,be,cdb-&gt;cef'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test2</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s3"># Edge test3</span>
        <span class="s1">edge_test3 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'bca,cdb,dbf,afc-&gt;'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test3</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test3</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s3"># Edge test4</span>
        <span class="s1">edge_test4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s2">)</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test4</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test4</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s3"># Edge test5</span>
        <span class="s1">edge_test4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'a,ac,ab,ad,cd,bd,bc-&gt;'</span><span class="s2">,</span>
                                         <span class="s1">size_dict</span><span class="s2">={</span><span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s5">20</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s5">20</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">: </span><span class="s5">20</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">: </span><span class="s5">20</span><span class="s2">})</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test4</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'greedy'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">edge_test4</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s4">'optimal'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_path_type_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test explicit path handling</span>
        <span class="s1">path_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'dcc,fce,ea,dbf-&gt;ab'</span><span class="s2">)</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)])</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>

        <span class="s1">exp_path </span><span class="s2">= [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)]</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">exp_path</span><span class="s2">)</span>

        <span class="s3"># Double check einsum works on the input path</span>
        <span class="s1">noopt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">noopt</span><span class="s2">, </span><span class="s1">opt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_path_type_input_internal_trace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">#gh-20962</span>
        <span class="s1">path_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'cab,cdd-&gt;ab'</span><span class="s2">)</span>
        <span class="s1">exp_path </span><span class="s2">= [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">,), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)]</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">path_str </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_path_equal</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">exp_path</span><span class="s2">)</span>

        <span class="s3"># Double check einsum works on the input path</span>
        <span class="s1">noopt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">opt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(*</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">noopt</span><span class="s2">, </span><span class="s1">opt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_path_type_input_invalid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">path_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'ab,bc,cd,de-&gt;ae'</span><span class="s2">)</span>
        <span class="s1">exp_path </span><span class="s2">= [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, *</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span>
            <span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">, *</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>

        <span class="s1">path_test </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_operands</span><span class="s2">(</span><span class="s4">'a,a,a-&gt;a'</span><span class="s2">)</span>
        <span class="s1">exp_path </span><span class="s2">= [</span><span class="s4">'einsum_path'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">,), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">, *</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span>
            <span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum_path</span><span class="s2">, *</span><span class="s1">path_test</span><span class="s2">, </span><span class="s1">optimize</span><span class="s2">=</span><span class="s1">exp_path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_spaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">#gh-10794</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s0">for </span><span class="s1">sp </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">([</span><span class="s4">''</span><span class="s2">, </span><span class="s4">' '</span><span class="s2">], </span><span class="s1">repeat</span><span class="s2">=</span><span class="s5">4</span><span class="s2">):</span>
            <span class="s3"># no error for any spacing</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'{}...a{}-&gt;{}...a{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(*</span><span class="s1">sp</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_overlap</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s3"># sanity check</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,jk-&gt;ik'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
    <span class="s3">#gh-10080, out overlaps one of the operands</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s4">'ij,jk-&gt;ik'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
</pre>
</body>
</html>