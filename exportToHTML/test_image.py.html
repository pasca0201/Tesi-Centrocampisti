<html>
<head>
<title>test_image.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_image.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">ExitStack</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span>
<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">colors</span><span class="s2">, </span><span class="s1">image </span><span class="s0">as </span><span class="s1">mimage</span><span class="s2">, </span><span class="s1">patches</span><span class="s2">, </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span><span class="s2">, </span><span class="s1">style</span><span class="s2">, </span><span class="s1">rcParams</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">image </span><span class="s0">import </span><span class="s2">(</span><span class="s1">AxesImage</span><span class="s2">, </span><span class="s1">BboxImage</span><span class="s2">, </span><span class="s1">FigureImage</span><span class="s2">,</span>
                              <span class="s1">NonUniformImage</span><span class="s2">, </span><span class="s1">PcolorImage</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">import </span><span class="s1">Bbox</span><span class="s2">, </span><span class="s1">Affine2D</span><span class="s2">, </span><span class="s1">TransformedBbox</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">ticker </span><span class="s0">as </span><span class="s1">mticker</span>

<span class="s0">import </span><span class="s1">pytest</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_interps'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_interps</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Make the basic nearest, bilinear and bicubic interps.&quot;&quot;&quot;</span>
    <span class="s5"># Remove texts when this image is regenerated.</span>
    <span class="s5"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'text.kerning_factor'</span><span class="s2">] = </span><span class="s6">6</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">20</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">ax3</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'three interpolations'</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'nearest'</span><span class="s2">)</span>

    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'bilinear'</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'bilinear'</span><span class="s2">)</span>

    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'bicubic'</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'bicubic'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'interp_alpha.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_alpha_interp</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test the interpolation of the alpha channel on RGBA images&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">axl</span><span class="s2">, </span><span class="s1">axr</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s5"># full green image</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">4</span><span class="s2">))</span>
    <span class="s1">img</span><span class="s2">[..., </span><span class="s6">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">))</span>
    <span class="s5"># transparent under main diagonal</span>
    <span class="s1">img</span><span class="s2">[..., </span><span class="s6">3</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tril</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">))</span>
    <span class="s1">axl</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">img</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">&quot;none&quot;</span><span class="s2">)</span>
    <span class="s1">axr</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">img</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">&quot;bilinear&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'interp_nearest_vs_none'</span><span class="s2">],</span>
                  <span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'pdf'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_interp_nearest_vs_none</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test the effect of &quot;nearest&quot; and &quot;none&quot; interpolation&quot;&quot;&quot;</span>
    <span class="s5"># Setting dpi to something really small makes the difference very</span>
    <span class="s5"># visible. This works fine with pdf, since the dpi setting doesn't</span>
    <span class="s5"># affect anything but images, but the agg output becomes unusably</span>
    <span class="s5"># small.</span>
    <span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'savefig.dpi'</span><span class="s2">] = </span><span class="s6">3</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[[</span><span class="s6">218</span><span class="s2">, </span><span class="s6">165</span><span class="s2">, </span><span class="s6">32</span><span class="s2">], [</span><span class="s6">122</span><span class="s2">, </span><span class="s6">103</span><span class="s2">, </span><span class="s6">238</span><span class="s2">]],</span>
                  <span class="s2">[[</span><span class="s6">127</span><span class="s2">, </span><span class="s6">255</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], [</span><span class="s6">255</span><span class="s2">, </span><span class="s6">99</span><span class="s2">, </span><span class="s6">71</span><span class="s2">]]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'interpolation none'</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'interpolation nearest'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'suppressComposite'</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figimage'</span><span class="s2">], </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">, </span><span class="s3">'pdf'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_figimage</span><span class="s2">(</span><span class="s1">suppressComposite</span><span class="s2">):</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suppressComposite </span><span class="s2">= </span><span class="s1">suppressComposite</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ix_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">) / </span><span class="s6">100.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">) / </span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">*</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s6">20</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s6">50</span><span class="s2">*</span><span class="s1">y</span><span class="s2">**</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">z </span><span class="s2">+ </span><span class="s1">c</span><span class="s2">/</span><span class="s6">5</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">figimage</span><span class="s2">(</span><span class="s1">img</span><span class="s2">, </span><span class="s1">xo</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">figimage</span><span class="s2">(</span><span class="s1">img</span><span class="s2">[::-</span><span class="s6">1</span><span class="s2">, :], </span><span class="s1">xo</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">figimage</span><span class="s2">(</span><span class="s1">img</span><span class="s2">[:, ::-</span><span class="s6">1</span><span class="s2">], </span><span class="s1">xo</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">figimage</span><span class="s2">(</span><span class="s1">img</span><span class="s2">[::-</span><span class="s6">1</span><span class="s2">, ::-</span><span class="s6">1</span><span class="s2">], </span><span class="s1">xo</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_image_python_io</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">])</span>
    <span class="s1">buffer </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>
    <span class="s1">buffer</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;img_size, fig_size, interpolation&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s3">&quot;hanning&quot;</span><span class="s2">),  </span><span class="s5"># data larger than figure.</span>
     <span class="s2">(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s3">&quot;nearest&quot;</span><span class="s2">),  </span><span class="s5"># exact resample.</span>
     <span class="s2">(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s3">&quot;nearest&quot;</span><span class="s2">),  </span><span class="s5"># double sample.</span>
     <span class="s2">(</span><span class="s6">3</span><span class="s2">, </span><span class="s6">2.9</span><span class="s2">, </span><span class="s3">&quot;hanning&quot;</span><span class="s2">),  </span><span class="s5"># &lt;3 upsample.</span>
     <span class="s2">(</span><span class="s6">3</span><span class="s2">, </span><span class="s6">9.1</span><span class="s2">, </span><span class="s3">&quot;nearest&quot;</span><span class="s2">),  </span><span class="s5"># &gt;3 upsample.</span>
     <span class="s2">])</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imshow_antialiased</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">,</span>
                            <span class="s1">img_size</span><span class="s2">, </span><span class="s1">fig_size</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">19680801</span><span class="s2">)</span>
    <span class="s1">dpi </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;savefig.dpi&quot;</span><span class="s2">]</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">dpi </span><span class="s2">* </span><span class="s1">img_size</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dpi </span><span class="s2">* </span><span class="s1">img_size</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s2">[</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s1">fig_size</span><span class="s2">, </span><span class="s1">fig_size</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_position</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'antialiased'</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_position</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s1">interpolation</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imshow_zoom</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># should be less than 3 upsample, so should be nearest...</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">19680801</span><span class="s2">)</span>
    <span class="s1">dpi </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;savefig.dpi&quot;</span><span class="s2">]</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">dpi </span><span class="s2">* </span><span class="s6">3</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">dpi </span><span class="s2">* </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s2">[</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s6">2.9</span><span class="s2">, </span><span class="s6">2.9</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'antialiased'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([</span><span class="s6">10</span><span class="s2">, </span><span class="s6">20</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">([</span><span class="s6">10</span><span class="s2">, </span><span class="s6">20</span><span class="s2">])</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([</span><span class="s6">10</span><span class="s2">, </span><span class="s6">20</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">([</span><span class="s6">10</span><span class="s2">, </span><span class="s6">20</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_imshow_pil</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">style</span><span class="s2">.</span><span class="s1">use</span><span class="s2">(</span><span class="s3">&quot;default&quot;</span><span class="s2">)</span>
    <span class="s1">png_path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s3">&quot;baseline_images/pngsuite/basn3p04.png&quot;</span>
    <span class="s1">tiff_path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s3">&quot;baseline_images/test_image/uint16.tif&quot;</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">png_path</span><span class="s2">))</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">tiff_path</span><span class="s2">))</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">png_path</span><span class="s2">))</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">tiff_path</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_imread_pil_uint16</span><span class="s2">():</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">),</span>
                     <span class="s3">'baseline_images'</span><span class="s2">, </span><span class="s3">'test_image'</span><span class="s2">, </span><span class="s3">'uint16.tif'</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">img</span><span class="s2">) == </span><span class="s6">134184960</span>


<span class="s0">def </span><span class="s1">test_imread_fspath</span><span class="s2">():</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span>
        <span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s3">'baseline_images/test_image/uint16.tif'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">img</span><span class="s2">) == </span><span class="s6">134184960</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;fmt&quot;</span><span class="s2">, [</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s3">&quot;jpg&quot;</span><span class="s2">, </span><span class="s3">&quot;jpeg&quot;</span><span class="s2">, </span><span class="s3">&quot;tiff&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imsave</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s1">has_alpha </span><span class="s2">= </span><span class="s1">fmt </span><span class="s0">not in </span><span class="s2">[</span><span class="s3">&quot;jpg&quot;</span><span class="s2">, </span><span class="s3">&quot;jpeg&quot;</span><span class="s2">]</span>

    <span class="s5"># The goal here is that the user can specify an output logical DPI</span>
    <span class="s5"># for the image, but this will not actually add any extra pixels</span>
    <span class="s5"># to the image, it will merely be used for metadata purposes.</span>

    <span class="s5"># So we do the traditional case (dpi == 1), and the new case (dpi</span>
    <span class="s5"># == 100) and read the resulting PNG files back in and make sure</span>
    <span class="s5"># the data is 100% identical.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s5"># The height of 1856 pixels was selected because going through creating an</span>
    <span class="s5"># actual dpi=100 figure to save the image to a Pillow-provided format would</span>
    <span class="s5"># cause a rounding error resulting in a final image of shape 1855.</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">1856</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>

    <span class="s1">buff_dpi1 </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buff_dpi1</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">buff_dpi100 </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buff_dpi100</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>

    <span class="s1">buff_dpi1</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">arr_dpi1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buff_dpi1</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>

    <span class="s1">buff_dpi100</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">arr_dpi100 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buff_dpi100</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">arr_dpi1</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s6">1856</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3 </span><span class="s2">+ </span><span class="s1">has_alpha</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">arr_dpi100</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s6">1856</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3 </span><span class="s2">+ </span><span class="s1">has_alpha</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_dpi1</span><span class="s2">, </span><span class="s1">arr_dpi100</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;origin&quot;</span><span class="s2">, [</span><span class="s3">&quot;upper&quot;</span><span class="s2">, </span><span class="s3">&quot;lower&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imsave_rgba_origin</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">):</span>
    <span class="s5"># test that imsave always passes c-contiguous arrays down to pillow</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">4</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'uint8'</span><span class="s2">)</span>
    <span class="s1">mimage</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">=</span><span class="s1">result</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">origin</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;fmt&quot;</span><span class="s2">, [</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ps&quot;</span><span class="s2">, </span><span class="s3">&quot;eps&quot;</span><span class="s2">, </span><span class="s3">&quot;svg&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imsave_fspath</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">devnull</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]]), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imsave_color_alpha</span><span class="s2">():</span>
    <span class="s5"># Test that imsave accept arrays with ndim=3 where the third dimension is</span>
    <span class="s5"># color and alpha without raising any exceptions, and that the data is</span>
    <span class="s5"># acceptably preserved through a save/read roundtrip.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">origin </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'lower'</span><span class="s2">, </span><span class="s3">'upper'</span><span class="s2">]:</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">16</span><span class="s2">, </span><span class="s6">16</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">)</span>

        <span class="s1">buff</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">arr_buf </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">)</span>

        <span class="s5"># Recreate the float -&gt; uint8 conversion of the data</span>
        <span class="s5"># We can only expect to be the same with 8 bits of precision,</span>
        <span class="s5"># since that's what the PNG file used.</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s6">255</span><span class="s2">*</span><span class="s1">data</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'uint8'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">origin </span><span class="s2">== </span><span class="s3">'lower'</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[::-</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">arr_buf </span><span class="s2">= (</span><span class="s6">255</span><span class="s2">*</span><span class="s1">arr_buf</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'uint8'</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">arr_buf</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imsave_pil_kwargs_png</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">PIL</span><span class="s2">.</span><span class="s1">PngImagePlugin </span><span class="s0">import </span><span class="s1">PngInfo</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">pnginfo </span><span class="s2">= </span><span class="s1">PngInfo</span><span class="s2">()</span>
    <span class="s1">pnginfo</span><span class="s2">.</span><span class="s1">add_text</span><span class="s2">(</span><span class="s3">&quot;Software&quot;</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, [[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">]],</span>
               <span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s1">pil_kwargs</span><span class="s2">={</span><span class="s3">&quot;pnginfo&quot;</span><span class="s2">: </span><span class="s1">pnginfo</span><span class="s2">})</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">info</span><span class="s2">[</span><span class="s3">&quot;Software&quot;</span><span class="s2">] == </span><span class="s3">&quot;test&quot;</span>


<span class="s0">def </span><span class="s1">test_imsave_pil_kwargs_tiff</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">PIL</span><span class="s2">.</span><span class="s1">TiffTags </span><span class="s0">import </span><span class="s1">TAGS_V2 </span><span class="s0">as </span><span class="s1">TAGS</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">pil_kwargs </span><span class="s2">= {</span><span class="s3">&quot;description&quot;</span><span class="s2">: </span><span class="s3">&quot;test image&quot;</span><span class="s2">}</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, [[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">]], </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;tiff&quot;</span><span class="s2">, </span><span class="s1">pil_kwargs</span><span class="s2">=</span><span class="s1">pil_kwargs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pil_kwargs</span><span class="s2">) == </span><span class="s6">1</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s1">tags </span><span class="s2">= {</span><span class="s1">TAGS</span><span class="s2">[</span><span class="s1">k</span><span class="s2">].</span><span class="s1">name</span><span class="s2">: </span><span class="s1">v </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">im</span><span class="s2">.</span><span class="s1">tag_v2</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>
    <span class="s0">assert </span><span class="s1">tags</span><span class="s2">[</span><span class="s3">&quot;ImageDescription&quot;</span><span class="s2">] == </span><span class="s3">&quot;test image&quot;</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_alpha'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_alpha</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">6</span><span class="s2">, </span><span class="s6">6</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">ax3</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imshow_alpha</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">19680801</span><span class="s2">)</span>

    <span class="s1">rgbf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">6</span><span class="s2">, </span><span class="s6">6</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">rgbu </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">(</span><span class="s1">rgbf </span><span class="s2">* </span><span class="s6">255</span><span class="s2">)</span>
    <span class="s2">((</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">), (</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">ax3</span><span class="s2">)) = </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">ax0</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbf</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbf</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.75</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbu</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbu</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.75</span><span class="s2">)</span>

    <span class="s1">rgbaf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">rgbf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">6</span><span class="s2">, </span><span class="s6">6</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))), </span><span class="s1">axis</span><span class="s2">=</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">rgbau </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">rgbu</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">6</span><span class="s2">, </span><span class="s6">6</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s6">255</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s2">((</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">), (</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">ax3</span><span class="s2">)) = </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">rgbaf</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s6">0.5</span>
    <span class="s1">ax0</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbaf</span><span class="s2">)</span>
    <span class="s1">rgbaf</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s6">0.75</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbaf</span><span class="s2">)</span>
    <span class="s1">rgbau</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s6">127</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbau</span><span class="s2">)</span>
    <span class="s1">rgbau</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s6">191</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgbau</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_cursor_data</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s1">MouseEvent</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'upper'</span><span class="s2">)</span>

    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">4</span><span class="s2">, </span><span class="s6">4</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) == </span><span class="s6">44</span>

    <span class="s5"># Now try for a point outside the image</span>
    <span class="s5"># Tests issue #4957</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">10.1</span><span class="s2">, </span><span class="s6">4</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s5"># Hmm, something is wrong here... I get 0, not None...</span>
    <span class="s5"># But, this works further down in the tests with extents flipped</span>
    <span class="s5"># x, y = 0.1, -0.1</span>
    <span class="s5"># xdisp, ydisp = ax.transData.transform([x, y])</span>
    <span class="s5"># event = MouseEvent('motion_notify_event', fig.canvas, xdisp, ydisp)</span>
    <span class="s5"># z = im.get_cursor_data(event)</span>
    <span class="s5"># assert z is None, &quot;Did not get None, got %d&quot; % z</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s5"># Now try with the extents flipped.</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">)</span>

    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">4</span><span class="s2">, </span><span class="s6">4</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) == </span><span class="s6">44</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">])</span>

    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">0.25</span><span class="s2">, </span><span class="s6">0.25</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) == </span><span class="s6">55</span>

    <span class="s5"># Now try for a point outside the image</span>
    <span class="s5"># Tests issue #4957</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">0.75</span><span class="s2">, </span><span class="s6">0.25</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">0.01</span><span class="s2">, -</span><span class="s6">0.01</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s5"># Now try with additional transform applied to the image artist</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s6">2</span><span class="s2">).</span><span class="s1">rotate</span><span class="s2">(</span><span class="s6">0.5</span><span class="s2">)</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">),</span>
                   <span class="s1">transform</span><span class="s2">=</span><span class="s1">trans </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s6">3</span><span class="s2">, </span><span class="s6">10</span>
    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>
    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) == </span><span class="s6">44</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;xy, data&quot;</span><span class="s2">, [</span>
    <span class="s5"># x/y coords chosen to be 0.5 above boundaries so they lie within image pixels</span>
    <span class="s2">[[</span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">], </span><span class="s6">0 </span><span class="s2">+ </span><span class="s6">0</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">1.5</span><span class="s2">], </span><span class="s6">0 </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s6">4.5</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">], </span><span class="s6">16 </span><span class="s2">+ </span><span class="s6">0</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s6">8.5</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">], </span><span class="s6">16 </span><span class="s2">+ </span><span class="s6">0</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s6">9.5</span><span class="s2">, </span><span class="s6">2.5</span><span class="s2">], </span><span class="s6">81 </span><span class="s2">+ </span><span class="s6">4</span><span class="s2">],</span>
    <span class="s2">[[-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">[[</span><span class="s6">0.5</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cursor_data_nonuniform</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s1">MouseEvent</span>

    <span class="s5"># Non-linear set of x-values</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">4</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">16</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">])</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, :]**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]**</span><span class="s6">2</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">NonUniformImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">x</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(), </span><span class="s1">y</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_image</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)</span>
    <span class="s5"># Set lower min lim so we can test cursor outside image</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">min</span><span class="s2">() - </span><span class="s6">2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">max</span><span class="s2">())</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">min</span><span class="s2">() - </span><span class="s6">2</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">())</span>

    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">)</span>
    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) == </span><span class="s1">data</span><span class="s2">, (</span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">), </span><span class="s1">data</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;data, text&quot;</span><span class="s2">, [</span>
        <span class="s2">([[</span><span class="s6">10001</span><span class="s2">, </span><span class="s6">10000</span><span class="s2">]], </span><span class="s3">&quot;[10001.000]&quot;</span><span class="s2">),</span>
        <span class="s2">([[</span><span class="s6">.123</span><span class="s2">, </span><span class="s6">.987</span><span class="s2">]], </span><span class="s3">&quot;[0.123]&quot;</span><span class="s2">),</span>
        <span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]], </span><span class="s3">&quot;[]&quot;</span><span class="s2">),</span>
        <span class="s2">([[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">+</span><span class="s6">1e-15</span><span class="s2">]], </span><span class="s3">&quot;[1.0000000000000000]&quot;</span><span class="s2">),</span>
        <span class="s2">([[-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">]], </span><span class="s3">&quot;[-1.0]&quot;</span><span class="s2">),</span>
        <span class="s2">([[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]], </span><span class="s3">&quot;[0.00]&quot;</span><span class="s2">),</span>
    <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_format_cursor_data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s1">MouseEvent</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">'motion_notify_event'</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">xdisp</span><span class="s2">, </span><span class="s1">ydisp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">format_cursor_data</span><span class="s2">(</span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)) == </span><span class="s1">text</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_clip'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_clip</span><span class="s2">():</span>
    <span class="s1">d </span><span class="s2">= [[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], [</span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">]]</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
    <span class="s1">patch </span><span class="s2">= </span><span class="s1">patches</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">), </span><span class="s1">radius</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_clip_path</span><span class="s2">(</span><span class="s1">patch</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_cliprect'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_cliprect</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">d </span><span class="s2">= [[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], [</span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">]]</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">))</span>

    <span class="s1">rect </span><span class="s2">= </span><span class="s1">patches</span><span class="s2">.</span><span class="s1">Rectangle</span><span class="s2">(</span>
        <span class="s1">xy</span><span class="s2">=(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">width</span><span class="s2">=</span><span class="s6">2</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=</span><span class="s6">2</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">im</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_clip_path</span><span class="s2">(</span><span class="s1">rect</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">&quot;bilinear&quot;</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_imshow_10_10_1</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># 10x10x1 should be the same as 10x10</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[:, :, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">&quot;bilinear&quot;</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">&quot;bilinear&quot;</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imshow_10_10_2</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">200</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imshow_10_10_5</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">500</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">5</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'no_interpolation_origin'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_no_interpolation_origin</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">50</span><span class="s2">)), </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">&quot;lower&quot;</span><span class="s2">,</span>
                  <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">50</span><span class="s2">)), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_shift'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'pdf'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_image_shift</span><span class="s2">():</span>
    <span class="s1">imgData </span><span class="s2">= [[</span><span class="s6">1 </span><span class="s2">/ </span><span class="s1">x </span><span class="s2">+ </span><span class="s6">1 </span><span class="s2">/ </span><span class="s1">y </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)]</span>
    <span class="s1">tMin </span><span class="s2">= </span><span class="s6">734717.945208</span>
    <span class="s1">tMax </span><span class="s2">= </span><span class="s6">734717.946366</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">imgData</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">(), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">,</span>
              <span class="s1">extent</span><span class="s2">=(</span><span class="s1">tMin</span><span class="s2">, </span><span class="s1">tMax</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">100</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s3">'auto'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_image_edges</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">frameon</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12</span><span class="s2">), </span><span class="s6">15</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">20</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'upper'</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[-</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, -</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">],</span>
                   <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'gray'</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s6">2</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([-</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">([-</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xticks</span><span class="s2">([])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yticks</span><span class="s2">([])</span>

    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>

    <span class="s1">buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">im</span><span class="s2">[:, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">im</span><span class="s2">[:, -</span><span class="s6">1</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">g </span><span class="s2">!= </span><span class="s6">100</span><span class="s2">, </span><span class="s3">'Expected a non-green edge - but sadly, it was.'</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_composite_background'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_composite_background</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">15</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">4</span><span class="s2">, </span><span class="s6">6</span><span class="s2">, </span><span class="s6">15</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">((</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">12</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_composite_alpha'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_composite_alpha</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot; 
    Tests that the alpha value is recognized and correctly applied in the 
    process of compositing images together. 
    &quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">11</span><span class="s2">, </span><span class="s6">21</span><span class="s2">, </span><span class="s6">4</span><span class="s2">))</span>
    <span class="s1">arr</span><span class="s2">[:, :, </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">1</span>
    <span class="s1">arr</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.1</span><span class="s2">, </span><span class="s6">0.1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0.1</span><span class="s2">)[::-</span><span class="s6">1</span><span class="s2">]))</span>
    <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">21</span><span class="s2">, </span><span class="s6">11</span><span class="s2">, </span><span class="s6">4</span><span class="s2">))</span>
    <span class="s1">arr2</span><span class="s2">[:, :, </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">1</span>
    <span class="s1">arr2</span><span class="s2">[:, :, </span><span class="s6">1</span><span class="s2">] = </span><span class="s6">1</span>
    <span class="s1">arr2</span><span class="s2">[:, :, </span><span class="s6">3</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.1</span><span class="s2">, </span><span class="s6">0.1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0.1</span><span class="s2">)[::-</span><span class="s6">1</span><span class="s2">]))[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.6</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr2</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr2</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.6</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr2</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0.3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">([</span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;pdf&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_clip_path_disables_compositing</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">fig </span><span class="s0">in </span><span class="s2">[</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">]:</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">clip_path</span><span class="s2">=(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">([(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">), (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)]),</span>
                                <span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">))</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">clip_path</span><span class="s2">=(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">([(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">), (</span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)]),</span>
                                <span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">))</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">suppressComposite </span><span class="s2">= </span><span class="s0">True</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'rasterize_10dpi'</span><span class="s2">],</span>
                  <span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'pdf'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rasterize_dpi</span><span class="s2">():</span>
    <span class="s5"># This test should check rasterized rendering with high output resolution.</span>
    <span class="s5"># It plots a rasterized line and a normal image with imshow.  So it will</span>
    <span class="s5"># catch when images end up in the wrong place in case of non-standard dpi</span>
    <span class="s5"># setting.  Instead of high-res rasterization I use low-res.  Therefore</span>
    <span class="s5"># the fact that the resolution is non-standard is easily checked by</span>
    <span class="s5"># image_comparison.</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], [</span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">]])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">3</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">img</span><span class="s2">)</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s6">20.</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s6">20.</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>

    <span class="s5"># Low-dpi PDF rasterization errors prevent proper image comparison tests.</span>
    <span class="s5"># Hide detailed structures like the axes spines.</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xticks</span><span class="s2">([])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yticks</span><span class="s2">([])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">spines</span><span class="s2">[:].</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'savefig.dpi'</span><span class="s2">] = </span><span class="s6">10</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'bbox_image_inverted'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_bbox_image_inverted</span><span class="s2">():</span>
    <span class="s5"># This is just used to produce an image to feed to BboxImage</span>
    <span class="s1">image </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">bbox_im </span><span class="s2">= </span><span class="s1">BboxImage</span><span class="s2">(</span>
        <span class="s1">TransformedBbox</span><span class="s2">(</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s6">100</span><span class="s2">, </span><span class="s6">100</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]]), </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">),</span>
        <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">bbox_im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
    <span class="s1">bbox_im</span><span class="s2">.</span><span class="s1">set_clip_on</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">bbox_im</span><span class="s2">)</span>

    <span class="s1">image </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s6">10</span><span class="s2">)</span>

    <span class="s1">bbox_im </span><span class="s2">= </span><span class="s1">BboxImage</span><span class="s2">(</span><span class="s1">TransformedBbox</span><span class="s2">(</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s6">0.1</span><span class="s2">, </span><span class="s6">0.2</span><span class="s2">], [</span><span class="s6">0.3</span><span class="s2">, </span><span class="s6">0.25</span><span class="s2">]]),</span>
                                        <span class="s1">ax</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">transFigure</span><span class="s2">),</span>
                        <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">bbox_im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
    <span class="s1">bbox_im</span><span class="s2">.</span><span class="s1">set_clip_on</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">bbox_im</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_window_extent_for_AxisImage</span><span class="s2">():</span>
    <span class="s5"># Create a figure of known size (1000x1000 pixels), place an image</span>
    <span class="s5"># object at a given location and check that get_window_extent()</span>
    <span class="s5"># returns the correct bounding box values (in pixels).</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">0.25</span><span class="s2">, </span><span class="s6">0.75</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">0.75</span><span class="s2">], [</span><span class="s6">0.1</span><span class="s2">, </span><span class="s6">0.65</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">0.4</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s6">0.6</span><span class="s2">, </span><span class="s6">0.3</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.2</span><span class="s2">], [</span><span class="s6">0.7</span><span class="s2">, </span><span class="s6">0.9</span><span class="s2">, </span><span class="s6">0.4</span><span class="s2">, </span><span class="s6">0.6</span><span class="s2">]])</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_position</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">im_obj </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span>
        <span class="s1">im</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0.4</span><span class="s2">, </span><span class="s6">0.7</span><span class="s2">, </span><span class="s6">0.2</span><span class="s2">, </span><span class="s6">0.9</span><span class="s2">], </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">renderer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span>
    <span class="s1">im_bbox </span><span class="s2">= </span><span class="s1">im_obj</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">im_bbox</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), [[</span><span class="s6">400</span><span class="s2">, </span><span class="s6">200</span><span class="s2">], [</span><span class="s6">700</span><span class="s2">, </span><span class="s6">900</span><span class="s2">]])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_position</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">im_obj </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span>
        <span class="s1">im</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0.4</span><span class="s2">, </span><span class="s6">0.7</span><span class="s2">, </span><span class="s6">0.2</span><span class="s2">, </span><span class="s6">0.9</span><span class="s2">], </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">,</span>
        <span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">renderer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span>
    <span class="s1">im_bbox </span><span class="s2">= </span><span class="s1">im_obj</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">im_bbox</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), [[</span><span class="s6">400</span><span class="s2">, </span><span class="s6">200</span><span class="s2">], [</span><span class="s6">700</span><span class="s2">, </span><span class="s6">900</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'zoom_and_clip_upper_origin.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_zoom_and_clip_upper_origin</span><span class="s2">():</span>
    <span class="s1">image </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">image </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">2.0</span><span class="s2">, -</span><span class="s6">0.5</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">2.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nonuniformimage_setcmap</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">NonUniformImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_cmap</span><span class="s2">(</span><span class="s3">'Blues'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nonuniformimage_setnorm</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">NonUniformImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_norm</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_jpeg_2d</span><span class="s2">():</span>
    <span class="s5"># smoke test that mode-L pillow images work.</span>
    <span class="s1">imd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'uint8'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">10</span><span class="s2">):</span>
        <span class="s1">imd</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, :] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">) * </span><span class="s6">255</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">new</span><span class="s2">(</span><span class="s3">'L'</span><span class="s2">, (</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">putdata</span><span class="s2">(</span><span class="s1">imd</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">())</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_jpeg_alpha</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">300</span><span class="s2">)</span>
    <span class="s5"># Create an image that is all black, with a gradient from 0-1 in</span>
    <span class="s5"># the alpha channel from left to right.</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">300</span><span class="s2">, </span><span class="s6">300</span><span class="s2">, </span><span class="s6">4</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">[..., </span><span class="s6">3</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">300</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figimage</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)</span>

    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s3">&quot;red&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'jpg'</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">300</span><span class="s2">)</span>

    <span class="s1">buff</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">image </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">)</span>

    <span class="s5"># If this fails, there will be only one color (all black). If this</span>
    <span class="s5"># is working, we should have all 256 shades of grey represented.</span>
    <span class="s1">num_colors </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">image</span><span class="s2">.</span><span class="s1">getcolors</span><span class="s2">(</span><span class="s6">256</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s6">175 </span><span class="s2">&lt;= </span><span class="s1">num_colors </span><span class="s2">&lt;= </span><span class="s6">210</span>
    <span class="s5"># The fully transparent part should be red.</span>
    <span class="s1">corner_pixel </span><span class="s2">= </span><span class="s1">image</span><span class="s2">.</span><span class="s1">getpixel</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">corner_pixel </span><span class="s2">== (</span><span class="s6">254</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_axesimage_setdata</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">AxesImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">9.9</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">_A</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] == </span><span class="s6">0</span><span class="s2">, </span><span class="s3">'value changed'</span>


<span class="s0">def </span><span class="s1">test_figureimage_setdata</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">FigureImage</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">9.9</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">_A</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] == </span><span class="s6">0</span><span class="s2">, </span><span class="s3">'value changed'</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;image_cls,x,y,a&quot;</span><span class="s2">, [</span>
        <span class="s2">(</span><span class="s1">NonUniformImage</span><span class="s2">,</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">3.</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">4.</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12.</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))),</span>
        <span class="s2">(</span><span class="s1">PcolorImage</span><span class="s2">,</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">3.</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">4.</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">6.</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))),</span>
    <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_setdata_xya</span><span class="s2">(</span><span class="s1">image_cls</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">image_cls</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">9.9</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">_A</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] == </span><span class="s1">im</span><span class="s2">.</span><span class="s1">_Ax</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] == </span><span class="s1">im</span><span class="s2">.</span><span class="s1">_Ay</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] == </span><span class="s6">0</span><span class="s2">, </span><span class="s3">'value changed'</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((*</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)))  </span><span class="s5"># Just a smoketest.</span>


<span class="s0">def </span><span class="s1">test_minimized_rasterized</span><span class="s2">():</span>
    <span class="s5"># This ensures that the rasterized content in the colorbars is</span>
    <span class="s5"># only as thick as the colorbar, and doesn't extend to other parts</span>
    <span class="s5"># of the image.  See #5814.  While the original bug exists only</span>
    <span class="s5"># in Postscript, the best way to detect it is to generate SVG</span>
    <span class="s5"># and then parse the output to make sure the two colorbar images</span>
    <span class="s5"># are the same size.</span>
    <span class="s0">from </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree </span><span class="s0">import </span><span class="s1">ElementTree</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">p1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">p2 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">p1</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">p2</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'svg'</span><span class="s2">)</span>

    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">())</span>
    <span class="s1">tree </span><span class="s2">= </span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">)</span>
    <span class="s1">width </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">for </span><span class="s1">image </span><span class="s0">in </span><span class="s1">tree</span><span class="s2">.</span><span class="s1">iter</span><span class="s2">(</span><span class="s3">'image'</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">width </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">width </span><span class="s2">= </span><span class="s1">image</span><span class="s2">[</span><span class="s3">'width'</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">image</span><span class="s2">[</span><span class="s3">'width'</span><span class="s2">] != </span><span class="s1">width</span><span class="s2">:</span>
                <span class="s0">assert False</span>


<span class="s0">def </span><span class="s1">test_load_from_url</span><span class="s2">():</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s3">&quot;baseline_images/pngsuite/basn3p04.png&quot;</span>
    <span class="s1">url </span><span class="s2">= (</span><span class="s3">'file:'</span>
           <span class="s2">+ (</span><span class="s3">'///' </span><span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win32' </span><span class="s0">else </span><span class="s3">''</span><span class="s2">)</span>
           <span class="s2">+ </span><span class="s1">path</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">().</span><span class="s1">as_posix</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Please open the URL&quot;</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">url</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request</span><span class="s2">.</span><span class="s1">urlopen</span><span class="s2">(</span><span class="s1">url</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'log_scale_image'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_log_scale_image</span><span class="s2">():</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>
    <span class="s1">Z</span><span class="s2">[::</span><span class="s6">2</span><span class="s2">] = </span><span class="s6">1</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">100</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">100</span><span class="s2">], </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'viridis'</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1</span><span class="s2">,</span>
              <span class="s1">aspect</span><span class="s2">=</span><span class="s3">'auto'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">yscale</span><span class="s2">=</span><span class="s3">'log'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'rotate_image'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rotate_image</span><span class="s2">():</span>
    <span class="s1">delta </span><span class="s2">= </span><span class="s6">0.25</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s6">3.0</span><span class="s2">, </span><span class="s6">3.0</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">Z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s1">X</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">Y</span><span class="s2">**</span><span class="s6">2</span><span class="s2">) / </span><span class="s6">2</span><span class="s2">) / (</span><span class="s6">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
    <span class="s1">Z2 </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(((</span><span class="s1">X </span><span class="s2">- </span><span class="s6">1</span><span class="s2">) / </span><span class="s6">1.5</span><span class="s2">)**</span><span class="s6">2 </span><span class="s2">+ ((</span><span class="s1">Y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">) / </span><span class="s6">0.5</span><span class="s2">)**</span><span class="s6">2</span><span class="s2">) / </span><span class="s6">2</span><span class="s2">) /</span>
          <span class="s2">(</span><span class="s6">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s6">0.5 </span><span class="s2">* </span><span class="s6">1.5</span><span class="s2">))</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">Z2 </span><span class="s2">- </span><span class="s1">Z1  </span><span class="s5"># difference of Gaussians</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">im1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'viridis'</span><span class="s2">,</span>
                     <span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">,</span>
                     <span class="s1">extent</span><span class="s2">=[-</span><span class="s6">2</span><span class="s2">, </span><span class="s6">4</span><span class="s2">, -</span><span class="s6">3</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s1">clip_on</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">trans_data2 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s6">30</span><span class="s2">) + </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">transData</span>
    <span class="s1">im1</span><span class="s2">.</span><span class="s1">set_transform</span><span class="s2">(</span><span class="s1">trans_data2</span><span class="s2">)</span>

    <span class="s5"># display intended extent of the image</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">im1</span><span class="s2">.</span><span class="s1">get_extent</span><span class="s2">()</span>

    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">], [</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">], </span><span class="s3">&quot;r--&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s6">3</span><span class="s2">,</span>
             <span class="s1">transform</span><span class="s2">=</span><span class="s1">trans_data2</span><span class="s2">)</span>

    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_image_preserve_size</span><span class="s2">():</span>
    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">481</span><span class="s2">, </span><span class="s6">321</span><span class="s2">))</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imsave</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">im</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">)</span>

    <span class="s1">buff</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] == </span><span class="s1">im</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_image_preserve_size2</span><span class="s2">():</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s6">7</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">frameon</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">((</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">'auto'</span><span class="s2">)</span>
    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">buff</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s6">7</span><span class="s2">, </span><span class="s6">7</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">img</span><span class="s2">[:, :, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">bool</span><span class="s2">),</span>
                       <span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">)[::-</span><span class="s6">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'mask_image_over_under.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s6">1.0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mask_image_over_under</span><span class="s2">():</span>
    <span class="s5"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'pcolormesh.snap'</span><span class="s2">] = </span><span class="s0">False</span>

    <span class="s1">delta </span><span class="s2">= </span><span class="s6">0.025</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s6">3.0</span><span class="s2">, </span><span class="s6">3.0</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">Z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s1">X</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">Y</span><span class="s2">**</span><span class="s6">2</span><span class="s2">) / </span><span class="s6">2</span><span class="s2">) / (</span><span class="s6">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
    <span class="s1">Z2 </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(((</span><span class="s1">X </span><span class="s2">- </span><span class="s6">1</span><span class="s2">) / </span><span class="s6">1.5</span><span class="s2">)**</span><span class="s6">2 </span><span class="s2">+ ((</span><span class="s1">Y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">) / </span><span class="s6">0.5</span><span class="s2">)**</span><span class="s6">2</span><span class="s2">) / </span><span class="s6">2</span><span class="s2">) /</span>
          <span class="s2">(</span><span class="s6">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s6">0.5 </span><span class="s2">* </span><span class="s6">1.5</span><span class="s2">))</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s6">10</span><span class="s2">*(</span><span class="s1">Z2 </span><span class="s2">- </span><span class="s1">Z1</span><span class="s2">)  </span><span class="s5"># difference of Gaussians</span>

    <span class="s1">palette </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">gray</span><span class="s2">.</span><span class="s1">with_extremes</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">under</span><span class="s2">=</span><span class="s3">'g'</span><span class="s2">, </span><span class="s1">bad</span><span class="s2">=</span><span class="s3">'b'</span><span class="s2">)</span>
    <span class="s1">Zm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_where</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">&gt; </span><span class="s6">1.2</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Zm</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'bilinear'</span><span class="s2">,</span>
                    <span class="s1">cmap</span><span class="s2">=</span><span class="s1">palette</span><span class="s2">,</span>
                    <span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">clip</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
                    <span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[-</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, -</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">])</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Green=low, Red=high, Blue=bad'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">extend</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">=</span><span class="s3">'horizontal'</span><span class="s2">,</span>
                 <span class="s1">ax</span><span class="s2">=</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s6">10</span><span class="s2">)</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Zm</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">,</span>
                    <span class="s1">cmap</span><span class="s2">=</span><span class="s1">palette</span><span class="s2">,</span>
                    <span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">BoundaryNorm</span><span class="s2">([-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">0.5</span><span class="s2">, -</span><span class="s6">0.2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0.2</span><span class="s2">, </span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">1</span><span class="s2">],</span>
                                             <span class="s1">ncolors</span><span class="s2">=</span><span class="s6">256</span><span class="s2">, </span><span class="s1">clip</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
                    <span class="s1">origin</span><span class="s2">=</span><span class="s3">'lower'</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[-</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, -</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">])</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'With BoundaryNorm'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">extend</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">, </span><span class="s1">spacing</span><span class="s2">=</span><span class="s3">'proportional'</span><span class="s2">,</span>
                 <span class="s1">orientation</span><span class="s2">=</span><span class="s3">'horizontal'</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s6">10</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'mask_image'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mask_image</span><span class="s2">():</span>
    <span class="s5"># Test mask image two ways: Using nans and using a masked array.</span>

    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">))</span>
    <span class="s1">A</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">:</span><span class="s6">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">A</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">:</span><span class="s6">2</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">), </span><span class="s1">A</span><span class="s2">)</span>

    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mask_image_all</span><span class="s2">():</span>
    <span class="s5"># Test behavior with an image that is entirely masked does not warn</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw_idle</span><span class="s2">()  </span><span class="s5"># would emit a warning</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow_endianess.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow_endianess</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">10</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">X </span><span class="s2">- </span><span class="s6">5</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">- </span><span class="s6">5</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)</span>

    <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">=</span><span class="s3">&quot;lower&quot;</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'viridis'</span><span class="s2">)</span>

    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'&lt;f8'</span><span class="s2">), **</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'&gt;f8'</span><span class="s2">), **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow_masked_interpolation'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s6">0 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'x86_64' </span><span class="s0">else </span><span class="s6">0.01</span><span class="s2">,</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow_masked_interpolation</span><span class="s2">():</span>

    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">'viridis'</span><span class="s2">].</span><span class="s1">with_extremes</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">under</span><span class="s2">=</span><span class="s3">'b'</span><span class="s2">, </span><span class="s1">bad</span><span class="s2">=</span><span class="s3">'k'</span><span class="s2">)</span>

    <span class="s1">N </span><span class="s2">= </span><span class="s6">20</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s1">N</span><span class="s2">*</span><span class="s1">N</span><span class="s2">-</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">*</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>

    <span class="s1">data</span><span class="s2">[</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">] = -</span><span class="s6">1</span>
    <span class="s5"># This will cause crazy ringing for the higher-order</span>
    <span class="s5"># interpolations</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s6">15</span><span class="s2">, </span><span class="s6">5</span><span class="s2">] = </span><span class="s6">1e5</span>

    <span class="s5"># data[3, 3] = np.nan</span>

    <span class="s1">data</span><span class="s2">[</span><span class="s6">15</span><span class="s2">, </span><span class="s6">15</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>

    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'bool'</span><span class="s2">)</span>
    <span class="s1">mask</span><span class="s2">[</span><span class="s6">5</span><span class="s2">, </span><span class="s6">15</span><span class="s2">] = </span><span class="s0">True</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax_grid </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">3</span><span class="s2">, </span><span class="s6">6</span><span class="s2">)</span>
    <span class="s1">interps </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">mimage</span><span class="s2">.</span><span class="s1">_interpd_</span><span class="s2">)</span>
    <span class="s1">interps</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s3">'antialiased'</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">interp</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">interps</span><span class="s2">, </span><span class="s1">ax_grid</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">n</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s1">interp</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">(</span><span class="s3">'off'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imshow_no_warn_invalid</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], [</span><span class="s6">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]])  </span><span class="s5"># Check that no warning is emitted.</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s3">'u2 u4 i2 i4 i8 f4 f8'</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()])</span>
<span class="s0">def </span><span class="s1">test_imshow_clips_rgb_to_valid_range</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">300</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">!= </span><span class="s3">'u'</span><span class="s2">:</span>
        <span class="s1">arr </span><span class="s2">-= </span><span class="s6">10</span>
    <span class="s1">too_low </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">&lt; </span><span class="s6">0</span>
    <span class="s1">too_high </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">&gt; </span><span class="s6">255</span>
    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">'f'</span><span class="s2">:</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">/ </span><span class="s6">255</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">).</span><span class="s1">get_array</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s1">too_low</span><span class="s2">] == </span><span class="s6">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">'f'</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s1">too_high</span><span class="s2">] == </span><span class="s6">1</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">'f'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s1">too_high</span><span class="s2">] == </span><span class="s6">255</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow_flatfield.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow_flatfield</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_clim</span><span class="s2">(</span><span class="s6">.5</span><span class="s2">, </span><span class="s6">1.5</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow_bignumbers.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow_bignumbers</span><span class="s2">():</span>
    <span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'image.interpolation'</span><span class="s2">] = </span><span class="s3">'nearest'</span>
    <span class="s5"># putting a big number in an array of integers shouldn't</span>
    <span class="s5"># ruin the dynamic range of the resolved bits.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1e12</span><span class="s2">], [</span><span class="s6">3</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">img</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_clim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'imshow_bignumbers_real.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_imshow_bignumbers_real</span><span class="s2">():</span>
    <span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'image.interpolation'</span><span class="s2">] = </span><span class="s3">'nearest'</span>
    <span class="s5"># putting a big number in an array of integers shouldn't</span>
    <span class="s5"># ruin the dynamic range of the resolved bits.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">2.</span><span class="s2">, </span><span class="s6">1.</span><span class="s2">, </span><span class="s6">1.e22</span><span class="s2">], [</span><span class="s6">4.</span><span class="s2">, </span><span class="s6">1.</span><span class="s2">, </span><span class="s6">3.</span><span class="s2">]])</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">img</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_clim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;make_norm&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">,</span>
     <span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">,</span>
     <span class="s0">lambda</span><span class="s2">: </span><span class="s1">colors</span><span class="s2">.</span><span class="s1">SymLogNorm</span><span class="s2">(</span><span class="s6">1</span><span class="s2">),</span>
     <span class="s0">lambda</span><span class="s2">: </span><span class="s1">colors</span><span class="s2">.</span><span class="s1">PowerNorm</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_empty_imshow</span><span class="s2">(</span><span class="s1">make_norm</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Attempting to set identical low and high xlims&quot;</span><span class="s2">):</span>
        <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[]], </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">make_norm</span><span class="s2">())</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_extent</span><span class="s2">([-</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, -</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
        <span class="s1">im</span><span class="s2">.</span><span class="s1">make_image</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_imshow_float16</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">))</span>
    <span class="s5"># Ensure that drawing doesn't cause crash.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_imshow_float128</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s2">(</span><span class="s1">ExitStack</span><span class="s2">() </span><span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">can_cast</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">&quot;equiv&quot;</span><span class="s2">)</span>
          <span class="s0">else </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)):</span>
        <span class="s5"># Ensure that drawing doesn't cause crash.</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_imshow_bool</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_full_invalid</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;fmt,counted&quot;</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s3">&quot;ps&quot;</span><span class="s2">, </span><span class="s7">b&quot; colorimage&quot;</span><span class="s2">), (</span><span class="s3">&quot;svg&quot;</span><span class="s2">, </span><span class="s7">b&quot;&lt;image&quot;</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;composite_image,count&quot;</span><span class="s2">, [(</span><span class="s0">True</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_composite</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">counted</span><span class="s2">, </span><span class="s1">composite_image</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
    <span class="s5"># Test that figures can be saved with and without combining multiple images</span>
    <span class="s5"># (on a single set of axes) into a single composite image.</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">Y </span><span class="s2">** </span><span class="s6">2</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">[::-</span><span class="s6">1</span><span class="s2">], </span><span class="s1">extent</span><span class="s2">=[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'image.composite_image'</span><span class="s2">] = </span><span class="s1">composite_image</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">count</span><span class="s2">(</span><span class="s1">counted</span><span class="s2">) == </span><span class="s1">count</span>


<span class="s0">def </span><span class="s1">test_relim</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s6">0</span><span class="s2">]], </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">relim</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">autoscale</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unclipped</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]], </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(-</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, -</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">),</span>
                   <span class="s1">cmap</span><span class="s2">=</span><span class="s3">'gray'</span><span class="s2">, </span><span class="s1">clip_on</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s5"># The unclipped image should fill the *entire* figure and be black.</span>
    <span class="s5"># Ignore alpha for this comparison.</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">buffer_rgba</span><span class="s2">())[..., :</span><span class="s6">3</span><span class="s2">] == </span><span class="s6">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_respects_bbox</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">]], </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_clip_path</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s5"># Make the image invisible in axs[1], but visible in axs[0] if we pan</span>
    <span class="s5"># axs[1] up.</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_clip_box</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">)</span>
    <span class="s1">buf_before </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf_before</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;rgba&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">{*</span><span class="s1">buf_before</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()} == {</span><span class="s6">0xff</span><span class="s2">}  </span><span class="s5"># All white.</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">set</span><span class="s2">(</span><span class="s1">ylim</span><span class="s2">=(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>
    <span class="s1">buf_after </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf_after</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;rgba&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">buf_before</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">() != </span><span class="s1">buf_after</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()  </span><span class="s5"># Not all white.</span>


<span class="s0">def </span><span class="s1">test_image_cursor_formatting</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s5"># Create a dummy image to be able to call format_cursor_data</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">4</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)))</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">format_cursor_data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) == </span><span class="s3">'[]'</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">format_cursor_data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) == </span><span class="s3">'[0]'</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">format_cursor_data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) == </span><span class="s3">'[nan]'</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_image_array_alpha</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Per-pixel alpha channel test.&quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">xx</span><span class="s2">, </span><span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>

    <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(- </span><span class="s6">3 </span><span class="s2">* ((</span><span class="s1">xx </span><span class="s2">- </span><span class="s6">0.5</span><span class="s2">) ** </span><span class="s6">2</span><span class="s2">) + (</span><span class="s1">yy </span><span class="s2">- </span><span class="s6">0.7 </span><span class="s2">** </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">zz </span><span class="s2">/ </span><span class="s1">zz</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>

    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">'viridis'</span><span class="s2">]</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">zz</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">rgba </span><span class="s2">= </span><span class="s1">cmap</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">()(</span><span class="s1">zz</span><span class="s2">))</span>
    <span class="s1">rgba</span><span class="s2">[..., -</span><span class="s6">1</span><span class="s2">] = </span><span class="s1">alpha</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">rgba</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_image_array_alpha_validation</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;alpha must be a float, two-d&quot;</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)), </span><span class="s1">alpha</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_exact_vmin</span><span class="s2">():</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">&quot;autumn_r&quot;</span><span class="s2">])</span>
    <span class="s1">cmap</span><span class="s2">.</span><span class="s1">set_under</span><span class="s2">(</span><span class="s1">color</span><span class="s2">=</span><span class="s3">&quot;lightgrey&quot;</span><span class="s2">)</span>

    <span class="s5"># make the image exactly 190 pixels wide</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">1.9</span><span class="s2">, </span><span class="s6">0.1</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">43</span><span class="s2">, </span><span class="s6">79</span><span class="s2">, </span><span class="s6">95</span><span class="s2">, </span><span class="s6">66</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">34</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">(</span><span class="s3">&quot;off&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s5"># get the RGBA slice from the image</span>
    <span class="s1">from_image </span><span class="s2">= </span><span class="s1">im</span><span class="s2">.</span><span class="s1">make_image</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
    <span class="s5"># expand the input to be 190 long and run through norm / cmap</span>
    <span class="s1">direct_computation </span><span class="s2">= (</span>
        <span class="s1">im</span><span class="s2">.</span><span class="s1">cmap</span><span class="s2">(</span><span class="s1">im</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">((</span><span class="s1">data </span><span class="s2">* ([[</span><span class="s6">1</span><span class="s2">]] * </span><span class="s6">10</span><span class="s2">)).</span><span class="s1">T</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())) * </span><span class="s6">255</span>
    <span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s5"># check than the RBGA values are the same</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">from_image </span><span class="s2">== </span><span class="s1">direct_computation</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'image_placement'</span><span class="s2">], </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'svg'</span><span class="s2">, </span><span class="s3">'pdf'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_image_placement</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot; 
    The red box should line up exactly with the outside of the image. 
    &quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s6">0.1</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s6">19680801</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s6">16</span><span class="s2">, </span><span class="s6">16</span><span class="s2">), </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'Blues'</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">),</span>
              <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s6">0.1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">+</span><span class="s6">0.1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s6">0.1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">+</span><span class="s6">0.1</span><span class="s2">)</span>


<span class="s5"># A basic ndarray subclass that implements a quantity</span>
<span class="s5"># It does not implement an entire unit system or all quantity math.</span>
<span class="s5"># There is just enough implemented to test handling of ndarray</span>
<span class="s5"># subclasses.</span>
<span class="s0">class </span><span class="s1">QuantityND</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">units</span><span class="s2">):</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s1">obj</span><span class="s2">.</span><span class="s1">units </span><span class="s2">= </span><span class="s1">units</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">__array_finalize__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">units </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;units&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s1">units </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">&quot;units&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s1">QuantityND</span><span class="s2">) </span><span class="s0">or </span><span class="s1">units </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">QuantityND</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s1">units</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ret</span>

    <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s3">&quot;out&quot; </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">NotImplemented</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">) == </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">i0 </span><span class="s2">= </span><span class="s1">inputs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">unit </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">i0</span><span class="s2">, </span><span class="s3">&quot;units&quot;</span><span class="s2">, </span><span class="s3">&quot;dimensionless&quot;</span><span class="s2">)</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">i0</span><span class="s2">), **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">) == </span><span class="s6">2</span><span class="s2">:</span>
            <span class="s1">i0 </span><span class="s2">= </span><span class="s1">inputs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">i1 </span><span class="s2">= </span><span class="s1">inputs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
            <span class="s1">u0 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">i0</span><span class="s2">, </span><span class="s3">&quot;units&quot;</span><span class="s2">, </span><span class="s3">&quot;dimensionless&quot;</span><span class="s2">)</span>
            <span class="s1">u1 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">i1</span><span class="s2">, </span><span class="s3">&quot;units&quot;</span><span class="s2">, </span><span class="s3">&quot;dimensionless&quot;</span><span class="s2">)</span>
            <span class="s1">u0 </span><span class="s2">= </span><span class="s1">u1 </span><span class="s0">if </span><span class="s1">u0 </span><span class="s0">is None else </span><span class="s1">u0</span>
            <span class="s1">u1 </span><span class="s2">= </span><span class="s1">u0 </span><span class="s0">if </span><span class="s1">u1 </span><span class="s0">is None else </span><span class="s1">u1</span>
            <span class="s0">if </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">u0 </span><span class="s2">!= </span><span class="s1">u1</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span>
                <span class="s1">unit </span><span class="s2">= </span><span class="s1">u0</span>
            <span class="s0">elif </span><span class="s1">ufunc </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">:</span>
                <span class="s1">unit </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">u0</span><span class="s0">}</span><span class="s3">*</span><span class="s0">{</span><span class="s1">u1</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s0">elif </span><span class="s1">ufunc </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divide</span><span class="s2">:</span>
                <span class="s1">unit </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">u0</span><span class="s0">}</span><span class="s3">/(</span><span class="s0">{</span><span class="s1">u1</span><span class="s0">}</span><span class="s3">)&quot;</span>
            <span class="s0">elif </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">,</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">,</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">):</span>
                <span class="s5"># Comparisons produce unitless booleans for output</span>
                <span class="s1">unit </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">i0</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">), </span><span class="s1">i1</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">), **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">NotImplemented</span>
        <span class="s0">if </span><span class="s1">unit </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out_arr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">QuantityND</span><span class="s2">(</span><span class="s1">out_arr</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">out_arr</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">v</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_quantitynd</span><span class="s2">():</span>
    <span class="s1">q </span><span class="s2">= </span><span class="s1">QuantityND</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s3">&quot;m&quot;</span><span class="s2">)</span>
    <span class="s1">q0</span><span class="s2">, </span><span class="s1">q1 </span><span class="s2">= </span><span class="s1">q</span><span class="s2">[:]</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">v </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">q</span><span class="s2">.</span><span class="s1">units </span><span class="s2">== </span><span class="s3">&quot;m&quot;</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">((</span><span class="s1">q0 </span><span class="s2">+ </span><span class="s1">q1</span><span class="s2">).</span><span class="s1">v </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s6">3</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">q0 </span><span class="s2">* </span><span class="s1">q1</span><span class="s2">).</span><span class="s1">units </span><span class="s2">== </span><span class="s3">&quot;m*m&quot;</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">q1 </span><span class="s2">/ </span><span class="s1">q0</span><span class="s2">).</span><span class="s1">units </span><span class="s2">== </span><span class="s3">&quot;m/(m)&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">q0 </span><span class="s2">+ </span><span class="s1">QuantityND</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_imshow_quantitynd</span><span class="s2">():</span>
    <span class="s5"># generate a dummy ndarray subclass</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">QuantityND</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">)), </span><span class="s3">&quot;m&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s5"># executing the draw should not raise an exception</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_norm_change</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># LogNorm should not mask anything invalid permanently.</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s6">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, :] = -</span><span class="s6">1</span>

    <span class="s1">masked_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">masked_data</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">[</span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">] = </span><span class="s0">True</span>

    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">'viridis'</span><span class="s2">].</span><span class="s1">with_extremes</span><span class="s2">(</span><span class="s1">under</span><span class="s2">=</span><span class="s3">'w'</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">),</span>
                   <span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_norm</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">masked_data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0.5</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">),</span>
                   <span class="s1">extent</span><span class="s2">=(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">)</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_norm</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">2</span><span class="s2">),</span>
              <span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">masked_data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">2</span><span class="s2">),</span>
              <span class="s1">extent</span><span class="s2">=(</span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'x'</span><span class="s2">, [-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_huge_range_log</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s5"># parametrize over bad lognorm -1 values and large range 1 -&gt; 1e20</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, :] = </span><span class="s6">1E20</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()),</span>
              <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'viridis'</span><span class="s2">)</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s6">5</span><span class="s2">, </span><span class="s6">5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">:</span><span class="s6">2</span><span class="s2">, :] = </span><span class="s6">1000</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">'viridis'</span><span class="s2">].</span><span class="s1">with_extremes</span><span class="s2">(</span><span class="s1">under</span><span class="s2">=</span><span class="s3">'w'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()),</span>
              <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_spy_box</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># setting up reference and test</span>
    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>

    <span class="s1">plot_data </span><span class="s2">= (</span>
        <span class="s2">[[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]],</span>
    <span class="s2">)</span>
    <span class="s1">plot_titles </span><span class="s2">= [</span><span class="s3">&quot;ones&quot;</span><span class="s2">, </span><span class="s3">&quot;zeros&quot;</span><span class="s2">, </span><span class="s3">&quot;mixed&quot;</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">z</span><span class="s2">, </span><span class="s1">title</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">plot_data</span><span class="s2">, </span><span class="s1">plot_titles</span><span class="s2">)):</span>
        <span class="s1">ax_test</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">title</span><span class="s2">)</span>
        <span class="s1">ax_test</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">spy</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">title</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">,</span>
                            <span class="s1">aspect</span><span class="s2">=</span><span class="s3">'equal'</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s3">'upper'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">'Greys'</span><span class="s2">,</span>
                            <span class="s1">vmin</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s6">0.5</span><span class="s2">, </span><span class="s6">1.5</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s6">1.5</span><span class="s2">, -</span><span class="s6">0.5</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">tick_top</span><span class="s2">()</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">title</span><span class="s2">.</span><span class="s1">set_y</span><span class="s2">(</span><span class="s6">1.05</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_ticks_position</span><span class="s2">(</span><span class="s3">'both'</span><span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_major_locator</span><span class="s2">(</span>
            <span class="s1">mticker</span><span class="s2">.</span><span class="s1">MaxNLocator</span><span class="s2">(</span><span class="s1">nbins</span><span class="s2">=</span><span class="s6">9</span><span class="s2">, </span><span class="s1">steps</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">], </span><span class="s1">integer</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">ax_ref</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_major_locator</span><span class="s2">(</span>
            <span class="s1">mticker</span><span class="s2">.</span><span class="s1">MaxNLocator</span><span class="s2">(</span><span class="s1">nbins</span><span class="s2">=</span><span class="s6">9</span><span class="s2">, </span><span class="s1">steps</span><span class="s2">=[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">5</span><span class="s2">, </span><span class="s6">10</span><span class="s2">], </span><span class="s1">integer</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">&quot;nonuniform_and_pcolor.png&quot;</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;mpl20&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nonuniform_and_pcolor</span><span class="s2">():</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)).</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">3</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax</span><span class="s2">, </span><span class="s1">interpolation </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">, [</span><span class="s3">&quot;nearest&quot;</span><span class="s2">, </span><span class="s3">&quot;bilinear&quot;</span><span class="s2">]):</span>
        <span class="s1">im </span><span class="s2">= </span><span class="s1">NonUniformImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s1">interpolation</span><span class="s2">)</span>
        <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">3</span><span class="s2">) ** </span><span class="s6">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">3</span><span class="s2">) ** </span><span class="s6">2</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)))</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_image</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">pcolorfast</span><span class="s2">(  </span><span class="s5"># PcolorImage</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">4</span><span class="s2">) ** </span><span class="s6">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">4</span><span class="s2">) ** </span><span class="s6">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">3</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)))</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
        <span class="s5"># NonUniformImage &quot;leaks&quot; out of extents, not PColorImage.</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">10</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">'rgba_antialias.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">, </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">tol</span><span class="s2">=</span><span class="s6">0 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'x86_64' </span><span class="s0">else </span><span class="s6">0.007</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rgba_antialias</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s6">3.5</span><span class="s2">, </span><span class="s6">3.5</span><span class="s2">), </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                            <span class="s1">sharey</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s6">250</span>
    <span class="s1">aa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">))</span>
    <span class="s1">aa</span><span class="s2">[::</span><span class="s6">2</span><span class="s2">, :] = -</span><span class="s6">1</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">) / </span><span class="s1">N </span><span class="s2">- </span><span class="s6">0.5</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">) / </span><span class="s1">N </span><span class="s2">- </span><span class="s6">0.5</span>

    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">R </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">X</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">Y</span><span class="s2">**</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s1">f0 </span><span class="s2">= </span><span class="s6">10</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s6">75</span>
    <span class="s5"># aliased concentric circles</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s6">2 </span><span class="s2">* (</span><span class="s1">f0 </span><span class="s2">* </span><span class="s1">R </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">* </span><span class="s1">R</span><span class="s2">**</span><span class="s6">2 </span><span class="s2">/ </span><span class="s6">2</span><span class="s2">))</span>

    <span class="s5"># stripes on lhs</span>
    <span class="s1">a</span><span class="s2">[:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">), :][</span><span class="s1">R</span><span class="s2">[:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">), :] &lt; </span><span class="s6">0.4</span><span class="s2">] = -</span><span class="s6">1</span>
    <span class="s1">a</span><span class="s2">[:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">), :][</span><span class="s1">R</span><span class="s2">[:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">), :] &lt; </span><span class="s6">0.3</span><span class="s2">] = </span><span class="s6">1</span>
    <span class="s1">aa</span><span class="s2">[:, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">):] = </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">):]</span>

    <span class="s5"># set some over/unders and NaNs</span>
    <span class="s1">aa</span><span class="s2">[</span><span class="s6">20</span><span class="s2">:</span><span class="s6">50</span><span class="s2">, </span><span class="s6">20</span><span class="s2">:</span><span class="s6">50</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s1">aa</span><span class="s2">[</span><span class="s6">70</span><span class="s2">:</span><span class="s6">90</span><span class="s2">, </span><span class="s6">70</span><span class="s2">:</span><span class="s6">90</span><span class="s2">] = </span><span class="s6">1e6</span>
    <span class="s1">aa</span><span class="s2">[</span><span class="s6">70</span><span class="s2">:</span><span class="s6">90</span><span class="s2">, </span><span class="s6">20</span><span class="s2">:</span><span class="s6">30</span><span class="s2">] = -</span><span class="s6">1e6</span>
    <span class="s1">aa</span><span class="s2">[</span><span class="s6">70</span><span class="s2">:</span><span class="s6">90</span><span class="s2">, </span><span class="s6">195</span><span class="s2">:</span><span class="s6">215</span><span class="s2">] = </span><span class="s6">1e6</span>
    <span class="s1">aa</span><span class="s2">[</span><span class="s6">20</span><span class="s2">:</span><span class="s6">30</span><span class="s2">, </span><span class="s6">195</span><span class="s2">:</span><span class="s6">215</span><span class="s2">] = -</span><span class="s6">1e6</span>

    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">RdBu_r</span><span class="s2">)</span>
    <span class="s1">cmap</span><span class="s2">.</span><span class="s1">set_over</span><span class="s2">(</span><span class="s3">'yellow'</span><span class="s2">)</span>
    <span class="s1">cmap</span><span class="s2">.</span><span class="s1">set_under</span><span class="s2">(</span><span class="s3">'cyan'</span><span class="s2">)</span>

    <span class="s1">axs </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s5"># zoom in</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1.2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1.2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">set_xlim</span><span class="s2">([</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">-</span><span class="s6">25</span><span class="s2">, </span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">+</span><span class="s6">25</span><span class="s2">])</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">set_ylim</span><span class="s2">([</span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">+</span><span class="s6">50</span><span class="s2">, </span><span class="s1">N</span><span class="s2">/</span><span class="s6">2</span><span class="s2">-</span><span class="s6">10</span><span class="s2">])</span>

    <span class="s5"># no anti-alias</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'nearest'</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1.2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1.2</span><span class="s2">)</span>

    <span class="s5"># data antialias: Note no purples, and white in circle.  Note</span>
    <span class="s5"># that alternating red and blue stripes become white.</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'antialiased'</span><span class="s2">, </span><span class="s1">interpolation_stage</span><span class="s2">=</span><span class="s3">'data'</span><span class="s2">,</span>
                  <span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1.2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1.2</span><span class="s2">)</span>

    <span class="s5"># rgba antialias: Note purples at boundary with circle.  Note that</span>
    <span class="s5"># alternating red and blue stripes become purple</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s6">3</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'antialiased'</span><span class="s2">, </span><span class="s1">interpolation_stage</span><span class="s2">=</span><span class="s3">'rgba'</span><span class="s2">,</span>
                  <span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s6">1.2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1.2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_rc_interpolation_stage</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;rgba&quot;</span><span class="s2">]:</span>
        <span class="s0">with </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s3">&quot;image.interpolation_stage&quot;</span><span class="s2">: </span><span class="s1">val</span><span class="s2">}):</span>
            <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]]).</span><span class="s1">get_interpolation_stage</span><span class="s2">() == </span><span class="s1">val</span>
    <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;DATA&quot;</span><span class="s2">, </span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;image.interpolation_stage&quot;</span><span class="s2">] = </span><span class="s1">val</span>


<span class="s5"># We check for the warning with a draw() in the test, but we also need to</span>
<span class="s5"># filter the warning as it is emitted by the figure test decorator</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">r'ignore:Data with more than .* '</span>
                            <span class="s3">'cannot be accurately displayed'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'origin'</span><span class="s2">, [</span><span class="s3">'upper'</span><span class="s2">, </span><span class="s3">'lower'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">'dim, size, msg'</span><span class="s2">, [[</span><span class="s3">'row'</span><span class="s2">, </span><span class="s6">2</span><span class="s2">**</span><span class="s6">23</span><span class="s2">, </span><span class="s3">r'2\*\*23 columns'</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s3">'col'</span><span class="s2">, </span><span class="s6">2</span><span class="s2">**</span><span class="s6">24</span><span class="s2">, </span><span class="s3">r'2\*\*24 rows'</span><span class="s2">]])</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=(</span><span class="s3">'png'</span><span class="s2">, ))</span>
<span class="s0">def </span><span class="s1">test_large_image</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">dim</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">):</span>
    <span class="s5"># Check that Matplotlib downsamples images that are too big for AGG</span>
    <span class="s5"># See issue #19276. Currently the fix only works for png output but not</span>
    <span class="s5"># pdf or svg output.</span>
    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">1</span><span class="s2">, </span><span class="s1">size </span><span class="s2">+ </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">array</span><span class="s2">[:, </span><span class="s1">array</span><span class="s2">.</span><span class="s1">size </span><span class="s2">// </span><span class="s6">2</span><span class="s2">:] = </span><span class="s6">1</span>
    <span class="s0">if </span><span class="s1">dim </span><span class="s2">== </span><span class="s3">'col'</span><span class="s2">:</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">T</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax_test</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">,</span>
                        <span class="s1">aspect</span><span class="s2">=</span><span class="s3">'auto'</span><span class="s2">, </span><span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">),</span>
                        <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">,</span>
                        <span class="s1">origin</span><span class="s2">=</span><span class="s1">origin</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">f'Data with more than </span><span class="s0">{</span><span class="s1">msg</span><span class="s0">} </span><span class="s3">cannot be '</span>
                      <span class="s3">'accurately displayed.'</span><span class="s2">):</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">array</span><span class="s2">[:, </span><span class="s6">1</span><span class="s2">] = </span><span class="s6">1</span>
    <span class="s0">if </span><span class="s1">dim </span><span class="s2">== </span><span class="s3">'col'</span><span class="s2">:</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">T</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">'auto'</span><span class="s2">,</span>
                       <span class="s1">extent</span><span class="s2">=(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">),</span>
                       <span class="s1">interpolation</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">,</span>
                       <span class="s1">origin</span><span class="s2">=</span><span class="s1">origin</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_str_norms</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s6">10</span><span class="s2">, </span><span class="s6">10</span><span class="s2">) * </span><span class="s6">.8 </span><span class="s2">+ </span><span class="s6">.1  </span><span class="s5"># between 0 and 1</span>
    <span class="s1">axts </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)</span>
    <span class="s1">axts</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;log&quot;</span><span class="s2">)</span>
    <span class="s1">axts</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;log&quot;</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">.2</span><span class="s2">)</span>
    <span class="s1">axts</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;symlog&quot;</span><span class="s2">)</span>
    <span class="s1">axts</span><span class="s2">[</span><span class="s6">3</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;symlog&quot;</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">.3</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">.7</span><span class="s2">)</span>
    <span class="s1">axts</span><span class="s2">[</span><span class="s6">4</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;logit&quot;</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">.3</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">.7</span><span class="s2">)</span>
    <span class="s1">axrs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">5</span><span class="s2">)</span>
    <span class="s1">axrs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">())</span>
    <span class="s1">axrs</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">.2</span><span class="s2">))</span>
    <span class="s5"># same linthresh as SymmetricalLogScale's default.</span>
    <span class="s1">axrs</span><span class="s2">[</span><span class="s6">2</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">SymLogNorm</span><span class="s2">(</span><span class="s1">linthresh</span><span class="s2">=</span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">axrs</span><span class="s2">[</span><span class="s6">3</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">SymLogNorm</span><span class="s2">(</span><span class="s1">linthresh</span><span class="s2">=</span><span class="s6">2</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">.3</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">.7</span><span class="s2">))</span>
    <span class="s1">axrs</span><span class="s2">[</span><span class="s6">4</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;logit&quot;</span><span class="s2">, </span><span class="s1">clim</span><span class="s2">=(</span><span class="s6">.3</span><span class="s2">, </span><span class="s6">.7</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">axts</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">images</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">norm</span><span class="s2">) </span><span class="s0">is </span><span class="s1">colors</span><span class="s2">.</span><span class="s1">LogNorm  </span><span class="s5"># Exactly that class</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">axts</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s3">&quot;foobar&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__resample_valid_output</span><span class="s2">():</span>
    <span class="s1">resample </span><span class="s2">= </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_image</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">Affine2D</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;incompatible function arguments&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)), </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different dimensionalities&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different dimensionalities&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;3D input array must be RGBA&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;3D output array must be RGBA&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">4</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;mismatched types&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;must be C-contiguous&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)).</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">))</span>
    <span class="s1">out</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Output array must be writeable&quot;</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s6">9</span><span class="s2">, </span><span class="s6">9</span><span class="s2">)), </span><span class="s1">out</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_axesimage_get_shape</span><span class="s2">():</span>
    <span class="s5"># generate dummy image to test get_shape method</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">AxesImage</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;You must first set the image array&quot;</span><span class="s2">):</span>
        <span class="s1">im</span><span class="s2">.</span><span class="s1">get_shape</span><span class="s2">()</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
    <span class="s1">im</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_shape</span><span class="s2">() == (</span><span class="s6">4</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_size</span><span class="s2">() == </span><span class="s1">im</span><span class="s2">.</span><span class="s1">get_shape</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_non_transdata_image_does_not_touch_aspect</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s6">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_aspect</span><span class="s2">() == </span><span class="s3">&quot;auto&quot;</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s6">2</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_aspect</span><span class="s2">() == </span><span class="s6">1</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_aspect</span><span class="s2">() == </span><span class="s6">2</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">'dtype'</span><span class="s2">,</span>
    <span class="s2">(</span><span class="s3">'float64'</span><span class="s2">, </span><span class="s3">'float32'</span><span class="s2">, </span><span class="s3">'int16'</span><span class="s2">, </span><span class="s3">'uint16'</span><span class="s2">, </span><span class="s3">'int8'</span><span class="s2">, </span><span class="s3">'uint8'</span><span class="s2">),</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'ndim'</span><span class="s2">, (</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_resample_dtypes</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">):</span>
    <span class="s5"># Issue 28448, incorrect dtype comparisons in C++ image_resample can raise</span>
    <span class="s5"># ValueError: arrays must be of dtype byte, short, float32 or float64</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s6">4181</span><span class="s2">)</span>
    <span class="s1">shape </span><span class="s2">= (</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">) </span><span class="s0">if </span><span class="s1">ndim </span><span class="s2">== </span><span class="s6">2 </span><span class="s0">else </span><span class="s2">(</span><span class="s6">2</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">axes_image </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s5"># Before fix the following raises ValueError for some dtypes.</span>
    <span class="s1">axes_image</span><span class="s2">.</span><span class="s1">make_image</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>
</pre>
</body>
</html>