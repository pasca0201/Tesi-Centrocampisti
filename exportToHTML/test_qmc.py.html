<html>
<head>
<title>test_qmc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_qmc.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">Counter</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">combinations</span><span class="s2">, </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">spatial </span><span class="s0">import </span><span class="s1">distance</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats </span><span class="s0">import </span><span class="s1">shapiro</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">_sobol </span><span class="s0">import </span><span class="s1">_test_find_index</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats </span><span class="s0">import </span><span class="s1">qmc</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">_qmc </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">van_der_corput</span><span class="s2">, </span><span class="s1">n_primes</span><span class="s2">, </span><span class="s1">primes_from_2_to</span><span class="s2">,</span>
    <span class="s1">update_discrepancy</span><span class="s2">, </span><span class="s1">QMCEngine</span><span class="s2">, </span><span class="s1">_l1_norm</span><span class="s2">,</span>
    <span class="s1">_perturb_discrepancy</span><span class="s2">, </span><span class="s1">_lloyd_centroidal_voronoi_tessellation</span>
<span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUtils</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_scale</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># 1d scalar</span>
        <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s1">out </span><span class="s2">= [[-</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]]</span>
        <span class="s1">scaled_space </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">scaled_space</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s3"># 2d space</span>
        <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
        <span class="s1">out </span><span class="s2">= [[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">]]</span>

        <span class="s1">scaled_space </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">scaled_space</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">scaled_back_space </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">scaled_space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span>
                                      <span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">reverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">scaled_back_space</span><span class="s2">, </span><span class="s1">space</span><span class="s2">)</span>

        <span class="s3"># broadcast</span>
        <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s1">l_bounds</span><span class="s2">, </span><span class="s1">u_bounds </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">out </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">]]</span>

        <span class="s1">scaled_space </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">l_bounds</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">u_bounds</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">scaled_space</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_scale_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">317589836511269190194010915937762468165</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">a </span><span class="s2">= -</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) * </span><span class="s4">10</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) * </span><span class="s4">10</span>
        <span class="s1">scaled </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">reverse</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">unscaled </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">scaled</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">reverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">unscaled</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_scale_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not a 2D array&quot;</span><span class="s2">):</span>
            <span class="s1">space </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Bounds are not consistent&quot;</span><span class="s2">):</span>
            <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
            <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;'l_bounds' and 'u_bounds'&quot;</span>
                                             <span class="s5">r&quot; must be broadcastable&quot;</span><span class="s2">):</span>
            <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
            <span class="s1">l_bounds</span><span class="s2">, </span><span class="s1">u_bounds </span><span class="s2">= [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">l_bounds</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">u_bounds</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;'l_bounds' and 'u_bounds'&quot;</span>
                                             <span class="s5">r&quot; must be broadcastable&quot;</span><span class="s2">):</span>
            <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
            <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not in unit &quot;</span>
                                             <span class="s5">r&quot;hypercube&quot;</span><span class="s2">):</span>
            <span class="s1">space </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
            <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">space</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is out of bounds&quot;</span><span class="s2">):</span>
            <span class="s1">out </span><span class="s2">= [[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">]]</span>
            <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">],</span>
                      <span class="s1">reverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_discrepancy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">space_1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">space_1 </span><span class="s2">= (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">space_1 </span><span class="s2">- </span><span class="s4">1.0</span><span class="s2">) / (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s4">6.0</span><span class="s2">)</span>
        <span class="s1">space_2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
        <span class="s1">space_2 </span><span class="s2">= (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">space_2 </span><span class="s2">- </span><span class="s4">1.0</span><span class="s2">) / (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s4">6.0</span><span class="s2">)</span>

        <span class="s3"># From Fang et al. Design and modeling for computer experiments, 2006</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">), </span><span class="s4">0.0081</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">space_2</span><span class="s2">), </span><span class="s4">0.0105</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># From Zhou Y.-D. et al. Mixture discrepancy for quasi-random point</span>
        <span class="s3"># sets. Journal of Complexity, 29 (3-4), pp. 283-301, 2013.</span>
        <span class="s3"># Example 4 on Page 298</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
        <span class="s1">sample </span><span class="s2">= (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">sample </span><span class="s2">- </span><span class="s4">1.0</span><span class="s2">) / (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s4">2.0</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'MD'</span><span class="s2">), </span><span class="s4">2.5000</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'WD'</span><span class="s2">), </span><span class="s4">1.3680</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'CD'</span><span class="s2">), </span><span class="s4">0.3172</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># From Tim P. et al. Minimizing the L2 and Linf star discrepancies</span>
        <span class="s3"># of a single point in the unit hypercube. JCAM, 2005</span>
        <span class="s3"># Table 1 on Page 283</span>
        <span class="s0">for </span><span class="s1">dim </span><span class="s0">in </span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">64</span><span class="s2">]:</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">3</span><span class="s2">**(-</span><span class="s1">dim</span><span class="s2">))</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">]*</span><span class="s1">dim</span><span class="s2">]),</span>
                                            <span class="s1">method</span><span class="s2">=</span><span class="s5">'L2-star'</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_discrepancy_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not in unit hypercube&quot;</span>
        <span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not a 2D array&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>

        <span class="s1">sample </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;'toto' is not a valid ...&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;toto&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_discrepancy_parallel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
        <span class="s1">sample </span><span class="s2">= (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">sample </span><span class="s2">- </span><span class="s4">1.0</span><span class="s2">) / (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s4">2.0</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'MD'</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">),</span>
                        <span class="s4">2.5000</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'WD'</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">),</span>
                        <span class="s4">1.3680</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'CD'</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">),</span>
                        <span class="s4">0.3172</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># From Tim P. et al. Minimizing the L2 and Linf star discrepancies</span>
        <span class="s3"># of a single point in the unit hypercube. JCAM, 2005</span>
        <span class="s3"># Table 1 on Page 283</span>
        <span class="s0">for </span><span class="s1">dim </span><span class="s0">in </span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">64</span><span class="s2">]:</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">3 </span><span class="s2">** (-</span><span class="s1">dim</span><span class="s2">))</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">] * </span><span class="s1">dim</span><span class="s2">]),</span>
                                            <span class="s1">method</span><span class="s2">=</span><span class="s5">'L2-star'</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">os</span><span class="s2">, </span><span class="s5">'cpu_count'</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Cannot determine the&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Invalid number of workers...&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_geometric_discrepancy_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not in unit hypercube&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not a 2D array&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>

        <span class="s1">sample </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;'toto' is not a valid ...&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;toto&quot;</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Sample contains duplicate points.&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Sample must contain at least two points&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_geometric_discrepancy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;mst&quot;</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;mst&quot;</span><span class="s2">), </span><span class="s4">0.75</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0.25</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) / </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;mst&quot;</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) / </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;chebyshev&quot;</span><span class="s2">), </span><span class="s4">0.25</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;mst&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;chebyshev&quot;</span><span class="s2">), </span><span class="s4">0.5</span>
        <span class="s2">)</span>

        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">191468432622931918890291693003068437394</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), </span><span class="s4">0.05106012076093356</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'mst'</span><span class="s2">), </span><span class="s4">0.19704396643366182</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;minimum_spanning_tree ignores zero distances (#18892)&quot;</span><span class="s2">,</span>
            <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_geometric_discrepancy_mst_with_zero_distances</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">geometric_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'mst'</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_update_discrepancy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># From Fang et al. Design and modeling for computer experiments, 2006</span>
        <span class="s1">space_1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">space_1 </span><span class="s2">= (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">space_1 </span><span class="s2">- </span><span class="s4">1.0</span><span class="s2">) / (</span><span class="s4">2.0 </span><span class="s2">* </span><span class="s4">6.0</span><span class="s2">)</span>

        <span class="s1">disc_init </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">iterative</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">disc_iter </span><span class="s2">= </span><span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_iter</span><span class="s2">, </span><span class="s4">0.0081</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># n&lt;d</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">241557431858162136881731220526394276199</span><span class="s2">)</span>
        <span class="s1">space_1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>

        <span class="s1">disc_ref </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">)</span>
        <span class="s1">disc_init </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">iterative</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">disc_iter </span><span class="s2">= </span><span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_iter</span><span class="s2">, </span><span class="s1">disc_ref</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># errors</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not in unit &quot;</span>
                                             <span class="s5">r&quot;hypercube&quot;</span><span class="s2">):</span>
            <span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">, </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Sample is not a 2D array&quot;</span><span class="s2">):</span>
            <span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">space_1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">space_1</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s1">x_new </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;x_new is not in unit &quot;</span>
                                             <span class="s5">r&quot;hypercube&quot;</span><span class="s2">):</span>
            <span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">x_new</span><span class="s2">, </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s1">x_new </span><span class="s2">= [[</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;x_new is not a 1D array&quot;</span><span class="s2">):</span>
            <span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">x_new</span><span class="s2">, </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

        <span class="s1">x_new </span><span class="s2">= [</span><span class="s4">0.3</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;x_new and sample must be &quot;</span>
                                             <span class="s5">r&quot;broadcastable&quot;</span><span class="s2">):</span>
            <span class="s1">update_discrepancy</span><span class="s2">(</span><span class="s1">x_new</span><span class="s2">, </span><span class="s1">space_1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">disc_init</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_perm_discrepancy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">46449423132557934943847369749645759997</span><span class="s2">)</span>
        <span class="s1">qmc_gen </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">qmc_gen</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">disc </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">):</span>
            <span class="s1">row_1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s1">row_2 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s1">col </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>

            <span class="s1">disc </span><span class="s2">= </span><span class="s1">_perturb_discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">row_1</span><span class="s2">, </span><span class="s1">row_2</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">disc</span><span class="s2">)</span>
            <span class="s1">sample</span><span class="s2">[</span><span class="s1">row_1</span><span class="s2">, </span><span class="s1">col</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">[</span><span class="s1">row_2</span><span class="s2">, </span><span class="s1">col</span><span class="s2">] = (</span>
                <span class="s1">sample</span><span class="s2">[</span><span class="s1">row_2</span><span class="s2">, </span><span class="s1">col</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">[</span><span class="s1">row_1</span><span class="s2">, </span><span class="s1">col</span><span class="s2">])</span>
            <span class="s1">disc_reference </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc</span><span class="s2">, </span><span class="s1">disc_reference</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_discrepancy_alternative_implementation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Alternative definitions from Matt Haberland.&quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">disc_c2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">s </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span>
            <span class="s1">xij </span><span class="s2">= </span><span class="s1">x</span>
            <span class="s1">disc1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">((</span><span class="s4">1</span>
                                    <span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij</span><span class="s2">-</span><span class="s4">0.5</span><span class="s2">)</span>
                                    <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij</span><span class="s2">-</span><span class="s4">0.5</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))</span>
            <span class="s1">xij </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :, :]</span>
            <span class="s1">xkj </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">, :]</span>
            <span class="s1">disc2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s4">1</span>
                                          <span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s4">0.5</span><span class="s2">)</span>
                                          <span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xkj </span><span class="s2">- </span><span class="s4">0.5</span><span class="s2">)</span>
                                          <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s1">xkj</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">2</span><span class="s2">),</span>
                                  <span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s4">13</span><span class="s2">/</span><span class="s4">12</span><span class="s2">)**</span><span class="s1">s </span><span class="s2">- </span><span class="s4">2</span><span class="s2">/</span><span class="s1">n </span><span class="s2">* </span><span class="s1">disc1 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s1">n</span><span class="s2">**</span><span class="s4">2</span><span class="s2">*</span><span class="s1">disc2</span>

        <span class="s0">def </span><span class="s1">disc_wd</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">s </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span>
            <span class="s1">xij </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :, :]</span>
            <span class="s1">xkj </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">, :]</span>
            <span class="s1">disc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s4">3</span><span class="s2">/</span><span class="s4">2</span>
                                         <span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s1">xkj</span><span class="s2">)</span>
                                         <span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s1">xkj</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">2</span><span class="s2">),</span>
                                 <span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s2">-(</span><span class="s4">4</span><span class="s2">/</span><span class="s4">3</span><span class="s2">)**</span><span class="s1">s </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s1">n</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">disc</span>

        <span class="s0">def </span><span class="s1">disc_md</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">s </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span>
            <span class="s1">xij </span><span class="s2">= </span><span class="s1">x</span>
            <span class="s1">disc1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">((</span><span class="s4">5</span><span class="s2">/</span><span class="s4">3</span>
                                    <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij</span><span class="s2">-</span><span class="s4">0.5</span><span class="s2">)</span>
                                    <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij</span><span class="s2">-</span><span class="s4">0.5</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))</span>
            <span class="s1">xij </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :, :]</span>
            <span class="s1">xkj </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">, :]</span>
            <span class="s1">disc2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s4">15</span><span class="s2">/</span><span class="s4">8</span>
                                          <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s4">0.5</span><span class="s2">)</span>
                                          <span class="s2">- </span><span class="s4">1</span><span class="s2">/</span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xkj </span><span class="s2">- </span><span class="s4">0.5</span><span class="s2">)</span>
                                          <span class="s2">- </span><span class="s4">3</span><span class="s2">/</span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s1">xkj</span><span class="s2">)</span>
                                          <span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s4">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">xij </span><span class="s2">- </span><span class="s1">xkj</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">,</span>
                                          <span class="s1">axis</span><span class="s2">=</span><span class="s4">2</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s4">19</span><span class="s2">/</span><span class="s4">12</span><span class="s2">)**</span><span class="s1">s </span><span class="s2">- </span><span class="s4">2</span><span class="s2">/</span><span class="s1">n </span><span class="s2">* </span><span class="s1">disc1 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">/</span><span class="s1">n</span><span class="s2">**</span><span class="s4">2</span><span class="s2">*</span><span class="s1">disc2</span>

        <span class="s0">def </span><span class="s1">disc_star_l2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">s </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span>
                <span class="s4">3 </span><span class="s2">** (-</span><span class="s1">s</span><span class="s2">) - </span><span class="s4">2 </span><span class="s2">** (</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">s</span><span class="s2">) / </span><span class="s1">n</span>
                <span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">x </span><span class="s2">** </span><span class="s4">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))</span>
                <span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">([</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">k</span><span class="s2">, :], </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, :]))</span>
                    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
                <span class="s2">]) / </span><span class="s1">n </span><span class="s2">** </span><span class="s4">2</span>
            <span class="s2">)</span>

        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">117065081482921065782761407107747179201</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>

        <span class="s1">disc_curr </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'CD'</span><span class="s2">)</span>
        <span class="s1">disc_alt </span><span class="s2">= </span><span class="s1">disc_c2</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_curr</span><span class="s2">, </span><span class="s1">disc_alt</span><span class="s2">)</span>

        <span class="s1">disc_curr </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'WD'</span><span class="s2">)</span>
        <span class="s1">disc_alt </span><span class="s2">= </span><span class="s1">disc_wd</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_curr</span><span class="s2">, </span><span class="s1">disc_alt</span><span class="s2">)</span>

        <span class="s1">disc_curr </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'MD'</span><span class="s2">)</span>
        <span class="s1">disc_alt </span><span class="s2">= </span><span class="s1">disc_md</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_curr</span><span class="s2">, </span><span class="s1">disc_alt</span><span class="s2">)</span>

        <span class="s1">disc_curr </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'L2-star'</span><span class="s2">)</span>
        <span class="s1">disc_alt </span><span class="s2">= </span><span class="s1">disc_star_l2</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disc_curr</span><span class="s2">, </span><span class="s1">disc_alt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_n_primes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">primes </span><span class="s2">= </span><span class="s1">n_primes</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">primes</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">29</span>

        <span class="s1">primes </span><span class="s2">= </span><span class="s1">n_primes</span><span class="s2">(</span><span class="s4">168</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">primes</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">997</span>

        <span class="s1">primes </span><span class="s2">= </span><span class="s1">n_primes</span><span class="s2">(</span><span class="s4">350</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">primes</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">2357</span>

    <span class="s0">def </span><span class="s1">test_primes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">primes </span><span class="s2">= </span><span class="s1">primes_from_2_to</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">17</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">29</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">37</span><span class="s2">, </span><span class="s4">41</span><span class="s2">, </span><span class="s4">43</span><span class="s2">, </span><span class="s4">47</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">primes</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestVDC</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_van_der_corput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">0.125</span><span class="s2">, </span><span class="s4">0.625</span><span class="s2">,</span>
               <span class="s4">0.375</span><span class="s2">, </span><span class="s4">0.875</span><span class="s2">, </span><span class="s4">0.0625</span><span class="s2">, </span><span class="s4">0.5625</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s1">start_index</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:])</span>

    <span class="s0">def </span><span class="s1">test_van_der_corput_scramble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s4">338213789010180879520345496831675783177</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s1">start_index</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:])</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span>
            <span class="s4">7</span><span class="s2">, </span><span class="s1">start_index</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">4</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:])</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">van_der_corput</span><span class="s2">(</span>
            <span class="s4">7</span><span class="s2">, </span><span class="s1">start_index</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">out</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:])</span>

    <span class="s0">def </span><span class="s1">test_invalid_base_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;'base' must be at least 2&quot;</span><span class="s2">):</span>
            <span class="s1">van_der_corput</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">base</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">RandomEngine</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">QMCEngine</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">=</span><span class="s1">optimization</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, *, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">sample</span>


<span class="s0">def </span><span class="s1">test_subclassing_QMCEngine</span><span class="s2">():</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">RandomEngine</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">175180605424926556207367152557812293274</span><span class="s2">)</span>

    <span class="s1">sample_1 </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">sample_2 </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s4">12</span>

    <span class="s3"># reset and re-sample</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s4">0</span>

    <span class="s1">sample_1_test </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample_1</span><span class="s2">, </span><span class="s1">sample_1_test</span><span class="s2">)</span>

    <span class="s3"># repeat reset and fast forward</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">fast_forward</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">sample_2_test </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample_2</span><span class="s2">, </span><span class="s1">sample_2_test</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s4">12</span>


<span class="s0">def </span><span class="s1">test_raises</span><span class="s2">():</span>
    <span class="s3"># input validation</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;d must be a non-negative integer&quot;</span><span class="s2">):</span>
        <span class="s1">RandomEngine</span><span class="s2">((</span><span class="s4">2</span><span class="s2">,))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;d must be a non-negative integer&quot;</span><span class="s2">):</span>
        <span class="s1">RandomEngine</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">r&quot;'u_bounds' and 'l_bounds' must be integers&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">RandomEngine</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">l_bounds</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s4">1.1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_integers</span><span class="s2">():</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">RandomEngine</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">231195739755290648063853336582377368684</span><span class="s2">)</span>

    <span class="s3"># basic tests</span>
    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int64'</span><span class="s2">)</span>

    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

    <span class="s1">low </span><span class="s2">= -</span><span class="s4">5</span>
    <span class="s1">high </span><span class="s2">= </span><span class="s4">7</span>

    <span class="s3"># scaling logic</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
    <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">ref_sample </span><span class="s2">* (</span><span class="s1">high </span><span class="s2">- </span><span class="s1">low</span><span class="s2">) + </span><span class="s1">low</span>
    <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">ref_sample</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

    <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">high</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">)</span>

    <span class="s3"># up to bounds, no less, no more</span>
    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">high</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">((</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()), (</span><span class="s1">low</span><span class="s2">, </span><span class="s1">high</span><span class="s2">-</span><span class="s4">1</span><span class="s2">))</span>

    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">high</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">((</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()), (</span><span class="s1">low</span><span class="s2">, </span><span class="s1">high</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_integers_nd</span><span class="s2">():</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">3716505122102428560615700415287450951</span><span class="s2">)</span>
    <span class="s1">low </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=-</span><span class="s4">5</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>
    <span class="s1">high </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">RandomEngine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">high</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">low</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">high</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">u_bounds</span><span class="s2">=</span><span class="s1">high</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">low</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">high</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">QMCEngineTests</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Generic tests for QMC engines.&quot;&quot;&quot;</span>
    <span class="s1">qmce </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">can_scramble </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">unscramble_nd </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">scramble_nd </span><span class="s2">= </span><span class="s1">NotImplemented</span>

    <span class="s1">scramble </span><span class="s2">= [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]</span>
    <span class="s1">ids </span><span class="s2">= [</span><span class="s5">&quot;Scrambled&quot;</span><span class="s2">, </span><span class="s5">&quot;Unscrambled&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
        <span class="s1">seed</span><span class="s2">=</span><span class="s4">170382760648021597650530316304495310428</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">kwargs</span>
    <span class="s2">) </span><span class="s1">-&gt; QMCEngine</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">can_scramble</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">qmce</span><span class="s2">(</span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">scramble</span><span class="s2">:</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">qmce</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">reference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">) </span><span class="s1">-&gt; np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scramble_nd </span><span class="s0">if </span><span class="s1">scramble </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unscramble_nd</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_0dim</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), </span><span class="s1">sample</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_0sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">sample</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_1sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">) == </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">512</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">sample </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">sample </span><span class="s2">&lt;= </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">reference</span><span class="s2">(</span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ref_sample</span><span class="s2">))</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ref_sample</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_continuing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>

        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>

        <span class="s1">n_half </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ref_sample</span><span class="s2">) // </span><span class="s4">2</span>

        <span class="s1">_ </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">n_half</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">n_half</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">[</span><span class="s1">n_half</span><span class="s2">:], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;seed&quot;</span><span class="s2">,</span>
        <span class="s2">(</span>
            <span class="s4">170382760648021597650530316304495310428</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">170382760648021597650530316304495310428</span><span class="s2">),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>

        <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s4">0</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">ids</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_fast_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>

        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>

        <span class="s1">engine</span><span class="s2">.</span><span class="s1">fast_forward</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">[</span><span class="s4">4</span><span class="s2">:], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-1</span><span class="s2">)</span>

        <span class="s3"># alternate fast forwarding with sampling</span>
        <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">even_draws </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">% </span><span class="s4">2 </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">even_draws</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">())</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">engine</span><span class="s2">.</span><span class="s1">fast_forward</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">ref_sample</span><span class="s2">[[</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">) </span><span class="s0">if </span><span class="s1">i </span><span class="s2">% </span><span class="s4">2 </span><span class="s2">== </span><span class="s4">0</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">even_draws</span><span class="s2">),</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-5</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_distribution</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s4">50</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">1024</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">d</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">percentile</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s4">0.25</span><span class="s2">, </span><span class="s1">d</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">percentile</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s4">75</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s4">0.75</span><span class="s2">, </span><span class="s1">d</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_raises_optimizer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;'toto' is not a valid optimization method&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">=</span><span class="s5">&quot;toto&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;optimization,metric&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s5">&quot;random-CD&quot;</span><span class="s2">, </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">discrepancy</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;lloyd&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">sample</span><span class="s2">: -</span><span class="s1">_l1_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">))]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_optimizers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">sample_ref </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">64</span><span class="s2">)</span>
        <span class="s1">metric_ref </span><span class="s2">= </span><span class="s1">metric</span><span class="s2">(</span><span class="s1">sample_ref</span><span class="s2">)</span>

        <span class="s1">optimal_ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">=</span><span class="s1">optimization</span><span class="s2">)</span>
        <span class="s1">sample_ </span><span class="s2">= </span><span class="s1">optimal_</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">64</span><span class="s2">)</span>
        <span class="s1">metric_ </span><span class="s2">= </span><span class="s1">metric</span><span class="s2">(</span><span class="s1">sample_</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">metric_ </span><span class="s2">&lt; </span><span class="s1">metric_ref</span>

    <span class="s0">def </span><span class="s1">test_consume_prng_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">0xa29cabb11cfdf44ff6cac8bec254c2a0</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
            <span class="s1">sample</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">4</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Arrays are not equal&quot;</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Arrays are not equal&quot;</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestHalton</span><span class="s2">(</span><span class="s1">QMCEngineTests</span><span class="s2">):</span>
    <span class="s1">qmce </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Halton</span>
    <span class="s1">can_scramble </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s3"># theoretical values known from Van der Corput</span>
    <span class="s1">unscramble_nd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3 </span><span class="s2">/ </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">9</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">8</span><span class="s2">, </span><span class="s4">4 </span><span class="s2">/ </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5 </span><span class="s2">/ </span><span class="s4">8</span><span class="s2">, </span><span class="s4">7 </span><span class="s2">/ </span><span class="s4">9</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">3 </span><span class="s2">/ </span><span class="s4">8</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">/ </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">7 </span><span class="s2">/ </span><span class="s4">8</span><span class="s2">, </span><span class="s4">5 </span><span class="s2">/ </span><span class="s4">9</span><span class="s2">]])</span>
    <span class="s3"># theoretical values unknown: convergence properties checked</span>
    <span class="s1">scramble_nd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.50246036</span><span class="s2">, </span><span class="s4">0.93382481</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.00246036</span><span class="s2">, </span><span class="s4">0.26715815</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.75246036</span><span class="s2">, </span><span class="s4">0.60049148</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.25246036</span><span class="s2">, </span><span class="s4">0.8227137 </span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.62746036</span><span class="s2">, </span><span class="s4">0.15604704</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.12746036</span><span class="s2">, </span><span class="s4">0.48938037</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.87746036</span><span class="s2">, </span><span class="s4">0.71160259</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.37746036</span><span class="s2">, </span><span class="s4">0.04493592</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_workers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">reference</span><span class="s2">(</span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ref_sample</span><span class="s2">), </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">)</span>

        <span class="s3"># worker + integers</span>
        <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">ref_sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">engine</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">ref_sample</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLHS</span><span class="s2">(</span><span class="s1">QMCEngineTests</span><span class="s2">):</span>
    <span class="s1">qmce </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span>
    <span class="s1">can_scramble </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">test_continuing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Not applicable: not a sequence.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fast_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Not applicable: not a sequence.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Not applicable: the value of reference sample is&quot;</span>
                    <span class="s5">&quot; implementation dependent.&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;strength&quot;</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scramble&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;optimization&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;random-CD&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sample_stratified</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">, </span><span class="s1">strength</span><span class="s2">):</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">37511836202578819870665127532742111260</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">p</span><span class="s2">**</span><span class="s4">2</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s4">6</span>

        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s1">scramble</span><span class="s2">,</span>
                                    <span class="s1">strength</span><span class="s2">=</span><span class="s1">strength</span><span class="s2">,</span>
                                    <span class="s1">optimization</span><span class="s2">=</span><span class="s1">optimization</span><span class="s2">,</span>
                                    <span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">num_generated </span><span class="s2">== </span><span class="s1">n</span>

        <span class="s3"># centering stratifies samples in the middle of equal segments:</span>
        <span class="s3"># * inter-sample distance is constant in 1D sub-projections</span>
        <span class="s3"># * after ordering, columns are equal</span>
        <span class="s1">expected1d </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) + </span><span class="s4">0.5</span><span class="s2">) / </span><span class="s1">n</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">expected1d</span><span class="s2">, (</span><span class="s1">d</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)).</span><span class="s1">T</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">sample </span><span class="s2">!= </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">sorted_sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">tol </span><span class="s2">= </span><span class="s4">0.5 </span><span class="s2">/ </span><span class="s1">n </span><span class="s0">if </span><span class="s1">scramble </span><span class="s0">else </span><span class="s4">0</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sorted_sample</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">sample </span><span class="s2">- </span><span class="s1">expected </span><span class="s2">&gt; </span><span class="s1">tol</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">strength </span><span class="s2">== </span><span class="s4">2 </span><span class="s0">and </span><span class="s1">optimization </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">unique_elements </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s1">desired </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">product</span><span class="s2">(</span><span class="s1">unique_elements</span><span class="s2">, </span><span class="s1">unique_elements</span><span class="s2">))</span>

            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">combinations</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">d</span><span class="s2">), </span><span class="s4">2</span><span class="s2">):</span>
                <span class="s1">samples_2d </span><span class="s2">= </span><span class="s1">sample</span><span class="s2">[:, [</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">]]</span>
                <span class="s1">res </span><span class="s2">= (</span><span class="s1">samples_2d </span><span class="s2">* </span><span class="s1">p</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
                <span class="s1">res_set </span><span class="s2">= {</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">row</span><span class="s2">) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">res</span><span class="s2">}</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res_set</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_optimizer_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># discrepancy measures are invariant under permuting factors and runs</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">sample_ref </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">64</span><span class="s2">)</span>

        <span class="s1">optimal_ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">optimization</span><span class="s2">=</span><span class="s5">&quot;random-CD&quot;</span><span class="s2">)</span>
        <span class="s1">sample_ </span><span class="s2">= </span><span class="s1">optimal_</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">64</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sample_ref</span><span class="s2">, </span><span class="s1">sample_</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;not a valid strength&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">strength</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;n is not the square of a prime number&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">strength</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;n is not the square of a prime number&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">strength</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)  </span><span class="s3"># because int(sqrt(5)) would result in 2</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;n is too small for d&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">LatinHypercube</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">strength</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">9</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSobol</span><span class="s2">(</span><span class="s1">QMCEngineTests</span><span class="s2">):</span>
    <span class="s1">qmce </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span>
    <span class="s1">can_scramble </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s3"># theoretical values from Joe Kuo2010</span>
    <span class="s1">unscramble_nd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.25</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.375</span><span class="s2">, </span><span class="s4">0.375</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.875</span><span class="s2">, </span><span class="s4">0.875</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.625</span><span class="s2">, </span><span class="s4">0.125</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">0.125</span><span class="s2">, </span><span class="s4">0.625</span><span class="s2">]])</span>

    <span class="s3"># theoretical values unknown: convergence properties checked</span>
    <span class="s1">scramble_nd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.25331921</span><span class="s2">, </span><span class="s4">0.41371179</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.8654213</span><span class="s2">, </span><span class="s4">0.9821167</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.70097554</span><span class="s2">, </span><span class="s4">0.03664616</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.18027647</span><span class="s2">, </span><span class="s4">0.60895735</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.10521339</span><span class="s2">, </span><span class="s4">0.21897069</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.53019685</span><span class="s2">, </span><span class="s4">0.66619033</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.91122276</span><span class="s2">, </span><span class="s4">0.34580743</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s4">0.45337471</span><span class="s2">, </span><span class="s4">0.78912079</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_warning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;The balance properties of &quot;</span>
                                             <span class="s5">r&quot;Sobol' points&quot;</span><span class="s2">):</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_base2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random_base2</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unscramble_nd</span><span class="s2">[:</span><span class="s4">4</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s3"># resampling still having N=2**n</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random_base2</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unscramble_nd</span><span class="s2">[</span><span class="s4">4</span><span class="s2">:</span><span class="s4">8</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s3"># resampling again but leading to N!=2**n</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;The balance properties of &quot;</span>
                                             <span class="s5">r&quot;Sobol' points&quot;</span><span class="s2">):</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random_base2</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_raise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Maximum supported &quot;</span>
                                             <span class="s5">r&quot;dimensionality&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">.</span><span class="s1">MAXDIM </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Maximum supported &quot;</span>
                                             <span class="s5">r&quot;'bits' is 64&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">=</span><span class="s4">65</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_high_dim</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">1111</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">count1 </span><span class="s2">= </span><span class="s1">Counter</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">().</span><span class="s1">flatten</span><span class="s2">().</span><span class="s1">tolist</span><span class="s2">())</span>
        <span class="s1">count2 </span><span class="s2">= </span><span class="s1">Counter</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">().</span><span class="s1">flatten</span><span class="s2">().</span><span class="s1">tolist</span><span class="s2">())</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">count1</span><span class="s2">, </span><span class="s1">Counter</span><span class="s2">({</span><span class="s4">0.0</span><span class="s2">: </span><span class="s4">1111</span><span class="s2">}))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">count2</span><span class="s2">, </span><span class="s1">Counter</span><span class="s2">({</span><span class="s4">0.5</span><span class="s2">: </span><span class="s4">1111</span><span class="s2">}))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;bits&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_bits</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">=</span><span class="s1">bits</span><span class="s2">)</span>
        <span class="s1">ns </span><span class="s2">= </span><span class="s4">2</span><span class="s2">**</span><span class="s1">bits</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">ns</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unscramble_nd</span><span class="s2">[:</span><span class="s1">ns</span><span class="s2">], </span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;increasing `bits`&quot;</span><span class="s2">):</span>
            <span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_64bits</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">=</span><span class="s4">64</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unscramble_nd</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPoisson</span><span class="s2">(</span><span class="s1">QMCEngineTests</span><span class="s2">):</span>
    <span class="s1">qmce </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">PoissonDisk</span>
    <span class="s1">can_scramble </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">test_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Too costly in memory.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fast_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Not applicable: recursive process.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;Not applicable: the value of reference sample is&quot;</span>
                    <span class="s5">&quot; implementation dependent.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_continuing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s3"># can continue a sampling, but will not preserve the same order</span>
        <span class="s3"># because candidates are lost, so we will not select the same center</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s4">0.05</span>
        <span class="s1">ns </span><span class="s2">= </span><span class="s4">6</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">sample_init </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">ns</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sample_init</span><span class="s2">) &lt;= </span><span class="s1">ns</span>
        <span class="s0">assert </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample_init</span><span class="s2">) &gt;= </span><span class="s1">radius</span>

        <span class="s1">sample_continued </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s1">ns</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sample_continued</span><span class="s2">) &lt;= </span><span class="s1">ns</span>
        <span class="s0">assert </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample_continued</span><span class="s2">) &gt;= </span><span class="s1">radius</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">sample_init</span><span class="s2">, </span><span class="s1">sample_continued</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">) &lt;= </span><span class="s1">ns </span><span class="s2">* </span><span class="s4">2</span>
        <span class="s0">assert </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">) &gt;= </span><span class="s1">radius</span>

    <span class="s0">def </span><span class="s1">test_mindist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">132074951149370773672162394161442690287</span><span class="s2">)</span>
        <span class="s1">ns </span><span class="s2">= </span><span class="s4">50</span>

        <span class="s1">low</span><span class="s2">, </span><span class="s1">high </span><span class="s2">= </span><span class="s4">0.08</span><span class="s2">, </span><span class="s4">0.2</span>
        <span class="s1">radii </span><span class="s2">= (</span><span class="s1">high </span><span class="s2">- </span><span class="s1">low</span><span class="s2">) * </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">5</span><span class="s2">) + </span><span class="s1">low</span>

        <span class="s1">dimensions </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">hypersphere_methods </span><span class="s2">= [</span><span class="s5">&quot;volume&quot;</span><span class="s2">, </span><span class="s5">&quot;surface&quot;</span><span class="s2">]</span>

        <span class="s1">gen </span><span class="s2">= </span><span class="s1">product</span><span class="s2">(</span><span class="s1">dimensions</span><span class="s2">, </span><span class="s1">radii</span><span class="s2">, </span><span class="s1">hypersphere_methods</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">d</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">, </span><span class="s1">hypersphere </span><span class="s0">in </span><span class="s1">gen</span><span class="s2">:</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">qmce</span><span class="s2">(</span>
                <span class="s1">d</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">hypersphere</span><span class="s2">=</span><span class="s1">hypersphere</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span>
            <span class="s2">)</span>
            <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">ns</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">) &lt;= </span><span class="s1">ns</span>
            <span class="s0">assert </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">) &gt;= </span><span class="s1">radius</span>

    <span class="s0">def </span><span class="s1">test_fill_space</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s4">0.2</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">qmce</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">)</span>

        <span class="s1">sample </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">fill_space</span><span class="s2">()</span>
        <span class="s3"># circle packing problem is np complex</span>
        <span class="s0">assert </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">) &gt;= </span><span class="s1">radius</span>

    <span class="s0">def </span><span class="s1">test_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;'toto' is not a valid hypersphere sampling&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">PoissonDisk</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">hypersphere</span><span class="s2">=</span><span class="s5">&quot;toto&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMultinomialQMC</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_validations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># negative Ps</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, -</span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;Elements of pvals must &quot;</span>
                                             <span class="s5">r&quot;be non-negative.&quot;</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>

        <span class="s3"># sum of P too large</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Elements of pvals must sum to 1.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>

        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Dimension of `engine` must be 1.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;`engine` must be an instance of...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">())</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">'ignore::UserWarning'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_MultinomialBasicDraw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">6955663962957011631562466584467607969</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>
        <span class="s1">n_trials </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_2d</span><span class="s2">(</span><span class="s1">n_trials </span><span class="s2">* </span><span class="s1">p</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s1">n_trials</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_MultinomialDistribution</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">77797854505813727292048130876699859000</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s4">8192</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">draws </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">draws </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">draws</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_2d</span><span class="s2">(</span><span class="s1">p</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_FindIndex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p_cumulative </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.45</span><span class="s2">, </span><span class="s4">0.6</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">0.99</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">])</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_test_find_index</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_test_find_index</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_test_find_index</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s4">0.44999</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_test_find_index</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s4">0.45001</span><span class="s2">), </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_test_find_index</span><span class="s2">(</span><span class="s1">p_cumulative</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), </span><span class="s1">size </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">'ignore::UserWarning'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_other_engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># same as test_MultinomialBasicDraw with different engine</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">283753519042773243071753037669078065412</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.12</span><span class="s2">, </span><span class="s4">0.26</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0.22</span><span class="s2">])</span>
        <span class="s1">n_trials </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_2d</span><span class="s2">(</span><span class="s1">n_trials </span><span class="s2">* </span><span class="s1">p</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">base_engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultinomialQMC</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n_trials</span><span class="s2">=</span><span class="s1">n_trials</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">base_engine</span><span class="s2">,</span>
                                    <span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestNormalQMC</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_NormalQMC</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># d = 1</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s3"># d = 2</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_NormalQMCInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># d = 1</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">1</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s3"># d = 2</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_NormalQMCSeeded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test even dimension</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">274600237797326520096085022671371676017</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.932001</span><span class="s2">, -</span><span class="s4">0.522923</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s4">1.477655</span><span class="s2">, </span><span class="s4">0.846851</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># test odd dimension</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">274600237797326520096085022671371676017</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.932001</span><span class="s2">, -</span><span class="s4">0.522923</span><span class="s2">, </span><span class="s4">0.036578</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s4">1.778011</span><span class="s2">, </span><span class="s4">0.912428</span><span class="s2">, -</span><span class="s4">0.065421</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># same test with another engine</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">274600237797326520096085022671371676017</span><span class="s2">)</span>
        <span class="s1">base_engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">engine</span><span class="s2">=</span><span class="s1">base_engine</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.932001</span><span class="s2">, -</span><span class="s4">0.522923</span><span class="s2">, </span><span class="s4">0.036578</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s4">1.778011</span><span class="s2">, </span><span class="s4">0.912428</span><span class="s2">, -</span><span class="s4">0.065421</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_NormalQMCSeededInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test even dimension</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">288527772707286126646493545351112463929</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.913237</span><span class="s2">, -</span><span class="s4">0.964026</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s4">0.255904</span><span class="s2">, </span><span class="s4">0.003068</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># test odd dimension</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">288527772707286126646493545351112463929</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.913237</span><span class="s2">, -</span><span class="s4">0.964026</span><span class="s2">, </span><span class="s4">0.355501</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s4">0.699261</span><span class="s2">, </span><span class="s4">2.90213 </span><span class="s2">, -</span><span class="s4">0.6418</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_other_engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">base_engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s1">d</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">d</span><span class="s2">),</span>
                                               <span class="s1">engine</span><span class="s2">=</span><span class="s1">base_engine</span><span class="s2">,</span>
                                               <span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_NormalQMCShapiro</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">13242</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># make sure samples are uncorrelated</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span>

    <span class="s0">def </span><span class="s1">test_NormalQMCShapiroInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">32344554</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># make sure samples are uncorrelated</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span>


<span class="s0">class </span><span class="s1">TestMultivariateNormalQMC</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_validations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Dimension of `engine` must be consistent&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Dimension of `engine` must be consistent&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">Sobol</span><span class="s2">(</span><span class="s1">d</span><span class="s2">=</span><span class="s4">4</span><span class="s2">))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;`engine` must be an instance of...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">())</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Covariance matrix not PSD.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Covariance matrix is not symmetric.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s5">r&quot;Dimension mismatch between mean and covariance.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCNonPD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># try with non-pd but psd cov; should work</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]],</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">_corr_matrix </span><span class="s0">is not None</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># d = 1 scalar</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">cov</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s3"># d = 2 list</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s3"># d = 3 np.array</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">cov</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># d = 1 scalar</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">cov</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s3"># d = 2 list</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s3"># d = 3 np.array</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">cov</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCSeeded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test even dimension</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">180182791534511062935571481899241825000</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">() + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]), </span><span class="s1">A</span><span class="s2">,</span>
                                           <span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.64419</span><span class="s2">, -</span><span class="s4">0.882413</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s4">0.837199</span><span class="s2">, </span><span class="s4">2.045301</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># test odd dimension</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">180182791534511062935571481899241825000</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">() + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]), </span><span class="s1">A</span><span class="s2">,</span>
                                           <span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">0.693853</span><span class="s2">, -</span><span class="s4">1.265338</span><span class="s2">, -</span><span class="s4">0.088024</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s4">1.620193</span><span class="s2">, </span><span class="s4">2.679222</span><span class="s2">, </span><span class="s4">0.457343</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCSeededInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test even dimension</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">224125808928297329711992996940871155974</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">() + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]), </span><span class="s1">A</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.682171</span><span class="s2">, -</span><span class="s4">3.114233</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s4">0.098463</span><span class="s2">, </span><span class="s4">0.668069</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

        <span class="s3"># test odd dimension</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">224125808928297329711992996940871155974</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">a</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">() + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]), </span><span class="s1">A</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">samples_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.988061</span><span class="s2">, -</span><span class="s4">1.644089</span><span class="s2">, -</span><span class="s4">0.877035</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s4">1.771731</span><span class="s2">, </span><span class="s4">1.096988</span><span class="s2">, </span><span class="s4">2.024744</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">samples_expected</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCShapiro</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test the standard case</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">188960007281846377164494575845971640</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># make sure samples are uncorrelated</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span>

        <span class="s3"># test the correlated, non-zero mean case</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">], </span><span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">]], </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># check covariance</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] - </span><span class="s4">0.5</span><span class="s2">) &lt; </span><span class="s4">1e-2</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCShapiroInvTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test the standard case</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">200089821034563288698994840831440331329</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># make sure samples are uncorrelated</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span>

        <span class="s3"># test the correlated, non-zero mean case</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">],</span>
            <span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">]],</span>
            <span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">,</span>
            <span class="s1">inv_transform</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">256</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s3"># perform Shapiro-Wilk test for normality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.9</span>
        <span class="s3"># check covariance</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] - </span><span class="s4">0.5</span><span class="s2">) &lt; </span><span class="s4">1e-2</span>

    <span class="s0">def </span><span class="s1">test_MultivariateNormalQMCDegenerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># X, Y iid standard Normal and Z = X + Y, random vector (X, Y, Z)</span>
        <span class="s1">seed </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">16320637417581448357869821654290448620</span><span class="s2">)</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s1">qmc</span><span class="s2">.</span><span class="s1">MultivariateNormalQMC</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">],</span>
            <span class="s1">cov</span><span class="s2">=[[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">]],</span>
            <span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">512</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">]) - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">]) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)) &lt; </span><span class="s4">1e-2</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">pval </span><span class="s2">= </span><span class="s1">shapiro</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">assert </span><span class="s1">pval </span><span class="s2">&gt; </span><span class="s4">0.8</span>
        <span class="s1">cov </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">())</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]) &lt; </span><span class="s4">1e-2</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">] - </span><span class="s4">1</span><span class="s2">) &lt; </span><span class="s4">1e-2</span>
        <span class="s3"># check to see if X + Y = Z almost exactly</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">] + </span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">] - </span><span class="s1">samples</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">])</span>
                   <span class="s2">&lt; </span><span class="s4">1e-5</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLloyd</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_lloyd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># quite sensible seed as it can go up before going further down</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1809831</span><span class="s2">)</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">128</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">base_l1 </span><span class="s2">= </span><span class="s1">_l1_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s1">base_l2 </span><span class="s2">= </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">4</span><span class="s2">):</span>
            <span class="s1">sample_lloyd </span><span class="s2">= </span><span class="s1">_lloyd_centroidal_voronoi_tessellation</span><span class="s2">(</span>
                    <span class="s1">sample</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">curr_l1 </span><span class="s2">= </span><span class="s1">_l1_norm</span><span class="s2">(</span><span class="s1">sample_lloyd</span><span class="s2">)</span>
            <span class="s1">curr_l2 </span><span class="s2">= </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample_lloyd</span><span class="s2">)</span>

            <span class="s3"># higher is better for the distance measures</span>
            <span class="s0">assert </span><span class="s1">base_l1 </span><span class="s2">&lt; </span><span class="s1">curr_l1</span>
            <span class="s0">assert </span><span class="s1">base_l2 </span><span class="s2">&lt; </span><span class="s1">curr_l2</span>

            <span class="s1">base_l1 </span><span class="s2">= </span><span class="s1">curr_l1</span>
            <span class="s1">base_l2 </span><span class="s2">= </span><span class="s1">curr_l2</span>

            <span class="s1">sample </span><span class="s2">= </span><span class="s1">sample_lloyd</span>

    <span class="s0">def </span><span class="s1">test_lloyd_non_mutating</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Verify that the input samples are not mutated in place and that they do 
        not share memory with the output. 
        &quot;&quot;&quot;</span>
        <span class="s1">sample_orig </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">],</span>
                                <span class="s2">[</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">],</span>
                                <span class="s2">[</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">],</span>
                                <span class="s2">[</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">]])</span>
        <span class="s1">sample_copy </span><span class="s2">= </span><span class="s1">sample_orig</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">new_sample </span><span class="s2">= </span><span class="s1">_lloyd_centroidal_voronoi_tessellation</span><span class="s2">(</span>
            <span class="s1">sample</span><span class="s2">=</span><span class="s1">sample_orig</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sample_orig</span><span class="s2">, </span><span class="s1">sample_copy</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">may_share_memory</span><span class="s2">(</span><span class="s1">sample_orig</span><span class="s2">, </span><span class="s1">new_sample</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lloyd_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">r&quot;`sample` is not a 2D array&quot;</span><span class="s2">):</span>
            <span class="s1">sample </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]</span>
            <span class="s1">_lloyd_centroidal_voronoi_tessellation</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s5">r&quot;`sample` dimension is not &gt;= 2&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">sample </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0.4</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]]</span>
            <span class="s1">_lloyd_centroidal_voronoi_tessellation</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s5">r&quot;`sample` is not in unit hypercube&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">sample </span><span class="s2">= [[-</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]</span>
            <span class="s1">_lloyd_centroidal_voronoi_tessellation</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">)</span>


<span class="s3"># mindist</span>
<span class="s0">def </span><span class="s1">l2_norm</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">distance</span><span class="s2">.</span><span class="s1">pdist</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">).</span><span class="s1">min</span><span class="s2">()</span>
</pre>
</body>
</html>