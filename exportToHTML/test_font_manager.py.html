<html>
<head>
<title>test_font_manager.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_font_manager.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span><span class="s2">, </span><span class="s1">StringIO</span>
<span class="s0">import </span><span class="s1">gc</span>
<span class="s0">import </span><span class="s1">multiprocessing</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">font_manager </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">findfont</span><span class="s2">, </span><span class="s1">findSystemFonts</span><span class="s2">, </span><span class="s1">FontEntry</span><span class="s2">, </span><span class="s1">FontProperties</span><span class="s2">, </span><span class="s1">fontManager</span><span class="s2">,</span>
    <span class="s1">json_dump</span><span class="s2">, </span><span class="s1">json_load</span><span class="s2">, </span><span class="s1">get_font</span><span class="s2">, </span><span class="s1">is_opentype_cff_font</span><span class="s2">,</span>
    <span class="s1">MSUserFontDirectories</span><span class="s2">, </span><span class="s1">_get_fontconfig_fonts</span><span class="s2">, </span><span class="s1">ttfFontProperty</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">cbook</span><span class="s2">, </span><span class="s1">ft2font</span><span class="s2">, </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span><span class="s2">, </span><span class="s1">rc_context</span><span class="s2">, </span><span class="s1">figure </span><span class="s0">as </span><span class="s1">mfigure</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">subprocess_run_helper</span><span class="s2">, </span><span class="s1">subprocess_run_for_testing</span>


<span class="s1">has_fclist </span><span class="s2">= </span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">which</span><span class="s2">(</span><span class="s3">'fc-list'</span><span class="s2">) </span><span class="s0">is not None</span>


<span class="s0">def </span><span class="s1">test_font_priority</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">rc_context</span><span class="s2">(</span><span class="s1">rc</span><span class="s2">={</span>
            <span class="s3">'font.sans-serif'</span><span class="s2">:</span>
            <span class="s2">[</span><span class="s3">'cmmi10'</span><span class="s2">, </span><span class="s3">'Bitstream Vera Sans'</span><span class="s2">]}):</span>
        <span class="s1">fontfile </span><span class="s2">= </span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s3">&quot;sans-serif&quot;</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fontfile</span><span class="s2">).</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'cmmi10.ttf'</span>

    <span class="s4"># Smoketest get_charmap, which isn't used internally anymore</span>
    <span class="s1">font </span><span class="s2">= </span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">fontfile</span><span class="s2">)</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_charmap</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">) == </span><span class="s5">131</span>
    <span class="s0">assert </span><span class="s1">cmap</span><span class="s2">[</span><span class="s5">8729</span><span class="s2">] == </span><span class="s5">30</span>


<span class="s0">def </span><span class="s1">test_score_weight</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s5">0 </span><span class="s2">== </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;regular&quot;</span><span class="s2">, </span><span class="s3">&quot;regular&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">0 </span><span class="s2">== </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;bold&quot;</span><span class="s2">, </span><span class="s3">&quot;bold&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s5">0 </span><span class="s2">&lt; </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s5">400</span><span class="s2">, </span><span class="s5">400</span><span class="s2">) &lt;</span>
            <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;normal&quot;</span><span class="s2">, </span><span class="s3">&quot;bold&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s5">0 </span><span class="s2">&lt; </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;normal&quot;</span><span class="s2">, </span><span class="s3">&quot;regular&quot;</span><span class="s2">) &lt;</span>
            <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;normal&quot;</span><span class="s2">, </span><span class="s3">&quot;bold&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s3">&quot;normal&quot;</span><span class="s2">, </span><span class="s3">&quot;regular&quot;</span><span class="s2">) ==</span>
            <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">score_weight</span><span class="s2">(</span><span class="s5">400</span><span class="s2">, </span><span class="s5">400</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_json_serialization</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s4"># Can't open a NamedTemporaryFile twice on Windows, so use a temporary</span>
    <span class="s4"># directory instead.</span>
    <span class="s1">json_dump</span><span class="s2">(</span><span class="s1">fontManager</span><span class="s2">, </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;fontlist.json&quot;</span><span class="s2">)</span>
    <span class="s1">copy </span><span class="s2">= </span><span class="s1">json_load</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;fontlist.json&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">'ignore'</span><span class="s2">, </span><span class="s3">'findfont: Font family.*not found'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">prop </span><span class="s0">in </span><span class="s2">({</span><span class="s3">'family'</span><span class="s2">: </span><span class="s3">'STIXGeneral'</span><span class="s2">},</span>
                     <span class="s2">{</span><span class="s3">'family'</span><span class="s2">: </span><span class="s3">'Bitstream Vera Sans'</span><span class="s2">, </span><span class="s3">'weight'</span><span class="s2">: </span><span class="s5">700</span><span class="s2">},</span>
                     <span class="s2">{</span><span class="s3">'family'</span><span class="s2">: </span><span class="s3">'no such font family'</span><span class="s2">}):</span>
            <span class="s1">fp </span><span class="s2">= </span><span class="s1">FontProperties</span><span class="s2">(**</span><span class="s1">prop</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s2">(</span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">rebuild_if_missing</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) ==</span>
                    <span class="s1">copy</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">rebuild_if_missing</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_otf</span><span class="s2">():</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'/usr/share/fonts/opentype/freefont/FreeMono.otf'</span>
    <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">is_opentype_cff_font</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s3">'otf' </span><span class="s0">in </span><span class="s1">f</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">) == </span><span class="s6">b'OTTO'</span>
            <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s1">is_opentype_cff_font</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;win32&quot; </span><span class="s0">or not </span><span class="s1">has_fclist</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s3">'no fontconfig installed'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_get_fontconfig_fonts</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">_get_fontconfig_fonts</span><span class="s2">()) &gt; </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'factor'</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_hinting_factor</span><span class="s2">(</span><span class="s1">factor</span><span class="s2">):</span>
    <span class="s1">font </span><span class="s2">= </span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s3">&quot;sans-serif&quot;</span><span class="s2">]))</span>

    <span class="s1">font1 </span><span class="s2">= </span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">hinting_factor</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">font1</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s1">font1</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">font1</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s3">'abc'</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">font1</span><span class="s2">.</span><span class="s1">get_width_height</span><span class="s2">()</span>

    <span class="s1">hinted_font </span><span class="s2">= </span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">hinting_factor</span><span class="s2">=</span><span class="s1">factor</span><span class="s2">)</span>
    <span class="s1">hinted_font</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s1">hinted_font</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">hinted_font</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s3">'abc'</span><span class="s2">)</span>
    <span class="s4"># Check that hinting only changes text layout by a small (10%) amount.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">hinted_font</span><span class="s2">.</span><span class="s1">get_width_height</span><span class="s2">(), </span><span class="s1">expected</span><span class="s2">,</span>
                               <span class="s1">rtol</span><span class="s2">=</span><span class="s5">0.1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_utf16m_sfnt</span><span class="s2">():</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s4"># seguisbi = Microsoft Segoe UI Semibold</span>
        <span class="s1">entry </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">entry </span><span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span>
                     <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">).</span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;seguisbi.ttf&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;Couldn't find seguisbi.ttf font to test against.&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s4"># Check that we successfully read &quot;semibold&quot; from the font's sfnt table</span>
        <span class="s4"># and set its weight accordingly.</span>
        <span class="s0">assert </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">weight </span><span class="s2">== </span><span class="s5">600</span>


<span class="s0">def </span><span class="s1">test_find_ttc</span><span class="s2">():</span>
    <span class="s1">fp </span><span class="s2">= </span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s3">&quot;WenQuanYi Zen Hei&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)).</span><span class="s1">name </span><span class="s2">!= </span><span class="s3">&quot;wqy-zenhei.ttc&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;Font wqy-zenhei.ttc may be missing&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\N{KANGXI RADICAL DRAGON}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">fontproperties</span><span class="s2">=</span><span class="s1">fp</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">fmt </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;raw&quot;</span><span class="s2">, </span><span class="s3">&quot;svg&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ps&quot;</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_find_noto</span><span class="s2">():</span>
    <span class="s1">fp </span><span class="s2">= </span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s3">&quot;Noto Sans CJK SC&quot;</span><span class="s2">, </span><span class="s3">&quot;Noto Sans CJK JP&quot;</span><span class="s2">])</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)).</span><span class="s1">name</span>
    <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">&quot;NotoSansCJKsc-Regular.otf&quot;</span><span class="s2">, </span><span class="s3">&quot;NotoSansCJK-Regular.ttc&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f&quot;Noto Sans CJK SC font may be missing (found </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s3">'Hello, 你好'</span><span class="s2">, </span><span class="s1">fontproperties</span><span class="s2">=</span><span class="s1">fp</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">fmt </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;raw&quot;</span><span class="s2">, </span><span class="s3">&quot;svg&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ps&quot;</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_find_invalid</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">):</span>
        <span class="s1">get_font</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">'non-existent-font-name.ttf'</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">):</span>
        <span class="s1">get_font</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">'non-existent-font-name.ttf'</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">):</span>
        <span class="s1">get_font</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">'non-existent-font-name.ttf'</span><span class="s2">))</span>

    <span class="s4"># Not really public, but get_font doesn't expose non-filename constructor.</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">ft2font </span><span class="s0">import </span><span class="s1">FT2Font</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'font file or a binary-mode file'</span><span class="s2">):</span>
        <span class="s1">FT2Font</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">())  </span><span class="s4"># type: ignore[arg-type]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s3">'linux' </span><span class="s0">or not </span><span class="s1">has_fclist</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s3">'only Linux with fontconfig installed'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_user_fonts_linux</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">font_test_file </span><span class="s2">= </span><span class="s3">'mpltest.ttf'</span>

    <span class="s4"># Precondition: the test font should not be available</span>
    <span class="s1">fonts </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">font_test_file </span><span class="s0">in </span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">font_test_file</span><span class="s0">} </span><span class="s3">already exists in system fonts'</span><span class="s2">)</span>

    <span class="s4"># Prepare a temporary user font directory</span>
    <span class="s1">user_fonts_dir </span><span class="s2">= </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'fonts'</span><span class="s2">)</span>
    <span class="s1">user_fonts_dir</span><span class="s2">.</span><span class="s1">ensure</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s1">font_test_file</span><span class="s2">,</span>
                    <span class="s1">user_fonts_dir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">font_test_file</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">context</span><span class="s2">() </span><span class="s0">as </span><span class="s1">m</span><span class="s2">:</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s3">'XDG_DATA_HOME'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">))</span>
        <span class="s1">_get_fontconfig_fonts</span><span class="s2">.</span><span class="s1">cache_clear</span><span class="s2">()</span>
        <span class="s4"># Now, the font should be available</span>
        <span class="s1">fonts </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">font_test_file </span><span class="s0">in </span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">)</span>

    <span class="s4"># Make sure the temporary directory is no longer cached.</span>
    <span class="s1">_get_fontconfig_fonts</span><span class="s2">.</span><span class="s1">cache_clear</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_addfont_as_path</span><span class="s2">():</span>
    <span class="s7">&quot;&quot;&quot;Smoke test that addfont() accepts pathlib.Path.&quot;&quot;&quot;</span>
    <span class="s1">font_test_file </span><span class="s2">= </span><span class="s3">'mpltest.ttf'</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s1">font_test_file</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">addfont</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">added</span><span class="s2">, = [</span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span>
                  <span class="s0">if </span><span class="s1">font</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">font_test_file</span><span class="s2">)]</span>
        <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">added</span><span class="s2">)</span>
    <span class="s0">finally</span><span class="s2">:</span>
        <span class="s1">to_remove </span><span class="s2">= [</span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span>
                     <span class="s0">if </span><span class="s1">font</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">font_test_file</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">to_remove</span><span class="s2">:</span>
            <span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">font</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s3">'win32'</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">'Windows only'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_user_fonts_win32</span><span class="s2">():</span>
    <span class="s0">if not </span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'APPVEYOR'</span><span class="s2">) </span><span class="s0">or </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'TF_BUILD'</span><span class="s2">)):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s3">&quot;This test should only run on CI (appveyor or azure) &quot;</span>
                     <span class="s3">&quot;as the developer's font directory should remain &quot;</span>
                     <span class="s3">&quot;unchanged.&quot;</span><span class="s2">)</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s3">&quot;We need to update the registry for this test to work&quot;</span><span class="s2">)</span>
    <span class="s1">font_test_file </span><span class="s2">= </span><span class="s3">'mpltest.ttf'</span>

    <span class="s4"># Precondition: the test font should not be available</span>
    <span class="s1">fonts </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">font_test_file </span><span class="s0">in </span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f'</span><span class="s0">{</span><span class="s1">font_test_file</span><span class="s0">} </span><span class="s3">already exists in system fonts'</span><span class="s2">)</span>

    <span class="s1">user_fonts_dir </span><span class="s2">= </span><span class="s1">MSUserFontDirectories</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s4"># Make sure that the user font directory exists (this is probably not the</span>
    <span class="s4"># case on Windows versions &lt; 1809)</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">user_fonts_dir</span><span class="s2">)</span>

    <span class="s4"># Copy the test font to the user font directory</span>
    <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s1">font_test_file</span><span class="s2">, </span><span class="s1">user_fonts_dir</span><span class="s2">)</span>

    <span class="s4"># Now, the font should be available</span>
    <span class="s1">fonts </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">font_test_file </span><span class="s0">in </span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_model_handler</span><span class="s2">(</span><span class="s1">_</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pdf&quot;</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">os</span><span class="s2">, </span><span class="s3">&quot;register_at_fork&quot;</span><span class="s2">),</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Cannot register at_fork handlers&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fork</span><span class="s2">():</span>
    <span class="s1">_model_handler</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)  </span><span class="s4"># Make sure the font cache is filled.</span>
    <span class="s1">ctx </span><span class="s2">= </span><span class="s1">multiprocessing</span><span class="s2">.</span><span class="s1">get_context</span><span class="s2">(</span><span class="s3">&quot;fork&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">Pool</span><span class="s2">(</span><span class="s1">processes</span><span class="s2">=</span><span class="s5">2</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pool</span><span class="s2">:</span>
        <span class="s1">pool</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s1">_model_handler</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_missing_family</span><span class="s2">(</span><span class="s1">caplog</span><span class="s2">):</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;font.sans-serif&quot;</span><span class="s2">] = [</span><span class="s3">&quot;this-font-does-not-exist&quot;</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">at_level</span><span class="s2">(</span><span class="s3">&quot;WARNING&quot;</span><span class="s2">):</span>
        <span class="s1">findfont</span><span class="s2">(</span><span class="s3">&quot;sans&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">getMessage</span><span class="s2">() </span><span class="s0">for </span><span class="s1">rec </span><span class="s0">in </span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">records</span><span class="s2">] == [</span>
        <span class="s3">&quot;findfont: Font family ['sans'] not found. &quot;</span>
        <span class="s3">&quot;Falling back to DejaVu Sans.&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;findfont: Generic family 'sans' not found because none of the &quot;</span>
        <span class="s3">&quot;following families were found: this-font-does-not-exist&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>


<span class="s0">def </span><span class="s1">_test_threading</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">threading</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">ft2font </span><span class="s0">import </span><span class="s1">LOAD_NO_HINTING</span>
    <span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">font_manager </span><span class="s0">as </span><span class="s1">fm</span>

    <span class="s1">N </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Barrier</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bad_idea</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">100</span><span class="s2">):</span>
            <span class="s1">font </span><span class="s2">= </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s3">&quot;DejaVu Sans&quot;</span><span class="s2">))</span>
            <span class="s1">font</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">LOAD_NO_HINTING</span><span class="s2">)</span>

    <span class="s1">threads </span><span class="s2">= [</span>
        <span class="s1">threading</span><span class="s2">.</span><span class="s1">Thread</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">bad_idea</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">f&quot;bad_thread_</span><span class="s0">{</span><span class="s1">j</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">j</span><span class="s2">,))</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">join</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_fontcache_thread_safe</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">'threading'</span><span class="s2">)</span>

    <span class="s1">subprocess_run_helper</span><span class="s2">(</span><span class="s1">_test_threading</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_lockfilefailure</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s4"># The logic here:</span>
    <span class="s4"># 1. get a temp directory from pytest</span>
    <span class="s4"># 2. import matplotlib which makes sure it exists</span>
    <span class="s4"># 3. get the cache dir (where we check it is writable)</span>
    <span class="s4"># 4. make it not writable</span>
    <span class="s4"># 5. try to write into it via font manager</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">subprocess_run_for_testing</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">,</span>
            <span class="s3">&quot;-c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;import matplotlib;&quot;</span>
            <span class="s3">&quot;import os;&quot;</span>
            <span class="s3">&quot;p = matplotlib.get_cachedir();&quot;</span>
            <span class="s3">&quot;os.chmod(p, 0o555);&quot;</span>
            <span class="s3">&quot;import matplotlib.font_manager;&quot;</span>
        <span class="s2">],</span>
        <span class="s1">env</span><span class="s2">={**</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">, </span><span class="s3">'MPLCONFIGDIR'</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">)},</span>
        <span class="s1">check</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_fontentry_dataclass</span><span class="s2">():</span>
    <span class="s1">fontent </span><span class="s2">= </span><span class="s1">FontEntry</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">'font-name'</span><span class="s2">)</span>

    <span class="s1">png </span><span class="s2">= </span><span class="s1">fontent</span><span class="s2">.</span><span class="s1">_repr_png_</span><span class="s2">()</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">png</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">width </span><span class="s2">&gt; </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">img</span><span class="s2">.</span><span class="s1">height </span><span class="s2">&gt; </span><span class="s5">0</span>

    <span class="s1">html </span><span class="s2">= </span><span class="s1">fontent</span><span class="s2">.</span><span class="s1">_repr_html_</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;&lt;img src=</span><span class="s0">\&quot;</span><span class="s3">data:image/png;base64&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_fontentry_dataclass_invalid_path</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">):</span>
        <span class="s1">fontent </span><span class="s2">= </span><span class="s1">FontEntry</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">=</span><span class="s3">'/random'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">'font-name'</span><span class="s2">)</span>
        <span class="s1">fontent</span><span class="s2">.</span><span class="s1">_repr_html_</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win32'</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">'Linux or OS only'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_get_font_names</span><span class="s2">():</span>
    <span class="s1">paths_mpl </span><span class="s2">= [</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_get_data_path</span><span class="s2">(</span><span class="s3">'fonts'</span><span class="s2">, </span><span class="s1">subdir</span><span class="s2">) </span><span class="s0">for </span><span class="s1">subdir </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'ttf'</span><span class="s2">]]</span>
    <span class="s1">fonts_mpl </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">(</span><span class="s1">paths_mpl</span><span class="s2">, </span><span class="s1">fontext</span><span class="s2">=</span><span class="s3">'ttf'</span><span class="s2">)</span>
    <span class="s1">fonts_system </span><span class="s2">= </span><span class="s1">findSystemFonts</span><span class="s2">(</span><span class="s1">fontext</span><span class="s2">=</span><span class="s3">'ttf'</span><span class="s2">)</span>
    <span class="s1">ttf_fonts </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">fonts_mpl </span><span class="s2">+ </span><span class="s1">fonts_system</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">font </span><span class="s2">= </span><span class="s1">ft2font</span><span class="s2">.</span><span class="s1">FT2Font</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">prop </span><span class="s2">= </span><span class="s1">ttfFontProperty</span><span class="s2">(</span><span class="s1">font</span><span class="s2">)</span>
            <span class="s1">ttf_fonts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
            <span class="s0">pass</span>
    <span class="s1">available_fonts </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">ttf_fonts</span><span class="s2">)))</span>
    <span class="s1">mpl_font_names </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">get_font_names</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">available_fonts</span><span class="s2">) == </span><span class="s1">set</span><span class="s2">(</span><span class="s1">mpl_font_names</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">available_fonts</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">mpl_font_names</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">available_fonts </span><span class="s2">== </span><span class="s1">mpl_font_names</span>


<span class="s0">def </span><span class="s1">test_donot_cache_tracebacks</span><span class="s2">():</span>

    <span class="s0">class </span><span class="s1">SomeObject</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">inner</span><span class="s2">():</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">SomeObject</span><span class="s2">()</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">mfigure</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">()</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s3">'aardvark'</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=</span><span class="s3">'doesnotexist'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">out</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">'ignore'</span><span class="s2">)</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'raw'</span><span class="s2">)</span>

    <span class="s1">inner</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_objects</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">SomeObject</span><span class="s2">):</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">&quot;object from inner stack still alive&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>