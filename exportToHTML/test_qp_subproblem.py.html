<html>
<head>
<title>test_qp_subproblem.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_qp_subproblem.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse </span><span class="s0">import </span><span class="s1">csc_matrix</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_trustregion_constr</span><span class="s2">.</span><span class="s1">qp_subproblem \</span>
    <span class="s0">import </span><span class="s2">(</span><span class="s1">eqp_kktfact</span><span class="s2">,</span>
            <span class="s1">projected_cg</span><span class="s2">,</span>
            <span class="s1">box_intersections</span><span class="s2">,</span>
            <span class="s1">sphere_intersections</span><span class="s2">,</span>
            <span class="s1">box_sphere_intersections</span><span class="s2">,</span>
            <span class="s1">modified_dogleg</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_trustregion_constr</span><span class="s2">.</span><span class="s1">projections \</span>
    <span class="s0">import </span><span class="s1">projections</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">TestCase</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_equal</span>
<span class="s0">import </span><span class="s1">pytest</span>


<span class="s0">class </span><span class="s1">TestEQPDirectFactorization</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s3"># From Example 16.2 Nocedal/Wright &quot;Numerical</span>
    <span class="s3"># Optimization&quot; p.452.</span>
    <span class="s0">def </span><span class="s1">test_nocedal_example</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">8</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">lagrange_multipliers </span><span class="s2">= </span><span class="s1">eqp_kktfact</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">lagrange_multipliers</span><span class="s2">, [</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestSphericalBoundariesIntersections</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_2d_sphere_constraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Interior inicial point</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># No intersection between line and circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Outside initial point pointing toward outside the circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Outside initial point pointing toward inside the circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">1.5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_sphere_constraints_line_intersections</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Interior initial point</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">0.5</span><span class="s2">,</span>
                                                 <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># No intersection between line and circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">,</span>
                                                 <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Outside initial point pointing toward outside the circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">,</span>
                                                 <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Outside initial point pointing toward inside the circle</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">1.5</span><span class="s2">,</span>
                                                 <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                                                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                 <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBoxBoundariesIntersections</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Box constraint in the direction of vector d</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Negative direction</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Some constraints are absent (set to +/- inf)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Intersect on the face of the box</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Interior initial point</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># No intersection between line and box constraints</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0.99</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                                         <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints_entire_line</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Box constraint in the direction of vector d</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Negative direction</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">1.5</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Some constraints are absent (set to +/- inf)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Intersect on the face of the box</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Interior initial pointoint</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># No intersection between line and box constraints</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">3</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">0.99</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3d_box_constraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Simple case</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Negative direction</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Interior point</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3d_box_constraints_entire_line</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Simple case</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Negative direction</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Interior point</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                                              <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBoxSphereBoundariesIntersections</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Both constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># None of the constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">10</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Box constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">10</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Spherical constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Infeasible problems</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints_entire_line</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Both constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># None of the constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">10</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Box constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">10</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Spherical constraints are active</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">([</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># Infeasible problems</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ta</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">, </span><span class="s1">intersect </span><span class="s2">= </span><span class="s1">box_sphere_intersections</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                                                     <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s4">2</span><span class="s2">,</span>
                                                     <span class="s1">entire_line</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">intersect</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestModifiedDogleg</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_cauchypoint_equalsto_newtonpoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">16</span><span class="s2">])</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">newton_point </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.24615385</span><span class="s2">, </span><span class="s4">1.96923077</span><span class="s2">])</span>

        <span class="s3"># Newton point inside boundaries</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">newton_point</span><span class="s2">)</span>

        <span class="s3"># Spherical constraint active</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">newton_point</span><span class="s2">/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">newton_point</span><span class="s2">))</span>

        <span class="s3"># Box constraints active</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s1">newton_point</span><span class="s2">/</span><span class="s1">newton_point</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) * </span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3d_example</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">16</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">LS</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>

        <span class="s1">newton_point </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">1.37090909</span><span class="s2">, </span><span class="s4">2.23272727</span><span class="s2">, -</span><span class="s4">0.49090909</span><span class="s2">])</span>
        <span class="s1">cauchy_point </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.11165723</span><span class="s2">, </span><span class="s4">1.73068711</span><span class="s2">, </span><span class="s4">0.16748585</span><span class="s2">])</span>
        <span class="s1">origin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">newton_point</span><span class="s2">)</span>

        <span class="s3"># newton_point inside boundaries</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">newton_point</span><span class="s2">)</span>

        <span class="s3"># line between cauchy_point and newton_point contains best point</span>
        <span class="s3"># (spherical constraint is active).</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">cauchy_point</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">newton_point</span><span class="s2">-</span><span class="s1">cauchy_point</span>
        <span class="s1">t </span><span class="s2">= ((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.40807330</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>

        <span class="s3"># line between cauchy_point and newton_point contains best point</span>
        <span class="s3"># (box constraint is active).</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">cauchy_point</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">newton_point</span><span class="s2">-</span><span class="s1">cauchy_point</span>
        <span class="s1">t </span><span class="s2">= ((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.7498195</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], -</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s3"># line between origin and cauchy_point contains best point</span>
        <span class="s3"># (spherical constraint is active).</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">origin</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cauchy_point</span>
        <span class="s1">t </span><span class="s2">= ((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.573936265</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s3"># line between origin and newton_point contains best point</span>
        <span class="s3"># (box constraint is active).</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">modified_dogleg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">origin</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">newton_point</span>
        <span class="s1">t </span><span class="s2">= ((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.4478827364</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestProjectCG</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s3"># From Example 16.2 Nocedal/Wright &quot;Numerical</span>
    <span class="s3"># Optimization&quot; p.452.</span>
    <span class="s0">def </span><span class="s1">test_nocedal_example</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">8</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_compare_with_direct_fact</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">x_kkt</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">eqp_kktfact</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x_kkt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_trust_region_infeasible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_trust_region_barely_feasible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">2.32379000772445021283</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">trust_radius</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, -</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_hits_boundary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">trust_radius</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_curvature_unconstrained</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_curvature</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">1000</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">trust_radius</span><span class="s2">)</span>

    <span class="s3"># The box constraints are inactive at the solution but</span>
    <span class="s3"># are active during the iterations.</span>
    <span class="s0">def </span><span class="s1">test_inactive_box_constraints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">lb</span><span class="s2">=[</span><span class="s4">0.5</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                                   <span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                               <span class="s1">return_all</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">x_kkt</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">eqp_kktfact</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x_kkt</span><span class="s2">)</span>

    <span class="s3"># The box constraints active and the termination is</span>
    <span class="s3"># by maximum iterations (infeasible interaction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_maximum_iterations_reached</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">lb</span><span class="s2">=[</span><span class="s4">0.8</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                                   <span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                               <span class="s1">return_all</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), -</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0.8</span><span class="s2">)</span>

    <span class="s3"># The box constraints are active and the termination is</span>
    <span class="s3"># because it hits boundary (without infeasible interaction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_hits_boundaries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">ub</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">,</span>
                               <span class="s1">return_all</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s4">1.6</span><span class="s2">)</span>

    <span class="s3"># The box constraints are active and the termination is</span>
    <span class="s3"># because it hits boundary (infeasible interaction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_hits_boundaries_infeasible_iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">4</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">ub</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">,</span>
                               <span class="s1">return_all</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s3"># The box constraints are active and the termination is</span>
    <span class="s3"># because it hits boundary (no infeasible interaction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_negative_curvature</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">H </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">csc_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">Z</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">projections</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">trust_radius </span><span class="s2">= </span><span class="s4">1000</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">projected_cg</span><span class="s2">(</span><span class="s1">H</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">,</span>
                               <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
                               <span class="s1">ub</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                               <span class="s1">trust_radius</span><span class="s2">=</span><span class="s1">trust_radius</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;stop_cond&quot;</span><span class="s2">], </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">info</span><span class="s2">[</span><span class="s5">&quot;hits_boundary&quot;</span><span class="s2">], </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s4">100</span><span class="s2">)</span>
</pre>
</body>
</html>