<html>
<head>
<title>test_subclassing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_subclassing.py</font>
</center></td></tr></table>
<pre><span class="s0"># pylint: disable-msg=W0611, W0612, W0511,R0201</span>
<span class="s2">&quot;&quot;&quot;Tests suite for MaskedArray &amp; subclassing. 
 
:author: Pierre Gerard-Marchant 
:contact: pierregm_at_uga_dot_edu 
:version: $Id: test_subclassing.py 3473 2007-10-29 15:18:13Z jarrod.millman $ 
 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">lib</span><span class="s4">.</span><span class="s1">mixins </span><span class="s3">import </span><span class="s1">NDArrayOperatorsMixin</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">testing </span><span class="s3">import </span><span class="s1">assert_</span><span class="s4">, </span><span class="s1">assert_raises</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">testutils </span><span class="s3">import </span><span class="s1">assert_equal</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">array</span><span class="s4">, </span><span class="s1">arange</span><span class="s4">, </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">, </span><span class="s1">masked_array</span><span class="s4">, </span><span class="s1">log</span><span class="s4">, </span><span class="s1">add</span><span class="s4">, </span><span class="s1">hypot</span><span class="s4">,</span>
    <span class="s1">divide</span><span class="s4">, </span><span class="s1">asarray</span><span class="s4">, </span><span class="s1">asanyarray</span><span class="s4">, </span><span class="s1">nomask</span>
    <span class="s4">)</span>
<span class="s0"># from numpy.ma.core import (</span>

<span class="s3">def </span><span class="s1">assert_startswith</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">):</span>
    <span class="s0"># produces a better error message than assert_(a.startswith(b))</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">a</span><span class="s4">[:</span><span class="s1">len</span><span class="s4">(</span><span class="s1">b</span><span class="s4">)], </span><span class="s1">b</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">SubArray</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">):</span>
    <span class="s0"># Defines a generic np.ndarray subclass, that stores some metadata</span>
    <span class="s0"># in the  dictionary `info`.</span>
    <span class="s3">def </span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">,</span><span class="s1">arr</span><span class="s4">,</span><span class="s1">info</span><span class="s4">={}):</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">asanyarray</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">).</span><span class="s1">view</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">.</span><span class="s1">info </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">x</span>

    <span class="s3">def </span><span class="s1">__array_finalize__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__array_finalize__</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">info </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s5">'info'</span><span class="s4">, {}).</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s3">return</span>

    <span class="s3">def </span><span class="s1">__add__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__add__</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>
        <span class="s1">result</span><span class="s4">.</span><span class="s1">info</span><span class="s4">[</span><span class="s5">'added'</span><span class="s4">] = </span><span class="s1">result</span><span class="s4">.</span><span class="s1">info</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'added'</span><span class="s4">, </span><span class="s6">0</span><span class="s4">) + </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s3">def </span><span class="s1">__iadd__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__iadd__</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>
        <span class="s1">result</span><span class="s4">.</span><span class="s1">info</span><span class="s4">[</span><span class="s5">'iadded'</span><span class="s4">] = </span><span class="s1">result</span><span class="s4">.</span><span class="s1">info</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'iadded'</span><span class="s4">, </span><span class="s6">0</span><span class="s4">) + </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">result</span>


<span class="s1">subarray </span><span class="s4">= </span><span class="s1">SubArray</span>


<span class="s3">class </span><span class="s1">SubMaskedArray</span><span class="s4">(</span><span class="s1">MaskedArray</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Pure subclass of MaskedArray, keeping some info on subclass.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">info</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">obj </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s1">obj</span><span class="s4">.</span><span class="s1">_optinfo</span><span class="s4">[</span><span class="s5">'info'</span><span class="s4">] = </span><span class="s1">info</span>
        <span class="s3">return </span><span class="s1">obj</span>


<span class="s3">class </span><span class="s1">MSubArray</span><span class="s4">(</span><span class="s1">SubArray</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">info</span><span class="s4">={}, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">nomask</span><span class="s4">):</span>
        <span class="s1">subarr </span><span class="s4">= </span><span class="s1">SubArray</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">info</span><span class="s4">)</span>
        <span class="s1">_data </span><span class="s4">= </span><span class="s1">MaskedArray</span><span class="s4">.</span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">subarr</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">mask</span><span class="s4">)</span>
        <span class="s1">_data</span><span class="s4">.</span><span class="s1">info </span><span class="s4">= </span><span class="s1">subarr</span><span class="s4">.</span><span class="s1">info</span>
        <span class="s3">return </span><span class="s1">_data</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">_series</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">_view </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">MaskedArray</span><span class="s4">)</span>
        <span class="s1">_view</span><span class="s4">.</span><span class="s1">_sharedmask </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">return </span><span class="s1">_view</span>

<span class="s1">msubarray </span><span class="s4">= </span><span class="s1">MSubArray</span>


<span class="s0"># Also a subclass that overrides __str__, __repr__ and __setitem__, disallowing</span>
<span class="s0"># setting to non-class values (and thus np.ma.core.masked_print_option)</span>
<span class="s0"># and overrides __array_wrap__, updating the info dict, to check that this</span>
<span class="s0"># doesn't get destroyed by MaskedArray._update_from.  But this one also needs</span>
<span class="s0"># its own iterator...</span>
<span class="s3">class </span><span class="s1">CSAIterator</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot; 
    Flat iterator object that uses its own setter/getter 
    (works around ndarray.flat not propagating subclass setters/getters 
    see https://github.com/numpy/numpy/issues/4564) 
    roughly following MaskedIterator 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">a</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_original </span><span class="s4">= </span><span class="s1">a</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dataiter </span><span class="s4">= </span><span class="s1">a</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">).</span><span class="s1">flat</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">indx</span><span class="s4">):</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_dataiter</span><span class="s4">.</span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">indx</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">):</span>
            <span class="s1">out </span><span class="s4">= </span><span class="s1">out</span><span class="s4">.</span><span class="s1">__array__</span><span class="s4">()</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">out</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_original</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">out</span>

    <span class="s3">def </span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dataiter</span><span class="s4">[</span><span class="s1">index</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_original</span><span class="s4">.</span><span class="s1">_validate_input</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__next__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">next</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_dataiter</span><span class="s4">).</span><span class="s1">__array__</span><span class="s4">().</span><span class="s1">view</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_original</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">ComplicatedSubArray</span><span class="s4">(</span><span class="s1">SubArray</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">f'myprefix </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">SubArray</span><span class="s4">)</span><span class="s3">} </span><span class="s5">mypostfix'</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Return a repr that does not start with 'name('</span>
        <span class="s3">return </span><span class="s5">f'&lt;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">} {</span><span class="s1">self</span><span class="s3">}</span><span class="s5">&gt;'</span>

    <span class="s3">def </span><span class="s1">_validate_input</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Can only set to MySubArray values&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">item</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s0"># validation ensures direct assignment with ndarray or</span>
        <span class="s0"># masked_print_option will fail</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">item</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_validate_input</span><span class="s4">(</span><span class="s1">value</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
        <span class="s0"># ensure getter returns our own class also for scalars</span>
        <span class="s1">value </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">):  </span><span class="s0"># scalar</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">__array__</span><span class="s4">().</span><span class="s1">view</span><span class="s4">(</span><span class="s1">ComplicatedSubArray</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">flat</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">CSAIterator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">flat</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">flat</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ravel</span><span class="s4">()</span>
        <span class="s1">y</span><span class="s4">[:] = </span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">__array_wrap__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">, </span><span class="s1">context</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">return_scalar</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
        <span class="s1">obj </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__array_wrap__</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">context</span><span class="s4">, </span><span class="s1">return_scalar</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">context </span><span class="s3">is not None and </span><span class="s1">context</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">is </span><span class="s1">np</span><span class="s4">.</span><span class="s1">multiply</span><span class="s4">:</span>
            <span class="s1">obj</span><span class="s4">.</span><span class="s1">info</span><span class="s4">[</span><span class="s5">'multiplied'</span><span class="s4">] = </span><span class="s1">obj</span><span class="s4">.</span><span class="s1">info</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'multiplied'</span><span class="s4">, </span><span class="s6">0</span><span class="s4">) + </span><span class="s6">1</span>

        <span class="s3">return </span><span class="s1">obj</span>


<span class="s3">class </span><span class="s1">WrappedArray</span><span class="s4">(</span><span class="s1">NDArrayOperatorsMixin</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Wrapping a MaskedArray rather than subclassing to test that 
    ufunc deferrals are commutative. 
    See: https://github.com/numpy/numpy/issues/15200) 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s4">= (</span><span class="s5">'_array'</span><span class="s4">, </span><span class="s5">'attrs'</span><span class="s4">)</span>
    <span class="s1">__array_priority__ </span><span class="s4">= </span><span class="s6">20</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, **</span><span class="s1">attrs</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_array </span><span class="s4">= </span><span class="s1">array</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attrs </span><span class="s4">= </span><span class="s1">attrs</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">(</span><span class="s3">\n{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_array</span><span class="s3">}\n{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">attrs</span><span class="s3">}\n</span><span class="s5">)&quot;</span>

    <span class="s3">def </span><span class="s1">__array__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">copy</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_array</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__array_ufunc__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">ufunc</span><span class="s4">, </span><span class="s1">method</span><span class="s4">, *</span><span class="s1">inputs</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">method </span><span class="s4">== </span><span class="s5">'__call__'</span><span class="s4">:</span>
            <span class="s1">inputs </span><span class="s4">= [</span><span class="s1">arg</span><span class="s4">.</span><span class="s1">_array </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">) </span><span class="s3">else </span><span class="s1">arg</span>
                      <span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">inputs</span><span class="s4">]</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">(</span><span class="s1">ufunc</span><span class="s4">(*</span><span class="s1">inputs</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">), **</span><span class="s1">self</span><span class="s4">.</span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">NotImplemented</span>


<span class="s3">class </span><span class="s1">TestSubclassing</span><span class="s4">:</span>
    <span class="s0"># Test suite for masked subclasses of ndarray.</span>

    <span class="s3">def </span><span class="s1">setup_method</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'float'</span><span class="s4">)</span>
        <span class="s1">mx </span><span class="s4">= </span><span class="s1">msubarray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= (</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_data_subclassing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests whether the subclass is kept.</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">m </span><span class="s4">= [</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">xsub </span><span class="s4">= </span><span class="s1">SubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">xmsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">m</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">xmsub</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">xmsub</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">xsub</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">xmsub</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">SubArray</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_maskedarray_subclassing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests subclassing MaskedArray</span>
        <span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">subarray</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_masked_unary_operations</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests masked_unary_operation</span>
        <span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s3">with </span><span class="s1">np</span><span class="s4">.</span><span class="s1">errstate</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">=</span><span class="s5">'ignore'</span><span class="s4">):</span>
            <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">log</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">log</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_masked_binary_operations</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests masked_binary_operation</span>
        <span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s0"># Result should be a msubarray</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">add</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">add</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">x</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s0"># Result should work</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">add</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">x</span><span class="s4">), </span><span class="s1">mx</span><span class="s4">+</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">add</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">).</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">subarray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">add</span><span class="s4">.</span><span class="s1">outer</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">hypot</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">hypot</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">x</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_masked_binary_operations2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests domained_masked_binary_operation</span>
        <span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">xmx </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">__array__</span><span class="s4">(), </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">mx</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">x</span><span class="s4">), </span><span class="s1">msubarray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">, </span><span class="s1">mx</span><span class="s4">), </span><span class="s1">divide</span><span class="s4">(</span><span class="s1">xmx</span><span class="s4">, </span><span class="s1">xmx</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_attributepropagation</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">array</span><span class="s4">(</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">), </span><span class="s1">mask</span><span class="s4">=[</span><span class="s6">0</span><span class="s4">]+[</span><span class="s6">1</span><span class="s4">]*</span><span class="s6">4</span><span class="s4">)</span>
        <span class="s1">my </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">subarray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))</span>
        <span class="s1">ym </span><span class="s4">= </span><span class="s1">msubarray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s1">z </span><span class="s4">= (</span><span class="s1">my</span><span class="s4">+</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">SubArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">z</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">info</span><span class="s4">, {})</span>
        <span class="s0">#</span>
        <span class="s1">z </span><span class="s4">= (</span><span class="s1">ym</span><span class="s4">+</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">z</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">SubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">z</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">info</span><span class="s4">[</span><span class="s5">'added'</span><span class="s4">] &gt; </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s0"># Test that inplace methods from data get used (gh-4617)</span>
        <span class="s1">ym </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">SubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">info</span><span class="s4">[</span><span class="s5">'iadded'</span><span class="s4">] &gt; </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s1">ym</span><span class="s4">.</span><span class="s1">_set_mask</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">])</span>
        <span class="s1">ym</span><span class="s4">.</span><span class="s1">_series</span><span class="s4">.</span><span class="s1">_set_mask</span><span class="s4">([</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ym</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">])</span>
        <span class="s0">#</span>
        <span class="s1">xsub </span><span class="s4">= </span><span class="s1">subarray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">info</span><span class="s4">={</span><span class="s5">'name'</span><span class="s4">:</span><span class="s5">'x'</span><span class="s4">})</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s5">'info'</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">, </span><span class="s1">xsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_subclasspreservation</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Checks that masked_array(...,subok=True) preserves the class.</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">m </span><span class="s4">= [</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">xinfo </span><span class="s4">= [(</span><span class="s1">i</span><span class="s4">, </span><span class="s1">j</span><span class="s4">) </span><span class="s3">for </span><span class="s4">(</span><span class="s1">i</span><span class="s4">, </span><span class="s1">j</span><span class="s4">) </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)]</span>
        <span class="s1">xsub </span><span class="s4">= </span><span class="s1">MSubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">m</span><span class="s4">, </span><span class="s1">info</span><span class="s4">={</span><span class="s5">'xsub'</span><span class="s4">:</span><span class="s1">xinfo</span><span class="s4">})</span>
        <span class="s0">#</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">, </span><span class="s1">subok</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">, </span><span class="s1">subok</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">, </span><span class="s1">xsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">xsub</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">asanyarray</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">, </span><span class="s1">MSubArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">, </span><span class="s1">xsub</span><span class="s4">.</span><span class="s1">info</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_subclass_items</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;test that getter and setter go via baseclass&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">xcsub </span><span class="s4">= </span><span class="s1">ComplicatedSubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">mxcsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s0"># getter should  return a ComplicatedSubArray, even for single item</span>
        <span class="s0"># first check we wrote ComplicatedSubArray correctly</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">,...], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>

        <span class="s0"># now that it propagates inside the MaskedArray</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">,...].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">is </span><span class="s1">masked</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">0</span><span class="s4">,...].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>

        <span class="s0"># also for flattened version (which goes via MaskedIterator)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">is </span><span class="s1">masked</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">].</span><span class="s1">base</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>

        <span class="s0"># setter should only work with ComplicatedSubArray input</span>
        <span class="s0"># first check we wrote ComplicatedSubArray correctly</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">xcsub</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s1">x</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s0"># now that it propagates inside the MaskedArray</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s1">x</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">4</span><span class="s4">), </span><span class="s1">x</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]</span>
        <span class="s1">mxcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">] = </span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">]</span>
        <span class="s0"># also for flattened version (which goes via MaskedIterator)</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s1">x</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">4</span><span class="s4">), </span><span class="s1">x</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]</span>
        <span class="s1">mxcsub</span><span class="s4">.</span><span class="s1">flat</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">] = </span><span class="s1">xcsub</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">4</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_subclass_nomask_items</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">xcsub </span><span class="s4">= </span><span class="s1">ComplicatedSubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">mxcsub_nomask </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">)</span>

        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub_nomask</span><span class="s4">[</span><span class="s6">1</span><span class="s4">,...].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub_nomask</span><span class="s4">[</span><span class="s6">0</span><span class="s4">,...].</span><span class="s1">data</span><span class="s4">, </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>

        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub_nomask</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mxcsub_nomask</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">ComplicatedSubArray</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_subclass_repr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;test that repr uses the name of the subclass 
        and 'array' for np.ndarray&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">mx </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">assert_startswith</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">mx</span><span class="s4">), </span><span class="s5">'masked_array'</span><span class="s4">)</span>
        <span class="s1">xsub </span><span class="s4">= </span><span class="s1">SubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">assert_startswith</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">),</span>
            <span class="s5">f'masked_</span><span class="s3">{</span><span class="s1">SubArray</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">(data=[--, 1, --, 3, 4]'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_subclass_str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;test str with subclass that has overridden str, setitem&quot;&quot;&quot;</span>
        <span class="s0"># first without override</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">xsub </span><span class="s4">= </span><span class="s1">SubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">mxsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xsub</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">mxsub</span><span class="s4">), </span><span class="s5">'[-- 1 -- 3 4]'</span><span class="s4">)</span>

        <span class="s1">xcsub </span><span class="s4">= </span><span class="s1">ComplicatedSubArray</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">xcsub</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">, </span><span class="s6">0</span><span class="s4">,</span>
                      <span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">masked_print_option</span><span class="s4">)</span>
        <span class="s1">mxcsub </span><span class="s4">= </span><span class="s1">masked_array</span><span class="s4">(</span><span class="s1">xcsub</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">mxcsub</span><span class="s4">), </span><span class="s5">'myprefix [-- 1 -- 3 4] mypostfix'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pure_subclass_info_preservation</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test that ufuncs and methods conserve extra information consistently;</span>
        <span class="s0"># see gh-7122.</span>
        <span class="s1">arr1 </span><span class="s4">= </span><span class="s1">SubMaskedArray</span><span class="s4">(</span><span class="s5">'test'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=[</span><span class="s6">1</span><span class="s4">,</span><span class="s6">2</span><span class="s4">,</span><span class="s6">3</span><span class="s4">,</span><span class="s6">4</span><span class="s4">,</span><span class="s6">5</span><span class="s4">,</span><span class="s6">6</span><span class="s4">])</span>
        <span class="s1">arr2 </span><span class="s4">= </span><span class="s1">SubMaskedArray</span><span class="s4">(</span><span class="s1">data</span><span class="s4">=[</span><span class="s6">0</span><span class="s4">,</span><span class="s6">1</span><span class="s4">,</span><span class="s6">2</span><span class="s4">,</span><span class="s6">3</span><span class="s4">,</span><span class="s6">4</span><span class="s4">,</span><span class="s6">5</span><span class="s4">])</span>
        <span class="s1">diff1 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">subtract</span><span class="s4">(</span><span class="s1">arr1</span><span class="s4">, </span><span class="s1">arr2</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s5">'info' </span><span class="s3">in </span><span class="s1">diff1</span><span class="s4">.</span><span class="s1">_optinfo</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">diff1</span><span class="s4">.</span><span class="s1">_optinfo</span><span class="s4">[</span><span class="s5">'info'</span><span class="s4">] == </span><span class="s5">'test'</span><span class="s4">)</span>
        <span class="s1">diff2 </span><span class="s4">= </span><span class="s1">arr1 </span><span class="s4">- </span><span class="s1">arr2</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s5">'info' </span><span class="s3">in </span><span class="s1">diff2</span><span class="s4">.</span><span class="s1">_optinfo</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">diff2</span><span class="s4">.</span><span class="s1">_optinfo</span><span class="s4">[</span><span class="s5">'info'</span><span class="s4">] == </span><span class="s5">'test'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">ArrayNoInheritance</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Quantity-like class that does not inherit from ndarray&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">units</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">magnitude </span><span class="s4">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">units </span><span class="s4">= </span><span class="s1">units</span>

    <span class="s3">def </span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">magnitude</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_array_no_inheritance</span><span class="s4">():</span>
    <span class="s1">data_masked </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">])</span>
    <span class="s1">data_masked_units </span><span class="s4">= </span><span class="s1">ArrayNoInheritance</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">, </span><span class="s5">'meters'</span><span class="s4">)</span>

    <span class="s0"># Get the masked representation of the Quantity-like class</span>
    <span class="s1">new_array </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data_masked_units</span><span class="s4">)</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
    <span class="s0"># Test sharing the mask</span>
    <span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">]</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
    <span class="s1">assert_</span><span class="s4">(</span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">sharedmask</span><span class="s4">)</span>

    <span class="s0"># Get the masked representation of the Quantity-like class</span>
    <span class="s1">new_array </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data_masked_units</span><span class="s4">, </span><span class="s1">copy</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
    <span class="s0"># Test that the mask is not shared when copy=True</span>
    <span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">]</span>
    <span class="s1">assert_equal</span><span class="s4">([</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">], </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
    <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">sharedmask</span><span class="s4">)</span>

    <span class="s0"># Get the masked representation of the Quantity-like class</span>
    <span class="s1">new_array </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data_masked_units</span><span class="s4">, </span><span class="s1">keep_mask</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>
    <span class="s0"># The change did not affect the original mask</span>
    <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">data_masked</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">])</span>
    <span class="s0"># Test that the mask is False and not shared when keep_mask=False</span>
    <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">)</span>
    <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">new_array</span><span class="s4">.</span><span class="s1">sharedmask</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestClassWrapping</span><span class="s4">:</span>
    <span class="s0"># Test suite for classes that wrap MaskedArrays</span>

    <span class="s3">def </span><span class="s1">setup_method</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">masked_array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">3</span><span class="s4">, </span><span class="s6">5</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">wm </span><span class="s4">= </span><span class="s1">WrappedArray</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= (</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_masked_unary_operations</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests masked_unary_operation</span>
        <span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s3">with </span><span class="s1">np</span><span class="s4">.</span><span class="s1">errstate</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">=</span><span class="s5">'ignore'</span><span class="s4">):</span>
            <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_masked_binary_operations</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests masked_binary_operation</span>
        <span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s0"># Result should be a WrappedArray</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s0"># add and '+' should call the same ufunc</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">m </span><span class="s4">+ </span><span class="s1">wm</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">hypot</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">hypot</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s0"># Test domained binary operations</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m</span><span class="s4">) * </span><span class="s1">m</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">m</span><span class="s4">) * </span><span class="s1">wm</span><span class="s4">)</span>
        <span class="s0"># Test broadcasting</span>
        <span class="s1">m2 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">stack</span><span class="s4">([</span><span class="s1">m</span><span class="s4">, </span><span class="s1">m</span><span class="s4">])</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">m2</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">WrappedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">m2</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">divide</span><span class="s4">(</span><span class="s1">wm</span><span class="s4">, </span><span class="s1">m2</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_mixins_have_slots</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">mixin </span><span class="s4">= </span><span class="s1">NDArrayOperatorsMixin</span><span class="s4">()</span>
        <span class="s0"># Should raise an error</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">mixin</span><span class="s4">.</span><span class="s1">__setattr__</span><span class="s4">, </span><span class="s5">&quot;not_a_real_attr&quot;</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>

        <span class="s1">m </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">masked_array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">3</span><span class="s4">, </span><span class="s6">5</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">wm </span><span class="s4">= </span><span class="s1">WrappedArray</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
        <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">wm</span><span class="s4">.</span><span class="s1">__setattr__</span><span class="s4">, </span><span class="s5">&quot;not_an_attr&quot;</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
</pre>
</body>
</html>