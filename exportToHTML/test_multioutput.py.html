<html>
<head>
<title>test_multioutput.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_multioutput.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">joblib </span><span class="s0">import </span><span class="s1">cpu_count</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">datasets</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">ClassifierMixin</span><span class="s2">, </span><span class="s1">clone</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">load_linnerud</span><span class="s2">,</span>
    <span class="s1">make_classification</span><span class="s2">,</span>
    <span class="s1">make_multilabel_classification</span><span class="s2">,</span>
    <span class="s1">make_regression</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">dummy </span><span class="s0">import </span><span class="s1">DummyClassifier</span><span class="s2">, </span><span class="s1">DummyRegressor</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">GradientBoostingRegressor</span><span class="s2">,</span>
    <span class="s1">RandomForestClassifier</span><span class="s2">,</span>
    <span class="s1">StackingRegressor</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">NotFittedError</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">impute </span><span class="s0">import </span><span class="s1">SimpleImputer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Lasso</span><span class="s2">,</span>
    <span class="s1">LinearRegression</span><span class="s2">,</span>
    <span class="s1">LogisticRegression</span><span class="s2">,</span>
    <span class="s1">OrthogonalMatchingPursuit</span><span class="s2">,</span>
    <span class="s1">PassiveAggressiveClassifier</span><span class="s2">,</span>
    <span class="s1">Ridge</span><span class="s2">,</span>
    <span class="s1">SGDClassifier</span><span class="s2">,</span>
    <span class="s1">SGDRegressor</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">jaccard_score</span><span class="s2">, </span><span class="s1">mean_squared_error</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">GridSearchCV</span><span class="s2">, </span><span class="s1">train_test_split</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">multiclass </span><span class="s0">import </span><span class="s1">OneVsRestClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">multioutput </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ClassifierChain</span><span class="s2">,</span>
    <span class="s1">MultiOutputClassifier</span><span class="s2">,</span>
    <span class="s1">MultiOutputRegressor</span><span class="s2">,</span>
    <span class="s1">RegressorChain</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">svm </span><span class="s0">import </span><span class="s1">LinearSVC</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">tree </span><span class="s0">import </span><span class="s1">DecisionTreeClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">shuffle</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">COO_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">DOK_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">LIL_CONTAINERS</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_target_regression</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">]</span>
    <span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s3">50</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">[</span><span class="s3">50</span><span class="s2">:]</span>

    <span class="s1">references </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s1">rgr </span><span class="s2">= </span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">[:, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">references</span><span class="s2">[:, </span><span class="s1">n</span><span class="s2">] = </span><span class="s1">rgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">references</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_target_regression_partial_fit</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">]</span>
    <span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s3">50</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">[</span><span class="s3">50</span><span class="s2">:]</span>

    <span class="s1">references </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">y_test</span><span class="s2">)</span>
    <span class="s1">half_index </span><span class="s2">= </span><span class="s3">25</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s1">sgr </span><span class="s2">= </span><span class="s1">SGDRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">sgr</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">], </span><span class="s1">y_train</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">sgr</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:], </span><span class="s1">y_train</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">references</span><span class="s2">[:, </span><span class="s1">n</span><span class="s2">] = </span><span class="s1">sgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">sgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">SGDRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">))</span>

    <span class="s1">sgr</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">], </span><span class="s1">y_train</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">])</span>
    <span class="s1">sgr</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:], </span><span class="s1">y_train</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:])</span>

    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">sgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">references</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">Lasso</span><span class="s2">), </span><span class="s4">&quot;partial_fit&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_target_regression_one_target</span><span class="s2">():</span>
    <span class="s5"># Test multi target regression raises</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;at least two dimensions&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;sparse_container&quot;</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">COO_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">LIL_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">DOK_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">BSR_CONTAINERS</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multi_target_sparse_regression</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s3">50</span><span class="s2">]</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s3">50</span><span class="s2">:]</span>

    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">Lasso</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">rgr_sparse </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">Lasso</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>

    <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">rgr_sparse</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">), </span><span class="s1">y_train</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">rgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">rgr_sparse</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_target_sample_weights_api</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3.141</span><span class="s2">, </span><span class="s3">2.718</span><span class="s2">], [</span><span class="s3">2.718</span><span class="s2">, </span><span class="s3">3.141</span><span class="s2">]]</span>
    <span class="s1">w </span><span class="s2">= [</span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">]</span>

    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">OrthogonalMatchingPursuit</span><span class="s2">())</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;does not support sample weights&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s5"># no exception should be raised if the base estimator supports weights</span>
    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_target_sample_weight_partial_fit</span><span class="s2">():</span>
    <span class="s5"># weighted regressor</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3.141</span><span class="s2">, </span><span class="s3">2.718</span><span class="s2">], [</span><span class="s3">2.718</span><span class="s2">, </span><span class="s3">3.141</span><span class="s2">]]</span>
    <span class="s1">w </span><span class="s2">= [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">rgr_w </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">SGDRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">))</span>
    <span class="s1">rgr_w</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s5"># weighted with different weights</span>
    <span class="s1">w </span><span class="s2">= [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]</span>
    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">SGDRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">))</span>
    <span class="s1">rgr</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">rgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">0</span><span class="s2">] != </span><span class="s1">rgr_w</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_multi_target_sample_weights</span><span class="s2">():</span>
    <span class="s5"># weighted regressor</span>
    <span class="s1">Xw </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">yw </span><span class="s2">= [[</span><span class="s3">3.141</span><span class="s2">, </span><span class="s3">2.718</span><span class="s2">], [</span><span class="s3">2.718</span><span class="s2">, </span><span class="s3">3.141</span><span class="s2">]]</span>
    <span class="s1">w </span><span class="s2">= [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">rgr_w </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">rgr_w</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xw</span><span class="s2">, </span><span class="s1">yw</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s5"># unweighted, but with repeated samples</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3.141</span><span class="s2">, </span><span class="s3">2.718</span><span class="s2">], [</span><span class="s3">3.141</span><span class="s2">, </span><span class="s3">2.718</span><span class="s2">], [</span><span class="s3">2.718</span><span class="s2">, </span><span class="s3">3.141</span><span class="s2">]]</span>
    <span class="s1">rgr </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s1">rgr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">], [</span><span class="s3">3.5</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">, </span><span class="s3">5.5</span><span class="s2">]]</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">rgr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">rgr_w</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>


<span class="s5"># Import the data</span>
<span class="s1">iris </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">()</span>
<span class="s5"># create a multiple targets by randomized shuffling and concatenating y.</span>
<span class="s1">X </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span>
<span class="s1">y1 </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span>
<span class="s1">y2 </span><span class="s2">= </span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
<span class="s1">y3 </span><span class="s2">= </span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
<span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">((</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">y3</span><span class="s2">))</span>
<span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span>
<span class="s1">n_outputs </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
<span class="s1">n_classes </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">))</span>
<span class="s1">classes </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">, (</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">y3</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification_partial_fit_parallelism</span><span class="s2">():</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">loss</span><span class="s2">=</span><span class="s4">&quot;log_loss&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">mor </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">, </span><span class="s1">n_jobs</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
    <span class="s1">mor</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">)</span>
    <span class="s1">est1 </span><span class="s2">= </span><span class="s1">mor</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">mor</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">est2 </span><span class="s2">= </span><span class="s1">mor</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">cpu_count</span><span class="s2">() &gt; </span><span class="s3">1</span><span class="s2">:</span>
        <span class="s5"># parallelism requires this to be the case for a sane implementation</span>
        <span class="s0">assert </span><span class="s1">est1 </span><span class="s0">is not </span><span class="s1">est2</span>


<span class="s5"># check multioutput has predict_proba</span>
<span class="s0">def </span><span class="s1">test_hasattr_multi_output_predict_proba</span><span class="s2">():</span>
    <span class="s5"># default SGDClassifier has loss='hinge'</span>
    <span class="s5"># which does not expose a predict_proba method</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">multi_target_linear</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>

    <span class="s5"># case where predict_proba attribute exists</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">loss</span><span class="s2">=</span><span class="s4">&quot;log_loss&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">multi_target_linear</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>


<span class="s5"># check predict_proba passes</span>
<span class="s0">def </span><span class="s1">test_multi_output_predict_proba</span><span class="s2">():</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">param </span><span class="s2">= {</span><span class="s4">&quot;loss&quot;</span><span class="s2">: (</span><span class="s4">&quot;hinge&quot;</span><span class="s2">, </span><span class="s4">&quot;log_loss&quot;</span><span class="s2">, </span><span class="s4">&quot;modified_huber&quot;</span><span class="s2">)}</span>

    <span class="s5"># inner function for custom scoring</span>
    <span class="s0">def </span><span class="s1">custom_scorer</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s3">1.0</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s3">0.0</span>

    <span class="s1">grid_clf </span><span class="s2">= </span><span class="s1">GridSearchCV</span><span class="s2">(</span>
        <span class="s1">sgd_linear_clf</span><span class="s2">,</span>
        <span class="s1">param_grid</span><span class="s2">=</span><span class="s1">param</span><span class="s2">,</span>
        <span class="s1">scoring</span><span class="s2">=</span><span class="s1">custom_scorer</span><span class="s2">,</span>
        <span class="s1">cv</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
        <span class="s1">error_score</span><span class="s2">=</span><span class="s4">&quot;raise&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">grid_clf</span><span class="s2">)</span>
    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s5"># SGDClassifier defaults to loss='hinge' which is not a probabilistic</span>
    <span class="s5"># loss function; therefore it does not expose a predict_proba method</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">inner2_msg </span><span class="s2">= </span><span class="s4">&quot;probability estimates are not available for loss='hinge'&quot;</span>
    <span class="s1">inner1_msg </span><span class="s2">= </span><span class="s4">&quot;'SGDClassifier' has no attribute 'predict_proba'&quot;</span>
    <span class="s1">outer_msg </span><span class="s2">= </span><span class="s4">&quot;'MultiOutputClassifier' has no attribute 'predict_proba'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">outer_msg</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exec_info</span><span class="s2">:</span>
        <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inner1_msg </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inner2_msg </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification_partial_fit</span><span class="s2">():</span>
    <span class="s5"># test if multi_target initializes correctly with base estimator and fit</span>
    <span class="s5"># assert predictions work as expected for predict</span>

    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">loss</span><span class="s2">=</span><span class="s4">&quot;log_loss&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>

    <span class="s5"># train the multi_target_linear and also get the predictions.</span>
    <span class="s1">half_index </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] // </span><span class="s3">2</span>
    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">)</span>

    <span class="s1">first_predictions </span><span class="s2">= </span><span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_outputs</span><span class="s2">) == </span><span class="s1">first_predictions</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:])</span>
    <span class="s1">second_predictions </span><span class="s2">= </span><span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_outputs</span><span class="s2">) == </span><span class="s1">second_predictions</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s5"># train the linear classification with each column and assert that</span>
    <span class="s5"># predictions are equal after first partial_fit and second partial_fit</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s5"># create a clone with the same state</span>
        <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
        <span class="s1">sgd_linear_clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">half_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">first_predictions</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">sgd_linear_clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">half_index</span><span class="s2">:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">second_predictions</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification_partial_fit_no_first_classes_exception</span><span class="s2">():</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">loss</span><span class="s2">=</span><span class="s4">&quot;log_loss&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">multi_target_linear </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;classes must be passed on the first call to partial_fit.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">multi_target_linear</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification</span><span class="s2">():</span>
    <span class="s5"># test if multi_target initializes correctly with base estimator and fit</span>
    <span class="s5"># assert predictions work as expected for predict, prodict_proba and score</span>

    <span class="s1">forest </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">multi_target_forest </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">forest</span><span class="s2">)</span>

    <span class="s5"># train the multi_target_forest and also get the predictions.</span>
    <span class="s1">multi_target_forest</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">predictions </span><span class="s2">= </span><span class="s1">multi_target_forest</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_outputs</span><span class="s2">) == </span><span class="s1">predictions</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s1">predict_proba </span><span class="s2">= </span><span class="s1">multi_target_forest</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">predict_proba</span><span class="s2">) == </span><span class="s1">n_outputs</span>
    <span class="s0">for </span><span class="s1">class_probabilities </span><span class="s0">in </span><span class="s1">predict_proba</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">) == </span><span class="s1">class_probabilities</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">(</span><span class="s1">predict_proba</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), </span><span class="s1">predictions</span><span class="s2">)</span>

    <span class="s5"># train the forest with each column and assert that predictions are equal</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s1">forest_ </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">forest</span><span class="s2">)  </span><span class="s5"># create a clone with the same state</span>
        <span class="s1">forest_</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">forest_</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">predictions</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">forest_</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">predict_proba</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>


<span class="s0">def </span><span class="s1">test_multiclass_multioutput_estimator</span><span class="s2">():</span>
    <span class="s5"># test to check meta of meta estimators</span>
    <span class="s1">svc </span><span class="s2">= </span><span class="s1">LinearSVC</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">multi_class_svc </span><span class="s2">= </span><span class="s1">OneVsRestClassifier</span><span class="s2">(</span><span class="s1">svc</span><span class="s2">)</span>
    <span class="s1">multi_target_svc </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">multi_class_svc</span><span class="s2">)</span>

    <span class="s1">multi_target_svc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">predictions </span><span class="s2">= </span><span class="s1">multi_target_svc</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_outputs</span><span class="s2">) == </span><span class="s1">predictions</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s5"># train the forest with each column and assert that predictions are equal</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s1">multi_class_svc_ </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">multi_class_svc</span><span class="s2">)  </span><span class="s5"># create a clone</span>
        <span class="s1">multi_class_svc_</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">multi_class_svc_</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">predictions</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_multiclass_multioutput_estimator_predict_proba</span><span class="s2">():</span>
    <span class="s1">seed </span><span class="s2">= </span><span class="s3">542</span>

    <span class="s5"># make test deterministic</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>

    <span class="s5"># random features</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))</span>

    <span class="s5"># random labels</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">]).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)  </span><span class="s5"># 2 classes</span>
    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;f&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">]).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)  </span><span class="s5"># 3 classes</span>

    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span>
        <span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">=</span><span class="s4">&quot;liblinear&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">y_result </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_actual </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">0.23481764</span><span class="s2">, </span><span class="s3">0.76518236</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.67196072</span><span class="s2">, </span><span class="s3">0.32803928</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.54681448</span><span class="s2">, </span><span class="s3">0.45318552</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.34883923</span><span class="s2">, </span><span class="s3">0.65116077</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.73687069</span><span class="s2">, </span><span class="s3">0.26312931</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">0.5171785</span><span class="s2">, </span><span class="s3">0.23878628</span><span class="s2">, </span><span class="s3">0.24403522</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.22141451</span><span class="s2">, </span><span class="s3">0.64102704</span><span class="s2">, </span><span class="s3">0.13755846</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.16751315</span><span class="s2">, </span><span class="s3">0.18256843</span><span class="s2">, </span><span class="s3">0.64991843</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.27357372</span><span class="s2">, </span><span class="s3">0.55201592</span><span class="s2">, </span><span class="s3">0.17441036</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0.65745193</span><span class="s2">, </span><span class="s3">0.26062899</span><span class="s2">, </span><span class="s3">0.08191907</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y_actual</span><span class="s2">)):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">y_result</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">y_actual</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification_sample_weights</span><span class="s2">():</span>
    <span class="s5"># weighted classifier</span>
    <span class="s1">Xw </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">yw </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]]</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">forest </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">clf_w </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">forest</span><span class="s2">)</span>
    <span class="s1">clf_w</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xw</span><span class="s2">, </span><span class="s1">yw</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s5"># unweighted, but with repeated samples</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]]</span>
    <span class="s1">forest </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">forest</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">], [</span><span class="s3">3.5</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">, </span><span class="s3">5.5</span><span class="s2">]]</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">clf_w</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_multi_output_classification_partial_fit_sample_weights</span><span class="s2">():</span>
    <span class="s5"># weighted classifier</span>
    <span class="s1">Xw </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">yw </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">20</span><span class="s2">)</span>
    <span class="s1">clf_w </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">clf_w</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xw</span><span class="s2">, </span><span class="s1">yw</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s5"># unweighted, but with repeated samples</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">sgd_linear_clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s3">20</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">sgd_linear_clf</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">clf_w</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_multi_output_exceptions</span><span class="s2">():</span>
    <span class="s5"># NotFittedError when fit is not done but score, predict and</span>
    <span class="s5"># and predict_proba are called</span>
    <span class="s1">moc </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">LinearSVC</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">moc</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># ValueError when number of outputs is different</span>
    <span class="s5"># for fit and score</span>
    <span class="s1">y_new </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">((</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">))</span>
    <span class="s1">moc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">moc</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_new</span><span class="s2">)</span>

    <span class="s5"># ValueError when y is continuous</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Unknown label type&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">moc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;response_method&quot;</span><span class="s2">, [</span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">, </span><span class="s4">&quot;predict&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_multi_output_not_fitted_error</span><span class="s2">(</span><span class="s1">response_method</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise the proper error when the estimator is not fitted&quot;&quot;&quot;</span>
    <span class="s1">moc </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">moc</span><span class="s2">, </span><span class="s1">response_method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multi_output_delegate_predict_proba</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check the behavior for the delegation of predict_proba to the underlying 
    estimator&quot;&quot;&quot;</span>

    <span class="s5"># A base estimator with `predict_proba`should expose the method even before fit</span>
    <span class="s1">moc </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">moc</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>
    <span class="s1">moc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">moc</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>

    <span class="s5"># A base estimator without `predict_proba` should raise an AttributeError</span>
    <span class="s1">moc </span><span class="s2">= </span><span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">LinearSVC</span><span class="s2">())</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">moc</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>

    <span class="s1">outer_msg </span><span class="s2">= </span><span class="s4">&quot;'MultiOutputClassifier' has no attribute 'predict_proba'&quot;</span>
    <span class="s1">inner_msg </span><span class="s2">= </span><span class="s4">&quot;'LinearSVC' object has no attribute 'predict_proba'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">outer_msg</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exec_info</span><span class="s2">:</span>
        <span class="s1">moc</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inner_msg </span><span class="s2">== </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>

    <span class="s1">moc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">moc</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">outer_msg</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exec_info</span><span class="s2">:</span>
        <span class="s1">moc</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inner_msg </span><span class="s2">== </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">():</span>
    <span class="s5"># Generate a multilabel data set from a multiclass dataset as a way of</span>
    <span class="s5"># by representing the integer number of the original class using a binary</span>
    <span class="s5"># encoding.</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">100</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s3">16</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
    <span class="s2">)</span>

    <span class="s1">Y_multi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">yyy</span><span class="s2">) </span><span class="s0">for </span><span class="s1">yyy </span><span class="s0">in </span><span class="s1">format</span><span class="s2">(</span><span class="s1">yy</span><span class="s2">, </span><span class="s4">&quot;#06b&quot;</span><span class="s2">)[</span><span class="s3">2</span><span class="s2">:]] </span><span class="s0">for </span><span class="s1">yy </span><span class="s0">in </span><span class="s1">y</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y_multi</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;chain_method&quot;</span><span class="s2">, [</span><span class="s4">&quot;predict&quot;</span><span class="s2">, </span><span class="s4">&quot;decision_function&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_classifier_chain_fit_and_predict_with_linear_svc</span><span class="s2">(</span><span class="s1">chain_method</span><span class="s2">):</span>
    <span class="s5"># Fit classifier chain and verify predict performance using LinearSVC</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">classifier_chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span>
        <span class="s1">LinearSVC</span><span class="s2">(),</span>
        <span class="s1">chain_method</span><span class="s2">=</span><span class="s1">chain_method</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">classifier_chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">Y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s1">Y_decision </span><span class="s2">= </span><span class="s1">classifier_chain</span><span class="s2">.</span><span class="s1">decision_function</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">Y_binary </span><span class="s2">= </span><span class="s1">Y_decision </span><span class="s2">&gt;= </span><span class="s3">0</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Y_binary</span><span class="s2">, </span><span class="s1">Y_pred</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">classifier_chain</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_classifier_chain_fit_and_predict_with_sparse_data</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s5"># Fit classifier chain with sparse data</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">X_sparse </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">classifier_chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">()).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred_sparse </span><span class="s2">= </span><span class="s1">classifier_chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">)</span>

    <span class="s1">classifier_chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">()).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred_dense </span><span class="s2">= </span><span class="s1">classifier_chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Y_pred_sparse</span><span class="s2">, </span><span class="s1">Y_pred_dense</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_classifier_chain_vs_independent_models</span><span class="s2">():</span>
    <span class="s5"># Verify that an ensemble of classifier chains (each of length</span>
    <span class="s5"># N) can achieve a higher Jaccard similarity score than N independent</span>
    <span class="s5"># models</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:</span><span class="s3">600</span><span class="s2">, :]</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s3">600</span><span class="s2">:, :]</span>
    <span class="s1">Y_train </span><span class="s2">= </span><span class="s1">Y</span><span class="s2">[:</span><span class="s3">600</span><span class="s2">, :]</span>
    <span class="s1">Y_test </span><span class="s2">= </span><span class="s1">Y</span><span class="s2">[</span><span class="s3">600</span><span class="s2">:, :]</span>

    <span class="s1">ovr </span><span class="s2">= </span><span class="s1">OneVsRestClassifier</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">())</span>
    <span class="s1">ovr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">Y_train</span><span class="s2">)</span>
    <span class="s1">Y_pred_ovr </span><span class="s2">= </span><span class="s1">ovr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">())</span>
    <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">Y_train</span><span class="s2">)</span>
    <span class="s1">Y_pred_chain </span><span class="s2">= </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">jaccard_score</span><span class="s2">(</span><span class="s1">Y_test</span><span class="s2">, </span><span class="s1">Y_pred_chain</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s4">&quot;samples&quot;</span><span class="s2">) &gt; </span><span class="s1">jaccard_score</span><span class="s2">(</span>
        <span class="s1">Y_test</span><span class="s2">, </span><span class="s1">Y_pred_ovr</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s4">&quot;samples&quot;</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;chain_method&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s4">&quot;predict&quot;</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">, </span><span class="s4">&quot;predict_log_proba&quot;</span><span class="s2">, </span><span class="s4">&quot;decision_function&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;response_method&quot;</span><span class="s2">, [</span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">, </span><span class="s4">&quot;predict_log_proba&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_classifier_chain_fit_and_predict</span><span class="s2">(</span><span class="s1">chain_method</span><span class="s2">, </span><span class="s1">response_method</span><span class="s2">):</span>
    <span class="s5"># Fit classifier chain and verify predict performance</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">(), </span><span class="s1">chain_method</span><span class="s2">=</span><span class="s1">chain_method</span><span class="s2">)</span>
    <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">Y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">c</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">.</span><span class="s1">size </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">] == </span><span class="s1">list</span><span class="s2">(</span>
        <span class="s1">range</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s2">)</span>

    <span class="s1">Y_prob </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">, </span><span class="s1">response_method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">response_method </span><span class="s2">== </span><span class="s4">&quot;predict_log_proba&quot;</span><span class="s2">:</span>
        <span class="s1">Y_prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">Y_prob</span><span class="s2">)</span>
    <span class="s1">Y_binary </span><span class="s2">= </span><span class="s1">Y_prob </span><span class="s2">&gt;= </span><span class="s3">0.5</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Y_binary</span><span class="s2">, </span><span class="s1">Y_pred</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">, </span><span class="s1">ClassifierMixin</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_regressor_chain_fit_and_predict</span><span class="s2">():</span>
    <span class="s5"># Fit regressor chain and verify Y and estimator coefficients shape</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">chain </span><span class="s2">= </span><span class="s1">RegressorChain</span><span class="s2">(</span><span class="s1">Ridge</span><span class="s2">())</span>
    <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">Y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">c</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">.</span><span class="s1">size </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">] == </span><span class="s1">list</span><span class="s2">(</span>
        <span class="s1">range</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_base_chain_fit_and_predict_with_sparse_data_and_cv</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s5"># Fit base chain with sparse data cross_val_predict</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s1">X_sparse </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">base_chains </span><span class="s2">= [</span>
        <span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">(), </span><span class="s1">cv</span><span class="s2">=</span><span class="s3">3</span><span class="s2">),</span>
        <span class="s1">RegressorChain</span><span class="s2">(</span><span class="s1">Ridge</span><span class="s2">(), </span><span class="s1">cv</span><span class="s2">=</span><span class="s3">3</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s0">for </span><span class="s1">chain </span><span class="s0">in </span><span class="s1">base_chains</span><span class="s2">:</span>
        <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_base_chain_random_order</span><span class="s2">():</span>
    <span class="s5"># Fit base chain with random order</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">chain </span><span class="s0">in </span><span class="s2">[</span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">()), </span><span class="s1">RegressorChain</span><span class="s2">(</span><span class="s1">Ridge</span><span class="s2">())]:</span>
        <span class="s1">chain_random </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">).</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s4">&quot;random&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">chain_random</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">chain_fixed </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">).</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">order_</span><span class="s2">)</span>
        <span class="s1">chain_fixed</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">chain_fixed</span><span class="s2">.</span><span class="s1">order_</span><span class="s2">, </span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">order_</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">order</span><span class="s2">) != </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">4</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">order_</span><span class="s2">) == </span><span class="s3">4</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">order_</span><span class="s2">)) == </span><span class="s3">4</span>
        <span class="s5"># Randomly ordered chain should behave identically to a fixed order</span>
        <span class="s5"># chain with the same order.</span>
        <span class="s0">for </span><span class="s1">est1</span><span class="s2">, </span><span class="s1">est2 </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">chain_random</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">, </span><span class="s1">chain_fixed</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">est1</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">est2</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;chain_type, chain_method&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;classifier&quot;</span><span class="s2">, </span><span class="s4">&quot;predict&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;classifier&quot;</span><span class="s2">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;classifier&quot;</span><span class="s2">, </span><span class="s4">&quot;predict_log_proba&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;classifier&quot;</span><span class="s2">, </span><span class="s4">&quot;decision_function&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;regressor&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_base_chain_crossval_fit_and_predict</span><span class="s2">(</span><span class="s1">chain_type</span><span class="s2">, </span><span class="s1">chain_method</span><span class="s2">):</span>
    <span class="s5"># Fit chain with cross_val_predict and verify predict</span>
    <span class="s5"># performance</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">generate_multilabel_dataset_with_correlations</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">chain_type </span><span class="s2">== </span><span class="s4">&quot;classifier&quot;</span><span class="s2">:</span>
        <span class="s1">chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">LogisticRegression</span><span class="s2">(), </span><span class="s1">chain_method</span><span class="s2">=</span><span class="s1">chain_method</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">chain </span><span class="s2">= </span><span class="s1">RegressorChain</span><span class="s2">(</span><span class="s1">Ridge</span><span class="s2">())</span>
    <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">chain_cv </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">).</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">cv</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">chain_cv</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred_cv </span><span class="s2">= </span><span class="s1">chain_cv</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">Y_pred_cv</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">Y_pred</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">Y_pred </span><span class="s2">== </span><span class="s1">Y_pred_cv</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">, </span><span class="s1">ClassifierChain</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">jaccard_score</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y_pred_cv</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s4">&quot;samples&quot;</span><span class="s2">) &gt; </span><span class="s3">0.4</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y_pred_cv</span><span class="s2">) &lt; </span><span class="s3">0.25</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">2</span><span class="s2">),</span>
        <span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)),</span>
        <span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multi_output_classes_</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
    <span class="s5"># Tests classes_ attribute of multioutput classifiers</span>
    <span class="s5"># RandomForestClassifier supports multioutput out-of-the-box</span>
    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">classes_</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">classes_</span><span class="s2">) == </span><span class="s1">n_outputs</span>
    <span class="s0">for </span><span class="s1">estimator_classes</span><span class="s2">, </span><span class="s1">expected_classes </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">classes</span><span class="s2">, </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">classes_</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">estimator_classes</span><span class="s2">, </span><span class="s1">expected_classes</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DummyRegressorWithFitParams</span><span class="s2">(</span><span class="s1">DummyRegressor</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">fit_params</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_fit_params </span><span class="s2">= </span><span class="s1">fit_params</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DummyClassifierWithFitParams</span><span class="s2">(</span><span class="s1">DummyClassifier</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">fit_params</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_fit_params </span><span class="s2">= </span><span class="s1">fit_params</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:`n_features_in_` is deprecated&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;estimator, dataset&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">MultiOutputClassifier</span><span class="s2">(</span><span class="s1">DummyClassifierWithFitParams</span><span class="s2">(</span><span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;prior&quot;</span><span class="s2">)),</span>
            <span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_multilabel_classification</span><span class="s2">(),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">DummyRegressorWithFitParams</span><span class="s2">()),</span>
            <span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multioutput_estimator_with_fit_params</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">dataset</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">dataset</span>
    <span class="s1">some_param </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">some_param</span><span class="s2">=</span><span class="s1">some_param</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">dummy_estimator </span><span class="s0">in </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s4">&quot;some_param&quot; </span><span class="s0">in </span><span class="s1">dummy_estimator</span><span class="s2">.</span><span class="s1">_fit_params</span>


<span class="s0">def </span><span class="s1">test_regressor_chain_w_fit_params</span><span class="s2">():</span>
    <span class="s5"># Make sure fit_params are properly propagated to the sub-estimators</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">weight </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s0">class </span><span class="s1">MySGD</span><span class="s2">(</span><span class="s1">SGDRegressor</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">fit_params</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sample_weight_ </span><span class="s2">= </span><span class="s1">fit_params</span><span class="s2">[</span><span class="s4">&quot;sample_weight&quot;</span><span class="s2">]</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">fit_params</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">RegressorChain</span><span class="s2">(</span><span class="s1">MySGD</span><span class="s2">())</span>

    <span class="s5"># Fitting with params</span>
    <span class="s1">fit_param </span><span class="s2">= {</span><span class="s4">&quot;sample_weight&quot;</span><span class="s2">: </span><span class="s1">weight</span><span class="s2">}</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">fit_param</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">est </span><span class="s0">in </span><span class="s1">model</span><span class="s2">.</span><span class="s1">estimators_</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">est</span><span class="s2">.</span><span class="s1">sample_weight_ </span><span class="s0">is </span><span class="s1">weight</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;MultiOutputEstimator, Estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s1">MultiOutputClassifier</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">), (</span><span class="s1">MultiOutputRegressor</span><span class="s2">, </span><span class="s1">Ridge</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s5"># FIXME: we should move this test in `estimator_checks` once we are able</span>
<span class="s5"># to construct meta-estimator instances</span>
<span class="s0">def </span><span class="s1">test_support_missing_values</span><span class="s2">(</span><span class="s1">MultiOutputEstimator</span><span class="s2">, </span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s5"># smoke test to check that pipeline MultioutputEstimators are letting</span>
    <span class="s5"># the validation of missing values to</span>
    <span class="s5"># the underlying pipeline, regressor or classifier</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">50</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">binomial</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, (</span><span class="s3">50</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=[</span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.99</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">SimpleImputer</span><span class="s2">(), </span><span class="s1">Estimator</span><span class="s2">())</span>
    <span class="s1">MultiOutputEstimator</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;order_type&quot;</span><span class="s2">, [</span><span class="s1">list</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_classifier_chain_tuple_order</span><span class="s2">(</span><span class="s1">order_type</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">order </span><span class="s2">= </span><span class="s1">order_type</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s1">chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span>
        <span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s1">order</span>
    <span class="s2">)</span>

    <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">y_test </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">y_test</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_classifier_chain_tuple_invalid_order</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">order </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">chain </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span><span class="s1">RandomForestClassifier</span><span class="s2">(), </span><span class="s1">order</span><span class="s2">=</span><span class="s1">order</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;invalid order&quot;</span><span class="s2">):</span>
        <span class="s1">chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_classifier_chain_verbose</span><span class="s2">(</span><span class="s1">capsys</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_multilabel_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">100</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
    <span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s1">pattern </span><span class="s2">= (</span>
        <span class="s4">r&quot;\[Chain\].*\(1 of 3\) Processing order 0, total=.*\n&quot;</span>
        <span class="s4">r&quot;\[Chain\].*\(2 of 3\) Processing order 1, total=.*\n&quot;</span>
        <span class="s4">r&quot;\[Chain\].*\(3 of 3\) Processing order 2, total=.*\n$&quot;</span>
    <span class="s2">)</span>

    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">ClassifierChain</span><span class="s2">(</span>
        <span class="s1">DecisionTreeClassifier</span><span class="s2">(),</span>
        <span class="s1">order</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
        <span class="s1">verbose</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">classifier</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">capsys</span><span class="s2">.</span><span class="s1">readouterr</span><span class="s2">()[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_regressor_chain_verbose</span><span class="s2">(</span><span class="s1">capsys</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s3">125</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s1">pattern </span><span class="s2">= (</span>
        <span class="s4">r&quot;\[Chain\].*\(1 of 3\) Processing order 1, total=.*\n&quot;</span>
        <span class="s4">r&quot;\[Chain\].*\(2 of 3\) Processing order 0, total=.*\n&quot;</span>
        <span class="s4">r&quot;\[Chain\].*\(3 of 3\) Processing order 2, total=.*\n$&quot;</span>
    <span class="s2">)</span>
    <span class="s1">regressor </span><span class="s2">= </span><span class="s1">RegressorChain</span><span class="s2">(</span>
        <span class="s1">LinearRegression</span><span class="s2">(),</span>
        <span class="s1">order</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
        <span class="s1">verbose</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">regressor</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">capsys</span><span class="s2">.</span><span class="s1">readouterr</span><span class="s2">()[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_multioutputregressor_ducktypes_fitted_estimator</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that MultiOutputRegressor checks the fitted estimator for 
    predict. Non-regression test for #16549.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">stacker </span><span class="s2">= </span><span class="s1">StackingRegressor</span><span class="s2">(</span>
        <span class="s1">estimators</span><span class="s2">=[(</span><span class="s4">&quot;sgd&quot;</span><span class="s2">, </span><span class="s1">SGDRegressor</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))],</span>
        <span class="s1">final_estimator</span><span class="s2">=</span><span class="s1">Ridge</span><span class="s2">(),</span>
        <span class="s1">cv</span><span class="s2">=</span><span class="s3">2</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">reg </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">stacker</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># Does not raise</span>
    <span class="s1">reg</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;Cls, method&quot;</span><span class="s2">, [(</span><span class="s1">ClassifierChain</span><span class="s2">, </span><span class="s4">&quot;fit&quot;</span><span class="s2">), (</span><span class="s1">MultiOutputClassifier</span><span class="s2">, </span><span class="s4">&quot;partial_fit&quot;</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fit_params_no_routing</span><span class="s2">(</span><span class="s1">Cls</span><span class="s2">, </span><span class="s1">method</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise an error when passing metadata not requested by the 
    underlying classifier. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s3">50</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">Cls</span><span class="s2">(</span><span class="s1">PassiveAggressiveClassifier</span><span class="s2">())</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;is only supported if&quot;</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">test</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multioutput_regressor_has_partial_fit</span><span class="s2">():</span>
    <span class="s5"># Test that an unfitted MultiOutputRegressor handles available_if for</span>
    <span class="s5"># partial_fit correctly</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">MultiOutputRegressor</span><span class="s2">(</span><span class="s1">LinearRegression</span><span class="s2">())</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;This 'MultiOutputRegressor' has no attribute 'partial_fit'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s4">&quot;partial_fit&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>