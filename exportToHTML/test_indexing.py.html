<html>
<head>
<title>test_indexing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_indexing.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">from </span><span class="s1">unittest </span><span class="s0">import </span><span class="s1">SkipTest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">sklearn</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">externals</span><span class="s2">.</span><span class="s1">_packaging</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">parse </span><span class="s0">as </span><span class="s1">parse_version</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">_safe_indexing</span><span class="s2">, </span><span class="s1">resample</span><span class="s2">, </span><span class="s1">shuffle</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s1">yield_namespace_device_dtype_combinations</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_indexing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_determine_key_type</span><span class="s2">,</span>
    <span class="s1">_get_column_indices</span><span class="s2">,</span>
    <span class="s1">_safe_assign</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_mocking </span><span class="s0">import </span><span class="s1">MockDataFrame</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_array_api_for_tests</span><span class="s2">,</span>
    <span class="s1">_convert_container</span><span class="s2">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">skip_if_array_api_compat_not_configured</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSC_CONTAINERS</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span>

<span class="s3"># toy array</span>
<span class="s1">X_toy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_polars_indexing</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Check _safe_indexing for polars as expected.&quot;&quot;&quot;</span>
    <span class="s1">pl </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;polars&quot;</span><span class="s2">, </span><span class="s1">minversion</span><span class="s2">=</span><span class="s6">&quot;0.18.2&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s6">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s6">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], </span><span class="s6">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]}, </span><span class="s1">orient</span><span class="s2">=</span><span class="s6">&quot;row&quot;</span>
    <span class="s2">)</span>

    <span class="s0">from </span><span class="s1">polars</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_frame_equal</span>

    <span class="s1">str_keys </span><span class="s2">= [[</span><span class="s6">&quot;b&quot;</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">], [</span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], [</span><span class="s6">&quot;c&quot;</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">]]</span>

    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">str_keys</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s1">bool_keys </span><span class="s2">= [([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]), ([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], [</span><span class="s6">&quot;c&quot;</span><span class="s2">])]</span>

    <span class="s0">for </span><span class="s1">bool_key</span><span class="s2">, </span><span class="s1">str_key </span><span class="s0">in </span><span class="s1">bool_keys</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">bool_key</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[:, </span><span class="s1">str_key</span><span class="s2">], </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s1">int_keys </span><span class="s2">= [([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">]), ([</span><span class="s4">2</span><span class="s2">], [</span><span class="s6">&quot;c&quot;</span><span class="s2">])]</span>

    <span class="s0">for </span><span class="s1">int_key</span><span class="s2">, </span><span class="s1">str_key </span><span class="s0">in </span><span class="s1">int_keys</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">int_key</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[:, </span><span class="s1">str_key</span><span class="s2">], </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s1">axis_0_keys </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">axis_0_keys</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">out</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;key, dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;0&quot;</span><span class="s2">, </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s6">&quot;bool&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">(</span><span class="s0">True</span><span class="s2">), </span><span class="s6">&quot;bool&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s6">&quot;0&quot;</span><span class="s2">, </span><span class="s6">&quot;1&quot;</span><span class="s2">, </span><span class="s6">&quot;2&quot;</span><span class="s2">], </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">((</span><span class="s6">&quot;0&quot;</span><span class="s2">, </span><span class="s6">&quot;1&quot;</span><span class="s2">, </span><span class="s6">&quot;2&quot;</span><span class="s2">), </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">), </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), </span><span class="s6">&quot;int&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s6">&quot;bool&quot;</span><span class="s2">),</span>
        <span class="s2">((</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), </span><span class="s6">&quot;bool&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]), </span><span class="s6">&quot;bool&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">], </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">((</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">), </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s6">&quot;begin&quot;</span><span class="s2">, </span><span class="s6">&quot;end&quot;</span><span class="s2">), </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]), </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">), </span><span class="s6">&quot;str&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_determine_key_type</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) == </span><span class="s1">dtype</span>


<span class="s0">def </span><span class="s1">test_determine_key_type_error</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No valid specification of the&quot;</span><span class="s2">):</span>
        <span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s4">1.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_determine_key_type_slice_error</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;Only array-like or scalar are&quot;</span><span class="s2">):</span>
        <span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">accept_slice</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">skip_if_array_api_compat_not_configured</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;array_namespace, device, dtype_name&quot;</span><span class="s2">, </span><span class="s1">yield_namespace_device_dtype_combinations</span><span class="s2">()</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_determine_key_type_array_api</span><span class="s2">(</span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span><span class="s2">):</span>
    <span class="s1">xp </span><span class="s2">= </span><span class="s1">_array_api_for_tests</span><span class="s2">(</span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">int_array_key </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s1">int_array_key</span><span class="s2">) == </span><span class="s6">&quot;int&quot;</span>

        <span class="s1">bool_array_key </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s1">bool_array_key</span><span class="s2">) == </span><span class="s6">&quot;bool&quot;</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">complex_array_key </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2j</span><span class="s2">, </span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3j</span><span class="s2">])</span>
        <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
            <span class="s3"># Complex numbers are not supported by all Array API libraries.</span>
            <span class="s1">complex_array_key </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">if </span><span class="s1">complex_array_key </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No valid specification of the&quot;</span><span class="s2">):</span>
                <span class="s1">_determine_key_type</span><span class="s2">(</span><span class="s1">complex_array_key</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;slice&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_container_axis_0</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">):</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">indices_type </span><span class="s2">== </span><span class="s6">&quot;slice&quot; </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s1">indices</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] += </span><span class="s4">1</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span>
        <span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;slice&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_1d_container</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">):</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">indices_type </span><span class="s2">== </span><span class="s6">&quot;slice&quot; </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s1">indices</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] += </span><span class="s4">1</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">array_type</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;slice&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices&quot;</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_container_axis_1</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">):</span>
    <span class="s3"># validation of the indices</span>
    <span class="s3"># we make a copy because indices is mutable and shared between tests</span>
    <span class="s1">indices_converted </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">indices_type </span><span class="s2">== </span><span class="s6">&quot;slice&quot; </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s1">indices_converted</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] += </span><span class="s4">1</span>

    <span class="s1">columns_name </span><span class="s2">= [</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">columns_name</span>
    <span class="s2">)</span>
    <span class="s1">indices_converted </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices_converted</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">str</span><span class="s2">) </span><span class="s0">and </span><span class="s1">array_type </span><span class="s0">not in </span><span class="s2">(</span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">):</span>
        <span class="s1">err_msg </span><span class="s2">= (</span>
            <span class="s6">&quot;Specifying the columns using strings is only supported for dataframes&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices_converted</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices_converted</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span>
            <span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">)</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_read_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_read_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;axis, expected_array&quot;</span><span class="s2">, [(</span><span class="s4">0</span><span class="s2">, [[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]]), (</span><span class="s4">1</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]])]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_read_only_axis_1</span><span class="s2">(</span>
    <span class="s1">array_read_only</span><span class="s2">, </span><span class="s1">indices_read_only</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">expected_array</span>
<span class="s2">):</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]])</span>
    <span class="s0">if </span><span class="s1">array_read_only</span><span class="s2">:</span>
        <span class="s1">array</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">indices_read_only</span><span class="s2">:</span>
        <span class="s1">indices</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">expected_array</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_1d_container_mask</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">):</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">] + [</span><span class="s0">True</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s0">False</span><span class="s2">] * </span><span class="s4">6</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">array_type</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;axis, expected_subset&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s4">0</span><span class="s2">, [[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]]), (</span><span class="s4">1</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]])],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_mask</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">expected_subset</span><span class="s2">):</span>
    <span class="s1">columns_name </span><span class="s2">= [</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">columns_name</span>
    <span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indices_type</span><span class="s2">)</span>

    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span>
        <span class="s1">subset</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">expected_subset</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;array_type, expected_output_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;list&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;polars&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_scalar_axis_0</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">expected_output_type</span><span class="s2">):</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s4">2</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">expected_array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">expected_output_type</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">expected_array</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_1d_scalar</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">):</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s4">2</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">subset </span><span class="s2">== </span><span class="s4">3</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;array_type, expected_output_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;polars&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_2d_scalar_axis_1</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">expected_output_type</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">):</span>
    <span class="s1">columns_name </span><span class="s2">= [</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]</span>
    <span class="s1">array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">columns_name</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s0">and </span><span class="s1">array_type </span><span class="s0">not in </span><span class="s2">(</span><span class="s6">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s6">&quot;polars&quot;</span><span class="s2">):</span>
        <span class="s1">err_msg </span><span class="s2">= (</span>
            <span class="s6">&quot;Specifying the columns using strings is only supported for dataframes&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected_output </span><span class="s2">= [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">expected_output_type </span><span class="s2">== </span><span class="s6">&quot;sparse&quot;</span><span class="s2">:</span>
            <span class="s3"># sparse matrix are keeping the 2D shape</span>
            <span class="s1">expected_output </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">]]</span>
        <span class="s1">expected_array </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">expected_output</span><span class="s2">, </span><span class="s1">expected_output_type</span><span class="s2">)</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">expected_array</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_None_axis_0</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">X_subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">X_subset</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_safe_indexing_pandas_no_matching_cols_error</span><span class="s2">():</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;No valid specification of the columns.&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X_toy</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, [</span><span class="s4">1.0</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;axis&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_error_axis</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;'axis' should be either 0&quot;</span><span class="s2">):</span>
        <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X_toy</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;X_constructor&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;series&quot;</span><span class="s2">, </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_1d_array_error</span><span class="s2">(</span><span class="s1">X_constructor</span><span class="s2">):</span>
    <span class="s3"># check that we are raising an error if the array-like passed is 1D and</span>
    <span class="s3"># we try to index on the 2nd dimension</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">X_constructor </span><span class="s2">== </span><span class="s6">&quot;array&quot;</span><span class="s2">:</span>
        <span class="s1">X_constructor </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">X_constructor </span><span class="s2">== </span><span class="s6">&quot;series&quot;</span><span class="s2">:</span>
        <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">)</span>
        <span class="s1">X_constructor </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">X_constructor </span><span class="s2">== </span><span class="s6">&quot;polars_series&quot;</span><span class="s2">:</span>
        <span class="s1">pl </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;polars&quot;</span><span class="s2">)</span>
        <span class="s1">X_constructor </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">values</span><span class="s2">=</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;'X' should be a 2D NumPy array, 2D sparse matrix or dataframe&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X_constructor</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_safe_indexing_container_axis_0_unsupported_type</span><span class="s2">():</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">]</span>
    <span class="s1">array </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]]</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;String indexing is not supported with 'axis=0'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_safe_indexing_pandas_no_settingwithcopy_warning</span><span class="s2">():</span>
    <span class="s3"># Using safe_indexing with an array-like indexer gives a copy of the</span>
    <span class="s3"># DataFrame -&gt; ensure it doesn't raise a warning if modified</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">pd_version </span><span class="s2">= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">)</span>
    <span class="s1">pd_base_version </span><span class="s2">= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">pd_version</span><span class="s2">.</span><span class="s1">base_version</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">pd_base_version </span><span class="s2">&gt;= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s6">&quot;3&quot;</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">SkipTest</span><span class="s2">(</span><span class="s6">&quot;SettingWithCopyWarning has been removed in pandas 3.0.0.dev&quot;</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s6">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s6">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]})</span>
    <span class="s1">subset </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">, </span><span class="s6">&quot;SettingWithCopyWarning&quot;</span><span class="s2">):</span>
        <span class="s1">SettingWithCopyWarning </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">errors</span><span class="s2">.</span><span class="s1">SettingWithCopyWarning</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># backward compatibility for pandas &lt; 1.5</span>
        <span class="s1">SettingWithCopyWarning </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">common</span><span class="s2">.</span><span class="s1">SettingWithCopyWarning</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s6">&quot;error&quot;</span><span class="s2">, </span><span class="s1">SettingWithCopyWarning</span><span class="s2">)</span>
        <span class="s1">subset</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">10</span>
    <span class="s3"># The original dataframe is unaffected by the assignment on the subset:</span>
    <span class="s0">assert </span><span class="s1">X</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;indices&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])])</span>
<span class="s0">def </span><span class="s1">test_safe_indexing_list_axis_1_unsupported</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that we raise a ValueError when axis=1 with input as list.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]]</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;axis=1 is not supported for lists&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;array&quot;</span><span class="s2">, </span><span class="s6">&quot;sparse&quot;</span><span class="s2">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_safe_assign</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that `_safe_assign` works as expected.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">X_array </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s1">row_indexer </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s1">values </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">row_indexer</span><span class="s2">), </span><span class="s1">X_array</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">_safe_assign</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">row_indexer</span><span class="s2">=</span><span class="s1">row_indexer</span><span class="s2">)</span>

    <span class="s1">assigned_portion </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">row_indexer</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span>
        <span class="s1">assigned_portion</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">column_indexer </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s1">values </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">column_indexer</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">_safe_assign</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">column_indexer</span><span class="s2">=</span><span class="s1">column_indexer</span><span class="s2">)</span>

    <span class="s1">assigned_portion </span><span class="s2">= </span><span class="s1">_safe_indexing</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">column_indexer</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span>
        <span class="s1">assigned_portion</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">row_indexer</span><span class="s2">, </span><span class="s1">column_indexer </span><span class="s2">= </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span>
    <span class="s1">values </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(*</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>
    <span class="s1">_safe_assign</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">column_indexer</span><span class="s2">=</span><span class="s1">column_indexer</span><span class="s2">)</span>

    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;key, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s6">r&quot;all features must be in \[0, 2\]&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;whatever&quot;</span><span class="s2">, </span><span class="s6">&quot;A given column is not a column of the dataframe&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">object</span><span class="s2">(), </span><span class="s6">&quot;No valid specification of the columns&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_get_column_indices_error</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X_toy</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s6">&quot;col_0&quot;</span><span class="s2">, </span><span class="s6">&quot;col_1&quot;</span><span class="s2">, </span><span class="s6">&quot;col_2&quot;</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_get_column_indices</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;key&quot;</span><span class="s2">, [[</span><span class="s6">&quot;col1&quot;</span><span class="s2">], [</span><span class="s6">&quot;col2&quot;</span><span class="s2">], [</span><span class="s6">&quot;col1&quot;</span><span class="s2">, </span><span class="s6">&quot;col2&quot;</span><span class="s2">], [</span><span class="s6">&quot;col1&quot;</span><span class="s2">, </span><span class="s6">&quot;col3&quot;</span><span class="s2">], [</span><span class="s6">&quot;col2&quot;</span><span class="s2">, </span><span class="s6">&quot;col3&quot;</span><span class="s2">]]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_get_column_indices_pandas_nonunique_columns_error</span><span class="s2">(</span><span class="s1">key</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">toy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s6">&quot;col1&quot;</span><span class="s2">, </span><span class="s6">&quot;col1&quot;</span><span class="s2">, </span><span class="s6">&quot;col2&quot;</span><span class="s2">, </span><span class="s6">&quot;col3&quot;</span><span class="s2">, </span><span class="s6">&quot;col2&quot;</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">toy</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;Selected columns, {}, are not unique in dataframe&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exc_info</span><span class="s2">:</span>
        <span class="s1">_get_column_indices</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exc_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">) == </span><span class="s1">err_msg</span>


<span class="s0">def </span><span class="s1">test_get_column_indices_interchange</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Check _get_column_indices for edge cases with the interchange&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s6">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">minversion</span><span class="s2">=</span><span class="s6">&quot;1.5&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s3"># Hide the fact that this is a pandas dataframe to trigger the dataframe protocol</span>
    <span class="s3"># code path.</span>
    <span class="s0">class </span><span class="s1">MockDataFrame</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_df </span><span class="s2">= </span><span class="s1">df</span>

        <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_df</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

    <span class="s1">df_mocked </span><span class="s2">= </span><span class="s1">MockDataFrame</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s1">key_results </span><span class="s2">= [</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), [</span><span class="s4">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]),</span>
        <span class="s2">([], []),</span>
    <span class="s2">]</span>
    <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">result </span><span class="s0">in </span><span class="s1">key_results</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">_get_column_indices</span><span class="s2">(</span><span class="s1">df_mocked</span><span class="s2">, </span><span class="s1">key</span><span class="s2">) == </span><span class="s1">result</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;A given column is not a column of the dataframe&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">_get_column_indices</span><span class="s2">(</span><span class="s1">df_mocked</span><span class="s2">, [</span><span class="s6">&quot;not_a_column&quot;</span><span class="s2">])</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;key.step must be 1 or None&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">_get_column_indices</span><span class="s2">(</span><span class="s1">df_mocked</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_resample</span><span class="s2">():</span>
    <span class="s3"># Border case not worth mentioning in doctests</span>
    <span class="s0">assert </span><span class="s1">resample</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s3"># Check that invalid arguments yield ValueError</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">resample</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

    <span class="s3"># Issue:6581, n_samples can be more when replace is True (default).</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">resample</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)) == </span><span class="s4">5</span>


<span class="s0">def </span><span class="s1">test_resample_stratified</span><span class="s2">():</span>
    <span class="s3"># Make sure resample can stratify</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s4">0.9</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">binomial</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s1">_</span><span class="s2">, </span><span class="s1">y_not_stratified </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">y_not_stratified </span><span class="s2">== </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">_</span><span class="s2">, </span><span class="s1">y_stratified </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">y_stratified </span><span class="s2">== </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">y_stratified</span><span class="s2">) == </span><span class="s4">9  </span><span class="s3"># all 1s, one 0</span>


<span class="s0">def </span><span class="s1">test_resample_stratified_replace</span><span class="s2">():</span>
    <span class="s3"># Make sure stratified resampling supports the replace parameter</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s1">X_replace</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span>
    <span class="s2">)</span>
    <span class="s1">X_no_replace</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">X_replace</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s4">50</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">X_no_replace</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s4">50</span>

    <span class="s3"># make sure n_samples can be greater than X.shape[0] if we sample with</span>
    <span class="s3"># replacement</span>
    <span class="s1">X_replace</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_replace</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s4">1000</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">X_replace</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s4">100</span>


<span class="s0">def </span><span class="s1">test_resample_stratify_2dy</span><span class="s2">():</span>
    <span class="s3"># Make sure y can be 2d when stratifying</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">2</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_resample_stratify_sparse_error</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3"># resample must be ndarray</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">stratify </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;Sparse data was passed&quot;</span><span class="s2">):</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">resample</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">stratify</span><span class="s2">=</span><span class="s1">stratify</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_shuffle_on_ndim_equals_three</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">to_tuple</span><span class="s2">(</span><span class="s1">A</span><span class="s2">):  </span><span class="s3"># to make the inner arrays hashable</span>
        <span class="s0">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">C</span><span class="s2">) </span><span class="s0">for </span><span class="s1">C </span><span class="s0">in </span><span class="s1">B</span><span class="s2">) </span><span class="s0">for </span><span class="s1">B </span><span class="s0">in </span><span class="s1">A</span><span class="s2">)</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], [[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]]])  </span><span class="s3"># A.shape = (2,2,2)</span>
    <span class="s1">S </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">to_tuple</span><span class="s2">(</span><span class="s1">A</span><span class="s2">))</span>
    <span class="s1">shuffle</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)  </span><span class="s3"># shouldn't raise a ValueError for dim = 3</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">to_tuple</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)) == </span><span class="s1">S</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;csc_container&quot;</span><span class="s2">, </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_shuffle_dont_convert_to_array</span><span class="s2">(</span><span class="s1">csc_container</span><span class="s2">):</span>
    <span class="s3"># Check that shuffle does not try to convert to numpy arrays with float</span>
    <span class="s3"># dtypes can let any indexable datastructure pass-through.</span>
    <span class="s1">a </span><span class="s2">= [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">MockDataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>
    <span class="s1">e </span><span class="s2">= </span><span class="s1">csc_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">a_s</span><span class="s2">, </span><span class="s1">b_s</span><span class="s2">, </span><span class="s1">c_s</span><span class="s2">, </span><span class="s1">d_s</span><span class="s2">, </span><span class="s1">e_s </span><span class="s2">= </span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">a_s </span><span class="s2">== [</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">a_s</span><span class="s2">) == </span><span class="s1">list  </span><span class="s3"># noqa: E721</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">b_s</span><span class="s2">, [</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">b_s</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>

    <span class="s0">assert </span><span class="s1">c_s </span><span class="s2">== [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">c_s</span><span class="s2">) == </span><span class="s1">list  </span><span class="s3"># noqa: E721</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d_s</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">d_s</span><span class="s2">) == </span><span class="s1">MockDataFrame  </span><span class="s3"># noqa: E721</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">e_s</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]))</span>
</pre>
</body>
</html>