<html>
<head>
<title>test_minpack.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_minpack.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Unit tests for optimization routines from minpack.py. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_array_equal</span><span class="s3">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">,</span>
                           <span class="s1">assert_warns</span><span class="s3">, </span><span class="s1">suppress_warnings</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">array</span><span class="s3">, </span><span class="s1">float64</span>
<span class="s2">from </span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">pool </span><span class="s2">import </span><span class="s1">ThreadPool</span>

<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">optimize</span><span class="s3">, </span><span class="s1">linalg</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special </span><span class="s2">import </span><span class="s1">lambertw</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">_minpack_py </span><span class="s2">import </span><span class="s1">leastsq</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s1">fixed_point</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">optimize </span><span class="s2">import </span><span class="s1">OptimizeWarning</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">_minimize </span><span class="s2">import </span><span class="s1">Bounds</span>


<span class="s2">class </span><span class="s1">ReturnShape</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;This class exists to create a callable that does not have a '__name__' attribute. 
 
    __init__ takes the argument 'shape', which should be a tuple of ints. 
    When an instance is called with a single argument 'x', it returns numpy.ones(shape). 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">= </span><span class="s1">shape</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">dummy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;A function that returns an array of ones of the given shape. 
    `x` is ignored. 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">sequence_parallel</span><span class="s3">(</span><span class="s1">fs</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">ThreadPool</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">fs</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">pool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">pool</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">f</span><span class="s3">: </span><span class="s1">f</span><span class="s3">(), </span><span class="s1">fs</span><span class="s3">)</span>


<span class="s4"># Function and Jacobian for tests of solvers for systems of nonlinear</span>
<span class="s4"># equations</span>


<span class="s2">def </span><span class="s1">pressure_network</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">, </span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Evaluate non-linear equation system representing 
    the pressures and flows in a system of n parallel pipes:: 
 
        f_i = P_i - P_0, for i = 1..n 
        f_0 = sum(Q_i) - Qtot 
 
    where Q_i is the flow rate in pipe i and P_i the pressure in that pipe. 
    Pressure is modeled as a P=kQ**2 where k is a valve coefficient and 
    Q is the flow rate. 
 
    Parameters 
    ---------- 
    flow_rates : float 
        A 1-D array of n flow rates [kg/s]. 
    k : float 
        A 1-D array of n valve coefficients [1/kg m]. 
    Qtot : float 
        A scalar, the total input flow rate [kg/s]. 
 
    Returns 
    ------- 
    F : float 
        A 1-D array, F[i] == f_i. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">P </span><span class="s3">= </span><span class="s1">k </span><span class="s3">* </span><span class="s1">flow_rates</span><span class="s3">**</span><span class="s5">2</span>
    <span class="s1">F </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">P</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:] - </span><span class="s1">P</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">flow_rates</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">() - </span><span class="s1">Qtot</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">F</span>


<span class="s2">def </span><span class="s1">pressure_network_jacobian</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">, </span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Return the jacobian of the equation system F(flow_rates) 
    computed by `pressure_network` with respect to 
    *flow_rates*. See `pressure_network` for the detailed 
    description of parameters. 
 
    Returns 
    ------- 
    jac : float 
        *n* by *n* matrix ``df_i/dQ_i`` where ``n = len(flow_rates)`` 
        and *f_i* and *Q_i* are described in the doc for `pressure_network` 
    &quot;&quot;&quot;</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">)</span>
    <span class="s1">pdiff </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:] * </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:] - </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">flow_rates</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] * </span><span class="s1">k</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

    <span class="s1">jac </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">jac</span><span class="s3">[:</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">, :</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">pdiff </span><span class="s3">* </span><span class="s5">0</span>
    <span class="s1">jac</span><span class="s3">[:</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">0</span>
    <span class="s1">jac</span><span class="s3">[</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">, :] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">jac</span>


<span class="s2">def </span><span class="s1">pressure_network_fun_and_grad</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">, </span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">pressure_network</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">, </span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
            <span class="s1">pressure_network_jacobian</span><span class="s3">(</span><span class="s1">flow_rates</span><span class="s3">, </span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestFSolve</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_pressure_network_no_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># fsolve without gradient, equal pipes -&gt; equal flows.</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">ier</span><span class="s3">, </span><span class="s1">mesg </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span>
            <span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
            <span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s3">== </span><span class="s5">1</span><span class="s3">, </span><span class="s1">mesg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pressure_network_with_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># fsolve with gradient, equal pipes -&gt; equal flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span>
            <span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
            <span class="s1">fprime</span><span class="s3">=</span><span class="s1">pressure_network_jacobian</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_func_callable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s4"># x0 is a list of two elements, but func will return an array with</span>
        <span class="s4"># length 1, so this should result in a TypeError.</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_func_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># x0 is a list of two elements, but func will return an array with</span>
        <span class="s4"># length 1, so this should result in a TypeError.</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">, </span><span class="s1">dummy_func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=((</span><span class="s5">1</span><span class="s3">,),))</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_fprime_callable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">deriv_func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">((</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">], </span><span class="s1">fprime</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_fprime_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">dummy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">,))</span>
        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">dummy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">], </span><span class="s1">fprime</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_func_can_raise</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s6">'I raised'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">'I raised'</span><span class="s3">):</span>
            <span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_Dfun_can_raise</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">10</span><span class="s3">])</span>

        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s6">'I raised'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">'I raised'</span><span class="s3">):</span>
            <span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">fprime</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s5">100</span><span class="s3">, </span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s5">1000</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">) ** </span><span class="s5">2</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">func</span><span class="s3">(</span><span class="s1">p</span><span class="s3">), [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reentrant_func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">test_pressure_network_no_gradient</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">pressure_network</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s4"># fsolve without gradient, equal pipes -&gt; equal flows.</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">ier</span><span class="s3">, </span><span class="s1">mesg </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
            <span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s3">== </span><span class="s5">1</span><span class="s3">, </span><span class="s1">mesg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reentrant_Dfunc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">test_pressure_network_with_gradient</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">pressure_network_jacobian</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s4"># fsolve with gradient, equal pipes -&gt; equal flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span>
            <span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
            <span class="s1">fprime</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_concurrent_no_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">sequence_parallel</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">test_pressure_network_no_gradient</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">result </span><span class="s2">is None for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">v</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_concurrent_with_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">sequence_parallel</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">test_pressure_network_with_gradient</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">result </span><span class="s2">is None for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">v</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">TestRootHybr</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_pressure_network_no_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># root/hybr without gradient, equal pipes -&gt; equal flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">root</span><span class="s3">(</span><span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">,</span>
                                    <span class="s1">method</span><span class="s3">=</span><span class="s6">'hybr'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)).</span><span class="s1">x</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_pressure_network_with_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># root/hybr with gradient, equal pipes -&gt; equal flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">root</span><span class="s3">(</span><span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">,</span>
                                    <span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">), </span><span class="s1">method</span><span class="s3">=</span><span class="s6">'hybr'</span><span class="s3">,</span>
                                    <span class="s1">jac</span><span class="s3">=</span><span class="s1">pressure_network_jacobian</span><span class="s3">).</span><span class="s1">x</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_pressure_network_with_gradient_combined</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># root/hybr with gradient and function combined, equal pipes -&gt; equal</span>
        <span class="s4"># flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">root</span><span class="s3">(</span><span class="s1">pressure_network_fun_and_grad</span><span class="s3">,</span>
                                    <span class="s1">initial_guess</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">),</span>
                                    <span class="s1">method</span><span class="s3">=</span><span class="s6">'hybr'</span><span class="s3">, </span><span class="s1">jac</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">x</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestRootLM</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_pressure_network_no_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># root/lm without gradient, equal pipes -&gt; equal flows</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">Qtot </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">initial_guess </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">final_flows </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">root</span><span class="s3">(</span><span class="s1">pressure_network</span><span class="s3">, </span><span class="s1">initial_guess</span><span class="s3">,</span>
                                    <span class="s1">method</span><span class="s3">=</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">Qtot</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)).</span><span class="s1">x</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">final_flows</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestNfev</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">zero_f</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s2">return </span><span class="s1">y</span><span class="s3">**</span><span class="s5">2</span><span class="s3">-</span><span class="s5">3</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'method'</span><span class="s3">, [</span><span class="s6">'hybr'</span><span class="s3">, </span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'broyden1'</span><span class="s3">,</span>
                                        <span class="s6">'broyden2'</span><span class="s3">, </span><span class="s6">'anderson'</span><span class="s3">,</span>
                                        <span class="s6">'linearmixing'</span><span class="s3">, </span><span class="s6">'diagbroyden'</span><span class="s3">,</span>
                                        <span class="s6">'excitingmixing'</span><span class="s3">, </span><span class="s6">'krylov'</span><span class="s3">,</span>
                                        <span class="s6">'df-sane'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_root_nfev</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">solution </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">root</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">zero_f</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">solution</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">nfev</span>

    <span class="s2">def </span><span class="s1">test_fsolve_nfev</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">info</span><span class="s3">, </span><span class="s1">ier</span><span class="s3">, </span><span class="s1">mesg </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">fsolve</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">zero_f</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">info</span><span class="s3">[</span><span class="s6">'nfev'</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">nfev</span>


<span class="s2">class </span><span class="s1">TestLeastSq</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">40</span><span class="s3">)</span>
        <span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c </span><span class="s3">= </span><span class="s5">3.1</span><span class="s3">, </span><span class="s5">42</span><span class="s3">, -</span><span class="s5">304.2</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">abc </span><span class="s3">= </span><span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span>
        <span class="s1">y_true </span><span class="s3">= </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">**</span><span class="s5">2 </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">c</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas </span><span class="s3">= </span><span class="s1">y_true </span><span class="s3">+ </span><span class="s5">0.01</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s1">y_true</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">residuals</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c </span><span class="s3">= </span><span class="s1">p</span>
        <span class="s1">err </span><span class="s3">= </span><span class="s1">y</span><span class="s3">-(</span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">**</span><span class="s5">2 </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">err</span>

    <span class="s2">def </span><span class="s1">residuals_jacobian</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">_p</span><span class="s3">, </span><span class="s1">_y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">x</span><span class="s3">**</span><span class="s5">2</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)]).</span><span class="s1">T</span>

    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                                  <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">'solution not found (ier=%d)' </span><span class="s3">% </span><span class="s1">ier</span><span class="s3">)</span>
        <span class="s4"># low precision due to random</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">params_fit</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_basic_with_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                                  <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">),</span>
                                  <span class="s1">Dfun</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals_jacobian</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">'solution not found (ier=%d)' </span><span class="s3">% </span><span class="s1">ier</span><span class="s3">)</span>
        <span class="s4"># low precision due to random</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">params_fit</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_full_output</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">]])</span>
        <span class="s1">full_output </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                              <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">),</span>
                              <span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">cov_x</span><span class="s3">, </span><span class="s1">infodict</span><span class="s3">, </span><span class="s1">mesg</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">full_output</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">f'solution not found: </span><span class="s2">{</span><span class="s1">mesg</span><span class="s2">}</span><span class="s6">'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_input_untouched</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],</span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">p0_copy </span><span class="s3">= </span><span class="s1">array</span><span class="s3">(</span><span class="s1">p0</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">full_output </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                              <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">),</span>
                              <span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">cov_x</span><span class="s3">, </span><span class="s1">infodict</span><span class="s3">, </span><span class="s1">mesg</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">full_output</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">f'solution not found: </span><span class="s2">{</span><span class="s1">mesg</span><span class="s2">}</span><span class="s6">'</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">p0</span><span class="s3">, </span><span class="s1">p0_copy</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_func_callable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s4"># x0 is a list of two elements, but func will return an array with</span>
        <span class="s4"># length 1, so this should result in a TypeError.</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_func_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># x0 is a list of two elements, but func will return an array with</span>
        <span class="s4"># length 1, so this should result in a TypeError.</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">, </span><span class="s1">dummy_func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=((</span><span class="s5">1</span><span class="s3">,),))</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_Dfun_callable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">deriv_func </span><span class="s3">= </span><span class="s1">ReturnShape</span><span class="s3">((</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">], </span><span class="s1">Dfun</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_shape_Dfun_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">dummy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">,))</span>
        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">dummy_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">], </span><span class="s1">Dfun</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Regression test for gh-1447</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">p</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">):</span>
            <span class="s1">q </span><span class="s3">= </span><span class="s1">p</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-(</span><span class="s1">x</span><span class="s3">-</span><span class="s1">p</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])**</span><span class="s5">2</span><span class="s3">/(</span><span class="s5">2.0</span><span class="s3">*</span><span class="s1">p</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]**</span><span class="s5">2</span><span class="s3">))+</span><span class="s1">p</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>
            <span class="s2">return </span><span class="s1">q </span><span class="s3">- </span><span class="s1">y</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.475</span><span class="s3">,</span><span class="s5">1.429</span><span class="s3">,</span><span class="s5">1.409</span><span class="s3">,</span><span class="s5">1.419</span><span class="s3">,</span><span class="s5">1.455</span><span class="s3">,</span><span class="s5">1.519</span><span class="s3">,</span><span class="s5">1.472</span><span class="s3">, </span><span class="s5">1.368</span><span class="s3">,</span><span class="s5">1.286</span><span class="s3">,</span>
                       <span class="s5">1.231</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.0168</span><span class="s3">,</span><span class="s5">0.0193</span><span class="s3">,</span><span class="s5">0.0211</span><span class="s3">,</span><span class="s5">0.0202</span><span class="s3">,</span><span class="s5">0.0171</span><span class="s3">,</span><span class="s5">0.0151</span><span class="s3">,</span><span class="s5">0.0185</span><span class="s3">,</span><span class="s5">0.0258</span><span class="s3">,</span>
                      <span class="s5">0.034</span><span class="s3">,</span><span class="s5">0.0396</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">,</span><span class="s5">1.0</span><span class="s3">,</span><span class="s5">1.0</span><span class="s3">,</span><span class="s5">1.0</span><span class="s3">])</span>
        <span class="s1">p1</span><span class="s3">, </span><span class="s1">success </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">))</span>

        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">success </span><span class="s2">in </span><span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">])</span>
        <span class="s1">assert_</span><span class="s3">((</span><span class="s1">func</span><span class="s3">(</span><span class="s1">p1</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">() &lt; </span><span class="s5">1e-4 </span><span class="s3">* (</span><span class="s1">func</span><span class="s3">(</span><span class="s1">p0</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">test_func_can_raise</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s6">'I raised'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">'I raised'</span><span class="s3">):</span>
            <span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_Dfun_can_raise</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">10</span><span class="s3">])</span>

        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s6">'I raised'</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">'I raised'</span><span class="s3">):</span>
            <span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">Dfun</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reentrant_func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">test_basic</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                                  <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">'solution not found (ier=%d)' </span><span class="s3">% </span><span class="s1">ier</span><span class="s3">)</span>
        <span class="s4"># low precision due to random</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">params_fit</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reentrant_Dfun</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">deriv_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">test_basic</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals_jacobian</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">params_fit</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">residuals</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">,</span>
                                  <span class="s1">args</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y_meas</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">),</span>
                                  <span class="s1">Dfun</span><span class="s3">=</span><span class="s1">deriv_func</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s6">'solution not found (ier=%d)' </span><span class="s3">% </span><span class="s1">ier</span><span class="s3">)</span>
        <span class="s4"># low precision due to random</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">params_fit</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_concurrent_no_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">sequence_parallel</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">test_basic</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">result </span><span class="s2">is None for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">v</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_concurrent_with_gradient</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">sequence_parallel</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">test_basic_with_gradient</span><span class="s3">] * </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">result </span><span class="s2">is None for </span><span class="s1">result </span><span class="s2">in </span><span class="s1">v</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_func_input_output_length_check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">2 </span><span class="s3">* (</span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s5">3</span><span class="s3">) ** </span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">1</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">,</span>
                           <span class="s1">match</span><span class="s3">=</span><span class="s6">'Improper input: func input vector length N='</span><span class="s3">):</span>
            <span class="s1">optimize</span><span class="s3">.</span><span class="s1">leastsq</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">TestCurveFit</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">y </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">3.2</span><span class="s3">, </span><span class="s5">9.5</span><span class="s3">, </span><span class="s5">13.7</span><span class="s3">])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_one_argument</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">a</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s1">a</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">) == </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">1.9149</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">], </span><span class="s5">0.0016</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>

        <span class="s4"># Test if we get the same with full_output. Regression test for #1415.</span>
        <span class="s4"># Also test if check_finite can be turned off.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y</span><span class="s3">,</span>
                        <span class="s1">full_output</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">check_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s3">(</span><span class="s1">popt2</span><span class="s3">, </span><span class="s1">pcov2</span><span class="s3">, </span><span class="s1">infodict</span><span class="s3">, </span><span class="s1">errmsg</span><span class="s3">, </span><span class="s1">ier</span><span class="s3">) = </span><span class="s1">res</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, </span><span class="s1">popt2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_two_argument</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">**</span><span class="s1">a</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">) == </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">1.7989</span><span class="s3">, </span><span class="s5">1.1642</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">, [[</span><span class="s5">0.0852</span><span class="s3">, -</span><span class="s5">0.1260</span><span class="s3">], [-</span><span class="s5">0.1260</span><span class="s3">, </span><span class="s5">0.1912</span><span class="s3">]],</span>
                                  <span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_func_is_classmethod</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">class </span><span class="s1">test_self</span><span class="s3">:</span>
            <span class="s0">&quot;&quot;&quot;This class tests if curve_fit passes the correct number of 
               arguments when the model function is a class instance method. 
            &quot;&quot;&quot;</span>

            <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">b </span><span class="s3">* </span><span class="s1">x</span><span class="s3">**</span><span class="s1">a</span>

        <span class="s1">test_self_inst </span><span class="s3">= </span><span class="s1">test_self</span><span class="s3">()</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">test_self_inst</span><span class="s3">.</span><span class="s1">func</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">1.7989</span><span class="s3">, </span><span class="s5">1.1642</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">, [[</span><span class="s5">0.0852</span><span class="s3">, -</span><span class="s5">0.1260</span><span class="s3">], [-</span><span class="s5">0.1260</span><span class="s3">, </span><span class="s5">0.1912</span><span class="s3">]],</span>
                                  <span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_regression_2639</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># This test fails if epsfcn in leastsq is too large.</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">574.14200000000005</span><span class="s3">, </span><span class="s5">574.154</span><span class="s3">, </span><span class="s5">574.16499999999996</span><span class="s3">,</span>
             <span class="s5">574.17700000000002</span><span class="s3">, </span><span class="s5">574.18799999999999</span><span class="s3">, </span><span class="s5">574.19899999999996</span><span class="s3">,</span>
             <span class="s5">574.21100000000001</span><span class="s3">, </span><span class="s5">574.22199999999998</span><span class="s3">, </span><span class="s5">574.23400000000004</span><span class="s3">,</span>
             <span class="s5">574.245</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">859.0</span><span class="s3">, </span><span class="s5">997.0</span><span class="s3">, </span><span class="s5">1699.0</span><span class="s3">, </span><span class="s5">2604.0</span><span class="s3">, </span><span class="s5">2013.0</span><span class="s3">, </span><span class="s5">1964.0</span><span class="s3">, </span><span class="s5">2435.0</span><span class="s3">,</span>
             <span class="s5">1550.0</span><span class="s3">, </span><span class="s5">949.0</span><span class="s3">, </span><span class="s5">841.0</span><span class="s3">]</span>
        <span class="s1">guess </span><span class="s3">= [</span><span class="s5">574.1861428571428</span><span class="s3">, </span><span class="s5">574.2155714285715</span><span class="s3">, </span><span class="s5">1302.0</span><span class="s3">, </span><span class="s5">1302.0</span><span class="s3">,</span>
                 <span class="s5">0.0035019999999983615</span><span class="s3">, </span><span class="s5">859.0</span><span class="s3">]</span>
        <span class="s1">good </span><span class="s3">= [</span><span class="s5">5.74177150e+02</span><span class="s3">, </span><span class="s5">5.74209188e+02</span><span class="s3">, </span><span class="s5">1.74187044e+03</span><span class="s3">, </span><span class="s5">1.58646166e+03</span><span class="s3">,</span>
                <span class="s5">1.0068462e-02</span><span class="s3">, </span><span class="s5">8.57450661e+02</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">f_double_gauss</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">A0</span><span class="s3">, </span><span class="s1">A1</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">A0</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-(</span><span class="s1">x</span><span class="s3">-</span><span class="s1">x0</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">/(</span><span class="s5">2.</span><span class="s3">*</span><span class="s1">sigma</span><span class="s3">**</span><span class="s5">2</span><span class="s3">))</span>
                    <span class="s3">+ </span><span class="s1">A1</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-(</span><span class="s1">x</span><span class="s3">-</span><span class="s1">x1</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">/(</span><span class="s5">2.</span><span class="s3">*</span><span class="s1">sigma</span><span class="s3">**</span><span class="s5">2</span><span class="s3">)) + </span><span class="s1">c</span><span class="s3">)</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f_double_gauss</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">guess</span><span class="s3">, </span><span class="s1">maxfev</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, </span><span class="s1">good</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pcov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">12</span><span class="s3">])</span>
        <span class="s1">sigma </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">,</span>
                                   <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">perr_scaled </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">perr_scaled</span><span class="s3">, [</span><span class="s5">0.20659803</span><span class="s3">, </span><span class="s5">0.57204404</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">sigma</span><span class="s3">=</span><span class="s5">3</span><span class="s3">*</span><span class="s1">sigma</span><span class="s3">,</span>
                                   <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">perr_scaled </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">perr_scaled</span><span class="s3">, [</span><span class="s5">0.20659803</span><span class="s3">, </span><span class="s5">0.57204404</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">,</span>
                                   <span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">perr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">perr</span><span class="s3">, [</span><span class="s5">0.30714756</span><span class="s3">, </span><span class="s5">0.85045308</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">sigma</span><span class="s3">=</span><span class="s5">3</span><span class="s3">*</span><span class="s1">sigma</span><span class="s3">,</span>
                                   <span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">perr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">perr</span><span class="s3">, [</span><span class="s5">3</span><span class="s3">*</span><span class="s5">0.30714756</span><span class="s3">, </span><span class="s5">3</span><span class="s3">*</span><span class="s5">0.85045308</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

        <span class="s4"># infinite variances</span>

        <span class="s2">def </span><span class="s1">f_flat</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span>

        <span class="s1">pcov_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]*</span><span class="s5">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">OptimizeWarning</span><span class="s3">,</span>
                       <span class="s6">&quot;Covariance of the parameters could not be estimated&quot;</span><span class="s3">)</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f_flat</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">)</span>
            <span class="s1">popt1</span><span class="s3">, </span><span class="s1">pcov1 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">], </span><span class="s1">ydata</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">], </span><span class="s1">p0</span><span class="s3">=[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>

        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pcov</span><span class="s3">, </span><span class="s1">pcov_expected</span><span class="s3">)</span>

        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">pcov1</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pcov1</span><span class="s3">, </span><span class="s1">pcov_expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Test sequence input. Regression test for gh-3037.</span>
        <span class="s2">def </span><span class="s1">f_linear</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s1">x </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f_linear</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_indeterminate_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Test that a warning is returned when pcov is indeterminate</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5.5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
        <span class="s1">assert_warns</span><span class="s3">(</span><span class="s1">OptimizeWarning</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">,</span>
                     <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_NaN_handling</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Test for correct handling of NaNs in input data: gh-3422</span>

        <span class="s4"># create input with NaNs</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">,</span>
                      <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">,</span>
                      <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">)</span>

        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">,</span>
                      <span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, **{</span><span class="s6">&quot;check_finite&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})</span>

    <span class="s3">@</span><span class="s1">staticmethod</span>
    <span class="s2">def </span><span class="s1">_check_nan_policy</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata_with_nan</span><span class="s3">, </span><span class="s1">xdata_without_nan</span><span class="s3">,</span>
                          <span class="s1">ydata_with_nan</span><span class="s3">, </span><span class="s1">ydata_without_nan</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s6">'f'</span><span class="s3">: </span><span class="s1">f</span><span class="s3">, </span><span class="s6">'xdata'</span><span class="s3">: </span><span class="s1">xdata_with_nan</span><span class="s3">, </span><span class="s6">'ydata'</span><span class="s3">: </span><span class="s1">ydata_with_nan</span><span class="s3">,</span>
                  <span class="s6">'method'</span><span class="s3">: </span><span class="s1">method</span><span class="s3">, </span><span class="s6">'check_finite'</span><span class="s3">: </span><span class="s2">False</span><span class="s3">}</span>
        <span class="s4"># propagate test</span>
        <span class="s1">error_msg </span><span class="s3">= (</span><span class="s6">&quot;`nan_policy='propagate'` is not supported &quot;</span>
                     <span class="s6">&quot;by this function.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">curve_fit</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s6">&quot;propagate&quot;</span><span class="s3">, </span><span class="s1">maxfev</span><span class="s3">=</span><span class="s5">2000</span><span class="s3">)</span>

        <span class="s4"># raise test</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;The input contains nan&quot;</span><span class="s3">):</span>
            <span class="s1">curve_fit</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">)</span>

        <span class="s4"># omit test</span>
        <span class="s1">result_with_nan</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s6">&quot;omit&quot;</span><span class="s3">)</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s6">'xdata'</span><span class="s3">] = </span><span class="s1">xdata_without_nan</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s6">'ydata'</span><span class="s3">] = </span><span class="s1">ydata_without_nan</span>
        <span class="s1">result_without_nan</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">result_with_nan</span><span class="s3">, </span><span class="s1">result_without_nan</span><span class="s3">)</span>

        <span class="s4"># not valid policy test</span>
        <span class="s4"># check for argument names in any order</span>
        <span class="s1">error_msg </span><span class="s3">= (</span><span class="s6">r&quot;nan_policy must be one of \{(?:'raise'|'omit'|None)&quot;</span>
                     <span class="s6">r&quot;(?:, ?(?:'raise'|'omit'|None))*\}&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">curve_fit</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">nan_policy</span><span class="s3">=</span><span class="s6">&quot;hi&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'method'</span><span class="s3">, [</span><span class="s6">&quot;lm&quot;</span><span class="s3">, </span><span class="s6">&quot;trf&quot;</span><span class="s3">, </span><span class="s6">&quot;dogbox&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_policy_1d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s1">xdata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>
        <span class="s1">ydata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">7</span><span class="s3">])</span>
        <span class="s1">xdata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">])</span>
        <span class="s1">ydata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_nan_policy</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata_with_nan</span><span class="s3">, </span><span class="s1">xdata_without_nan</span><span class="s3">,</span>
                               <span class="s1">ydata_with_nan</span><span class="s3">, </span><span class="s1">ydata_without_nan</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'method'</span><span class="s3">, [</span><span class="s6">&quot;lm&quot;</span><span class="s3">, </span><span class="s6">&quot;trf&quot;</span><span class="s3">, </span><span class="s6">&quot;dogbox&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_policy_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">x1 </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, :]</span>
            <span class="s1">x2 </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">, :]</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x1 </span><span class="s3">+ </span><span class="s1">b </span><span class="s3">+ </span><span class="s1">x2</span>

        <span class="s1">xdata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                                   <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]])</span>
        <span class="s1">ydata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>
        <span class="s1">xdata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]])</span>
        <span class="s1">ydata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_nan_policy</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata_with_nan</span><span class="s3">, </span><span class="s1">xdata_without_nan</span><span class="s3">,</span>
                               <span class="s1">ydata_with_nan</span><span class="s3">, </span><span class="s1">ydata_without_nan</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'n'</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'method'</span><span class="s3">, [</span><span class="s6">&quot;lm&quot;</span><span class="s3">, </span><span class="s6">&quot;trf&quot;</span><span class="s3">, </span><span class="s6">&quot;dogbox&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_nan_policy_2_3d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">x1 </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[..., </span><span class="s5">0</span><span class="s3">, :].</span><span class="s1">squeeze</span><span class="s3">()</span>
            <span class="s1">x2 </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[..., </span><span class="s5">1</span><span class="s3">, :].</span><span class="s1">squeeze</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x1 </span><span class="s3">+ </span><span class="s1">b </span><span class="s3">+ </span><span class="s1">x2</span>

        <span class="s1">xdata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                                   <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]]])</span>
        <span class="s1">xdata_with_nan </span><span class="s3">= </span><span class="s1">xdata_with_nan</span><span class="s3">.</span><span class="s1">squeeze</span><span class="s3">() </span><span class="s2">if </span><span class="s1">n </span><span class="s3">== </span><span class="s5">2 </span><span class="s2">else </span><span class="s1">xdata_with_nan</span>
        <span class="s1">ydata_with_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>
        <span class="s1">xdata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]]])</span>
        <span class="s1">ydata_without_nan </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_nan_policy</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata_with_nan</span><span class="s3">, </span><span class="s1">xdata_without_nan</span><span class="s3">,</span>
                               <span class="s1">ydata_with_nan</span><span class="s3">, </span><span class="s1">ydata_without_nan</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_inputs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Test both with and without bounds (regression test for gh-9864)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, [], [])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, [], [],</span>
                      <span class="s1">bounds</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">], [])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">], [],</span>
                      <span class="s1">bounds</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_function_zero_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Fit args is zero, so &quot;Unable to determine number of fit parameters.&quot;</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_None_x</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):  </span><span class="s4"># Added in GH10196</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">_</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">),</span>
                               <span class="s2">None</span><span class="s3">, </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2.</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_method_argument</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">, </span><span class="s6">'lm'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">])</span>

        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">'unknown'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_full_output</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b </span><span class="s3">* </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">, </span><span class="s6">'lm'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov</span><span class="s3">, </span><span class="s1">infodict</span><span class="s3">, </span><span class="s1">errmsg</span><span class="s3">, </span><span class="s1">ier </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span>
                <span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">full_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">])</span>
            <span class="s2">assert </span><span class="s6">&quot;nfev&quot; </span><span class="s2">in </span><span class="s1">infodict</span>
            <span class="s2">assert </span><span class="s6">&quot;fvec&quot; </span><span class="s2">in </span><span class="s1">infodict</span>
            <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s6">'lm' </span><span class="s2">or </span><span class="s1">method </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s6">&quot;fjac&quot; </span><span class="s2">in </span><span class="s1">infodict</span>
                <span class="s2">assert </span><span class="s6">&quot;ipvt&quot; </span><span class="s2">in </span><span class="s1">infodict</span>
                <span class="s2">assert </span><span class="s6">&quot;qtf&quot; </span><span class="s2">in </span><span class="s1">infodict</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">errmsg</span><span class="s3">, </span><span class="s1">str</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">ier </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">)</span>

        <span class="s4"># The minimum w/out bounds is at [2., 2.],</span>
        <span class="s4"># and with bounds it's at [1.5, smth].</span>
        <span class="s1">lb </span><span class="s3">= [</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">ub </span><span class="s3">= [</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">3.</span><span class="s3">]</span>

        <span class="s4"># Test that both variants of the bounds yield the same result</span>
        <span class="s1">bounds </span><span class="s3">= (</span><span class="s1">lb</span><span class="s3">, </span><span class="s1">ub</span><span class="s3">)</span>
        <span class="s1">bounds_class </span><span class="s3">= </span><span class="s1">Bounds</span><span class="s3">(</span><span class="s1">lb</span><span class="s3">, </span><span class="s1">ub</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">,</span>
                                   <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">1.5</span><span class="s3">)</span>

            <span class="s1">popt_class</span><span class="s3">, </span><span class="s1">pcov_class </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">,</span>
                                               <span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds_class</span><span class="s3">,</span>
                                               <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt_class</span><span class="s3">, </span><span class="s1">popt</span><span class="s3">)</span>

        <span class="s4"># With bounds, the starting estimate is feasible.</span>
        <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">'trf'</span><span class="s3">,</span>
                               <span class="s1">bounds</span><span class="s3">=([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">0.6</span><span class="s3">)</span>

        <span class="s4"># method='lm' doesn't support bounds.</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">curve_fit</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">,</span>
                      <span class="s1">method</span><span class="s3">=</span><span class="s6">'lm'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bounds_p0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># This test is for issue #5719. The problem was that an initial guess</span>
        <span class="s4"># was ignored when 'trf' or 'dogbox' methods were invoked.</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">a</span><span class="s3">)</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s5">40</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">)</span>
        <span class="s1">bounds </span><span class="s3">= (-</span><span class="s5">3 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt_1</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=</span><span class="s5">2.1</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
            <span class="s1">popt_2</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=</span><span class="s5">2.1</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">,</span>
                                  <span class="s1">bounds</span><span class="s3">=</span><span class="s1">bounds</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>

            <span class="s4"># If the initial guess is ignored, then popt_2 would be close 0.</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt_1</span><span class="s3">, </span><span class="s1">popt_2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_jac</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Test that Jacobian callable is handled correctly and</span>
        <span class="s4"># weighted if sigma is provided.</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">jac</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">e</span><span class="s3">, -</span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">* </span><span class="s1">e</span><span class="s3">)).</span><span class="s1">T</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">)</span>

        <span class="s4"># Test numerical options for least_squares backend.</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">scheme </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'2-point'</span><span class="s3">, </span><span class="s6">'3-point'</span><span class="s3">, </span><span class="s6">'cs'</span><span class="s3">]:</span>
                <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">jac</span><span class="s3">=</span><span class="s1">scheme</span><span class="s3">,</span>
                                       <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s4"># Test the analytic option.</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">jac</span><span class="s3">=</span><span class="s1">jac</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s4"># Now add an outlier and provide sigma.</span>
        <span class="s1">ydata</span><span class="s3">[</span><span class="s5">5</span><span class="s3">] = </span><span class="s5">100</span>
        <span class="s1">sigma </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">sigma</span><span class="s3">[</span><span class="s5">5</span><span class="s3">] = </span><span class="s5">200</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt</span><span class="s3">, </span><span class="s1">pcov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                                   <span class="s1">jac</span><span class="s3">=</span><span class="s1">jac</span><span class="s3">)</span>
            <span class="s4"># Still the optimization process is influenced somehow,</span>
            <span class="s4"># have to set rtol=1e-3.</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_maxfev_and_bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># gh-6340: with no bounds, curve_fit accepts parameter maxfev (via leastsq)</span>
        <span class="s4"># but with bounds, the parameter is `max_nfev` (via least_squares)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s5">2</span><span class="s3">*</span><span class="s1">x</span>
        <span class="s1">popt1</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">,</span><span class="s1">p</span><span class="s3">: </span><span class="s1">p</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), </span><span class="s1">maxfev</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">popt2</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">,</span><span class="s1">p</span><span class="s3">: </span><span class="s1">p</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">bounds</span><span class="s3">=(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), </span><span class="s1">max_nfev</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_curvefit_simplecovariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">jac</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">e</span><span class="s3">, -</span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">* </span><span class="s1">e</span><span class="s3">)).</span><span class="s1">T</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">, </span><span class="s5">1.3</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">y </span><span class="s3">+ </span><span class="s5">0.2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">))</span>

        <span class="s1">sigma </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">)) + </span><span class="s5">0.2</span>
        <span class="s1">covar </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">sigma</span><span class="s3">**</span><span class="s5">2</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">jac1</span><span class="s3">, </span><span class="s1">jac2 </span><span class="s2">in </span><span class="s3">[(</span><span class="s1">jac</span><span class="s3">, </span><span class="s1">jac</span><span class="s3">), (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]:</span>
            <span class="s2">for </span><span class="s1">absolute_sigma </span><span class="s2">in </span><span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]:</span>
                <span class="s1">popt1</span><span class="s3">, </span><span class="s1">pcov1 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">,</span>
                        <span class="s1">jac</span><span class="s3">=</span><span class="s1">jac1</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span><span class="s3">)</span>
                <span class="s1">popt2</span><span class="s3">, </span><span class="s1">pcov2 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">covar</span><span class="s3">,</span>
                        <span class="s1">jac</span><span class="s3">=</span><span class="s1">jac2</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span><span class="s3">)</span>

                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt1</span><span class="s3">, </span><span class="s1">popt2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pcov1</span><span class="s3">, </span><span class="s1">pcov2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_curvefit_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">funcp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">rotn </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), -</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
            <span class="s2">return </span><span class="s1">rotn</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">))</span>

        <span class="s2">def </span><span class="s1">jacp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">rotn </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), -</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">rotn</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">e</span><span class="s3">, -</span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">* </span><span class="s1">e</span><span class="s3">)).</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">jac</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">e</span><span class="s3">, -</span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">* </span><span class="s1">e</span><span class="s3">)).</span><span class="s1">T</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">y </span><span class="s3">+ </span><span class="s5">0.2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">))</span>
        <span class="s1">sigma </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">)) + </span><span class="s5">0.2</span>
        <span class="s1">covar </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">sigma</span><span class="s3">**</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s4"># Get a rotation matrix, and obtain ydatap = R ydata</span>
        <span class="s4"># Chisq = ydata^T C^{-1} ydata</span>
        <span class="s4">#       = ydata^T R^T R C^{-1} R^T R ydata</span>
        <span class="s4">#       = ydatap^T Cp^{-1} ydatap</span>
        <span class="s4"># Cp^{-1} = R C^{-1} R^T</span>
        <span class="s4"># Cp      = R C R^T, since R^-1 = R^T</span>
        <span class="s1">rotn </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), -</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">1.</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s5">0</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
        <span class="s1">ydatap </span><span class="s3">= </span><span class="s1">rotn</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">ydata</span><span class="s3">)</span>
        <span class="s1">covarp </span><span class="s3">= </span><span class="s1">rotn</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">covar</span><span class="s3">).</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">rotn</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">jac1</span><span class="s3">, </span><span class="s1">jac2 </span><span class="s2">in </span><span class="s3">[(</span><span class="s1">jac</span><span class="s3">, </span><span class="s1">jacp</span><span class="s3">), (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]:</span>
            <span class="s2">for </span><span class="s1">absolute_sigma </span><span class="s2">in </span><span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]:</span>
                <span class="s1">popt1</span><span class="s3">, </span><span class="s1">pcov1 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">,</span>
                        <span class="s1">jac</span><span class="s3">=</span><span class="s1">jac1</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span><span class="s3">)</span>
                <span class="s1">popt2</span><span class="s3">, </span><span class="s1">pcov2 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">funcp</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydatap</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">covarp</span><span class="s3">,</span>
                        <span class="s1">jac</span><span class="s3">=</span><span class="s1">jac2</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span><span class="s3">)</span>

                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt1</span><span class="s3">, </span><span class="s1">popt2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1.2e-7</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pcov1</span><span class="s3">, </span><span class="s1">pcov2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1.2e-7</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;absolute_sigma&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_curvefit_scalar_sigma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">pcov1 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span><span class="s3">)</span>
        <span class="s4"># Explicitly building the sigma 1D array</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">pcov2 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">full_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">absolute_sigma</span><span class="s3">=</span><span class="s1">absolute_sigma</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pcov1 </span><span class="s3">== </span><span class="s1">pcov2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dtypes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># regression test for gh-9581: curve_fit fails if x and y dtypes differ</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s5">1.5</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">3.0 </span><span class="s3">+ </span><span class="s5">0.5</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">dtx </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">]:</span>
                <span class="s2">for </span><span class="s1">dty </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">]:</span>
                    <span class="s1">x </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtx</span><span class="s3">)</span>
                    <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dty</span><span class="s3">)</span>

                <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
                    <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;error&quot;</span><span class="s3">, </span><span class="s1">OptimizeWarning</span><span class="s3">)</span>
                    <span class="s1">p</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>

                    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">).</span><span class="s1">all</span><span class="s3">()</span>
                    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)   </span><span class="s4"># curve_fit's initial value</span>

    <span class="s2">def </span><span class="s1">test_dtypes2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># regression test for gh-7117: curve_fit fails if</span>
        <span class="s4"># both inputs are float32</span>
        <span class="s2">def </span><span class="s1">hyperbola</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">s_1</span><span class="s3">, </span><span class="s1">s_2</span><span class="s3">, </span><span class="s1">o_x</span><span class="s3">, </span><span class="s1">o_y</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s1">b_2 </span><span class="s3">= (</span><span class="s1">s_1 </span><span class="s3">+ </span><span class="s1">s_2</span><span class="s3">) / </span><span class="s5">2</span>
            <span class="s1">b_1 </span><span class="s3">= (</span><span class="s1">s_2 </span><span class="s3">- </span><span class="s1">s_1</span><span class="s3">) / </span><span class="s5">2</span>
            <span class="s2">return </span><span class="s1">o_y </span><span class="s3">+ </span><span class="s1">b_1</span><span class="s3">*(</span><span class="s1">x</span><span class="s3">-</span><span class="s1">o_x</span><span class="s3">) + </span><span class="s1">b_2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">((</span><span class="s1">x</span><span class="s3">-</span><span class="s1">o_x</span><span class="s3">)**</span><span class="s5">2 </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">**</span><span class="s5">2</span><span class="s3">/</span><span class="s5">4</span><span class="s3">)</span>

        <span class="s1">min_fit </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, -</span><span class="s5">2.0</span><span class="s3">, -</span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">])</span>
        <span class="s1">max_fit </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">])</span>
        <span class="s1">guess </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">2.5</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, -</span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">])</span>

        <span class="s1">params </span><span class="s3">= [-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">5</span><span class="s3">, </span><span class="s5">9.5</span><span class="s3">]</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">32</span><span class="s3">, -</span><span class="s5">16</span><span class="s3">, -</span><span class="s5">8</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">16</span><span class="s3">, </span><span class="s5">32</span><span class="s3">])</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">hyperbola</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, *</span><span class="s1">params</span><span class="s3">)</span>

        <span class="s4"># run optimization twice, with xdata being float32 and float64</span>
        <span class="s1">popt_64</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">=</span><span class="s1">hyperbola</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">=</span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">=</span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=</span><span class="s1">guess</span><span class="s3">,</span>
                               <span class="s1">bounds</span><span class="s3">=(</span><span class="s1">min_fit</span><span class="s3">, </span><span class="s1">max_fit</span><span class="s3">))</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">xdata</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">hyperbola</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, *</span><span class="s1">params</span><span class="s3">)</span>

        <span class="s1">popt_32</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">=</span><span class="s1">hyperbola</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">=</span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">=</span><span class="s1">ydata</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">=</span><span class="s1">guess</span><span class="s3">,</span>
                               <span class="s1">bounds</span><span class="s3">=(</span><span class="s1">min_fit</span><span class="s3">, </span><span class="s1">max_fit</span><span class="s3">))</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">popt_32</span><span class="s3">, </span><span class="s1">popt_64</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">2e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_broadcast_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s5">4.7 </span><span class="s3">* </span><span class="s1">xdata </span><span class="s3">** </span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3.5 </span><span class="s3">* </span><span class="s1">xdata </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">))</span>
        <span class="s2">def </span><span class="s1">fit_func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">** </span><span class="s5">2 </span><span class="s3">+ </span><span class="s1">b </span><span class="s3">* </span><span class="s1">x </span><span class="s3">- </span><span class="s1">target</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s6">'trf'</span><span class="s3">, </span><span class="s6">'dogbox'</span><span class="s3">]:</span>
            <span class="s1">popt0</span><span class="s3">, </span><span class="s1">pcov0 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">fit_func</span><span class="s3">,</span>
                                     <span class="s1">xdata</span><span class="s3">=</span><span class="s1">xdata</span><span class="s3">,</span>
                                     <span class="s1">ydata</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">),</span>
                                     <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">popt1</span><span class="s3">, </span><span class="s1">pcov1 </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">fit_func</span><span class="s3">,</span>
                                     <span class="s1">xdata</span><span class="s3">=</span><span class="s1">xdata</span><span class="s3">,</span>
                                     <span class="s1">ydata</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
                                     <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pcov0</span><span class="s3">, </span><span class="s1">pcov1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_args_in_kwargs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># Ensure that `args` cannot be passed as keyword argument to `curve_fit`</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">b</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">,</span>
                      <span class="s1">xdata</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
                      <span class="s1">ydata</span><span class="s3">=[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">13</span><span class="s3">, </span><span class="s5">17</span><span class="s3">],</span>
                      <span class="s1">p0</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">],</span>
                      <span class="s1">args</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">,))</span>

    <span class="s2">def </span><span class="s1">test_data_point_number_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">e</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b </span><span class="s3">* </span><span class="s1">x</span><span class="s3">) + </span><span class="s1">c </span><span class="s3">+ </span><span class="s1">d </span><span class="s3">+ </span><span class="s1">e</span>

        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;The number of func parameters=&quot;</span><span class="s3">):</span>
            <span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">,</span>
                      <span class="s1">xdata</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
                      <span class="s1">ydata</span><span class="s3">=[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">13</span><span class="s3">, </span><span class="s5">17</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">'ignore::RuntimeWarning'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_gh4555</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># gh-4555 reported that covariance matrices returned by `leastsq`</span>
        <span class="s4"># can have negative diagonal elements and eigenvalues. (In fact,</span>
        <span class="s4"># they can also be asymmetric.) This shows up in the output of</span>
        <span class="s4"># `scipy.optimize.curve_fit`. Check that it has been resolved.giit</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">e</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">) + </span><span class="s1">c</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">) + </span><span class="s1">e</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">408113519974467917</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">100</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s1">n</span><span class="s3">) + </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">p</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s1">optimize</span><span class="s3">.</span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">maxfev</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">eigs </span><span class="s3">= </span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]  </span><span class="s4"># separate line for debugging</span>
        <span class="s4"># some platforms see a small negative eigevenvalue</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">eigs </span><span class="s3">&gt; -</span><span class="s5">1e-2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gh4555b</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># check that PR gh-17247 did not significantly change covariance matrix</span>
        <span class="s4"># for simple cases</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">408113519974467917</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">a </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">b </span><span class="s3">* </span><span class="s1">x</span><span class="s3">) + </span><span class="s1">c</span>

        <span class="s1">xdata </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">50</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">xdata</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">, </span><span class="s5">1.3</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">y_noise </span><span class="s3">= </span><span class="s5">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">xdata</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">ydata </span><span class="s3">= </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">y_noise</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">res </span><span class="s3">= </span><span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">xdata</span><span class="s3">, </span><span class="s1">ydata</span><span class="s3">)</span>
        <span class="s4"># reference from commit 1d80a2f254380d2b45733258ca42eb6b55c8755b</span>
        <span class="s1">ref </span><span class="s3">= [[+</span><span class="s5">0.0158972536486215</span><span class="s3">, </span><span class="s5">0.0069207183284242</span><span class="s3">, -</span><span class="s5">0.0007474400714749</span><span class="s3">],</span>
               <span class="s3">[+</span><span class="s5">0.0069207183284242</span><span class="s3">, </span><span class="s5">0.0205057958128679</span><span class="s3">, +</span><span class="s5">0.0053997711275403</span><span class="s3">],</span>
               <span class="s3">[-</span><span class="s5">0.0007474400714749</span><span class="s3">, </span><span class="s5">0.0053997711275403</span><span class="s3">, +</span><span class="s5">0.0027833930320877</span><span class="s3">]]</span>
        <span class="s4"># Linux_Python_38_32bit_full fails with default tolerance</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s5">2e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gh13670</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># gh-13670 reported that `curve_fit` executes callables</span>
        <span class="s4"># with the same values of the parameters at the beginning of</span>
        <span class="s4"># optimization. Check that this has been resolved.</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">8250058582555444926</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">101</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">+ </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">101</span><span class="s3">) * </span><span class="s5">0.5</span>

        <span class="s2">def </span><span class="s1">line</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, *</span><span class="s1">p</span><span class="s3">):</span>
            <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">line</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">== </span><span class="s1">p</span><span class="s3">)</span>
            <span class="s1">line</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">= </span><span class="s1">p</span>
            <span class="s2">return </span><span class="s1">x </span><span class="s3">* </span><span class="s1">p</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s1">p</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">jac</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, *</span><span class="s1">p</span><span class="s3">):</span>
            <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">jac</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">== </span><span class="s1">p</span><span class="s3">)</span>
            <span class="s1">jac</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">= </span><span class="s1">p</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)]).</span><span class="s1">T</span>

        <span class="s1">line</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">jac</span><span class="s3">.</span><span class="s1">last_p </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">p0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">])</span>
        <span class="s1">curve_fit</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">p0</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">'lm'</span><span class="s3">, </span><span class="s1">jac</span><span class="s3">=</span><span class="s1">jac</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestFixedPoint</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_scalar_trivial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># f(x) = 2x; fixed point should be x=0</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">2.0</span><span class="s3">*</span><span class="s1">x</span>
        <span class="s1">x0 </span><span class="s3">= </span><span class="s5">1.0</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_scalar_basic1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># f(x) = x**2; x0=1.05; fixed point should be x=1</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s5">2</span>
        <span class="s1">x0 </span><span class="s3">= </span><span class="s5">1.05</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_scalar_basic2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># f(x) = x**0.5; x0=1.05; fixed point should be x=1</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s5">0.5</span>
        <span class="s1">x0 </span><span class="s3">= </span><span class="s5">1.05</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_array_trivial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">2.0</span><span class="s3">*</span><span class="s1">x</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">0.15</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s6">'ignore'</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_array_basic1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># f(x) = c * x**2; fixed point should be x=1/c</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">c </span><span class="s3">* </span><span class="s1">x</span><span class="s3">**</span><span class="s5">2</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.25</span><span class="s3">])</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1.15</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s6">'ignore'</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">c</span><span class="s3">,))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">/</span><span class="s1">c</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_array_basic2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># f(x) = c * x**0.5; fixed point should be x=c**2</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">c </span><span class="s3">* </span><span class="s1">x</span><span class="s3">**</span><span class="s5">0.5</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.25</span><span class="s3">])</span>
        <span class="s1">x0 </span><span class="s3">= [</span><span class="s5">0.8</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">c</span><span class="s3">,))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">c</span><span class="s3">**</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_lambertw</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># python-list/2010-December/594592.html</span>
        <span class="s1">xxroot </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">xx</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s5">2.0</span><span class="s3">*</span><span class="s1">xx</span><span class="s3">)/</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">,</span>
                <span class="s1">args</span><span class="s3">=(), </span><span class="s1">xtol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s5">500</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xxroot</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s5">2.0</span><span class="s3">*</span><span class="s1">xxroot</span><span class="s3">)/</span><span class="s5">2.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">xxroot</span><span class="s3">, </span><span class="s1">lambertw</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)/</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_no_acceleration</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># github issue 5460</span>
        <span class="s1">ks </span><span class="s3">= </span><span class="s5">2</span>
        <span class="s1">kl </span><span class="s3">= </span><span class="s5">6</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s5">1.3</span>
        <span class="s1">n0 </span><span class="s3">= </span><span class="s5">1.001</span>
        <span class="s1">i0 </span><span class="s3">= ((</span><span class="s1">m</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)/</span><span class="s1">m</span><span class="s3">)*(</span><span class="s1">kl</span><span class="s3">/</span><span class="s1">ks</span><span class="s3">/</span><span class="s1">m</span><span class="s3">)**(</span><span class="s5">1</span><span class="s3">/(</span><span class="s1">m</span><span class="s3">-</span><span class="s5">1</span><span class="s3">))</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">kl</span><span class="s3">/</span><span class="s1">ks</span><span class="s3">/</span><span class="s1">n</span><span class="s3">) / </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">i0</span><span class="s3">*</span><span class="s1">n</span><span class="s3">/(</span><span class="s1">n </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)) + </span><span class="s5">1</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s1">fixed_point</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">n0</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">'iteration'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)</span>
</pre>
</body>
</html>