<html>
<head>
<title>tfmLib.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tfmLib.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Module for reading TFM (TeX Font Metrics) files. 
 
The TFM format is described in the TFtoPL WEB source code, whose typeset form 
can be found on `CTAN &lt;http://mirrors.ctan.org/info/knuth-pdf/texware/tftopl.pdf&gt;`_. 
 
    &gt;&gt;&gt; from fontTools.tfmLib import TFM 
    &gt;&gt;&gt; tfm = TFM(&quot;Tests/tfmLib/data/cmr10.tfm&quot;) 
    &gt;&gt;&gt; 
    &gt;&gt;&gt; # Accessing an attribute gets you metadata. 
    &gt;&gt;&gt; tfm.checksum 
    1274110073 
    &gt;&gt;&gt; tfm.designsize 
    10.0 
    &gt;&gt;&gt; tfm.codingscheme 
    'TeX text' 
    &gt;&gt;&gt; tfm.family 
    'CMR' 
    &gt;&gt;&gt; tfm.seven_bit_safe_flag 
    False 
    &gt;&gt;&gt; tfm.face 
    234 
    &gt;&gt;&gt; tfm.extraheader 
    {} 
    &gt;&gt;&gt; tfm.fontdimens 
    {'SLANT': 0.0, 'SPACE': 0.33333396911621094, 'STRETCH': 0.16666698455810547, 'SHRINK': 0.11111164093017578, 'XHEIGHT': 0.4305553436279297, 'QUAD': 1.0000028610229492, 'EXTRASPACE': 0.11111164093017578} 
    &gt;&gt;&gt; # Accessing a character gets you its metrics. 
    &gt;&gt;&gt; # “width” is always available, other metrics are available only when 
    &gt;&gt;&gt; # applicable. All values are relative to “designsize”. 
    &gt;&gt;&gt; tfm.chars[ord(&quot;g&quot;)] 
    {'width': 0.5000019073486328, 'height': 0.4305553436279297, 'depth': 0.1944446563720703, 'italic': 0.013888359069824219} 
    &gt;&gt;&gt; # Kerning and ligature can be accessed as well. 
    &gt;&gt;&gt; tfm.kerning[ord(&quot;c&quot;)] 
    {104: -0.02777862548828125, 107: -0.02777862548828125} 
    &gt;&gt;&gt; tfm.ligatures[ord(&quot;f&quot;)] 
    {105: ('LIG', 12), 102: ('LIG', 11), 108: ('LIG', 13)} 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">types </span><span class="s2">import </span><span class="s1">SimpleNamespace</span>

<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">sstruct </span><span class="s2">import </span><span class="s1">calcsize</span><span class="s3">, </span><span class="s1">unpack</span><span class="s3">, </span><span class="s1">unpack2</span>

<span class="s1">SIZES_FORMAT </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
    &gt; 
    lf: h    # length of the entire file, in words 
    lh: h    # length of the header data, in words 
    bc: h    # smallest character code in the font 
    ec: h    # largest character code in the font 
    nw: h    # number of words in the width table 
    nh: h    # number of words in the height table 
    nd: h    # number of words in the depth table 
    ni: h    # number of words in the italic correction table 
    nl: h    # number of words in the ligature/kern table 
    nk: h    # number of words in the kern table 
    ne: h    # number of words in the extensible character table 
    np: h    # number of font parameter words 
&quot;&quot;&quot;</span>

<span class="s1">SIZES_SIZE </span><span class="s3">= </span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">SIZES_FORMAT</span><span class="s3">)</span>

<span class="s1">FIXED_FORMAT </span><span class="s3">= </span><span class="s4">&quot;12.20F&quot;</span>

<span class="s1">HEADER_FORMAT1 </span><span class="s3">= </span><span class="s4">f&quot;&quot;&quot;</span>
    <span class="s4">&gt;</span>
    <span class="s4">checksum:            L</span>
    <span class="s4">designsize:          </span><span class="s2">{</span><span class="s1">FIXED_FORMAT</span><span class="s2">}</span>
<span class="s4">&quot;&quot;&quot;</span>

<span class="s1">HEADER_FORMAT2 </span><span class="s3">= </span><span class="s4">f&quot;&quot;&quot;</span>
    <span class="s2">{</span><span class="s1">HEADER_FORMAT1</span><span class="s2">}</span>
    <span class="s4">codingscheme:        40p</span>
<span class="s4">&quot;&quot;&quot;</span>

<span class="s1">HEADER_FORMAT3 </span><span class="s3">= </span><span class="s4">f&quot;&quot;&quot;</span>
    <span class="s2">{</span><span class="s1">HEADER_FORMAT2</span><span class="s2">}</span>
    <span class="s4">family:              20p</span>
<span class="s4">&quot;&quot;&quot;</span>

<span class="s1">HEADER_FORMAT4 </span><span class="s3">= </span><span class="s4">f&quot;&quot;&quot;</span>
    <span class="s2">{</span><span class="s1">HEADER_FORMAT3</span><span class="s2">}</span>
    <span class="s4">seven_bit_safe_flag: ?</span>
    <span class="s4">ignored:             x</span>
    <span class="s4">ignored:             x</span>
    <span class="s4">face:                B</span>
<span class="s4">&quot;&quot;&quot;</span>

<span class="s1">HEADER_SIZE1 </span><span class="s3">= </span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">HEADER_FORMAT1</span><span class="s3">)</span>
<span class="s1">HEADER_SIZE2 </span><span class="s3">= </span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">HEADER_FORMAT2</span><span class="s3">)</span>
<span class="s1">HEADER_SIZE3 </span><span class="s3">= </span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">HEADER_FORMAT3</span><span class="s3">)</span>
<span class="s1">HEADER_SIZE4 </span><span class="s3">= </span><span class="s1">calcsize</span><span class="s3">(</span><span class="s1">HEADER_FORMAT4</span><span class="s3">)</span>

<span class="s1">LIG_KERN_COMMAND </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
    &gt; 
    skip_byte: B 
    next_char: B 
    op_byte: B 
    remainder: B 
&quot;&quot;&quot;</span>

<span class="s1">BASE_PARAMS </span><span class="s3">= [</span>
    <span class="s4">&quot;SLANT&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SPACE&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;STRETCH&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SHRINK&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;XHEIGHT&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;QUAD&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;EXTRASPACE&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">MATHSY_PARAMS </span><span class="s3">= [</span>
    <span class="s4">&quot;NUM1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;NUM2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;NUM3&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;DENOM1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;DENOM2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUP1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUP2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUP3&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUB1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUB2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUPDROP&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;SUBDROP&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;DELIM1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;DELIM2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;AXISHEIGHT&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">MATHEX_PARAMS </span><span class="s3">= [</span>
    <span class="s4">&quot;DEFAULTRULETHICKNESS&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BIGOPSPACING1&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BIGOPSPACING2&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BIGOPSPACING3&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BIGOPSPACING4&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BIGOPSPACING5&quot;</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">VANILLA </span><span class="s3">= </span><span class="s5">0</span>
<span class="s1">MATHSY </span><span class="s3">= </span><span class="s5">1</span>
<span class="s1">MATHEX </span><span class="s3">= </span><span class="s5">2</span>

<span class="s1">UNREACHABLE </span><span class="s3">= </span><span class="s5">0</span>
<span class="s1">PASSTHROUGH </span><span class="s3">= </span><span class="s5">1</span>
<span class="s1">ACCESSABLE </span><span class="s3">= </span><span class="s5">2</span>

<span class="s1">NO_TAG </span><span class="s3">= </span><span class="s5">0</span>
<span class="s1">LIG_TAG </span><span class="s3">= </span><span class="s5">1</span>
<span class="s1">LIST_TAG </span><span class="s3">= </span><span class="s5">2</span>
<span class="s1">EXT_TAG </span><span class="s3">= </span><span class="s5">3</span>

<span class="s1">STOP_FLAG </span><span class="s3">= </span><span class="s5">128</span>
<span class="s1">KERN_FLAG </span><span class="s3">= </span><span class="s5">128</span>


<span class="s2">class </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TFM</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_read</span><span class="s3">(</span><span class="s1">file</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span>
            <span class="s4">f&quot;&lt;TFM&quot;</span>
            <span class="s4">f&quot; for </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">family</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s4">f&quot; in </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">codingscheme</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s4">f&quot; at </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">designsize</span><span class="s2">:</span><span class="s4">g</span><span class="s2">}</span><span class="s4">pt&gt;&quot;</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">&quot;read&quot;</span><span class="s3">):</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fp</span><span class="s3">:</span>
                <span class="s1">data </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_data </span><span class="s3">= </span><span class="s1">data</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) &lt; </span><span class="s1">SIZES_SIZE</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;Too short input file&quot;</span><span class="s3">)</span>

        <span class="s1">sizes </span><span class="s3">= </span><span class="s1">SimpleNamespace</span><span class="s3">()</span>
        <span class="s1">unpack2</span><span class="s3">(</span><span class="s1">SIZES_FORMAT</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">sizes</span><span class="s3">)</span>

        <span class="s6"># Do some file structure sanity checks.</span>
        <span class="s6"># TeX and TFtoPL do additional functional checks and might even correct</span>
        <span class="s6"># “errors” in the input file, but we instead try to output the file as</span>
        <span class="s6"># it is as long as it is parsable, even if the data make no sense.</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lf </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;The file claims to have negative or zero length!&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) &lt; </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lf </span><span class="s3">* </span><span class="s5">4</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;The file has fewer bytes than it claims!&quot;</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">length </span><span class="s2">in </span><span class="s1">vars</span><span class="s3">(</span><span class="s1">sizes</span><span class="s3">).</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;The subfile size: '{name}' is negative!&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh </span><span class="s3">&lt; </span><span class="s5">2</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">f&quot;The header length is only </span><span class="s2">{</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh</span><span class="s2">}</span><span class="s4">!&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc </span><span class="s3">&gt; </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s3">+ </span><span class="s5">1 </span><span class="s2">or </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s3">&gt; </span><span class="s5">255</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span>
                <span class="s4">f&quot;The character code range </span><span class="s2">{</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc</span><span class="s2">}</span><span class="s4">..</span><span class="s2">{</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec</span><span class="s2">} </span><span class="s4">is illegal!&quot;</span>
            <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nw </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nh </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nd </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ni </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;Incomplete subfiles for character dimensions!&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ne </span><span class="s3">&gt; </span><span class="s5">256</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">f&quot;There are </span><span class="s2">{</span><span class="s1">ne</span><span class="s2">} </span><span class="s4">extensible recipes!&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lf </span><span class="s3">!= (</span>
            <span class="s5">6</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh</span>
            <span class="s3">+ (</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s3">- </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nw</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nh</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nd</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ni</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nl</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nk</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ne</span>
            <span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">np</span>
        <span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">TFMException</span><span class="s3">(</span><span class="s4">&quot;Subfile sizes don’t add up to the stated total&quot;</span><span class="s3">)</span>

        <span class="s6"># Subfile offsets, used in the helper function below. These all are</span>
        <span class="s6"># 32-bit word offsets not 8-bit byte offsets.</span>
        <span class="s1">char_base </span><span class="s3">= </span><span class="s5">6 </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh </span><span class="s3">- </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc</span>
        <span class="s1">width_base </span><span class="s3">= </span><span class="s1">char_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s3">+ </span><span class="s5">1</span>
        <span class="s1">height_base </span><span class="s3">= </span><span class="s1">width_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nw</span>
        <span class="s1">depth_base </span><span class="s3">= </span><span class="s1">height_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nh</span>
        <span class="s1">italic_base </span><span class="s3">= </span><span class="s1">depth_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nd</span>
        <span class="s1">lig_kern_base </span><span class="s3">= </span><span class="s1">italic_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ni</span>
        <span class="s1">kern_base </span><span class="s3">= </span><span class="s1">lig_kern_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nl</span>
        <span class="s1">exten_base </span><span class="s3">= </span><span class="s1">kern_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nk</span>
        <span class="s1">param_base </span><span class="s3">= </span><span class="s1">exten_base </span><span class="s3">+ </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ne</span>

        <span class="s6"># Helper functions for accessing individual data. If this looks</span>
        <span class="s6"># nonidiomatic Python, I blame the effect of reading the literate WEB</span>
        <span class="s6"># documentation of TFtoPL.</span>
        <span class="s2">def </span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">char_base </span><span class="s3">+ </span><span class="s1">c</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">width_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)]</span>

        <span class="s2">def </span><span class="s1">noneexistent</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">c </span><span class="s3">&lt; </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc </span><span class="s2">or </span><span class="s1">c </span><span class="s3">&gt; </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s2">or </span><span class="s1">width_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) == </span><span class="s5">0</span>

        <span class="s2">def </span><span class="s1">height_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">] // </span><span class="s5">16</span>

        <span class="s2">def </span><span class="s1">depth_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">] % </span><span class="s5">16</span>

        <span class="s2">def </span><span class="s1">italic_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s5">2</span><span class="s3">] // </span><span class="s5">4</span>

        <span class="s2">def </span><span class="s1">tag</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s5">2</span><span class="s3">] % </span><span class="s5">4</span>

        <span class="s2">def </span><span class="s1">remainder</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">data</span><span class="s3">[</span><span class="s1">char_info</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s5">3</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">width</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">width_base </span><span class="s3">+ </span><span class="s1">width_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">&quot;v&quot;</span><span class="s3">)[</span><span class="s4">&quot;v&quot;</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">height</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">height_base </span><span class="s3">+ </span><span class="s1">height_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">&quot;v&quot;</span><span class="s3">)[</span><span class="s4">&quot;v&quot;</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">depth</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">depth_base </span><span class="s3">+ </span><span class="s1">depth_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">&quot;v&quot;</span><span class="s3">)[</span><span class="s4">&quot;v&quot;</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">italic</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">italic_base </span><span class="s3">+ </span><span class="s1">italic_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">&quot;v&quot;</span><span class="s3">)[</span><span class="s4">&quot;v&quot;</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">exten</span><span class="s3">(</span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">exten_base </span><span class="s3">+ </span><span class="s1">remainder</span><span class="s3">(</span><span class="s1">c</span><span class="s3">))</span>

        <span class="s2">def </span><span class="s1">lig_step</span><span class="s3">(</span><span class="s1">i</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">lig_kern_base </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">lig_kern_command</span><span class="s3">(</span><span class="s1">i</span><span class="s3">):</span>
            <span class="s1">command </span><span class="s3">= </span><span class="s1">SimpleNamespace</span><span class="s3">()</span>
            <span class="s1">unpack2</span><span class="s3">(</span><span class="s1">LIG_KERN_COMMAND</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">:], </span><span class="s1">command</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">command</span>

        <span class="s2">def </span><span class="s1">kern</span><span class="s3">(</span><span class="s1">i</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">kern_base </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">&quot;v&quot;</span><span class="s3">)[</span><span class="s4">&quot;v&quot;</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">param</span><span class="s3">(</span><span class="s1">i</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">4 </span><span class="s3">* (</span><span class="s1">param_base </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">ret </span><span class="s3">= </span><span class="s1">unpack2</span><span class="s3">(</span><span class="s4">f&quot;&gt;;</span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s4">:</span><span class="s2">{</span><span class="s1">FIXED_FORMAT</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">index</span><span class="s3">:], </span><span class="s1">obj</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s6"># Set all attributes to empty values regardless of the header size.</span>
        <span class="s1">unpack</span><span class="s3">(</span><span class="s1">HEADER_FORMAT4</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">] * </span><span class="s1">HEADER_SIZE4</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">offset </span><span class="s3">= </span><span class="s5">24</span>
        <span class="s1">length </span><span class="s3">= </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh </span><span class="s3">* </span><span class="s5">4</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">extraheader </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&gt;= </span><span class="s1">HEADER_SIZE4</span><span class="s3">:</span>
            <span class="s1">rest </span><span class="s3">= </span><span class="s1">unpack2</span><span class="s3">(</span><span class="s1">HEADER_FORMAT4</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">offset</span><span class="s3">:], </span><span class="s1">self</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">face </span><span class="s3">&lt; </span><span class="s5">18</span><span class="s3">:</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">face </span><span class="s3">% </span><span class="s5">2</span>
                <span class="s1">b </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">face </span><span class="s3">// </span><span class="s5">2</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">face </span><span class="s3">= </span><span class="s4">&quot;MBL&quot;</span><span class="s3">[</span><span class="s1">b </span><span class="s3">% </span><span class="s5">3</span><span class="s3">] + </span><span class="s4">&quot;RI&quot;</span><span class="s3">[</span><span class="s1">s</span><span class="s3">] + </span><span class="s4">&quot;RCE&quot;</span><span class="s3">[</span><span class="s1">b </span><span class="s3">// </span><span class="s5">3</span><span class="s3">]</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">lh </span><span class="s3">- </span><span class="s1">HEADER_SIZE4 </span><span class="s3">// </span><span class="s5">4</span><span class="s3">):</span>
                <span class="s1">rest </span><span class="s3">= </span><span class="s1">unpack2</span><span class="s3">(</span><span class="s4">f&quot;&gt;;HEADER</span><span class="s2">{</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">18</span><span class="s2">}</span><span class="s4">:l&quot;</span><span class="s3">, </span><span class="s1">rest</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">extraheader</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">elif </span><span class="s1">length </span><span class="s3">&gt;= </span><span class="s1">HEADER_SIZE3</span><span class="s3">:</span>
            <span class="s1">unpack2</span><span class="s3">(</span><span class="s1">HEADER_FORMAT3</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">offset</span><span class="s3">:], </span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">length </span><span class="s3">&gt;= </span><span class="s1">HEADER_SIZE2</span><span class="s3">:</span>
            <span class="s1">unpack2</span><span class="s3">(</span><span class="s1">HEADER_FORMAT2</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">offset</span><span class="s3">:], </span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">length </span><span class="s3">&gt;= </span><span class="s1">HEADER_SIZE1</span><span class="s3">:</span>
            <span class="s1">unpack2</span><span class="s3">(</span><span class="s1">HEADER_FORMAT1</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">offset</span><span class="s3">:], </span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">fonttype </span><span class="s3">= </span><span class="s1">VANILLA</span>
        <span class="s1">scheme </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">codingscheme</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;TEX MATH SY&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fonttype </span><span class="s3">= </span><span class="s1">MATHSY</span>
        <span class="s2">elif </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;TEX MATH EX&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fonttype </span><span class="s3">= </span><span class="s1">MATHEX</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">fontdimens </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">np</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s4">f&quot;PARAMETER</span><span class="s2">{</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s3">&lt;= </span><span class="s5">6</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">BASE_PARAMS</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fonttype </span><span class="s3">== </span><span class="s1">MATHSY </span><span class="s2">and </span><span class="s1">i </span><span class="s3">&lt;= </span><span class="s5">21</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">MATHSY_PARAMS</span><span class="s3">[</span><span class="s1">i </span><span class="s3">- </span><span class="s5">7</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fonttype </span><span class="s3">== </span><span class="s1">MATHEX </span><span class="s2">and </span><span class="s1">i </span><span class="s3">&lt;= </span><span class="s5">12</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">MATHEX_PARAMS</span><span class="s3">[</span><span class="s1">i </span><span class="s3">- </span><span class="s5">7</span><span class="s3">]</span>
            <span class="s1">read_fixed</span><span class="s3">(</span><span class="s1">param</span><span class="s3">(</span><span class="s1">i</span><span class="s3">), </span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fontdimens</span><span class="s3">)</span>

        <span class="s1">lig_kern_map </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">right_boundary_char </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">left_boundary_char </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nl </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">cmd </span><span class="s3">= </span><span class="s1">lig_kern_command</span><span class="s3">(</span><span class="s1">lig_step</span><span class="s3">(</span><span class="s5">0</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">== </span><span class="s5">255</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">right_boundary_char </span><span class="s3">= </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">next_char</span>

            <span class="s1">cmd </span><span class="s3">= </span><span class="s1">lig_kern_command</span><span class="s3">(</span><span class="s1">lig_step</span><span class="s3">((</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nl </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)))</span>
            <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">== </span><span class="s5">255</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">left_boundary_char </span><span class="s3">= </span><span class="s5">256</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s5">256 </span><span class="s3">* </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">op_byte </span><span class="s3">+ </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">remainder</span>
                <span class="s1">lig_kern_map</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">left_boundary_char</span><span class="s3">] = </span><span class="s1">r</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">chars </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">bc</span><span class="s3">, </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">ec </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">width_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">chars</span><span class="s3">[</span><span class="s1">c</span><span class="s3">] = </span><span class="s1">info </span><span class="s3">= {}</span>
                <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;width&quot;</span><span class="s3">] = </span><span class="s1">width</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">height_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;height&quot;</span><span class="s3">] = </span><span class="s1">height</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">depth_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;depth&quot;</span><span class="s3">] = </span><span class="s1">depth</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">italic_index</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;italic&quot;</span><span class="s3">] = </span><span class="s1">italic</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s1">char_tag </span><span class="s3">= </span><span class="s1">tag</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">char_tag </span><span class="s3">== </span><span class="s1">NO_TAG</span><span class="s3">:</span>
                    <span class="s2">pass</span>
                <span class="s2">elif </span><span class="s1">char_tag </span><span class="s3">== </span><span class="s1">LIG_TAG</span><span class="s3">:</span>
                    <span class="s1">lig_kern_map</span><span class="s3">[</span><span class="s1">c</span><span class="s3">] = </span><span class="s1">remainder</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">char_tag </span><span class="s3">== </span><span class="s1">LIST_TAG</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;nextlarger&quot;</span><span class="s3">] = </span><span class="s1">remainder</span><span class="s3">(</span><span class="s1">c</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">char_tag </span><span class="s3">== </span><span class="s1">EXT_TAG</span><span class="s3">:</span>
                    <span class="s1">info</span><span class="s3">[</span><span class="s4">&quot;varchar&quot;</span><span class="s3">] = </span><span class="s1">varchar </span><span class="s3">= {}</span>
                    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">):</span>
                        <span class="s1">part </span><span class="s3">= </span><span class="s1">data</span><span class="s3">[</span><span class="s1">exten</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) + </span><span class="s1">i</span><span class="s3">]</span>
                        <span class="s2">if </span><span class="s1">i </span><span class="s3">== </span><span class="s5">3 </span><span class="s2">or </span><span class="s1">part </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
                            <span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;rep&quot;</span>
                            <span class="s2">if </span><span class="s1">i </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                                <span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;top&quot;</span>
                            <span class="s2">elif </span><span class="s1">i </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:</span>
                                <span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;mid&quot;</span>
                            <span class="s2">elif </span><span class="s1">i </span><span class="s3">== </span><span class="s5">2</span><span class="s3">:</span>
                                <span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;bot&quot;</span>
                            <span class="s2">if </span><span class="s1">noneexistent</span><span class="s3">(</span><span class="s1">part</span><span class="s3">):</span>
                                <span class="s1">varchar</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">c</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">varchar</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">part</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ligatures </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">kerning </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">c</span><span class="s3">, </span><span class="s1">i </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">lig_kern_map</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
            <span class="s1">cmd </span><span class="s3">= </span><span class="s1">lig_kern_command</span><span class="s3">(</span><span class="s1">lig_step</span><span class="s3">(</span><span class="s1">i</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">&gt; </span><span class="s1">STOP_FLAG</span><span class="s3">:</span>
                <span class="s1">i </span><span class="s3">= </span><span class="s5">256 </span><span class="s3">* </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">op_byte </span><span class="s3">+ </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">remainder</span>

            <span class="s2">while </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">sizes</span><span class="s3">.</span><span class="s1">nl</span><span class="s3">:</span>
                <span class="s1">cmd </span><span class="s3">= </span><span class="s1">lig_kern_command</span><span class="s3">(</span><span class="s1">lig_step</span><span class="s3">(</span><span class="s1">i</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">&gt; </span><span class="s1">STOP_FLAG</span><span class="s3">:</span>
                    <span class="s2">pass</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">op_byte </span><span class="s3">&gt;= </span><span class="s1">KERN_FLAG</span><span class="s3">:</span>
                        <span class="s1">r </span><span class="s3">= </span><span class="s5">256 </span><span class="s3">* (</span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">op_byte </span><span class="s3">- </span><span class="s1">KERN_FLAG</span><span class="s3">) + </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">remainder</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">kerning</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, {})[</span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">next_char</span><span class="s3">] = </span><span class="s1">kern</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">r </span><span class="s3">= </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">op_byte</span>
                        <span class="s2">if </span><span class="s1">r </span><span class="s3">== </span><span class="s5">4 </span><span class="s2">or </span><span class="s3">(</span><span class="s1">r </span><span class="s3">&gt; </span><span class="s5">7 </span><span class="s2">and </span><span class="s1">r </span><span class="s3">!= </span><span class="s5">11</span><span class="s3">):</span>
                            <span class="s6"># Ligature step with nonstandard code, we output</span>
                            <span class="s6"># the code verbatim.</span>
                            <span class="s1">lig </span><span class="s3">= </span><span class="s1">r</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">lig </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
                            <span class="s2">if </span><span class="s1">r </span><span class="s3">% </span><span class="s5">4 </span><span class="s3">&gt; </span><span class="s5">1</span><span class="s3">:</span>
                                <span class="s1">lig </span><span class="s3">+= </span><span class="s4">&quot;/&quot;</span>
                            <span class="s1">lig </span><span class="s3">+= </span><span class="s4">&quot;LIG&quot;</span>
                            <span class="s2">if </span><span class="s1">r </span><span class="s3">% </span><span class="s5">2 </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
                                <span class="s1">lig </span><span class="s3">+= </span><span class="s4">&quot;/&quot;</span>
                            <span class="s2">while </span><span class="s1">r </span><span class="s3">&gt; </span><span class="s5">3</span><span class="s3">:</span>
                                <span class="s1">lig </span><span class="s3">+= </span><span class="s4">&quot;&gt;&quot;</span>
                                <span class="s1">r </span><span class="s3">-= </span><span class="s5">4</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">ligatures</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, {})[</span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">next_char</span><span class="s3">] = (</span>
                            <span class="s1">lig</span><span class="s3">,</span>
                            <span class="s1">cmd</span><span class="s3">.</span><span class="s1">remainder</span><span class="s3">,</span>
                        <span class="s3">)</span>

                <span class="s2">if </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">&gt;= </span><span class="s1">STOP_FLAG</span><span class="s3">:</span>
                    <span class="s2">break</span>
                <span class="s1">i </span><span class="s3">+= </span><span class="s1">cmd</span><span class="s3">.</span><span class="s1">skip_byte </span><span class="s3">+ </span><span class="s5">1</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">&quot;__main__&quot;</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">sys</span>

    <span class="s1">tfm </span><span class="s3">= </span><span class="s1">TFM</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">print</span><span class="s3">(</span>
        <span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
            <span class="s1">x</span>
            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s3">[</span>
                <span class="s4">f&quot;tfm.checksum=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">checksum</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.designsize=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">designsize</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.codingscheme=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">codingscheme</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.fonttype=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">fonttype</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.family=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">family</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.seven_bit_safe_flag=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">seven_bit_safe_flag</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.face=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">face</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.extraheader=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">extraheader</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.fontdimens=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">fontdimens</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.right_boundary_char=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">right_boundary_char</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.left_boundary_char=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">left_boundary_char</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.kerning=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">kerning</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.ligatures=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">ligatures</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s4">f&quot;tfm.chars=</span><span class="s2">{</span><span class="s1">tfm</span><span class="s3">.</span><span class="s1">chars</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
            <span class="s3">]</span>
        <span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s1">tfm</span><span class="s3">)</span>
</pre>
</body>
</html>