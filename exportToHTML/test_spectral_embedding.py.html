<html>
<head>
<title>test_spectral_embedding.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_spectral_embedding.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">Mock</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">eigh</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">eigsh</span><span class="s2">, </span><span class="s1">lobpcg</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cluster </span><span class="s0">import </span><span class="s1">KMeans</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">make_blobs</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">manifold </span><span class="s0">import </span><span class="s1">SpectralEmbedding</span><span class="s2">, </span><span class="s1">_spectral_embedding</span><span class="s2">, </span><span class="s1">spectral_embedding</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">manifold</span><span class="s2">.</span><span class="s1">_spectral_embedding </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_graph_connected_component</span><span class="s2">,</span>
    <span class="s1">_graph_is_connected</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">normalized_mutual_info_score</span><span class="s2">, </span><span class="s1">pairwise_distances</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise </span><span class="s0">import </span><span class="s1">rbf_kernel</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">neighbors </span><span class="s0">import </span><span class="s1">NearestNeighbors</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">extmath </span><span class="s0">import </span><span class="s1">_deterministic_vector_sign_flip</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">COO_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">parse_version</span><span class="s2">,</span>
    <span class="s1">sp_version</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">laplacian </span><span class="s0">as </span><span class="s1">csgraph_laplacian</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">pyamg </span><span class="s0">import </span><span class="s1">smoothed_aggregation_solver  </span><span class="s3"># noqa</span>

    <span class="s1">pyamg_available </span><span class="s2">= </span><span class="s0">True</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">pyamg_available </span><span class="s2">= </span><span class="s0">False</span>
<span class="s1">skip_if_no_pyamg </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s0">not </span><span class="s1">pyamg_available</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;PyAMG is required for the tests in this function.&quot;</span>
<span class="s2">)</span>

<span class="s3"># non centered, sparse centers to check the</span>
<span class="s1">centers </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s1">n_samples </span><span class="s2">= </span><span class="s5">1000</span>
<span class="s1">n_clusters</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s1">centers</span><span class="s2">.</span><span class="s1">shape</span>
<span class="s1">S</span><span class="s2">, </span><span class="s1">true_labels </span><span class="s2">= </span><span class="s1">make_blobs</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">centers</span><span class="s2">=</span><span class="s1">centers</span><span class="s2">, </span><span class="s1">cluster_std</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check array A and B are equal with possible sign flipping on 
    each columns&quot;&quot;&quot;</span>
    <span class="s1">tol_squared </span><span class="s2">= </span><span class="s1">tol</span><span class="s2">**</span><span class="s5">2</span>
    <span class="s0">for </span><span class="s1">A_col</span><span class="s2">, </span><span class="s1">B_col </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">.</span><span class="s1">T</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">((</span><span class="s1">A_col </span><span class="s2">- </span><span class="s1">B_col</span><span class="s2">) ** </span><span class="s5">2</span><span class="s2">) &lt;= </span><span class="s1">tol_squared</span>
            <span class="s0">or </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">((</span><span class="s1">A_col </span><span class="s2">+ </span><span class="s1">B_col</span><span class="s2">) ** </span><span class="s5">2</span><span class="s2">) &lt;= </span><span class="s1">tol_squared</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;coo_container&quot;</span><span class="s2">, </span><span class="s1">COO_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sparse_graph_connected_component</span><span class="s2">(</span><span class="s1">coo_container</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">300</span>
    <span class="s1">boundaries </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">42</span><span class="s2">, </span><span class="s5">121</span><span class="s2">, </span><span class="s5">200</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">]</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">connections </span><span class="s2">= []</span>

    <span class="s0">for </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">boundaries</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">boundaries</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]):</span>
        <span class="s1">group </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">stop</span><span class="s2">]</span>
        <span class="s3"># Connect all elements within the group at least once via an</span>
        <span class="s3"># arbitrary path that spans the group.</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">group</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">connections</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">group</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">group</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]))</span>

        <span class="s3"># Add some more random connections within the group</span>
        <span class="s1">min_idx</span><span class="s2">, </span><span class="s1">max_idx </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">group</span><span class="s2">) - </span><span class="s5">1</span>
        <span class="s1">n_random_connections </span><span class="s2">= </span><span class="s5">1000</span>
        <span class="s1">source </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">min_idx</span><span class="s2">, </span><span class="s1">max_idx</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_random_connections</span><span class="s2">)</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">min_idx</span><span class="s2">, </span><span class="s1">max_idx</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_random_connections</span><span class="s2">)</span>
        <span class="s1">connections</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">group</span><span class="s2">[</span><span class="s1">source</span><span class="s2">], </span><span class="s1">group</span><span class="s2">[</span><span class="s1">target</span><span class="s2">]))</span>

    <span class="s3"># Build a symmetric affinity matrix</span>
    <span class="s1">row_idx</span><span class="s2">, </span><span class="s1">column_idx </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">connections</span><span class="s2">).</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">42</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">connections</span><span class="s2">))</span>
    <span class="s1">affinity </span><span class="s2">= </span><span class="s1">coo_container</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, (</span><span class="s1">row_idx</span><span class="s2">, </span><span class="s1">column_idx</span><span class="s2">)))</span>
    <span class="s1">affinity </span><span class="s2">= </span><span class="s5">0.5 </span><span class="s2">* (</span><span class="s1">affinity </span><span class="s2">+ </span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">boundaries</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">boundaries</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]):</span>
        <span class="s1">component_1 </span><span class="s2">= </span><span class="s1">_graph_connected_component</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">, </span><span class="s1">p</span><span class="s2">[</span><span class="s1">start</span><span class="s2">])</span>
        <span class="s1">component_size </span><span class="s2">= </span><span class="s1">stop </span><span class="s2">- </span><span class="s1">start</span>
        <span class="s0">assert </span><span class="s1">component_1</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() == </span><span class="s1">component_size</span>

        <span class="s3"># We should retrieve the same component mask by starting by both ends</span>
        <span class="s3"># of the group</span>
        <span class="s1">component_2 </span><span class="s2">= </span><span class="s1">_graph_connected_component</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">, </span><span class="s1">p</span><span class="s2">[</span><span class="s1">stop </span><span class="s2">- </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">component_2</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() == </span><span class="s1">component_size</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">component_1</span><span class="s2">, </span><span class="s1">component_2</span><span class="s2">)</span>


<span class="s3"># TODO: investigate why this test is seed-sensitive on 32-bit Python</span>
<span class="s3"># runtimes. Is this revealing a numerical stability problem ? Or is it</span>
<span class="s3"># expected from the test numerical design ? In the latter case the test</span>
<span class="s3"># should be made less seed-sensitive instead.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;eigen_solver&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4">&quot;arpack&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;lobpcg&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_if_no_pyamg</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_two_components</span><span class="s2">(</span><span class="s1">eigen_solver</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
    <span class="s3"># Test spectral embedding with two components</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">n_sample </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">affinity </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=[</span><span class="s1">n_sample </span><span class="s2">* </span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_sample </span><span class="s2">* </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s3"># first component</span>
    <span class="s1">affinity</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s1">n_sample</span><span class="s2">, </span><span class="s5">0</span><span class="s2">:</span><span class="s1">n_sample</span><span class="s2">] = (</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_sample</span><span class="s2">, </span><span class="s1">n_sample</span><span class="s2">)) + </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s3"># second component</span>
    <span class="s1">affinity</span><span class="s2">[</span><span class="s1">n_sample</span><span class="s2">::, </span><span class="s1">n_sample</span><span class="s2">::] = (</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_sample</span><span class="s2">, </span><span class="s1">n_sample</span><span class="s2">)) + </span><span class="s5">2</span>
    <span class="s2">)</span>

    <span class="s3"># Test of internal _graph_connected_component before connection</span>
    <span class="s1">component </span><span class="s2">= </span><span class="s1">_graph_connected_component</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">component</span><span class="s2">[:</span><span class="s1">n_sample</span><span class="s2">].</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">component</span><span class="s2">[</span><span class="s1">n_sample</span><span class="s2">:].</span><span class="s1">any</span><span class="s2">()</span>
    <span class="s1">component </span><span class="s2">= </span><span class="s1">_graph_connected_component</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">component</span><span class="s2">[:</span><span class="s1">n_sample</span><span class="s2">].</span><span class="s1">any</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">component</span><span class="s2">[</span><span class="s1">n_sample</span><span class="s2">:].</span><span class="s1">all</span><span class="s2">()</span>

    <span class="s3"># connection</span>
    <span class="s1">affinity</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n_sample </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] = </span><span class="s5">1</span>
    <span class="s1">affinity</span><span class="s2">[</span><span class="s1">n_sample </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">1</span>
    <span class="s1">affinity</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">[:: </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">n_sample </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s1">affinity </span><span class="s2">= </span><span class="s5">0.5 </span><span class="s2">* (</span><span class="s1">affinity </span><span class="s2">+ </span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s1">true_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">n_sample</span><span class="s2">)</span>
    <span class="s1">true_label</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s1">n_sample</span><span class="s2">] = </span><span class="s5">1</span>

    <span class="s1">se_precomp </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;precomputed&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s1">eigen_solver</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">embedded_coordinate </span><span class="s2">= </span><span class="s1">se_precomp</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s3"># thresholding on the first components using 0.</span>
    <span class="s1">label_ </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">embedded_coordinate</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">() &lt; </span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">normalized_mutual_info_score</span><span class="s2">(</span><span class="s1">true_label</span><span class="s2">, </span><span class="s1">label_</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">CSR_CONTAINERS</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;eigen_solver&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4">&quot;arpack&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;lobpcg&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_if_no_pyamg</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_precomputed_affinity</span><span class="s2">(</span>
    <span class="s1">sparse_container</span><span class="s2">, </span><span class="s1">eigen_solver</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span>
<span class="s2">):</span>
    <span class="s3"># Test spectral embedding with precomputed kernel</span>
    <span class="s1">gamma </span><span class="s2">= </span><span class="s5">1.0</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">S </span><span class="s0">if </span><span class="s1">sparse_container </span><span class="s0">is None else </span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>

    <span class="s1">se_precomp </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;precomputed&quot;</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s1">eigen_solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">se_rbf </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;rbf&quot;</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s1">eigen_solver</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">embed_precomp </span><span class="s2">= </span><span class="s1">se_precomp</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">))</span>
    <span class="s1">embed_rbf </span><span class="s2">= </span><span class="s1">se_rbf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">se_precomp</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">, </span><span class="s1">se_rbf</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">)</span>
    <span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">embed_precomp</span><span class="s2">, </span><span class="s1">embed_rbf</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_precomputed_nearest_neighbors_filtering</span><span class="s2">():</span>
    <span class="s3"># Test precomputed graph filtering when containing too many neighbors</span>
    <span class="s1">n_neighbors </span><span class="s2">= </span><span class="s5">2</span>
    <span class="s1">results </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">additional_neighbors </span><span class="s0">in </span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">]:</span>
        <span class="s1">nn </span><span class="s2">= </span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors </span><span class="s2">+ </span><span class="s1">additional_neighbors</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>
        <span class="s1">graph </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">S</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;connectivity&quot;</span><span class="s2">)</span>
        <span class="s1">embedding </span><span class="s2">= (</span>
            <span class="s1">SpectralEmbedding</span><span class="s2">(</span>
                <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
                <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
                <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;precomputed_nearest_neighbors&quot;</span><span class="s2">,</span>
                <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">embedding_</span>
        <span class="s2">)</span>
        <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">embedding</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">results</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">CSR_CONTAINERS</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_callable_affinity</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span><span class="s2">):</span>
    <span class="s3"># Test spectral embedding with callable affinity</span>
    <span class="s1">gamma </span><span class="s2">= </span><span class="s5">0.9</span>
    <span class="s1">kern </span><span class="s2">= </span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">S</span><span class="s2">, </span><span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">S </span><span class="s0">if </span><span class="s1">sparse_container </span><span class="s0">is None else </span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>

    <span class="s1">se_callable </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">)),</span>
        <span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">se_rbf </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;rbf&quot;</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">=</span><span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">embed_rbf </span><span class="s2">= </span><span class="s1">se_rbf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">embed_callable </span><span class="s2">= </span><span class="s1">se_callable</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">se_callable</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">, </span><span class="s1">se_rbf</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">kern</span><span class="s2">, </span><span class="s1">se_rbf</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">)</span>
    <span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">embed_rbf</span><span class="s2">, </span><span class="s1">embed_callable</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">)</span>


<span class="s3"># TODO: Remove when pyamg does replaces sp.rand call with np.random.rand</span>
<span class="s3"># https://github.com/scikit-learn/scikit-learn/issues/15913</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:scipy.rand is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s3"># TODO: Remove when pyamg removes the use of np.float</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:`np.float` is a deprecated alias:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s3"># TODO: Remove when pyamg removes the use of pinv2</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:scipy.linalg.pinv2 is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:np.find_common_type is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s0">not </span><span class="s1">pyamg_available</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;PyAMG is required for the tests in this function.&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;coo_container&quot;</span><span class="s2">, </span><span class="s1">COO_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_amg_solver</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">coo_container</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span><span class="s2">):</span>
    <span class="s1">se_amg </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;nearest_neighbors&quot;</span><span class="s2">,</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s4">&quot;amg&quot;</span><span class="s2">,</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">se_arpack </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;nearest_neighbors&quot;</span><span class="s2">,</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s4">&quot;arpack&quot;</span><span class="s2">,</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">embed_amg </span><span class="s2">= </span><span class="s1">se_amg</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">S</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">embed_arpack </span><span class="s2">= </span><span class="s1">se_arpack</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">S</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">embed_amg</span><span class="s2">, </span><span class="s1">embed_arpack</span><span class="s2">, </span><span class="s5">1e-5</span><span class="s2">)</span>

    <span class="s3"># same with special case in which amg is not actually used</span>
    <span class="s3"># regression test for #10715</span>
    <span class="s3"># affinity between nodes</span>
    <span class="s1">row </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

    <span class="s1">affinity </span><span class="s2">= </span><span class="s1">coo_container</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">val</span><span class="s2">, </span><span class="s1">val</span><span class="s2">]), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">row</span><span class="s2">, </span><span class="s1">col</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">col</span><span class="s2">, </span><span class="s1">row</span><span class="s2">]))),</span>
        <span class="s1">shape</span><span class="s2">=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">6</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">se_amg</span><span class="s2">.</span><span class="s1">affinity </span><span class="s2">= </span><span class="s4">&quot;precomputed&quot;</span>
    <span class="s1">se_arpack</span><span class="s2">.</span><span class="s1">affinity </span><span class="s2">= </span><span class="s4">&quot;precomputed&quot;</span>
    <span class="s1">embed_amg </span><span class="s2">= </span><span class="s1">se_amg</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">embed_arpack </span><span class="s2">= </span><span class="s1">se_arpack</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">embed_amg</span><span class="s2">, </span><span class="s1">embed_arpack</span><span class="s2">, </span><span class="s5">1e-5</span><span class="s2">)</span>

    <span class="s3"># Check that passing a sparse matrix with `np.int64` indices dtype raises an error</span>
    <span class="s3"># or is successful based on the version of SciPy which is installed.</span>
    <span class="s3"># Use a CSR matrix to avoid any conversion during the validation</span>
    <span class="s1">affinity </span><span class="s2">= </span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">tocsr</span><span class="s2">()</span>
    <span class="s1">affinity</span><span class="s2">.</span><span class="s1">indptr </span><span class="s2">= </span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s1">affinity</span><span class="s2">.</span><span class="s1">indices </span><span class="s2">= </span><span class="s1">affinity</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

    <span class="s3"># PR: https://github.com/scipy/scipy/pull/18913</span>
    <span class="s3"># First integration in 1.11.3: https://github.com/scipy/scipy/pull/19279</span>
    <span class="s1">scipy_graph_traversal_supports_int64_index </span><span class="s2">= </span><span class="s1">sp_version </span><span class="s2">&gt;= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s4">&quot;1.11.3&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">scipy_graph_traversal_supports_int64_index</span><span class="s2">:</span>
        <span class="s1">se_amg</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;Only sparse matrices with 32-bit integer indices are accepted&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">se_amg</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">affinity</span><span class="s2">)</span>


<span class="s3"># TODO: Remove filterwarnings when pyamg does replaces sp.rand call with</span>
<span class="s3"># np.random.rand:</span>
<span class="s3"># https://github.com/scikit-learn/scikit-learn/issues/15913</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:scipy.rand is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s3"># TODO: Remove when pyamg removes the use of np.float</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:`np.float` is a deprecated alias:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s3"># TODO: Remove when pyamg removes the use of pinv2</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:scipy.linalg.pinv2 is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s0">not </span><span class="s1">pyamg_available</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;PyAMG is required for the tests in this function.&quot;</span>
<span class="s2">)</span>
<span class="s3"># TODO: Remove when pyamg removes the use of np.find_common_type</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:np.find_common_type is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_amg_solver_failure</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span><span class="s2">):</span>
    <span class="s3"># Non-regression test for amg solver failure (issue #13393 on github)</span>
    <span class="s1">num_nodes </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">num_nodes</span><span class="s2">, </span><span class="s1">num_nodes</span><span class="s2">, </span><span class="s1">density</span><span class="s2">=</span><span class="s5">0.1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">upper </span><span class="s2">= </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">triu</span><span class="s2">(</span><span class="s1">X</span><span class="s2">) - </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">diags</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">diagonal</span><span class="s2">())</span>
    <span class="s1">sym_matrix </span><span class="s2">= </span><span class="s1">upper </span><span class="s2">+ </span><span class="s1">upper</span><span class="s2">.</span><span class="s1">T</span>
    <span class="s1">embedding </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span>
        <span class="s1">sym_matrix</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">eigen_solver</span><span class="s2">=</span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s2">)</span>

    <span class="s3"># Check that the learned embedding is stable w.r.t. random solver init:</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">):</span>
        <span class="s1">new_embedding </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span>
            <span class="s1">sym_matrix</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">eigen_solver</span><span class="s2">=</span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span>
        <span class="s2">)</span>
        <span class="s1">_assert_equal_with_sign_flipping</span><span class="s2">(</span><span class="s1">embedding</span><span class="s2">, </span><span class="s1">new_embedding</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">0.05</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:the behavior of nmi will change in version 0.22&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pipeline_spectral_clustering</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span><span class="s2">):</span>
    <span class="s3"># Test using pipeline to do spectral clustering</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">se_rbf </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_clusters</span><span class="s2">, </span><span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;rbf&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span>
    <span class="s2">)</span>
    <span class="s1">se_knn </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_clusters</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;nearest_neighbors&quot;</span><span class="s2">,</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">for </span><span class="s1">se </span><span class="s0">in </span><span class="s2">[</span><span class="s1">se_rbf</span><span class="s2">, </span><span class="s1">se_knn</span><span class="s2">]:</span>
        <span class="s1">km </span><span class="s2">= </span><span class="s1">KMeans</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s1">n_clusters</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">, </span><span class="s1">n_init</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">km</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">se</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">S</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
            <span class="s1">normalized_mutual_info_score</span><span class="s2">(</span><span class="s1">km</span><span class="s2">.</span><span class="s1">labels_</span><span class="s2">, </span><span class="s1">true_labels</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_connectivity</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">=</span><span class="s5">36</span><span class="s2">):</span>
    <span class="s3"># Test that graph connectivity test works as expected</span>
    <span class="s1">graph </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">csr_container </span><span class="s0">in </span><span class="s1">CSR_CONTAINERS</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">csc_container </span><span class="s0">in </span><span class="s1">CSC_CONTAINERS</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">csc_container</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">))</span>

    <span class="s1">graph </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">csr_container </span><span class="s0">in </span><span class="s1">CSR_CONTAINERS</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">csc_container </span><span class="s0">in </span><span class="s1">CSC_CONTAINERS</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">_graph_is_connected</span><span class="s2">(</span><span class="s1">csc_container</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_spectral_embedding_deterministic</span><span class="s2">():</span>
    <span class="s3"># Test that Spectral Embedding is deterministic</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">36</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">30</span><span class="s2">)</span>
    <span class="s1">sims </span><span class="s2">= </span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">embedding_1 </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span><span class="s1">sims</span><span class="s2">)</span>
    <span class="s1">embedding_2 </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span><span class="s1">sims</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">embedding_1</span><span class="s2">, </span><span class="s1">embedding_2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_spectral_embedding_unnormalized</span><span class="s2">():</span>
    <span class="s3"># Test that spectral_embedding is also processing unnormalized laplacian</span>
    <span class="s3"># correctly</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">36</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">30</span><span class="s2">)</span>
    <span class="s1">sims </span><span class="s2">= </span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">8</span>
    <span class="s1">embedding_1 </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span>
        <span class="s1">sims</span><span class="s2">, </span><span class="s1">norm_laplacian</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">drop_first</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s3"># Verify using manual computation with dense eigh</span>
    <span class="s1">laplacian</span><span class="s2">, </span><span class="s1">dd </span><span class="s2">= </span><span class="s1">csgraph_laplacian</span><span class="s2">(</span><span class="s1">sims</span><span class="s2">, </span><span class="s1">normed</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">return_diag</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">diffusion_map </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">laplacian</span><span class="s2">)</span>
    <span class="s1">embedding_2 </span><span class="s2">= </span><span class="s1">diffusion_map</span><span class="s2">.</span><span class="s1">T</span><span class="s2">[:</span><span class="s1">n_components</span><span class="s2">]</span>
    <span class="s1">embedding_2 </span><span class="s2">= </span><span class="s1">_deterministic_vector_sign_flip</span><span class="s2">(</span><span class="s1">embedding_2</span><span class="s2">).</span><span class="s1">T</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">embedding_1</span><span class="s2">, </span><span class="s1">embedding_2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_spectral_embedding_first_eigen_vector</span><span class="s2">():</span>
    <span class="s3"># Test that the first eigenvector of spectral_embedding</span>
    <span class="s3"># is constant and that the second is not (for a connected graph)</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">36</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">30</span><span class="s2">)</span>
    <span class="s1">sims </span><span class="s2">= </span><span class="s1">rbf_kernel</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">2</span>

    <span class="s0">for </span><span class="s1">seed </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">10</span><span class="s2">):</span>
        <span class="s1">embedding </span><span class="s2">= </span><span class="s1">spectral_embedding</span><span class="s2">(</span>
            <span class="s1">sims</span><span class="s2">,</span>
            <span class="s1">norm_laplacian</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
            <span class="s1">drop_first</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">embedding</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">]) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">embedding</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">]) &gt; </span><span class="s5">1e-3</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;eigen_solver&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4">&quot;arpack&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;lobpcg&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">skip_if_no_pyamg</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spectral_embedding_preserves_dtype</span><span class="s2">(</span><span class="s1">eigen_solver</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that `SpectralEmbedding is preserving the dtype of the fitted 
    attribute and transformed data. 
 
    Ideally, this test should be covered by the common test 
    `check_transformer_preserve_dtypes`. However, this test only run 
    with transformers implementing `transform` while `SpectralEmbedding` 
    implements only `fit_transform`. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">S</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">se </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;rbf&quot;</span><span class="s2">, </span><span class="s1">eigen_solver</span><span class="s2">=</span><span class="s1">eigen_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">se</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
    <span class="s0">assert </span><span class="s1">se</span><span class="s2">.</span><span class="s1">embedding_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
    <span class="s0">assert </span><span class="s1">se</span><span class="s2">.</span><span class="s1">affinity_matrix_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">pyamg_available</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;PyAMG is installed and we should not test for an error.&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_error_pyamg_not_available</span><span class="s2">():</span>
    <span class="s1">se_precomp </span><span class="s2">= </span><span class="s1">SpectralEmbedding</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">affinity</span><span class="s2">=</span><span class="s4">&quot;rbf&quot;</span><span class="s2">,</span>
        <span class="s1">eigen_solver</span><span class="s2">=</span><span class="s4">&quot;amg&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;The eigen_solver was set to 'amg', but pyamg is not available.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">se_precomp</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>


<span class="s3"># TODO: Remove when pyamg removes the use of np.find_common_type</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:np.find_common_type is deprecated:DeprecationWarning:pyamg.*&quot;</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;solver&quot;</span><span class="s2">, [</span><span class="s4">&quot;arpack&quot;</span><span class="s2">, </span><span class="s4">&quot;amg&quot;</span><span class="s2">, </span><span class="s4">&quot;lobpcg&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spectral_eigen_tol_auto</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that `eigen_tol=&quot;auto&quot;` is resolved correctly&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">solver </span><span class="s2">== </span><span class="s4">&quot;amg&quot; </span><span class="s0">and not </span><span class="s1">pyamg_available</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;PyAMG is not available.&quot;</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">make_blobs</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">centers</span><span class="s2">=[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]], </span><span class="s1">cluster_std</span><span class="s2">=</span><span class="s5">0.01</span>
    <span class="s2">)</span>
    <span class="s1">D </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)  </span><span class="s3"># Distance matrix</span>
    <span class="s1">S </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">D</span><span class="s2">) - </span><span class="s1">D  </span><span class="s3"># Similarity matrix</span>

    <span class="s1">solver_func </span><span class="s2">= </span><span class="s1">eigsh </span><span class="s0">if </span><span class="s1">solver </span><span class="s2">== </span><span class="s4">&quot;arpack&quot; </span><span class="s0">else </span><span class="s1">lobpcg</span>
    <span class="s1">default_value </span><span class="s2">= </span><span class="s5">0 </span><span class="s0">if </span><span class="s1">solver </span><span class="s2">== </span><span class="s4">&quot;arpack&quot; </span><span class="s0">else None</span>
    <span class="s0">if </span><span class="s1">solver </span><span class="s2">== </span><span class="s4">&quot;amg&quot;</span><span class="s2">:</span>
        <span class="s1">S </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>

    <span class="s1">mocked_solver </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">side_effect</span><span class="s2">=</span><span class="s1">solver_func</span><span class="s2">)</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">_spectral_embedding</span><span class="s2">, </span><span class="s1">solver_func</span><span class="s2">.</span><span class="s1">__qualname__</span><span class="s2">, </span><span class="s1">mocked_solver</span><span class="s2">)</span>

    <span class="s1">spectral_embedding</span><span class="s2">(</span><span class="s1">S</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">, </span><span class="s1">eigen_solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">, </span><span class="s1">eigen_tol</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">mocked_solver</span><span class="s2">.</span><span class="s1">assert_called</span><span class="s2">()</span>

    <span class="s1">_</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s2">= </span><span class="s1">mocked_solver</span><span class="s2">.</span><span class="s1">call_args</span>
    <span class="s0">assert </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;tol&quot;</span><span class="s2">] == </span><span class="s1">default_value</span>
</pre>
</body>
</html>