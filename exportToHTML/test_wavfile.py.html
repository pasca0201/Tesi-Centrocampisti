<html>
<head>
<title>test_wavfile.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_wavfile.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">,</span>
                           <span class="s1">break_cycles</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">, </span><span class="s1">IS_PYPY</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises</span><span class="s2">, </span><span class="s1">warns</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">io </span><span class="s0">import </span><span class="s1">wavfile</span>


<span class="s0">def </span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">), </span><span class="s3">'data'</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_1</span><span class="s2">():</span>
    <span class="s4"># 32-bit PCM (which uses extensible format)</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-le-1ch-4bytes.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">44100</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4410</span><span class="s2">,))</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_read_2</span><span class="s2">():</span>
    <span class="s4"># 8-bit unsigned PCM</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-2ch-1byteu.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">800</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_read_3</span><span class="s2">():</span>
    <span class="s4"># Little-endian float</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-2ch-32bit-float-le.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">44100</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">441</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_read_4</span><span class="s2">():</span>
    <span class="s4"># Contains unsupported 'PEAK' chunk</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">WavFileWarning</span><span class="s2">,</span>
                       <span class="s3">&quot;Chunk .non-data. not understood, skipping it&quot;</span><span class="s2">)</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-48000Hz-2ch-64bit-float-le-wavex.wav'</span>
            <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">48000</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">480</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_read_5</span><span class="s2">():</span>
    <span class="s4"># Big-endian float</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-2ch-32bit-float-be.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">44100</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">== </span><span class="s3">'&gt;' </span><span class="s0">or </span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">== </span><span class="s3">'big' </span><span class="s0">and</span>
                                                <span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">== </span><span class="s3">'='</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">441</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_5_bit_odd_size_no_pad</span><span class="s2">():</span>
    <span class="s4"># 5-bit, 1 B container, 5 channels, 9 samples, 45 B data chunk</span>
    <span class="s4"># Generated by LTspice, which incorrectly omits pad byte, but should be</span>
    <span class="s4"># readable anyway</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-5ch-9S-5bit.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">9</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>

        <span class="s4"># 8-5 = 3 LSBits should be 0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0b00000111</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

        <span class="s4"># Unsigned</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(), </span><span class="s5">0b11111000</span><span class="s2">)  </span><span class="s4"># Highest possible</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s5">128</span><span class="s2">)  </span><span class="s4"># Midpoint is 128 for &lt;= 8-bit</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s5">0</span><span class="s2">)  </span><span class="s4"># Lowest possible</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_12_bit_even_size</span><span class="s2">():</span>
    <span class="s4"># 12-bit, 2 B container, 4 channels, 9 samples, 72 B data chunk</span>
    <span class="s4"># Generated by LTspice from 1 Vpk sine waves</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-4ch-9S-12bit.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">9</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>

        <span class="s4"># 16-12 = 4 LSBits should be 0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0b00000000_00001111</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

        <span class="s4"># Signed</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(), </span><span class="s5">0b01111111_11110000</span><span class="s2">)  </span><span class="s4"># Highest possible</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)  </span><span class="s4"># Midpoint is 0 for &gt;= 9-bit</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), -</span><span class="s5">0b10000000_00000000</span><span class="s2">)  </span><span class="s4"># Lowest possible</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_24_bit_odd_size_with_pad</span><span class="s2">():</span>
    <span class="s4"># 24-bit, 3 B container, 3 channels, 5 samples, 45 B data chunk</span>
    <span class="s4"># Should not raise any warnings about the data chunk pad byte</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-24bit.wav'</span>
    <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># All LSBytes should be 0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0xff</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4"># Hand-made max/min samples under different conventions:</span>
    <span class="s4">#                      2**(N-1)     2**(N-1)-1     LSB</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, [[-</span><span class="s5">0x8000_0000</span><span class="s2">, -</span><span class="s5">0x7fff_ff00</span><span class="s2">, -</span><span class="s5">0x200</span><span class="s2">],</span>
                        <span class="s2">[-</span><span class="s5">0x4000_0000</span><span class="s2">, -</span><span class="s5">0x3fff_ff00</span><span class="s2">, -</span><span class="s5">0x100</span><span class="s2">],</span>
                        <span class="s2">[+</span><span class="s5">0x0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000</span><span class="s2">, +</span><span class="s5">0x000</span><span class="s2">],</span>
                        <span class="s2">[+</span><span class="s5">0x4000_0000</span><span class="s2">, +</span><span class="s5">0x3fff_ff00</span><span class="s2">, +</span><span class="s5">0x100</span><span class="s2">],</span>
                        <span class="s2">[+</span><span class="s5">0x7fff_ff00</span><span class="s2">, +</span><span class="s5">0x7fff_ff00</span><span class="s2">, +</span><span class="s5">0x200</span><span class="s2">]])</span>
    <span class="s4">#                     ^ clipped</span>


<span class="s0">def </span><span class="s1">test_20_bit_extra_data</span><span class="s2">():</span>
    <span class="s4"># 20-bit, 3 B container, 1 channel, 10 samples, 30 B data chunk</span>
    <span class="s4"># with extra data filling container beyond the bit depth</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-1ch-10S-20bit-extra.wav'</span>
    <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">1234</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">10</span><span class="s2">,))</span>

    <span class="s4"># All LSBytes should still be 0, because 3 B container in 4 B dtype</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0xff</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4"># But it should load the data beyond 20 bits</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0xf00</span><span class="s2">).</span><span class="s1">any</span><span class="s2">())</span>

    <span class="s4"># Full-scale positive/negative samples, then being halved each time</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, [+</span><span class="s5">0x7ffff000</span><span class="s2">,       </span><span class="s4"># +full-scale 20-bit</span>
                        <span class="s2">-</span><span class="s5">0x7ffff000</span><span class="s2">,       </span><span class="s4"># -full-scale 20-bit</span>
                        <span class="s2">+</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">1</span><span class="s2">,  </span><span class="s4"># +1/2</span>
                        <span class="s2">-</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">1</span><span class="s2">,  </span><span class="s4"># -1/2</span>
                        <span class="s2">+</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">2</span><span class="s2">,  </span><span class="s4"># +1/4</span>
                        <span class="s2">-</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">2</span><span class="s2">,  </span><span class="s4"># -1/4</span>
                        <span class="s2">+</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">3</span><span class="s2">,  </span><span class="s4"># +1/8</span>
                        <span class="s2">-</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">3</span><span class="s2">,  </span><span class="s4"># -1/8</span>
                        <span class="s2">+</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">4</span><span class="s2">,  </span><span class="s4"># +1/16</span>
                        <span class="s2">-</span><span class="s5">0x7ffff000 </span><span class="s2">&gt;&gt; </span><span class="s5">4</span><span class="s2">,  </span><span class="s4"># -1/16</span>
                        <span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_36_bit_odd_size</span><span class="s2">():</span>
    <span class="s4"># 36-bit, 5 B container, 3 channels, 5 samples, 75 B data chunk + pad</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-36bit.wav'</span>
    <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># 28 LSBits should be 0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0xfffffff</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4"># Hand-made max/min samples under different conventions:</span>
    <span class="s4">#            Fixed-point 2**(N-1)    Full-scale 2**(N-1)-1       LSB</span>
    <span class="s1">correct </span><span class="s2">= [[-</span><span class="s5">0x8000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x7fff_ffff_f000_0000</span><span class="s2">, -</span><span class="s5">0x2000_0000</span><span class="s2">],</span>
               <span class="s2">[-</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x3fff_ffff_f000_0000</span><span class="s2">, -</span><span class="s5">0x1000_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x3fff_ffff_f000_0000</span><span class="s2">, +</span><span class="s5">0x1000_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x7fff_ffff_f000_0000</span><span class="s2">, +</span><span class="s5">0x7fff_ffff_f000_0000</span><span class="s2">, +</span><span class="s5">0x2000_0000</span><span class="s2">]]</span>
    <span class="s4">#              ^ clipped</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">correct</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_45_bit_even_size</span><span class="s2">():</span>
    <span class="s4"># 45-bit, 6 B container, 3 channels, 5 samples, 90 B data chunk</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-45bit.wav'</span>
    <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># 19 LSBits should be 0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x7ffff</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4"># Hand-made max/min samples under different conventions:</span>
    <span class="s4">#            Fixed-point 2**(N-1)    Full-scale 2**(N-1)-1      LSB</span>
    <span class="s1">correct </span><span class="s2">= [[-</span><span class="s5">0x8000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x7fff_ffff_fff8_0000</span><span class="s2">, -</span><span class="s5">0x10_0000</span><span class="s2">],</span>
               <span class="s2">[-</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x3fff_ffff_fff8_0000</span><span class="s2">, -</span><span class="s5">0x08_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x00_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x3fff_ffff_fff8_0000</span><span class="s2">, +</span><span class="s5">0x08_0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x7fff_ffff_fff8_0000</span><span class="s2">, +</span><span class="s5">0x7fff_ffff_fff8_0000</span><span class="s2">, +</span><span class="s5">0x10_0000</span><span class="s2">]]</span>
    <span class="s4">#              ^ clipped</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">correct</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_53_bit_odd_size</span><span class="s2">():</span>
    <span class="s4"># 53-bit, 7 B container, 3 channels, 5 samples, 105 B data chunk + pad</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-53bit.wav'</span>
    <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># 11 LSBits should be 0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data </span><span class="s2">&amp; </span><span class="s5">0x7ff</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s4"># Hand-made max/min samples under different conventions:</span>
    <span class="s4">#            Fixed-point 2**(N-1)    Full-scale 2**(N-1)-1    LSB</span>
    <span class="s1">correct </span><span class="s2">= [[-</span><span class="s5">0x8000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x7fff_ffff_ffff_f800</span><span class="s2">, -</span><span class="s5">0x1000</span><span class="s2">],</span>
               <span class="s2">[-</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x3fff_ffff_ffff_f800</span><span class="s2">, -</span><span class="s5">0x0800</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x3fff_ffff_ffff_f800</span><span class="s2">, +</span><span class="s5">0x0800</span><span class="s2">],</span>
               <span class="s2">[+</span><span class="s5">0x7fff_ffff_ffff_f800</span><span class="s2">, +</span><span class="s5">0x7fff_ffff_ffff_f800</span><span class="s2">, +</span><span class="s5">0x1000</span><span class="s2">]]</span>
    <span class="s4">#              ^ clipped</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">correct</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_64_bit_even_size</span><span class="s2">():</span>
    <span class="s4"># 64-bit, 8 B container, 3 channels, 5 samples, 120 B data chunk</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-64bit.wav'</span>
        <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s5">8000</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

        <span class="s4"># Hand-made max/min samples under different conventions:</span>
        <span class="s4">#            Fixed-point 2**(N-1)    Full-scale 2**(N-1)-1   LSB</span>
        <span class="s1">correct </span><span class="s2">= [[-</span><span class="s5">0x8000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x7fff_ffff_ffff_ffff</span><span class="s2">, -</span><span class="s5">0x2</span><span class="s2">],</span>
                   <span class="s2">[-</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, -</span><span class="s5">0x3fff_ffff_ffff_ffff</span><span class="s2">, -</span><span class="s5">0x1</span><span class="s2">],</span>
                   <span class="s2">[+</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x0</span><span class="s2">],</span>
                   <span class="s2">[+</span><span class="s5">0x4000_0000_0000_0000</span><span class="s2">, +</span><span class="s5">0x3fff_ffff_ffff_ffff</span><span class="s2">, +</span><span class="s5">0x1</span><span class="s2">],</span>
                   <span class="s2">[+</span><span class="s5">0x7fff_ffff_ffff_ffff</span><span class="s2">, +</span><span class="s5">0x7fff_ffff_ffff_ffff</span><span class="s2">, +</span><span class="s5">0x2</span><span class="s2">]]</span>
        <span class="s4">#              ^ clipped</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">correct</span><span class="s2">)</span>

        <span class="s0">del </span><span class="s1">data</span>


<span class="s0">def </span><span class="s1">test_unsupported_mmap</span><span class="s2">():</span>
    <span class="s4"># Test containers that cannot be mapped to numpy types</span>
    <span class="s0">for </span><span class="s1">filename </span><span class="s0">in </span><span class="s2">{</span><span class="s3">'test-8000Hz-le-3ch-5S-24bit.wav'</span><span class="s2">,</span>
                     <span class="s3">'test-8000Hz-le-3ch-5S-36bit.wav'</span><span class="s2">,</span>
                     <span class="s3">'test-8000Hz-le-3ch-5S-45bit.wav'</span><span class="s2">,</span>
                     <span class="s3">'test-8000Hz-le-3ch-5S-53bit.wav'</span><span class="s2">,</span>
                     <span class="s3">'test-8000Hz-le-1ch-10S-20bit-extra.wav'</span><span class="s2">}:</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;mmap.*not compatible&quot;</span><span class="s2">):</span>
            <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_rifx</span><span class="s2">():</span>
    <span class="s4"># Compare equivalent RIFX and RIFF files</span>
    <span class="s0">for </span><span class="s1">rifx</span><span class="s2">, </span><span class="s1">riff </span><span class="s0">in </span><span class="s2">{(</span><span class="s3">'test-44100Hz-be-1ch-4bytes.wav'</span><span class="s2">,</span>
                        <span class="s3">'test-44100Hz-le-1ch-4bytes.wav'</span><span class="s2">),</span>
                       <span class="s2">(</span><span class="s3">'test-8000Hz-be-3ch-5S-24bit.wav'</span><span class="s2">,</span>
                        <span class="s3">'test-8000Hz-le-3ch-5S-24bit.wav'</span><span class="s2">)}:</span>
        <span class="s1">rate1</span><span class="s2">, </span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">rifx</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">rate2</span><span class="s2">, </span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">riff</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate1</span><span class="s2">, </span><span class="s1">rate2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data1</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_rf64</span><span class="s2">():</span>
    <span class="s4"># Compare equivalent RF64 and RIFF files</span>
    <span class="s0">for </span><span class="s1">rf64</span><span class="s2">, </span><span class="s1">riff </span><span class="s0">in </span><span class="s2">{(</span><span class="s3">'test-44100Hz-le-1ch-4bytes-rf64.wav'</span><span class="s2">,</span>
                        <span class="s3">'test-44100Hz-le-1ch-4bytes.wav'</span><span class="s2">),</span>
                       <span class="s2">(</span><span class="s3">'test-8000Hz-le-3ch-5S-24bit-rf64.wav'</span><span class="s2">,</span>
                        <span class="s3">'test-8000Hz-le-3ch-5S-24bit.wav'</span><span class="s2">)}:</span>
        <span class="s1">rate1</span><span class="s2">, </span><span class="s1">data1 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">rf64</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">rate2</span><span class="s2">, </span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">riff</span><span class="s2">), </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rate1</span><span class="s2">, </span><span class="s1">rate2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">data1</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span>
<span class="s0">def </span><span class="s1">test_write_roundtrip_rf64</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;&lt;i8&quot;</span><span class="s2">)</span>
    <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'temp.wav'</span><span class="s2">))</span>
    <span class="s1">rate </span><span class="s2">= </span><span class="s5">44100</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">127</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">**</span><span class="s5">29</span><span class="s2">,)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">rate2</span><span class="s2">, </span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s1">rate2</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">data2</span><span class="s2">.</span><span class="s1">dtype</span><span class="s0">} </span><span class="s3">byteorder not in ('&lt;', '=', '|')&quot;</span>
    <span class="s0">assert </span><span class="s1">data2</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'&lt;'</span><span class="s2">, </span><span class="s3">'='</span><span class="s2">, </span><span class="s3">'|'</span><span class="s2">), </span><span class="s1">msg</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">)</span>
    <span class="s4"># also test writing (gh-12176)</span>
    <span class="s1">data2</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>


<span class="s0">def </span><span class="s1">test_read_unknown_filetype_fail</span><span class="s2">():</span>
    <span class="s4"># Not an RIFF</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'example_1.nc'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;CDF.*'RIFF', 'RIFX', and 'RF64' supported&quot;</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_unknown_riff_form_type</span><span class="s2">():</span>
    <span class="s4"># RIFF, but not WAVE form</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'Transparent Busy.ani'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Not a WAV file.*ACON'</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_unknown_wave_format</span><span class="s2">():</span>
    <span class="s4"># RIFF and WAVE, but not supported format</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-1ch-1byte-ulaw.wav'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Unknown wave file format.*MULAW.*'</span>
                        <span class="s3">'Supported formats'</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_early_eof_with_data</span><span class="s2">():</span>
    <span class="s4"># File ends inside 'data' chunk, but we keep incomplete data</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-le-1ch-4bytes-early-eof.wav'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">warns</span><span class="s2">(</span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">WavFileWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Reached EOF'</span><span class="s2">):</span>
                <span class="s1">rate</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0</span>
                <span class="s0">assert </span><span class="s1">rate </span><span class="s2">== </span><span class="s5">44100</span>
                <span class="s4"># also test writing (gh-12176)</span>
                <span class="s1">data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>


<span class="s0">def </span><span class="s1">test_read_early_eof</span><span class="s2">():</span>
    <span class="s4"># File ends after 'fact' chunk at boundary, no data read</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-le-1ch-4bytes-early-eof-no-data.wav'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Unexpected end of file.&quot;</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_incomplete_chunk</span><span class="s2">():</span>
    <span class="s4"># File ends inside 'fmt ' chunk ID, no data read</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-44100Hz-le-1ch-4bytes-incomplete-chunk.wav'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Incomplete chunk ID.*b'f'&quot;</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_inconsistent_header</span><span class="s2">():</span>
    <span class="s4"># File header's size fields contradict each other</span>
    <span class="s0">for </span><span class="s1">mmap </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s3">'test-8000Hz-le-3ch-5S-24bit-inconsistent.wav'</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">datafile</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">), </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;header is invalid&quot;</span><span class="s2">):</span>
                <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>


<span class="s4"># signed 8-bit integer PCM is not allowed</span>
<span class="s4"># unsigned &gt; 8-bit integer PCM is not allowed</span>
<span class="s4"># 8- or 16-bit float PCM is not expected</span>
<span class="s4"># g and q are platform-dependent, so not included</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dt_str&quot;</span><span class="s2">, [</span><span class="s3">&quot;&lt;i2&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;i4&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;i8&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;f4&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;f8&quot;</span><span class="s2">,</span>
                                    <span class="s3">&quot;&gt;i2&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;i4&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;i8&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;f4&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;f8&quot;</span><span class="s2">, </span><span class="s3">'|u1'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;channels&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;rate&quot;</span><span class="s2">, [</span><span class="s5">8000</span><span class="s2">, </span><span class="s5">32000</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;mmap&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;realfile&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_write_roundtrip</span><span class="s2">(</span><span class="s1">realfile</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">channels</span><span class="s2">, </span><span class="s1">dt_str</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dt_str</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">realfile</span><span class="s2">:</span>
        <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'temp.wav'</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s1">channels</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">channels </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">'f'</span><span class="s2">:</span>
        <span class="s4"># The range of the float type should be in [-1, 1]</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">data</span><span class="s2">*</span><span class="s5">128</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">rate2</span><span class="s2">, </span><span class="s1">data2 </span><span class="s2">= </span><span class="s1">wavfile</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s1">mmap</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rate</span><span class="s2">, </span><span class="s1">rate2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">data2</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'&lt;'</span><span class="s2">, </span><span class="s3">'='</span><span class="s2">, </span><span class="s3">'|'</span><span class="s2">), </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">data2</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">)</span>
    <span class="s4"># also test writing (gh-12176)</span>
    <span class="s0">if </span><span class="s1">realfile</span><span class="s2">:</span>
        <span class="s1">data2</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'read-only'</span><span class="s2">):</span>
            <span class="s1">data2</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>

    <span class="s0">if </span><span class="s1">realfile </span><span class="s0">and </span><span class="s1">mmap </span><span class="s0">and </span><span class="s1">IS_PYPY </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win32'</span><span class="s2">:</span>
        <span class="s4"># windows cannot remove a dead file held by a mmap but not collected</span>
        <span class="s4"># in PyPy; since the filename gets reused in this test, clean this up</span>
        <span class="s1">break_cycles</span><span class="s2">()</span>
        <span class="s1">break_cycles</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_wavfile_dtype_unsupported</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">tmpfile </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'temp.wav'</span><span class="s2">))</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">1234</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">100</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">rate </span><span class="s2">= </span><span class="s5">8000</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Unsupported&quot;</span><span class="s2">):</span>
        <span class="s1">wavfile</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">tmpfile</span><span class="s2">, </span><span class="s1">rate</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
</pre>
</body>
</html>