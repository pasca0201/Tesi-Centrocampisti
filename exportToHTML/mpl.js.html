<html>
<head>
<title>mpl.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
mpl.js</font>
</center></td></tr></table>
<pre><span class="s0">/* Put everything inside the global mpl namespace */</span>
<span class="s0">/* global mpl */</span>
<span class="s1">window</span><span class="s2">.</span><span class="s1">mpl </span><span class="s2">= {};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">get_websocket_type </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">WebSocket </span><span class="s2">!== </span><span class="s4">'undefined'</span><span class="s2">) {</span>
        <span class="s3">return </span><span class="s1">WebSocket</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">MozWebSocket </span><span class="s2">!== </span><span class="s4">'undefined'</span><span class="s2">) {</span>
        <span class="s3">return </span><span class="s1">MozWebSocket</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">alert</span><span class="s2">(</span>
            <span class="s4">'Your browser does not have WebSocket support. ' </span><span class="s2">+</span>
                <span class="s4">'Please try Chrome, Safari or Firefox â‰¥ 6. ' </span><span class="s2">+</span>
                <span class="s4">'Firefox 4 and 5 are also supported but you ' </span><span class="s2">+</span>
                <span class="s4">'have to enable WebSockets in about:config.'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">figure_id</span><span class="s2">, </span><span class="s1">websocket</span><span class="s2">, </span><span class="s1">ondownload</span><span class="s2">, </span><span class="s1">parent_element</span><span class="s2">) {</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">id </span><span class="s2">= </span><span class="s1">figure_id</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">ws </span><span class="s2">= </span><span class="s1">websocket</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">supports_binary </span><span class="s2">= </span><span class="s3">this</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">binaryType </span><span class="s2">!== </span><span class="s1">undefined</span><span class="s2">;</span>

    <span class="s3">if </span><span class="s2">(!</span><span class="s3">this</span><span class="s2">.</span><span class="s1">supports_binary</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">warnings </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">getElementById</span><span class="s2">(</span><span class="s4">'mpl-warnings'</span><span class="s2">);</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">warnings</span><span class="s2">) {</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">display </span><span class="s2">= </span><span class="s4">'block'</span><span class="s2">;</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">textContent </span><span class="s2">=</span>
                <span class="s4">'This browser does not support binary websocket messages. ' </span><span class="s2">+</span>
                <span class="s4">'Performance may be slow.'</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">imageObj </span><span class="s2">= </span><span class="s3">new </span><span class="s1">Image</span><span class="s2">();</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">message </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">rubberband_canvas </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">rubberband_context </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">format_dropdown </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">image_mode </span><span class="s2">= </span><span class="s4">'full'</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'style'</span><span class="s2">, </span><span class="s4">'display: inline-block'</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">_root_extra_style</span><span class="s2">(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">);</span>

    <span class="s1">parent_element</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">_init_header</span><span class="s2">(</span><span class="s3">this</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">_init_canvas</span><span class="s2">(</span><span class="s3">this</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">_init_toolbar</span><span class="s2">(</span><span class="s3">this</span><span class="s2">);</span>

    <span class="s3">var </span><span class="s1">fig </span><span class="s2">= </span><span class="s3">this</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">waiting </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">onopen </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'supports_binary'</span><span class="s2">, { </span><span class="s1">value</span><span class="s2">: </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">supports_binary </span><span class="s2">});</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'send_image_mode'</span><span class="s2">, {});</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio </span><span class="s2">!== </span><span class="s5">1</span><span class="s2">) {</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'set_device_pixel_ratio'</span><span class="s2">, {</span>
                <span class="s1">device_pixel_ratio</span><span class="s2">: </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">,</span>
            <span class="s2">});</span>
        <span class="s2">}</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'refresh'</span><span class="s2">, {});</span>
    <span class="s2">};</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">onload </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">image_mode </span><span class="s2">=== </span><span class="s4">'full'</span><span class="s2">) {</span>
            <span class="s0">// Full images could contain transparency (where diff images</span>
            <span class="s0">// almost always do), so we need to clear the canvas so that</span>
            <span class="s0">// there is no ghosting.</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">clearRect</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">width</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">drawImage</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">);</span>
    <span class="s2">};</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">onunload </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">close</span><span class="s2">();</span>
    <span class="s2">};</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">onmessage </span><span class="s2">= </span><span class="s3">this</span><span class="s2">.</span><span class="s1">_make_on_message_function</span><span class="s2">(</span><span class="s3">this</span><span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">ondownload </span><span class="s2">= </span><span class="s1">ondownload</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_init_header </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s3">var </span><span class="s1">titlebar </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
    <span class="s1">titlebar</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">=</span>
        <span class="s4">'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix'</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">titletext </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
    <span class="s1">titletext</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'ui-dialog-title'</span><span class="s2">;</span>
    <span class="s1">titletext</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
        <span class="s4">'style'</span><span class="s2">,</span>
        <span class="s4">'width: 100%; text-align: center; padding: 3px;'</span>
    <span class="s2">);</span>
    <span class="s1">titlebar</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">titletext</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">titlebar</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">header </span><span class="s2">= </span><span class="s1">titletext</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_canvas_extra_style </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">_canvas_div</span><span class="s2">) {};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_root_extra_style </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">_canvas_div</span><span class="s2">) {};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_init_canvas </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s3">var </span><span class="s1">fig </span><span class="s2">= </span><span class="s3">this</span><span class="s2">;</span>

    <span class="s3">var </span><span class="s1">canvas_div </span><span class="s2">= (</span><span class="s3">this</span><span class="s2">.</span><span class="s1">canvas_div </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">));</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'tabindex'</span><span class="s2">, </span><span class="s4">'0'</span><span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
        <span class="s4">'style'</span><span class="s2">,</span>
        <span class="s4">'border: 1px solid #ddd;' </span><span class="s2">+</span>
            <span class="s4">'box-sizing: content-box;' </span><span class="s2">+</span>
            <span class="s4">'clear: both;' </span><span class="s2">+</span>
            <span class="s4">'min-height: 1px;' </span><span class="s2">+</span>
            <span class="s4">'min-width: 1px;' </span><span class="s2">+</span>
            <span class="s4">'outline: 0;' </span><span class="s2">+</span>
            <span class="s4">'overflow: hidden;' </span><span class="s2">+</span>
            <span class="s4">'position: relative;' </span><span class="s2">+</span>
            <span class="s4">'resize: both;' </span><span class="s2">+</span>
            <span class="s4">'z-index: 2;'</span>
    <span class="s2">);</span>

    <span class="s3">function </span><span class="s1">on_keyboard_event_closure</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
        <span class="s3">return function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
            <span class="s3">return </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">key_event</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">);</span>
        <span class="s2">};</span>
    <span class="s2">}</span>

    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'keydown'</span><span class="s2">,</span>
        <span class="s1">on_keyboard_event_closure</span><span class="s2">(</span><span class="s4">'key_press'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'keyup'</span><span class="s2">,</span>
        <span class="s1">on_keyboard_event_closure</span><span class="s2">(</span><span class="s4">'key_release'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">_canvas_extra_style</span><span class="s2">(</span><span class="s1">canvas_div</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">canvas_div</span><span class="s2">);</span>

    <span class="s3">var </span><span class="s1">canvas </span><span class="s2">= (</span><span class="s3">this</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'canvas'</span><span class="s2">));</span>
    <span class="s1">canvas</span><span class="s2">.</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">'mpl-canvas'</span><span class="s2">);</span>
    <span class="s1">canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
        <span class="s4">'style'</span><span class="s2">,</span>
        <span class="s4">'box-sizing: content-box;' </span><span class="s2">+</span>
            <span class="s4">'pointer-events: none;' </span><span class="s2">+</span>
            <span class="s4">'position: relative;' </span><span class="s2">+</span>
            <span class="s4">'z-index: 0;'</span>
    <span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">getContext</span><span class="s2">(</span><span class="s4">'2d'</span><span class="s2">);</span>

    <span class="s3">var </span><span class="s1">backingStore </span><span class="s2">=</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">backingStorePixelRatio </span><span class="s2">||</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">webkitBackingStorePixelRatio </span><span class="s2">||</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">mozBackingStorePixelRatio </span><span class="s2">||</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">msBackingStorePixelRatio </span><span class="s2">||</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">oBackingStorePixelRatio </span><span class="s2">||</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">backingStorePixelRatio </span><span class="s2">||</span>
        <span class="s5">1</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">ratio </span><span class="s2">= (</span><span class="s1">window</span><span class="s2">.</span><span class="s1">devicePixelRatio </span><span class="s2">|| </span><span class="s5">1</span><span class="s2">) / </span><span class="s1">backingStore</span><span class="s2">;</span>

    <span class="s3">var </span><span class="s1">rubberband_canvas </span><span class="s2">= (</span><span class="s3">this</span><span class="s2">.</span><span class="s1">rubberband_canvas </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span>
        <span class="s4">'canvas'</span>
    <span class="s2">));</span>
    <span class="s1">rubberband_canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
        <span class="s4">'style'</span><span class="s2">,</span>
        <span class="s4">'box-sizing: content-box;' </span><span class="s2">+</span>
            <span class="s4">'left: 0;' </span><span class="s2">+</span>
            <span class="s4">'pointer-events: none;' </span><span class="s2">+</span>
            <span class="s4">'position: absolute;' </span><span class="s2">+</span>
            <span class="s4">'top: 0;' </span><span class="s2">+</span>
            <span class="s4">'z-index: 1;'</span>
    <span class="s2">);</span>

    <span class="s0">// Apply a ponyfill if ResizeObserver is not implemented by browser.</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">ResizeObserver </span><span class="s2">=== </span><span class="s1">undefined</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">window</span><span class="s2">.</span><span class="s1">ResizeObserver </span><span class="s2">!== </span><span class="s1">undefined</span><span class="s2">) {</span>
            <span class="s3">this</span><span class="s2">.</span><span class="s1">ResizeObserver </span><span class="s2">= </span><span class="s1">window</span><span class="s2">.</span><span class="s1">ResizeObserver</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s3">var </span><span class="s1">obs </span><span class="s2">= </span><span class="s1">_JSXTOOLS_RESIZE_OBSERVER</span><span class="s2">({});</span>
            <span class="s3">this</span><span class="s2">.</span><span class="s1">ResizeObserver </span><span class="s2">= </span><span class="s1">obs</span><span class="s2">.</span><span class="s1">ResizeObserver</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">resizeObserverInstance </span><span class="s2">= </span><span class="s3">new this</span><span class="s2">.</span><span class="s1">ResizeObserver</span><span class="s2">(</span><span class="s3">function </span><span class="s2">(</span><span class="s1">entries</span><span class="s2">) {</span>
        <span class="s0">// There's no need to resize if the WebSocket is not connected:</span>
        <span class="s0">// - If it is still connecting, then we will get an initial resize from</span>
        <span class="s0">//   Python once it connects.</span>
        <span class="s0">// - If it has disconnected, then resizing will clear the canvas and</span>
        <span class="s0">//   never get anything back to refill it, so better to not resize and</span>
        <span class="s0">//   keep something visible.</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">readyState </span><span class="s2">!= </span><span class="s5">1</span><span class="s2">) {</span>
            <span class="s3">return</span><span class="s2">;</span>
        <span class="s2">}</span>
        <span class="s3">var </span><span class="s1">nentries </span><span class="s2">= </span><span class="s1">entries</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
        <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">nentries</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
            <span class="s3">var </span><span class="s1">entry </span><span class="s2">= </span><span class="s1">entries</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
            <span class="s3">var </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">;</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize</span><span class="s2">) {</span>
                <span class="s3">if </span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize </span><span class="s3">instanceof </span><span class="s1">Array</span><span class="s2">) {</span>
                    <span class="s0">// Chrome 84 implements new version of spec.</span>
                    <span class="s1">width </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">inlineSize</span><span class="s2">;</span>
                    <span class="s1">height </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">blockSize</span><span class="s2">;</span>
                <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                    <span class="s0">// Firefox implements old version of spec.</span>
                    <span class="s1">width </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize</span><span class="s2">.</span><span class="s1">inlineSize</span><span class="s2">;</span>
                    <span class="s1">height </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentBoxSize</span><span class="s2">.</span><span class="s1">blockSize</span><span class="s2">;</span>
                <span class="s2">}</span>
            <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                <span class="s0">// Chrome &lt;84 implements even older version of spec.</span>
                <span class="s1">width </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentRect</span><span class="s2">.</span><span class="s1">width</span><span class="s2">;</span>
                <span class="s1">height </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">contentRect</span><span class="s2">.</span><span class="s1">height</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">// Keep the size of the canvas and rubber band canvas in sync with</span>
            <span class="s0">// the canvas container.</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">devicePixelContentBoxSize</span><span class="s2">) {</span>
                <span class="s0">// Chrome 84 implements new version of spec.</span>
                <span class="s1">canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
                    <span class="s4">'width'</span><span class="s2">,</span>
                    <span class="s1">entry</span><span class="s2">.</span><span class="s1">devicePixelContentBoxSize</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">inlineSize</span>
                <span class="s2">);</span>
                <span class="s1">canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span>
                    <span class="s4">'height'</span><span class="s2">,</span>
                    <span class="s1">entry</span><span class="s2">.</span><span class="s1">devicePixelContentBoxSize</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">blockSize</span>
                <span class="s2">);</span>
            <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
                <span class="s1">canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'width'</span><span class="s2">, </span><span class="s1">width </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">);</span>
                <span class="s1">canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'height'</span><span class="s2">, </span><span class="s1">height </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">);</span>
            <span class="s2">}</span>
            <span class="s0">/* This rescales the canvas back to display pixels, so that it 
             * appears correct on HiDPI screens. */</span>
            <span class="s1">canvas</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">width </span><span class="s2">+ </span><span class="s4">'px'</span><span class="s2">;</span>
            <span class="s1">canvas</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">height </span><span class="s2">+ </span><span class="s4">'px'</span><span class="s2">;</span>

            <span class="s1">rubberband_canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'width'</span><span class="s2">, </span><span class="s1">width</span><span class="s2">);</span>
            <span class="s1">rubberband_canvas</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'height'</span><span class="s2">, </span><span class="s1">height</span><span class="s2">);</span>

            <span class="s0">// And update the size in Python. We ignore the initial 0/0 size</span>
            <span class="s0">// that occurs as the element is placed into the DOM, which should</span>
            <span class="s0">// otherwise not happen due to the minimum size styling.</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">width </span><span class="s2">!= </span><span class="s5">0 </span><span class="s2">&amp;&amp; </span><span class="s1">height </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">) {</span>
                <span class="s1">fig</span><span class="s2">.</span><span class="s1">request_resize</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">);</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
    <span class="s2">});</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">resizeObserverInstance</span><span class="s2">.</span><span class="s1">observe</span><span class="s2">(</span><span class="s1">canvas_div</span><span class="s2">);</span>

    <span class="s3">function </span><span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
        <span class="s0">/* User Agent sniffing is bad, but WebKit is busted: 
         * https://bugs.webkit.org/show_bug.cgi?id=144526 
         * https://bugs.webkit.org/show_bug.cgi?id=181818 
         * The worst that happens here is that they get an extra browser 
         * selection when dragging, if this check fails to catch them. 
         */</span>
        <span class="s3">var </span><span class="s1">UA </span><span class="s2">= </span><span class="s1">navigator</span><span class="s2">.</span><span class="s1">userAgent</span><span class="s2">;</span>
        <span class="s3">var </span><span class="s1">isWebKit </span><span class="s2">= </span><span class="s6">/AppleWebKit/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">UA</span><span class="s2">) &amp;&amp; !</span><span class="s6">/Chrome/</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s1">UA</span><span class="s2">);</span>
        <span class="s3">if</span><span class="s2">(</span><span class="s1">isWebKit</span><span class="s2">) {</span>
            <span class="s3">return function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
                <span class="s0">/* This prevents the web browser from automatically changing to 
                 * the text insertion cursor when the button is pressed. We 
                 * want to control all of the cursor setting manually through 
                 * the 'cursor' event from matplotlib */</span>
                <span class="s1">event</span><span class="s2">.</span><span class="s1">preventDefault</span><span class="s2">()</span>
                <span class="s3">return </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">mouse_event</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">);</span>
            <span class="s2">};</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s3">return function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
                <span class="s3">return </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">mouse_event</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">);</span>
            <span class="s2">};</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'mousedown'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'button_press'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'mouseup'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'button_release'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'dblclick'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'dblclick'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">// Throttle sequential mouse events to 1 every 20ms.</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'mousemove'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'motion_notify'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'mouseenter'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'figure_enter'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span>
        <span class="s4">'mouseleave'</span><span class="s2">,</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'figure_leave'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'wheel'</span><span class="s2">, </span><span class="s3">function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">deltaY </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">) {</span>
            <span class="s1">event</span><span class="s2">.</span><span class="s1">step </span><span class="s2">= </span><span class="s5">1</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s1">event</span><span class="s2">.</span><span class="s1">step </span><span class="s2">= -</span><span class="s5">1</span><span class="s2">;</span>
        <span class="s2">}</span>
        <span class="s1">on_mouse_event_closure</span><span class="s2">(</span><span class="s4">'scroll'</span><span class="s2">)(</span><span class="s1">event</span><span class="s2">);</span>
    <span class="s2">});</span>

    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">canvas</span><span class="s2">);</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">rubberband_canvas</span><span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">rubberband_context </span><span class="s2">= </span><span class="s1">rubberband_canvas</span><span class="s2">.</span><span class="s1">getContext</span><span class="s2">(</span><span class="s4">'2d'</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">rubberband_context</span><span class="s2">.</span><span class="s1">strokeStyle </span><span class="s2">= </span><span class="s4">'#000000'</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">_resize_canvas </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">forward</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">forward</span><span class="s2">) {</span>
            <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">width </span><span class="s2">+ </span><span class="s4">'px'</span><span class="s2">;</span>
            <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">height </span><span class="s2">+ </span><span class="s4">'px'</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">};</span>

    <span class="s0">// Disable right mouse context menu.</span>
    <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'contextmenu'</span><span class="s2">, </span><span class="s3">function </span><span class="s2">(</span><span class="s1">_e</span><span class="s2">) {</span>
        <span class="s1">event</span><span class="s2">.</span><span class="s1">preventDefault</span><span class="s2">();</span>
        <span class="s3">return false</span><span class="s2">;</span>
    <span class="s2">});</span>

    <span class="s3">function </span><span class="s1">set_focus</span><span class="s2">() {</span>
        <span class="s1">canvas</span><span class="s2">.</span><span class="s1">focus</span><span class="s2">();</span>
        <span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">focus</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">window</span><span class="s2">.</span><span class="s1">setTimeout</span><span class="s2">(</span><span class="s1">set_focus</span><span class="s2">, </span><span class="s5">100</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_init_toolbar </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s3">var </span><span class="s1">fig </span><span class="s2">= </span><span class="s3">this</span><span class="s2">;</span>

    <span class="s3">var </span><span class="s1">toolbar </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
    <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-toolbar'</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">toolbar</span><span class="s2">);</span>

    <span class="s3">function </span><span class="s1">on_click_closure</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
        <span class="s3">return function </span><span class="s2">(</span><span class="s1">_event</span><span class="s2">) {</span>
            <span class="s3">return </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">toolbar_button_onclick</span><span class="s2">(</span><span class="s1">name</span><span class="s2">);</span>
        <span class="s2">};</span>
    <span class="s2">}</span>

    <span class="s3">function </span><span class="s1">on_mouseover_closure</span><span class="s2">(</span><span class="s1">tooltip</span><span class="s2">) {</span>
        <span class="s3">return function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
            <span class="s3">if </span><span class="s2">(!</span><span class="s1">event</span><span class="s2">.</span><span class="s1">currentTarget</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">) {</span>
                <span class="s3">return </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">toolbar_button_onmouseover</span><span class="s2">(</span><span class="s1">tooltip</span><span class="s2">);</span>
            <span class="s2">}</span>
        <span class="s2">};</span>
    <span class="s2">}</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons </span><span class="s2">= {};</span>
    <span class="s3">var </span><span class="s1">buttonGroup </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
    <span class="s1">buttonGroup</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-button-group'</span><span class="s2">;</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">toolbar_ind </span><span class="s3">in </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">toolbar_items</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">name </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">toolbar_items</span><span class="s2">[</span><span class="s1">toolbar_ind</span><span class="s2">][</span><span class="s5">0</span><span class="s2">];</span>
        <span class="s3">var </span><span class="s1">tooltip </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">toolbar_items</span><span class="s2">[</span><span class="s1">toolbar_ind</span><span class="s2">][</span><span class="s5">1</span><span class="s2">];</span>
        <span class="s3">var </span><span class="s1">image </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">toolbar_items</span><span class="s2">[</span><span class="s1">toolbar_ind</span><span class="s2">][</span><span class="s5">2</span><span class="s2">];</span>
        <span class="s3">var </span><span class="s1">method_name </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">toolbar_items</span><span class="s2">[</span><span class="s1">toolbar_ind</span><span class="s2">][</span><span class="s5">3</span><span class="s2">];</span>

        <span class="s3">if </span><span class="s2">(!</span><span class="s1">name</span><span class="s2">) {</span>
            <span class="s0">/* Instead of a spacer, we start a new button group. */</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">buttonGroup</span><span class="s2">.</span><span class="s1">hasChildNodes</span><span class="s2">()) {</span>
                <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">buttonGroup</span><span class="s2">);</span>
            <span class="s2">}</span>
            <span class="s1">buttonGroup </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'div'</span><span class="s2">);</span>
            <span class="s1">buttonGroup</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-button-group'</span><span class="s2">;</span>
            <span class="s3">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s3">var </span><span class="s1">button </span><span class="s2">= (</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'button'</span><span class="s2">));</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-widget'</span><span class="s2">;</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'role'</span><span class="s2">, </span><span class="s4">'button'</span><span class="s2">);</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'aria-disabled'</span><span class="s2">, </span><span class="s4">'false'</span><span class="s2">);</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'click'</span><span class="s2">, </span><span class="s1">on_click_closure</span><span class="s2">(</span><span class="s1">method_name</span><span class="s2">));</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">addEventListener</span><span class="s2">(</span><span class="s4">'mouseover'</span><span class="s2">, </span><span class="s1">on_mouseover_closure</span><span class="s2">(</span><span class="s1">tooltip</span><span class="s2">));</span>

        <span class="s3">var </span><span class="s1">icon_img </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'img'</span><span class="s2">);</span>
        <span class="s1">icon_img</span><span class="s2">.</span><span class="s1">src </span><span class="s2">= </span><span class="s4">'_images/' </span><span class="s2">+ </span><span class="s1">image </span><span class="s2">+ </span><span class="s4">'.png'</span><span class="s2">;</span>
        <span class="s1">icon_img</span><span class="s2">.</span><span class="s1">srcset </span><span class="s2">= </span><span class="s4">'_images/' </span><span class="s2">+ </span><span class="s1">image </span><span class="s2">+ </span><span class="s4">'_large.png 2x'</span><span class="s2">;</span>
        <span class="s1">icon_img</span><span class="s2">.</span><span class="s1">alt </span><span class="s2">= </span><span class="s1">tooltip</span><span class="s2">;</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">icon_img</span><span class="s2">);</span>

        <span class="s1">buttonGroup</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">button</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s3">if </span><span class="s2">(</span><span class="s1">buttonGroup</span><span class="s2">.</span><span class="s1">hasChildNodes</span><span class="s2">()) {</span>
        <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">buttonGroup</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s3">var </span><span class="s1">fmt_picker </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'select'</span><span class="s2">);</span>
    <span class="s1">fmt_picker</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-widget'</span><span class="s2">;</span>
    <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">fmt_picker</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">format_dropdown </span><span class="s2">= </span><span class="s1">fmt_picker</span><span class="s2">;</span>

    <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">ind </span><span class="s3">in </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">extensions</span><span class="s2">) {</span>
        <span class="s3">var </span><span class="s1">fmt </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">extensions</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">];</span>
        <span class="s3">var </span><span class="s1">option </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'option'</span><span class="s2">);</span>
        <span class="s1">option</span><span class="s2">.</span><span class="s1">selected </span><span class="s2">= </span><span class="s1">fmt </span><span class="s2">=== </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">default_extension</span><span class="s2">;</span>
        <span class="s1">option</span><span class="s2">.</span><span class="s1">innerHTML </span><span class="s2">= </span><span class="s1">fmt</span><span class="s2">;</span>
        <span class="s1">fmt_picker</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">option</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s3">var </span><span class="s1">status_bar </span><span class="s2">= </span><span class="s1">document</span><span class="s2">.</span><span class="s1">createElement</span><span class="s2">(</span><span class="s4">'span'</span><span class="s2">);</span>
    <span class="s1">status_bar</span><span class="s2">.</span><span class="s1">classList </span><span class="s2">= </span><span class="s4">'mpl-message'</span><span class="s2">;</span>
    <span class="s1">toolbar</span><span class="s2">.</span><span class="s1">appendChild</span><span class="s2">(</span><span class="s1">status_bar</span><span class="s2">);</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">message </span><span class="s2">= </span><span class="s1">status_bar</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">request_resize </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">x_pixels</span><span class="s2">, </span><span class="s1">y_pixels</span><span class="s2">) {</span>
    <span class="s0">// Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,</span>
    <span class="s0">// which will in turn request a refresh of the image.</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'resize'</span><span class="s2">, { </span><span class="s1">width</span><span class="s2">: </span><span class="s1">x_pixels</span><span class="s2">, </span><span class="s1">height</span><span class="s2">: </span><span class="s1">y_pixels </span><span class="s2">});</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">send_message </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">properties</span><span class="s2">) {</span>
    <span class="s1">properties</span><span class="s2">[</span><span class="s4">'type'</span><span class="s2">] = </span><span class="s1">type</span><span class="s2">;</span>
    <span class="s1">properties</span><span class="s2">[</span><span class="s4">'figure_id'</span><span class="s2">] = </span><span class="s3">this</span><span class="s2">.</span><span class="s1">id</span><span class="s2">;</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">JSON</span><span class="s2">.</span><span class="s1">stringify</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">));</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">send_draw_message </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s3">if </span><span class="s2">(!</span><span class="s3">this</span><span class="s2">.</span><span class="s1">waiting</span><span class="s2">) {</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">waiting </span><span class="s2">= </span><span class="s3">true</span><span class="s2">;</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">ws</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">JSON</span><span class="s2">.</span><span class="s1">stringify</span><span class="s2">({ </span><span class="s1">type</span><span class="s2">: </span><span class="s4">'draw'</span><span class="s2">, </span><span class="s1">figure_id</span><span class="s2">: </span><span class="s3">this</span><span class="s2">.</span><span class="s1">id </span><span class="s2">}));</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_save </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">_msg</span><span class="s2">) {</span>
    <span class="s3">var </span><span class="s1">format_dropdown </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">format_dropdown</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">format </span><span class="s2">= </span><span class="s1">format_dropdown</span><span class="s2">.</span><span class="s1">options</span><span class="s2">[</span><span class="s1">format_dropdown</span><span class="s2">.</span><span class="s1">selectedIndex</span><span class="s2">].</span><span class="s1">value</span><span class="s2">;</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">ondownload</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">format</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_resize </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s3">var </span><span class="s1">size </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'size'</span><span class="s2">];</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">size</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] !== </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">width </span><span class="s2">|| </span><span class="s1">size</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] !== </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height</span><span class="s2">) {</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">_resize_canvas</span><span class="s2">(</span><span class="s1">size</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">size</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'forward'</span><span class="s2">]);</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'refresh'</span><span class="s2">, {});</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_rubberband </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s3">var </span><span class="s1">x0 </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'x0'</span><span class="s2">] / </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">y0 </span><span class="s2">= (</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'y0'</span><span class="s2">]) / </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">x1 </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'x1'</span><span class="s2">] / </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">y1 </span><span class="s2">= (</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'y1'</span><span class="s2">]) / </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>
    <span class="s1">x0 </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">) + </span><span class="s5">0.5</span><span class="s2">;</span>
    <span class="s1">y0 </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">) + </span><span class="s5">0.5</span><span class="s2">;</span>
    <span class="s1">x1 </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">) + </span><span class="s5">0.5</span><span class="s2">;</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">) + </span><span class="s5">0.5</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">min_x </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">);</span>
    <span class="s3">var </span><span class="s1">min_y </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">);</span>
    <span class="s3">var </span><span class="s1">width </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x0</span><span class="s2">);</span>
    <span class="s3">var </span><span class="s1">height </span><span class="s2">= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y1 </span><span class="s2">- </span><span class="s1">y0</span><span class="s2">);</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">rubberband_context</span><span class="s2">.</span><span class="s1">clearRect</span><span class="s2">(</span>
        <span class="s5">0</span><span class="s2">,</span>
        <span class="s5">0</span><span class="s2">,</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">,</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height </span><span class="s2">/ </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ratio</span>
    <span class="s2">);</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">rubberband_context</span><span class="s2">.</span><span class="s1">strokeRect</span><span class="s2">(</span><span class="s1">min_x</span><span class="s2">, </span><span class="s1">min_y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_figure_label </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s0">// Updates the figure title.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">header</span><span class="s2">.</span><span class="s1">textContent </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'label'</span><span class="s2">];</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_cursor </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">cursor </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'cursor'</span><span class="s2">];</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_message </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">message</span><span class="s2">.</span><span class="s1">textContent </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'message'</span><span class="s2">];</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_draw </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">_msg</span><span class="s2">) {</span>
    <span class="s0">// Request the server to send over a new figure.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">send_draw_message</span><span class="s2">();</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_image_mode </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">image_mode </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'mode'</span><span class="s2">];</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_history_buttons </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s1">key </span><span class="s3">in </span><span class="s1">msg</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(!(</span><span class="s1">key </span><span class="s3">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">)) {</span>
            <span class="s3">continue</span><span class="s2">;</span>
        <span class="s2">}</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">disabled </span><span class="s2">= !</span><span class="s1">msg</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s4">'aria-disabled'</span><span class="s2">, !</span><span class="s1">msg</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]);</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">handle_navigate_mode </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) {</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'mode'</span><span class="s2">] === </span><span class="s4">'PAN'</span><span class="s2">) {</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Pan'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Zoom'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'mode'</span><span class="s2">] === </span><span class="s4">'ZOOM'</span><span class="s2">) {</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Pan'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Zoom'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Pan'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">buttons</span><span class="s2">[</span><span class="s4">'Zoom'</span><span class="s2">].</span><span class="s1">classList</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">'active'</span><span class="s2">);</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">updated_canvas_event </span><span class="s2">= </span><span class="s3">function </span><span class="s2">() {</span>
    <span class="s0">// Called whenever the canvas gets updated.</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'ack'</span><span class="s2">, {});</span>
<span class="s2">};</span>

<span class="s0">// A function to construct a web socket function for onmessage handling.</span>
<span class="s0">// Called in the figure constructor.</span>
<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_make_on_message_function </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">) {</span>
    <span class="s3">return function </span><span class="s1">socket_on_message</span><span class="s2">(</span><span class="s1">evt</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">evt</span><span class="s2">.</span><span class="s1">data </span><span class="s3">instanceof </span><span class="s1">Blob</span><span class="s2">) {</span>
            <span class="s3">var </span><span class="s1">img </span><span class="s2">= </span><span class="s1">evt</span><span class="s2">.</span><span class="s1">data</span><span class="s2">;</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">img</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!== </span><span class="s4">'image/png'</span><span class="s2">) {</span>
                <span class="s0">/* FIXME: We get &quot;Resource interpreted as Image but 
                 * transferred with MIME type text/plain:&quot; errors on 
                 * Chrome.  But how to set the MIME type?  It doesn't seem 
                 * to be part of the websocket stream */</span>
                <span class="s1">img</span><span class="s2">.</span><span class="s1">type </span><span class="s2">= </span><span class="s4">'image/png'</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">/* Free the memory for the previous frames */</span>
            <span class="s3">if </span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">src</span><span class="s2">) {</span>
                <span class="s2">(</span><span class="s1">window</span><span class="s2">.</span><span class="s1">URL </span><span class="s2">|| </span><span class="s1">window</span><span class="s2">.</span><span class="s1">webkitURL</span><span class="s2">).</span><span class="s1">revokeObjectURL</span><span class="s2">(</span>
                    <span class="s1">fig</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">src</span>
                <span class="s2">);</span>
            <span class="s2">}</span>

            <span class="s1">fig</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">src </span><span class="s2">= (</span><span class="s1">window</span><span class="s2">.</span><span class="s1">URL </span><span class="s2">|| </span><span class="s1">window</span><span class="s2">.</span><span class="s1">webkitURL</span><span class="s2">).</span><span class="s1">createObjectURL</span><span class="s2">(</span>
                <span class="s1">img</span>
            <span class="s2">);</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">updated_canvas_event</span><span class="s2">();</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">waiting </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>
            <span class="s3">return</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else if </span><span class="s2">(</span>
            <span class="s3">typeof </span><span class="s1">evt</span><span class="s2">.</span><span class="s1">data </span><span class="s2">=== </span><span class="s4">'string' </span><span class="s2">&amp;&amp;</span>
            <span class="s1">evt</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">21</span><span class="s2">) === </span><span class="s4">'data:image/png;base64'</span>
        <span class="s2">) {</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">imageObj</span><span class="s2">.</span><span class="s1">src </span><span class="s2">= </span><span class="s1">evt</span><span class="s2">.</span><span class="s1">data</span><span class="s2">;</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">updated_canvas_event</span><span class="s2">();</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">waiting </span><span class="s2">= </span><span class="s3">false</span><span class="s2">;</span>
            <span class="s3">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s3">var </span><span class="s1">msg </span><span class="s2">= </span><span class="s1">JSON</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">evt</span><span class="s2">.</span><span class="s1">data</span><span class="s2">);</span>
        <span class="s3">var </span><span class="s1">msg_type </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s4">'type'</span><span class="s2">];</span>

        <span class="s0">// Call the  &quot;handle_{type}&quot; callback, which takes</span>
        <span class="s0">// the figure and JSON message as its only arguments.</span>
        <span class="s3">try </span><span class="s2">{</span>
            <span class="s3">var </span><span class="s1">callback </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">[</span><span class="s4">'handle_' </span><span class="s2">+ </span><span class="s1">msg_type</span><span class="s2">];</span>
        <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
            <span class="s1">console</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span>
                <span class="s4">&quot;No handler for the '&quot; </span><span class="s2">+ </span><span class="s1">msg_type </span><span class="s2">+ </span><span class="s4">&quot;' message type: &quot;</span><span class="s2">,</span>
                <span class="s1">msg</span>
            <span class="s2">);</span>
            <span class="s3">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s3">if </span><span class="s2">(</span><span class="s1">callback</span><span class="s2">) {</span>
            <span class="s3">try </span><span class="s2">{</span>
                <span class="s0">// console.log(&quot;Handling '&quot; + msg_type + &quot;' message: &quot;, msg);</span>
                <span class="s1">callback</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">);</span>
            <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
                <span class="s1">console</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span>
                    <span class="s4">&quot;Exception inside the 'handler_&quot; </span><span class="s2">+ </span><span class="s1">msg_type </span><span class="s2">+ </span><span class="s4">&quot;' callback:&quot;</span><span class="s2">,</span>
                    <span class="s1">e</span><span class="s2">,</span>
                    <span class="s1">e</span><span class="s2">.</span><span class="s1">stack</span><span class="s2">,</span>
                    <span class="s1">msg</span>
                <span class="s2">);</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
    <span class="s2">};</span>
<span class="s2">};</span>

<span class="s3">function </span><span class="s1">getModifiers</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) {</span>
    <span class="s3">var </span><span class="s1">mods </span><span class="s2">= [];</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">ctrlKey</span><span class="s2">) {</span>
        <span class="s1">mods</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s4">'ctrl'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">altKey</span><span class="s2">) {</span>
        <span class="s1">mods</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s4">'alt'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">shiftKey</span><span class="s2">) {</span>
        <span class="s1">mods</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s4">'shift'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">metaKey</span><span class="s2">) {</span>
        <span class="s1">mods</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s4">'meta'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s3">return </span><span class="s1">mods</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">/* 
 * return a copy of an object with only non-object keys 
 * we need this to avoid circular references 
 * https://stackoverflow.com/a/24161582/3208463 
 */</span>
<span class="s3">function </span><span class="s1">simpleKeys</span><span class="s2">(</span><span class="s1">original</span><span class="s2">) {</span>
    <span class="s3">return </span><span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s1">original</span><span class="s2">).</span><span class="s1">reduce</span><span class="s2">(</span><span class="s3">function </span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s3">typeof </span><span class="s1">original</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] !== </span><span class="s4">'object'</span><span class="s2">) {</span>
            <span class="s1">obj</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
        <span class="s2">}</span>
        <span class="s3">return </span><span class="s1">obj</span><span class="s2">;</span>
    <span class="s2">}, {});</span>
<span class="s2">}</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">mouse_event </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">=== </span><span class="s4">'button_press'</span><span class="s2">) {</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">focus</span><span class="s2">();</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">canvas_div</span><span class="s2">.</span><span class="s1">focus</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s0">// from https://stackoverflow.com/q/1114465</span>
    <span class="s3">var </span><span class="s1">boundingRect </span><span class="s2">= </span><span class="s3">this</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">getBoundingClientRect</span><span class="s2">();</span>
    <span class="s3">var </span><span class="s1">x </span><span class="s2">= (</span><span class="s1">event</span><span class="s2">.</span><span class="s1">clientX </span><span class="s2">- </span><span class="s1">boundingRect</span><span class="s2">.</span><span class="s1">left</span><span class="s2">) * </span><span class="s3">this</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>
    <span class="s3">var </span><span class="s1">y </span><span class="s2">= (</span><span class="s1">event</span><span class="s2">.</span><span class="s1">clientY </span><span class="s2">- </span><span class="s1">boundingRect</span><span class="s2">.</span><span class="s1">top</span><span class="s2">) * </span><span class="s3">this</span><span class="s2">.</span><span class="s1">ratio</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, {</span>
        <span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">,</span>
        <span class="s1">y</span><span class="s2">: </span><span class="s1">y</span><span class="s2">,</span>
        <span class="s1">button</span><span class="s2">: </span><span class="s1">event</span><span class="s2">.</span><span class="s1">button</span><span class="s2">,</span>
        <span class="s1">step</span><span class="s2">: </span><span class="s1">event</span><span class="s2">.</span><span class="s1">step</span><span class="s2">,</span>
        <span class="s1">modifiers</span><span class="s2">: </span><span class="s1">getModifiers</span><span class="s2">(</span><span class="s1">event</span><span class="s2">),</span>
        <span class="s1">guiEvent</span><span class="s2">: </span><span class="s1">simpleKeys</span><span class="s2">(</span><span class="s1">event</span><span class="s2">),</span>
    <span class="s2">});</span>

    <span class="s3">return false</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_key_event_extra </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">_event</span><span class="s2">, </span><span class="s1">_name</span><span class="s2">) {</span>
    <span class="s0">// Handle any extra behaviour associated with a key event</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">key_event </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">// Prevent repeat events</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">=== </span><span class="s4">'key_press'</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">key </span><span class="s2">=== </span><span class="s3">this</span><span class="s2">.</span><span class="s1">_key</span><span class="s2">) {</span>
            <span class="s3">return</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s3">this</span><span class="s2">.</span><span class="s1">_key </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">=== </span><span class="s4">'key_release'</span><span class="s2">) {</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">_key </span><span class="s2">= </span><span class="s3">null</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s3">var </span><span class="s1">value </span><span class="s2">= </span><span class="s4">''</span><span class="s2">;</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">ctrlKey </span><span class="s2">&amp;&amp; </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key </span><span class="s2">!== </span><span class="s4">'Control'</span><span class="s2">) {</span>
        <span class="s1">value </span><span class="s2">+= </span><span class="s4">'ctrl+'</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s3">else if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">altKey </span><span class="s2">&amp;&amp; </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key </span><span class="s2">!== </span><span class="s4">'Alt'</span><span class="s2">) {</span>
        <span class="s1">value </span><span class="s2">+= </span><span class="s4">'alt+'</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s3">else if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">shiftKey </span><span class="s2">&amp;&amp; </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key </span><span class="s2">!== </span><span class="s4">'Shift'</span><span class="s2">) {</span>
        <span class="s1">value </span><span class="s2">+= </span><span class="s4">'shift+'</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">value </span><span class="s2">+= </span><span class="s4">'k' </span><span class="s2">+ </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key</span><span class="s2">;</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">_key_event_extra</span><span class="s2">(</span><span class="s1">event</span><span class="s2">, </span><span class="s1">name</span><span class="s2">);</span>

    <span class="s3">this</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, { </span><span class="s1">key</span><span class="s2">: </span><span class="s1">value</span><span class="s2">, </span><span class="s1">guiEvent</span><span class="s2">: </span><span class="s1">simpleKeys</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) });</span>
    <span class="s3">return false</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toolbar_button_onclick </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">=== </span><span class="s4">'download'</span><span class="s2">) {</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">handle_save</span><span class="s2">(</span><span class="s3">this</span><span class="s2">, </span><span class="s3">null</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
        <span class="s3">this</span><span class="s2">.</span><span class="s1">send_message</span><span class="s2">(</span><span class="s4">'toolbar_button'</span><span class="s2">, { </span><span class="s1">name</span><span class="s2">: </span><span class="s1">name </span><span class="s2">});</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">mpl</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toolbar_button_onmouseover </span><span class="s2">= </span><span class="s3">function </span><span class="s2">(</span><span class="s1">tooltip</span><span class="s2">) {</span>
    <span class="s3">this</span><span class="s2">.</span><span class="s1">message</span><span class="s2">.</span><span class="s1">textContent </span><span class="s2">= </span><span class="s1">tooltip</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s0">///////////////// REMAINING CONTENT GENERATED BY embed_js.py /////////////////</span>
<span class="s0">// prettier-ignore</span>
<span class="s3">var </span><span class="s1">_JSXTOOLS_RESIZE_OBSERVER</span><span class="s2">=</span><span class="s3">function</span><span class="s2">(</span><span class="s1">A</span><span class="s2">){</span><span class="s3">var </span><span class="s1">t</span><span class="s2">,</span><span class="s1">i</span><span class="s2">=</span><span class="s3">new </span><span class="s1">WeakMap</span><span class="s2">,</span><span class="s1">n</span><span class="s2">=</span><span class="s3">new </span><span class="s1">WeakMap</span><span class="s2">,</span><span class="s1">a</span><span class="s2">=</span><span class="s3">new </span><span class="s1">WeakMap</span><span class="s2">,</span><span class="s1">r</span><span class="s2">=</span><span class="s3">new </span><span class="s1">WeakMap</span><span class="s2">,</span><span class="s1">o</span><span class="s2">=</span><span class="s3">new </span><span class="s1">Set</span><span class="s2">;</span><span class="s3">function </span><span class="s1">s</span><span class="s2">(</span><span class="s1">e</span><span class="s2">){</span><span class="s3">if</span><span class="s2">(!(</span><span class="s3">this instanceof </span><span class="s1">s</span><span class="s2">))</span><span class="s3">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s4">&quot;Constructor requires 'new' operator&quot;</span><span class="s2">);</span><span class="s1">i</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s3">this</span><span class="s2">,</span><span class="s1">e</span><span class="s2">)}</span><span class="s3">function </span><span class="s1">h</span><span class="s2">(){</span><span class="s3">throw new </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s4">&quot;Function is not a constructor&quot;</span><span class="s2">)}</span><span class="s3">function </span><span class="s1">c</span><span class="s2">(</span><span class="s1">e</span><span class="s2">,</span><span class="s1">t</span><span class="s2">,</span><span class="s1">i</span><span class="s2">,</span><span class="s1">n</span><span class="s2">){</span><span class="s1">e</span><span class="s2">=</span><span class="s5">0 </span><span class="s3">in </span><span class="s1">arguments</span><span class="s2">?</span><span class="s1">Number</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]):</span><span class="s5">0</span><span class="s2">,</span><span class="s1">t</span><span class="s2">=</span><span class="s5">1 </span><span class="s3">in </span><span class="s1">arguments</span><span class="s2">?</span><span class="s1">Number</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]):</span><span class="s5">0</span><span class="s2">,</span><span class="s1">i</span><span class="s2">=</span><span class="s5">2 </span><span class="s3">in </span><span class="s1">arguments</span><span class="s2">?</span><span class="s1">Number</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]):</span><span class="s5">0</span><span class="s2">,</span><span class="s1">n</span><span class="s2">=</span><span class="s5">3 </span><span class="s3">in </span><span class="s1">arguments</span><span class="s2">?</span><span class="s1">Number</span><span class="s2">(</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">3</span><span class="s2">]):</span><span class="s5">0</span><span class="s2">,</span><span class="s3">this</span><span class="s2">.</span><span class="s1">right</span><span class="s2">=(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">x</span><span class="s2">=</span><span class="s3">this</span><span class="s2">.</span><span class="s1">left</span><span class="s2">=</span><span class="s1">e</span><span class="s2">)+(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">width</span><span class="s2">=</span><span class="s1">i</span><span class="s2">),</span><span class="s3">this</span><span class="s2">.</span><span class="s1">bottom</span><span class="s2">=(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">y</span><span class="s2">=</span><span class="s3">this</span><span class="s2">.</span><span class="s1">top</span><span class="s2">=</span><span class="s1">t</span><span class="s2">)+(</span><span class="s3">this</span><span class="s2">.</span><span class="s1">height</span><span class="s2">=</span><span class="s1">n</span><span class="s2">),</span><span class="s1">Object</span><span class="s2">.</span><span class="s1">freeze</span><span class="s2">(</span><span class="s3">this</span><span class="s2">)}</span><span class="s3">function </span><span class="s1">d</span><span class="s2">(){</span><span class="s1">t</span><span class="s2">=</span><span class="s1">requestAnimationFrame</span><span class="s2">(</span><span class="s1">d</span><span class="s2">);</span><span class="s3">var </span><span class="s1">s</span><span class="s2">=</span><span class="s3">new </span><span class="s1">WeakMap</span><span class="s2">,</span><span class="s1">p</span><span class="s2">=</span><span class="s3">new </span><span class="s1">Set</span><span class="s2">;</span><span class="s1">o</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s3">function</span><span class="s2">(</span><span class="s1">t</span><span class="s2">){</span><span class="s1">r</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">t</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">((</span><span class="s3">function</span><span class="s2">(</span><span class="s1">i</span><span class="s2">){</span><span class="s3">var </span><span class="s1">r</span><span class="s2">=</span><span class="s1">t </span><span class="s3">instanceof </span><span class="s1">window</span><span class="s2">.</span><span class="s1">SVGElement</span><span class="s2">,</span><span class="s1">o</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">t</span><span class="s2">),</span><span class="s1">d</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">paddingTop</span><span class="s2">),</span><span class="s1">f</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">paddingRight</span><span class="s2">),</span><span class="s1">l</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">paddingBottom</span><span class="s2">),</span><span class="s1">u</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">paddingLeft</span><span class="s2">),</span><span class="s1">g</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">borderTopWidth</span><span class="s2">),</span><span class="s1">m</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">borderRightWidth</span><span class="s2">),</span><span class="s1">w</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">borderBottomWidth</span><span class="s2">),</span><span class="s1">b</span><span class="s2">=</span><span class="s1">u</span><span class="s2">+</span><span class="s1">f</span><span class="s2">,</span><span class="s1">F</span><span class="s2">=</span><span class="s1">d</span><span class="s2">+</span><span class="s1">l</span><span class="s2">,</span><span class="s1">v</span><span class="s2">=(</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">borderLeftWidth</span><span class="s2">))+</span><span class="s1">m</span><span class="s2">,</span><span class="s1">W</span><span class="s2">=</span><span class="s1">g</span><span class="s2">+</span><span class="s1">w</span><span class="s2">,</span><span class="s1">y</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">t</span><span class="s2">.</span><span class="s1">offsetHeight</span><span class="s2">-</span><span class="s1">W</span><span class="s2">-</span><span class="s1">t</span><span class="s2">.</span><span class="s1">clientHeight</span><span class="s2">,</span><span class="s1">E</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s5">0</span><span class="s2">:</span><span class="s1">t</span><span class="s2">.</span><span class="s1">offsetWidth</span><span class="s2">-</span><span class="s1">v</span><span class="s2">-</span><span class="s1">t</span><span class="s2">.</span><span class="s1">clientWidth</span><span class="s2">,</span><span class="s1">R</span><span class="s2">=</span><span class="s1">b</span><span class="s2">+</span><span class="s1">v</span><span class="s2">,</span><span class="s1">z</span><span class="s2">=</span><span class="s1">F</span><span class="s2">+</span><span class="s1">W</span><span class="s2">,</span><span class="s1">M</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s1">t</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)-</span><span class="s1">R</span><span class="s2">-</span><span class="s1">E</span><span class="s2">,</span><span class="s1">O</span><span class="s2">=</span><span class="s1">r</span><span class="s2">?</span><span class="s1">t</span><span class="s2">.</span><span class="s1">height</span><span class="s2">:</span><span class="s1">parseFloat</span><span class="s2">(</span><span class="s1">o</span><span class="s2">.</span><span class="s1">height</span><span class="s2">)-</span><span class="s1">z</span><span class="s2">-</span><span class="s1">y</span><span class="s2">;</span><span class="s3">if</span><span class="s2">(</span><span class="s1">n</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)){</span><span class="s3">var </span><span class="s1">k</span><span class="s2">=</span><span class="s1">n</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">t</span><span class="s2">);</span><span class="s3">if</span><span class="s2">(</span><span class="s1">k</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]===</span><span class="s1">M</span><span class="s2">&amp;&amp;</span><span class="s1">k</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]===</span><span class="s1">O</span><span class="s2">)</span><span class="s3">return</span><span class="s2">}</span><span class="s1">n</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">t</span><span class="s2">,[</span><span class="s1">M</span><span class="s2">,</span><span class="s1">O</span><span class="s2">]);</span><span class="s3">var </span><span class="s1">S</span><span class="s2">=</span><span class="s1">Object</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">h</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">);</span><span class="s1">S</span><span class="s2">.</span><span class="s1">target</span><span class="s2">=</span><span class="s1">t</span><span class="s2">,</span><span class="s1">S</span><span class="s2">.</span><span class="s1">contentRect</span><span class="s2">=</span><span class="s3">new </span><span class="s1">c</span><span class="s2">(</span><span class="s1">u</span><span class="s2">,</span><span class="s1">d</span><span class="s2">,</span><span class="s1">M</span><span class="s2">,</span><span class="s1">O</span><span class="s2">),</span><span class="s1">s</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)||(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">i</span><span class="s2">,[]),</span><span class="s1">p</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)),</span><span class="s1">s</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">i</span><span class="s2">).</span><span class="s1">push</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)}))})),</span><span class="s1">p</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">((</span><span class="s3">function</span><span class="s2">(</span><span class="s1">e</span><span class="s2">){</span><span class="s1">i</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">e</span><span class="s2">).</span><span class="s1">call</span><span class="s2">(</span><span class="s1">e</span><span class="s2">,</span><span class="s1">s</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">e</span><span class="s2">),</span><span class="s1">e</span><span class="s2">)}))}</span><span class="s3">return </span><span class="s1">s</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">observe</span><span class="s2">=</span><span class="s3">function</span><span class="s2">(</span><span class="s1">i</span><span class="s2">){</span><span class="s3">if</span><span class="s2">(</span><span class="s1">i </span><span class="s3">instanceof </span><span class="s1">window</span><span class="s2">.</span><span class="s1">Element</span><span class="s2">){</span><span class="s1">r</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)||(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">i</span><span class="s2">,</span><span class="s3">new </span><span class="s1">Set</span><span class="s2">),</span><span class="s1">o</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span><span class="s1">a</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">i</span><span class="s2">,</span><span class="s1">window</span><span class="s2">.</span><span class="s1">getComputedStyle</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)));</span><span class="s3">var </span><span class="s1">n</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">i</span><span class="s2">);</span><span class="s1">n</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s3">this</span><span class="s2">)||</span><span class="s1">n</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">this</span><span class="s2">),</span><span class="s1">cancelAnimationFrame</span><span class="s2">(</span><span class="s1">t</span><span class="s2">),</span><span class="s1">t</span><span class="s2">=</span><span class="s1">requestAnimationFrame</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)}},</span><span class="s1">s</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">unobserve</span><span class="s2">=</span><span class="s3">function</span><span class="s2">(</span><span class="s1">i</span><span class="s2">){</span><span class="s3">if</span><span class="s2">(</span><span class="s1">i </span><span class="s3">instanceof </span><span class="s1">window</span><span class="s2">.</span><span class="s1">Element</span><span class="s2">&amp;&amp;</span><span class="s1">r</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)){</span><span class="s3">var </span><span class="s1">n</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">i</span><span class="s2">);</span><span class="s1">n</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s3">this</span><span class="s2">)&amp;&amp;(</span><span class="s1">n</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s3">this</span><span class="s2">),</span><span class="s1">n</span><span class="s2">.</span><span class="s1">size</span><span class="s2">||(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span><span class="s1">o</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))),</span><span class="s1">n</span><span class="s2">.</span><span class="s1">size</span><span class="s2">||</span><span class="s1">r</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span><span class="s1">o</span><span class="s2">.</span><span class="s1">size</span><span class="s2">||</span><span class="s1">cancelAnimationFrame</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)}},</span><span class="s1">A</span><span class="s2">.</span><span class="s1">DOMRectReadOnly</span><span class="s2">=</span><span class="s1">c</span><span class="s2">,</span><span class="s1">A</span><span class="s2">.</span><span class="s1">ResizeObserver</span><span class="s2">=</span><span class="s1">s</span><span class="s2">,</span><span class="s1">A</span><span class="s2">.</span><span class="s1">ResizeObserverEntry</span><span class="s2">=</span><span class="s1">h</span><span class="s2">,</span><span class="s1">A</span><span class="s2">}; </span><span class="s0">// eslint-disable-line</span>
</pre>
</body>
</html>