<html>
<head>
<title>test_validation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_validation.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Test the validation module&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">from </span><span class="s1">time </span><span class="s2">import </span><span class="s1">sleep</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse </span><span class="s2">import </span><span class="s1">issparse</span>

<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">BaseEstimator</span><span class="s3">, </span><span class="s1">clone</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">cluster </span><span class="s2">import </span><span class="s1">KMeans</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">load_diabetes</span><span class="s3">,</span>
    <span class="s1">load_digits</span><span class="s3">,</span>
    <span class="s1">load_iris</span><span class="s3">,</span>
    <span class="s1">make_classification</span><span class="s3">,</span>
    <span class="s1">make_multilabel_classification</span><span class="s3">,</span>
    <span class="s1">make_regression</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">ensemble </span><span class="s2">import </span><span class="s1">RandomForestClassifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">FitFailedWarning</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">impute </span><span class="s2">import </span><span class="s1">SimpleImputer</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">LogisticRegression</span><span class="s3">,</span>
    <span class="s1">PassiveAggressiveClassifier</span><span class="s3">,</span>
    <span class="s1">Ridge</span><span class="s3">,</span>
    <span class="s1">RidgeClassifier</span><span class="s3">,</span>
    <span class="s1">SGDClassifier</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">accuracy_score</span><span class="s3">,</span>
    <span class="s1">check_scoring</span><span class="s3">,</span>
    <span class="s1">confusion_matrix</span><span class="s3">,</span>
    <span class="s1">explained_variance_score</span><span class="s3">,</span>
    <span class="s1">make_scorer</span><span class="s3">,</span>
    <span class="s1">mean_squared_error</span><span class="s3">,</span>
    <span class="s1">precision_recall_fscore_support</span><span class="s3">,</span>
    <span class="s1">precision_score</span><span class="s3">,</span>
    <span class="s1">r2_score</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">_scorer </span><span class="s2">import </span><span class="s1">_MultimetricScorer</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">GridSearchCV</span><span class="s3">,</span>
    <span class="s1">GroupKFold</span><span class="s3">,</span>
    <span class="s1">GroupShuffleSplit</span><span class="s3">,</span>
    <span class="s1">KFold</span><span class="s3">,</span>
    <span class="s1">LeaveOneGroupOut</span><span class="s3">,</span>
    <span class="s1">LeaveOneOut</span><span class="s3">,</span>
    <span class="s1">LeavePGroupsOut</span><span class="s3">,</span>
    <span class="s1">ShuffleSplit</span><span class="s3">,</span>
    <span class="s1">StratifiedKFold</span><span class="s3">,</span>
    <span class="s1">cross_val_predict</span><span class="s3">,</span>
    <span class="s1">cross_val_score</span><span class="s3">,</span>
    <span class="s1">cross_validate</span><span class="s3">,</span>
    <span class="s1">learning_curve</span><span class="s3">,</span>
    <span class="s1">permutation_test_score</span><span class="s3">,</span>
    <span class="s1">validation_curve</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection</span><span class="s3">.</span><span class="s1">_validation </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_check_is_permutation</span><span class="s3">,</span>
    <span class="s1">_fit_and_score</span><span class="s3">,</span>
    <span class="s1">_score</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">common </span><span class="s2">import </span><span class="s1">OneTimeSplitter</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">test_search </span><span class="s2">import </span><span class="s1">FailingClassifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">multiclass </span><span class="s2">import </span><span class="s1">OneVsRestClassifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">neighbors </span><span class="s2">import </span><span class="s1">KNeighborsClassifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">neural_network </span><span class="s2">import </span><span class="s1">MLPRegressor</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">pipeline </span><span class="s2">import </span><span class="s1">Pipeline</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing </span><span class="s2">import </span><span class="s1">LabelEncoder</span><span class="s3">, </span><span class="s1">scale</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm </span><span class="s2">import </span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">LinearSVC</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">metadata_routing_common </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ConsumingClassifier</span><span class="s3">,</span>
    <span class="s1">ConsumingScorer</span><span class="s3">,</span>
    <span class="s1">ConsumingSplitter</span><span class="s3">,</span>
    <span class="s1">_Registry</span><span class="s3">,</span>
    <span class="s1">check_recorded_metadata</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">shuffle</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_mocking </span><span class="s2">import </span><span class="s1">CheckingClassifier</span><span class="s3">, </span><span class="s1">MockDataFrame</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">COO_CONTAINERS</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">validation </span><span class="s2">import </span><span class="s1">_num_samples</span>


<span class="s2">class </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Dummy classifier to test the learning curve&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n_max_train_sizes</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">n_max_train_sizes </span><span class="s3">= </span><span class="s1">n_max_train_sizes</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X_subset</span><span class="s3">, </span><span class="s1">y_subset</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset </span><span class="s3">= </span><span class="s1">X_subset</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes </span><span class="s3">= </span><span class="s1">X_subset</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s5"># training score becomes worse (2 -&gt; 1), test error better (0 -&gt; 1)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_training_data</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">2.0 </span><span class="s3">- </span><span class="s1">float</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes</span><span class="s3">) / </span><span class="s1">self</span><span class="s3">.</span><span class="s1">n_max_train_sizes</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">float</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes</span><span class="s3">) / </span><span class="s1">self</span><span class="s3">.</span><span class="s1">n_max_train_sizes</span>

    <span class="s2">def </span><span class="s1">_is_training_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X </span><span class="s2">is </span><span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset</span>


<span class="s2">class </span><span class="s1">MockIncrementalImprovingEstimator</span><span class="s3">(</span><span class="s1">MockImprovingEstimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Dummy classifier that provides partial_fit&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n_max_train_sizes</span><span class="s3">, </span><span class="s1">expected_fit_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">n_max_train_sizes</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">expected_fit_params </span><span class="s3">= </span><span class="s1">expected_fit_params</span>

    <span class="s2">def </span><span class="s1">_is_training_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s2">in </span><span class="s1">X</span>

    <span class="s2">def </span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes </span><span class="s3">+= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">expected_fit_params</span><span class="s3">:</span>
            <span class="s1">missing </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">expected_fit_params</span><span class="s3">) - </span><span class="s1">set</span><span class="s3">(</span><span class="s1">params</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">missing</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">AssertionError</span><span class="s3">(</span>
                    <span class="s6">f&quot;Expected fit parameter(s) </span><span class="s2">{</span><span class="s1">list</span><span class="s3">(</span><span class="s1">missing</span><span class="s3">)</span><span class="s2">} </span><span class="s6">not seen.&quot;</span>
                <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">params</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">expected_fit_params </span><span class="s2">and </span><span class="s1">_num_samples</span><span class="s3">(</span>
                    <span class="s1">value</span>
                <span class="s3">) != </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
                    <span class="s2">raise </span><span class="s1">AssertionError</span><span class="s3">(</span>
                        <span class="s6">f&quot;Fit parameter </span><span class="s2">{</span><span class="s1">key</span><span class="s2">} </span><span class="s6">has length </span><span class="s2">{</span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span><span class="s2">}</span><span class="s6">&quot;</span>
                        <span class="s6">f&quot;; expected </span><span class="s2">{</span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span><span class="s2">}</span><span class="s6">.&quot;</span>
                    <span class="s3">)</span>


<span class="s2">class </span><span class="s1">MockEstimatorWithParameter</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Dummy classifier to test the validation curve&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">param</span><span class="s3">=</span><span class="s4">0.5</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">param </span><span class="s3">= </span><span class="s1">param</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X_subset</span><span class="s3">, </span><span class="s1">y_subset</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset </span><span class="s3">= </span><span class="s1">X_subset</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">train_sizes </span><span class="s3">= </span><span class="s1">X_subset</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">param </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_training_data</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">else </span><span class="s4">1 </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">param</span>

    <span class="s2">def </span><span class="s1">_is_training_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X </span><span class="s2">is </span><span class="s1">self</span><span class="s3">.</span><span class="s1">X_subset</span>


<span class="s2">class </span><span class="s1">MockEstimatorWithSingleFitCallAllowed</span><span class="s3">(</span><span class="s1">MockEstimatorWithParameter</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Dummy classifier that disallows repeated calls of fit method&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X_subset</span><span class="s3">, </span><span class="s1">y_subset</span><span class="s3">):</span>
        <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s6">&quot;fit_called_&quot;</span><span class="s3">), </span><span class="s6">&quot;fit is called the second time&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fit_called_ </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_subset</span><span class="s3">, </span><span class="s1">y_subset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>


<span class="s2">class </span><span class="s1">MockClassifier</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Dummy classifier to test the cross-validation&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s1">a</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">allow_nd </span><span class="s3">= </span><span class="s1">allow_nd</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">Y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">class_prior</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">sparse_sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">sparse_param</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">dummy_int</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">dummy_str</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">dummy_obj</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">callback</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The dummy arguments are to test that this fit function can 
        accept non-array arguments through cross-validation, such as: 
            - int 
            - str (this is actually array-like) 
            - object 
            - function 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dummy_int </span><span class="s3">= </span><span class="s1">dummy_int</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dummy_str </span><span class="s3">= </span><span class="s1">dummy_str</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dummy_obj </span><span class="s3">= </span><span class="s1">dummy_obj</span>
        <span class="s2">if </span><span class="s1">callback </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_nd</span><span class="s3">:</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), -</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">X</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">&gt;= </span><span class="s4">3 </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_nd</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s6">&quot;X cannot be d&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sample_weight </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], (</span>
                <span class="s6">&quot;MockClassifier extra fit_param &quot;</span>
                <span class="s6">&quot;sample_weight.shape[0] is {0}, should be {1}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                    <span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">class_prior </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">class_prior</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)), (</span>
                <span class="s6">&quot;MockClassifier extra fit_param class_prior.shape[0]&quot;</span>
                <span class="s6">&quot; is {0}, should be {1}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">class_prior</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)))</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sparse_sample_weight </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">fmt </span><span class="s3">= (</span>
                <span class="s6">&quot;MockClassifier extra fit_param sparse_sample_weight&quot;</span>
                <span class="s6">&quot;.shape[0] is {0}, should be {1}&quot;</span>
            <span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">sparse_sample_weight</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">fmt</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">sparse_sample_weight</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sparse_param </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">fmt </span><span class="s3">= (</span>
                <span class="s6">&quot;MockClassifier extra fit_param sparse_param.shape &quot;</span>
                <span class="s6">&quot;is ({0}, {1}), should be ({2}, {3})&quot;</span>
            <span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">sparse_param</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">P</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">fmt</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">sparse_param</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">],</span>
                <span class="s1">sparse_param</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">],</span>
                <span class="s1">P</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">],</span>
                <span class="s1">P</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">],</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">T</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_nd</span><span class="s3">:</span>
            <span class="s1">T </span><span class="s3">= </span><span class="s1">T</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), -</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">T</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">T</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">T</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">1.0 </span><span class="s3">/ (</span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">a</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s6">&quot;a&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s6">&quot;allow_nd&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_nd</span><span class="s3">}</span>


<span class="s5"># XXX: use 2D array, since 1D X is being detected as a single sample in</span>
<span class="s5"># check_consistent_length</span>
<span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">10</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>
<span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">])</span>
<span class="s5"># The number of samples per class needs to be &gt; n_splits,</span>
<span class="s5"># for StratifiedKFold(n_splits=3)</span>
<span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>
<span class="s1">P </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s4">5</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_score</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(-</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s1">a</span>
        <span class="s5"># Smoke test</span>
        <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">))</span>

        <span class="s5"># test with multioutput y</span>
        <span class="s1">multioutput_y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">column_stack</span><span class="s3">([</span><span class="s1">y2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">[::-</span><span class="s4">1</span><span class="s3">]])</span>
        <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">))</span>

        <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">))</span>

        <span class="s5"># test with multioutput y</span>
        <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">))</span>

    <span class="s5"># test with X and y as list</span>
    <span class="s1">list_check </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">list_check</span><span class="s3">)</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_y</span><span class="s3">=</span><span class="s1">list_check</span><span class="s3">)</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>

    <span class="s5"># test with 3d X and</span>
    <span class="s1">X_3d </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[:, :, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">(</span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_3d</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">(</span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_3d</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_validate_many_jobs</span><span class="s3">():</span>
    <span class="s5"># regression test for #12154: cv='warn' with n_jobs&gt;1 trigger a copy of</span>
    <span class="s5"># the parameters leading to a failure in check_cv due to cv is 'warn'</span>
    <span class="s5"># instead of cv == 'warn'.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">gamma</span><span class="s3">=</span><span class="s6">&quot;auto&quot;</span><span class="s3">)</span>
    <span class="s1">grid </span><span class="s3">= </span><span class="s1">GridSearchCV</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">param_grid</span><span class="s3">={</span><span class="s6">&quot;C&quot;</span><span class="s3">: [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">]})</span>
    <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">grid</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_validate_invalid_scoring_param</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>

    <span class="s5"># Test the errors</span>
    <span class="s1">error_message_regexp </span><span class="s3">= </span><span class="s6">&quot;.*must be unique strings.*&quot;</span>

    <span class="s5"># List/tuple of callables should raise a message advising users to use</span>
    <span class="s5"># dict of names to callables mapping</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">scoring</span><span class="s3">=(</span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">), </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">accuracy_score</span><span class="s3">)),</span>
        <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=(</span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">),))</span>

    <span class="s5"># So should empty lists/tuples</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp </span><span class="s3">+ </span><span class="s6">&quot;Empty list.*&quot;</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=())</span>

    <span class="s5"># So should duplicated entries</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp </span><span class="s3">+ </span><span class="s6">&quot;Duplicate.*&quot;</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=(</span><span class="s6">&quot;f1_micro&quot;</span><span class="s3">, </span><span class="s6">&quot;f1_micro&quot;</span><span class="s3">))</span>

    <span class="s5"># Nested Lists should raise a generic error message</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=[[</span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">)]])</span>

    <span class="s5"># Empty dict should raise invalid scoring error</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;An empty dict&quot;</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=(</span><span class="s1">dict</span><span class="s3">()))</span>

    <span class="s1">multiclass_scorer </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_recall_fscore_support</span><span class="s3">)</span>

    <span class="s5"># Multiclass Scorers that return multiple values are not supported yet</span>
    <span class="s5"># the warning message we're expecting to see</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s6">&quot;Scoring failed. The score on this train-test &quot;</span>
        <span class="s6">f&quot;partition for these parameters will be set to </span><span class="s2">{</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s2">}</span><span class="s6">. &quot;</span>
        <span class="s6">&quot;Details: </span><span class="s2">\n</span><span class="s6">&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">multiclass_scorer</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">={</span><span class="s6">&quot;foo&quot;</span><span class="s3">: </span><span class="s1">multiclass_scorer</span><span class="s3">})</span>


<span class="s2">def </span><span class="s1">test_cross_validate_nested_estimator</span><span class="s3">():</span>
    <span class="s5"># Non-regression test to ensure that nested</span>
    <span class="s5"># estimators are properly returned in a list</span>
    <span class="s5"># https://github.com/scikit-learn/scikit-learn/pull/17745</span>
    <span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) = </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s6">&quot;imputer&quot;</span><span class="s3">, </span><span class="s1">SimpleImputer</span><span class="s3">()),</span>
            <span class="s3">(</span><span class="s6">&quot;classifier&quot;</span><span class="s3">, </span><span class="s1">MockClassifier</span><span class="s3">()),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">return_estimator</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">estimators </span><span class="s3">= </span><span class="s1">results</span><span class="s3">[</span><span class="s6">&quot;estimator&quot;</span><span class="s3">]</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimators</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">) </span><span class="s2">for </span><span class="s1">estimator </span><span class="s2">in </span><span class="s1">estimators</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;use_sparse&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_validate</span><span class="s3">(</span><span class="s1">use_sparse</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s5"># Compute train and test mse/r2 scores</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">()</span>

    <span class="s5"># Regression</span>
    <span class="s1">X_reg</span><span class="s3">, </span><span class="s1">y_reg </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">Ridge</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s5"># Classification</span>
    <span class="s1">X_clf</span><span class="s3">, </span><span class="s1">y_clf </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">use_sparse</span><span class="s3">:</span>
        <span class="s1">X_reg </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_reg</span><span class="s3">)</span>
        <span class="s1">X_clf </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_clf</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">est </span><span class="s2">in </span><span class="s3">((</span><span class="s1">X_reg</span><span class="s3">, </span><span class="s1">y_reg</span><span class="s3">, </span><span class="s1">reg</span><span class="s3">), (</span><span class="s1">X_clf</span><span class="s3">, </span><span class="s1">y_clf</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)):</span>
        <span class="s5"># It's okay to evaluate regression metrics on classification too</span>
        <span class="s1">mse_scorer </span><span class="s3">= </span><span class="s1">check_scoring</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">)</span>
        <span class="s1">r2_scorer </span><span class="s3">= </span><span class="s1">check_scoring</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;r2&quot;</span><span class="s3">)</span>
        <span class="s1">train_mse_scores </span><span class="s3">= []</span>
        <span class="s1">test_mse_scores </span><span class="s3">= []</span>
        <span class="s1">train_r2_scores </span><span class="s3">= []</span>
        <span class="s1">test_r2_scores </span><span class="s3">= []</span>
        <span class="s1">fitted_estimators </span><span class="s3">= []</span>

        <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s1">est </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">est</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
            <span class="s1">train_mse_scores</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">mse_scorer</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">]))</span>
            <span class="s1">train_r2_scores</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">r2_scorer</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">]))</span>
            <span class="s1">test_mse_scores</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">mse_scorer</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">test</span><span class="s3">]))</span>
            <span class="s1">test_r2_scores</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">r2_scorer</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">test</span><span class="s3">]))</span>
            <span class="s1">fitted_estimators</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">est</span><span class="s3">)</span>

        <span class="s1">train_mse_scores </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">train_mse_scores</span><span class="s3">)</span>
        <span class="s1">test_mse_scores </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">test_mse_scores</span><span class="s3">)</span>
        <span class="s1">train_r2_scores </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">train_r2_scores</span><span class="s3">)</span>
        <span class="s1">test_r2_scores </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">test_r2_scores</span><span class="s3">)</span>
        <span class="s1">fitted_estimators </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">fitted_estimators</span><span class="s3">)</span>

        <span class="s1">scores </span><span class="s3">= (</span>
            <span class="s1">train_mse_scores</span><span class="s3">,</span>
            <span class="s1">test_mse_scores</span><span class="s3">,</span>
            <span class="s1">train_r2_scores</span><span class="s3">,</span>
            <span class="s1">test_r2_scores</span><span class="s3">,</span>
            <span class="s1">fitted_estimators</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5"># To ensure that the test does not suffer from</span>
        <span class="s5"># large statistical fluctuations due to slicing small datasets,</span>
        <span class="s5"># we pass the cross-validation instance</span>
        <span class="s1">check_cross_validate_single_metric</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">)</span>
        <span class="s1">check_cross_validate_multi_metric</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_validate_single_metric</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">):</span>
    <span class="s3">(</span>
        <span class="s1">train_mse_scores</span><span class="s3">,</span>
        <span class="s1">test_mse_scores</span><span class="s3">,</span>
        <span class="s1">train_r2_scores</span><span class="s3">,</span>
        <span class="s1">test_r2_scores</span><span class="s3">,</span>
        <span class="s1">fitted_estimators</span><span class="s3">,</span>
    <span class="s3">) = </span><span class="s1">scores</span>
    <span class="s5"># Test single metric evaluation when scoring is string or singleton list</span>
    <span class="s2">for </span><span class="s1">return_train_score</span><span class="s3">, </span><span class="s1">dict_len </span><span class="s2">in </span><span class="s3">((</span><span class="s2">True</span><span class="s3">, </span><span class="s4">4</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)):</span>
        <span class="s5"># Single metric passed as a string</span>
        <span class="s2">if </span><span class="s1">return_train_score</span><span class="s3">:</span>
            <span class="s1">mse_scores_dict </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">,</span>
                <span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">mse_scores_dict</span><span class="s3">[</span><span class="s6">&quot;train_score&quot;</span><span class="s3">], </span><span class="s1">train_mse_scores</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">mse_scores_dict </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">,</span>
                <span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">mse_scores_dict</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">mse_scores_dict</span><span class="s3">) == </span><span class="s1">dict_len</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">mse_scores_dict</span><span class="s3">[</span><span class="s6">&quot;test_score&quot;</span><span class="s3">], </span><span class="s1">test_mse_scores</span><span class="s3">)</span>

        <span class="s5"># Single metric passed as a list</span>
        <span class="s2">if </span><span class="s1">return_train_score</span><span class="s3">:</span>
            <span class="s5"># It must be True by default - deprecated</span>
            <span class="s1">r2_scores_dict </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=[</span><span class="s6">&quot;r2&quot;</span><span class="s3">], </span><span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span>
            <span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">r2_scores_dict</span><span class="s3">[</span><span class="s6">&quot;train_r2&quot;</span><span class="s3">], </span><span class="s1">train_r2_scores</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">r2_scores_dict </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=[</span><span class="s6">&quot;r2&quot;</span><span class="s3">], </span><span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span>
            <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">r2_scores_dict</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">r2_scores_dict</span><span class="s3">) == </span><span class="s1">dict_len</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">r2_scores_dict</span><span class="s3">[</span><span class="s6">&quot;test_r2&quot;</span><span class="s3">], </span><span class="s1">test_r2_scores</span><span class="s3">)</span>

    <span class="s5"># Test return_estimator option</span>
    <span class="s1">mse_scores_dict </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
        <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">, </span><span class="s1">return_estimator</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span>
    <span class="s3">)</span>
    <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">est </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">mse_scores_dict</span><span class="s3">[</span><span class="s6">&quot;estimator&quot;</span><span class="s3">]):</span>
        <span class="s1">est_coef </span><span class="s3">= </span><span class="s1">est</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">est_coef</span><span class="s3">):</span>
            <span class="s1">est_coef </span><span class="s3">= </span><span class="s1">est_coef</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

        <span class="s1">fitted_est_coef </span><span class="s3">= </span><span class="s1">fitted_estimators</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">fitted_est_coef</span><span class="s3">):</span>
            <span class="s1">fitted_est_coef </span><span class="s3">= </span><span class="s1">fitted_est_coef</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">est_coef</span><span class="s3">, </span><span class="s1">fitted_est_coef</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">fitted_estimators</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_validate_multi_metric</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">):</span>
    <span class="s5"># Test multimetric evaluation when scoring is a list / dict</span>
    <span class="s3">(</span>
        <span class="s1">train_mse_scores</span><span class="s3">,</span>
        <span class="s1">test_mse_scores</span><span class="s3">,</span>
        <span class="s1">train_r2_scores</span><span class="s3">,</span>
        <span class="s1">test_r2_scores</span><span class="s3">,</span>
        <span class="s1">fitted_estimators</span><span class="s3">,</span>
    <span class="s3">) = </span><span class="s1">scores</span>

    <span class="s2">def </span><span class="s1">custom_scorer</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s6">&quot;r2&quot;</span><span class="s3">: </span><span class="s1">r2_score</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">),</span>
            <span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">: -</span><span class="s1">mean_squared_error</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">),</span>
        <span class="s3">}</span>

    <span class="s1">all_scoring </span><span class="s3">= (</span>
        <span class="s3">(</span><span class="s6">&quot;r2&quot;</span><span class="s3">, </span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">),</span>
        <span class="s3">{</span>
            <span class="s6">&quot;r2&quot;</span><span class="s3">: </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">r2_score</span><span class="s3">),</span>
            <span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">: </span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s1">custom_scorer</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">keys_sans_train </span><span class="s3">= {</span>
        <span class="s6">&quot;test_r2&quot;</span><span class="s3">,</span>
        <span class="s6">&quot;test_neg_mean_squared_error&quot;</span><span class="s3">,</span>
        <span class="s6">&quot;fit_time&quot;</span><span class="s3">,</span>
        <span class="s6">&quot;score_time&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">keys_with_train </span><span class="s3">= </span><span class="s1">keys_sans_train</span><span class="s3">.</span><span class="s1">union</span><span class="s3">(</span>
        <span class="s3">{</span><span class="s6">&quot;train_r2&quot;</span><span class="s3">, </span><span class="s6">&quot;train_neg_mean_squared_error&quot;</span><span class="s3">}</span>
    <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">return_train_score </span><span class="s2">in </span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">scoring </span><span class="s2">in </span><span class="s1">all_scoring</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">return_train_score</span><span class="s3">:</span>
                <span class="s5"># return_train_score must be True by default - deprecated</span>
                <span class="s1">cv_results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                    <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">, </span><span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span>
                <span class="s3">)</span>
                <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;train_r2&quot;</span><span class="s3">], </span><span class="s1">train_r2_scores</span><span class="s3">)</span>
                <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                    <span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;train_neg_mean_squared_error&quot;</span><span class="s3">], </span><span class="s1">train_mse_scores</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">cv_results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                    <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">, </span><span class="s1">return_train_score</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span>
                <span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) == (</span>
                <span class="s1">keys_with_train </span><span class="s2">if </span><span class="s1">return_train_score </span><span class="s2">else </span><span class="s1">keys_sans_train</span>
            <span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;test_r2&quot;</span><span class="s3">], </span><span class="s1">test_r2_scores</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;test_neg_mean_squared_error&quot;</span><span class="s3">], </span><span class="s1">test_mse_scores</span>
            <span class="s3">)</span>

            <span class="s5"># Make sure all the arrays are of np.ndarray type</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;test_r2&quot;</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;test_neg_mean_squared_error&quot;</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;fit_time&quot;</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;score_time&quot;</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>

            <span class="s5"># Ensure all the times are within sane limits</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;fit_time&quot;</span><span class="s3">] &gt;= </span><span class="s4">0</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;fit_time&quot;</span><span class="s3">] &lt; </span><span class="s4">10</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;score_time&quot;</span><span class="s3">] &gt;= </span><span class="s4">0</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;score_time&quot;</span><span class="s3">] &lt; </span><span class="s4">10</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_predict_groups</span><span class="s3">():</span>
    <span class="s5"># Check if ValueError (when groups is None) propagates to cross_val_score</span>
    <span class="s5"># and cross_val_predict</span>
    <span class="s5"># And also check if groups is correctly passed to the cv object</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s1">group_cvs </span><span class="s3">= [</span>
        <span class="s1">LeaveOneGroupOut</span><span class="s3">(),</span>
        <span class="s1">LeavePGroupsOut</span><span class="s3">(</span><span class="s4">2</span><span class="s3">),</span>
        <span class="s1">GroupKFold</span><span class="s3">(),</span>
        <span class="s1">GroupShuffleSplit</span><span class="s3">(),</span>
    <span class="s3">]</span>
    <span class="s1">error_message </span><span class="s3">= </span><span class="s6">&quot;The 'groups' parameter should not be None.&quot;</span>
    <span class="s2">for </span><span class="s1">cv </span><span class="s2">in </span><span class="s1">group_cvs</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message</span><span class="s3">):</span>
            <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message</span><span class="s3">):</span>
            <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore: Using or importing the ABCs from&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_score_pandas</span><span class="s3">():</span>
    <span class="s5"># check cross_val_score doesn't destroy pandas dataframe</span>
    <span class="s1">types </span><span class="s3">= [(</span><span class="s1">MockDataFrame</span><span class="s3">, </span><span class="s1">MockDataFrame</span><span class="s3">)]</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">DataFrame</span><span class="s3">, </span><span class="s1">Series</span>

        <span class="s1">types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">Series</span><span class="s3">, </span><span class="s1">DataFrame</span><span class="s3">))</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s2">pass</span>
    <span class="s2">for </span><span class="s1">TargetType</span><span class="s3">, </span><span class="s1">InputFeatureType </span><span class="s2">in </span><span class="s1">types</span><span class="s3">:</span>
        <span class="s5"># X dataframe, y series</span>
        <span class="s5"># 3 fold cross val is used so we need at least 3 samples per class</span>
        <span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser </span><span class="s3">= </span><span class="s1">InputFeatureType</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">TargetType</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
        <span class="s1">check_df </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">InputFeatureType</span><span class="s3">)</span>
        <span class="s1">check_series </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">TargetType</span><span class="s3">)</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">check_df</span><span class="s3">, </span><span class="s1">check_y</span><span class="s3">=</span><span class="s1">check_series</span><span class="s3">)</span>
        <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_mask</span><span class="s3">():</span>
    <span class="s5"># test that cross_val_score works with boolean masks</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">kfold </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">scores_indices </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">kfold</span><span class="s3">)</span>
    <span class="s1">kfold </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">cv_masks </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">kfold</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">mask_train </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>
        <span class="s1">mask_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>
        <span class="s1">mask_train</span><span class="s3">[</span><span class="s1">train</span><span class="s3">] = </span><span class="s4">1</span>
        <span class="s1">mask_test</span><span class="s3">[</span><span class="s1">test</span><span class="s3">] = </span><span class="s4">1</span>
        <span class="s1">cv_masks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">train</span><span class="s3">, </span><span class="s1">test</span><span class="s3">))</span>
    <span class="s1">scores_masks </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv_masks</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scores_indices</span><span class="s3">, </span><span class="s1">scores_masks</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_precomputed</span><span class="s3">():</span>
    <span class="s5"># test for svm with precomputed kernel</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">linear_kernel </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">score_precomputed </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">linear_kernel</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">score_linear </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">score_precomputed</span><span class="s3">, </span><span class="s1">score_linear</span><span class="s3">)</span>

    <span class="s5"># test with callable</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">T</span><span class="s3">))</span>
    <span class="s1">score_callable </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">score_precomputed</span><span class="s3">, </span><span class="s1">score_callable</span><span class="s3">)</span>

    <span class="s5"># Error raised for non-square X</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s5"># test error is raised when the precomputed kernel is not array-like</span>
    <span class="s5"># or sparse</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">svm</span><span class="s3">, </span><span class="s1">linear_kernel</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_score_fit_params</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">n_classes </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>

    <span class="s1">W_sparse </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">]), (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">]))), </span><span class="s1">shape</span><span class="s3">=(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">P_sparse </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s4">5</span><span class="s3">))</span>

    <span class="s1">DUMMY_INT </span><span class="s3">= </span><span class="s4">42</span>
    <span class="s1">DUMMY_STR </span><span class="s3">= </span><span class="s6">&quot;42&quot;</span>
    <span class="s1">DUMMY_OBJ </span><span class="s3">= </span><span class="s1">object</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">assert_fit_params</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">):</span>
        <span class="s5"># Function to test that the values are passed correctly to the</span>
        <span class="s5"># classifier arguments for non-array type</span>

        <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dummy_int </span><span class="s3">== </span><span class="s1">DUMMY_INT</span>
        <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dummy_str </span><span class="s3">== </span><span class="s1">DUMMY_STR</span>
        <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dummy_obj </span><span class="s3">== </span><span class="s1">DUMMY_OBJ</span>

    <span class="s1">fit_params </span><span class="s3">= {</span>
        <span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">),</span>
        <span class="s6">&quot;class_prior&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">, </span><span class="s4">1.0 </span><span class="s3">/ </span><span class="s1">n_classes</span><span class="s3">),</span>
        <span class="s6">&quot;sparse_sample_weight&quot;</span><span class="s3">: </span><span class="s1">W_sparse</span><span class="s3">,</span>
        <span class="s6">&quot;sparse_param&quot;</span><span class="s3">: </span><span class="s1">P_sparse</span><span class="s3">,</span>
        <span class="s6">&quot;dummy_int&quot;</span><span class="s3">: </span><span class="s1">DUMMY_INT</span><span class="s3">,</span>
        <span class="s6">&quot;dummy_str&quot;</span><span class="s3">: </span><span class="s1">DUMMY_STR</span><span class="s3">,</span>
        <span class="s6">&quot;dummy_obj&quot;</span><span class="s3">: </span><span class="s1">DUMMY_OBJ</span><span class="s3">,</span>
        <span class="s6">&quot;callback&quot;</span><span class="s3">: </span><span class="s1">assert_fit_params</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s1">fit_params</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_score_func</span><span class="s3">():</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">_score_func_args </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">score_func</span><span class="s3">(</span><span class="s1">y_test</span><span class="s3">, </span><span class="s1">y_predict</span><span class="s3">):</span>
        <span class="s1">_score_func_args</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">y_test</span><span class="s3">, </span><span class="s1">y_predict</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s4">1.0</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">scoring </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">score_func</span><span class="s3">)</span>
        <span class="s1">score </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">score</span><span class="s3">, [</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s5"># Test that score function is called only 3 times (for cv=3)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">_score_func_args</span><span class="s3">) == </span><span class="s4">3</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_with_score_func_classification</span><span class="s3">():</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s5"># Default score (should be the accuracy score)</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, [</span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s5"># Correct classification score (aka. zero / one score) - should be the</span>
    <span class="s5"># same as the default estimator score</span>
    <span class="s1">zo_scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">zo_scores</span><span class="s3">, [</span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s5"># F1 score (class are balanced so f1_score should be equal to zero/one</span>
    <span class="s5"># score</span>
    <span class="s1">f1_scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;f1_weighted&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">f1_scores</span><span class="s3">, [</span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_with_score_func_regression</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">n_informative</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">Ridge</span><span class="s3">()</span>

    <span class="s5"># Default score of the Ridge regression estimator</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, [</span><span class="s4">0.94</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.99</span><span class="s3">, </span><span class="s4">0.92</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s5"># R2 score (aka. determination coefficient) - should be the</span>
    <span class="s5"># same as the default estimator score</span>
    <span class="s1">r2_scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;r2&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">r2_scores</span><span class="s3">, [</span><span class="s4">0.94</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.99</span><span class="s3">, </span><span class="s4">0.92</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s5"># Mean squared error; this is a loss function, so &quot;scores&quot; are negative</span>
    <span class="s1">neg_mse_scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;neg_mean_squared_error&quot;</span><span class="s3">)</span>
    <span class="s1">expected_neg_mse </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s4">763.07</span><span class="s3">, -</span><span class="s4">553.16</span><span class="s3">, -</span><span class="s4">274.38</span><span class="s3">, -</span><span class="s4">273.26</span><span class="s3">, -</span><span class="s4">1681.99</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">neg_mse_scores</span><span class="s3">, </span><span class="s1">expected_neg_mse</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s5"># Explained variance</span>
    <span class="s1">scoring </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">explained_variance_score</span><span class="s3">)</span>
    <span class="s1">ev_scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">ev_scores</span><span class="s3">, [</span><span class="s4">0.94</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.97</span><span class="s3">, </span><span class="s4">0.99</span><span class="s3">, </span><span class="s4">0.92</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_permutation_score</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">StratifiedKFold</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">score</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">pvalue </span><span class="s3">= </span><span class="s1">permutation_test_score</span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n_permutations</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">score </span><span class="s3">&gt; </span><span class="s4">0.9</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s1">score_group</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">pvalue_group </span><span class="s3">= </span><span class="s1">permutation_test_score</span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">n_permutations</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
        <span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span><span class="s3">,</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">size</span><span class="s3">),</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">score_group </span><span class="s3">== </span><span class="s1">score</span>
    <span class="s2">assert </span><span class="s1">pvalue_group </span><span class="s3">== </span><span class="s1">pvalue</span>

    <span class="s5"># check that we obtain the same results with a sparse representation</span>
    <span class="s1">svm_sparse </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">cv_sparse </span><span class="s3">= </span><span class="s1">StratifiedKFold</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">score_group</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">pvalue_group </span><span class="s3">= </span><span class="s1">permutation_test_score</span><span class="s3">(</span>
        <span class="s1">svm_sparse</span><span class="s3">,</span>
        <span class="s1">X_sparse</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">n_permutations</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv_sparse</span><span class="s3">,</span>
        <span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span><span class="s3">,</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">size</span><span class="s3">),</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">score_group </span><span class="s3">== </span><span class="s1">score</span>
    <span class="s2">assert </span><span class="s1">pvalue_group </span><span class="s3">== </span><span class="s1">pvalue</span>

    <span class="s5"># test with custom scoring object</span>
    <span class="s2">def </span><span class="s1">custom_score</span><span class="s3">(</span><span class="s1">y_true</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">((</span><span class="s1">y_true </span><span class="s3">== </span><span class="s1">y_pred</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">() - (</span><span class="s1">y_true </span><span class="s3">!= </span><span class="s1">y_pred</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()) / </span><span class="s1">y_true</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s1">scorer </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">custom_score</span><span class="s3">)</span>
    <span class="s1">score</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">pvalue </span><span class="s3">= </span><span class="s1">permutation_test_score</span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n_permutations</span><span class="s3">=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scorer</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score</span><span class="s3">, </span><span class="s4">0.93</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">pvalue</span><span class="s3">, </span><span class="s4">0.01</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>

    <span class="s5"># set random y</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mod</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)), </span><span class="s4">3</span><span class="s3">)</span>

    <span class="s1">score</span><span class="s3">, </span><span class="s1">scores</span><span class="s3">, </span><span class="s1">pvalue </span><span class="s3">= </span><span class="s1">permutation_test_score</span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n_permutations</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span>
    <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">score </span><span class="s3">&lt; </span><span class="s4">0.5</span>
    <span class="s2">assert </span><span class="s1">pvalue </span><span class="s3">&gt; </span><span class="s4">0.2</span>


<span class="s2">def </span><span class="s1">test_permutation_test_score_allow_nans</span><span class="s3">():</span>
    <span class="s5"># Check that permutation_test_score allows input data with NaNs</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">200</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s4">2</span><span class="s3">, :] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] / </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s6">&quot;imputer&quot;</span><span class="s3">, </span><span class="s1">SimpleImputer</span><span class="s3">(</span><span class="s1">strategy</span><span class="s3">=</span><span class="s6">&quot;mean&quot;</span><span class="s3">, </span><span class="s1">missing_values</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s6">&quot;classifier&quot;</span><span class="s3">, </span><span class="s1">MockClassifier</span><span class="s3">()),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">permutation_test_score</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_permutation_test_score_fit_params</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">100</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">5 </span><span class="s3">+ [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">expected_sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;Expected sample_weight to be passed&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AssertionError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">permutation_test_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;sample_weight.shape == \(1,\), expected \(8,\)!&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">permutation_test_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)})</span>
    <span class="s1">permutation_test_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)})</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_allow_nans</span><span class="s3">():</span>
    <span class="s5"># Check that cross_val_score allows input data with NaNs</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">200</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s4">2</span><span class="s3">, :] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] / </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s6">&quot;imputer&quot;</span><span class="s3">, </span><span class="s1">SimpleImputer</span><span class="s3">(</span><span class="s1">strategy</span><span class="s3">=</span><span class="s6">&quot;mean&quot;</span><span class="s3">, </span><span class="s1">missing_values</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s6">&quot;classifier&quot;</span><span class="s3">, </span><span class="s1">MockClassifier</span><span class="s3">()),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_score_multilabel</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[-</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s4">2</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]]</span>
    <span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">KNeighborsClassifier</span><span class="s3">(</span><span class="s1">n_neighbors</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">scoring_micro </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">, </span><span class="s1">average</span><span class="s3">=</span><span class="s6">&quot;micro&quot;</span><span class="s3">)</span>
    <span class="s1">scoring_macro </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">, </span><span class="s1">average</span><span class="s3">=</span><span class="s6">&quot;macro&quot;</span><span class="s3">)</span>
    <span class="s1">scoring_samples </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">precision_score</span><span class="s3">, </span><span class="s1">average</span><span class="s3">=</span><span class="s6">&quot;samples&quot;</span><span class="s3">)</span>
    <span class="s1">score_micro </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring_micro</span><span class="s3">)</span>
    <span class="s1">score_macro </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring_macro</span><span class="s3">)</span>
    <span class="s1">score_samples </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring_samples</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score_micro</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">3</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score_macro</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score_samples</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_predict</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_diabetes</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">()</span>

    <span class="s1">est </span><span class="s3">= </span><span class="s1">Ridge</span><span class="s3">()</span>

    <span class="s5"># Naive loop (should be same as cross_val_predict):</span>
    <span class="s1">preds2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">preds2</span><span class="s3">[</span><span class="s1">test</span><span class="s3">] = </span><span class="s1">est</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">])</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">preds</span><span class="s3">, </span><span class="s1">preds2</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">preds</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">cv </span><span class="s3">= </span><span class="s1">LeaveOneOut</span><span class="s3">()</span>
    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">preds</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">Xsp </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">Xsp </span><span class="s3">*= </span><span class="s1">Xsp </span><span class="s3">&gt; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">Xsp</span><span class="s3">)</span>
    <span class="s1">Xsp </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">Xsp</span><span class="s3">)</span>
    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">Xsp</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">preds</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">KMeans</span><span class="s3">(</span><span class="s1">n_init</span><span class="s3">=</span><span class="s6">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">preds</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">class </span><span class="s1">BadCV</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">4</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s3">])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">BadCV</span><span class="s3">())</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s6">r&quot;Number of classes in training fold \(2\) does &quot;</span>
        <span class="s6">r&quot;not match total number of classes \(3\). &quot;</span>
        <span class="s6">&quot;Results may not be appropriate for your use case.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">cross_val_predict</span><span class="s3">(</span>
            <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">),</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s4">2</span><span class="s3">),</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_decision_function_shape</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">50</span><span class="s3">,)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">150</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>

    <span class="s5"># This specifically tests imbalanced splits for binary</span>
    <span class="s5"># classification with decision_function. This is only</span>
    <span class="s5"># applicable to classifiers that can be fit on a single</span>
    <span class="s5"># class.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[:</span><span class="s4">100</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">[:</span><span class="s4">100</span><span class="s3">]</span>
    <span class="s1">error_message </span><span class="s3">= (</span>
        <span class="s6">&quot;Only 1 class/es in training fold,&quot;</span>
        <span class="s6">&quot; but 2 in overall dataset. This&quot;</span>
        <span class="s6">&quot; is not supported for decision_function&quot;</span>
        <span class="s6">&quot; with imbalanced folds. To fix &quot;</span>
        <span class="s6">&quot;this, use a cross-validation technique &quot;</span>
        <span class="s6">&quot;resulting in properly stratified folds&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message</span><span class="s3">):</span>
        <span class="s1">cross_val_predict</span><span class="s3">(</span>
            <span class="s1">RidgeClassifier</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_digits</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovo&quot;</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">1797</span><span class="s3">, </span><span class="s4">45</span><span class="s3">)</span>

    <span class="s1">ind </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argsort</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[</span><span class="s1">ind</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">ind</span><span class="s3">]</span>
    <span class="s1">error_message_regexp </span><span class="s3">= (</span>
        <span class="s6">r&quot;Output shape \(599L?, 21L?\) of &quot;</span>
        <span class="s6">&quot;decision_function does not match number of &quot;</span>
        <span class="s6">r&quot;classes \(7\) in fold. Irregular &quot;</span>
        <span class="s6">&quot;decision_function .*&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message_regexp</span><span class="s3">):</span>
        <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">), </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_predict_proba_shape</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_proba&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">50</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_proba&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">150</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_predict_log_proba_shape</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">50</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_log_proba&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">50</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_log_proba&quot;</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">preds</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">150</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_predict_input_types</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">multioutput_y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">column_stack</span><span class="s3">([</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[::-</span><span class="s4">1</span><span class="s3">]])</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Ridge</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s5"># 3 fold cv is used --&gt; at least 3 samples per class</span>
    <span class="s5"># Smoke test</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">predictions</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">150</span><span class="s3">,)</span>

    <span class="s5"># test with multioutput y</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">predictions</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">150</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">predictions</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s4">150</span><span class="s3">,))</span>

    <span class="s5"># test with multioutput y</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">multioutput_y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">predictions</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s4">150</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>

    <span class="s5"># test with X and y as list</span>
    <span class="s1">list_check </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">list_check</span><span class="s3">)</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">y</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">())</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_y</span><span class="s3">=</span><span class="s1">list_check</span><span class="s3">)</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">())</span>

    <span class="s5"># test with X and y as list and non empty method</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">),</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(),</span>
        <span class="s1">y</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(),</span>
        <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">),</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(),</span>
        <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s5"># test with 3d X and</span>
    <span class="s1">X_3d </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[:, :, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
    <span class="s1">check_3d </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s4">3</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">check_3d</span><span class="s3">)</span>
    <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_3d</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">predictions</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s4">150</span><span class="s3">,))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore: Using or importing the ABCs from&quot;</span><span class="s3">)</span>
<span class="s5"># python3.7 deprecation warnings in pandas via matplotlib :-/</span>
<span class="s2">def </span><span class="s1">test_cross_val_predict_pandas</span><span class="s3">():</span>
    <span class="s5"># check cross_val_score doesn't destroy pandas dataframe</span>
    <span class="s1">types </span><span class="s3">= [(</span><span class="s1">MockDataFrame</span><span class="s3">, </span><span class="s1">MockDataFrame</span><span class="s3">)]</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">DataFrame</span><span class="s3">, </span><span class="s1">Series</span>

        <span class="s1">types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">Series</span><span class="s3">, </span><span class="s1">DataFrame</span><span class="s3">))</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s2">pass</span>
    <span class="s2">for </span><span class="s1">TargetType</span><span class="s3">, </span><span class="s1">InputFeatureType </span><span class="s2">in </span><span class="s1">types</span><span class="s3">:</span>
        <span class="s5"># X dataframe, y series</span>
        <span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser </span><span class="s3">= </span><span class="s1">InputFeatureType</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">TargetType</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
        <span class="s1">check_df </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">InputFeatureType</span><span class="s3">)</span>
        <span class="s1">check_series </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">TargetType</span><span class="s3">)</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">check_df</span><span class="s3">, </span><span class="s1">check_y</span><span class="s3">=</span><span class="s1">check_series</span><span class="s3">)</span>
        <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_unbalanced</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">100</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s5"># Change the first sample to a new class</span>
    <span class="s1">y</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] = </span><span class="s4">2</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">)</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">StratifiedKFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">yhat_proba </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">y</span><span class="s3">[</span><span class="s1">test</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]][</span><span class="s4">0</span><span class="s3">] == </span><span class="s4">2  </span><span class="s5"># sanity check for further assertions</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">yhat_proba</span><span class="s3">[</span><span class="s1">test</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]][:, </span><span class="s4">2</span><span class="s3">] == </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">yhat_proba</span><span class="s3">[</span><span class="s1">test</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]][:, </span><span class="s4">0</span><span class="s3">:</span><span class="s4">1</span><span class="s3">] &gt; </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">yhat_proba</span><span class="s3">[</span><span class="s1">test</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]] &gt; </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">yhat_proba</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">12</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_y_none</span><span class="s3">():</span>
    <span class="s5"># ensure that cross_val_predict works when y is None</span>
    <span class="s1">mock_classifier </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s4">100</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y_hat </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">mock_classifier</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">], </span><span class="s1">y_hat</span><span class="s3">)</span>
    <span class="s1">y_hat_proba </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span>
        <span class="s1">mock_classifier</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;predict_proba&quot;</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y_hat_proba</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_score_sparse_fit_params</span><span class="s3">(</span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">fit_params </span><span class="s3">= {</span><span class="s6">&quot;sparse_sample_weight&quot;</span><span class="s3">: </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]))}</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s1">fit_params</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">3</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_learning_curve</span><span class="s3">():</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">30</span>
    <span class="s1">n_splits </span><span class="s3">= </span><span class="s4">3</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s1">n_samples </span><span class="s3">* ((</span><span class="s1">n_splits </span><span class="s3">- </span><span class="s4">1</span><span class="s3">) / </span><span class="s1">n_splits</span><span class="s3">))</span>
    <span class="s2">for </span><span class="s1">shuffle_train </span><span class="s2">in </span><span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]:</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">w</span><span class="s3">:</span>
            <span class="s3">(</span>
                <span class="s1">train_sizes</span><span class="s3">,</span>
                <span class="s1">train_scores</span><span class="s3">,</span>
                <span class="s1">test_scores</span><span class="s3">,</span>
                <span class="s1">fit_times</span><span class="s3">,</span>
                <span class="s1">score_times</span><span class="s3">,</span>
            <span class="s3">) = </span><span class="s1">learning_curve</span><span class="s3">(</span>
                <span class="s1">estimator</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s1">n_splits</span><span class="s3">),</span>
                <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
                <span class="s1">shuffle</span><span class="s3">=</span><span class="s1">shuffle_train</span><span class="s3">,</span>
                <span class="s1">return_times</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">w</span><span class="s3">) &gt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s6">&quot;Unexpected warning: %r&quot; </span><span class="s3">% </span><span class="s1">w</span><span class="s3">[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">message</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">fit_times</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">score_times</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1.9</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>

        <span class="s5"># Cannot use assert_array_almost_equal for fit and score times because</span>
        <span class="s5"># the values are hardware-dependant</span>
        <span class="s2">assert </span><span class="s1">fit_times</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s6">&quot;float64&quot;</span>
        <span class="s2">assert </span><span class="s1">score_times</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s6">&quot;float64&quot;</span>

        <span class="s5"># Test a custom cv splitter that can iterate only once</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">w</span><span class="s3">:</span>
            <span class="s1">train_sizes2</span><span class="s3">, </span><span class="s1">train_scores2</span><span class="s3">, </span><span class="s1">test_scores2 </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
                <span class="s1">estimator</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s1">OneTimeSplitter</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s1">n_splits</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">),</span>
                <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
                <span class="s1">shuffle</span><span class="s3">=</span><span class="s1">shuffle_train</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">w</span><span class="s3">) &gt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s6">&quot;Unexpected warning: %r&quot; </span><span class="s3">% </span><span class="s1">w</span><span class="s3">[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">message</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores2</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores2</span><span class="s3">, </span><span class="s1">test_scores</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_unsupervised</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1.9</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_learning_curve_verbose</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>

    <span class="s1">old_stdout </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span>
    <span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout </span><span class="s3">= </span><span class="s1">StringIO</span><span class="s3">()</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s4">1</span>
        <span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">out </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout </span><span class="s3">= </span><span class="s1">old_stdout</span>

    <span class="s2">assert </span><span class="s6">&quot;[learning_curve]&quot; </span><span class="s2">in </span><span class="s1">out</span>


<span class="s2">def </span><span class="s1">test_learning_curve_incremental_learning_not_possible</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s5"># The mockup does not have partial_fit()</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_incremental_learning</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockIncrementalImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">shuffle_train </span><span class="s2">in </span><span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]:</span>
        <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
            <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
            <span class="s1">shuffle</span><span class="s3">=</span><span class="s1">shuffle_train</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1.9</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_learning_curve_incremental_learning_unsupervised</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockIncrementalImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1.9</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_learning_curve_batch_and_incremental_learning_are_equal</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">train_sizes </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">PassiveAggressiveClassifier</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">train_sizes_inc</span><span class="s3">, </span><span class="s1">train_scores_inc</span><span class="s3">, </span><span class="s1">test_scores_inc </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">train_sizes</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">train_sizes_batch</span><span class="s3">, </span><span class="s1">train_scores_batch</span><span class="s3">, </span><span class="s1">test_scores_batch </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">train_sizes</span><span class="s3">,</span>
        <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes_inc</span><span class="s3">, </span><span class="s1">train_sizes_batch</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">train_scores_inc</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">train_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">test_scores_inc</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">test_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_n_sample_range_out_of_bounds</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=[</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.1</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">20</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">21</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_learning_curve_remove_duplicate_sample_sizes</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s6">&quot;Removed duplicate entries from 'train_sizes'. Number of ticks &quot;</span>
        <span class="s6">&quot;will be less than the size of 'train_sizes': 2 instead of 3.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.33</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_learning_curve_with_boolean_indices</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_sizes</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1.9</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_learning_curve_with_shuffle</span><span class="s3">():</span>
    <span class="s5"># Following test case was designed this way to verify the code</span>
    <span class="s5"># changes made in pull request: #7506.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">11</span><span class="s3">, </span><span class="s4">12</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">13</span><span class="s3">, </span><span class="s4">14</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">15</span><span class="s3">, </span><span class="s4">16</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">17</span><span class="s3">, </span><span class="s4">18</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">19</span><span class="s3">, </span><span class="s4">20</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">9</span><span class="s3">, </span><span class="s4">10</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">11</span><span class="s3">, </span><span class="s4">12</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">13</span><span class="s3">, </span><span class="s4">14</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">15</span><span class="s3">, </span><span class="s4">16</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">17</span><span class="s3">, </span><span class="s4">18</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">])</span>
    <span class="s1">groups </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">])</span>
    <span class="s5"># Splits on these groups fail without shuffle as the first iteration</span>
    <span class="s5"># of the learning curve doesn't contain label 4 in the training set.</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">PassiveAggressiveClassifier</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">cv </span><span class="s3">= </span><span class="s1">GroupKFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">train_sizes_batch</span><span class="s3">, </span><span class="s1">train_scores_batch</span><span class="s3">, </span><span class="s1">test_scores_batch </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.3</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s1">groups</span><span class="s3">,</span>
        <span class="s1">shuffle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">train_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0.75</span><span class="s3">, </span><span class="s4">0.3</span><span class="s3">, </span><span class="s4">0.36111111</span><span class="s3">])</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">test_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0.36111111</span><span class="s3">, </span><span class="s4">0.25</span><span class="s3">, </span><span class="s4">0.25</span><span class="s3">])</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
            <span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
            <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.3</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
            <span class="s1">groups</span><span class="s3">=</span><span class="s1">groups</span><span class="s3">,</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s1">train_sizes_inc</span><span class="s3">, </span><span class="s1">train_scores_inc</span><span class="s3">, </span><span class="s1">test_scores_inc </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.3</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s1">groups</span><span class="s3">,</span>
        <span class="s1">shuffle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">train_scores_inc</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">train_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">test_scores_inc</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">test_scores_batch</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_fit_params</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">100</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">5 </span><span class="s3">+ [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">expected_sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;Expected sample_weight to be passed&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AssertionError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;sample_weight.shape == \(1,\), expected \(2,\)!&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)}</span>
        <span class="s3">)</span>
    <span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)}</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_incremental_learning_fit_params</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MockIncrementalImprovingEstimator</span><span class="s3">(</span><span class="s4">20</span><span class="s3">, [</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">])</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;Expected fit parameter\(s\) \['sample_weight'\] not seen.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AssertionError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
            <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">&quot;Fit parameter sample_weight has length 3; expected&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AssertionError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
            <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
            <span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">3</span><span class="s3">)},</span>
        <span class="s3">)</span>

    <span class="s1">learning_curve</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">train_sizes</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">),</span>
        <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
        <span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)},</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_validation_curve</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">param_range </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">w</span><span class="s3">:</span>
        <span class="s1">train_scores</span><span class="s3">, </span><span class="s1">test_scores </span><span class="s3">= </span><span class="s1">validation_curve</span><span class="s3">(</span>
            <span class="s1">MockEstimatorWithParameter</span><span class="s3">(),</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;param&quot;</span><span class="s3">,</span>
            <span class="s1">param_range</span><span class="s3">=</span><span class="s1">param_range</span><span class="s3">,</span>
            <span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">w</span><span class="s3">) &gt; </span><span class="s4">0</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s6">&quot;Unexpected warning: %r&quot; </span><span class="s3">% </span><span class="s1">w</span><span class="s3">[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">message</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">train_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">param_range</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">test_scores</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s4">1 </span><span class="s3">- </span><span class="s1">param_range</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_validation_curve_clone_estimator</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">n_redundant</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">param_range </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">validation_curve</span><span class="s3">(</span>
        <span class="s1">MockEstimatorWithSingleFitCallAllowed</span><span class="s3">(),</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;param&quot;</span><span class="s3">,</span>
        <span class="s1">param_range</span><span class="s3">=</span><span class="s1">param_range</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_validation_curve_cv_splits_consistency</span><span class="s3">():</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">n_splits </span><span class="s3">= </span><span class="s4">5</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">scores1 </span><span class="s3">= </span><span class="s1">validation_curve</span><span class="s3">(</span>
        <span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">),</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;C&quot;</span><span class="s3">,</span>
        <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">],</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">OneTimeSplitter</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s1">n_splits</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s5"># The OneTimeSplitter is a non-re-entrant cv splitter. Unless, the</span>
    <span class="s5"># `split` is called for each parameter, the following should produce</span>
    <span class="s5"># identical results for param setting 1 and param setting 2 as both have</span>
    <span class="s5"># the same C value.</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vsplit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">(</span><span class="s1">scores1</span><span class="s3">)[(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">), :], </span><span class="s4">2</span><span class="s3">))</span>

    <span class="s1">scores2 </span><span class="s3">= </span><span class="s1">validation_curve</span><span class="s3">(</span>
        <span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">),</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;C&quot;</span><span class="s3">,</span>
        <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">],</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s1">n_splits</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
    <span class="s3">)</span>

    <span class="s5"># For scores2, compare the 1st and 2nd parameter's scores</span>
    <span class="s5"># (Since the C value for 1st two param setting is 0.1, they must be</span>
    <span class="s5"># consistent unless the train test folds differ between the param settings)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vsplit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">(</span><span class="s1">scores2</span><span class="s3">)[(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">), :], </span><span class="s4">2</span><span class="s3">))</span>

    <span class="s1">scores3 </span><span class="s3">= </span><span class="s1">validation_curve</span><span class="s3">(</span>
        <span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">),</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;C&quot;</span><span class="s3">,</span>
        <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">],</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s1">n_splits</span><span class="s3">),</span>
    <span class="s3">)</span>

    <span class="s5"># OneTimeSplitter is basically unshuffled KFold(n_splits=5). Sanity check.</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">scores3</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">scores1</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_validation_curve_fit_params</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">100</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">5 </span><span class="s3">+ [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">expected_sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;Expected sample_weight to be passed&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AssertionError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">validation_curve</span><span class="s3">(</span>
            <span class="s1">clf</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;foo_param&quot;</span><span class="s3">,</span>
            <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">],</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">r&quot;sample_weight.shape == \(1,\), expected \(8,\)!&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">validation_curve</span><span class="s3">(</span>
            <span class="s1">clf</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">,</span>
            <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;foo_param&quot;</span><span class="s3">,</span>
            <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">],</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
            <span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)},</span>
        <span class="s3">)</span>
    <span class="s1">validation_curve</span><span class="s3">(</span>
        <span class="s1">clf</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">param_name</span><span class="s3">=</span><span class="s6">&quot;foo_param&quot;</span><span class="s3">,</span>
        <span class="s1">param_range</span><span class="s3">=[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">],</span>
        <span class="s1">error_score</span><span class="s3">=</span><span class="s6">&quot;raise&quot;</span><span class="s3">,</span>
        <span class="s1">fit_params</span><span class="s3">={</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)},</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_is_permutation</span><span class="s3">():</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">100</span><span class="s3">)</span>
    <span class="s1">rng</span><span class="s3">.</span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">_check_is_permutation</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s4">100</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">_check_is_permutation</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s4">23</span><span class="s3">), </span><span class="s4">100</span><span class="s3">)</span>

    <span class="s1">p</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] = </span><span class="s4">23</span>
    <span class="s2">assert not </span><span class="s1">_check_is_permutation</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s4">100</span><span class="s3">)</span>

    <span class="s5"># Check if the additional duplicate indices are caught</span>
    <span class="s2">assert not </span><span class="s1">_check_is_permutation</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">p</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)), </span><span class="s4">100</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_val_predict_sparse_prediction</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s5"># check that cross_val_predict gives same result for sparse and dense input</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_multilabel_classification</span><span class="s3">(</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">,</span>
        <span class="s1">n_labels</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s1">allow_unlabeled</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">return_indicator</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s4">1</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">y_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">classif </span><span class="s3">= </span><span class="s1">OneVsRestClassifier</span><span class="s3">(</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">))</span>
    <span class="s1">preds </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">classif</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">preds_sparse </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">classif</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">y_sparse</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">preds_sparse </span><span class="s3">= </span><span class="s1">preds_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">preds_sparse</span><span class="s3">, </span><span class="s1">preds</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_val_predict_binary</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Helper for tests of cross_val_predict with binary classification&quot;&quot;&quot;</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s5"># Generate expected outputs</span>
    <span class="s2">if </span><span class="s1">y</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">exp_shape </span><span class="s3">= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),) </span><span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s6">&quot;decision_function&quot; </span><span class="s2">else </span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">exp_shape </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">exp_shape</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">est</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">expected_predictions</span><span class="s3">[</span><span class="s1">test</span><span class="s3">] = </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">])</span>

    <span class="s5"># Check actual outputs for several representations of y</span>
    <span class="s2">for </span><span class="s1">tg </span><span class="s2">in </span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">, </span><span class="s1">y </span><span class="s3">- </span><span class="s4">2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;str&quot;</span><span class="s3">)]:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span>
            <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tg</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">), </span><span class="s1">expected_predictions</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_val_predict_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Helper for tests of cross_val_predict with multiclass classification&quot;&quot;&quot;</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s5"># Generate expected outputs</span>
    <span class="s1">float_min </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">min</span>
    <span class="s1">default_values </span><span class="s3">= {</span>
        <span class="s6">&quot;decision_function&quot;</span><span class="s3">: </span><span class="s1">float_min</span><span class="s3">,</span>
        <span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">: </span><span class="s1">float_min</span><span class="s3">,</span>
        <span class="s6">&quot;predict_proba&quot;</span><span class="s3">: </span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))), </span><span class="s1">default_values</span><span class="s3">[</span><span class="s1">method</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s3">)</span>
    <span class="s1">_</span><span class="s3">, </span><span class="s1">y_enc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">return_inverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y_enc</span><span class="s3">):</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">est</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y_enc</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">fold_preds </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">])</span>
        <span class="s1">i_cols_fit </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y_enc</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">expected_predictions</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ix_</span><span class="s3">(</span><span class="s1">test</span><span class="s3">, </span><span class="s1">i_cols_fit</span><span class="s3">)] = </span><span class="s1">fold_preds</span>

    <span class="s5"># Check actual outputs for several representations of y</span>
    <span class="s2">for </span><span class="s1">tg </span><span class="s2">in </span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">, </span><span class="s1">y </span><span class="s3">- </span><span class="s4">2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;str&quot;</span><span class="s3">)]:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span>
            <span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tg</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">), </span><span class="s1">expected_predictions</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_val_predict_multilabel</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the output of cross_val_predict for 2D targets using 
    Estimators which provide a predictions as a list with one 
    element per class. 
    &quot;&quot;&quot;</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s5"># Create empty arrays of the correct size to hold outputs</span>
    <span class="s1">float_min </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">min</span>
    <span class="s1">default_values </span><span class="s3">= {</span>
        <span class="s6">&quot;decision_function&quot;</span><span class="s3">: </span><span class="s1">float_min</span><span class="s3">,</span>
        <span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">: </span><span class="s1">float_min</span><span class="s3">,</span>
        <span class="s6">&quot;predict_proba&quot;</span><span class="s3">: </span><span class="s4">0</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">n_targets </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>
    <span class="s1">expected_preds </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">i_col </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_targets</span><span class="s3">):</span>
        <span class="s1">n_classes_in_label </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">i_col</span><span class="s3">]))</span>
        <span class="s2">if </span><span class="s1">n_classes_in_label </span><span class="s3">== </span><span class="s4">2 </span><span class="s2">and </span><span class="s1">method </span><span class="s3">== </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">:</span>
            <span class="s1">exp_shape </span><span class="s3">= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">exp_shape </span><span class="s3">= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">n_classes_in_label</span><span class="s3">)</span>
        <span class="s1">expected_preds</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">exp_shape</span><span class="s3">, </span><span class="s1">default_values</span><span class="s3">[</span><span class="s1">method</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s5"># Generate expected outputs</span>
    <span class="s1">y_enc_cols </span><span class="s3">= [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">i</span><span class="s3">], </span><span class="s1">return_inverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)[</span><span class="s4">1</span><span class="s3">][:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">])</span>
    <span class="s3">]</span>
    <span class="s1">y_enc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">(</span><span class="s1">y_enc_cols</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y_enc</span><span class="s3">):</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">est</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y_enc</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">fold_preds </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">])</span>
        <span class="s2">for </span><span class="s1">i_col </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_targets</span><span class="s3">):</span>
            <span class="s1">fold_cols </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y_enc</span><span class="s3">[</span><span class="s1">train</span><span class="s3">][:, </span><span class="s1">i_col</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">expected_preds</span><span class="s3">[</span><span class="s1">i_col</span><span class="s3">].</span><span class="s1">ndim </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
                <span class="s5"># Decision function with &lt;=2 classes</span>
                <span class="s1">expected_preds</span><span class="s3">[</span><span class="s1">i_col</span><span class="s3">][</span><span class="s1">test</span><span class="s3">] = </span><span class="s1">fold_preds</span><span class="s3">[</span><span class="s1">i_col</span><span class="s3">]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">idx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ix_</span><span class="s3">(</span><span class="s1">test</span><span class="s3">, </span><span class="s1">fold_cols</span><span class="s3">)</span>
                <span class="s1">expected_preds</span><span class="s3">[</span><span class="s1">i_col</span><span class="s3">][</span><span class="s1">idx</span><span class="s3">] = </span><span class="s1">fold_preds</span><span class="s3">[</span><span class="s1">i_col</span><span class="s3">]</span>

    <span class="s5"># Check actual outputs for several representations of y</span>
    <span class="s2">for </span><span class="s1">tg </span><span class="s2">in </span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">, </span><span class="s1">y </span><span class="s3">- </span><span class="s4">2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;str&quot;</span><span class="s3">)]:</span>
        <span class="s1">cv_predict_output </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tg</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">cv_predict_output</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">expected_preds</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">cv_predict_output</span><span class="s3">)):</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cv_predict_output</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">expected_preds</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">check_cross_val_predict_with_method_binary</span><span class="s3">(</span><span class="s1">est</span><span class="s3">):</span>
    <span class="s5"># This test includes the decision_function with two classes.</span>
    <span class="s5"># This is a special case: it has only one column of output.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]:</span>
        <span class="s1">check_cross_val_predict_binary</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_cross_val_predict_with_method_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">):</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]:</span>
        <span class="s1">check_cross_val_predict_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_with_method</span><span class="s3">():</span>
    <span class="s1">check_cross_val_predict_with_method_binary</span><span class="s3">(</span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">))</span>
    <span class="s1">check_cross_val_predict_with_method_multiclass</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_method_checking</span><span class="s3">():</span>
    <span class="s5"># Regression test for issue #9639. Tests that cross_val_predict does not</span>
    <span class="s5"># check estimator methods (e.g. predict_proba) before fitting</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]:</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">SGDClassifier</span><span class="s3">(</span><span class="s1">loss</span><span class="s3">=</span><span class="s6">&quot;log_loss&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">check_cross_val_predict_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_gridsearchcv_cross_val_predict_with_method</span><span class="s3">():</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">GridSearchCV</span><span class="s3">(</span>
        <span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span><span class="s3">, </span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">), {</span><span class="s6">&quot;C&quot;</span><span class="s3">: [</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]}, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span>
    <span class="s3">)</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]:</span>
        <span class="s1">check_cross_val_predict_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_with_method_multilabel_ovr</span><span class="s3">():</span>
    <span class="s5"># OVR does multilabel predictions, but only arrays of</span>
    <span class="s5"># binary indicator columns. The output of predict_proba</span>
    <span class="s5"># is a 2D array with shape (n_samples, n_classes).</span>
    <span class="s1">n_samp </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">n_classes </span><span class="s3">= </span><span class="s4">4</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_multilabel_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samp</span><span class="s3">, </span><span class="s1">n_labels</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">=</span><span class="s1">n_classes</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span>
    <span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">OneVsRestClassifier</span><span class="s3">(</span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">]:</span>
        <span class="s1">check_cross_val_predict_binary</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">RFWithDecisionFunction</span><span class="s3">(</span><span class="s1">RandomForestClassifier</span><span class="s3">):</span>
    <span class="s5"># None of the current multioutput-multiclass estimators have</span>
    <span class="s5"># decision function methods. Create a mock decision function</span>
    <span class="s5"># to test the cross_val_predict function's handling of this case.</span>
    <span class="s2">def </span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s1">probs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;This helper should only be used on multioutput-multiclass tasks&quot;</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">probs</span><span class="s3">, </span><span class="s1">list</span><span class="s3">), </span><span class="s1">msg</span>
        <span class="s1">probs </span><span class="s3">= [</span><span class="s1">p</span><span class="s3">[:, -</span><span class="s4">1</span><span class="s3">] </span><span class="s2">if </span><span class="s1">p</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] == </span><span class="s4">2 </span><span class="s2">else </span><span class="s1">p </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">probs</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">probs</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_with_method_multilabel_rf</span><span class="s3">():</span>
    <span class="s5"># The RandomForest allows multiple classes in each label.</span>
    <span class="s5"># Output of predict_proba is a list of outputs of predict_proba</span>
    <span class="s5"># for each individual label.</span>
    <span class="s1">n_classes </span><span class="s3">= </span><span class="s4">4</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_multilabel_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">n_labels</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">=</span><span class="s1">n_classes</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span>
    <span class="s3">)</span>
    <span class="s1">y</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] += </span><span class="s1">y</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">]  </span><span class="s5"># Put three classes in the first column</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">]:</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">RFWithDecisionFunction</span><span class="s3">(</span><span class="s1">n_estimators</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s5"># Suppress &quot;RuntimeWarning: divide by zero encountered in log&quot;</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;ignore&quot;</span><span class="s3">)</span>
            <span class="s1">check_cross_val_predict_multilabel</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_with_method_rare_class</span><span class="s3">():</span>
    <span class="s5"># Test a multiclass problem where one class will be missing from</span>
    <span class="s5"># one of the CV training sets.</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">14</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">]:</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s5"># Suppress warning about too few examples of a class</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;ignore&quot;</span><span class="s3">)</span>
            <span class="s1">check_cross_val_predict_multiclass</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_with_method_multilabel_rf_rare_class</span><span class="s3">():</span>
    <span class="s5"># The RandomForest allows anything for the contents of the labels.</span>
    <span class="s5"># Output of predict_proba is a list of outputs of predict_proba</span>
    <span class="s5"># for each individual label.</span>
    <span class="s5"># In this test, the first label has a class with a single example.</span>
    <span class="s5"># We'll have one CV fold where the training data don't include it.</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]])</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]:</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">RFWithDecisionFunction</span><span class="s3">(</span><span class="s1">n_estimators</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s5"># Suppress &quot;RuntimeWarning: divide by zero encountered in log&quot;</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;ignore&quot;</span><span class="s3">)</span>
            <span class="s1">check_cross_val_predict_multilabel</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">get_expected_predictions</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">, </span><span class="s1">classes</span><span class="s3">, </span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
    <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">([</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">classes</span><span class="s3">])</span>
    <span class="s1">func </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s2">in </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">train</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">train</span><span class="s3">])</span>
        <span class="s1">expected_predictions_ </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">test</span><span class="s3">])</span>
        <span class="s5"># To avoid 2 dimensional indexing</span>
        <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">:</span>
            <span class="s1">exp_pred_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">len</span><span class="s3">(</span><span class="s1">test</span><span class="s3">), </span><span class="s1">classes</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">exp_pred_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">test</span><span class="s3">), </span><span class="s1">classes</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">expected_predictions</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">).</span><span class="s1">min</span>
            <span class="s3">)</span>
        <span class="s1">exp_pred_test</span><span class="s3">[:, </span><span class="s1">est</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">] = </span><span class="s1">expected_predictions_</span>
        <span class="s1">expected_predictions</span><span class="s3">[</span><span class="s1">test</span><span class="s3">] = </span><span class="s1">exp_pred_test</span>

    <span class="s2">return </span><span class="s1">expected_predictions</span>


<span class="s2">def </span><span class="s1">test_cross_val_predict_class_subset</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">200</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">100</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">x </span><span class="s3">// </span><span class="s4">10 </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">100</span><span class="s3">)])</span>
    <span class="s1">classes </span><span class="s3">= </span><span class="s4">10</span>

    <span class="s1">kfold3 </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">kfold4 </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">4</span><span class="s3">)</span>

    <span class="s1">le </span><span class="s3">= </span><span class="s1">LabelEncoder</span><span class="s3">()</span>

    <span class="s1">methods </span><span class="s3">= [</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_log_proba&quot;</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s1">methods</span><span class="s3">:</span>
        <span class="s1">est </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">solver</span><span class="s3">=</span><span class="s6">&quot;liblinear&quot;</span><span class="s3">)</span>

        <span class="s5"># Test with n_splits=3</span>
        <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">kfold3</span><span class="s3">)</span>

        <span class="s5"># Runs a naive loop (should be same as cross_val_predict):</span>
        <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">get_expected_predictions</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">kfold3</span><span class="s3">, </span><span class="s1">classes</span><span class="s3">, </span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">expected_predictions</span><span class="s3">, </span><span class="s1">predictions</span><span class="s3">)</span>

        <span class="s5"># Test with n_splits=4</span>
        <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">kfold4</span><span class="s3">)</span>
        <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">get_expected_predictions</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">kfold4</span><span class="s3">, </span><span class="s1">classes</span><span class="s3">, </span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">expected_predictions</span><span class="s3">, </span><span class="s1">predictions</span><span class="s3">)</span>

        <span class="s5"># Testing unordered labels</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s4">10</span><span class="s3">), </span><span class="s4">10</span><span class="s3">), </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">predictions </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">kfold3</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">le</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">expected_predictions </span><span class="s3">= </span><span class="s1">get_expected_predictions</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">kfold3</span><span class="s3">, </span><span class="s1">classes</span><span class="s3">, </span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">expected_predictions</span><span class="s3">, </span><span class="s1">predictions</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_score_memmap</span><span class="s3">():</span>
    <span class="s5"># Ensure a scalar score of memmap type is accepted</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MockClassifier</span><span class="s3">()</span>
    <span class="s1">tf </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">NamedTemporaryFile</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s6">&quot;wb&quot;</span><span class="s3">, </span><span class="s1">delete</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">tf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s7">b&quot;Hello world!!!!!&quot;</span><span class="s3">)</span>
    <span class="s1">tf</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s1">scores </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">memmap</span><span class="s3">(</span><span class="s1">tf</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">score </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">memmap</span><span class="s3">(</span><span class="s1">tf</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=(), </span><span class="s1">mode</span><span class="s3">=</span><span class="s6">&quot;r&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">score</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cross_val_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">scores</span><span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s5"># Best effort to release the mmap file handles before deleting the</span>
        <span class="s5"># backing file under Windows</span>
        <span class="s1">scores</span><span class="s3">, </span><span class="s1">score </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">tf</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s2">break</span>
            <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
                <span class="s1">sleep</span><span class="s3">(</span><span class="s4">1.0</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore: Using or importing the ABCs from&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_permutation_test_score_pandas</span><span class="s3">():</span>
    <span class="s5"># check permutation_test_score doesn't destroy pandas dataframe</span>
    <span class="s1">types </span><span class="s3">= [(</span><span class="s1">MockDataFrame</span><span class="s3">, </span><span class="s1">MockDataFrame</span><span class="s3">)]</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">DataFrame</span><span class="s3">, </span><span class="s1">Series</span>

        <span class="s1">types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">Series</span><span class="s3">, </span><span class="s1">DataFrame</span><span class="s3">))</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s2">pass</span>
    <span class="s2">for </span><span class="s1">TargetType</span><span class="s3">, </span><span class="s1">InputFeatureType </span><span class="s2">in </span><span class="s1">types</span><span class="s3">:</span>
        <span class="s5"># X dataframe, y series</span>
        <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
        <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
        <span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser </span><span class="s3">= </span><span class="s1">InputFeatureType</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">TargetType</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">check_df </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">InputFeatureType</span><span class="s3">)</span>
        <span class="s1">check_series </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">TargetType</span><span class="s3">)</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">CheckingClassifier</span><span class="s3">(</span><span class="s1">check_X</span><span class="s3">=</span><span class="s1">check_df</span><span class="s3">, </span><span class="s1">check_y</span><span class="s3">=</span><span class="s1">check_series</span><span class="s3">)</span>
        <span class="s1">permutation_test_score</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">y_ser</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fit_and_score_failing</span><span class="s3">():</span>
    <span class="s5"># Create a failing classifier to deliberately fail</span>
    <span class="s1">failing_clf </span><span class="s3">= </span><span class="s1">FailingClassifier</span><span class="s3">(</span><span class="s1">FailingClassifier</span><span class="s3">.</span><span class="s1">FAILING_PARAMETER</span><span class="s3">)</span>
    <span class="s5"># dummy X data</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">fit_and_score_args </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">=</span><span class="s1">failing_clf</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scorer</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(),</span>
        <span class="s1">train</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">test</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">verbose</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">parameters</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">fit_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">score_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s5"># passing error score to trigger the warning message</span>
    <span class="s1">fit_and_score_args</span><span class="s3">[</span><span class="s6">&quot;error_score&quot;</span><span class="s3">] = </span><span class="s6">&quot;raise&quot;</span>
    <span class="s5"># check if exception was raised, with default error_score='raise'</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Failing classifier failed as required&quot;</span><span class="s3">):</span>
        <span class="s1">_fit_and_score</span><span class="s3">(**</span><span class="s1">fit_and_score_args</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">failing_clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">() == </span><span class="s4">0.0  </span><span class="s5"># FailingClassifier coverage</span>


<span class="s2">def </span><span class="s1">test_fit_and_score_working</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">ShuffleSplit</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s5"># Test return_parameters option</span>
    <span class="s1">fit_and_score_args </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">,</span>
        <span class="s1">scorer</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(),</span>
        <span class="s1">train</span><span class="s3">=</span><span class="s1">train</span><span class="s3">,</span>
        <span class="s1">test</span><span class="s3">=</span><span class="s1">test</span><span class="s3">,</span>
        <span class="s1">verbose</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">parameters</span><span class="s3">={</span><span class="s6">&quot;max_iter&quot;</span><span class="s3">: </span><span class="s4">100</span><span class="s3">, </span><span class="s6">&quot;tol&quot;</span><span class="s3">: </span><span class="s4">0.1</span><span class="s3">},</span>
        <span class="s1">fit_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">score_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">return_parameters</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">_fit_and_score</span><span class="s3">(**</span><span class="s1">fit_and_score_args</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">result</span><span class="s3">[</span><span class="s6">&quot;parameters&quot;</span><span class="s3">] == </span><span class="s1">fit_and_score_args</span><span class="s3">[</span><span class="s6">&quot;parameters&quot;</span><span class="s3">]</span>


<span class="s2">class </span><span class="s1">DataDependentFailingClassifier</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">max_x_value</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">max_x_value </span><span class="s3">= </span><span class="s1">max_x_value</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">num_values_too_high </span><span class="s3">= (</span><span class="s1">X </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">max_x_value</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">num_values_too_high</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s6">f&quot;Classifier fit failed with </span><span class="s2">{</span><span class="s1">num_values_too_high</span><span class="s2">} </span><span class="s6">values too high&quot;</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">0.0</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;error_score&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_cross_validate_some_failing_fits_warning</span><span class="s3">(</span><span class="s1">error_score</span><span class="s3">):</span>
    <span class="s5"># Create a failing classifier to deliberately fail</span>
    <span class="s1">failing_clf </span><span class="s3">= </span><span class="s1">DataDependentFailingClassifier</span><span class="s3">(</span><span class="s1">max_x_value</span><span class="s3">=</span><span class="s4">8</span><span class="s3">)</span>
    <span class="s5"># dummy X data</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">9</span><span class="s3">)</span>
    <span class="s5"># passing error score to trigger the warning message</span>
    <span class="s1">cross_validate_args </span><span class="s3">= [</span><span class="s1">failing_clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s1">cross_validate_kwargs </span><span class="s3">= {</span><span class="s6">&quot;cv&quot;</span><span class="s3">: </span><span class="s4">3</span><span class="s3">, </span><span class="s6">&quot;error_score&quot;</span><span class="s3">: </span><span class="s1">error_score</span><span class="s3">}</span>
    <span class="s5"># check if the warning message type is as expected</span>

    <span class="s1">individual_fit_error_message </span><span class="s3">= (</span>
        <span class="s6">&quot;ValueError: Classifier fit failed with 1 values too high&quot;</span>
    <span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span>
        <span class="s3">(</span>
            <span class="s6">&quot;2 fits failed.+total of 3.+The score on these&quot;</span>
            <span class="s6">&quot; train-test partitions for these parameters will be set to&quot;</span>
            <span class="s6">f&quot; </span><span class="s2">{</span><span class="s1">cross_validate_kwargs</span><span class="s3">[</span><span class="s6">'error_score'</span><span class="s3">]</span><span class="s2">}</span><span class="s6">.+</span><span class="s2">{</span><span class="s1">individual_fit_error_message</span><span class="s2">}</span><span class="s6">&quot;</span>
        <span class="s3">),</span>
        <span class="s1">flags</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">DOTALL</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FitFailedWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(*</span><span class="s1">cross_validate_args</span><span class="s3">, **</span><span class="s1">cross_validate_kwargs</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;error_score&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_cross_validate_all_failing_fits_error</span><span class="s3">(</span><span class="s1">error_score</span><span class="s3">):</span>
    <span class="s5"># Create a failing classifier to deliberately fail</span>
    <span class="s1">failing_clf </span><span class="s3">= </span><span class="s1">FailingClassifier</span><span class="s3">(</span><span class="s1">FailingClassifier</span><span class="s3">.</span><span class="s1">FAILING_PARAMETER</span><span class="s3">)</span>
    <span class="s5"># dummy X data</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">9</span><span class="s3">)</span>

    <span class="s1">cross_validate_args </span><span class="s3">= [</span><span class="s1">failing_clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s1">cross_validate_kwargs </span><span class="s3">= {</span><span class="s6">&quot;cv&quot;</span><span class="s3">: </span><span class="s4">7</span><span class="s3">, </span><span class="s6">&quot;error_score&quot;</span><span class="s3">: </span><span class="s1">error_score</span><span class="s3">}</span>

    <span class="s1">individual_fit_error_message </span><span class="s3">= </span><span class="s6">&quot;ValueError: Failing classifier failed as required&quot;</span>
    <span class="s1">error_message </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span>
        <span class="s3">(</span>
            <span class="s6">&quot;All the 7 fits failed.+your model is misconfigured.+&quot;</span>
            <span class="s6">f&quot;</span><span class="s2">{</span><span class="s1">individual_fit_error_message</span><span class="s2">}</span><span class="s6">&quot;</span>
        <span class="s3">),</span>
        <span class="s1">flags</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">DOTALL</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(*</span><span class="s1">cross_validate_args</span><span class="s3">, **</span><span class="s1">cross_validate_kwargs</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_failing_scorer</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">error_msg</span><span class="s3">):</span>
    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">error_msg</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:lbfgs failed to converge&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;error_score&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s6">&quot;raise&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_cross_val_score_failing_scorer</span><span class="s3">(</span><span class="s1">error_score</span><span class="s3">):</span>
    <span class="s5"># check that an estimator can fail during scoring in `cross_val_score` and</span>
    <span class="s5"># that we can optionally replaced it with `error_score`</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s4">5</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">error_msg </span><span class="s3">= </span><span class="s6">&quot;This scorer is supposed to fail!!!&quot;</span>
    <span class="s1">failing_scorer </span><span class="s3">= </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">_failing_scorer</span><span class="s3">, </span><span class="s1">error_msg</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">error_score </span><span class="s3">== </span><span class="s6">&quot;raise&quot;</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">cross_val_score</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">failing_scorer</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s1">error_score</span>
            <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">warning_msg </span><span class="s3">= (</span>
            <span class="s6">&quot;Scoring failed. The score on this train-test partition for &quot;</span>
            <span class="s6">f&quot;these parameters will be set to </span><span class="s2">{</span><span class="s1">error_score</span><span class="s2">}</span><span class="s6">&quot;</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_msg</span><span class="s3">):</span>
            <span class="s1">scores </span><span class="s3">= </span><span class="s1">cross_val_score</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">failing_scorer</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s1">error_score</span>
            <span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scores</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:lbfgs failed to converge&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;error_score&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s6">&quot;raise&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;return_train_score&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;with_multimetric&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_cross_validate_failing_scorer</span><span class="s3">(</span>
    <span class="s1">error_score</span><span class="s3">, </span><span class="s1">return_train_score</span><span class="s3">, </span><span class="s1">with_multimetric</span>
<span class="s3">):</span>
    <span class="s5"># Check that an estimator can fail during scoring in `cross_validate` and</span>
    <span class="s5"># that we can optionally replace it with `error_score`. In the multimetric</span>
    <span class="s5"># case also check the result of a non-failing scorer where the other scorers</span>
    <span class="s5"># are failing.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s4">5</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">error_msg </span><span class="s3">= </span><span class="s6">&quot;This scorer is supposed to fail!!!&quot;</span>
    <span class="s1">failing_scorer </span><span class="s3">= </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">_failing_scorer</span><span class="s3">, </span><span class="s1">error_msg</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">with_multimetric</span><span class="s3">:</span>
        <span class="s1">non_failing_scorer </span><span class="s3">= </span><span class="s1">make_scorer</span><span class="s3">(</span><span class="s1">mean_squared_error</span><span class="s3">)</span>
        <span class="s1">scoring </span><span class="s3">= {</span>
            <span class="s6">&quot;score_1&quot;</span><span class="s3">: </span><span class="s1">failing_scorer</span><span class="s3">,</span>
            <span class="s6">&quot;score_2&quot;</span><span class="s3">: </span><span class="s1">non_failing_scorer</span><span class="s3">,</span>
            <span class="s6">&quot;score_3&quot;</span><span class="s3">: </span><span class="s1">failing_scorer</span><span class="s3">,</span>
        <span class="s3">}</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">scoring </span><span class="s3">= </span><span class="s1">failing_scorer</span>

    <span class="s2">if </span><span class="s1">error_score </span><span class="s3">== </span><span class="s6">&quot;raise&quot;</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
                <span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">,</span>
                <span class="s1">return_train_score</span><span class="s3">=</span><span class="s1">return_train_score</span><span class="s3">,</span>
                <span class="s1">error_score</span><span class="s3">=</span><span class="s1">error_score</span><span class="s3">,</span>
            <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">warning_msg </span><span class="s3">= (</span>
            <span class="s6">&quot;Scoring failed. The score on this train-test partition for &quot;</span>
            <span class="s6">f&quot;these parameters will be set to </span><span class="s2">{</span><span class="s1">error_score</span><span class="s2">}</span><span class="s6">&quot;</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_msg</span><span class="s3">):</span>
            <span class="s1">results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span>
                <span class="s1">clf</span><span class="s3">,</span>
                <span class="s1">X</span><span class="s3">,</span>
                <span class="s1">y</span><span class="s3">,</span>
                <span class="s1">cv</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
                <span class="s1">scoring</span><span class="s3">=</span><span class="s1">scoring</span><span class="s3">,</span>
                <span class="s1">return_train_score</span><span class="s3">=</span><span class="s1">return_train_score</span><span class="s3">,</span>
                <span class="s1">error_score</span><span class="s3">=</span><span class="s1">error_score</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">results</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s6">&quot;_score&quot; </span><span class="s2">in </span><span class="s1">key</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s6">&quot;_score_2&quot; </span><span class="s2">in </span><span class="s1">key</span><span class="s3">:</span>
                        <span class="s5"># check the test (and optionally train) score for the</span>
                        <span class="s5"># scorer that should be non-failing</span>
                        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">results</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]:</span>
                            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s5"># check the test (and optionally train) score for all</span>
                        <span class="s5"># scorers that should be assigned to `error_score`.</span>
                        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">results</span><span class="s3">[</span><span class="s1">key</span><span class="s3">], </span><span class="s1">error_score</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">three_params_scorer</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">3.4213</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;train_score, scorer, verbose, split_prg, cdt_prg, expected&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s2">False</span><span class="s3">,</span>
            <span class="s1">three_params_scorer</span><span class="s3">,</span>
            <span class="s4">2</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">),</span>
            <span class="s6">r&quot;\[CV\] END ....................................................&quot;</span>
            <span class="s6">r&quot; total time=   0.\ds&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">True</span><span class="s3">,</span>
            <span class="s1">_MultimetricScorer</span><span class="s3">(</span>
                <span class="s1">scorers</span><span class="s3">={</span><span class="s6">&quot;sc1&quot;</span><span class="s3">: </span><span class="s1">three_params_scorer</span><span class="s3">, </span><span class="s6">&quot;sc2&quot;</span><span class="s3">: </span><span class="s1">three_params_scorer</span><span class="s3">}</span>
            <span class="s3">),</span>
            <span class="s4">3</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">),</span>
            <span class="s6">r&quot;\[CV 2/3\] END  sc1: \(train=3.421, test=3.421\) sc2: &quot;</span>
            <span class="s6">r&quot;\(train=3.421, test=3.421\) total time=   0.\ds&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">False</span><span class="s3">,</span>
            <span class="s1">_MultimetricScorer</span><span class="s3">(</span>
                <span class="s1">scorers</span><span class="s3">={</span><span class="s6">&quot;sc1&quot;</span><span class="s3">: </span><span class="s1">three_params_scorer</span><span class="s3">, </span><span class="s6">&quot;sc2&quot;</span><span class="s3">: </span><span class="s1">three_params_scorer</span><span class="s3">}</span>
            <span class="s3">),</span>
            <span class="s4">10</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">),</span>
            <span class="s6">r&quot;\[CV 2/3; 1/1\] END ....... sc1: \(test=3.421\) sc2: \(test=3.421\)&quot;</span>
            <span class="s6">r&quot; total time=   0.\ds&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fit_and_score_verbosity</span><span class="s3">(</span>
    <span class="s1">capsys</span><span class="s3">, </span><span class="s1">train_score</span><span class="s3">, </span><span class="s1">scorer</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">, </span><span class="s1">split_prg</span><span class="s3">, </span><span class="s1">cdt_prg</span><span class="s3">, </span><span class="s1">expected</span>
<span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">train</span><span class="s3">, </span><span class="s1">test </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">ShuffleSplit</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

    <span class="s5"># test print without train score</span>
    <span class="s1">fit_and_score_args </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">,</span>
        <span class="s1">scorer</span><span class="s3">=</span><span class="s1">scorer</span><span class="s3">,</span>
        <span class="s1">train</span><span class="s3">=</span><span class="s1">train</span><span class="s3">,</span>
        <span class="s1">test</span><span class="s3">=</span><span class="s1">test</span><span class="s3">,</span>
        <span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose</span><span class="s3">,</span>
        <span class="s1">parameters</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">fit_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">score_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">return_train_score</span><span class="s3">=</span><span class="s1">train_score</span><span class="s3">,</span>
        <span class="s1">split_progress</span><span class="s3">=</span><span class="s1">split_prg</span><span class="s3">,</span>
        <span class="s1">candidate_progress</span><span class="s3">=</span><span class="s1">cdt_prg</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">_fit_and_score</span><span class="s3">(**</span><span class="s1">fit_and_score_args</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">()</span>
    <span class="s1">outlines </span><span class="s3">= </span><span class="s1">out</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s6">&quot;</span><span class="s2">\n</span><span class="s6">&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">outlines</span><span class="s3">) &gt; </span><span class="s4">2</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">outlines</span><span class="s3">[</span><span class="s4">1</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">outlines</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_score</span><span class="s3">():</span>
    <span class="s1">error_message </span><span class="s3">= </span><span class="s6">&quot;scoring must return a number, got None&quot;</span>

    <span class="s2">def </span><span class="s1">two_params_scorer</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">):</span>
        <span class="s2">return None</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_message</span><span class="s3">):</span>
        <span class="s1">_score</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">X_test</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">y_test</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">scorer</span><span class="s3">=</span><span class="s1">two_params_scorer</span><span class="s3">,</span>
            <span class="s1">score_params</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">error_score</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_callable_multimetric_confusion_matrix_cross_validate</span><span class="s3">():</span>
    <span class="s2">def </span><span class="s1">custom_scorer</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">cm </span><span class="s3">= </span><span class="s1">confusion_matrix</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s6">&quot;tn&quot;</span><span class="s3">: </span><span class="s1">cm</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], </span><span class="s6">&quot;fp&quot;</span><span class="s3">: </span><span class="s1">cm</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s6">&quot;fn&quot;</span><span class="s3">: </span><span class="s1">cm</span><span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], </span><span class="s6">&quot;tp&quot;</span><span class="s3">: </span><span class="s1">cm</span><span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]}</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s4">40</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s4">4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">cv_results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">custom_scorer</span><span class="s3">)</span>

    <span class="s1">score_names </span><span class="s3">= [</span><span class="s6">&quot;tn&quot;</span><span class="s3">, </span><span class="s6">&quot;fp&quot;</span><span class="s3">, </span><span class="s6">&quot;fn&quot;</span><span class="s3">, </span><span class="s6">&quot;tp&quot;</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">score_names</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s6">&quot;test_{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">name</span><span class="s3">) </span><span class="s2">in </span><span class="s1">cv_results</span>


<span class="s2">def </span><span class="s1">test_learning_curve_partial_fit_regressors</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that regressors with partial_fit is supported. 
 
    Non-regression test for #22981. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span><span class="s3">)</span>

    <span class="s5"># Does not error</span>
    <span class="s1">learning_curve</span><span class="s3">(</span><span class="s1">MLPRegressor</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">exploit_incremental_learning</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_learning_curve_some_failing_fits_warning</span><span class="s3">(</span><span class="s1">global_random_seed</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Checks for fit failures in `learning_curve` and raises the required warning&quot;&quot;&quot;</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">30</span><span class="s3">,</span>
        <span class="s1">n_classes</span><span class="s3">=</span><span class="s4">3</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s4">6</span><span class="s3">,</span>
        <span class="s1">shuffle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s1">global_random_seed</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s5"># sorting the target to trigger SVC error on the 2 first splits because a single</span>
    <span class="s5"># class is present</span>
    <span class="s1">sorted_idx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argsort</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[</span><span class="s1">sorted_idx</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">sorted_idx</span><span class="s3">]</span>

    <span class="s1">svc </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">warning_message </span><span class="s3">= </span><span class="s6">&quot;10 fits failed out of a total of 25&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FitFailedWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">train_score</span><span class="s3">, </span><span class="s1">test_score</span><span class="s3">, *</span><span class="s1">_ </span><span class="s3">= </span><span class="s1">learning_curve</span><span class="s3">(</span>
            <span class="s1">svc</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">error_score</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s3">)</span>

    <span class="s5"># the first 2 splits should lead to warnings and thus np.nan scores</span>
    <span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">2</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">train_score</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">test_score</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>

    <span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">train_score</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]):</span>
        <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">train_score</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]).</span><span class="s1">any</span><span class="s3">()</span>
        <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">test_score</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]).</span><span class="s1">any</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_cross_validate_return_indices</span><span class="s3">(</span><span class="s1">global_random_seed</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `return_indices` in `cross_validate`.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)  </span><span class="s5"># scale features for better convergence</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">()</span>

    <span class="s1">cv </span><span class="s3">= </span><span class="s1">KFold</span><span class="s3">(</span><span class="s1">n_splits</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">shuffle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">global_random_seed</span><span class="s3">)</span>
    <span class="s1">cv_results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">return_indices</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">&quot;indices&quot; </span><span class="s2">not in </span><span class="s1">cv_results</span>

    <span class="s1">cv_results </span><span class="s3">= </span><span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">return_indices</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">&quot;indices&quot; </span><span class="s2">in </span><span class="s1">cv_results</span>
    <span class="s1">train_indices </span><span class="s3">= </span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;indices&quot;</span><span class="s3">][</span><span class="s6">&quot;train&quot;</span><span class="s3">]</span>
    <span class="s1">test_indices </span><span class="s3">= </span><span class="s1">cv_results</span><span class="s3">[</span><span class="s6">&quot;indices&quot;</span><span class="s3">][</span><span class="s6">&quot;test&quot;</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">train_indices</span><span class="s3">) == </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">n_splits</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">test_indices</span><span class="s3">) == </span><span class="s1">cv</span><span class="s3">.</span><span class="s1">n_splits</span>

    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">size </span><span class="s2">for </span><span class="s1">indices </span><span class="s2">in </span><span class="s1">train_indices</span><span class="s3">], </span><span class="s4">100</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">size </span><span class="s2">for </span><span class="s1">indices </span><span class="s2">in </span><span class="s1">test_indices</span><span class="s3">], </span><span class="s4">50</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">split_idx</span><span class="s3">, (</span><span class="s1">expected_train_idx</span><span class="s3">, </span><span class="s1">expected_test_idx</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)):</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">train_indices</span><span class="s3">[</span><span class="s1">split_idx</span><span class="s3">], </span><span class="s1">expected_train_idx</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">test_indices</span><span class="s3">[</span><span class="s1">split_idx</span><span class="s3">], </span><span class="s1">expected_test_idx</span><span class="s3">)</span>


<span class="s5"># Tests for metadata routing in cross_val*</span>
<span class="s5"># ========================================</span>


<span class="s5"># TODO(1.6): remove this test in 1.6</span>
<span class="s2">def </span><span class="s1">test_cross_validate_fit_param_deprecation</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that we warn about deprecating `fit_params`.&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;`fit_params` is deprecated&quot;</span><span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">=</span><span class="s1">ConsumingClassifier</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={})</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
        <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;`params` and `fit_params` cannot both be provided&quot;</span>
    <span class="s3">):</span>
        <span class="s1">cross_validate</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">=</span><span class="s1">ConsumingClassifier</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">, </span><span class="s1">fit_params</span><span class="s3">={}, </span><span class="s1">params</span><span class="s3">={}</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s6">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;cv_method&quot;</span><span class="s3">, [</span><span class="s1">cross_validate</span><span class="s3">, </span><span class="s1">cross_val_score</span><span class="s3">, </span><span class="s1">cross_val_predict</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_groups_with_routing_validation</span><span class="s3">(</span><span class="s1">cv_method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise an error if `groups` are passed to the cv method instead 
    of `params` when metadata routing is enabled. 
    &quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;`groups` can only be passed if&quot;</span><span class="s3">):</span>
        <span class="s1">cv_method</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">=</span><span class="s1">ConsumingClassifier</span><span class="s3">(),</span>
            <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">,</span>
            <span class="s1">groups</span><span class="s3">=[],</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s6">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;cv_method&quot;</span><span class="s3">, [</span><span class="s1">cross_validate</span><span class="s3">, </span><span class="s1">cross_val_score</span><span class="s3">, </span><span class="s1">cross_val_predict</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_passed_unrequested_metadata</span><span class="s3">(</span><span class="s1">cv_method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise an error when passing metadata that is not 
    requested.&quot;&quot;&quot;</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s6">&quot;but are not explicitly set as requested or not requested&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">cv_method</span><span class="s3">(</span>
            <span class="s1">estimator</span><span class="s3">=</span><span class="s1">ConsumingClassifier</span><span class="s3">(),</span>
            <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
            <span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">,</span>
            <span class="s1">params</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">=[]),</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s6">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;cv_method&quot;</span><span class="s3">, [</span><span class="s1">cross_validate</span><span class="s3">, </span><span class="s1">cross_val_score</span><span class="s3">, </span><span class="s1">cross_val_predict</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cross_validate_routing</span><span class="s3">(</span><span class="s1">cv_method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that the respective cv method is properly dispatching the metadata 
    to the consumer.&quot;&quot;&quot;</span>
    <span class="s1">scorer_registry </span><span class="s3">= </span><span class="s1">_Registry</span><span class="s3">()</span>
    <span class="s1">scorer </span><span class="s3">= </span><span class="s1">ConsumingScorer</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">scorer_registry</span><span class="s3">).</span><span class="s1">set_score_request</span><span class="s3">(</span>
        <span class="s1">sample_weight</span><span class="s3">=</span><span class="s6">&quot;score_weights&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s6">&quot;score_metadata&quot;</span>
    <span class="s3">)</span>
    <span class="s1">splitter_registry </span><span class="s3">= </span><span class="s1">_Registry</span><span class="s3">()</span>
    <span class="s1">splitter </span><span class="s3">= </span><span class="s1">ConsumingSplitter</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">splitter_registry</span><span class="s3">).</span><span class="s1">set_split_request</span><span class="s3">(</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s6">&quot;split_groups&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s6">&quot;split_metadata&quot;</span>
    <span class="s3">)</span>
    <span class="s1">estimator_registry </span><span class="s3">= </span><span class="s1">_Registry</span><span class="s3">()</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">ConsumingClassifier</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">estimator_registry</span><span class="s3">).</span><span class="s1">set_fit_request</span><span class="s3">(</span>
        <span class="s1">sample_weight</span><span class="s3">=</span><span class="s6">&quot;fit_sample_weight&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s6">&quot;fit_metadata&quot;</span>
    <span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">score_weights </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">score_metadata </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">split_groups </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">split_metadata </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">fit_sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">fit_metadata </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>

    <span class="s1">extra_params </span><span class="s3">= {</span>
        <span class="s1">cross_validate</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">my_scorer</span><span class="s3">=</span><span class="s1">scorer</span><span class="s3">, </span><span class="s1">accuracy</span><span class="s3">=</span><span class="s6">&quot;accuracy&quot;</span><span class="s3">)),</span>
        <span class="s5"># cross_val_score doesn't support multiple scorers</span>
        <span class="s1">cross_val_score</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">scoring</span><span class="s3">=</span><span class="s1">scorer</span><span class="s3">),</span>
        <span class="s5"># cross_val_predict doesn't need a scorer</span>
        <span class="s1">cross_val_predict</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">(),</span>
    <span class="s3">}</span>

    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">split_groups</span><span class="s3">=</span><span class="s1">split_groups</span><span class="s3">,</span>
        <span class="s1">split_metadata</span><span class="s3">=</span><span class="s1">split_metadata</span><span class="s3">,</span>
        <span class="s1">fit_sample_weight</span><span class="s3">=</span><span class="s1">fit_sample_weight</span><span class="s3">,</span>
        <span class="s1">fit_metadata</span><span class="s3">=</span><span class="s1">fit_metadata</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">cv_method </span><span class="s2">is not </span><span class="s1">cross_val_predict</span><span class="s3">:</span>
        <span class="s1">params</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span>
            <span class="s1">score_weights</span><span class="s3">=</span><span class="s1">score_weights</span><span class="s3">,</span>
            <span class="s1">score_metadata</span><span class="s3">=</span><span class="s1">score_metadata</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s1">cv_method</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">,</span>
        <span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">splitter</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">extra_params</span><span class="s3">[</span><span class="s1">cv_method</span><span class="s3">],</span>
        <span class="s1">params</span><span class="s3">=</span><span class="s1">params</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">cv_method </span><span class="s2">is not </span><span class="s1">cross_val_predict</span><span class="s3">:</span>
        <span class="s5"># cross_val_predict doesn't need a scorer</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">scorer_registry</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">_scorer </span><span class="s2">in </span><span class="s1">scorer_registry</span><span class="s3">:</span>
        <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
            <span class="s1">obj</span><span class="s3">=</span><span class="s1">_scorer</span><span class="s3">,</span>
            <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;score&quot;</span><span class="s3">,</span>
            <span class="s1">split_params</span><span class="s3">=(</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">, </span><span class="s6">&quot;metadata&quot;</span><span class="s3">),</span>
            <span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">score_weights</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">=</span><span class="s1">score_metadata</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">splitter_registry</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">_splitter </span><span class="s2">in </span><span class="s1">splitter_registry</span><span class="s3">:</span>
        <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
            <span class="s1">obj</span><span class="s3">=</span><span class="s1">_splitter</span><span class="s3">,</span>
            <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;split&quot;</span><span class="s3">,</span>
            <span class="s1">groups</span><span class="s3">=</span><span class="s1">split_groups</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">=</span><span class="s1">split_metadata</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">estimator_registry</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">_estimator </span><span class="s2">in </span><span class="s1">estimator_registry</span><span class="s3">:</span>
        <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
            <span class="s1">obj</span><span class="s3">=</span><span class="s1">_estimator</span><span class="s3">,</span>
            <span class="s1">method</span><span class="s3">=</span><span class="s6">&quot;fit&quot;</span><span class="s3">,</span>
            <span class="s1">split_params</span><span class="s3">=(</span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">, </span><span class="s6">&quot;metadata&quot;</span><span class="s3">),</span>
            <span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">fit_sample_weight</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">=</span><span class="s1">fit_metadata</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s5"># End of metadata routing tests</span>
<span class="s5"># =============================</span>
</pre>
</body>
</html>