<html>
<head>
<title>test_integrate.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_integrate.py</font>
</center></td></tr></table>
<pre><span class="s0"># Authors: Nils Wagner, Ed Schofield, Pauli Virtanen, John Travers</span>
<span class="s2">&quot;&quot;&quot; 
Tests for numerical integration. 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy </span><span class="s3">import </span><span class="s4">(</span><span class="s1">arange</span><span class="s4">, </span><span class="s1">zeros</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, </span><span class="s1">dot</span><span class="s4">, </span><span class="s1">sqrt</span><span class="s4">, </span><span class="s1">cos</span><span class="s4">, </span><span class="s1">sin</span><span class="s4">, </span><span class="s1">eye</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">, </span><span class="s1">exp</span><span class="s4">,</span>
                   <span class="s1">allclose</span><span class="s4">)</span>

<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">testing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">assert_</span><span class="s4">, </span><span class="s1">assert_array_almost_equal</span><span class="s4">,</span>
    <span class="s1">assert_allclose</span><span class="s4">, </span><span class="s1">assert_array_equal</span><span class="s4">, </span><span class="s1">assert_equal</span><span class="s4">, </span><span class="s1">assert_warns</span><span class="s4">)</span>
<span class="s3">from </span><span class="s1">pytest </span><span class="s3">import </span><span class="s1">raises </span><span class="s3">as </span><span class="s1">assert_raises</span>
<span class="s3">from </span><span class="s1">scipy</span><span class="s4">.</span><span class="s1">integrate </span><span class="s3">import </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">ode</span><span class="s4">, </span><span class="s1">complex_ode</span>

<span class="s0">#------------------------------------------------------------------------------</span>
<span class="s0"># Test ODE integrators</span>
<span class="s0">#------------------------------------------------------------------------------</span>


<span class="s3">class </span><span class="s1">TestOdeint</span><span class="s4">:</span>
    <span class="s0"># Check integrate.odeint</span>

    <span class="s3">def </span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">problem</span><span class="s4">):</span>
        <span class="s1">t </span><span class="s4">= </span><span class="s1">arange</span><span class="s4">(</span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stop_t</span><span class="s4">, </span><span class="s5">0.05</span><span class="s4">)</span>

        <span class="s0"># Basic case</span>
        <span class="s1">z</span><span class="s4">, </span><span class="s1">infodict </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">f</span><span class="s4">, </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">))</span>

        <span class="s0"># Use tfirst=True</span>
        <span class="s1">z</span><span class="s4">, </span><span class="s1">infodict </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">f</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">), </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">,</span>
                             <span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">tfirst</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">))</span>

        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
            <span class="s0"># Use Dfun</span>
            <span class="s1">z</span><span class="s4">, </span><span class="s1">infodict </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">f</span><span class="s4">, </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">Dfun</span><span class="s4">=</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">jac</span><span class="s4">,</span>
                                 <span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s1">assert_</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">))</span>

            <span class="s0"># Use Dfun and tfirst=True</span>
            <span class="s1">z</span><span class="s4">, </span><span class="s1">infodict </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">f</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">), </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">,</span>
                                 <span class="s1">Dfun</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">jac</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">),</span>
                                 <span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">tfirst</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s1">assert_</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_odeint</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">cmplx</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestODEClass</span><span class="s4">:</span>

    <span class="s1">ode_class </span><span class="s4">= </span><span class="s3">None   </span><span class="s0"># Set in subclass.</span>

    <span class="s3">def </span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">problem</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">, </span><span class="s1">method</span><span class="s4">=</span><span class="s6">'adams'</span><span class="s4">):</span>

        <span class="s0"># ode has callback arguments in different order than odeint</span>
        <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">z</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">f</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">)</span>
        <span class="s1">jac </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
            <span class="s3">def </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">z</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">jac</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">)</span>

        <span class="s1">integrator_params </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">lband </span><span class="s3">is not None or </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">uband </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">integrator_params</span><span class="s4">[</span><span class="s6">'uband'</span><span class="s4">] = </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">uband</span>
            <span class="s1">integrator_params</span><span class="s4">[</span><span class="s6">'lband'</span><span class="s4">] = </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">lband</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ode_class</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">jac</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">,</span>
                          <span class="s1">atol</span><span class="s4">=</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">atol</span><span class="s4">/</span><span class="s5">10</span><span class="s4">,</span>
                          <span class="s1">rtol</span><span class="s4">=</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">rtol</span><span class="s4">/</span><span class="s5">10</span><span class="s4">,</span>
                          <span class="s1">method</span><span class="s4">=</span><span class="s1">method</span><span class="s4">,</span>
                          <span class="s4">**</span><span class="s1">integrator_params</span><span class="s4">)</span>

        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">=</span><span class="s5">0.0</span><span class="s4">)</span>
        <span class="s1">z </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stop_t</span><span class="s4">)</span>

        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">z</span><span class="s4">, </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">y</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ig</span><span class="s4">.</span><span class="s1">successful</span><span class="s4">(), (</span><span class="s1">problem</span><span class="s4">, </span><span class="s1">method</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ig</span><span class="s4">.</span><span class="s1">get_return_code</span><span class="s4">() &gt; </span><span class="s5">0</span><span class="s4">, (</span><span class="s1">problem</span><span class="s4">, </span><span class="s1">method</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">array</span><span class="s4">([</span><span class="s1">z</span><span class="s4">]), </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stop_t</span><span class="s4">), (</span><span class="s1">problem</span><span class="s4">, </span><span class="s1">method</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestOde</span><span class="s4">(</span><span class="s1">TestODEClass</span><span class="s4">):</span>

    <span class="s1">ode_class </span><span class="s4">= </span><span class="s1">ode</span>

    <span class="s3">def </span><span class="s1">test_vode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the vode solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">cmplx</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if not </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'adams'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'bdf'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_zvode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the zvode solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'zvode'</span><span class="s4">, </span><span class="s6">'adams'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'zvode'</span><span class="s4">, </span><span class="s6">'bdf'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_lsoda</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the lsoda solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">cmplx</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'lsoda'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dopri5</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the dopri5 solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">cmplx</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'dopri5'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dop853</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the dop853 solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">cmplx</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_concurrent_fail</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">sol </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'zvode'</span><span class="s4">, </span><span class="s6">'lsoda'</span><span class="s4">):</span>
            <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s5">1.0</span>

            <span class="s1">r </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
            <span class="s1">r</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

            <span class="s1">r2 </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
            <span class="s1">r2</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

            <span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
            <span class="s1">r2</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>

            <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">RuntimeError</span><span class="s4">, </span><span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">, </span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_concurrent_ok</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s5">1.0</span>

        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">3</span><span class="s4">):</span>
            <span class="s3">for </span><span class="s1">sol </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'zvode'</span><span class="s4">, </span><span class="s6">'lsoda'</span><span class="s4">, </span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
                <span class="s1">r </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

                <span class="s1">r2 </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

                <span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>

                <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">sol </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
                <span class="s1">r </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

                <span class="s1">r2 </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>

                <span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>
                <span class="s1">r2</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">t </span><span class="s4">+ </span><span class="s5">0.1</span><span class="s4">)</span>

                <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">r</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s5">0.3</span><span class="s4">)</span>
                <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">r2</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, </span><span class="s5">0.2</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestComplexOde</span><span class="s4">(</span><span class="s1">TestODEClass</span><span class="s4">):</span>

    <span class="s1">ode_class </span><span class="s4">= </span><span class="s1">complex_ode</span>

    <span class="s3">def </span><span class="s1">test_vode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the vode solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'adams'</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'vode'</span><span class="s4">, </span><span class="s6">'bdf'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_lsoda</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the lsoda solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'lsoda'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dopri5</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the dopri5 solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'dopri5'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dop853</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Check the dop853 solver</span>
        <span class="s3">for </span><span class="s1">problem_cls </span><span class="s3">in </span><span class="s1">PROBLEMS</span><span class="s4">:</span>
            <span class="s1">problem </span><span class="s4">= </span><span class="s1">problem_cls</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">problem</span><span class="s4">.</span><span class="s1">stiff</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'jac'</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_do_problem</span><span class="s4">(</span><span class="s1">problem</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestSolout</span><span class="s4">:</span>
    <span class="s0"># Check integrate.ode correctly handles solout for dopri5 and dop853</span>
    <span class="s3">def </span><span class="s1">_run_solout_test</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">):</span>
        <span class="s0"># Check correct usage of solout</span>
        <span class="s1">ts </span><span class="s4">= []</span>
        <span class="s1">ys </span><span class="s4">= []</span>
        <span class="s1">t0 </span><span class="s4">= </span><span class="s5">0.0</span>
        <span class="s1">tend </span><span class="s4">= </span><span class="s5">10.0</span>
        <span class="s1">y0 </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">]</span>

        <span class="s3">def </span><span class="s1">solout</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">ts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)</span>
            <span class="s1">ys</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">())</span>

        <span class="s3">def </span><span class="s1">rhs</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s4">[</span><span class="s1">y</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] + </span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]**</span><span class="s5">2</span><span class="s4">]</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">rhs</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_solout</span><span class="s4">(</span><span class="s1">solout</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">ret </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">tend</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y0</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">ret</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">tend</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_solout</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">integrator </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_run_solout_test</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_run_solout_after_initial_test</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">):</span>
        <span class="s0"># Check if solout works even if it is set after the initial value.</span>
        <span class="s1">ts </span><span class="s4">= []</span>
        <span class="s1">ys </span><span class="s4">= []</span>
        <span class="s1">t0 </span><span class="s4">= </span><span class="s5">0.0</span>
        <span class="s1">tend </span><span class="s4">= </span><span class="s5">10.0</span>
        <span class="s1">y0 </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">]</span>

        <span class="s3">def </span><span class="s1">solout</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">ts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)</span>
            <span class="s1">ys</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">())</span>

        <span class="s3">def </span><span class="s1">rhs</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s4">[</span><span class="s1">y</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] + </span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]**</span><span class="s5">2</span><span class="s4">]</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">rhs</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_solout</span><span class="s4">(</span><span class="s1">solout</span><span class="s4">)</span>
        <span class="s1">ret </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">tend</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y0</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">ret</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">tend</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_solout_after_initial</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">integrator </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_run_solout_after_initial_test</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_run_solout_break_test</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">):</span>
        <span class="s0"># Check correct usage of stopping via solout</span>
        <span class="s1">ts </span><span class="s4">= []</span>
        <span class="s1">ys </span><span class="s4">= []</span>
        <span class="s1">t0 </span><span class="s4">= </span><span class="s5">0.0</span>
        <span class="s1">tend </span><span class="s4">= </span><span class="s5">10.0</span>
        <span class="s1">y0 </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">]</span>

        <span class="s3">def </span><span class="s1">solout</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">ts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)</span>
            <span class="s1">ys</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">())</span>
            <span class="s3">if </span><span class="s1">t </span><span class="s4">&gt; </span><span class="s1">tend</span><span class="s4">/</span><span class="s5">2.0</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s4">-</span><span class="s5">1</span>

        <span class="s3">def </span><span class="s1">rhs</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s4">[</span><span class="s1">y</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] + </span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]**</span><span class="s5">2</span><span class="s4">]</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">rhs</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_solout</span><span class="s4">(</span><span class="s1">solout</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">ret </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">tend</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y0</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">ret</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] &gt; </span><span class="s1">tend</span><span class="s4">/</span><span class="s5">2.0</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] &lt; </span><span class="s1">tend</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_solout_break</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">integrator </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_run_solout_break_test</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestComplexSolout</span><span class="s4">:</span>
    <span class="s0"># Check integrate.ode correctly handles solout for dopri5 and dop853</span>
    <span class="s3">def </span><span class="s1">_run_solout_test</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">):</span>
        <span class="s0"># Check correct usage of solout</span>
        <span class="s1">ts </span><span class="s4">= []</span>
        <span class="s1">ys </span><span class="s4">= []</span>
        <span class="s1">t0 </span><span class="s4">= </span><span class="s5">0.0</span>
        <span class="s1">tend </span><span class="s4">= </span><span class="s5">20.0</span>
        <span class="s1">y0 </span><span class="s4">= [</span><span class="s5">0.0</span><span class="s4">]</span>

        <span class="s3">def </span><span class="s1">solout</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">ts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)</span>
            <span class="s1">ys</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">())</span>

        <span class="s3">def </span><span class="s1">rhs</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s4">[</span><span class="s5">1.0</span><span class="s4">/(</span><span class="s1">t </span><span class="s4">- </span><span class="s5">10.0 </span><span class="s4">- </span><span class="s5">1j</span><span class="s4">)]</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">complex_ode</span><span class="s4">(</span><span class="s1">rhs</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_solout</span><span class="s4">(</span><span class="s1">solout</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">ret </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">tend</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y0</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">ret</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">tend</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_solout</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">integrator </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_run_solout_test</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_run_solout_break_test</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">integrator</span><span class="s4">):</span>
        <span class="s0"># Check correct usage of stopping via solout</span>
        <span class="s1">ts </span><span class="s4">= []</span>
        <span class="s1">ys </span><span class="s4">= []</span>
        <span class="s1">t0 </span><span class="s4">= </span><span class="s5">0.0</span>
        <span class="s1">tend </span><span class="s4">= </span><span class="s5">20.0</span>
        <span class="s1">y0 </span><span class="s4">= [</span><span class="s5">0.0</span><span class="s4">]</span>

        <span class="s3">def </span><span class="s1">solout</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s1">ts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)</span>
            <span class="s1">ys</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">())</span>
            <span class="s3">if </span><span class="s1">t </span><span class="s4">&gt; </span><span class="s1">tend</span><span class="s4">/</span><span class="s5">2.0</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s4">-</span><span class="s5">1</span>

        <span class="s3">def </span><span class="s1">rhs</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s4">[</span><span class="s5">1.0</span><span class="s4">/(</span><span class="s1">t </span><span class="s4">- </span><span class="s5">10.0 </span><span class="s4">- </span><span class="s5">1j</span><span class="s4">)]</span>

        <span class="s1">ig </span><span class="s4">= </span><span class="s1">complex_ode</span><span class="s4">(</span><span class="s1">rhs</span><span class="s4">).</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_solout</span><span class="s4">(</span><span class="s1">solout</span><span class="s4">)</span>
        <span class="s1">ig</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">ret </span><span class="s4">= </span><span class="s1">ig</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">tend</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y0</span><span class="s4">)</span>
        <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ys</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">], </span><span class="s1">ret</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">t0</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] &gt; </span><span class="s1">tend</span><span class="s4">/</span><span class="s5">2.0</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ts</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] &lt; </span><span class="s1">tend</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_solout_break</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">integrator </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'dopri5'</span><span class="s4">, </span><span class="s6">'dop853'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_run_solout_break_test</span><span class="s4">(</span><span class="s1">integrator</span><span class="s4">)</span>


<span class="s0">#------------------------------------------------------------------------------</span>
<span class="s0"># Test problems</span>
<span class="s0">#------------------------------------------------------------------------------</span>


<span class="s3">class </span><span class="s1">ODE</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot; 
    ODE problem 
    &quot;&quot;&quot;</span>
    <span class="s1">stiff </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">cmplx </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">stop_t </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">z0 </span><span class="s4">= []</span>

    <span class="s1">lband </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">uband </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s1">atol </span><span class="s4">= </span><span class="s5">1e-6</span>
    <span class="s1">rtol </span><span class="s4">= </span><span class="s5">1e-5</span>


<span class="s3">class </span><span class="s1">SimpleOscillator</span><span class="s4">(</span><span class="s1">ODE</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot; 
    Free vibration of a simple oscillator:: 
        m \ddot{u} + k u = 0, u(0) = u_0 \dot{u}(0) \dot{u}_0 
    Solution:: 
        u(t) = u_0*cos(sqrt(k/m)*t)+\dot{u}_0*sin(sqrt(k/m)*t)/sqrt(k/m) 
    &quot;&quot;&quot;</span>
    <span class="s1">stop_t </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">+ </span><span class="s5">0.09</span>
    <span class="s1">z0 </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">], </span><span class="s1">float</span><span class="s4">)</span>

    <span class="s1">k </span><span class="s4">= </span><span class="s5">4.0</span>
    <span class="s1">m </span><span class="s4">= </span><span class="s5">1.0</span>

    <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s1">tmp </span><span class="s4">= </span><span class="s1">zeros</span><span class="s4">((</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">), </span><span class="s1">float</span><span class="s4">)</span>
        <span class="s1">tmp</span><span class="s4">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">] = </span><span class="s5">1.0</span>
        <span class="s1">tmp</span><span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">] = -</span><span class="s1">self</span><span class="s4">.</span><span class="s1">k </span><span class="s4">/ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">m</span>
        <span class="s3">return </span><span class="s1">dot</span><span class="s4">(</span><span class="s1">tmp</span><span class="s4">, </span><span class="s1">z</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">verify</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s1">omega </span><span class="s4">= </span><span class="s1">sqrt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">k </span><span class="s4">/ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">m</span><span class="s4">)</span>
        <span class="s1">u </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]*</span><span class="s1">cos</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">*</span><span class="s1">t</span><span class="s4">) + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]*</span><span class="s1">sin</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">*</span><span class="s1">t</span><span class="s4">)/</span><span class="s1">omega</span>
        <span class="s3">return </span><span class="s1">allclose</span><span class="s4">(</span><span class="s1">u</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">], </span><span class="s1">atol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">atol</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rtol</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">ComplexExp</span><span class="s4">(</span><span class="s1">ODE</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;The equation :lm:`\dot u = i u`&quot;&quot;&quot;</span>
    <span class="s1">stop_t </span><span class="s4">= </span><span class="s5">1.23</span><span class="s4">*</span><span class="s1">pi</span>
    <span class="s1">z0 </span><span class="s4">= </span><span class="s1">exp</span><span class="s4">([</span><span class="s5">1j</span><span class="s4">, </span><span class="s5">2j</span><span class="s4">, </span><span class="s5">3j</span><span class="s4">, </span><span class="s5">4j</span><span class="s4">, </span><span class="s5">5j</span><span class="s4">])</span>
    <span class="s1">cmplx </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">1j</span><span class="s4">*</span><span class="s1">z</span>

    <span class="s3">def </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">1j</span><span class="s4">*</span><span class="s1">eye</span><span class="s4">(</span><span class="s5">5</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">verify</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s1">u </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0 </span><span class="s4">* </span><span class="s1">exp</span><span class="s4">(</span><span class="s5">1j</span><span class="s4">*</span><span class="s1">t</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">allclose</span><span class="s4">(</span><span class="s1">u</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">atol</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rtol</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">Pi</span><span class="s4">(</span><span class="s1">ODE</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Integrate 1/(t + 1j) from t=-10 to t=10&quot;&quot;&quot;</span>
    <span class="s1">stop_t </span><span class="s4">= </span><span class="s5">20</span>
    <span class="s1">z0 </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">cmplx </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.</span><span class="s4">/(</span><span class="s1">t </span><span class="s4">- </span><span class="s5">10 </span><span class="s4">+ </span><span class="s5">1j</span><span class="s4">)])</span>

    <span class="s3">def </span><span class="s1">verify</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s1">u </span><span class="s4">= -</span><span class="s5">2j </span><span class="s4">* </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arctan</span><span class="s4">(</span><span class="s5">10</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">allclose</span><span class="s4">(</span><span class="s1">u</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">, :], </span><span class="s1">atol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">atol</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rtol</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">CoupledDecay</span><span class="s4">(</span><span class="s1">ODE</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot; 
    3 coupled decays suited for banded treatment 
    (banded mode makes it necessary when N&gt;&gt;3) 
    &quot;&quot;&quot;</span>

    <span class="s1">stiff </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s1">stop_t </span><span class="s4">= </span><span class="s5">0.5</span>
    <span class="s1">z0 </span><span class="s4">= [</span><span class="s5">5.0</span><span class="s4">, </span><span class="s5">7.0</span><span class="s4">, </span><span class="s5">13.0</span><span class="s4">]</span>
    <span class="s1">lband </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">uband </span><span class="s4">= </span><span class="s5">0</span>

    <span class="s1">lmbd </span><span class="s4">= [</span><span class="s5">0.17</span><span class="s4">, </span><span class="s5">0.23</span><span class="s4">, </span><span class="s5">0.29</span><span class="s4">]  </span><span class="s0"># fictitious decay constants</span>

    <span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s1">lmbd </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lmbd</span>
        <span class="s3">return </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]*</span><span class="s1">z</span><span class="s4">[</span><span class="s5">0</span><span class="s4">],</span>
                         <span class="s4">-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]*</span><span class="s1">z</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] + </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]*</span><span class="s1">z</span><span class="s4">[</span><span class="s5">0</span><span class="s4">],</span>
                         <span class="s4">-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">2</span><span class="s4">]*</span><span class="s1">z</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] + </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]*</span><span class="s1">z</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]])</span>

    <span class="s3">def </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">z</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s0"># The full Jacobian is</span>
        <span class="s0">#</span>
        <span class="s0">#    [-lmbd[0]      0         0   ]</span>
        <span class="s0">#    [ lmbd[0]  -lmbd[1]      0   ]</span>
        <span class="s0">#    [    0      lmbd[1]  -lmbd[2]]</span>
        <span class="s0">#</span>
        <span class="s0"># The lower and upper bandwidths are lband=1 and uband=0, resp.</span>
        <span class="s0"># The representation of this array in packed format is</span>
        <span class="s0">#</span>
        <span class="s0">#    [-lmbd[0]  -lmbd[1]  -lmbd[2]]</span>
        <span class="s0">#    [ lmbd[0]   lmbd[1]      0   ]</span>

        <span class="s1">lmbd </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lmbd</span>
        <span class="s1">j </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lband </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">uband </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">), </span><span class="s1">order</span><span class="s4">=</span><span class="s6">'F'</span><span class="s4">)</span>

        <span class="s3">def </span><span class="s1">set_j</span><span class="s4">(</span><span class="s1">ri</span><span class="s4">, </span><span class="s1">ci</span><span class="s4">, </span><span class="s1">val</span><span class="s4">):</span>
            <span class="s1">j</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">uband </span><span class="s4">+ </span><span class="s1">ri </span><span class="s4">- </span><span class="s1">ci</span><span class="s4">, </span><span class="s1">ci</span><span class="s4">] = </span><span class="s1">val</span>
        <span class="s1">set_j</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, -</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">set_j</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">set_j</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, -</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">set_j</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">set_j</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, -</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">2</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">j</span>

    <span class="s3">def </span><span class="s1">verify</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s0"># Formulae derived by hand</span>
        <span class="s1">lmbd </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lmbd</span><span class="s4">)</span>
        <span class="s1">d10 </span><span class="s4">= </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] - </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">d21 </span><span class="s4">= </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] - </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
        <span class="s1">d20 </span><span class="s4">= </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] - </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">e0 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] * </span><span class="s1">t</span><span class="s4">)</span>
        <span class="s1">e1 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] * </span><span class="s1">t</span><span class="s4">)</span>
        <span class="s1">e2 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(-</span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] * </span><span class="s1">t</span><span class="s4">)</span>
        <span class="s1">u </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] * </span><span class="s1">e0</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] * </span><span class="s1">e1 </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] * </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] / </span><span class="s1">d10 </span><span class="s4">* (</span><span class="s1">e0 </span><span class="s4">- </span><span class="s1">e1</span><span class="s4">),</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">2</span><span class="s4">] * </span><span class="s1">e2 </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] * </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] / </span><span class="s1">d21 </span><span class="s4">* (</span><span class="s1">e1 </span><span class="s4">- </span><span class="s1">e2</span><span class="s4">) +</span>
            <span class="s1">lmbd</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] * </span><span class="s1">lmbd</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] * </span><span class="s1">self</span><span class="s4">.</span><span class="s1">z0</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] / </span><span class="s1">d10 </span><span class="s4">*</span>
            <span class="s4">(</span><span class="s5">1 </span><span class="s4">/ </span><span class="s1">d20 </span><span class="s4">* (</span><span class="s1">e0 </span><span class="s4">- </span><span class="s1">e2</span><span class="s4">) - </span><span class="s5">1 </span><span class="s4">/ </span><span class="s1">d21 </span><span class="s4">* (</span><span class="s1">e1 </span><span class="s4">- </span><span class="s1">e2</span><span class="s4">)))).</span><span class="s1">transpose</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">allclose</span><span class="s4">(</span><span class="s1">u</span><span class="s4">, </span><span class="s1">zs</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">atol</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rtol</span><span class="s4">)</span>


<span class="s1">PROBLEMS </span><span class="s4">= [</span><span class="s1">SimpleOscillator</span><span class="s4">, </span><span class="s1">ComplexExp</span><span class="s4">, </span><span class="s1">Pi</span><span class="s4">, </span><span class="s1">CoupledDecay</span><span class="s4">]</span>

<span class="s0">#------------------------------------------------------------------------------</span>


<span class="s3">def </span><span class="s1">f</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">):</span>
    <span class="s1">dxdt </span><span class="s4">= [</span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]]</span>
    <span class="s3">return </span><span class="s1">dxdt</span>


<span class="s3">def </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">):</span>
    <span class="s1">j </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">],</span>
               <span class="s4">[-</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">]])</span>
    <span class="s3">return </span><span class="s1">j</span>


<span class="s3">def </span><span class="s1">f1</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">):</span>
    <span class="s1">dxdt </span><span class="s4">= [</span><span class="s1">omega</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">omega</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]]</span>
    <span class="s3">return </span><span class="s1">dxdt</span>


<span class="s3">def </span><span class="s1">jac1</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">):</span>
    <span class="s1">j </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">],</span>
               <span class="s4">[-</span><span class="s1">omega</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">]])</span>
    <span class="s3">return </span><span class="s1">j</span>


<span class="s3">def </span><span class="s1">f2</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega1</span><span class="s4">, </span><span class="s1">omega2</span><span class="s4">):</span>
    <span class="s1">dxdt </span><span class="s4">= [</span><span class="s1">omega1</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">omega2</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]]</span>
    <span class="s3">return </span><span class="s1">dxdt</span>


<span class="s3">def </span><span class="s1">jac2</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega1</span><span class="s4">, </span><span class="s1">omega2</span><span class="s4">):</span>
    <span class="s1">j </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">omega1</span><span class="s4">],</span>
               <span class="s4">[-</span><span class="s1">omega2</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">]])</span>
    <span class="s3">return </span><span class="s1">j</span>


<span class="s3">def </span><span class="s1">fv</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">):</span>
    <span class="s1">dxdt </span><span class="s4">= [</span><span class="s1">omega</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], -</span><span class="s1">omega</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]]</span>
    <span class="s3">return </span><span class="s1">dxdt</span>


<span class="s3">def </span><span class="s1">jacv</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">):</span>
    <span class="s1">j </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([[</span><span class="s5">0.0</span><span class="s4">, </span><span class="s1">omega</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]],</span>
               <span class="s4">[-</span><span class="s1">omega</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s5">0.0</span><span class="s4">]])</span>
    <span class="s3">return </span><span class="s1">j</span>


<span class="s3">class </span><span class="s1">ODECheckParameterUse</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Call an ode-class solver with several cases of parameter use.&quot;&quot;&quot;</span>

    <span class="s0"># solver_name must be set before tests can be run with this class.</span>

    <span class="s0"># Set these in subclasses.</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">''</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s3">def </span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">f</span><span class="s4">, </span><span class="s1">jac</span><span class="s4">):</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">ode</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">jac</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_uses_jac</span><span class="s4">:</span>
            <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_name</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-9</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-7</span><span class="s4">,</span>
                                  <span class="s1">with_jacobian</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_uses_jac</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># XXX Shouldn't set_integrator *always* accept the keyword arg</span>
            <span class="s0"># 'with_jacobian', and perhaps raise an exception if it is set</span>
            <span class="s0"># to True if the solver can't actually use it?</span>
            <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_name</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-9</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-7</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">solver</span>

    <span class="s3">def </span><span class="s1">_check_solver</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">solver</span><span class="s4">):</span>
        <span class="s1">ic </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">]</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">ic</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">)</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">(</span><span class="s1">pi</span><span class="s4">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">solver</span><span class="s4">.</span><span class="s1">y</span><span class="s4">, [-</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_no_params</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">jac</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_solver</span><span class="s4">(</span><span class="s1">solver</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_one_scalar_param</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">f1</span><span class="s4">, </span><span class="s1">jac1</span><span class="s4">)</span>
        <span class="s1">omega </span><span class="s4">= </span><span class="s5">1.0</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_f_params</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_uses_jac</span><span class="s4">:</span>
            <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_jac_params</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_solver</span><span class="s4">(</span><span class="s1">solver</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_two_scalar_params</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">f2</span><span class="s4">, </span><span class="s1">jac2</span><span class="s4">)</span>
        <span class="s1">omega1 </span><span class="s4">= </span><span class="s5">1.0</span>
        <span class="s1">omega2 </span><span class="s4">= </span><span class="s5">1.0</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_f_params</span><span class="s4">(</span><span class="s1">omega1</span><span class="s4">, </span><span class="s1">omega2</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_uses_jac</span><span class="s4">:</span>
            <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_jac_params</span><span class="s4">(</span><span class="s1">omega1</span><span class="s4">, </span><span class="s1">omega2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_solver</span><span class="s4">(</span><span class="s1">solver</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vector_param</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">fv</span><span class="s4">, </span><span class="s1">jacv</span><span class="s4">)</span>
        <span class="s1">omega </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">]</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_f_params</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_uses_jac</span><span class="s4">:</span>
            <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_jac_params</span><span class="s4">(</span><span class="s1">omega</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_solver</span><span class="s4">(</span><span class="s1">solver</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_warns_on_failure</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Set nsteps small to ensure failure</span>
        <span class="s1">solver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_solver</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">jac</span><span class="s4">)</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_integrator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">solver_name</span><span class="s4">, </span><span class="s1">nsteps</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
        <span class="s1">ic </span><span class="s4">= [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">]</span>
        <span class="s1">solver</span><span class="s4">.</span><span class="s1">set_initial_value</span><span class="s4">(</span><span class="s1">ic</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">)</span>
        <span class="s1">assert_warns</span><span class="s4">(</span><span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">solver</span><span class="s4">.</span><span class="s1">integrate</span><span class="s4">, </span><span class="s1">pi</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestDOPRI5CheckParameterUse</span><span class="s4">(</span><span class="s1">ODECheckParameterUse</span><span class="s4">):</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">'dopri5'</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">False</span>


<span class="s3">class </span><span class="s1">TestDOP853CheckParameterUse</span><span class="s4">(</span><span class="s1">ODECheckParameterUse</span><span class="s4">):</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">'dop853'</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">False</span>


<span class="s3">class </span><span class="s1">TestVODECheckParameterUse</span><span class="s4">(</span><span class="s1">ODECheckParameterUse</span><span class="s4">):</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">'vode'</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">TestZVODECheckParameterUse</span><span class="s4">(</span><span class="s1">ODECheckParameterUse</span><span class="s4">):</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">'zvode'</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">TestLSODACheckParameterUse</span><span class="s4">(</span><span class="s1">ODECheckParameterUse</span><span class="s4">):</span>
    <span class="s1">solver_name </span><span class="s4">= </span><span class="s6">'lsoda'</span>
    <span class="s1">solver_uses_jac </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">def </span><span class="s1">test_odeint_trivial_time</span><span class="s4">():</span>
    <span class="s0"># Test that odeint succeeds when given a single time point</span>
    <span class="s0"># and full_output=True.  This is a regression test for gh-4282.</span>
    <span class="s1">y0 </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">t </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">y</span><span class="s4">, </span><span class="s1">info </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">: -</span><span class="s1">y</span><span class="s4">, </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s1">y0</span><span class="s4">]]))</span>


<span class="s3">def </span><span class="s1">test_odeint_banded_jacobian</span><span class="s4">():</span>
    <span class="s0"># Test the use of the `Dfun`, `ml` and `mu` options of odeint.</span>

    <span class="s3">def </span><span class="s1">func</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">c</span><span class="s4">.</span><span class="s1">dot</span><span class="s4">(</span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">c</span>

    <span class="s3">def </span><span class="s1">jac_transpose</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">c</span><span class="s4">.</span><span class="s1">T</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">order</span><span class="s4">=</span><span class="s6">'C'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">bjac_rows</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
        <span class="s1">jac </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span><span class="s1">np</span><span class="s4">.</span><span class="s1">r_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">diag</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
                            <span class="s1">np</span><span class="s4">.</span><span class="s1">diag</span><span class="s4">(</span><span class="s1">c</span><span class="s4">),</span>
                            <span class="s1">np</span><span class="s4">.</span><span class="s1">r_</span><span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">diag</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">), </span><span class="s5">0</span><span class="s4">],</span>
                            <span class="s1">np</span><span class="s4">.</span><span class="s1">r_</span><span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">diag</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">), </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]))</span>
        <span class="s3">return </span><span class="s1">jac</span>

    <span class="s3">def </span><span class="s1">bjac_cols</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">bjac_rows</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">).</span><span class="s1">T</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">order</span><span class="s4">=</span><span class="s6">'C'</span><span class="s4">)</span>

    <span class="s1">c </span><span class="s4">= </span><span class="s1">array</span><span class="s4">([[-</span><span class="s5">205</span><span class="s4">, </span><span class="s5">0.01</span><span class="s4">, </span><span class="s5">0.00</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">],</span>
               <span class="s4">[</span><span class="s5">0.1</span><span class="s4">, -</span><span class="s5">2.50</span><span class="s4">, </span><span class="s5">0.02</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">],</span>
               <span class="s4">[</span><span class="s5">1e-3</span><span class="s4">, </span><span class="s5">0.01</span><span class="s4">, -</span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">0.01</span><span class="s4">],</span>
               <span class="s4">[</span><span class="s5">0.00</span><span class="s4">, </span><span class="s5">0.00</span><span class="s4">, </span><span class="s5">0.1</span><span class="s4">, -</span><span class="s5">1.0</span><span class="s4">]])</span>

    <span class="s1">y0 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s5">4</span><span class="s4">)</span>
    <span class="s1">t </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">100</span><span class="s4">])</span>

    <span class="s0"># Use the full Jacobian.</span>
    <span class="s1">sol1</span><span class="s4">, </span><span class="s1">info1 </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">args</span><span class="s4">=(</span><span class="s1">c</span><span class="s4">,), </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                         <span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-13</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-11</span><span class="s4">, </span><span class="s1">mxstep</span><span class="s4">=</span><span class="s5">10000</span><span class="s4">,</span>
                         <span class="s1">Dfun</span><span class="s4">=</span><span class="s1">jac</span><span class="s4">)</span>

    <span class="s0"># Use the transposed full Jacobian, with col_deriv=True.</span>
    <span class="s1">sol2</span><span class="s4">, </span><span class="s1">info2 </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">args</span><span class="s4">=(</span><span class="s1">c</span><span class="s4">,), </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                         <span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-13</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-11</span><span class="s4">, </span><span class="s1">mxstep</span><span class="s4">=</span><span class="s5">10000</span><span class="s4">,</span>
                         <span class="s1">Dfun</span><span class="s4">=</span><span class="s1">jac_transpose</span><span class="s4">, </span><span class="s1">col_deriv</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s0"># Use the banded Jacobian.</span>
    <span class="s1">sol3</span><span class="s4">, </span><span class="s1">info3 </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">args</span><span class="s4">=(</span><span class="s1">c</span><span class="s4">,), </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                         <span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-13</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-11</span><span class="s4">, </span><span class="s1">mxstep</span><span class="s4">=</span><span class="s5">10000</span><span class="s4">,</span>
                         <span class="s1">Dfun</span><span class="s4">=</span><span class="s1">bjac_rows</span><span class="s4">, </span><span class="s1">ml</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">mu</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>

    <span class="s0"># Use the transposed banded Jacobian, with col_deriv=True.</span>
    <span class="s1">sol4</span><span class="s4">, </span><span class="s1">info4 </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">args</span><span class="s4">=(</span><span class="s1">c</span><span class="s4">,), </span><span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                         <span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-13</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-11</span><span class="s4">, </span><span class="s1">mxstep</span><span class="s4">=</span><span class="s5">10000</span><span class="s4">,</span>
                         <span class="s1">Dfun</span><span class="s4">=</span><span class="s1">bjac_cols</span><span class="s4">, </span><span class="s1">ml</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">mu</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">col_deriv</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">sol1</span><span class="s4">, </span><span class="s1">sol2</span><span class="s4">, </span><span class="s1">err_msg</span><span class="s4">=</span><span class="s6">&quot;sol1 != sol2&quot;</span><span class="s4">)</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">sol1</span><span class="s4">, </span><span class="s1">sol3</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-12</span><span class="s4">, </span><span class="s1">err_msg</span><span class="s4">=</span><span class="s6">&quot;sol1 != sol3&quot;</span><span class="s4">)</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">sol3</span><span class="s4">, </span><span class="s1">sol4</span><span class="s4">, </span><span class="s1">err_msg</span><span class="s4">=</span><span class="s6">&quot;sol3 != sol4&quot;</span><span class="s4">)</span>

    <span class="s0"># Verify that the number of jacobian evaluations was the same for the</span>
    <span class="s0"># calls of odeint with a full jacobian and with a banded jacobian. This is</span>
    <span class="s0"># a regression test--there was a bug in the handling of banded jacobians</span>
    <span class="s0"># that resulted in an incorrect jacobian matrix being passed to the LSODA</span>
    <span class="s0"># code.  That would cause errors or excessive jacobian evaluations.</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">info1</span><span class="s4">[</span><span class="s6">'nje'</span><span class="s4">], </span><span class="s1">info2</span><span class="s4">[</span><span class="s6">'nje'</span><span class="s4">])</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">info3</span><span class="s4">[</span><span class="s6">'nje'</span><span class="s4">], </span><span class="s1">info4</span><span class="s4">[</span><span class="s6">'nje'</span><span class="s4">])</span>

    <span class="s0"># Test the use of tfirst</span>
    <span class="s1">sol1ty</span><span class="s4">, </span><span class="s1">info1ty </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">c</span><span class="s4">: </span><span class="s1">func</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">), </span><span class="s1">y0</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">args</span><span class="s4">=(</span><span class="s1">c</span><span class="s4">,),</span>
                             <span class="s1">full_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-13</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-11</span><span class="s4">,</span>
                             <span class="s1">mxstep</span><span class="s4">=</span><span class="s5">10000</span><span class="s4">,</span>
                             <span class="s1">Dfun</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">t</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">c</span><span class="s4">: </span><span class="s1">jac</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">t</span><span class="s4">, </span><span class="s1">c</span><span class="s4">), </span><span class="s1">tfirst</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s0"># The code should execute the exact same sequence of floating point</span>
    <span class="s0"># calculations, so these should be exactly equal. We'll be safe and use</span>
    <span class="s0"># a small tolerance.</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">sol1</span><span class="s4">, </span><span class="s1">sol1ty</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-12</span><span class="s4">, </span><span class="s1">err_msg</span><span class="s4">=</span><span class="s6">&quot;sol1 != sol1ty&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_odeint_errors</span><span class="s4">():</span>
    <span class="s3">def </span><span class="s1">sys1d</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">-</span><span class="s5">100</span><span class="s4">*</span><span class="s1">x</span>

    <span class="s3">def </span><span class="s1">bad1</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">1.0</span><span class="s4">/</span><span class="s5">0</span>

    <span class="s3">def </span><span class="s1">bad2</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s6">&quot;foo&quot;</span>

    <span class="s3">def </span><span class="s1">bad_jac1</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">1.0</span><span class="s4">/</span><span class="s5">0</span>

    <span class="s3">def </span><span class="s1">bad_jac2</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[[</span><span class="s6">&quot;foo&quot;</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">sys2d</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[-</span><span class="s5">100</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], -</span><span class="s5">0.1</span><span class="s4">*</span><span class="s1">x</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">sys2d_bad_jac</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[[</span><span class="s5">1.0</span><span class="s4">/</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, -</span><span class="s5">0.1</span><span class="s4">]]</span>

    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ZeroDivisionError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">bad1</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">bad2</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ZeroDivisionError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys1d</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">Dfun</span><span class="s4">=</span><span class="s1">bad_jac1</span><span class="s4">)</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys1d</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">Dfun</span><span class="s4">=</span><span class="s1">bad_jac2</span><span class="s4">)</span>

    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ZeroDivisionError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys2d</span><span class="s4">, [</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
                  <span class="s1">Dfun</span><span class="s4">=</span><span class="s1">sys2d_bad_jac</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_odeint_bad_shapes</span><span class="s4">():</span>
    <span class="s0"># Tests of some errors that can occur with odeint.</span>

    <span class="s3">def </span><span class="s1">badrhs</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">sys1</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">-</span><span class="s5">100</span><span class="s4">*</span><span class="s1">x</span>

    <span class="s3">def </span><span class="s1">badjac</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]]</span>

    <span class="s0"># y0 must be at most 1-d.</span>
    <span class="s1">bad_y0 </span><span class="s4">= [[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]]</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys1</span><span class="s4">, </span><span class="s1">bad_y0</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s0"># t must be at most 1-d.</span>
    <span class="s1">bad_t </span><span class="s4">= [[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">]]</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys1</span><span class="s4">, [</span><span class="s5">10.0</span><span class="s4">], </span><span class="s1">bad_t</span><span class="s4">)</span>

    <span class="s0"># y0 is 10, but badrhs(x, t) returns [1, -1].</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">RuntimeError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">badrhs</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s0"># shape of array returned by badjac(x, t) is not correct.</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">RuntimeError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">sys1</span><span class="s4">, [</span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">Dfun</span><span class="s4">=</span><span class="s1">badjac</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_repeated_t_values</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot;Regression test for gh-8217.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">func</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">t</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">-</span><span class="s5">0.25</span><span class="s4">*</span><span class="s1">x</span>

    <span class="s1">t </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s5">10</span><span class="s4">)</span>
    <span class="s1">sol </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, [</span><span class="s5">1.</span><span class="s4">], </span><span class="s1">t</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s1">len</span><span class="s4">(</span><span class="s1">t</span><span class="s4">), </span><span class="s5">1</span><span class="s4">)))</span>

    <span class="s1">tau </span><span class="s4">= </span><span class="s5">4</span><span class="s4">*</span><span class="s1">np</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">t </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">]*</span><span class="s5">9 </span><span class="s4">+ [</span><span class="s1">tau</span><span class="s4">, </span><span class="s5">2</span><span class="s4">*</span><span class="s1">tau</span><span class="s4">, </span><span class="s5">2</span><span class="s4">*</span><span class="s1">tau</span><span class="s4">, </span><span class="s5">3</span><span class="s4">*</span><span class="s1">tau</span><span class="s4">]</span>
    <span class="s1">sol </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">], </span><span class="s1">t</span><span class="s4">, </span><span class="s1">rtol</span><span class="s4">=</span><span class="s5">1e-12</span><span class="s4">, </span><span class="s1">atol</span><span class="s4">=</span><span class="s5">1e-12</span><span class="s4">)</span>
    <span class="s1">expected_sol </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">]]*</span><span class="s5">9 </span><span class="s4">+</span>
                            <span class="s4">[[</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">],</span>
                             <span class="s4">[</span><span class="s5">0.25</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">],</span>
                             <span class="s4">[</span><span class="s5">0.25</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">],</span>
                             <span class="s4">[</span><span class="s5">0.125</span><span class="s4">, </span><span class="s5">0.25</span><span class="s4">]])</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">, </span><span class="s1">expected_sol</span><span class="s4">)</span>

    <span class="s0"># Edge case: empty t sequence.</span>
    <span class="s1">sol </span><span class="s4">= </span><span class="s1">odeint</span><span class="s4">(</span><span class="s1">func</span><span class="s4">, [</span><span class="s5">1.</span><span class="s4">], [])</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">sol</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">((</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)))</span>

    <span class="s0"># t values are not monotonic.</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">func</span><span class="s4">, [</span><span class="s5">1.</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
    <span class="s1">assert_raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">odeint</span><span class="s4">, </span><span class="s1">func</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], [</span><span class="s5">0</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">])</span>
</pre>
</body>
</html>