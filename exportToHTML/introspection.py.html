<html>
<head>
<title>introspection.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
introspection.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2020, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s0"># mypy: disable-error-code=&quot;override,attr-defined,call-arg&quot;</span>

<span class="s2">&quot;&quot;&quot;Database Introspection.&quot;&quot;&quot;</span>

<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">namedtuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TYPE_CHECKING</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Set</span><span class="s4">, </span><span class="s1">Tuple</span>

<span class="s3">import </span><span class="s1">sqlparse</span>

<span class="s3">from </span><span class="s1">django </span><span class="s3">import </span><span class="s1">VERSION </span><span class="s3">as </span><span class="s1">DJANGO_VERSION</span>
<span class="s3">from </span><span class="s1">django</span><span class="s4">.</span><span class="s1">db</span><span class="s4">.</span><span class="s1">backends</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">introspection </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">BaseDatabaseIntrospection</span><span class="s4">,</span>
    <span class="s1">FieldInfo </span><span class="s3">as </span><span class="s1">BaseFieldInfo</span><span class="s4">,</span>
    <span class="s1">TableInfo</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">django</span><span class="s4">.</span><span class="s1">db</span><span class="s4">.</span><span class="s1">models </span><span class="s3">import </span><span class="s1">Index</span>
<span class="s3">from </span><span class="s1">django</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">datastructures </span><span class="s3">import </span><span class="s1">OrderedSet</span>

<span class="s3">from </span><span class="s1">mysql</span><span class="s4">.</span><span class="s1">connector</span><span class="s4">.</span><span class="s1">constants </span><span class="s3">import </span><span class="s1">FieldType</span>

<span class="s0"># from .base import CursorWrapper produces a circular import error,</span>
<span class="s0"># avoiding importing CursorWrapper explicitly, using a documented</span>
<span class="s0"># trick; write the imports inside if TYPE_CHECKING: so that they</span>
<span class="s0"># are not executed at runtime.</span>
<span class="s0"># Ref: https://buildmedia.readthedocs.org/media/pdf/mypy/stable/mypy.pdf [page 42]</span>
<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s0"># CursorWraper is used exclusively for type hinting</span>
    <span class="s3">from </span><span class="s1">mysql</span><span class="s4">.</span><span class="s1">connector</span><span class="s4">.</span><span class="s1">django</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">CursorWrapper</span>

<span class="s0"># Based on my investigation, named tuples to</span>
<span class="s0"># comply with mypy need to define a static list or tuple</span>
<span class="s0"># for field_names (second argument). In this case, the field</span>
<span class="s0"># names are created dynamically for FieldInfo which triggers</span>
<span class="s0"># a mypy error. The solution is not straightforward since</span>
<span class="s0"># FieldInfo attributes are Django version dependent. Code</span>
<span class="s0"># refactory is needed to fix this issue.</span>
<span class="s1">FieldInfo </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(  </span><span class="s0"># type: ignore[misc]</span>
    <span class="s5">&quot;FieldInfo&quot;</span><span class="s4">,</span>
    <span class="s1">BaseFieldInfo</span><span class="s4">.</span><span class="s1">_fields </span><span class="s4">+ (</span><span class="s5">&quot;extra&quot;</span><span class="s4">, </span><span class="s5">&quot;is_unsigned&quot;</span><span class="s4">, </span><span class="s5">&quot;has_json_constraint&quot;</span><span class="s4">),</span>
<span class="s4">)</span>
<span class="s3">if </span><span class="s1">DJANGO_VERSION </span><span class="s4">&lt; (</span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">0</span><span class="s4">):</span>
    <span class="s1">InfoLine </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(</span>
        <span class="s5">&quot;InfoLine&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;col_name data_type max_len num_prec num_scale extra column_default &quot;</span>
        <span class="s5">&quot;is_unsigned&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s1">InfoLine </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(  </span><span class="s0"># type: ignore[no-redef]</span>
        <span class="s5">&quot;InfoLine&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;col_name data_type max_len num_prec num_scale extra column_default &quot;</span>
        <span class="s5">&quot;collation is_unsigned&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">class </span><span class="s1">DatabaseIntrospection</span><span class="s4">(</span><span class="s1">BaseDatabaseIntrospection</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Encapsulate backend-specific introspection utilities.&quot;&quot;&quot;</span>

    <span class="s1">data_types_reverse </span><span class="s4">= {</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">BLOB</span><span class="s4">: </span><span class="s5">&quot;TextField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">DECIMAL</span><span class="s4">: </span><span class="s5">&quot;DecimalField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">NEWDECIMAL</span><span class="s4">: </span><span class="s5">&quot;DecimalField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">DATE</span><span class="s4">: </span><span class="s5">&quot;DateField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">DATETIME</span><span class="s4">: </span><span class="s5">&quot;DateTimeField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">DOUBLE</span><span class="s4">: </span><span class="s5">&quot;FloatField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">FLOAT</span><span class="s4">: </span><span class="s5">&quot;FloatField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">INT24</span><span class="s4">: </span><span class="s5">&quot;IntegerField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">LONG</span><span class="s4">: </span><span class="s5">&quot;IntegerField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">LONGLONG</span><span class="s4">: </span><span class="s5">&quot;BigIntegerField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">SHORT</span><span class="s4">: </span><span class="s5">&quot;SmallIntegerField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">STRING</span><span class="s4">: </span><span class="s5">&quot;CharField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">TIME</span><span class="s4">: </span><span class="s5">&quot;TimeField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">TIMESTAMP</span><span class="s4">: </span><span class="s5">&quot;DateTimeField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">TINY</span><span class="s4">: </span><span class="s5">&quot;IntegerField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">TINY_BLOB</span><span class="s4">: </span><span class="s5">&quot;TextField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">MEDIUM_BLOB</span><span class="s4">: </span><span class="s5">&quot;TextField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">LONG_BLOB</span><span class="s4">: </span><span class="s5">&quot;TextField&quot;</span><span class="s4">,</span>
        <span class="s1">FieldType</span><span class="s4">.</span><span class="s1">VAR_STRING</span><span class="s4">: </span><span class="s5">&quot;CharField&quot;</span><span class="s4">,</span>
    <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">get_field_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">data_type</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">description</span><span class="s4">: </span><span class="s1">FieldInfo</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s1">field_type </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">get_field_type</span><span class="s4">(</span><span class="s1">data_type</span><span class="s4">, </span><span class="s1">description</span><span class="s4">)  </span><span class="s0"># type: ignore[arg-type]</span>
        <span class="s3">if </span><span class="s5">&quot;auto_increment&quot; </span><span class="s3">in </span><span class="s1">description</span><span class="s4">.</span><span class="s1">extra</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;IntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;AutoField&quot;</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;BigIntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;BigAutoField&quot;</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;SmallIntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;SmallAutoField&quot;</span>
        <span class="s3">if </span><span class="s1">description</span><span class="s4">.</span><span class="s1">is_unsigned</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;BigIntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;PositiveBigIntegerField&quot;</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;IntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;PositiveIntegerField&quot;</span>
            <span class="s3">if </span><span class="s1">field_type </span><span class="s4">== </span><span class="s5">&quot;SmallIntegerField&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;PositiveSmallIntegerField&quot;</span>
        <span class="s0"># JSON data type is an alias for LONGTEXT in MariaDB, use check</span>
        <span class="s0"># constraints clauses to introspect JSONField.</span>
        <span class="s3">if </span><span class="s1">description</span><span class="s4">.</span><span class="s1">has_json_constraint</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s5">&quot;JSONField&quot;</span>
        <span class="s3">return </span><span class="s1">field_type</span>

    <span class="s3">def </span><span class="s1">get_table_list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">TableInfo</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return a list of table and view names in the current database.&quot;&quot;&quot;</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s5">&quot;SHOW FULL TABLES&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">[</span>
            <span class="s1">TableInfo</span><span class="s4">(</span><span class="s1">row</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], {</span><span class="s5">&quot;BASE TABLE&quot;</span><span class="s4">: </span><span class="s5">&quot;t&quot;</span><span class="s4">, </span><span class="s5">&quot;VIEW&quot;</span><span class="s4">: </span><span class="s5">&quot;v&quot;</span><span class="s4">}.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">row</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]))</span>
            <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s4">]</span>

    <span class="s3">def </span><span class="s1">get_table_description</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">FieldInfo</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Return a description of the table with the DB-API cursor.description 
        interface.&quot; 
        &quot;&quot;&quot;</span>
        <span class="s1">json_constraints</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {}</span>
        <span class="s0"># A default collation for the given table.</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
            <span class="s5">&quot;&quot;&quot; 
            SELECT  table_collation 
            FROM    information_schema.tables 
            WHERE   table_schema = DATABASE() 
            AND     table_name = %s 
        &quot;&quot;&quot;</span><span class="s4">,</span>
            <span class="s4">[</span><span class="s1">table_name</span><span class="s4">],</span>
        <span class="s4">)</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchone</span><span class="s4">()</span>
        <span class="s1">default_column_collation </span><span class="s4">= </span><span class="s1">row</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">if </span><span class="s1">row </span><span class="s3">else </span><span class="s5">&quot;&quot;</span>
        <span class="s0"># information_schema database gives more accurate results for some figures:</span>
        <span class="s0"># - varchar length returned by cursor.description is an internal length,</span>
        <span class="s0">#   not visible length (#5725)</span>
        <span class="s0"># - precision and scale (for decimal fields) (#5014)</span>
        <span class="s0"># - auto_increment is not available in cursor.description</span>
        <span class="s3">if </span><span class="s1">DJANGO_VERSION </span><span class="s4">&lt; (</span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">0</span><span class="s4">):</span>
            <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
                <span class="s5">&quot;&quot;&quot; 
                SELECT 
                    column_name, data_type, character_maximum_length, 
                    numeric_precision, numeric_scale, extra, column_default, 
                    CASE 
                        WHEN column_type LIKE '%% unsigned' THEN 1 
                        ELSE 0 
                    END AS is_unsigned 
                FROM information_schema.columns 
                WHERE table_name = %s AND table_schema = DATABASE() 
            &quot;&quot;&quot;</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">table_name</span><span class="s4">],</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
                <span class="s5">&quot;&quot;&quot; 
                SELECT 
                    column_name, data_type, character_maximum_length, 
                    numeric_precision, numeric_scale, extra, column_default, 
                    CASE 
                        WHEN collation_name = %s THEN NULL 
                        ELSE collation_name 
                    END AS collation_name, 
                    CASE 
                        WHEN column_type LIKE '%% unsigned' THEN 1 
                        ELSE 0 
                    END AS is_unsigned 
                FROM information_schema.columns 
                WHERE table_name = %s AND table_schema = DATABASE() 
            &quot;&quot;&quot;</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">default_column_collation</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">],</span>
            <span class="s4">)</span>
        <span class="s1">field_info </span><span class="s4">= {</span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]: </span><span class="s1">InfoLine</span><span class="s4">(*</span><span class="s1">line</span><span class="s4">) </span><span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">()}</span>

        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
            <span class="s5">f&quot;SELECT * FROM </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">ops</span><span class="s4">.</span><span class="s1">quote_name</span><span class="s4">(</span><span class="s1">table_name</span><span class="s4">)</span><span class="s3">} </span><span class="s5">LIMIT 1&quot;</span>
        <span class="s4">)</span>

        <span class="s3">def </span><span class="s1">to_int</span><span class="s4">(</span><span class="s1">i</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]:</span>
            <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">if </span><span class="s1">i </span><span class="s3">is not None else </span><span class="s1">i</span>

        <span class="s1">fields </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">description</span><span class="s4">:</span>
            <span class="s1">info </span><span class="s4">= </span><span class="s1">field_info</span><span class="s4">[</span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]]</span>
            <span class="s3">if </span><span class="s1">DJANGO_VERSION </span><span class="s4">&lt; (</span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">0</span><span class="s4">):</span>
                <span class="s1">fields</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                    <span class="s1">FieldInfo</span><span class="s4">(</span>
                        <span class="s4">*</span><span class="s1">line</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">max_len</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">3</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">num_prec</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">4</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">num_scale</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">5</span><span class="s4">],</span>
                        <span class="s1">line</span><span class="s4">[</span><span class="s6">6</span><span class="s4">],</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">column_default</span><span class="s4">,</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">extra</span><span class="s4">,</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">is_unsigned</span><span class="s4">,</span>
                        <span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s1">json_constraints</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">fields</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                    <span class="s1">FieldInfo</span><span class="s4">(</span>
                        <span class="s4">*</span><span class="s1">line</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">max_len</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">3</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">num_prec</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">4</span><span class="s4">],</span>
                        <span class="s1">to_int</span><span class="s4">(</span><span class="s1">info</span><span class="s4">.</span><span class="s1">num_scale</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">5</span><span class="s4">],</span>
                        <span class="s1">line</span><span class="s4">[</span><span class="s6">6</span><span class="s4">],</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">column_default</span><span class="s4">,</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">collation</span><span class="s4">,</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">extra</span><span class="s4">,</span>
                        <span class="s1">info</span><span class="s4">.</span><span class="s1">is_unsigned</span><span class="s4">,</span>
                        <span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s1">json_constraints</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">fields</span>

    <span class="s3">def </span><span class="s1">get_indexes</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return indexes from table.&quot;&quot;&quot;</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s5">f&quot;SHOW INDEX FROM </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">ops</span><span class="s4">.</span><span class="s1">quote_name</span><span class="s4">(</span><span class="s1">table_name</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s0"># Do a two-pass search for indexes: on first pass check which indexes</span>
        <span class="s0"># are multicolumn, on second pass check which single-column indexes</span>
        <span class="s0"># are present.</span>
        <span class="s1">rows </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">())</span>
        <span class="s1">multicol_indexes </span><span class="s4">= </span><span class="s1">set</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">rows</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">[</span><span class="s6">3</span><span class="s4">] &gt; </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">multicol_indexes</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">row</span><span class="s4">[</span><span class="s6">2</span><span class="s4">])</span>
        <span class="s1">indexes</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]] = {}</span>
        <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">rows</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] </span><span class="s3">in </span><span class="s1">multicol_indexes</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">[</span><span class="s6">4</span><span class="s4">] </span><span class="s3">not in </span><span class="s1">indexes</span><span class="s4">:</span>
                <span class="s1">indexes</span><span class="s4">[</span><span class="s1">row</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]] = {</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">, </span><span class="s5">&quot;unique&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">}</span>
            <span class="s0"># It's possible to have the unique and PK constraints in</span>
            <span class="s0"># separate indexes.</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] == </span><span class="s5">&quot;PRIMARY&quot;</span><span class="s4">:</span>
                <span class="s1">indexes</span><span class="s4">[</span><span class="s1">row</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]][</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">] = </span><span class="s3">True</span>
            <span class="s3">if not </span><span class="s1">row</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:</span>
                <span class="s1">indexes</span><span class="s4">[</span><span class="s1">row</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]][</span><span class="s5">&quot;unique&quot;</span><span class="s4">] = </span><span class="s3">True</span>
        <span class="s3">return </span><span class="s1">indexes</span>

    <span class="s3">def </span><span class="s1">get_primary_key_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Returns the name of the primary key column for the given table 
        &quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">column </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_indexes</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">).</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">column</span><span class="s4">[</span><span class="s6">1</span><span class="s4">][</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">]:</span>
                <span class="s3">return </span><span class="s1">column</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">get_sequences</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">table_fields</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= ()</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s3">for </span><span class="s1">field_info </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_table_description</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s5">&quot;auto_increment&quot; </span><span class="s3">in </span><span class="s1">field_info</span><span class="s4">.</span><span class="s1">extra</span><span class="s4">:</span>
                <span class="s0"># MySQL allows only one auto-increment column per table.</span>
                <span class="s3">return </span><span class="s4">[{</span><span class="s5">&quot;table&quot;</span><span class="s4">: </span><span class="s1">table_name</span><span class="s4">, </span><span class="s5">&quot;column&quot;</span><span class="s4">: </span><span class="s1">field_info</span><span class="s4">.</span><span class="s1">name</span><span class="s4">}]</span>
        <span class="s3">return </span><span class="s4">[]</span>

    <span class="s3">def </span><span class="s1">get_relations</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Return a dictionary of {field_name: (field_name_other_table, other_table)} 
        representing all relationships to the given table. 
        &quot;&quot;&quot;</span>
        <span class="s1">constraints </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_key_columns</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">)</span>
        <span class="s1">relations </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">my_fieldname</span><span class="s4">, </span><span class="s1">other_table</span><span class="s4">, </span><span class="s1">other_field </span><span class="s3">in </span><span class="s1">constraints</span><span class="s4">:</span>
            <span class="s1">relations</span><span class="s4">[</span><span class="s1">my_fieldname</span><span class="s4">] = (</span><span class="s1">other_field</span><span class="s4">, </span><span class="s1">other_table</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">relations</span>

    <span class="s3">def </span><span class="s1">get_key_columns</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Return a list of (column_name, referenced_table_name, referenced_column_name) 
        for all key columns in the given table. 
        &quot;&quot;&quot;</span>
        <span class="s1">key_columns</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = []</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
            <span class="s5">&quot;&quot;&quot; 
            SELECT column_name, referenced_table_name, referenced_column_name 
            FROM information_schema.key_column_usage 
            WHERE table_name = %s 
                AND table_schema = DATABASE() 
                AND referenced_table_name IS NOT NULL 
                AND referenced_column_name IS NOT NULL&quot;&quot;&quot;</span><span class="s4">,</span>
            <span class="s4">[</span><span class="s1">table_name</span><span class="s4">],</span>
        <span class="s4">)</span>
        <span class="s1">key_columns</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">())</span>
        <span class="s3">return </span><span class="s1">key_columns</span>

    <span class="s3">def </span><span class="s1">get_storage_engine</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Retrieve the storage engine for a given table. Return the default 
        storage engine if the table doesn't exist. 
        &quot;&quot;&quot;</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span>
            <span class="s5">&quot;SELECT engine FROM information_schema.tables WHERE table_name = %s&quot;</span><span class="s4">,</span>
            <span class="s4">[</span><span class="s1">table_name</span><span class="s4">],</span>
        <span class="s4">)</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchone</span><span class="s4">()</span>
        <span class="s0"># pylint: disable=protected-access</span>
        <span class="s3">if not </span><span class="s1">result</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">features</span><span class="s4">.</span><span class="s1">_mysql_storage_engine</span>
        <span class="s0"># pylint: enable=protected-access</span>
        <span class="s3">return </span><span class="s1">result</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">_parse_constraint_columns</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">check_clause</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">columns</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; OrderedSet</span><span class="s4">:</span>
        <span class="s1">check_columns</span><span class="s4">: </span><span class="s1">OrderedSet </span><span class="s4">= </span><span class="s1">OrderedSet</span><span class="s4">()</span>
        <span class="s1">statement </span><span class="s4">= </span><span class="s1">sqlparse</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">(</span><span class="s1">check_clause</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">tokens </span><span class="s4">= (</span><span class="s1">token </span><span class="s3">for </span><span class="s1">token </span><span class="s3">in </span><span class="s1">statement</span><span class="s4">.</span><span class="s1">flatten</span><span class="s4">() </span><span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_whitespace</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">token </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">token</span><span class="s4">.</span><span class="s1">ttype </span><span class="s4">== </span><span class="s1">sqlparse</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">Name</span>
                <span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">ops</span><span class="s4">.</span><span class="s1">quote_name</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">) == </span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span>
                <span class="s3">and </span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:-</span><span class="s6">1</span><span class="s4">] </span><span class="s3">in </span><span class="s1">columns</span>
            <span class="s4">):</span>
                <span class="s1">check_columns</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:-</span><span class="s6">1</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">check_columns</span>

    <span class="s3">def </span><span class="s1">get_constraints</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">cursor</span><span class="s4">: </span><span class="s5">&quot;CursorWrapper&quot;</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Retrieve any constraints or keys (unique, pk, fk, check, index) across 
        one or more columns. 
        &quot;&quot;&quot;</span>
        <span class="s1">constraints</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {}</span>
        <span class="s0"># Get the actual constraint names and columns</span>
        <span class="s1">name_query </span><span class="s4">= </span><span class="s5">&quot;&quot;&quot; 
            SELECT kc.`constraint_name`, kc.`column_name`, 
                kc.`referenced_table_name`, kc.`referenced_column_name` 
            FROM information_schema.key_column_usage AS kc 
            WHERE 
                kc.table_schema = DATABASE() AND 
                kc.table_name = %s 
            ORDER BY kc.`ordinal_position` 
        &quot;&quot;&quot;</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">name_query</span><span class="s4">, [</span><span class="s1">table_name</span><span class="s4">])</span>
        <span class="s3">for </span><span class="s1">constraint</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">ref_table</span><span class="s4">, </span><span class="s1">ref_column </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">constraint </span><span class="s3">not in </span><span class="s1">constraints</span><span class="s4">:</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">] = {</span>
                    <span class="s5">&quot;columns&quot;</span><span class="s4">: </span><span class="s1">OrderedSet</span><span class="s4">(),</span>
                    <span class="s5">&quot;primary_key&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;unique&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;index&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;check&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;foreign_key&quot;</span><span class="s4">: (</span><span class="s1">ref_table</span><span class="s4">, </span><span class="s1">ref_column</span><span class="s4">) </span><span class="s3">if </span><span class="s1">ref_column </span><span class="s3">else None</span><span class="s4">,</span>
                <span class="s4">}</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">features</span><span class="s4">.</span><span class="s1">supports_index_column_ordering</span><span class="s4">:</span>
                    <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">][</span><span class="s5">&quot;orders&quot;</span><span class="s4">] = []</span>
            <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">][</span><span class="s5">&quot;columns&quot;</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">column</span><span class="s4">)</span>
        <span class="s0"># Now get the constraint types</span>
        <span class="s1">type_query </span><span class="s4">= </span><span class="s5">&quot;&quot;&quot; 
            SELECT c.constraint_name, c.constraint_type 
            FROM information_schema.table_constraints AS c 
            WHERE 
                c.table_schema = DATABASE() AND 
                c.table_name = %s 
        &quot;&quot;&quot;</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">type_query</span><span class="s4">, [</span><span class="s1">table_name</span><span class="s4">])</span>
        <span class="s3">for </span><span class="s1">constraint</span><span class="s4">, </span><span class="s1">kind </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">kind</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">() == </span><span class="s5">&quot;primary key&quot;</span><span class="s4">:</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">][</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">] = </span><span class="s3">True</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">][</span><span class="s5">&quot;unique&quot;</span><span class="s4">] = </span><span class="s3">True</span>
            <span class="s3">elif </span><span class="s1">kind</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">() == </span><span class="s5">&quot;unique&quot;</span><span class="s4">:</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">][</span><span class="s5">&quot;unique&quot;</span><span class="s4">] = </span><span class="s3">True</span>
        <span class="s0"># Add check constraints.</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">features</span><span class="s4">.</span><span class="s1">can_introspect_check_constraints</span><span class="s4">:</span>
            <span class="s1">unnamed_constraints_index </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s1">columns </span><span class="s4">= {</span>
                <span class="s1">info</span><span class="s4">.</span><span class="s1">name </span><span class="s3">for </span><span class="s1">info </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_table_description</span><span class="s4">(</span><span class="s1">cursor</span><span class="s4">, </span><span class="s1">table_name</span><span class="s4">)</span>
            <span class="s4">}</span>
            <span class="s1">type_query </span><span class="s4">= </span><span class="s5">&quot;&quot;&quot; 
                SELECT cc.constraint_name, cc.check_clause 
                FROM 
                    information_schema.check_constraints AS cc, 
                    information_schema.table_constraints AS tc 
                WHERE 
                    cc.constraint_schema = DATABASE() AND 
                    tc.table_schema = cc.constraint_schema AND 
                    cc.constraint_name = tc.constraint_name AND 
                    tc.constraint_type = 'CHECK' AND 
                    tc.table_name = %s 
            &quot;&quot;&quot;</span>
            <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">type_query</span><span class="s4">, [</span><span class="s1">table_name</span><span class="s4">])</span>
            <span class="s3">for </span><span class="s1">constraint</span><span class="s4">, </span><span class="s1">check_clause </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">():</span>
                <span class="s1">constraint_columns </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_parse_constraint_columns</span><span class="s4">(</span>
                    <span class="s1">check_clause</span><span class="s4">, </span><span class="s1">columns</span>
                <span class="s4">)</span>
                <span class="s0"># Ensure uniqueness of unnamed constraints. Unnamed unique</span>
                <span class="s0"># and check columns constraints have the same name as</span>
                <span class="s0"># a column.</span>
                <span class="s3">if </span><span class="s1">set</span><span class="s4">(</span><span class="s1">constraint_columns</span><span class="s4">) == {</span><span class="s1">constraint</span><span class="s4">}:</span>
                    <span class="s1">unnamed_constraints_index </span><span class="s4">+= </span><span class="s6">1</span>
                    <span class="s1">constraint </span><span class="s4">= </span><span class="s5">f&quot;__unnamed_constraint_</span><span class="s3">{</span><span class="s1">unnamed_constraints_index</span><span class="s3">}</span><span class="s5">__&quot;</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">constraint</span><span class="s4">] = {</span>
                    <span class="s5">&quot;columns&quot;</span><span class="s4">: </span><span class="s1">constraint_columns</span><span class="s4">,</span>
                    <span class="s5">&quot;primary_key&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;unique&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;index&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;check&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
                    <span class="s5">&quot;foreign_key&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
                <span class="s4">}</span>
        <span class="s0"># Now add in the indexes</span>
        <span class="s1">cursor</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s5">f&quot;SHOW INDEX FROM </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">ops</span><span class="s4">.</span><span class="s1">quote_name</span><span class="s4">(</span><span class="s1">table_name</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">order</span><span class="s4">, </span><span class="s1">type_ </span><span class="s3">in </span><span class="s4">[</span>
            <span class="s1">x</span><span class="s4">[:</span><span class="s6">6</span><span class="s4">] + (</span><span class="s1">x</span><span class="s4">[</span><span class="s6">10</span><span class="s4">],) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">cursor</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s4">]:</span>
            <span class="s3">if </span><span class="s1">index </span><span class="s3">not in </span><span class="s1">constraints</span><span class="s4">:</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">] = {</span>
                    <span class="s5">&quot;columns&quot;</span><span class="s4">: </span><span class="s1">OrderedSet</span><span class="s4">(),</span>
                    <span class="s5">&quot;primary_key&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;unique&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;check&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s5">&quot;foreign_key&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
                <span class="s4">}</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">features</span><span class="s4">.</span><span class="s1">supports_index_column_ordering</span><span class="s4">:</span>
                    <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">][</span><span class="s5">&quot;orders&quot;</span><span class="s4">] = []</span>
            <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">][</span><span class="s5">&quot;index&quot;</span><span class="s4">] = </span><span class="s3">True</span>
            <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">][</span><span class="s5">&quot;type&quot;</span><span class="s4">] = (</span>
                <span class="s1">Index</span><span class="s4">.</span><span class="s1">suffix </span><span class="s3">if </span><span class="s1">type_ </span><span class="s4">== </span><span class="s5">&quot;BTREE&quot; </span><span class="s3">else </span><span class="s1">type_</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span>
            <span class="s4">)</span>
            <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">][</span><span class="s5">&quot;columns&quot;</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">column</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">connection</span><span class="s4">.</span><span class="s1">features</span><span class="s4">.</span><span class="s1">supports_index_column_ordering</span><span class="s4">:</span>
                <span class="s1">constraints</span><span class="s4">[</span><span class="s1">index</span><span class="s4">][</span><span class="s5">&quot;orders&quot;</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s5">&quot;DESC&quot; </span><span class="s3">if </span><span class="s1">order </span><span class="s4">== </span><span class="s5">&quot;D&quot; </span><span class="s3">else </span><span class="s5">&quot;ASC&quot;</span><span class="s4">)</span>
        <span class="s0"># Convert the sorted sets to lists</span>
        <span class="s3">for </span><span class="s1">constraint </span><span class="s3">in </span><span class="s1">constraints</span><span class="s4">.</span><span class="s1">values</span><span class="s4">():</span>
            <span class="s1">constraint</span><span class="s4">[</span><span class="s5">&quot;columns&quot;</span><span class="s4">] = </span><span class="s1">list</span><span class="s4">(</span><span class="s1">constraint</span><span class="s4">[</span><span class="s5">&quot;columns&quot;</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">constraints</span>
</pre>
</body>
</html>