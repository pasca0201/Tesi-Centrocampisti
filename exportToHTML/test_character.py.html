<html>
<head>
<title>test_character.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_character.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">textwrap</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_raises</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">f2py</span><span class="s2">.</span><span class="s1">tests </span><span class="s0">import </span><span class="s1">util</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s0">class </span><span class="s1">TestCharacterString</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s3"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix </span><span class="s2">= </span><span class="s4">'.f90'</span>
    <span class="s1">fprefix </span><span class="s2">= </span><span class="s4">'test_character_string'</span>
    <span class="s1">length_list </span><span class="s2">= [</span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">]</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s4">''</span>
    <span class="s0">for </span><span class="s1">length </span><span class="s0">in </span><span class="s1">length_list</span><span class="s2">:</span>
        <span class="s1">fsuffix </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s1">clength </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">star</span><span class="s2">=</span><span class="s4">'(*)'</span><span class="s2">).</span><span class="s1">get</span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>

        <span class="s1">code </span><span class="s2">+= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>

        <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s4">(c, o, n)</span>
          <span class="s4">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s4">, intent(in) :: c</span>
          <span class="s4">integer n</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: n = slen(c)</span>
          <span class="s4">integer*1, dimension(n) :: o</span>
          <span class="s4">!f2py intent(out) o</span>
          <span class="s4">o = transfer(c, o)</span>
        <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s4">(c, o, n)</span>
          <span class="s4">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s4">, intent(out) :: c</span>
          <span class="s4">integer n</span>
          <span class="s4">integer*1, dimension(n), intent(in) :: o</span>
          <span class="s4">!f2py integer, depend(o), intent(hide) :: n = len(o)</span>
          <span class="s4">c = transfer(o, c)</span>
        <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s4">(c, o, m, n)</span>
          <span class="s4">integer m, i, n</span>
          <span class="s4">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s4">, intent(in), dimension(m) :: c</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: m = len(c)</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: n = f2py_itemsize(c)</span>
          <span class="s4">integer*1, dimension(m, n), intent(out) :: o</span>
          <span class="s4">do i=1,m</span>
            <span class="s4">o(i, :) = transfer(c(i), o(i, :))</span>
          <span class="s4">end do</span>
        <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s4">(c, o, m, n)</span>
          <span class="s4">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s4">, intent(out), dimension(m) :: c</span>
          <span class="s4">integer n</span>
          <span class="s4">integer*1, dimension(m, n), intent(in) :: o</span>
          <span class="s4">!f2py character(f2py_len=n) :: c</span>
          <span class="s4">!f2py integer, depend(o), intent(hide) :: m = len(o)</span>
          <span class="s4">!f2py integer, depend(o), intent(hide) :: n = shape(o, 1)</span>
          <span class="s4">do i=1,m</span>
            <span class="s4">c(i) = transfer(o(i, :), c(i))</span>
          <span class="s4">end do</span>
        <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_output_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>

        <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span><span class="s4">(c, o, m1, m2, n)</span>
          <span class="s4">integer m1, m2, i, j, n</span>
          <span class="s4">character*</span><span class="s0">{</span><span class="s1">clength</span><span class="s0">}</span><span class="s4">, intent(in), dimension(m1, m2) :: c</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: m1 = len(c)</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: m2 = shape(c, 1)</span>
          <span class="s4">!f2py integer, depend(c), intent(hide) :: n = f2py_itemsize(c)</span>
          <span class="s4">integer*1, dimension(m1, m2, n), intent(out) :: o</span>
          <span class="s4">do i=1,m1</span>
            <span class="s4">do j=1,m2</span>
              <span class="s4">o(i, j, :) = transfer(c(i, j), o(i, j, :))</span>
            <span class="s4">end do</span>
          <span class="s4">end do</span>
        <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_input_</span><span class="s0">{</span><span class="s1">fsuffix</span><span class="s0">}</span>
        <span class="s4">&quot;&quot;&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;length&quot;</span><span class="s2">, </span><span class="s1">length_list</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">fsuffix </span><span class="s2">= {</span><span class="s4">'(*)'</span><span class="s2">: </span><span class="s4">'star'</span><span class="s2">}.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_input_' </span><span class="s2">+ </span><span class="s1">fsuffix</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= {</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'abcde' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">]</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u1'</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;length&quot;</span><span class="s2">, </span><span class="s1">length_list</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">fsuffix </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_output_' </span><span class="s2">+ </span><span class="s1">fsuffix</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= {</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'abc'</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">]</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u1'</span><span class="s2">)),</span>
                           <span class="s1">a</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">())</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;length&quot;</span><span class="s2">, </span><span class="s1">length_list</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_array_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">fsuffix </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_input_' </span><span class="s2">+ </span><span class="s1">fsuffix</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'abcde' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">],</span>
                      <span class="s2">{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'ABC'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'ABCDE' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">],</span>
                      <span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S'</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s</span><span class="s2">] </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">a</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u1'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;length&quot;</span><span class="s2">, </span><span class="s1">length_list</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_array_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">fsuffix </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_output_' </span><span class="s2">+ </span><span class="s1">fsuffix</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'abcde' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">],</span>
             <span class="s2">{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'ABC'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'ABCDE' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s</span><span class="s2">] </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u1'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;length&quot;</span><span class="s2">, </span><span class="s1">length_list</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_2d_array_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">fsuffix </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_2d_array_input_' </span><span class="s2">+ </span><span class="s1">fsuffix</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'abcde' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">],</span>
                       <span class="s2">{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'ABC'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'ABCDE' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">]],</span>
                      <span class="s2">[{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'fgh'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'fghij' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">],</span>
                       <span class="s2">{</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'F'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'FGH'</span><span class="s2">, </span><span class="s4">'star'</span><span class="s2">: </span><span class="s4">'FGHIJ' </span><span class="s2">* </span><span class="s5">3</span><span class="s2">}[</span><span class="s1">length</span><span class="s2">]]],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S'</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[[</span><span class="s1">c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">item</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">row</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">a</span><span class="s2">],</span>
                            <span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u1'</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCharacter</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s3"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix </span><span class="s2">= </span><span class="s4">'.f90'</span>
    <span class="s1">fprefix </span><span class="s2">= </span><span class="s4">'test_character'</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>
       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input(c, o)</span>
          <span class="s4">character, intent(in) :: c</span>
          <span class="s4">integer*1 o</span>
          <span class="s4">!f2py intent(out) o</span>
          <span class="s4">o = transfer(c, o)</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_output(c, o)</span>
          <span class="s4">character :: c</span>
          <span class="s4">integer*1, intent(in) :: o</span>
          <span class="s4">!f2py intent(out) c</span>
          <span class="s4">c = transfer(o, c)</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_output</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input_output(c, o)</span>
          <span class="s4">character, intent(in) :: c</span>
          <span class="s4">character o</span>
          <span class="s4">!f2py intent(out) o</span>
          <span class="s4">o = c</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_input_output</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_inout(c, n)</span>
          <span class="s4">character :: c, n</span>
          <span class="s4">!f2py intent(in) n</span>
          <span class="s4">!f2py intent(inout) c</span>
          <span class="s4">c = n</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_inout</span>

       <span class="s4">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_return(o) result (c)</span>
          <span class="s4">character :: c</span>
          <span class="s4">character, intent(in) :: o</span>
          <span class="s4">c = transfer(o, c)</span>
       <span class="s4">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_return</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_input(c, o)</span>
          <span class="s4">character, intent(in) :: c(3)</span>
          <span class="s4">integer*1 o(3)</span>
          <span class="s4">!f2py intent(out) o</span>
          <span class="s4">integer i</span>
          <span class="s4">do i=1,3</span>
            <span class="s4">o(i) = transfer(c(i), o(i))</span>
          <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_input</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_input(c, o)</span>
          <span class="s4">character, intent(in) :: c(2, 3)</span>
          <span class="s4">integer*1 o(2, 3)</span>
          <span class="s4">!f2py intent(out) o</span>
          <span class="s4">integer i, j</span>
          <span class="s4">do i=1,2</span>
            <span class="s4">do j=1,3</span>
              <span class="s4">o(i, j) = transfer(c(i, j), o(i, j))</span>
            <span class="s4">end do</span>
          <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_input</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_output(c, o)</span>
          <span class="s4">character :: c(3)</span>
          <span class="s4">integer*1, intent(in) :: o(3)</span>
          <span class="s4">!f2py intent(out) c</span>
          <span class="s4">do i=1,3</span>
            <span class="s4">c(i) = transfer(o(i), c(i))</span>
          <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_output</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_inout(c, n)</span>
          <span class="s4">character :: c(3), n(3)</span>
          <span class="s4">!f2py intent(in) n(3)</span>
          <span class="s4">!f2py intent(inout) c(3)</span>
          <span class="s4">do i=1,3</span>
            <span class="s4">c(i) = n(i)</span>
          <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_inout</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_inout(c, n)</span>
          <span class="s4">character :: c(2, 3), n(2, 3)</span>
          <span class="s4">!f2py intent(in) n(2, 3)</span>
          <span class="s4">!f2py intent(inout) c(2. 3)</span>
          <span class="s4">integer i, j</span>
          <span class="s4">do i=1,2</span>
            <span class="s4">do j=1,3</span>
              <span class="s4">c(i, j) = n(i, j)</span>
            <span class="s4">end do</span>
          <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_2d_array_inout</span>

       <span class="s4">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_return(o) result (c)</span>
          <span class="s4">character, dimension(3) :: c</span>
          <span class="s4">character, intent(in) :: o(3)</span>
          <span class="s4">do i=1,3</span>
            <span class="s4">c(i) = o(i)</span>
          <span class="s4">end do</span>
       <span class="s4">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_array_return</span>

       <span class="s4">function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_optional(o) result (c)</span>
          <span class="s4">character, intent(in) :: o</span>
          <span class="s4">!f2py character o = &quot;a&quot;</span>
          <span class="s4">character :: c</span>
          <span class="s4">c = o</span>
       <span class="s4">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_optional</span>
    <span class="s4">&quot;&quot;&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_input'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'a'</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_input_varia</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_input'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">''</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b''</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'</span><span class="s0">\0</span><span class="s6">'</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'ab'</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'ab'</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">]), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">)), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">b'a'</span><span class="s2">])), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">ord</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">))</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">([])</span>
        <span class="s0">except </span><span class="s1">IndexError </span><span class="s0">as </span><span class="s1">msg</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">).</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">' got 0-list'</span><span class="s2">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">SystemError</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">f</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s4">should have failed on empty list'</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s5">97</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">msg</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">).</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">' got int instance'</span><span class="s2">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">SystemError</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">f</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s4">should have failed on int value'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">, </span><span class="s4">'U1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_array_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_input'</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i1'</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">b'a'</span><span class="s2">, </span><span class="s6">b'b'</span><span class="s2">, </span><span class="s6">b'c'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i1'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_array_input_varia</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_input'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">]),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i1'</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">([</span><span class="s6">b'a'</span><span class="s2">, </span><span class="s6">b'b'</span><span class="s2">, </span><span class="s6">b'c'</span><span class="s2">]),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i1'</span><span class="s2">))</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">).</span><span class="s1">endswith</span><span class="s2">(</span>
                    <span class="s4">'th dimension must be fixed to 3 but got 4'</span><span class="s2">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">SystemError</span><span class="s2">(</span>
                <span class="s4">f'</span><span class="s0">{</span><span class="s1">f</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s4">should have failed on wrong input'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">, </span><span class="s4">'U1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_2d_array_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_2d_array_input'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32 </span><span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s4">'U1' </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_output'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">)), </span><span class="s6">b'a'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s5">0</span><span class="s2">), </span><span class="s6">b'</span><span class="s0">\0</span><span class="s6">'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_output'</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">))),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S1'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_input_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_input_output'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'a'</span><span class="s2">), </span><span class="s6">b'a'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">), </span><span class="s6">b'a'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">''</span><span class="s2">), </span><span class="s6">b'</span><span class="s0">\0</span><span class="s6">'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_inout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_inout'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">'Abc'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s4">'B'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">'ABc'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'abc'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'Abc'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_inout_varia</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_inout'</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S3'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'Abc'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'abc'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S3'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'Abc'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">).</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">' got 3-str'</span><span class="s2">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">SystemError</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">f</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s4">should have failed on str value'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_array_inout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_inout'</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">msg</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">str</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">).</span><span class="s1">endswith</span><span class="s2">(</span>
                    <span class="s4">'th dimension must be fixed to 3 but got 4'</span><span class="s2">):</span>
                <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">SystemError</span><span class="s2">(</span>
                <span class="s4">f'</span><span class="s0">{</span><span class="s1">f</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s4">should have failed on wrong input'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_2d_array_inout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_2d_array_inout'</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">'D'</span><span class="s2">, </span><span class="s4">'E'</span><span class="s2">, </span><span class="s4">'F'</span><span class="s2">]],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">]],</span>
                     <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_return'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'a'</span><span class="s2">), </span><span class="s6">b'a'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'fortran function returning array segfaults'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_array_return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_array_return'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">'abc'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S1'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_optional</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_optional'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(), </span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'B'</span><span class="s2">), </span><span class="s6">b&quot;B&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMiscCharacter</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s3"># options = ['--debug-capi', '--build-dir', '/tmp/test-build-f2py']</span>
    <span class="s1">suffix </span><span class="s2">= </span><span class="s4">'.f90'</span>
    <span class="s1">fprefix </span><span class="s2">= </span><span class="s4">'test_misc_character'</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>
       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh18684(x, y, m)</span>
         <span class="s4">character(len=5), dimension(m), intent(in) :: x</span>
         <span class="s4">character*5, dimension(m), intent(out) :: y</span>
         <span class="s4">integer i, m</span>
         <span class="s4">!f2py integer, intent(hide), depend(x) :: m = f2py_len(x)</span>
         <span class="s4">do i=1,m</span>
           <span class="s4">y(i) = x(i)</span>
         <span class="s4">end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh18684</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh6308(x, i)</span>
         <span class="s4">integer i</span>
         <span class="s4">!f2py check(i&gt;=0 &amp;&amp; i&lt;12) i</span>
         <span class="s4">character*5 name, x</span>
         <span class="s4">common name(12)</span>
         <span class="s4">name(i + 1) = x</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh6308</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh4519(x)</span>
         <span class="s4">character(len=*), intent(in) :: x(:)</span>
         <span class="s4">!f2py intent(out) x</span>
         <span class="s4">integer :: i</span>
         <span class="s4">! Uncomment for debug printing:</span>
         <span class="s4">!do i=1, size(x)</span>
         <span class="s4">!   print*, &quot;x(&quot;,i,&quot;)=&quot;, x(i)</span>
         <span class="s4">!end do</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh4519</span>

       <span class="s4">pure function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh3425(x) result (y)</span>
         <span class="s4">character(len=*), intent(in) :: x</span>
         <span class="s4">character(len=len(x)) :: y</span>
         <span class="s4">integer :: i</span>
         <span class="s4">do i = 1, len(x)</span>
           <span class="s4">j = iachar(x(i:i))</span>
           <span class="s4">if (j&gt;=iachar(&quot;a&quot;) .and. j&lt;=iachar(&quot;z&quot;) ) then</span>
             <span class="s4">y(i:i) = achar(j-32)</span>
           <span class="s4">else</span>
             <span class="s4">y(i:i) = x(i:i)</span>
           <span class="s4">endif</span>
         <span class="s4">end do</span>
       <span class="s4">end function </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_gh3425</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_character_bc_new(x, y, z)</span>
         <span class="s4">character, intent(in) :: x</span>
         <span class="s4">character, intent(out) :: y</span>
         <span class="s4">!f2py character, depend(x) :: y = x</span>
         <span class="s4">!f2py character, dimension((x=='a'?1:2)), depend(x), intent(out) :: z</span>
         <span class="s4">character, dimension(*) :: z</span>
         <span class="s4">!f2py character, optional, check(x == 'a' || x == 'b') :: x = 'a'</span>
         <span class="s4">!f2py callstatement (*f2py_func)(&amp;x, &amp;y, z)</span>
         <span class="s4">!f2py callprotoargument character*, character*, character*</span>
         <span class="s4">if (y.eq.x) then</span>
           <span class="s4">y = x</span>
         <span class="s4">else</span>
           <span class="s4">y = 'e'</span>
         <span class="s4">endif</span>
         <span class="s4">z(1) = 'c'</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_character_bc_new</span>

       <span class="s4">subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_character_bc_old(x, y, z)</span>
         <span class="s4">character, intent(in) :: x</span>
         <span class="s4">character, intent(out) :: y</span>
         <span class="s4">!f2py character, depend(x) :: y = x[0]</span>
         <span class="s4">!f2py character, dimension((*x=='a'?1:2)), depend(x), intent(out) :: z</span>
         <span class="s4">character, dimension(*) :: z</span>
         <span class="s4">!f2py character, optional, check(*x == 'a' || x[0] == 'b') :: x = 'a'</span>
         <span class="s4">!f2py callstatement (*f2py_func)(x, y, z)</span>
         <span class="s4">!f2py callprotoargument char*, char*, char*</span>
          <span class="s4">if (y.eq.x) then</span>
           <span class="s4">y = x</span>
         <span class="s4">else</span>
           <span class="s4">y = 'e'</span>
         <span class="s4">endif</span>
         <span class="s4">z(1) = 'c'</span>
       <span class="s4">end subroutine </span><span class="s0">{</span><span class="s1">fprefix</span><span class="s0">}</span><span class="s4">_character_bc_old</span>
    <span class="s4">&quot;&quot;&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_gh18684</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test character(len=5) and character*5 usages</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_gh18684'</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;abcde&quot;</span><span class="s2">, </span><span class="s4">&quot;fghij&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S5'</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gh6308</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test character string array in a common block</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_gh6308'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">_BLNK_</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S5'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">_BLNK_</span><span class="s2">.</span><span class="s1">name</span><span class="s2">), </span><span class="s5">12</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s4">&quot;abcde&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">_BLNK_</span><span class="s2">.</span><span class="s1">name</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s6">b&quot;abcde&quot;</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">(</span><span class="s4">&quot;12345&quot;</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">_BLNK_</span><span class="s2">.</span><span class="s1">name</span><span class="s2">[</span><span class="s5">5</span><span class="s2">], </span><span class="s6">b&quot;12345&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gh4519</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test array of assumed length strings</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_gh4519'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s2">[</span>
                <span class="s2">(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S1'</span><span class="s2">))),</span>
                <span class="s2">(</span><span class="s4">'text'</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S4'</span><span class="s2">))),</span>
                <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'2'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S1'</span><span class="s2">),</span>
                 <span class="s1">dict</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s5">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S1'</span><span class="s2">))),</span>
                <span class="s2">([</span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'2'</span><span class="s2">, </span><span class="s4">'34'</span><span class="s2">],</span>
                 <span class="s1">dict</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s5">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S2'</span><span class="s2">))),</span>
                <span class="s2">([</span><span class="s4">''</span><span class="s2">, </span><span class="s4">''</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S1'</span><span class="s2">)))]:</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gh3425</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test returning a copy of assumed length string</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_gh3425'</span><span class="s2">)</span>
        <span class="s3"># f is equivalent to bytes.upper</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'abC'</span><span class="s2">), </span><span class="s6">b'ABC'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">''</span><span class="s2">), </span><span class="s6">b''</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s4">'abC12d'</span><span class="s2">), </span><span class="s6">b'ABC12D'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;state&quot;</span><span class="s2">, [</span><span class="s4">'new'</span><span class="s2">, </span><span class="s4">'old'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_character_bc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fprefix </span><span class="s2">+ </span><span class="s4">'_character_bc_' </span><span class="s2">+ </span><span class="s1">state</span><span class="s2">)</span>

        <span class="s1">c</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">f</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s6">b'a'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s5">1</span><span class="s2">)</span>

        <span class="s1">c</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'b'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s6">b'b'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">f</span><span class="s2">(</span><span class="s6">b'c'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestStringScalarArr</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s1">sources </span><span class="s2">= [</span><span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;scalar_string.f90&quot;</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">test_char</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_test</span><span class="s2">.</span><span class="s1">string</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_test</span><span class="s2">.</span><span class="s1">string77</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= ()</span>
            <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s4">'|S8'</span>
            <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s0">def </span><span class="s1">test_char_arr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_test</span><span class="s2">.</span><span class="s1">strarr</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_test</span><span class="s2">.</span><span class="s1">strarr77</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= (</span><span class="s5">5</span><span class="s2">,</span><span class="s5">7</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s4">'|S12'</span>
            <span class="s0">assert </span><span class="s1">out</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">expected</span>

<span class="s0">class </span><span class="s1">TestStringAssumedLength</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s1">sources </span><span class="s2">= [</span><span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh24008.f&quot;</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">test_gh24008</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">greet</span><span class="s2">(</span><span class="s4">&quot;joe&quot;</span><span class="s2">, </span><span class="s4">&quot;bob&quot;</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s0">class </span><span class="s1">TestStringOptionalInOut</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s1">sources </span><span class="s2">= [</span><span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh24662.f90&quot;</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">test_gh24662</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_inout_optional</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">'hi'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'S32'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_inout_optional</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s4">&quot;output string&quot; </span><span class="s0">in </span><span class="s1">a</span><span class="s2">.</span><span class="s1">tobytes</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
            <span class="s1">aa </span><span class="s2">= </span><span class="s4">&quot;Hi&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">string_inout_optional</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s0">class </span><span class="s1">TestNewCharHandling</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s3"># from v1.24 onwards, gh-19388</span>
    <span class="s1">sources </span><span class="s2">= [</span>
        <span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh25286.pyf&quot;</span><span class="s2">),</span>
        <span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh25286.f90&quot;</span><span class="s2">)</span>
    <span class="s2">]</span>
    <span class="s1">module_name </span><span class="s2">= </span><span class="s4">&quot;_char_handling_test&quot;</span>

    <span class="s0">def </span><span class="s1">test_gh25286</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">charint</span><span class="s2">(</span><span class="s4">'T'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">info </span><span class="s2">== </span><span class="s5">2</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s0">class </span><span class="s1">TestBCCharHandling</span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">F2PyTest</span><span class="s2">):</span>
    <span class="s3"># SciPy style, &quot;incorrect&quot; bindings with a hook</span>
    <span class="s1">sources </span><span class="s2">= [</span>
        <span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh25286_bc.pyf&quot;</span><span class="s2">),</span>
        <span class="s1">util</span><span class="s2">.</span><span class="s1">getpath</span><span class="s2">(</span><span class="s4">&quot;tests&quot;</span><span class="s2">, </span><span class="s4">&quot;src&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;gh25286.f90&quot;</span><span class="s2">)</span>
    <span class="s2">]</span>
    <span class="s1">module_name </span><span class="s2">= </span><span class="s4">&quot;_char_handling_test&quot;</span>

    <span class="s0">def </span><span class="s1">test_gh25286</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">info </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">charint</span><span class="s2">(</span><span class="s4">'T'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">info </span><span class="s2">== </span><span class="s5">2</span>
</pre>
</body>
</html>