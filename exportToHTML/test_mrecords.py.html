<html>
<head>
<title>test_mrecords.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_mrecords.py</font>
</center></td></tr></table>
<pre><span class="s0"># pylint: disable-msg=W0611, W0612, W0511,R0201</span>
<span class="s2">&quot;&quot;&quot;Tests suite for mrecords. 
 
:author: Pierre Gerard-Marchant 
:contact: pierregm_at_uga_dot_edu 
 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">pickle</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma </span><span class="s3">as </span><span class="s1">ma</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma </span><span class="s3">import </span><span class="s1">masked</span><span class="s4">, </span><span class="s1">nomask</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">testing </span><span class="s3">import </span><span class="s1">temppath</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">_core</span><span class="s4">.</span><span class="s1">records </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">recarray</span><span class="s4">, </span><span class="s1">fromrecords </span><span class="s3">as </span><span class="s1">recfromrecords</span><span class="s4">, </span><span class="s1">fromarrays </span><span class="s3">as </span><span class="s1">recfromarrays</span>
    <span class="s4">)</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">mrecords </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">MaskedRecords</span><span class="s4">, </span><span class="s1">mrecarray</span><span class="s4">, </span><span class="s1">fromarrays</span><span class="s4">, </span><span class="s1">fromtextfile</span><span class="s4">, </span><span class="s1">fromrecords</span><span class="s4">,</span>
    <span class="s1">addfield</span>
    <span class="s4">)</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">testutils </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">assert_</span><span class="s4">, </span><span class="s1">assert_equal</span><span class="s4">,</span>
    <span class="s1">assert_equal_records</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestMRecords</span><span class="s4">:</span>

    <span class="s1">ilist </span><span class="s4">= [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">]</span>
    <span class="s1">flist </span><span class="s4">= [</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s4">]</span>
    <span class="s1">slist </span><span class="s4">= [</span><span class="s6">b'one'</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">, </span><span class="s6">b'four'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s4">]</span>
    <span class="s1">ddtype </span><span class="s4">= [(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s7">'|S8'</span><span class="s4">)]</span>
    <span class="s1">mask </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]</span>
    <span class="s1">base </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">ilist</span><span class="s4">, </span><span class="s1">flist</span><span class="s4">, </span><span class="s1">slist</span><span class="s4">)), </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">mask</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_byview</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test creation by view</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, </span><span class="s1">base</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">base</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">recarray</span><span class="s4">))</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">base</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">recarray</span><span class="s4">))</span>
        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s4">(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s7">'b'</span><span class="s4">, </span><span class="s7">'c'</span><span class="s4">):</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">base</span><span class="s4">[</span><span class="s1">field</span><span class="s4">], </span><span class="s1">mbase</span><span class="s4">[</span><span class="s1">field</span><span class="s4">])</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">), </span><span class="s1">mbase</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests fields retrieval</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s0"># As fields..........</span>
        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s4">(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s7">'b'</span><span class="s4">, </span><span class="s7">'c'</span><span class="s4">):</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">, </span><span class="s1">field</span><span class="s4">), </span><span class="s1">mbase</span><span class="s4">[</span><span class="s1">field</span><span class="s4">])</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">base</span><span class="s4">[</span><span class="s1">field</span><span class="s4">], </span><span class="s1">mbase</span><span class="s4">[</span><span class="s1">field</span><span class="s4">])</span>
        <span class="s0"># as elements .......</span>
        <span class="s1">mbase_first </span><span class="s4">= </span><span class="s1">mbase</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">, </span><span class="s1">mrecarray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s6">b'one'</span><span class="s4">))</span>
        <span class="s0"># Used to be mask, now it's recordmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, </span><span class="s1">nomask</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">item</span><span class="s4">(), (</span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_first</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">], </span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">][</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">mbase_last </span><span class="s4">= </span><span class="s1">mbase</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">, </span><span class="s1">mrecarray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), (</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>
        <span class="s0"># Used to be mask, now it's recordmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">item</span><span class="s4">(), (</span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">], </span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">][-</span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">mbase_last</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">] </span><span class="s3">is </span><span class="s1">masked</span><span class="s4">)</span>
        <span class="s0"># as slice ..........</span>
        <span class="s1">mbase_sl </span><span class="s4">= </span><span class="s1">mbase</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">]</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">, </span><span class="s1">mrecarray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s0"># Used to be mask, now it's recordmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">,</span>
                             <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
                                       <span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)],</span>
                                      <span class="s1">dtype</span><span class="s4">=</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">))</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">, </span><span class="s1">base</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">].</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">))</span>
        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s4">(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s7">'b'</span><span class="s4">, </span><span class="s7">'c'</span><span class="s4">):</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mbase_sl</span><span class="s4">, </span><span class="s1">field</span><span class="s4">), </span><span class="s1">base</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">][</span><span class="s1">field</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_set_fields</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests setting fields.</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">fill_value </span><span class="s4">= (</span><span class="s5">999999</span><span class="s4">, </span><span class="s5">1e20</span><span class="s4">, </span><span class="s7">'N/A'</span><span class="s4">)</span>
        <span class="s0"># Change the data, the mask should be conserved</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[:] = </span><span class="s5">5</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s0"># Change the elements, and the mask will follow</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">a </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">getmaskarray</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">]), [</span><span class="s5">0</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s0"># Use to be _mask, now it's recordmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, [</span><span class="s3">False</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
                     <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
                              <span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">))</span>
        <span class="s0"># Set a field to mask ........................</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">c </span><span class="s4">= </span><span class="s1">masked</span>
        <span class="s0"># Use to be mask, and now it's still mask !</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">getmaskarray</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'c'</span><span class="s4">]), [</span><span class="s5">1</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">getdata</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'c'</span><span class="s4">]), [</span><span class="s6">b'N/A'</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
                     <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                               <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
                              <span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">))</span>
        <span class="s0"># Set fields by slices .......................</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">).</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">[</span><span class="s5">3</span><span class="s4">:] = </span><span class="s5">5</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">[</span><span class="s5">3</span><span class="s4">:] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">, </span><span class="s1">base</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s0"># Set fields globally..........................</span>
        <span class="s1">ndtype </span><span class="s4">= [(</span><span class="s7">'alpha'</span><span class="s4">, </span><span class="s7">'|S1'</span><span class="s4">), (</span><span class="s7">'num'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">)]</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s5">2</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s5">3</span><span class="s4">)], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ndtype</span><span class="s4">)</span>
        <span class="s1">rdata </span><span class="s4">= </span><span class="s1">data</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">MaskedRecords</span><span class="s4">)</span>
        <span class="s1">val </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">10</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">30</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>

        <span class="s1">rdata</span><span class="s4">[</span><span class="s7">'num'</span><span class="s4">] = </span><span class="s1">val</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">num</span><span class="s4">, </span><span class="s1">val</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">num</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_set_fields_mask</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests setting the mask of a field.</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s0"># This one has already a mask....</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">][-</span><span class="s5">2</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s0"># This one has not yet</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">fromarrays</span><span class="s4">([</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s5">5</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s5">5</span><span class="s4">)],</span>
                           <span class="s1">dtype</span><span class="s4">=[(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">)])</span>
        <span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">][-</span><span class="s5">2</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_set_mask</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s0"># Set the mask to True .......................</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">getmaskarray</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">]), [</span><span class="s5">1</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'c'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
                     <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)]*</span><span class="s5">5</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">))</span>
        <span class="s0"># Delete the mask ............................</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s1">nomask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">getmaskarray</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'c'</span><span class="s4">]), [</span><span class="s5">0</span><span class="s4">]*</span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
                     <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)]*</span><span class="s5">5</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_set_mask_fromarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s0"># Sets the mask w/ an array</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s0"># Yay, once more !</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_set_mask_fromfields</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">().</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>

        <span class="s1">nmask </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span>
            <span class="s4">[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)],</span>
            <span class="s1">dtype</span><span class="s4">=[(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">)])</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s1">nmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s0"># Reinitialize and redo</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">fieldmask </span><span class="s4">= </span><span class="s1">nmask</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_set_elements</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s0"># Set an element to mask .....................</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">).</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase</span><span class="s4">[-</span><span class="s5">2</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span>
            <span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
                     <span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">))</span>
        <span class="s0"># Used to be mask, now it's recordmask!</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">recordmask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s0"># Set slices .................................</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">).</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">] = (</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">5.</span><span class="s4">, </span><span class="s5">5.</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">,</span>
                     <span class="s4">[</span><span class="s6">b'5'</span><span class="s4">, </span><span class="s6">b'5'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">, </span><span class="s6">b'four'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">).</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase</span><span class="s4">[:</span><span class="s5">2</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">4.4</span><span class="s4">, </span><span class="s5">5.5</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">,</span>
                     <span class="s4">[</span><span class="s6">b'one'</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">, </span><span class="s6">b'four'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_setslices_hardmask</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests setting slices w/ hardmask.</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">harden_mask</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">mbase</span><span class="s4">[-</span><span class="s5">2</span><span class="s4">:] = (</span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">)</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s4">])</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, [</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5.5</span><span class="s4">])</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">,</span>
                         <span class="s4">[</span><span class="s6">b'one'</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">, </span><span class="s6">b'5'</span><span class="s4">, </span><span class="s6">b'five'</span><span class="s4">])</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">a</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">b</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">NotImplementedError</span><span class="s4">:</span>
            <span class="s0"># OK, not implemented yet...</span>
            <span class="s3">pass</span>
        <span class="s3">except </span><span class="s1">AssertionError</span><span class="s4">:</span>
            <span class="s3">raise</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">Exception</span><span class="s4">(</span><span class="s7">&quot;Flexible hard masks should be supported !&quot;</span><span class="s4">)</span>
        <span class="s0"># Not using a tuple should crash</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">mbase</span><span class="s4">[-</span><span class="s5">2</span><span class="s4">:] = </span><span class="s5">3</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">NotImplementedError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s7">&quot;Should have expected a readable buffer object!&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_hardmask</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test hardmask</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mbase </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">harden_mask</span><span class="s4">()</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_hardmask</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s1">nomask</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">base</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">soften_mask</span><span class="s4">()</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s3">not </span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_hardmask</span><span class="s4">)</span>
        <span class="s1">mbase</span><span class="s4">.</span><span class="s1">mask </span><span class="s4">= </span><span class="s1">nomask</span>
        <span class="s0"># So, the mask of a field is no longer set to nomask...</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">,</span>
                             <span class="s1">ma</span><span class="s4">.</span><span class="s1">make_mask_none</span><span class="s4">(</span><span class="s1">base</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">base</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">ma</span><span class="s4">.</span><span class="s1">make_mask</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">) </span><span class="s3">is </span><span class="s1">nomask</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mbase</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">].</span><span class="s1">_mask</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pickling</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test pickling</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">mrec </span><span class="s4">= </span><span class="s1">base</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">mrecarray</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">proto </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">pickle</span><span class="s4">.</span><span class="s1">HIGHEST_PROTOCOL </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">):</span>
            <span class="s1">_ </span><span class="s4">= </span><span class="s1">pickle</span><span class="s4">.</span><span class="s1">dumps</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">protocol</span><span class="s4">=</span><span class="s1">proto</span><span class="s4">)</span>
            <span class="s1">mrec_ </span><span class="s4">= </span><span class="s1">pickle</span><span class="s4">.</span><span class="s1">loads</span><span class="s4">(</span><span class="s1">_</span><span class="s4">)</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrec_</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
            <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mrec_</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrec_</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
            <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mrec_</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_filled</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test filling the array</span>
        <span class="s1">_a </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">_b </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">)</span>
        <span class="s1">_c </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">'one'</span><span class="s4">, </span><span class="s7">'two'</span><span class="s4">, </span><span class="s7">'three'</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s7">'|S8'</span><span class="s4">)</span>
        <span class="s1">ddtype </span><span class="s4">= [(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s7">'|S8'</span><span class="s4">)]</span>
        <span class="s1">mrec </span><span class="s4">= </span><span class="s1">fromarrays</span><span class="s4">([</span><span class="s1">_a</span><span class="s4">, </span><span class="s1">_b</span><span class="s4">, </span><span class="s1">_c</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">,</span>
                          <span class="s1">fill_value</span><span class="s4">=(</span><span class="s5">99999</span><span class="s4">, </span><span class="s5">99999.</span><span class="s4">, </span><span class="s7">'N/A'</span><span class="s4">))</span>
        <span class="s1">mrecfilled </span><span class="s4">= </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">()</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrecfilled</span><span class="s4">[</span><span class="s7">'a'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">((</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">99999</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrecfilled</span><span class="s4">[</span><span class="s7">'b'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">((</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">99999.</span><span class="s4">),</span>
                                               <span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrecfilled</span><span class="s4">[</span><span class="s7">'c'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">((</span><span class="s7">'one'</span><span class="s4">, </span><span class="s7">'two'</span><span class="s4">, </span><span class="s7">'N/A'</span><span class="s4">),</span>
                                               <span class="s1">dtype</span><span class="s4">=</span><span class="s7">'|S8'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_tolist</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test tolist.</span>
        <span class="s1">_a </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">_b </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">)</span>
        <span class="s1">_c </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">'one'</span><span class="s4">, </span><span class="s7">'two'</span><span class="s4">, </span><span class="s7">'three'</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s7">'|S8'</span><span class="s4">)</span>
        <span class="s1">ddtype </span><span class="s4">= [(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s7">'|S8'</span><span class="s4">)]</span>
        <span class="s1">mrec </span><span class="s4">= </span><span class="s1">fromarrays</span><span class="s4">([</span><span class="s1">_a</span><span class="s4">, </span><span class="s1">_b</span><span class="s4">, </span><span class="s1">_c</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">,</span>
                          <span class="s1">fill_value</span><span class="s4">=(</span><span class="s5">99999</span><span class="s4">, </span><span class="s5">99999.</span><span class="s4">, </span><span class="s7">'N/A'</span><span class="s4">))</span>

        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(),</span>
                     <span class="s4">[(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s3">None</span><span class="s4">), (</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">),</span>
                      <span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">)])</span>

    <span class="s3">def </span><span class="s1">test_withnames</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test the creation w/ format and names</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">mrecarray</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">formats</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">names</span><span class="s4">=</span><span class="s7">'base'</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s5">0</span><span class="s4">][</span><span class="s7">'base'</span><span class="s4">] = </span><span class="s5">10</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">x</span><span class="s4">[</span><span class="s7">'base'</span><span class="s4">][</span><span class="s5">0</span><span class="s4">], </span><span class="s5">10</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_exotic_formats</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test that 'exotic' formats are processed properly</span>
        <span class="s1">easy </span><span class="s4">= </span><span class="s1">mrecarray</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=[(</span><span class="s7">'i'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'s'</span><span class="s4">, </span><span class="s7">'|S8'</span><span class="s4">), (</span><span class="s7">'f'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">)])</span>
        <span class="s1">easy</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">easy</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">(</span><span class="s5">1</span><span class="s4">).</span><span class="s1">item</span><span class="s4">(), (</span><span class="s5">1</span><span class="s4">, </span><span class="s6">b'1'</span><span class="s4">, </span><span class="s5">1.</span><span class="s4">))</span>

        <span class="s1">solo </span><span class="s4">= </span><span class="s1">mrecarray</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=[(</span><span class="s7">'f0'</span><span class="s4">, </span><span class="s7">'&lt;f8'</span><span class="s4">, (</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">))])</span>
        <span class="s1">solo</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">solo</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">(</span><span class="s5">1</span><span class="s4">).</span><span class="s1">item</span><span class="s4">(),</span>
                     <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">((</span><span class="s5">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">solo</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">).</span><span class="s1">item</span><span class="s4">())</span>

        <span class="s1">mult </span><span class="s4">= </span><span class="s1">mrecarray</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s7">&quot;i4, (2,3)float, float&quot;</span><span class="s4">)</span>
        <span class="s1">mult</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] = </span><span class="s1">masked</span>
        <span class="s1">mult</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] = (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)</span>
        <span class="s1">mult</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">mult</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">(</span><span class="s5">0</span><span class="s4">),</span>
                             <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
                                      <span class="s1">dtype</span><span class="s4">=</span><span class="s1">mult</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestView</span><span class="s4">:</span>

    <span class="s3">def </span><span class="s1">setup_method</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">) = (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s5">10</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s5">10</span><span class="s4">))</span>
        <span class="s1">ndtype </span><span class="s4">= [(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">)]</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">)), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ndtype</span><span class="s4">)</span>

        <span class="s1">mrec </span><span class="s4">= </span><span class="s1">fromarrays</span><span class="s4">([</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ndtype</span><span class="s4">, </span><span class="s1">fill_value</span><span class="s4">=(-</span><span class="s5">9.</span><span class="s4">, -</span><span class="s5">99.</span><span class="s4">))</span>
        <span class="s1">mrec</span><span class="s4">.</span><span class="s1">mask</span><span class="s4">[</span><span class="s5">3</span><span class="s4">] = (</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= (</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_view_by_itself</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s4">= </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">view</span><span class="s4">()</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">MaskedRecords</span><span class="s4">))</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">test</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_view_simple_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">ntype </span><span class="s4">= (</span><span class="s1">float</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
        <span class="s1">test </span><span class="s4">= </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">ntype</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">MaskedArray</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">)), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">test</span><span class="s4">[</span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s4">] </span><span class="s3">is </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">masked</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_view_flexible_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">alttype </span><span class="s4">= [(</span><span class="s7">'A'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'B'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">)]</span>
        <span class="s1">test </span><span class="s4">= </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">alttype</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">MaskedRecords</span><span class="s4">))</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">test</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">view</span><span class="s4">(</span><span class="s1">alttype</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">test</span><span class="s4">[</span><span class="s7">'B'</span><span class="s4">][</span><span class="s5">3</span><span class="s4">] </span><span class="s3">is </span><span class="s1">masked</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">test</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s1">alttype</span><span class="s4">))</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">test</span><span class="s4">.</span><span class="s1">_fill_value </span><span class="s3">is None</span><span class="s4">)</span>


<span class="s0">##############################################################################</span>
<span class="s3">class </span><span class="s1">TestMRecordsImport</span><span class="s4">:</span>

    <span class="s1">_a </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
    <span class="s1">_b </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">)</span>
    <span class="s1">_c </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">b'one'</span><span class="s4">, </span><span class="s6">b'two'</span><span class="s4">, </span><span class="s6">b'three'</span><span class="s4">],</span>
                  <span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s7">'|S8'</span><span class="s4">)</span>
    <span class="s1">ddtype </span><span class="s4">= [(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'c'</span><span class="s4">, </span><span class="s7">'|S8'</span><span class="s4">)]</span>
    <span class="s1">mrec </span><span class="s4">= </span><span class="s1">fromarrays</span><span class="s4">([</span><span class="s1">_a</span><span class="s4">, </span><span class="s1">_b</span><span class="s4">, </span><span class="s1">_c</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">,</span>
                      <span class="s1">fill_value</span><span class="s4">=(</span><span class="s6">b'99999'</span><span class="s4">, </span><span class="s6">b'99999.'</span><span class="s4">,</span>
                                  <span class="s6">b'N/A'</span><span class="s4">))</span>
    <span class="s1">nrec </span><span class="s4">= </span><span class="s1">recfromarrays</span><span class="s4">((</span><span class="s1">_a</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">_b</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">_c</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">)</span>
    <span class="s1">data </span><span class="s4">= (</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">nrec</span><span class="s4">, </span><span class="s1">ddtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fromarrays</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">_a </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">_b </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1.1</span><span class="s4">, </span><span class="s5">2.2</span><span class="s4">, </span><span class="s5">3.3</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">)</span>
        <span class="s1">_c </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">'one'</span><span class="s4">, </span><span class="s7">'two'</span><span class="s4">, </span><span class="s7">'three'</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s7">'|S8'</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">nrec</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s3">for </span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">l</span><span class="s4">) </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">((</span><span class="s7">'a'</span><span class="s4">, </span><span class="s7">'b'</span><span class="s4">, </span><span class="s7">'c'</span><span class="s4">), (</span><span class="s1">_a</span><span class="s4">, </span><span class="s1">_b</span><span class="s4">, </span><span class="s1">_c</span><span class="s4">)):</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">f</span><span class="s4">).</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">l</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s0"># One record only</span>
        <span class="s1">_x </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1.1</span><span class="s4">, </span><span class="s7">'one'</span><span class="s4">], </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">fromarrays</span><span class="s4">(</span><span class="s1">_x</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">), </span><span class="s1">mrec</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_fromrecords</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Test construction from records.</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">nrec</span><span class="s4">, </span><span class="s1">ddtype</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s0">#......</span>
        <span class="s1">palist </span><span class="s4">= [(</span><span class="s5">1</span><span class="s4">, </span><span class="s7">'abc'</span><span class="s4">, </span><span class="s5">3.7000002861022949</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
                  <span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s7">'xy'</span><span class="s4">, </span><span class="s5">6.6999998092651367</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
                  <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s7">' '</span><span class="s4">, </span><span class="s5">0.40000000596046448</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)]</span>
        <span class="s1">pa </span><span class="s4">= </span><span class="s1">recfromrecords</span><span class="s4">(</span><span class="s1">palist</span><span class="s4">, </span><span class="s1">names</span><span class="s4">=</span><span class="s7">'c1, c2, c3, c4'</span><span class="s4">)</span>
        <span class="s1">mpa </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">palist</span><span class="s4">, </span><span class="s1">names</span><span class="s4">=</span><span class="s7">'c1, c2, c3, c4'</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">pa</span><span class="s4">, </span><span class="s1">mpa</span><span class="s4">)</span>
        <span class="s0">#.....</span>
        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">names</span><span class="s4">:</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">, </span><span class="s1">field</span><span class="s4">), </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">field</span><span class="s4">))</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">names</span><span class="s4">=</span><span class="s7">'c1,c2,c3'</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, [(</span><span class="s7">'c1'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'c2'</span><span class="s4">, </span><span class="s1">float</span><span class="s4">), (</span><span class="s7">'c3'</span><span class="s4">, </span><span class="s7">'|S5'</span><span class="s4">)])</span>
        <span class="s3">for </span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">n</span><span class="s4">) </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">((</span><span class="s7">'c1'</span><span class="s4">, </span><span class="s7">'c2'</span><span class="s4">, </span><span class="s7">'c3'</span><span class="s4">), (</span><span class="s7">'a'</span><span class="s4">, </span><span class="s7">'b'</span><span class="s4">, </span><span class="s7">'c'</span><span class="s4">)):</span>
            <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">, </span><span class="s1">f</span><span class="s4">), </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">n</span><span class="s4">))</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">filled</span><span class="s4">())</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fromrecords_wmask</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests construction from records w/ mask.</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">nrec</span><span class="s4">, </span><span class="s1">ddtype</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,])</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), [(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)])</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), [(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)])</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">)</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">())</span>

        <span class="s1">_mrec </span><span class="s4">= </span><span class="s1">fromrecords</span><span class="s4">(</span><span class="s1">nrec</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">ddtype</span><span class="s4">,</span>
                            <span class="s1">mask</span><span class="s4">=</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">())</span>
        <span class="s1">assert_equal_records</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">, </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">_mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">(), </span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">.</span><span class="s1">tolist</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">test_fromtextfile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests reading from a text file.</span>
        <span class="s1">fcontent </span><span class="s4">= (</span>
<span class="s7">&quot;&quot;&quot;# 
'One (S)','Two (I)','Three (F)','Four (M)','Five (-)','Six (C)' 
'strings',1,1.0,'mixed column',,1 
'with embedded &quot;double quotes&quot;',2,2.0,1.0,,1 
'strings',3,3.0E5,3,,1 
'strings',4,-1e-10,,,1 
&quot;&quot;&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">temppath</span><span class="s4">() </span><span class="s3">as </span><span class="s1">path</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s7">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">fcontent</span><span class="s4">)</span>
            <span class="s1">mrectxt </span><span class="s4">= </span><span class="s1">fromtextfile</span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s1">delimiter</span><span class="s4">=</span><span class="s7">','</span><span class="s4">, </span><span class="s1">varnames</span><span class="s4">=</span><span class="s7">'ABCDEFG'</span><span class="s4">)</span>
        <span class="s1">assert_</span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mrectxt</span><span class="s4">, </span><span class="s1">MaskedRecords</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrectxt</span><span class="s4">.</span><span class="s1">F</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrectxt</span><span class="s4">.</span><span class="s1">E</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrectxt</span><span class="s4">.</span><span class="s1">C</span><span class="s4">, [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3.e+5</span><span class="s4">, -</span><span class="s5">1e-10</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_addfield</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Tests addfield</span>
        <span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">nrec</span><span class="s4">, </span><span class="s1">ddtype</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">m</span><span class="s4">) = ([</span><span class="s5">100</span><span class="s4">, </span><span class="s5">200</span><span class="s4">, </span><span class="s5">300</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">mrec </span><span class="s4">= </span><span class="s1">addfield</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">, </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">mask</span><span class="s4">=</span><span class="s1">m</span><span class="s4">))</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">f3</span><span class="s4">, </span><span class="s1">d</span><span class="s4">)</span>
        <span class="s1">assert_equal</span><span class="s4">(</span><span class="s1">mrec</span><span class="s4">.</span><span class="s1">f3</span><span class="s4">.</span><span class="s1">_mask</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_record_array_with_object_field</span><span class="s4">():</span>
    <span class="s0"># Trac #1839</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">ma</span><span class="s4">.</span><span class="s1">masked_array</span><span class="s4">(</span>
        <span class="s4">[(</span><span class="s5">1</span><span class="s4">, </span><span class="s7">'2'</span><span class="s4">), (</span><span class="s5">3</span><span class="s4">, </span><span class="s7">'4'</span><span class="s4">)],</span>
        <span class="s1">mask</span><span class="s4">=[(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)],</span>
        <span class="s1">dtype</span><span class="s4">=[(</span><span class="s7">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s7">'b'</span><span class="s4">, </span><span class="s1">object</span><span class="s4">)])</span>
    <span class="s0"># getting an item used to fail</span>
    <span class="s1">y</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
</pre>
</body>
</html>