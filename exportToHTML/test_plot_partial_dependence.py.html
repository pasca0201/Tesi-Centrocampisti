<html>
<head>
<title>test_plot_partial_dependence.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_plot_partial_dependence.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">mstats </span><span class="s0">import </span><span class="s1">mquantiles</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">compose </span><span class="s0">import </span><span class="s1">make_column_transformer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">load_diabetes</span><span class="s2">,</span>
    <span class="s1">load_iris</span><span class="s2">,</span>
    <span class="s1">make_classification</span><span class="s2">,</span>
    <span class="s1">make_regression</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s1">GradientBoostingClassifier</span><span class="s2">, </span><span class="s1">GradientBoostingRegressor</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">inspection </span><span class="s0">import </span><span class="s1">PartialDependenceDisplay</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LinearRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">OneHotEncoder</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">_convert_container</span>

<span class="s3"># TODO: Remove when https://github.com/numpy/numpy/issues/14397 is resolved</span>
<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s2">(</span>
        <span class="s4">&quot;ignore:In future, it will be an error for 'np.bool_':DeprecationWarning:&quot;</span>
        <span class="s4">&quot;matplotlib.*&quot;</span>
    <span class="s2">),</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;module&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">diabetes</span><span class="s2">():</span>
    <span class="s3"># diabetes dataset, subsampled for speed</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">load_diabetes</span><span class="s2">()</span>
    <span class="s1">data</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[:</span><span class="s5">50</span><span class="s2">]</span>
    <span class="s1">data</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">target</span><span class="s2">[:</span><span class="s5">50</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">data</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;module&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">clf_diabetes</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GradientBoostingRegressor</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">clf</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;grid_resolution&quot;</span><span class="s2">, [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence</span><span class="s2">(</span><span class="s1">grid_resolution</span><span class="s2">, </span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s3"># Test partial dependence plot function.</span>
    <span class="s3"># Use columns 0 &amp; 2 as 1 is not quantitative (sex)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">contour_kw</span><span class="s2">={</span><span class="s4">&quot;cmap&quot;</span><span class="s2">: </span><span class="s4">&quot;jet&quot;</span><span class="s2">},</span>
    <span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_axes</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">fig</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">) == </span><span class="s5">4</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bounding_ax_ </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] </span><span class="s0">is None</span>

    <span class="s3"># deciles lines: always show on xaxis, only show on yaxis if 2-way PDP</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">] </span><span class="s0">is not None</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">features </span><span class="s2">== [(</span><span class="s5">0</span><span class="s2">,), (</span><span class="s5">2</span><span class="s2">,), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">feature_names </span><span class="s2">== </span><span class="s1">feature_names</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles</span><span class="s2">) == </span><span class="s5">2</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
            <span class="s1">mquantiles</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">prob</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">)),</span>
        <span class="s2">)</span>

    <span class="s1">single_feature_positions </span><span class="s2">= [(</span><span class="s5">0</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)), (</span><span class="s5">2</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))]</span>
    <span class="s1">expected_ylabels </span><span class="s2">= [</span><span class="s4">&quot;Partial dependence&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">feat_col</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">single_feature_positions</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s1">expected_ylabels</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">[</span><span class="s1">feat_col</span><span class="s2">]</span>

        <span class="s1">line </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">]</span>

        <span class="s1">avg_preds </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">avg_preds</span><span class="s2">.</span><span class="s1">average</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s1">grid_resolution</span><span class="s2">)</span>
        <span class="s1">target_idx </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">target_idx</span>

        <span class="s1">line_data </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">[</span><span class="s4">&quot;grid_values&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">.</span><span class="s1">average</span><span class="s2">[</span><span class="s1">target_idx</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s3"># two feature position</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">coutour </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">coutour</span><span class="s2">.</span><span class="s1">get_cmap</span><span class="s2">().</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;jet&quot;</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;kind, centered, subsample, shape&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;average&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">50</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">51</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">21</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">25</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">26</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;average&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">50</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">51</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">21</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_kind</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">kind</span><span class="s2">,</span>
    <span class="s1">centered</span><span class="s2">,</span>
    <span class="s1">subsample</span><span class="s2">,</span>
    <span class="s1">shape</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">centered</span><span class="s2">=</span><span class="s1">centered</span><span class="s2">,</span>
        <span class="s1">subsample</span><span class="s2">=</span><span class="s1">subsample</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">] </span><span class="s0">is None</span>

    <span class="s0">if </span><span class="s1">centered</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">ln</span><span class="s2">.</span><span class="s1">_y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">0.0 </span><span class="s0">for </span><span class="s1">ln </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">() </span><span class="s0">if </span><span class="s1">ln </span><span class="s0">is not None</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">ln</span><span class="s2">.</span><span class="s1">_y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] != </span><span class="s5">0.0 </span><span class="s0">for </span><span class="s1">ln </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">() </span><span class="s0">if </span><span class="s1">ln </span><span class="s0">is not None</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;input_type, feature_names_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s4">&quot;list&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;list&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;array&quot;</span><span class="s2">, </span><span class="s4">&quot;list&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;array&quot;</span><span class="s2">, </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s4">&quot;series&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;series&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;array&quot;</span><span class="s2">, </span><span class="s4">&quot;series&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;array&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_str_features</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
    <span class="s1">input_type</span><span class="s2">,</span>
    <span class="s1">feature_names_type</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">if </span><span class="s1">input_type </span><span class="s2">== </span><span class="s4">&quot;dataframe&quot;</span><span class="s2">:</span>
        <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">input_type </span><span class="s2">== </span><span class="s4">&quot;list&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s0">if </span><span class="s1">feature_names_type </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">feature_names </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">, </span><span class="s1">feature_names_type</span><span class="s2">)</span>

    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s3"># check with str features and array feature names and single column</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s2">[(</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">), </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">n_cols</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">line_kw</span><span class="s2">={</span><span class="s4">&quot;alpha&quot;</span><span class="s2">: </span><span class="s5">0.8</span><span class="s2">},</span>
    <span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_axes</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">) == </span><span class="s5">3</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">fig</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] </span><span class="s0">is not None</span>

    <span class="s3"># line</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">&quot;bmi&quot;</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;Partial dependence&quot;</span>

    <span class="s1">line </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">avg_preds </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">target_idx </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">target_idx</span>
    <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_alpha</span><span class="s2">() == </span><span class="s5">0.8</span>

    <span class="s1">line_data </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">[</span><span class="s4">&quot;grid_values&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">.</span><span class="s1">average</span><span class="s2">[</span><span class="s1">target_idx</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s3"># contour</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">&quot;age&quot;</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;bmi&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_custom_axes</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, (</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">)],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">ax</span><span class="s2">=[</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig </span><span class="s0">is </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bounding_ax_ </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">,)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">ax1</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">ax2</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">&quot;age&quot;</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;Partial dependence&quot;</span>

    <span class="s1">line </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">avg_preds </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">target_idx </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">target_idx</span>

    <span class="s1">line_data </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">[</span><span class="s4">&quot;grid_values&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line_data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">avg_preds</span><span class="s2">.</span><span class="s1">average</span><span class="s2">[</span><span class="s1">target_idx</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s3"># contour</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">&quot;age&quot;</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;bmi&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;kind, lines&quot;</span><span class="s2">, [(</span><span class="s4">&quot;average&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s5">50</span><span class="s2">), (</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s5">51</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_passing_numpy_axes</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">, </span><span class="s1">lines</span>
<span class="s2">):</span>
    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span>
    <span class="s1">disp1 </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;Partial dependence&quot;</span>
    <span class="s0">assert </span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">].</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_lines</span><span class="s2">()) == </span><span class="s1">lines</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">].</span><span class="s1">get_lines</span><span class="s2">()) == </span><span class="s1">lines</span>

    <span class="s1">lr </span><span class="s2">= </span><span class="s1">LinearRegression</span><span class="s2">()</span>
    <span class="s1">lr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>

    <span class="s1">disp2 </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">lr</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">ax</span><span class="s2">=</span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">axes_ </span><span class="s2">== </span><span class="s1">disp2</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">disp2</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_lines</span><span class="s2">()) == </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">lines</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">disp2</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">].</span><span class="s1">get_lines</span><span class="s2">()) == </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">lines</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;nrows, ncols&quot;</span><span class="s2">, [(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_incorrent_num_axes</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">nrows</span><span class="s2">, </span><span class="s1">ncols</span>
<span class="s2">):</span>
    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axes </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">nrows</span><span class="s2">, </span><span class="s1">ncols</span><span class="s2">)</span>
    <span class="s1">axes_formats </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">axes</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()), </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">axes</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()), </span><span class="s1">axes</span><span class="s2">]</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Expected ax to have 2 axes, got {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">nrows </span><span class="s2">* </span><span class="s1">ncols</span><span class="s2">)</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ax_format </span><span class="s0">in </span><span class="s1">axes_formats</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
                <span class="s1">clf_diabetes</span><span class="s2">,</span>
                <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
                <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
                <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
                <span class="s1">ax</span><span class="s2">=</span><span class="s1">ax_format</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s3"># with axes object</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax_format</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_with_same_axes</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s3"># The first call to plot_partial_dependence will create two new axes to</span>
    <span class="s3"># place in the space of the passed in axes, which results in a total of</span>
    <span class="s3"># three axes in the figure.</span>
    <span class="s3"># Currently the API does not allow for the second call to</span>
    <span class="s3"># plot_partial_dependence to use the same axes again, because it will</span>
    <span class="s3"># create two new axes in the space resulting in five axes. To get the</span>
    <span class="s3"># expected behavior one needs to pass the generated axes into the second</span>
    <span class="s3"># call:</span>
    <span class="s3"># disp1 = plot_partial_dependence(...)</span>
    <span class="s3"># disp2 = plot_partial_dependence(..., ax=disp1.axes_)</span>

    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;The ax was already used in another plot function, please set &quot;</span>
        <span class="s4">&quot;ax=display.axes_ instead&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
            <span class="s1">clf_diabetes</span><span class="s2">,</span>
            <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
            <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
            <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
            <span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_feature_name_reuse</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s3"># second call to plot does not change the feature names from the first</span>
    <span class="s3"># call</span>

    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()):</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s1">feature_names</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_multiclass</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">clf_int </span><span class="s2">= </span><span class="s1">GradientBoostingClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">iris </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">()</span>

    <span class="s3"># Test partial dependence plot function on multi-class input.</span>
    <span class="s1">clf_int</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
    <span class="s1">disp_target_0 </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_int</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">target</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is None for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">target_idx </span><span class="s2">== </span><span class="s5">0</span>

    <span class="s3"># now with symbol labels</span>
    <span class="s1">target </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target_names</span><span class="s2">[</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">]</span>
    <span class="s1">clf_symbol </span><span class="s2">= </span><span class="s1">GradientBoostingClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">clf_symbol</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">target</span><span class="s2">)</span>
    <span class="s1">disp_symbol </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_symbol</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">target</span><span class="s2">=</span><span class="s4">&quot;setosa&quot;</span><span class="s2">, </span><span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is None for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">target_idx </span><span class="s2">== </span><span class="s5">0</span>

    <span class="s0">for </span><span class="s1">int_result</span><span class="s2">, </span><span class="s1">symbol_result </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
        <span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">, </span><span class="s1">disp_symbol</span><span class="s2">.</span><span class="s1">pd_results</span>
    <span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">int_result</span><span class="s2">.</span><span class="s1">average</span><span class="s2">, </span><span class="s1">symbol_result</span><span class="s2">.</span><span class="s1">average</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">int_result</span><span class="s2">[</span><span class="s4">&quot;grid_values&quot;</span><span class="s2">], </span><span class="s1">symbol_result</span><span class="s2">[</span><span class="s4">&quot;grid_values&quot;</span><span class="s2">])</span>

    <span class="s3"># check that the pd plots are different for another target</span>
    <span class="s1">disp_target_1 </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_int</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">target</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span>
    <span class="s2">)</span>
    <span class="s1">target_0_data_y </span><span class="s2">= </span><span class="s1">disp_target_0</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_data</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">target_1_data_y </span><span class="s2">= </span><span class="s1">disp_target_1</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_data</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">target_0_data_y </span><span class="s2">!= </span><span class="s1">target_1_data_y</span><span class="s2">)</span>


<span class="s1">multioutput_regression_data </span><span class="s2">= </span><span class="s1">make_regression</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s5">50</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;target&quot;</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_multioutput</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">target</span><span class="s2">):</span>
    <span class="s3"># Test partial dependence plot function on multi-output input.</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">multioutput_regression_data</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">LinearRegression</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span>
    <span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_axes</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">) == </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">target_idx </span><span class="s2">== </span><span class="s1">target</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bounding_ax_ </span><span class="s0">is not None</span>

    <span class="s1">positions </span><span class="s2">= [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)]</span>
    <span class="s1">expected_label </span><span class="s2">= [</span><span class="s4">&quot;Partial dependence&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">positions</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s1">expected_label</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">f&quot;x</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_dataframe</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">)</span>

    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>

    <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">df</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;bp&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">(),</span>
    <span class="s2">)</span>


<span class="s1">dummy_classification_data </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;data, params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">multioutput_regression_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;target&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">]},</span>
            <span class="s4">&quot;target must be specified for multi-output&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">multioutput_regression_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;target&quot;</span><span class="s2">: -</span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">]},</span>
            <span class="s4">r&quot;target must be in \[0, n_tasks\]&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">multioutput_regression_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;target&quot;</span><span class="s2">: </span><span class="s5">100</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">]},</span>
            <span class="s4">r&quot;target must be in \[0, n_tasks\]&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s4">&quot;foobar&quot;</span><span class="s2">], </span><span class="s4">&quot;feature_names&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">},</span>
            <span class="s4">&quot;Feature 'foobar' not in feature_names&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s4">&quot;foobar&quot;</span><span class="s2">], </span><span class="s4">&quot;feature_names&quot;</span><span class="s2">: [</span><span class="s4">&quot;abcd&quot;</span><span class="s2">, </span><span class="s4">&quot;def&quot;</span><span class="s2">]},</span>
            <span class="s4">&quot;Feature 'foobar' not in feature_names&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]},</span>
            <span class="s4">&quot;Each entry in features must be either an int, &quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, {}]},</span>
            <span class="s4">&quot;Each entry in features must be either an int, &quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s1">tuple</span><span class="s2">()]},</span>
            <span class="s4">&quot;Each entry in features must be either an int, &quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">123</span><span class="s2">], </span><span class="s4">&quot;feature_names&quot;</span><span class="s2">: [</span><span class="s4">&quot;blahblah&quot;</span><span class="s2">]},</span>
            <span class="s4">&quot;All entries of features must be less than &quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s4">&quot;feature_names&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">]},</span>
            <span class="s4">&quot;feature_names should not contain duplicates&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s4">&quot;kind&quot;</span><span class="s2">: [</span><span class="s4">&quot;both&quot;</span><span class="s2">]},</span>
            <span class="s4">&quot;When `kind` is provided as a list of strings, it should contain&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">], </span><span class="s4">&quot;subsample&quot;</span><span class="s2">: -</span><span class="s5">1</span><span class="s2">},</span>
            <span class="s4">&quot;When an integer, subsample=-1 should be positive.&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">], </span><span class="s4">&quot;subsample&quot;</span><span class="s2">: </span><span class="s5">1.2</span><span class="s2">},</span>
            <span class="s4">r&quot;When a floating-point, subsample=1.2 should be in the \(0, 1\) range&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s4">&quot;categorical_features&quot;</span><span class="s2">: [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]},</span>
            <span class="s4">&quot;Expected `categorical_features` to be an array-like of boolean,&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], </span><span class="s4">&quot;categorical_features&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">]},</span>
            <span class="s4">&quot;Two-way partial dependence plots are not supported for pairs&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">dummy_classification_data</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">], </span><span class="s4">&quot;categorical_features&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">], </span><span class="s4">&quot;kind&quot;</span><span class="s2">: </span><span class="s4">&quot;individual&quot;</span><span class="s2">},</span>
            <span class="s4">&quot;It is not possible to display individual effects&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_error</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">data</span>
    <span class="s1">estimator </span><span class="s2">= </span><span class="s1">LinearRegression</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, **</span><span class="s1">params</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s4">&quot;target&quot;</span><span class="s2">: </span><span class="s5">4</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">]}, </span><span class="s4">&quot;target not in est.classes_, got 4&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s4">&quot;target&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">]}, </span><span class="s4">&quot;target must be specified for multi-class&quot;</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;target&quot;</span><span class="s2">: </span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;features&quot;</span><span class="s2">: [</span><span class="s5">4.5</span><span class="s2">]},</span>
            <span class="s4">&quot;Each entry in features must be either an int,&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_multiclass_error</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s1">iris </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">()</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GradientBoostingClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, **</span><span class="s1">params</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_plot_partial_dependence_does_not_override_ylabel</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span>
<span class="s2">):</span>
    <span class="s3"># Non-regression test to be sure to not override the ylabel if it has been</span>
    <span class="s3"># See https://github.com/scikit-learn/scikit-learn/issues/15772</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">axes </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">&quot;Hello world&quot;</span><span class="s2">)</span>
    <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axes</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">axes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;Hello world&quot;</span>
    <span class="s0">assert </span><span class="s1">axes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;Partial dependence&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;categorical_features, array_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">], </span><span class="s4">&quot;dataframe&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_with_categorical</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">categorical_features</span><span class="s2">, </span><span class="s1">array_type</span>
<span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]]</span>
    <span class="s1">column_name </span><span class="s2">= [</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_B&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">columns_name</span><span class="s2">=</span><span class="s1">column_name</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.45</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">preprocessor </span><span class="s2">= </span><span class="s1">make_column_transformer</span><span class="s2">((</span><span class="s1">OneHotEncoder</span><span class="s2">(), </span><span class="s1">categorical_features</span><span class="s2">))</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">preprocessor</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">())</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s3"># single feature</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">model</span><span class="s2">,</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[</span><span class="s4">&quot;col_C&quot;</span><span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">column_name</span><span class="s2">,</span>
        <span class="s1">categorical_features</span><span class="s2">=</span><span class="s1">categorical_features</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bars_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bars_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_legend</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s3"># interaction between two features</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">model</span><span class="s2">,</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[(</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">)],</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">column_name</span><span class="s2">,</span>
        <span class="s1">categorical_features</span><span class="s2">=</span><span class="s1">categorical_features</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_ </span><span class="s0">is </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bars_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">bars_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_vlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">deciles_hlines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_legend</span><span class="s2">() </span><span class="s0">is None</span>


<span class="s0">def </span><span class="s1">test_plot_partial_dependence_legend</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;col_A&quot;</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;col_B&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s4">&quot;col_C&quot;</span><span class="s2">: [</span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.45</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">categorical_features </span><span class="s2">= [</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">]</span>
    <span class="s1">preprocessor </span><span class="s2">= </span><span class="s1">make_column_transformer</span><span class="s2">((</span><span class="s1">OneHotEncoder</span><span class="s2">(), </span><span class="s1">categorical_features</span><span class="s2">))</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">preprocessor</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">())</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">model</span><span class="s2">,</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[</span><span class="s4">&quot;col_B&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">],</span>
        <span class="s1">categorical_features</span><span class="s2">=</span><span class="s1">categorical_features</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=[</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;average&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">legend_text </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_legend</span><span class="s2">().</span><span class="s1">get_texts</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">legend_text</span><span class="s2">) == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">legend_text</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_text</span><span class="s2">() == </span><span class="s4">&quot;average&quot;</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">].</span><span class="s1">get_legend</span><span class="s2">() </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;kind, expected_shape&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s4">&quot;average&quot;</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)), (</span><span class="s4">&quot;individual&quot;</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)), (</span><span class="s4">&quot;both&quot;</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">21</span><span class="s2">))],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_subsampling</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">, </span><span class="s1">expected_shape</span>
<span class="s2">):</span>
    <span class="s3"># check that the subsampling is properly working</span>
    <span class="s3"># non-regression test for:</span>
    <span class="s3"># https://github.com/scikit-learn/scikit-learn/pull/18359</span>
    <span class="s1">matplotlib </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;matplotlib&quot;</span><span class="s2">)</span>
    <span class="s1">grid_resolution </span><span class="s2">= </span><span class="s5">25</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span>

    <span class="s1">disp1 </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s4">&quot;bmi&quot;</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s1">grid_resolution</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">subsample</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected_shape</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">line</span><span class="s2">, </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">lines</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">) </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">disp1</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()]</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;kind, line_kw, label&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, {}, </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;individual&quot;</span><span class="s2">, {</span><span class="s4">&quot;label&quot;</span><span class="s2">: </span><span class="s4">&quot;xxx&quot;</span><span class="s2">}, </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;average&quot;</span><span class="s2">, {}, </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;average&quot;</span><span class="s2">, {</span><span class="s4">&quot;label&quot;</span><span class="s2">: </span><span class="s4">&quot;xxx&quot;</span><span class="s2">}, </span><span class="s4">&quot;xxx&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, {}, </span><span class="s4">&quot;average&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;both&quot;</span><span class="s2">, {</span><span class="s4">&quot;label&quot;</span><span class="s2">: </span><span class="s4">&quot;xxx&quot;</span><span class="s2">}, </span><span class="s4">&quot;xxx&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_partial_dependence_overwrite_labels</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
    <span class="s1">kind</span><span class="s2">,</span>
    <span class="s1">line_kw</span><span class="s2">,</span>
    <span class="s1">label</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that make sure that we can overwrite the label of the PDP plot&quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">25</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">line_kw</span><span class="s2">=</span><span class="s1">line_kw</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">label </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_legend</span><span class="s2">() </span><span class="s0">is None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">legend_text </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_legend</span><span class="s2">().</span><span class="s1">get_texts</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">legend_text</span><span class="s2">) == </span><span class="s5">1</span>
            <span class="s0">assert </span><span class="s1">legend_text</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_text</span><span class="s2">() == </span><span class="s1">label</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;categorical_features, array_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">], </span><span class="s4">&quot;dataframe&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s4">&quot;array&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_grid_resolution_with_categorical</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">categorical_features</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise a ValueError when the grid_resolution is too small 
    respect to the number of categories in the categorical features targeted. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">], [</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">], [</span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]]</span>
    <span class="s1">column_name </span><span class="s2">= [</span><span class="s4">&quot;col_A&quot;</span><span class="s2">, </span><span class="s4">&quot;col_B&quot;</span><span class="s2">, </span><span class="s4">&quot;col_C&quot;</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">columns_name</span><span class="s2">=</span><span class="s1">column_name</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.45</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">preprocessor </span><span class="s2">= </span><span class="s1">make_column_transformer</span><span class="s2">((</span><span class="s1">OneHotEncoder</span><span class="s2">(), </span><span class="s1">categorical_features</span><span class="s2">))</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">preprocessor</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">())</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s4">&quot;resolution of the computed grid is less than the minimum number of categories&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
            <span class="s1">model</span><span class="s2">,</span>
            <span class="s1">X</span><span class="s2">,</span>
            <span class="s1">features</span><span class="s2">=[</span><span class="s4">&quot;col_C&quot;</span><span class="s2">],</span>
            <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">column_name</span><span class="s2">,</span>
            <span class="s1">categorical_features</span><span class="s2">=</span><span class="s1">categorical_features</span><span class="s2">,</span>
            <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;kind&quot;</span><span class="s2">, [</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s4">&quot;average&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;centered&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_partial_dependence_plot_limits_one_way</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">, </span><span class="s1">centered</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the PD limit on the plots are properly set on one-way plots.&quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">25</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">range_pd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">pd </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s4">&quot;average&quot; </span><span class="s0">in </span><span class="s1">pd</span><span class="s2">:</span>
            <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;average&quot;</span><span class="s2">][...] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;average&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s4">&quot;individual&quot; </span><span class="s0">in </span><span class="s1">pd</span><span class="s2">:</span>
            <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;individual&quot;</span><span class="s2">][...] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;individual&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">centered</span><span class="s2">=</span><span class="s1">centered</span><span class="s2">)</span>
    <span class="s3"># check that we anchor to zero x-axis when centering</span>
    <span class="s1">y_lim </span><span class="s2">= </span><span class="s1">range_pd </span><span class="s2">- </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">centered </span><span class="s0">else </span><span class="s1">range_pd</span>
    <span class="s1">padding </span><span class="s2">= </span><span class="s5">0.05 </span><span class="s2">* (</span><span class="s1">y_lim</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] - </span><span class="s1">y_lim</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">y_lim</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] -= </span><span class="s1">padding</span>
    <span class="s1">y_lim</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] += </span><span class="s1">padding</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">axes_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">():</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">(), </span><span class="s1">y_lim</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;centered&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_partial_dependence_plot_limits_two_way</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf_diabetes</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">centered</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the PD limit on the plots are properly set on two-way plots.&quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;average&quot;</span><span class="s2">,</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">25</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">range_pd </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">pd </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">:</span>
        <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;average&quot;</span><span class="s2">][...] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">pd</span><span class="s2">[</span><span class="s4">&quot;average&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">centered</span><span class="s2">=</span><span class="s1">centered</span><span class="s2">)</span>
    <span class="s1">contours </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">levels </span><span class="s2">= </span><span class="s1">range_pd </span><span class="s2">- </span><span class="s1">range_pd</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">centered </span><span class="s0">else </span><span class="s1">range_pd</span>

    <span class="s1">padding </span><span class="s2">= </span><span class="s5">0.05 </span><span class="s2">* (</span><span class="s1">levels</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] - </span><span class="s1">levels</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">levels</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] -= </span><span class="s1">padding</span>
    <span class="s1">levels</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] += </span><span class="s1">padding</span>
    <span class="s1">expect_levels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(*</span><span class="s1">levels</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">contours</span><span class="s2">.</span><span class="s1">levels</span><span class="s2">, </span><span class="s1">expect_levels</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_partial_dependence_kind_list</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we can provide a list of strings to kind parameter.&quot;&quot;&quot;</span>
    <span class="s1">matplotlib </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;matplotlib&quot;</span><span class="s2">)</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=[</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;average&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">line</span><span class="s2">, </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">lines</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">()</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">] </span><span class="s0">is None</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">contours_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">] </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">line </span><span class="s0">is None for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">].</span><span class="s1">ravel</span><span class="s2">()])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;features, kind&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], </span><span class="s4">&quot;individual&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], </span><span class="s4">&quot;both&quot;</span><span class="s2">),</span>
        <span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], </span><span class="s4">&quot;individual&quot;</span><span class="s2">),</span>
        <span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], </span><span class="s4">&quot;both&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], [</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s4">&quot;individual&quot;</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)], [</span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_partial_dependence_kind_error</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
    <span class="s1">features</span><span class="s2">,</span>
    <span class="s1">kind</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise an informative error when 2-way PD is requested 
    together with 1-way PD/ICE&quot;&quot;&quot;</span>
    <span class="s1">warn_msg </span><span class="s2">= (</span>
        <span class="s4">&quot;ICE plot cannot be rendered for 2-way feature interactions. 2-way &quot;</span>
        <span class="s4">&quot;feature interactions mandates PD plots using the 'average' kind&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warn_msg</span><span class="s2">):</span>
        <span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
            <span class="s1">clf_diabetes</span><span class="s2">,</span>
            <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
            <span class="s1">features</span><span class="s2">=</span><span class="s1">features</span><span class="s2">,</span>
            <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
            <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore:A Bunch will be returned&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;line_kw, pd_line_kw, ice_lines_kw, expected_colors&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;r&quot;</span><span class="s2">}, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;g&quot;</span><span class="s2">}, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">}, (</span><span class="s4">&quot;g&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s0">None</span><span class="s2">, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;g&quot;</span><span class="s2">}, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">}, (</span><span class="s4">&quot;g&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)),</span>
        <span class="s2">({</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;r&quot;</span><span class="s2">}, </span><span class="s0">None</span><span class="s2">, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">}, (</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)),</span>
        <span class="s2">({</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;r&quot;</span><span class="s2">}, {</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;g&quot;</span><span class="s2">}, </span><span class="s0">None</span><span class="s2">, (</span><span class="s4">&quot;g&quot;</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">)),</span>
        <span class="s2">({</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;r&quot;</span><span class="s2">}, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">)),</span>
        <span class="s2">({</span><span class="s4">&quot;color&quot;</span><span class="s2">: </span><span class="s4">&quot;r&quot;</span><span class="s2">}, {</span><span class="s4">&quot;linestyle&quot;</span><span class="s2">: </span><span class="s4">&quot;--&quot;</span><span class="s2">}, {</span><span class="s4">&quot;linestyle&quot;</span><span class="s2">: </span><span class="s4">&quot;-.&quot;</span><span class="s2">}, (</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_plot_partial_dependence_lines_kw</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
    <span class="s1">line_kw</span><span class="s2">,</span>
    <span class="s1">pd_line_kw</span><span class="s2">,</span>
    <span class="s1">ice_lines_kw</span><span class="s2">,</span>
    <span class="s1">expected_colors</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that passing `pd_line_kw` and `ice_lines_kw` will act on the 
    specific lines in the plot. 
    &quot;&quot;&quot;</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s1">n_cols</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;both&quot;</span><span class="s2">,</span>
        <span class="s1">line_kw</span><span class="s2">=</span><span class="s1">line_kw</span><span class="s2">,</span>
        <span class="s1">pd_line_kw</span><span class="s2">=</span><span class="s1">pd_line_kw</span><span class="s2">,</span>
        <span class="s1">ice_lines_kw</span><span class="s2">=</span><span class="s1">ice_lines_kw</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">line </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_color</span><span class="s2">() == </span><span class="s1">expected_colors</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">pd_line_kw </span><span class="s0">is not None and </span><span class="s4">&quot;linestyle&quot; </span><span class="s0">in </span><span class="s1">pd_line_kw</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_linestyle</span><span class="s2">() == </span><span class="s1">pd_line_kw</span><span class="s2">[</span><span class="s4">&quot;linestyle&quot;</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_linestyle</span><span class="s2">() == </span><span class="s4">&quot;--&quot;</span>

    <span class="s1">line </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_color</span><span class="s2">() == </span><span class="s1">expected_colors</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">ice_lines_kw </span><span class="s0">is not None and </span><span class="s4">&quot;linestyle&quot; </span><span class="s0">in </span><span class="s1">ice_lines_kw</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_linestyle</span><span class="s2">() == </span><span class="s1">ice_lines_kw</span><span class="s2">[</span><span class="s4">&quot;linestyle&quot;</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_linestyle</span><span class="s2">() == </span><span class="s4">&quot;-&quot;</span>


<span class="s0">def </span><span class="s1">test_partial_dependence_display_wrong_len_kind</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise an error when `kind` is a list with a wrong length. 
 
    This case can only be triggered using the `PartialDependenceDisplay.from_estimator` 
    method. 
    &quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s1">features</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
        <span class="s1">grid_resolution</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;average&quot;</span><span class="s2">,  </span><span class="s3"># len(kind) != len(features)</span>
    <span class="s2">)</span>

    <span class="s3"># alter `kind` to be a list with a length different from length of `features`</span>
    <span class="s1">disp</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">= [</span><span class="s4">&quot;average&quot;</span><span class="s2">]</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s4">r&quot;When `kind` is provided as a list of strings, it should contain as many&quot;</span>
        <span class="s4">r&quot; elements as `features`. `kind` contains 1 element\(s\) and `features`&quot;</span>
        <span class="s4">r&quot; contains 2 element\(s\).&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;kind&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">, </span><span class="s4">&quot;average&quot;</span><span class="s2">, [</span><span class="s4">&quot;average&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">], [</span><span class="s4">&quot;individual&quot;</span><span class="s2">, </span><span class="s4">&quot;both&quot;</span><span class="s2">]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_partial_dependence_display_kind_centered_interaction</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">kind</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we properly center ICE and PD when passing kind as a string and as a 
    list.&quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">,</span>
        <span class="s1">centered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">subsample</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">ln</span><span class="s2">.</span><span class="s1">_y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">0.0 </span><span class="s0">for </span><span class="s1">ln </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">lines_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">() </span><span class="s0">if </span><span class="s1">ln </span><span class="s0">is not None</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_partial_dependence_display_with_constant_sample_weight</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">clf_diabetes</span><span class="s2">,</span>
    <span class="s1">diabetes</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the utilization of a constant sample weight maintains the 
    standard behavior. 
    &quot;&quot;&quot;</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;average&quot;</span><span class="s2">,</span>
        <span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;brute&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">diabetes</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
    <span class="s1">disp_sw </span><span class="s2">= </span><span class="s1">PartialDependenceDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">,</span>
        <span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;average&quot;</span><span class="s2">,</span>
        <span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;brute&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span>
        <span class="s1">disp</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s4">&quot;average&quot;</span><span class="s2">], </span><span class="s1">disp_sw</span><span class="s2">.</span><span class="s1">pd_results</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s4">&quot;average&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subclass_named_constructors_return_type_is_subclass</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">diabetes</span><span class="s2">, </span><span class="s1">clf_diabetes</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that named constructors return the correct type when subclassed. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/pull/27675 
    &quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">SubclassOfDisplay</span><span class="s2">(</span><span class="s1">PartialDependenceDisplay</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s1">curve </span><span class="s2">= </span><span class="s1">SubclassOfDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">clf_diabetes</span><span class="s2">,</span>
        <span class="s1">diabetes</span><span class="s2">.</span><span class="s1">data</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)],</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">curve</span><span class="s2">, </span><span class="s1">SubclassOfDisplay</span><span class="s2">)</span>
</pre>
</body>
</html>