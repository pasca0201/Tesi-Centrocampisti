<html>
<head>
<title>test_set_output.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_set_output.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">importlib</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">_config </span><span class="s0">import </span><span class="s1">config_context</span><span class="s2">, </span><span class="s1">get_config</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">StandardScaler</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_set_output </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ADAPTERS_MANAGER</span><span class="s2">,</span>
    <span class="s1">ContainerAdapterProtocol</span><span class="s2">,</span>
    <span class="s1">_get_adapter_from_container</span><span class="s2">,</span>
    <span class="s1">_get_output_config</span><span class="s2">,</span>
    <span class="s1">_safe_set_output</span><span class="s2">,</span>
    <span class="s1">_SetOutputMixin</span><span class="s2">,</span>
    <span class="s1">_wrap_data_with_container</span><span class="s2">,</span>
    <span class="s1">check_library_installed</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span>


<span class="s0">def </span><span class="s1">test_pandas_adapter</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check pandas adapter has expected behavior.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X_np </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">&quot;f0&quot;</span><span class="s2">, </span><span class="s4">&quot;f1&quot;</span><span class="s2">, </span><span class="s4">&quot;f2&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">X_df_orig </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s1">adapter </span><span class="s2">= </span><span class="s1">ADAPTERS_MANAGER</span><span class="s2">.</span><span class="s1">adapters</span><span class="s2">[</span><span class="s4">&quot;pandas&quot;</span><span class="s2">]</span>
    <span class="s1">X_container </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_np</span><span class="s2">, </span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_container</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_container</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_container</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">index</span><span class="s2">)</span>

    <span class="s6"># Input dataframe's index does not change</span>
    <span class="s1">new_columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">&quot;f0&quot;</span><span class="s2">, </span><span class="s4">&quot;f1&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">12</span><span class="s2">])</span>
    <span class="s1">new_df </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">X_df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">is_supported_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">is_supported_container</span><span class="s2">(</span><span class="s1">X_np</span><span class="s2">)</span>

    <span class="s6"># adapter.update_columns updates the columns</span>
    <span class="s1">new_columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">new_df </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">rename_columns</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>

    <span class="s6"># adapter.hstack stacks the dataframes horizontally.</span>
    <span class="s1">X_df_1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">])</span>
    <span class="s1">X_df_2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">4</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">X_stacked </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">X_df_1</span><span class="s2">, </span><span class="s1">X_df_2</span><span class="s2">])</span>

    <span class="s1">expected_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">pd</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">X_stacked</span><span class="s2">, </span><span class="s1">expected_df</span><span class="s2">)</span>

    <span class="s6"># check that we update properly the columns even with duplicate column names</span>
    <span class="s6"># this use-case potentially happen when using ColumnTransformer</span>
    <span class="s6"># non-regression test for gh-28260</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">new_columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x__a&quot;</span><span class="s2">, </span><span class="s4">&quot;y__a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">new_df </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">rename_columns</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>

    <span class="s6"># check the behavior of the inplace parameter in `create_container`</span>
    <span class="s6"># we should trigger a copy</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">X_output </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_output </span><span class="s0">is not </span><span class="s1">X_df</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_output</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]</span>

    <span class="s6"># the operation is inplace</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">X_output </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_output </span><span class="s0">is </span><span class="s1">X_df</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_output</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_polars_adapter</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check Polars adapter has expected behavior.&quot;&quot;&quot;</span>
    <span class="s1">pl </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;polars&quot;</span><span class="s2">)</span>
    <span class="s1">X_np </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s4">&quot;f1&quot;</span><span class="s2">, </span><span class="s4">&quot;f2&quot;</span><span class="s2">, </span><span class="s4">&quot;f3&quot;</span><span class="s2">]</span>
    <span class="s1">X_df_orig </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X_np</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span><span class="s2">)</span>

    <span class="s1">adapter </span><span class="s2">= </span><span class="s1">ADAPTERS_MANAGER</span><span class="s2">.</span><span class="s1">adapters</span><span class="s2">[</span><span class="s4">&quot;polars&quot;</span><span class="s2">]</span>
    <span class="s1">X_container </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_np</span><span class="s2">, </span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_container</span><span class="s2">, </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_container</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s6"># Update columns with create_container</span>
    <span class="s1">new_columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">new_df </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">is_supported_container</span><span class="s2">(</span><span class="s1">X_df_orig</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">is_supported_container</span><span class="s2">(</span><span class="s1">X_np</span><span class="s2">)</span>

    <span class="s6"># adapter.update_columns updates the columns</span>
    <span class="s1">new_columns </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;g&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">new_df </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">rename_columns</span><span class="s2">(</span><span class="s1">X_df_orig</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">new_columns</span><span class="s2">)</span>

    <span class="s6"># adapter.hstack stacks the dataframes horizontally.</span>
    <span class="s1">X_df_1 </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]], </span><span class="s1">schema</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">], </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span><span class="s2">)</span>
    <span class="s1">X_df_2 </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">4</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">]], </span><span class="s1">schema</span><span class="s2">=[</span><span class="s4">&quot;c&quot;</span><span class="s2">], </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span><span class="s2">)</span>
    <span class="s1">X_stacked </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">X_df_1</span><span class="s2">, </span><span class="s1">X_df_2</span><span class="s2">])</span>

    <span class="s1">expected_df </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]], </span><span class="s1">schema</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">], </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">polars</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_frame_equal</span>

    <span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">X_stacked</span><span class="s2">, </span><span class="s1">expected_df</span><span class="s2">)</span>

    <span class="s6"># check the behavior of the inplace parameter in `create_container`</span>
    <span class="s6"># we should trigger a copy</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">schema</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span><span class="s2">)</span>
    <span class="s1">X_output </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">], </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_output </span><span class="s0">is not </span><span class="s1">X_df</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_output</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">]</span>

    <span class="s6"># the operation is inplace</span>
    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">schema</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s1">orient</span><span class="s2">=</span><span class="s4">&quot;row&quot;</span><span class="s2">)</span>
    <span class="s1">X_output </span><span class="s2">= </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">create_container</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">X_df</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">], </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_output </span><span class="s0">is </span><span class="s1">X_df</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">X_output</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test__container_error_validation</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check errors in _wrap_data_with_container.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">match </span><span class="s2">= </span><span class="s4">&quot;The transformer outputs a scipy sparse matrix.&quot;</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">transform_output</span><span class="s2">=</span><span class="s4">&quot;pandas&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">_wrap_data_with_container</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">StandardScaler</span><span class="s2">())</span>


<span class="s0">class </span><span class="s1">EstimatorWithoutSetOutputAndWithoutTransform</span><span class="s2">:</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">EstimatorNoSetOutputWithTransform</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X  </span><span class="s6"># pragma: no cover</span>


<span class="s0">class </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s0">def </span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_features</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">f&quot;X</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__safe_set_output</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check _safe_set_output works as expected.&quot;&quot;&quot;</span>

    <span class="s6"># Estimator without transform will not raise when setting set_output for transform.</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithoutSetOutputAndWithoutTransform</span><span class="s2">()</span>
    <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s6"># Estimator with transform but without set_output will raise</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorNoSetOutputWithTransform</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unable to configure output&quot;</span><span class="s2">):</span>
        <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]))</span>
    <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s4">&quot;pandas&quot;</span>

    <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;default&quot;</span><span class="s2">)</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s4">&quot;default&quot;</span>

    <span class="s6"># transform is None is a no-op, so the config remains &quot;default&quot;</span>
    <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s4">&quot;default&quot;</span>


<span class="s0">class </span><span class="s1">EstimatorNoSetOutputWithTransformNoFeatureNamesOut</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X  </span><span class="s6"># pragma: no cover</span>


<span class="s0">def </span><span class="s1">test_set_output_mixin</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Estimator without get_feature_names_out does not define `set_output`.&quot;&quot;&quot;</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorNoSetOutputWithTransformNoFeatureNamesOut</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s4">&quot;set_output&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__safe_set_output_error</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check transform with invalid config.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">()</span>
    <span class="s1">_safe_set_output</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;bad&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;output config must be in&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dataframe_lib&quot;</span><span class="s2">, [</span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s4">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_set_output_method</span><span class="s2">(</span><span class="s1">dataframe_lib</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check that the output is a dataframe.&quot;&quot;&quot;</span>
    <span class="s1">lib </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s1">dataframe_lib</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s6"># transform=None is a no-op</span>
    <span class="s1">est2 </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est2 </span><span class="s0">is </span><span class="s1">est</span>
    <span class="s1">X_trans_np </span><span class="s2">= </span><span class="s1">est2</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_trans_np</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

    <span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s1">dataframe_lib</span><span class="s2">)</span>

    <span class="s1">X_trans_pd </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_trans_pd</span><span class="s2">, </span><span class="s1">lib</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_output_method_error</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check transform fails with invalid transform.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;bad&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;output config must be in&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;transform_output&quot;</span><span class="s2">, [</span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s4">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__get_output_config</span><span class="s2">(</span><span class="s1">transform_output</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check _get_output_config works as expected.&quot;&quot;&quot;</span>

    <span class="s6"># Without a configuration set, the global config is used</span>
    <span class="s1">global_config </span><span class="s2">= </span><span class="s1">get_config</span><span class="s2">()[</span><span class="s4">&quot;transform_output&quot;</span><span class="s2">]</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s1">global_config</span>

    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">transform_output</span><span class="s2">=</span><span class="s1">transform_output</span><span class="s2">):</span>
        <span class="s6"># with estimator=None, the global config is used</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s1">transform_output</span>

        <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorNoSetOutputWithTransform</span><span class="s2">()</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s1">transform_output</span>

        <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutput</span><span class="s2">()</span>
        <span class="s6"># If estimator has not config, use global config</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s1">transform_output</span>

        <span class="s6"># If estimator has a config, use local config</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;default&quot;</span><span class="s2">)</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s4">&quot;default&quot;</span>

    <span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s1">transform_output</span><span class="s2">)</span>
    <span class="s1">config </span><span class="s2">= </span><span class="s1">_get_output_config</span><span class="s2">(</span><span class="s4">&quot;transform&quot;</span><span class="s2">, </span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">config</span><span class="s2">[</span><span class="s4">&quot;dense&quot;</span><span class="s2">] == </span><span class="s1">transform_output</span>


<span class="s0">class </span><span class="s1">EstimatorWithSetOutputNoAutoWrap</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">, </span><span class="s1">auto_wrap_output_keys</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>


<span class="s0">def </span><span class="s1">test_get_output_auto_wrap_false</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that auto_wrap_output_keys=None does not wrap.&quot;&quot;&quot;</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutputNoAutoWrap</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s4">&quot;set_output&quot;</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">assert </span><span class="s1">X </span><span class="s0">is </span><span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_auto_wrap_output_keys_errors_with_incorrect_input</span><span class="s2">():</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;auto_wrap_output_keys must be None or a tuple of keys.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">BadEstimator</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">, </span><span class="s1">auto_wrap_output_keys</span><span class="s2">=</span><span class="s4">&quot;bad_parameter&quot;</span><span class="s2">):</span>
            <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">AnotherMixin</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init_subclass__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">custom_parameter</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init_subclass__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">custom_parameter </span><span class="s2">= </span><span class="s1">custom_parameter</span>


<span class="s0">def </span><span class="s1">test_set_output_mixin_custom_mixin</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that multiple init_subclasses passes parameters up.&quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">BothMixinEstimator</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">, </span><span class="s1">AnotherMixin</span><span class="s2">, </span><span class="s1">custom_parameter</span><span class="s2">=</span><span class="s5">123</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">X</span>

        <span class="s0">def </span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_features</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">input_features</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">BothMixinEstimator</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">est</span><span class="s2">.</span><span class="s1">custom_parameter </span><span class="s2">== </span><span class="s5">123</span>
    <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s4">&quot;set_output&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_output_mro</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that multi-inheritance resolves to the correct class method. 
 
    Non-regression test gh-25293. 
    &quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">Base</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s4">&quot;Base&quot;  </span><span class="s6"># noqa</span>

    <span class="s0">class </span><span class="s1">A</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">class </span><span class="s1">B</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s4">&quot;B&quot;</span>

    <span class="s0">class </span><span class="s1">C</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">assert </span><span class="s1">C</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s0">None</span><span class="s2">) == </span><span class="s4">&quot;B&quot;</span>


<span class="s0">class </span><span class="s1">EstimatorWithSetOutputIndex</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>

        <span class="s6"># transform by giving output a new index.</span>
        <span class="s0">return </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">to_numpy</span><span class="s2">(), </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">f&quot;s</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])])</span>

    <span class="s0">def </span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_features</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">f&quot;X</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_output_pandas_keep_index</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that set_output does not override index. 
 
    Non-regression test for gh-25730. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithSetOutputIndex</span><span class="s2">().</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, [</span><span class="s4">&quot;s0&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">EstimatorReturnTuple</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OutputTuple</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">OutputTuple </span><span class="s2">= </span><span class="s1">OutputTuple</span>

    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OutputTuple</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_output_named_tuple_out</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that namedtuples are kept by default.&quot;&quot;&quot;</span>
    <span class="s1">Output </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">&quot;Output&quot;</span><span class="s2">, </span><span class="s4">&quot;X, Y&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]])</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorReturnTuple</span><span class="s2">(</span><span class="s1">OutputTuple</span><span class="s2">=</span><span class="s1">Output</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">Output</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">Y</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">EstimatorWithListInput</span><span class="s2">(</span><span class="s1">_SetOutputMixin</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s0">def </span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_features</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">f&quot;X</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n_features_in_</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dataframe_lib&quot;</span><span class="s2">, [</span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s4">&quot;polars&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_set_output_list_input</span><span class="s2">(</span><span class="s1">dataframe_lib</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check set_output for list input. 
 
    Non-regression test for #27037. 
    &quot;&quot;&quot;</span>
    <span class="s1">lib </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s1">dataframe_lib</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]]</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">EstimatorWithListInput</span><span class="s2">()</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s1">dataframe_lib</span><span class="s2">)</span>

    <span class="s1">X_out </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_out</span><span class="s2">, </span><span class="s1">lib</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_out</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, [</span><span class="s4">&quot;X0&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X3&quot;</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">ADAPTERS_MANAGER</span><span class="s2">.</span><span class="s1">adapters</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_adapter_class_has_interface</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check adapters have the correct interface.&quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ADAPTERS_MANAGER</span><span class="s2">.</span><span class="s1">adapters</span><span class="s2">[</span><span class="s1">name</span><span class="s2">], </span><span class="s1">ContainerAdapterProtocol</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_check_library_installed</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Check import error changed.&quot;&quot;&quot;</span>
    <span class="s1">orig_import_module </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span>

    <span class="s0">def </span><span class="s1">patched_import_module</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImportError</span><span class="s2">()</span>
        <span class="s1">orig_import_module</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">package</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">importlib</span><span class="s2">, </span><span class="s4">&quot;import_module&quot;</span><span class="s2">, </span><span class="s1">patched_import_module</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Setting output container to 'pandas' requires&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">check_library_installed</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_adapter_from_container</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check the behavior fo `_get_adapter_from_container`.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">100</span><span class="s2">]})</span>
    <span class="s1">adapter </span><span class="s2">= </span><span class="s1">_get_adapter_from_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">adapter</span><span class="s2">.</span><span class="s1">container_lib </span><span class="s2">== </span><span class="s4">&quot;pandas&quot;</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;The container does not have a registered adapter in scikit-learn.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">_get_adapter_from_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">to_numpy</span><span class="s2">())</span>
</pre>
</body>
</html>