<html>
<head>
<title>test_simplification.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_simplification.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">base64</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">platform</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span><span class="s2">, </span><span class="s1">remove_ticks_and_titles</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">patches</span><span class="s2">, </span><span class="s1">transforms</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>


<span class="s3"># NOTE: All of these tests assume that path.simplify is set to True</span>
<span class="s3"># (the default)</span>

<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'clipping'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_clipping</span><span class="s2">():</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">*</span><span class="s1">t</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">((-</span><span class="s5">0.20</span><span class="s2">, -</span><span class="s5">0.28</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'overflow'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s5">0.007 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'arm64' </span><span class="s0">else </span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_overflow</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">2.0e5</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'clipping_diamond'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_diamond</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, -</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, -</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_clipping_out_of_bounds</span><span class="s2">():</span>
    <span class="s3"># Should work on a Path *without* codes.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">20</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">, [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s0">assert </span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">codes </span><span class="s2">== [</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">STOP</span><span class="s2">]</span>

    <span class="s3"># Should work on a Path *with* codes, and no curves.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
                <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">20</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">, [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s0">assert </span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">codes </span><span class="s2">== [</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">STOP</span><span class="s2">]</span>

    <span class="s3"># A Path with curves does not do any clipping yet.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">])</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">()</span>
    <span class="s1">simplified_clipped </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">20</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">simplified_clipped</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">simplified_clipped</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_noise</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">50000</span><span class="s2">) * </span><span class="s5">50</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">p1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">solid_joinstyle</span><span class="s2">=</span><span class="s4">'round'</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2.0</span><span class="s2">)</span>

    <span class="s3"># Ensure that the path's transform takes the new axes limits into account.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_path</span><span class="s2">()</span>
    <span class="s1">transform </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_transform</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">transform</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">simplify</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s5">25512</span>


<span class="s0">def </span><span class="s1">test_antiparallel_simplification</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
        <span class="s1">p1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">path </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_path</span><span class="s2">()</span>
        <span class="s1">transform </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_transform</span><span class="s2">()</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">transform</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">simplify</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">simplified </span><span class="s2">= </span><span class="s1">transform</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">().</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">simplified</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">simplified</span>

    <span class="s3"># test ending on a maximum</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">]</span>

    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, -</span><span class="s5">1.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]],</span>
                              <span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">, :])</span>

    <span class="s3"># test ending on a minimum</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">,  </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">]</span>

    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, -</span><span class="s5">2.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]],</span>
                              <span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">, :])</span>

    <span class="s3"># test ending in between</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">]</span>

    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, -</span><span class="s5">1.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]],</span>
                              <span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">, :])</span>

    <span class="s3"># test no anti-parallel ending at max</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">]</span>

    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]],</span>
                              <span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">, :])</span>

    <span class="s3"># test no anti-parallel ending in middle</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">]</span>

    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">_get_simplified</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">],</span>
                               <span class="s2">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]],</span>
                              <span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">, :])</span>


<span class="s3"># Only consider angles in 0 &lt;= angle &lt;= pi/2, otherwise</span>
<span class="s3"># using min/max will get the expected results out of order:</span>
<span class="s3"># min/max for simplification code depends on original vector,</span>
<span class="s3"># and if angle is outside above range then simplification</span>
<span class="s3"># min/max will be opposite from actual min/max.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'angle'</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s5">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s5">2</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'offset'</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_angled_antiparallel</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">):</span>
    <span class="s1">scale </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">19680801</span><span class="s2">)</span>
    <span class="s3"># get 15 random offsets</span>
    <span class="s3"># TODO: guarantee offset &gt; 0 results in some offsets &lt; 0</span>
    <span class="s1">vert_offsets </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">15</span><span class="s2">) - </span><span class="s1">offset</span><span class="s2">) * </span><span class="s1">scale</span>
    <span class="s3"># always start at 0 so rotation makes sense</span>
    <span class="s1">vert_offsets</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s3"># always take the first step the same direction</span>
    <span class="s1">vert_offsets</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s5">1</span>
    <span class="s3"># compute points along a diagonal line</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">vert_offsets</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">vert_offsets</span>

    <span class="s3"># will check these later</span>
    <span class="s1">x_max </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:].</span><span class="s1">max</span><span class="s2">()</span>
    <span class="s1">x_min </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:].</span><span class="s1">min</span><span class="s2">()</span>

    <span class="s1">y_max </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:].</span><span class="s1">max</span><span class="s2">()</span>
    <span class="s1">y_min </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:].</span><span class="s1">min</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">offset </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">p_expected </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s1">x_max</span><span class="s2">, </span><span class="s1">y_max</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s1">x_min</span><span class="s2">, </span><span class="s1">y_min</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s1">x</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]],</span>
                           <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]],</span>
                          <span class="s1">codes</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">p_expected </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s1">x_max</span><span class="s2">, </span><span class="s1">y_max</span><span class="s2">],</span>
                           <span class="s2">[</span><span class="s1">x</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]],</span>
                           <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]],</span>
                          <span class="s1">codes</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">p </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]).</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s1">p2 </span><span class="s2">= </span><span class="s1">p</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">simplify</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p_expected</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">,</span>
                              <span class="s1">p2</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">p_expected</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sine_plus_noise</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">50000</span><span class="s2">)) +</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">50000</span><span class="s2">) * </span><span class="s5">0.01</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">p1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">solid_joinstyle</span><span class="s2">=</span><span class="s4">'round'</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2.0</span><span class="s2">)</span>

    <span class="s3"># Ensure that the path's transform takes the new axes limits into account.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_path</span><span class="s2">()</span>
    <span class="s1">transform </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_transform</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">transform</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">simplify</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s5">25240</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'simplify_curve'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s5">0.017</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_simplify_curve</span><span class="s2">():</span>
    <span class="s1">pp1 </span><span class="s2">= </span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span>
        <span class="s1">Path</span><span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">),</span>
              <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)],</span>
             <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">,</span>
              <span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">]),</span>
        <span class="s1">fc</span><span class="s2">=</span><span class="s4">&quot;none&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">pp1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">((</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">((</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_closed_path_nan_removal</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">flatten</span><span class="s2">()</span>

    <span class="s3"># NaN on the first point also removes the last point, because it's closed.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN on second-last point should not re-close.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># Test multiple loops in a single path (with same paths as above).</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">],</span>
         <span class="s2">[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
         <span class="s2">[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN in first point of CURVE3 should not re-close, and hide entire curve.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN in second point of CURVE3 should not re-close, and hide entire curve</span>
    <span class="s3"># plus next line segment.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE3</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN in first point of CURVE4 should not re-close, and hide entire curve.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN in second point of CURVE4 should not re-close, and hide entire curve.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># NaN in third point of CURVE4 should not re-close, and hide entire curve</span>
    <span class="s3"># plus next line segment.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_test</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span>
        <span class="s2">[[-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">]],</span>
        <span class="s2">[</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CURVE4</span><span class="s2">,</span>
         <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">[</span><span class="s5">3</span><span class="s2">].</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># Keep everything clean.</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[*</span><span class="s1">ax_test</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">, *</span><span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(-</span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(-</span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">))</span>
    <span class="s1">remove_ticks_and_titles</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">)</span>
    <span class="s1">remove_ticks_and_titles</span><span class="s2">(</span><span class="s1">fig_ref</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_closed_path_clipping</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">vertices </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">roll </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">8</span><span class="s2">):</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s5">0.1 </span><span class="s2">* </span><span class="s1">roll </span><span class="s2">+ </span><span class="s5">0.1</span>

        <span class="s3"># A U-like pattern.</span>
        <span class="s1">pattern </span><span class="s2">= [</span>
            <span class="s2">[-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">], [-</span><span class="s5">0.5</span><span class="s2">, -</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1.5</span><span class="s2">, -</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">],  </span><span class="s3"># Outer square</span>
            <span class="s3"># With a notch in the top.</span>
            <span class="s2">[</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">offset </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">], [</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">offset </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">offset </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">], [</span><span class="s1">offset </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">],</span>
        <span class="s2">]</span>

        <span class="s3"># Place the initial/final point anywhere in/out of the clipping area.</span>
        <span class="s1">pattern </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">roll</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">roll</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">pattern </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">[:</span><span class="s5">1</span><span class="s2">, :]))</span>

        <span class="s1">vertices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">)</span>

    <span class="s3"># Multiple subpaths are used here to ensure they aren't broken by closed</span>
    <span class="s3"># loop clipping.</span>
    <span class="s1">codes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]), </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">)</span>
    <span class="s1">codes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span>
    <span class="s1">codes</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span>
    <span class="s1">codes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">))</span>
    <span class="s1">vertices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>

    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">codes</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>

    <span class="s3"># For reference, we draw the same thing, but unclosed by using a line to</span>
    <span class="s3"># the last point only.</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">codes </span><span class="s2">= </span><span class="s1">codes</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">codes</span><span class="s2">[</span><span class="s1">codes </span><span class="s2">== </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">] = </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">codes</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'hatch_simplify'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_hatch</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Rectangle</span><span class="s2">((</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">fill</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">hatch</span><span class="s2">=</span><span class="s4">&quot;/&quot;</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">((</span><span class="s5">0.45</span><span class="s2">, </span><span class="s5">0.55</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">((</span><span class="s5">0.45</span><span class="s2">, </span><span class="s5">0.55</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'fft_peaks'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fft_peaks</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">65536</span><span class="s2">)</span>
    <span class="s1">p1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fft</span><span class="s2">.</span><span class="s1">fft</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">*</span><span class="s5">.01</span><span class="s2">*</span><span class="s1">t</span><span class="s2">)*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">blackman</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)))))</span>

    <span class="s3"># Ensure that the path's transform takes the new axes limits into account.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_path</span><span class="s2">()</span>
    <span class="s1">transform </span><span class="s2">= </span><span class="s1">p1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_transform</span><span class="s2">()</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">transform</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">cleaned</span><span class="s2">(</span><span class="s1">simplify</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">simplified</span><span class="s2">.</span><span class="s1">vertices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s5">36</span>


<span class="s0">def </span><span class="s1">test_start_with_moveto</span><span class="s2">():</span>
    <span class="s3"># Should be entirely clipped away to a single MOVETO</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s6">b&quot;&quot;&quot; 
ZwAAAAku+v9UAQAA+Tj6/z8CAADpQ/r/KAMAANlO+v8QBAAAyVn6//UEAAC6ZPr/2gUAAKpv+v+8 
BgAAm3r6/50HAACLhfr/ewgAAHyQ+v9ZCQAAbZv6/zQKAABepvr/DgsAAE+x+v/lCwAAQLz6/7wM 
AAAxx/r/kA0AACPS+v9jDgAAFN36/zQPAAAF6Pr/AxAAAPfy+v/QEAAA6f36/5wRAADbCPv/ZhIA 
AMwT+/8uEwAAvh77//UTAACwKfv/uRQAAKM0+/98FQAAlT/7/z0WAACHSvv//RYAAHlV+/+7FwAA 
bGD7/3cYAABea/v/MRkAAFF2+//pGQAARIH7/6AaAAA3jPv/VRsAACmX+/8JHAAAHKL7/7ocAAAP 
rfv/ah0AAAO4+/8YHgAA9sL7/8QeAADpzfv/bx8AANzY+/8YIAAA0OP7/78gAADD7vv/ZCEAALf5 
+/8IIgAAqwT8/6kiAACeD/z/SiMAAJIa/P/oIwAAhiX8/4QkAAB6MPz/HyUAAG47/P+4JQAAYkb8 
/1AmAABWUfz/5SYAAEpc/P95JwAAPmf8/wsoAAAzcvz/nCgAACd9/P8qKQAAHIj8/7cpAAAQk/z/ 
QyoAAAWe/P/MKgAA+aj8/1QrAADus/z/2isAAOO+/P9eLAAA2Mn8/+AsAADM1Pz/YS0AAMHf/P/g 
LQAAtur8/10uAACr9fz/2C4AAKEA/f9SLwAAlgv9/8ovAACLFv3/QDAAAIAh/f+1MAAAdSz9/ycx 
AABrN/3/mDEAAGBC/f8IMgAAVk39/3UyAABLWP3/4TIAAEFj/f9LMwAANm79/7MzAAAsef3/GjQA 
ACKE/f9+NAAAF4/9/+E0AAANmv3/QzUAAAOl/f+iNQAA+a/9/wA2AADvuv3/XDYAAOXF/f+2NgAA 
29D9/w83AADR2/3/ZjcAAMfm/f+7NwAAvfH9/w44AACz/P3/XzgAAKkH/v+vOAAAnxL+//04AACW 
Hf7/SjkAAIwo/v+UOQAAgjP+/905AAB5Pv7/JDoAAG9J/v9pOgAAZVT+/606AABcX/7/7zoAAFJq 
/v8vOwAASXX+/207AAA/gP7/qjsAADaL/v/lOwAALZb+/x48AAAjof7/VTwAABqs/v+LPAAAELf+ 
/788AAAHwv7/8TwAAP7M/v8hPQAA9df+/1A9AADr4v7/fT0AAOLt/v+oPQAA2fj+/9E9AADQA/// 
+T0AAMYO//8fPgAAvRn//0M+AAC0JP//ZT4AAKsv//+GPgAAojr//6U+AACZRf//wj4AAJBQ///d 
PgAAh1v///c+AAB+Zv//Dz8AAHRx//8lPwAAa3z//zk/AABih///TD8AAFmS//9dPwAAUJ3//2w/ 
AABHqP//ej8AAD6z//+FPwAANb7//48/AAAsyf//lz8AACPU//+ePwAAGt///6M/AAAR6v//pj8A 
AAj1//+nPwAA/////w==&quot;&quot;&quot;</span>

    <span class="s1">verts </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">base64</span><span class="s2">.</span><span class="s1">decodebytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'&lt;i4'</span><span class="s2">)</span>
    <span class="s1">verts </span><span class="s2">= </span><span class="s1">verts</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s1">len</span><span class="s2">(</span><span class="s1">verts</span><span class="s2">) // </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">verts</span><span class="s2">)</span>
    <span class="s1">segs </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">iter_segments</span><span class="s2">(</span><span class="s1">transforms</span><span class="s2">.</span><span class="s1">IdentityTransform</span><span class="s2">(),</span>
                              <span class="s1">clip</span><span class="s2">=(</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">100.0</span><span class="s2">, </span><span class="s5">100.0</span><span class="s2">))</span>
    <span class="s1">segs </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">segs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">segs</span><span class="s2">) == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">segs</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">1</span><span class="s2">] == </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span>


<span class="s0">def </span><span class="s1">test_throw_rendering_complexity_exceeded</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'path.simplify'</span><span class="s2">] = </span><span class="s0">False</span>
    <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2_000_000</span><span class="s2">)</span>
    <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">2_000_000</span><span class="s2">)</span>
    <span class="s1">yy</span><span class="s2">[</span><span class="s5">1000</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'clipper_edge'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_clipper</span><span class="s2">():</span>
    <span class="s1">dat </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots_adjust</span><span class="s2">(</span><span class="s1">left</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">bottom</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">hspace</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">((</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), </span><span class="s1">autoscale_on</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">dat</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_major_locator</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">MultipleLocator</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_major_locator</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">MultipleLocator</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_ticks_position</span><span class="s2">(</span><span class="s4">'bottom'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_ticks_position</span><span class="s2">(</span><span class="s4">'left'</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">9</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'para_equal_perp'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_para_equal_perp</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] + [</span><span class="s5">1</span><span class="s2">] * </span><span class="s5">128</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] + [</span><span class="s5">0</span><span class="s2">] * </span><span class="s5">128</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s4">'ro'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'clipping_with_nans'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_clipping_with_nans</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3.14 </span><span class="s2">* </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3000</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">[::</span><span class="s5">100</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_clipping_full</span><span class="s2">():</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s5">1e30</span><span class="s2">, </span><span class="s5">1e30</span><span class="s2">]] * </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">iter_segments</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">simplified </span><span class="s2">== []</span>

    <span class="s1">p </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s5">50</span><span class="s2">, </span><span class="s5">40</span><span class="s2">], [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">65</span><span class="s2">]], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">iter_segments</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s2">([(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">simplified</span><span class="s2">] ==</span>
            <span class="s2">[([</span><span class="s5">50</span><span class="s2">, </span><span class="s5">40</span><span class="s2">], </span><span class="s5">1</span><span class="s2">), ([</span><span class="s5">75</span><span class="s2">, </span><span class="s5">65</span><span class="s2">], </span><span class="s5">2</span><span class="s2">)])</span>

    <span class="s1">p </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s5">50</span><span class="s2">, </span><span class="s5">40</span><span class="s2">]], [</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">simplified </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">iter_segments</span><span class="s2">(</span><span class="s1">clip</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s2">([(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">simplified</span><span class="s2">] ==</span>
            <span class="s2">[([</span><span class="s5">50</span><span class="s2">, </span><span class="s5">40</span><span class="s2">], </span><span class="s5">1</span><span class="s2">)])</span>
</pre>
</body>
</html>