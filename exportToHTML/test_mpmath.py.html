<html>
<head>
<title>test_mpmath.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_mpmath.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test SciPy functions versus mpmath, if available. 
 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">assert_</span><span class="s3">, </span><span class="s1">assert_allclose</span>
<span class="s2">from </span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">pi</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">itertools</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib </span><span class="s2">import </span><span class="s1">_pep440</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special </span><span class="s2">as </span><span class="s1">sc</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special</span><span class="s3">.</span><span class="s1">_testutils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">MissingModule</span><span class="s3">, </span><span class="s1">check_version</span><span class="s3">, </span><span class="s1">FuncData</span><span class="s3">,</span>
    <span class="s1">assert_func_equal</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special</span><span class="s3">.</span><span class="s1">_mptestutils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">Arg</span><span class="s3">, </span><span class="s1">FixedArg</span><span class="s3">, </span><span class="s1">ComplexArg</span><span class="s3">, </span><span class="s1">IntArg</span><span class="s3">, </span><span class="s1">assert_mpmath_equal</span><span class="s3">,</span>
    <span class="s1">nonfunctional_tooslow</span><span class="s3">, </span><span class="s1">trace_args</span><span class="s3">, </span><span class="s1">time_limited</span><span class="s3">, </span><span class="s1">exception_to_nan</span><span class="s3">,</span>
    <span class="s1">inf_to_nan</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special</span><span class="s3">.</span><span class="s1">_ufuncs </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_sinpi</span><span class="s3">, </span><span class="s1">_cospi</span><span class="s3">, </span><span class="s1">_lgam1p</span><span class="s3">, </span><span class="s1">_lanczos_sum_expg_scaled</span><span class="s3">, </span><span class="s1">_log1pmx</span><span class="s3">,</span>
    <span class="s1">_igam_fac</span><span class="s3">)</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">mpmath</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">mpmath </span><span class="s3">= </span><span class="s1">MissingModule</span><span class="s3">(</span><span class="s4">'mpmath'</span><span class="s3">)</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># expi</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.10'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_expi_complex</span><span class="s3">():</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">r </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">99</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s6">30</span><span class="s3">):</span>
            <span class="s1">z </span><span class="s3">= </span><span class="s1">r</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s6">1j</span><span class="s3">*</span><span class="s1">p</span><span class="s3">)</span>
            <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">z</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ei</span><span class="s3">(</span><span class="s1">z</span><span class="s3">))))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cdouble</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">expi</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># expn</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_expn_large_n</span><span class="s3">():</span>
    <span class="s5"># Test the transition to the asymptotic regime of n.</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s3">[</span><span class="s6">50</span><span class="s3">, </span><span class="s6">51</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">200</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">100</span><span class="s3">):</span>
                <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">expint</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">))))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">expn</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>

<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># hyp0f1</span>
<span class="s5"># ------------------------------------------------------------------------------</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp0f1_gh5764</span><span class="s3">():</span>
    <span class="s5"># Do a small and somewhat systematic test that runs quickly</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s1">axis </span><span class="s3">= [-</span><span class="s6">99.5</span><span class="s3">, -</span><span class="s6">9.5</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">9.5</span><span class="s3">, </span><span class="s6">99.5</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">axis</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">axis</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">axis</span><span class="s3">:</span>
                <span class="s1">z </span><span class="s3">= </span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span>
                <span class="s5"># mpmath computes the answer correctly at dps ~ 17 but</span>
                <span class="s5"># fails for 20 &lt; dps &lt; 120 (uses a different method);</span>
                <span class="s5"># set the dps high enough that this isn't an issue</span>
                <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">120</span><span class="s3">):</span>
                    <span class="s1">res </span><span class="s3">= </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">))</span>
                <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">res</span><span class="s3">))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">), </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s6">2</span><span class="s3">,</span>
             <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp0f1_gh_1609</span><span class="s3">():</span>
    <span class="s5"># this is a regression test for gh-1609</span>
    <span class="s1">vv </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">150</span><span class="s3">, </span><span class="s6">180</span><span class="s3">, </span><span class="s6">21</span><span class="s3">)</span>
    <span class="s1">af </span><span class="s3">= </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">vv</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">)</span>
    <span class="s1">mf </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">vv</span><span class="s3">])</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">af</span><span class="s3">, </span><span class="s1">mf</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">)</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># hyperu</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'1.1.0'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyperu_around_0</span><span class="s3">():</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s5"># DLMF 13.2.14-15 test points.</span>
    <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">20</span><span class="s3">):</span>
            <span class="s1">a </span><span class="s3">= -</span><span class="s1">n</span>
            <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))))</span>
            <span class="s1">a </span><span class="s3">= -</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">b </span><span class="s3">- </span><span class="s6">1</span>
            <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))))</span>
    <span class="s5"># DLMF 13.2.16-22 test points.</span>
    <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">10.5</span><span class="s3">, -</span><span class="s6">1.5</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">1.0</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2.5</span><span class="s3">]:</span>
            <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">5e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># hyp2f1</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'1.0.0'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp2f1_strange_points</span><span class="s3">():</span>
    <span class="s1">pts </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">),  </span><span class="s5"># expected: 2.4</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">),  </span><span class="s5"># expected: 3.87</span>
    <span class="s3">]</span>
    <span class="s1">pts </span><span class="s3">+= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">([</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">0.7</span><span class="s3">, -</span><span class="s6">1000</span><span class="s3">], </span><span class="s1">repeat</span><span class="s3">=</span><span class="s6">4</span><span class="s3">))</span>
    <span class="s1">pts </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x </span><span class="s2">in </span><span class="s1">pts</span>
        <span class="s2">if </span><span class="s1">b </span><span class="s3">== </span><span class="s1">c </span><span class="s2">and </span><span class="s1">round</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) == </span><span class="s1">b </span><span class="s2">and </span><span class="s1">b </span><span class="s3">&lt; </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">b </span><span class="s3">!= -</span><span class="s6">1000</span>
    <span class="s3">]</span>
    <span class="s1">kw </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">eliminate</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">dataset </span><span class="s3">= [</span><span class="s1">p </span><span class="s3">+ (</span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(*</span><span class="s1">p</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)),) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">pts</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">), </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.13'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp2f1_real_some_points</span><span class="s3">():</span>
    <span class="s1">pts </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1.</span><span class="s3">/</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">/</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5.</span><span class="s3">/</span><span class="s6">6</span><span class="s3">, </span><span class="s6">27.</span><span class="s3">/</span><span class="s6">32</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1.</span><span class="s3">/</span><span class="s6">4</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3.</span><span class="s3">/</span><span class="s6">4</span><span class="s3">, </span><span class="s6">80.</span><span class="s3">/</span><span class="s6">81</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">,-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1.5</span><span class="s3">, -</span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">0.7235</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">5</span><span class="s3">, </span><span class="s6">0.3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">0.25</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">/</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0.999</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">0.25</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">/</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">3.</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2.5</span><span class="s3">, -</span><span class="s6">3.25</span><span class="s3">, </span><span class="s6">0.999</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">8</span><span class="s3">, </span><span class="s6">18.016500331508873</span><span class="s3">, </span><span class="s6">10.805295997850628</span><span class="s3">, </span><span class="s6">0.90875647507000001</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">900</span><span class="s3">, -</span><span class="s6">10.5</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">900</span><span class="s3">, </span><span class="s6">10.5</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1 </span><span class="s3">- </span><span class="s6">270.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">0.999</span><span class="s3">**</span><span class="s6">2</span><span class="s3">),  </span><span class="s5"># from issue 1561</span>
    <span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= [</span><span class="s1">p </span><span class="s3">+ (</span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(*</span><span class="s1">p</span><span class="s3">)),) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">pts</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
        <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">), </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.14'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp2f1_some_points_2</span><span class="s3">():</span>
    <span class="s5"># Taken from mpmath unit tests -- this point failed for mpmath 0.13 but</span>
    <span class="s5"># was fixed in their SVN since then</span>
    <span class="s1">pts </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s6">112</span><span class="s3">, (</span><span class="s6">51</span><span class="s3">,</span><span class="s6">10</span><span class="s3">), (-</span><span class="s6">9</span><span class="s3">,</span><span class="s6">10</span><span class="s3">), -</span><span class="s6">0.99999</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">10</span><span class="s3">,-</span><span class="s6">900</span><span class="s3">,</span><span class="s6">10.5</span><span class="s3">,</span><span class="s6">0.99</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">10</span><span class="s3">,-</span><span class="s6">900</span><span class="s3">,-</span><span class="s6">10.5</span><span class="s3">,</span><span class="s6">0.99</span><span class="s3">),</span>
    <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">fev</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">float</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) / </span><span class="s1">x</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">x</span>

    <span class="s1">dataset </span><span class="s3">= [</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">fev</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)) + (</span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(*</span><span class="s1">p</span><span class="s3">)),) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">pts</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">), </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.13'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hyp2f1_real_some</span><span class="s3">():</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">10</span><span class="s3">, -</span><span class="s6">5</span><span class="s3">, -</span><span class="s6">1.8</span><span class="s3">, </span><span class="s6">1.8</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">2.5</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">7.4</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">9</span><span class="s3">, -</span><span class="s6">1.8</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">20.4</span><span class="s3">]:</span>
                <span class="s2">for </span><span class="s1">z </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">10</span><span class="s3">, -</span><span class="s6">1.01</span><span class="s3">, -</span><span class="s6">0.99</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0.6</span><span class="s3">, </span><span class="s6">0.95</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]:</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">v </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">z</span><span class="s3">))</span>
                    <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                        <span class="s2">continue</span>
                    <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">v</span><span class="s3">))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
        <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">,</span><span class="s6">3</span><span class="s3">), </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-9</span><span class="s3">,</span>
                 <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.12'</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s2">def </span><span class="s1">test_hyp2f1_real_random</span><span class="s3">():</span>
    <span class="s1">npoints </span><span class="s3">= </span><span class="s6">500</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">npoints</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s6">1234</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">pareto</span><span class="s3">(</span><span class="s6">1.5</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">1</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">pareto</span><span class="s3">(</span><span class="s6">1.5</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">2</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">pareto</span><span class="s3">(</span><span class="s6">1.5</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">3</span><span class="s3">] = </span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">npoints</span><span class="s3">) - </span><span class="s6">1</span>

    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">] *= (-</span><span class="s6">1</span><span class="s3">)**</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">1</span><span class="s3">] *= (-</span><span class="s6">1</span><span class="s3">)**</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>
    <span class="s1">dataset</span><span class="s3">[:, </span><span class="s6">2</span><span class="s3">] *= (-</span><span class="s6">1</span><span class="s3">)**</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s1">npoints</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">ds </span><span class="s2">in </span><span class="s1">dataset</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">__version__ </span><span class="s3">&lt; </span><span class="s4">'0.14'</span><span class="s3">:</span>
            <span class="s5"># mpmath &lt; 0.14 fails for c too much smaller than a, b</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">ds</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]).</span><span class="s1">max</span><span class="s3">() &gt; </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">ds</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]):</span>
                <span class="s1">ds</span><span class="s3">[</span><span class="s6">2</span><span class="s3">] = </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">ds</span><span class="s3">[:</span><span class="s6">2</span><span class="s3">]).</span><span class="s1">max</span><span class="s3">()</span>
        <span class="s1">ds</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] = </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(*</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">ds</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">])))</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-9</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># erf (complex)</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.14'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_erf_complex</span><span class="s3">():</span>
    <span class="s5"># need to increase mpmath precision for this test</span>
    <span class="s1">old_dps</span><span class="s3">, </span><span class="s1">old_prec </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">prec</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps </span><span class="s3">= </span><span class="s6">70</span>
        <span class="s1">x1</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">31</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">11</span><span class="s3">))</span>
        <span class="s1">x2</span><span class="s3">, </span><span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">80</span><span class="s3">, </span><span class="s6">.8</span><span class="s3">, </span><span class="s6">31</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">80</span><span class="s3">, </span><span class="s6">.8</span><span class="s3">, </span><span class="s6">11</span><span class="s3">))</span>
        <span class="s1">points </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(),</span><span class="s1">x2</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()] + </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">y1</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()]</span>

        <span class="s1">assert_func_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)), </span><span class="s1">points</span><span class="s3">,</span>
                          <span class="s1">vectorized</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">)</span>
        <span class="s1">assert_func_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)), </span><span class="s1">points</span><span class="s3">,</span>
                          <span class="s1">vectorized</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">prec </span><span class="s3">= </span><span class="s1">old_dps</span><span class="s3">, </span><span class="s1">old_prec</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># lpmv</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.15'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_lpmv</span><span class="s3">():</span>
    <span class="s1">pts </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s3">[-</span><span class="s6">0.99</span><span class="s3">, -</span><span class="s6">0.557</span><span class="s3">, </span><span class="s6">1e-6</span><span class="s3">, </span><span class="s6">0.132</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]:</span>
        <span class="s1">pts</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1.7</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1.7</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1.7</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">2.7</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">8</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">5</span><span class="s3">, -</span><span class="s6">11</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">8</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">5</span><span class="s3">, -</span><span class="s6">11</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">8.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">11.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">8.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">11.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">8.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s6">5</span><span class="s3">, -</span><span class="s6">11.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">8.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s3">(-</span><span class="s6">5</span><span class="s3">, -</span><span class="s6">11.3</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
        <span class="s3">])</span>

    <span class="s2">def </span><span class="s1">mplegenp</span><span class="s3">(</span><span class="s1">nu</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">mu </span><span class="s3">== </span><span class="s1">int</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">) </span><span class="s2">and </span><span class="s1">x </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s5"># mpmath 0.17 gets this wrong</span>
            <span class="s2">if </span><span class="s1">mu </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s6">1</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s6">0</span>
        <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenp</span><span class="s3">(</span><span class="s1">nu</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s1">dataset </span><span class="s3">= [</span><span class="s1">p </span><span class="s3">+ (</span><span class="s1">mplegenp</span><span class="s3">(</span><span class="s1">p</span><span class="s3">[</span><span class="s6">1</span><span class="s3">], </span><span class="s1">p</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">p</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]),) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">pts</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">evf</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">nu</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lpmv</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">), </span><span class="s1">nu</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
        <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">evf</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,</span><span class="s6">1</span><span class="s3">,</span><span class="s6">2</span><span class="s3">), </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># beta</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.15'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_beta</span><span class="s3">():</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s6">1234</span><span class="s3">)</span>

    <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">200</span><span class="s3">, </span><span class="s6">200</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
              <span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
              <span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
              <span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
              <span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">1</span><span class="s3">) + </span><span class="s6">0.5</span><span class="s3">,</span>
              <span class="s3">-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">2.3</span><span class="s3">, -</span><span class="s6">3</span><span class="s3">, -</span><span class="s6">100.3</span><span class="s3">, -</span><span class="s6">10003.4</span><span class="s3">]</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">b</span>

    <span class="s1">ab </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_arrays</span><span class="s3">(</span><span class="s1">a</span><span class="s3">[:,</span><span class="s2">None</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[</span><span class="s2">None</span><span class="s3">,:])).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">).</span><span class="s1">T</span>

    <span class="s1">old_dps</span><span class="s3">, </span><span class="s1">old_prec </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">prec</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps </span><span class="s3">= </span><span class="s6">400</span>

        <span class="s1">assert_func_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">,</span>
                          <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)),</span>
                          <span class="s1">ab</span><span class="s3">,</span>
                          <span class="s1">vectorized</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                          <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">,</span>
                          <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">assert_func_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">betaln</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)))),</span>
            <span class="s1">ab</span><span class="s3">,</span>
            <span class="s1">vectorized</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">prec </span><span class="s3">= </span><span class="s1">old_dps</span><span class="s3">, </span><span class="s1">old_prec</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># loggamma</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s1">LOGGAMMA_TAYLOR_RADIUS </span><span class="s3">= </span><span class="s6">0.2</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_loggamma_taylor_transition</span><span class="s3">():</span>
    <span class="s5"># Make sure there isn't a big jump in accuracy when we move from</span>
    <span class="s5"># using the Taylor series to using the recurrence relation.</span>

    <span class="s1">r </span><span class="s3">= </span><span class="s1">LOGGAMMA_TAYLOR_RADIUS </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">0.1</span><span class="s3">, -</span><span class="s6">0.01</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0.01</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">])</span>
    <span class="s1">theta </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">r</span><span class="s3">, </span><span class="s1">theta </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">theta</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">r</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s6">1j</span><span class="s3">*</span><span class="s1">theta</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s6">1 </span><span class="s3">+ </span><span class="s1">dz</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">+ </span><span class="s1">dz</span><span class="s3">].</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-14</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_loggamma_taylor</span><span class="s3">():</span>
    <span class="s5"># Test around the zeros at z = 1, 2.</span>

    <span class="s1">r </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s1">LOGGAMMA_TAYLOR_RADIUS</span><span class="s3">), </span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">theta </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">r</span><span class="s3">, </span><span class="s1">theta </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">theta</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">r</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s6">1j</span><span class="s3">*</span><span class="s1">theta</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s6">1 </span><span class="s3">+ </span><span class="s1">dz</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">+ </span><span class="s1">dz</span><span class="s3">].</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-14</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># rgamma</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s2">def </span><span class="s1">test_rgamma_zeros</span><span class="s3">():</span>
    <span class="s5"># Test around the zeros at z = 0, -1, -2, ...,  -169. (After -169 we</span>
    <span class="s5"># get values that are out of floating point range even when we're</span>
    <span class="s5"># within 0.1 of the zero.)</span>

    <span class="s5"># Can't use too many points here or the test takes forever.</span>
    <span class="s1">dx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">13</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">13</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)]</span>
    <span class="s1">dy </span><span class="s3">= </span><span class="s1">dx</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">dx</span><span class="s3">, </span><span class="s1">dy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">dy</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">dx </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">dy</span>
    <span class="s1">zeros </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">170</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">zeros </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dstack</span><span class="s3">((</span><span class="s1">dz</span><span class="s3">,)*</span><span class="s1">zeros</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)).</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">100</span><span class="s3">):</span>
        <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>
    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># digamma</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s2">def </span><span class="s1">test_digamma_roots</span><span class="s3">():</span>
    <span class="s5"># Test the special-cased roots for digamma.</span>
    <span class="s1">root </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">findroot</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">)</span>
    <span class="s1">roots </span><span class="s3">= [</span><span class="s1">float</span><span class="s3">(</span><span class="s1">root</span><span class="s3">)]</span>
    <span class="s1">root </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">findroot</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">)</span>
    <span class="s1">roots</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">root</span><span class="s3">))</span>
    <span class="s1">roots </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">roots</span><span class="s3">)</span>

    <span class="s5"># If we test beyond a radius of 0.24 mpmath will take forever.</span>
    <span class="s1">dx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s6">0.24</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">15</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">15</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s6">0.24</span><span class="s3">]</span>
    <span class="s1">dy </span><span class="s3">= </span><span class="s1">dx</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">dx</span><span class="s3">, </span><span class="s1">dy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">dy</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">dx </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">dy</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">roots </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dstack</span><span class="s3">((</span><span class="s1">dz</span><span class="s3">,)*</span><span class="s1">roots</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)).</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">30</span><span class="s3">):</span>
        <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>
    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_digamma_negreal</span><span class="s3">():</span>
    <span class="s5"># Test digamma around the negative real axis. Don't do this in</span>
    <span class="s5"># TestSystematic because the points need some jiggering so that</span>
    <span class="s5"># mpmath doesn't take forever.</span>

    <span class="s1">digamma </span><span class="s3">= </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">300</span><span class="s3">, -</span><span class="s6">30</span><span class="s3">, </span><span class="s6">100</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)]</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">40</span><span class="s3">):</span>
        <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">digamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_digamma_boundary</span><span class="s3">():</span>
    <span class="s5"># Check that there isn't a jump in accuracy when we switch from</span>
    <span class="s5"># using the asymptotic series to the reflection formula.</span>

    <span class="s1">x </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">300</span><span class="s3">, -</span><span class="s6">30</span><span class="s3">, </span><span class="s6">100</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">6.1</span><span class="s3">, -</span><span class="s6">5.9</span><span class="s3">, </span><span class="s6">5.9</span><span class="s3">, </span><span class="s6">6.1</span><span class="s3">])</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">30</span><span class="s3">):</span>
        <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">))) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># gammainc</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s2">def </span><span class="s1">test_gammainc_boundary</span><span class="s3">():</span>
    <span class="s5"># Test the transition to the asymptotic series.</span>
    <span class="s1">small </span><span class="s3">= </span><span class="s6">20</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">*</span><span class="s1">small</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">small</span><span class="s3">, </span><span class="s6">50</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">a</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">a</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">(), </span><span class="s1">x</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s6">100</span><span class="s3">):</span>
        <span class="s1">dataset </span><span class="s3">= [(</span><span class="s1">a0</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">a0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)))</span>
                   <span class="s2">for </span><span class="s1">a0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)]</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># spence</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s2">def </span><span class="s1">test_spence_circle</span><span class="s3">():</span>
    <span class="s5"># The trickiest region for spence is around the circle |z - 1| = 1,</span>
    <span class="s5"># so test that region carefully.</span>

    <span class="s2">def </span><span class="s1">spence</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">polylog</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">z</span><span class="s3">))</span>

    <span class="s1">r </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">)</span>
    <span class="s1">theta </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">pi</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s6">1 </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">outer</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s6">1j</span><span class="s3">*</span><span class="s1">theta</span><span class="s3">))).</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">spence</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spence</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># sinpi and cospi</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sinpi_zeros</span><span class="s3">():</span>
    <span class="s1">eps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">eps</span>
    <span class="s1">dx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">13</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)]</span>
    <span class="s1">dy </span><span class="s3">= </span><span class="s1">dx</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">dx</span><span class="s3">, </span><span class="s1">dy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">dy</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">dx </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">dy</span>
    <span class="s1">zeros </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s6">1</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">zeros </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dstack</span><span class="s3">((</span><span class="s1">dz</span><span class="s3">,)*</span><span class="s1">zeros</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)).</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sinpi</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>
    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">_sinpi</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">2</span><span class="s3">*</span><span class="s1">eps</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cospi_zeros</span><span class="s3">():</span>
    <span class="s1">eps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">eps</span>
    <span class="s1">dx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">13</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">13</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)]</span>
    <span class="s1">dy </span><span class="s3">= </span><span class="s1">dx</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">dx</span><span class="s3">, </span><span class="s1">dy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">dy</span><span class="s3">)</span>
    <span class="s1">dz </span><span class="s3">= </span><span class="s1">dx </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">dy</span>
    <span class="s1">zeros </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s6">1</span><span class="s3">) + </span><span class="s6">0.5</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">zeros </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dstack</span><span class="s3">((</span><span class="s1">dz</span><span class="s3">,)*</span><span class="s1">zeros</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)).</span><span class="s1">flatten</span><span class="s3">()</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">cospi</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">_cospi</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">2</span><span class="s3">*</span><span class="s1">eps</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># ellipj</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_dn_quarter_period</span><span class="s3">():</span>
    <span class="s2">def </span><span class="s1">dn</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipj</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">mpmath_dn</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipfun</span><span class="s3">(</span><span class="s4">&quot;dn&quot;</span><span class="s3">, </span><span class="s1">u</span><span class="s3">=</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">=</span><span class="s1">m</span><span class="s3">))</span>

    <span class="s1">m </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">du </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">15</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">15</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)]</span>
    <span class="s1">dataset </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">m0 </span><span class="s2">in </span><span class="s1">m</span><span class="s3">:</span>
        <span class="s1">u0 </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipk</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">du0 </span><span class="s2">in </span><span class="s1">du</span><span class="s3">:</span>
            <span class="s1">p </span><span class="s3">= </span><span class="s1">u0 </span><span class="s3">+ </span><span class="s1">du0</span>
            <span class="s1">dataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">p</span><span class="s3">, </span><span class="s1">m0</span><span class="s3">, </span><span class="s1">mpmath_dn</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">m0</span><span class="s3">)))</span>
    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">dataset</span><span class="s3">)</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">dn</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># Wright Omega</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s2">def </span><span class="s1">_mpmath_wrightomega</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s1">dps</span><span class="s3">):</span>
        <span class="s1">z </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpc</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">unwind </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">((</span><span class="s1">z</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">- </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)/(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">z</span><span class="s3">), </span><span class="s1">unwind</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">res</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_wrightomega_branch</span><span class="s3">():</span>
    <span class="s1">x </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">25</span><span class="s3">)</span>
    <span class="s1">picut_above </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)]</span>
    <span class="s1">picut_below </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)]</span>
    <span class="s1">npicut_above </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)]</span>
    <span class="s1">npicut_below </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)]</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">50</span><span class="s3">):</span>
        <span class="s1">picut_above</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">picut_above</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))</span>
        <span class="s1">picut_below</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">picut_below</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">], -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))</span>
        <span class="s1">npicut_above</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">npicut_above</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))</span>
        <span class="s1">npicut_below</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">npicut_below</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">], -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">picut_above</span><span class="s3">, </span><span class="s1">picut_below</span><span class="s3">, </span><span class="s1">npicut_above</span><span class="s3">, </span><span class="s1">npicut_below</span><span class="s3">))</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">_mpmath_wrightomega</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">, </span><span class="s6">25</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">wrightomega</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_wrightomega_region1</span><span class="s3">():</span>
    <span class="s5"># This region gets less coverage in the TestSystematic test</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">_mpmath_wrightomega</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">, </span><span class="s6">25</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">wrightomega</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_wrightomega_region2</span><span class="s3">():</span>
    <span class="s5"># This region gets less coverage in the TestSystematic test</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">_mpmath_wrightomega</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">, </span><span class="s6">25</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">wrightomega</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># lambertw</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_lambertw_smallz</span><span class="s3">():</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">25</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">25</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">).</span><span class="s1">flatten</span><span class="s3">()</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([(</span><span class="s1">z0</span><span class="s3">, </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">(</span><span class="s1">z0</span><span class="s3">)))</span>
                          <span class="s2">for </span><span class="s1">z0 </span><span class="s2">in </span><span class="s1">z</span><span class="s3">])</span>

    <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s5"># ------------------------------------------------------------------------------</span>
<span class="s5"># Systematic tests</span>
<span class="s5"># ------------------------------------------------------------------------------</span>

<span class="s1">HYPERKW </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">maxprec</span><span class="s3">=</span><span class="s6">200</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s6">200</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.17'</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestSystematic</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_airyai</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># oscillating function, limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">],</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">,</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
                            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">],</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">,</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_airyai_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">],</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">,</span>
                            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_airyai_prime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># oscillating function, limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
                            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_airyai_prime_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airyai</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_airybi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># oscillating function, limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
                            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_airybi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_airybi_prime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># oscillating function, limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">3</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
                            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">3</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_airybi_prime_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">airy</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">3</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">:</span>
                            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">airybi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">derivative</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_bei</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">bei</span><span class="s3">,</span>
                            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bei</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_ber</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ber</span><span class="s3">,</span>
                            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ber</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
                            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_bernoulli</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">n</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">bernoulli</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))[</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)],</span>
                            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">: </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bernoulli</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))),</span>
                            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">13000</span><span class="s3">)],</span>
                            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-9</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s6">13000</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besseli</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">iv</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besseli</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-270</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besseli_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">iv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besseli</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besselj</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">jv</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselj</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)],</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5"># loss of precision at large arguments due to oscillation</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">jv</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselj</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besselj_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">jv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselj</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">ComplexArg</span><span class="s3">()]</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besselk</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">kv</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselk</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">200</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besselk_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">kn</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselk</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(-</span><span class="s6">200</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_besselk_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">kv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselk</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bessely</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpbessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &gt; </span><span class="s6">1e305</span><span class="s3">:</span>
                <span class="s5"># overflowing to inf a bit earlier is OK</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) == </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">x </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s5"># invalid result from mpmath, point x=0 is a divergence</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">r</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">yv</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpbessely</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e100</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">5000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bessely_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpbessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &gt; </span><span class="s6">1e305</span><span class="s3">:</span>
                <span class="s5"># overflowing to inf a bit earlier is OK</span>
                <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
                    <span class="s1">r </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">r</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">yv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpbessely</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">15000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bessely_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpbessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bessely</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) == </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">x </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s5"># invalid result from mpmath, point x=0 is a divergence</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">r</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">yn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">v</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpbessely</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(-</span><span class="s6">1000</span><span class="s3">, </span><span class="s6">1000</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_beta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">bad_points </span><span class="s3">= []</span>

        <span class="s2">def </span><span class="s1">beta</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">nonzero</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">a </span><span class="s3">&lt; -</span><span class="s6">1e12 </span><span class="s2">or </span><span class="s1">b </span><span class="s3">&lt; -</span><span class="s6">1e12</span><span class="s3">:</span>
                <span class="s5"># Function is defined here only at integers, but due</span>
                <span class="s5"># to loss of precision this is numerically</span>
                <span class="s5"># ill-defined. Don't compare values here.</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">a </span><span class="s3">&lt; </span><span class="s6">0 </span><span class="s2">or </span><span class="s1">b </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">b</span><span class="s3">)) % </span><span class="s6">1</span><span class="s3">) == </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s5"># close to a zero of the function: mpmath and scipy</span>
                <span class="s5"># will not round here the same, so the test needs to be</span>
                <span class="s5"># run with an absolute tolerance</span>
                <span class="s2">if </span><span class="s1">nonzero</span><span class="s3">:</span>
                    <span class="s1">bad_points</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">float</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">float</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)))</span>
                    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">beta</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">nonzero</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">beta</span><span class="s3">,</span>
            <span class="s1">beta</span><span class="s3">,</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">bad_points</span><span class="s3">),</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_betainc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">,</span>
            <span class="s1">time_limited</span><span class="s3">()(</span>
                <span class="s1">exception_to_nan</span><span class="s3">(</span>
                    <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_betaincc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">betaincc</span><span class="s3">,</span>
            <span class="s1">time_limited</span><span class="s3">()(</span>
                <span class="s1">exception_to_nan</span><span class="s3">(</span>
                    <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_binom</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">bad_points </span><span class="s3">= []</span>

        <span class="s2">def </span><span class="s1">binomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">nonzero</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">k</span><span class="s3">) &gt; </span><span class="s6">1e8</span><span class="s3">*(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) + </span><span class="s6">1</span><span class="s3">):</span>
                <span class="s5"># The binomial is rapidly oscillating in this region,</span>
                <span class="s5"># and the function is numerically ill-defined. Don't</span>
                <span class="s5"># compare values here.</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">if </span><span class="s1">n </span><span class="s3">&lt; </span><span class="s1">k </span><span class="s2">and </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s1">k</span><span class="s3">) - </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s1">k</span><span class="s3">))) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># close to a zero of the function: mpmath and scipy</span>
                <span class="s5"># will not round here the same, so the test needs to be</span>
                <span class="s5"># run with an absolute tolerance</span>
                <span class="s2">if </span><span class="s1">nonzero</span><span class="s3">:</span>
                    <span class="s1">bad_points</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">float</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">float</span><span class="s3">(</span><span class="s1">k</span><span class="s3">)))</span>
                    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">binomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">binomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">nonzero</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">binom</span><span class="s3">,</span>
            <span class="s1">binomial</span><span class="s3">,</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">bad_points</span><span class="s3">),</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_chebyt_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_chebyt</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chebyt</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;some cases in hyp2f1 not fully accurate&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_chebyt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_chebyt</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">time_limited</span><span class="s3">()(</span>
                <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chebyt</span><span class="s3">)</span>
            <span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">101</span><span class="s3">, </span><span class="s6">101</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">10000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_chebyu_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_chebyu</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chebyu</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;some cases in hyp2f1 not fully accurate&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_chebyu</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_chebyu</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">time_limited</span><span class="s3">()(</span>
                <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chebyu</span><span class="s3">)</span>
            <span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">101</span><span class="s3">, </span><span class="s6">101</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_chi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">chi</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">shichi</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">chi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chi</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()])</span>
        <span class="s5"># check asymptotic series cross-over</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">chi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chi</span><span class="s3">, [</span><span class="s1">FixedArg</span><span class="s3">([</span><span class="s6">88 </span><span class="s3">- </span><span class="s6">1e-9</span><span class="s3">, </span><span class="s6">88</span><span class="s3">, </span><span class="s6">88 </span><span class="s3">+ </span><span class="s6">1e-9</span><span class="s3">])])</span>

    <span class="s2">def </span><span class="s1">test_chi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">chi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">shichi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s5"># chi oscillates as Im[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">chi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">chi</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1e8</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ci</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">ci</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">sici</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s5"># oscillating function: limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ci</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_ci_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">ci</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">sici</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s5"># ci oscillates as Re[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">ci</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ci</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s6">1e8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cospi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">eps</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">_cospi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">cospi</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">2</span><span class="s3">*</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cospi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_cospi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">cospi</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_digamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_digamma_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Test on a cut plane because mpmath will hang. See</span>
        <span class="s5"># test_digamma_negreal for tests on the negative real axis.</span>
        <span class="s2">def </span><span class="s1">param_filter</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">((</span><span class="s1">z</span><span class="s3">.</span><span class="s1">real </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">) &amp; (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">) &lt; </span><span class="s6">1.12</span><span class="s3">), </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">digamma</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">40</span><span class="s3">,</span>
            <span class="s1">param_filter</span><span class="s3">=</span><span class="s1">param_filter</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_e1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exp1</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">e1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_e1_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># E_1 oscillates as Im[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exp1</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">e1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1e8</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5"># Check cross-over region</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exp1</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">e1</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">50</span><span class="s3">, </span><span class="s6">50</span><span class="s3">, </span><span class="s6">171</span><span class="s3">)[:, </span><span class="s2">None</span><span class="s3">]</span>
             <span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">61</span><span class="s3">), -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">11</span><span class="s3">)]*</span><span class="s6">1j</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">(),</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exp1</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">e1</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s6">50</span><span class="s3">, -</span><span class="s6">35</span><span class="s3">, </span><span class="s6">10000</span><span class="s3">) + </span><span class="s6">0j</span><span class="s3">),</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exprel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exprel</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">expm1</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)/</span><span class="s1">x </span><span class="s2">if </span><span class="s1">x </span><span class="s3">!= </span><span class="s6">0 </span><span class="s2">else </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'1.0'</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">max</span><span class="s3">),</span>
                 <span class="s1">b</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">max</span><span class="s3">))],</span>
        <span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">exprel</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">expm1</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)/</span><span class="s1">x </span><span class="s2">if </span><span class="s1">x </span><span class="s3">!= </span><span class="s6">0 </span><span class="s2">else </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'1.0'</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1e-12</span><span class="s3">, </span><span class="s6">1e-24</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e12</span><span class="s3">, </span><span class="s6">1e24</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]),</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isinf</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">exprel</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">exprel</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">) == </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_expm1_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Oscillates as a function of Im[z], so limit range to avoid loss of precision</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">expm1</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">expm1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1e7</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">1e7</span><span class="s3">))],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_log1p_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">log1p</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">+</span><span class="s6">1</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">60</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_log1pmx</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_log1pmx</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">) - </span><span class="s1">x</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">60</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ei</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">expi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ei</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ei_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Ei oscillates as Im[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">expi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ei</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1e8</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-9</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipe</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipe</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipe</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_ellipeinc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipeinc</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipe</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)])</span>

    <span class="s2">def </span><span class="s1">test_ellipeinc_largephi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipeinc</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipe</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_ellipf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipkinc</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipf</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_ellipf_largephi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipkinc</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipf</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_ellipk</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipk</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipk</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)])</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipkm1</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">m</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipk</span><span class="s3">(</span><span class="s6">1 </span><span class="s3">- </span><span class="s1">m</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0.0</span><span class="s3">)],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipkinc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">ellipkinc</span><span class="s3">(</span><span class="s1">phi</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellippi</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipkinc</span><span class="s3">,</span>
            <span class="s1">ellipkinc</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)],</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipkinc_largephi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">ellipkinc</span><span class="s3">(</span><span class="s1">phi</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellippi</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipkinc</span><span class="s3">,</span>
            <span class="s1">ellipkinc</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">b</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)],</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipfun_sn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">sn</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
            <span class="s5"># mpmath doesn't get the zero at u = 0--fix that</span>
            <span class="s2">if </span><span class="s1">u </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s6">0</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipfun</span><span class="s3">(</span><span class="s4">&quot;sn&quot;</span><span class="s3">, </span><span class="s1">u</span><span class="s3">=</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">=</span><span class="s1">m</span><span class="s3">)</span>

        <span class="s5"># Oscillating function --- limit range of first argument; the</span>
        <span class="s5"># loss of precision there is an expected numerical feature</span>
        <span class="s5"># rather than an actual bug</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipj</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">],</span>
            <span class="s1">sn</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e6</span><span class="s3">, </span><span class="s6">1e6</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipfun_cn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># see comment in ellipfun_sn</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipj</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">],</span>
            <span class="s2">lambda </span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipfun</span><span class="s3">(</span><span class="s4">&quot;cn&quot;</span><span class="s3">, </span><span class="s1">u</span><span class="s3">=</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">=</span><span class="s1">m</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e6</span><span class="s3">, </span><span class="s6">1e6</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ellipfun_dn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># see comment in ellipfun_sn</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">ellipj</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">],</span>
            <span class="s2">lambda </span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ellipfun</span><span class="s3">(</span><span class="s4">&quot;dn&quot;</span><span class="s3">, </span><span class="s1">u</span><span class="s3">=</span><span class="s1">u</span><span class="s3">, </span><span class="s1">m</span><span class="s3">=</span><span class="s1">m</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e6</span><span class="s3">, </span><span class="s6">1e6</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_erf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">), [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_erf_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">), [</span><span class="s1">ComplexArg</span><span class="s3">()], </span><span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_erfc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_erfc_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_erfi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erfi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfi</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_erfi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">erfi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfi</span><span class="s3">, [</span><span class="s1">ComplexArg</span><span class="s3">()], </span><span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ndtr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ndtr</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ncdf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ndtr_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ndtr</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">(-</span><span class="s1">z</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2.</span><span class="s3">))/</span><span class="s6">2.</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s1">complex</span><span class="s3">(-</span><span class="s6">10000</span><span class="s3">, -</span><span class="s6">10000</span><span class="s3">), </span><span class="s1">b</span><span class="s3">=</span><span class="s1">complex</span><span class="s3">(</span><span class="s6">10000</span><span class="s3">, </span><span class="s6">10000</span><span class="s3">))],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">400</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_log_ndtr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">log_ndtr</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ncdf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">))),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">n</span><span class="s3">=</span><span class="s6">600</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">=</span><span class="s6">300</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_log_ndtr_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">log_ndtr</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">erfc</span><span class="s3">(-</span><span class="s1">z</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2.</span><span class="s3">))/</span><span class="s6">2.</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s1">complex</span><span class="s3">(-</span><span class="s6">10000</span><span class="s3">, -</span><span class="s6">100</span><span class="s3">), </span><span class="s1">b</span><span class="s3">=</span><span class="s1">complex</span><span class="s3">(</span><span class="s6">10000</span><span class="s3">, </span><span class="s6">100</span><span class="s3">))],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">=</span><span class="s6">300</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_eulernum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">euler</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">],</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">eulernum</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10000</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">10000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_expint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">expn</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">expint</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">160</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fresnels</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fresnels</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">fresnel</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">fresnels</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">fresnels</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_fresnelc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fresnelc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">fresnel</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">fresnelc</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">fresnelc</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_gamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">, </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">), [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_gamma_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()], </span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gammainc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Larger arguments are tested in test_data.py:test_local</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">z</span><span class="s3">, </span><span class="s1">b</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">b</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gammaincc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Larger arguments are tested in test_data.py:test_local</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">gammaincc</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">z</span><span class="s3">, </span><span class="s1">a</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s1">a</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-11</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gammaln</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># The real part of loggamma is log(|gamma(z)|).</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">(</span><span class="s1">z</span><span class="s3">).</span><span class="s1">real</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">gammaln</span><span class="s3">, </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">f</span><span class="s3">), [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_gegenbauer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_gegenbauer</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gegenbauer</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gegenbauer_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Redefine functions to deal with numerical + mpmath issues</span>
        <span class="s2">def </span><span class="s1">gegenbauer</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s5"># Avoid overflow at large `a` (mpmath would need an even larger</span>
            <span class="s5"># dps to handle this correctly, so just skip this region)</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) &gt; </span><span class="s6">1e100</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

            <span class="s5"># Deal with n=0, n=1 correctly; mpmath 0.17 doesn't do these</span>
            <span class="s5"># always correctly</span>
            <span class="s2">if </span><span class="s1">n </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s6">1.0</span>
            <span class="s2">elif </span><span class="s1">n </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s6">2</span><span class="s3">*</span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gegenbauer</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

            <span class="s5"># Mpmath 0.17 gives wrong results (spurious zero) in some cases, so</span>
            <span class="s5"># compute the value by perturbing the result</span>
            <span class="s2">if </span><span class="s1">float</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) == </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">a </span><span class="s3">&lt; -</span><span class="s6">1 </span><span class="s2">and </span><span class="s1">float</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) == </span><span class="s1">int</span><span class="s3">(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)):</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gegenbauer</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'1e-50'</span><span class="s3">), </span><span class="s1">x</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &lt; </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'1e-50'</span><span class="s3">):</span>
                    <span class="s1">r </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'0.0'</span><span class="s3">)</span>

            <span class="s5"># Differing overflow thresholds in scipy vs. mpmath</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &gt; </span><span class="s6">1e270</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
            <span class="s2">return </span><span class="s1">r</span>

        <span class="s2">def </span><span class="s1">sc_gegenbauer</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_gegenbauer</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
            <span class="s5"># Differing overflow thresholds in scipy vs. mpmath</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &gt; </span><span class="s6">1e270</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
            <span class="s2">return </span><span class="s1">r</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc_gegenbauer</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">gegenbauer</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e9</span><span class="s3">, </span><span class="s6">1e9</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">40000</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5"># Check the small-x expansion</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc_gegenbauer</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">gegenbauer</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">FixedArg</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">30</span><span class="s3">, -</span><span class="s6">4</span><span class="s3">, </span><span class="s6">30</span><span class="s3">))],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_gegenbauer_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_gegenbauer</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">a</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gegenbauer</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">nonfunctional_tooslow</span>
    <span class="s2">def </span><span class="s1">test_gegenbauer_complex_general</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_gegenbauer</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">a</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gegenbauer</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_hankel1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">hankel1</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hankel1</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e20</span><span class="s3">, </span><span class="s6">1e20</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_hankel2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">hankel2</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hankel2</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e20</span><span class="s3">, </span><span class="s6">1e20</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;issues at intermediately large orders&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_hermite</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_hermite</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hermite</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">10000</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s5"># hurwitz: same as zeta</span>

    <span class="s2">def </span><span class="s1">test_hyp0f1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># mpmath reports no convergence unless maxterms is large enough</span>
        <span class="s1">KW </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">maxprec</span><span class="s3">=</span><span class="s6">400</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s6">1500</span><span class="s3">)</span>
        <span class="s5"># n=500 (non-xslow default) fails for one bad point</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">KW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e7</span><span class="s3">, </span><span class="s6">1e7</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e5</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">5000</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s5"># NB: The range of the second parameter (&quot;z&quot;) is limited from below</span>
        <span class="s5"># because of an overflow in the intermediate calculations. The way</span>
        <span class="s5"># for fix it is to implement an asymptotic expansion for Bessel J</span>
        <span class="s5"># (similar to what is implemented for Bessel I here).</span>

    <span class="s2">def </span><span class="s1">test_hyp0f1_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp0f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s6">120</span><span class="s3">, -</span><span class="s6">120</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s6">120</span><span class="s3">, </span><span class="s6">120</span><span class="s3">))],</span>
        <span class="s3">)</span>
        <span class="s5"># NB: The range of the first parameter (&quot;v&quot;) are limited by an overflow</span>
        <span class="s5"># in the intermediate calculations. Can be fixed by implementing an</span>
        <span class="s5"># asymptotic expansion for Bessel functions for large order.</span>

    <span class="s2">def </span><span class="s1">test_hyp1f1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpmath_hyp1f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp1f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">ZeroDivisionError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp1f1</span><span class="s3">,</span>
            <span class="s1">mpmath_hyp1f1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">50</span><span class="s3">, </span><span class="s6">50</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">50</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">50</span><span class="s3">, </span><span class="s6">50</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">500</span><span class="s3">,</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_hyp1f1_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">inf_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp1f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">b</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp1f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">2000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">nonfunctional_tooslow</span>
    <span class="s2">def </span><span class="s1">test_hyp2f1_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># SciPy's hyp2f1 seems to have performance and accuracy problems</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">b</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e2</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e2</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e2</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">10</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_hyperu</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyperu</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail_on_32bit</span><span class="s3">(</span><span class="s4">&quot;mpmath issue gh-342: &quot;</span>
                                <span class="s4">&quot;unsupported operand mpz, long for pow&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_igam_fac</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_igam_fac</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)*</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">)/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_igam_fac</span><span class="s3">,</span>
            <span class="s1">mp_igam_fac</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e14</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e14</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_j0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># The Bessel function at large arguments is j0(x) ~ cos(x + phi)/sqrt(x)</span>
        <span class="s5"># and at large arguments the phase of the cosine loses precision.</span>
        <span class="s5">#</span>
        <span class="s5"># This is numerically expected behavior, so we compare only up to</span>
        <span class="s5"># 1e8 = 1e15 * 1e-7</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">j0</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">j0</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">j0</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">j0</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_j1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># See comment in test_j0</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">j1</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">j1</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e3</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">)])</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">j1</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">j1</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_jacobi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_jacobi</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">jacobi</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_jacobi</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">jacobi</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_jacobi_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Redefine functions to deal with numerical + mpmath issues</span>
        <span class="s2">def </span><span class="s1">jacobi</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s5"># Mpmath does not handle n=0 case always correctly</span>
            <span class="s2">if </span><span class="s1">n </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s6">1.0</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">jacobi</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_jacobi</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">jacobi</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">20000</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_kei</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">kei</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">x </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s5"># work around mpmath issue at x=0</span>
                <span class="s2">return </span><span class="s3">-</span><span class="s1">pi</span><span class="s3">/</span><span class="s6">4</span>
            <span class="s2">return </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">kei</span><span class="s3">)(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">kei</span><span class="s3">, </span><span class="s1">kei</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e30</span><span class="s3">, </span><span class="s6">1e30</span><span class="s3">)], </span><span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ker</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">ker</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ker</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e30</span><span class="s3">, </span><span class="s6">1e30</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">nonfunctional_tooslow</span>
    <span class="s2">def </span><span class="s1">test_laguerre</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">trace_args</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_laguerre</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">laguerre</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_laguerre_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_laguerre</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">laguerre</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">20000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail_on_32bit</span><span class="s3">(</span><span class="s4">&quot;see gh-3551 for bad points&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_lambertw_real</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">int</span><span class="s3">(</span><span class="s1">k</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)),</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">int</span><span class="s3">(</span><span class="s1">k</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">, </span><span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_lanczos_sum_expg_scaled</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">maxgamma </span><span class="s3">= </span><span class="s6">171.624376956302725</span>
        <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s6">6.024680040776729583740234375</span>

        <span class="s2">def </span><span class="s1">gamma</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">over</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
                <span class="s1">fac </span><span class="s3">= ((</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">g </span><span class="s3">- </span><span class="s6">0.5</span><span class="s3">)/</span><span class="s1">e</span><span class="s3">)**(</span><span class="s1">x </span><span class="s3">- </span><span class="s6">0.5</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">fac </span><span class="s3">!= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">:</span>
                    <span class="s1">res </span><span class="s3">= </span><span class="s1">fac</span><span class="s3">*</span><span class="s1">_lanczos_sum_expg_scaled</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">fac </span><span class="s3">= ((</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">g </span><span class="s3">- </span><span class="s6">0.5</span><span class="s3">)/</span><span class="s1">e</span><span class="s3">)**(</span><span class="s6">0.5</span><span class="s3">*(</span><span class="s1">x </span><span class="s3">- </span><span class="s6">0.5</span><span class="s3">))</span>
                    <span class="s1">res </span><span class="s3">= </span><span class="s1">fac</span><span class="s3">*</span><span class="s1">_lanczos_sum_expg_scaled</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
                    <span class="s1">res </span><span class="s3">*= </span><span class="s1">fac</span>
            <span class="s2">return </span><span class="s1">res</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">gamma</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">maxgamma</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">nonfunctional_tooslow</span>
    <span class="s2">def </span><span class="s1">test_legendre</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_legendre</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legendre</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_legendre_int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_legendre</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legendre</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">20000</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5"># Check the small-x expansion</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">eval_legendre</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">x</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legendre</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(), </span><span class="s1">FixedArg</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">30</span><span class="s3">, -</span><span class="s6">4</span><span class="s3">, </span><span class="s6">20</span><span class="s3">))],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_legenp</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">lpnm</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lpmn</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) &gt; </span><span class="s6">1e306</span><span class="s3">:</span>
                <span class="s5"># harmonize overflow to inf</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">v</span>

        <span class="s2">def </span><span class="s1">lpnm_2</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lpmv</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) &gt; </span><span class="s6">1e306</span><span class="s3">:</span>
                <span class="s5"># harmonize overflow to inf</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">v</span>

        <span class="s2">def </span><span class="s1">legenp</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">z </span><span class="s3">== </span><span class="s6">1 </span><span class="s2">or </span><span class="s1">z </span><span class="s3">== -</span><span class="s6">1</span><span class="s3">) </span><span class="s2">and </span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) == </span><span class="s1">n</span><span class="s3">:</span>
                <span class="s5"># Special case (mpmath may give inf, we take the limit by</span>
                <span class="s5"># continuity)</span>
                <span class="s2">if </span><span class="s1">m </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">n </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
                        <span class="s1">n </span><span class="s3">= -</span><span class="s1">n </span><span class="s3">- </span><span class="s6">1</span>
                    <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">z</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s6">0</span>

            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># mpmath has bad performance here</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

            <span class="s1">typ </span><span class="s3">= </span><span class="s6">2 </span><span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1 </span><span class="s2">else </span><span class="s6">3</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenp</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s1">typ</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) &gt; </span><span class="s6">1e306</span><span class="s3">:</span>
                <span class="s5"># harmonize overflow to inf</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">inf </span><span class="s3">* </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>

            <span class="s2">return </span><span class="s1">v</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">lpnm</span><span class="s3">, </span><span class="s1">legenp</span><span class="s3">, [</span><span class="s1">IntArg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()])</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">lpnm_2</span><span class="s3">,</span>
            <span class="s1">legenp</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)],</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_legenp_complex_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">clpnm</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">clpmn</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

        <span class="s2">def </span><span class="s1">legenp</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># mpmath has bad performance here</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenp</span><span class="s3">)(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>

        <span class="s5"># mpmath is quite slow here</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">0.99</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e-5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s6">2e3</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">1e3</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.3</span><span class="s3">])</span>
        <span class="s1">z </span><span class="s3">= (</span><span class="s1">x</span><span class="s3">[:,</span><span class="s2">None</span><span class="s3">] + </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">[</span><span class="s2">None</span><span class="s3">,:]).</span><span class="s1">ravel</span><span class="s3">()</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">clpnm</span><span class="s3">,</span>
            <span class="s1">legenp</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">FixedArg</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]),</span>
             <span class="s1">FixedArg</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]),</span>
             <span class="s1">FixedArg</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">,</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">500</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_legenp_complex_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">clpnm</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">clpmn</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

        <span class="s2">def </span><span class="s1">legenp</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># mpmath has bad performance here</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenp</span><span class="s3">)(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>

        <span class="s5"># mpmath is quite slow here</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">0.99</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e-5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.99</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s6">2e3</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">1e3</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.3</span><span class="s3">])</span>
        <span class="s1">z </span><span class="s3">= (</span><span class="s1">x</span><span class="s3">[:,</span><span class="s2">None</span><span class="s3">] + </span><span class="s6">1j</span><span class="s3">*</span><span class="s1">y</span><span class="s3">[</span><span class="s2">None</span><span class="s3">,:]).</span><span class="s1">ravel</span><span class="s3">()</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">clpnm</span><span class="s3">,</span>
            <span class="s1">legenp</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">FixedArg</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]),</span>
             <span class="s1">FixedArg</span><span class="s3">([-</span><span class="s6">2</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]),</span>
             <span class="s1">FixedArg</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">,</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">500</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;apparently picks wrong function at |z| &gt; 1&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_legenq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">lqnm</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lqmn</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">legenq</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># mpmath has bad performance here</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenq</span><span class="s3">)(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">lqnm</span><span class="s3">,</span>
            <span class="s1">legenq</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">nonfunctional_tooslow</span>
    <span class="s2">def </span><span class="s1">test_legenq_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">lqnm</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">lqmn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">,-</span><span class="s6">1</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">legenq</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) &lt; </span><span class="s6">1e-15</span><span class="s3">:</span>
                <span class="s5"># mpmath has bad performance here</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">legenq</span><span class="s3">)(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">lqnm</span><span class="s3">,</span>
            <span class="s1">legenq</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_lgam1p</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">param_filter</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s5"># Filter the poles</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) == </span><span class="s1">x</span><span class="s3">) &amp; (</span><span class="s1">x </span><span class="s3">&lt;= </span><span class="s6">0</span><span class="s3">), </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">mp_lgam1p</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s5"># The real part of loggamma is log(|gamma(z)|)</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">(</span><span class="s6">1 </span><span class="s3">+ </span><span class="s1">z</span><span class="s3">).</span><span class="s1">real</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_lgam1p</span><span class="s3">,</span>
            <span class="s1">mp_lgam1p</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
            <span class="s1">param_filter</span><span class="s3">=</span><span class="s1">param_filter</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_loggamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpmath_loggamma</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">res</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">loggamma</span><span class="s3">,</span>
            <span class="s1">mpmath_loggamma</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">distinguish_nan_and_inf</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pcfd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">pcfd</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">pbdv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">pcfd</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pcfd</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;it's not the same as the mpmath function --- &quot;</span>
                                         <span class="s4">&quot;maybe different definition?&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pcfv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">pcfv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">pbvv</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">pcfv</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">time_limited</span><span class="s3">()(</span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pcfv</span><span class="s3">))(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, **</span><span class="s1">HYPERKW</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pcfw</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">pcfw</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">pbwa</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">dpcfw</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">pbwa</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>

        <span class="s2">def </span><span class="s1">mpmath_dpcfw</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">diff</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pcfw</span><span class="s3">, (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">x</span><span class="s3">), (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">))</span>

        <span class="s5"># The Zhang and Jin implementation only uses Taylor series and</span>
        <span class="s5"># is thus accurate in only a very small range.</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">pcfw</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pcfw</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">2e-8</span><span class="s3">,</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">dpcfw</span><span class="s3">,</span>
            <span class="s1">mpmath_dpcfw</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">2e-9</span><span class="s3">,</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                       <span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;issues at large arguments (atol OK, rtol not) &quot;</span>
                              <span class="s4">&quot;and &lt;eps-close to z=0&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_polygamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">polygamma</span><span class="s3">,</span>
            <span class="s1">time_limited</span><span class="s3">()(</span><span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">polygamma</span><span class="s3">)),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1000</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_rgamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">8000</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">5000</span><span class="s3">,</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_rgamma_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">rgamma</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">=(</span><span class="s4">&quot;see gh-3551 for bad points on 32 bit &quot;</span>
                               <span class="s4">&quot;systems and gh-8095 for another bad &quot;</span>
                               <span class="s4">&quot;point&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">_pep440</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &gt;= </span><span class="s1">_pep440</span><span class="s3">.</span><span class="s1">Version</span><span class="s3">(</span><span class="s4">&quot;1.0.0&quot;</span><span class="s3">):</span>
            <span class="s5"># no workarounds needed</span>
            <span class="s1">mppoch </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">rf</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">def </span><span class="s1">mppoch</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
                <span class="s5"># deal with cases where the result in double precision</span>
                <span class="s5"># hits exactly a non-positive integer, but the</span>
                <span class="s5"># corresponding extended-precision mpf floats don't</span>
                <span class="s2">if </span><span class="s1">float</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">) == </span><span class="s1">int</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">) </span><span class="s2">and </span><span class="s1">float</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">) &lt;= </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s1">a </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
                    <span class="s1">m </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">) - </span><span class="s1">a</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">rf</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">sc</span><span class="s3">.</span><span class="s1">poch</span><span class="s3">, </span><span class="s1">mppoch</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">dps</span><span class="s3">=</span><span class="s6">400</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sinpi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">eps</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_sinpi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sinpi</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">2</span><span class="s3">*</span><span class="s1">eps</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sinpi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">_sinpi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sinpi</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">2e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_shi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">shi</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">shichi</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">shi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">shi</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()])</span>
        <span class="s5"># check asymptotic series cross-over</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">shi</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">shi</span><span class="s3">, [</span><span class="s1">FixedArg</span><span class="s3">([</span><span class="s6">88 </span><span class="s3">- </span><span class="s6">1e-9</span><span class="s3">, </span><span class="s6">88</span><span class="s3">, </span><span class="s6">88 </span><span class="s3">+ </span><span class="s6">1e-9</span><span class="s3">])])</span>

    <span class="s2">def </span><span class="s1">test_shi_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">shi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">shichi</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s5"># shi oscillates as Im[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">shi</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">shi</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1e8</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_si</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">si</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">sici</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span><span class="s1">si</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">si</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">()])</span>

    <span class="s2">def </span><span class="s1">test_si_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">si</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">sici</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s5"># si oscillates as Re[z] -&gt; +- inf, so limit range</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">si</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">si</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">(</span><span class="s1">complex</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), </span><span class="s1">complex</span><span class="s3">(</span><span class="s6">1e8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">))],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># mpmath uses a different convention for the dilogarithm</span>
        <span class="s2">def </span><span class="s1">dilog</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">polylog</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s5"># Spence has a branch cut on the negative real axis</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">spence</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">dilog</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spence_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">dilog</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">polylog</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">z</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">spence</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">dilog</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherharm</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">spherharm</span><span class="s3">(</span><span class="s1">l</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">theta</span><span class="s3">, </span><span class="s1">phi</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">m </span><span class="s3">&gt; </span><span class="s1">l</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">sph_harm</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">l</span><span class="s3">, </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">theta</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">spherharm</span><span class="s3">,</span>
            <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">spherharm</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">pi</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s6">2</span><span class="s3">*</span><span class="s1">pi</span><span class="s3">)],</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">,</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">6000</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">150</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_struveh</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">struve</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">struveh</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e4</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-10</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_struvel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_struvel</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">v </span><span class="s3">&lt; </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">z </span><span class="s3">&lt; -</span><span class="s1">v </span><span class="s2">and </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) &gt; </span><span class="s6">1000</span><span class="s3">:</span>
                <span class="s5"># larger DPS needed for correct results</span>
                <span class="s1">old_dps </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps </span><span class="s3">= </span><span class="s6">300</span>
                    <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">struvel</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)</span>
                <span class="s2">finally</span><span class="s3">:</span>
                    <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps </span><span class="s3">= </span><span class="s1">old_dps</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">struvel</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">modstruve</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_struvel</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e4</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-10</span><span class="s3">,</span>
            <span class="s1">ignore_inf_sign</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrightomega_real</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mpmath_wrightomega_real</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">lambertw</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s4">'-0.5'</span><span class="s3">))</span>

        <span class="s5"># For x &lt; -1000 the Wright Omega function is just 0 to double</span>
        <span class="s5"># precision, and for x &gt; 1e21 it is just x to double</span>
        <span class="s5"># precision.</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">wrightomega</span><span class="s3">,</span>
            <span class="s1">mpmath_wrightomega_real</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1000</span><span class="s3">, </span><span class="s6">1e21</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-15</span><span class="s3">,</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrightomega</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">wrightomega</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">z</span><span class="s3">: </span><span class="s1">_mpmath_wrightomega</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s6">25</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-14</span><span class="s3">,</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_hurwitz_zeta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s6">1e10</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_riemann_zeta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">if </span><span class="s1">x </span><span class="s3">!= </span><span class="s6">1 </span><span class="s2">else </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_zetac</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">zetac</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) - </span><span class="s6">1 </span><span class="s2">if </span><span class="s1">x </span><span class="s3">!= </span><span class="s6">1 </span><span class="s2">else </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">100</span><span class="s3">, </span><span class="s6">100</span><span class="s3">)],</span>
            <span class="s1">nan_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">45</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_boxcox</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">mp_boxcox</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">lmbda </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">powm1</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">) / </span><span class="s1">lmbda</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_boxcox</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">60</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_boxcox1p</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">def </span><span class="s1">mp_boxcox1p</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">)</span>
            <span class="s1">one </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">lmbda </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">one </span><span class="s3">+ </span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">powm1</span><span class="s3">(</span><span class="s1">one </span><span class="s3">+ </span><span class="s1">x</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">) / </span><span class="s1">lmbda</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sc</span><span class="s3">.</span><span class="s1">boxcox1p</span><span class="s3">,</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_boxcox1p</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=-</span><span class="s6">1</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">60</span><span class="s3">,</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-13</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_jn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_jn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselj</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_jn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_jn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e8</span><span class="s3">, </span><span class="s6">1e8</span><span class="s3">)],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">300</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_jn_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_jn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselj</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_jn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_jn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()]</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_yn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_yn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bessely</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_yn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_yn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e10</span><span class="s3">, </span><span class="s6">1e10</span><span class="s3">)],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_yn_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_yn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">bessely</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_yn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_yn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_in</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_in</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besseli</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_in</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_in</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
            <span class="s1">atol</span><span class="s3">=</span><span class="s6">10</span><span class="s3">**(-</span><span class="s6">278</span><span class="s3">),</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_in_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_in</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besseli</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_in</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_in</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_spherical_kn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_kn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselk</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">z</span><span class="s3">) *</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">))))</span>
            <span class="s2">if </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">).</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_kn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_kn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">150</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                       <span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;Accuracy issues near z = -1 inherited from kv.&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_spherical_kn_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">mp_spherical_kn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpmathify</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)</span>
            <span class="s1">out </span><span class="s3">= (</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besselk</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">) /</span>
                   <span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">*</span><span class="s1">arg</span><span class="s3">/</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">real</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">out</span>

        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">sc</span><span class="s3">.</span><span class="s1">spherical_kn</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">n</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">z</span><span class="s3">),</span>
            <span class="s1">exception_to_nan</span><span class="s3">(</span><span class="s1">mp_spherical_kn</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">200</span><span class="s3">), </span><span class="s1">ComplexArg</span><span class="s3">()],</span>
            <span class="s1">dps</span><span class="s3">=</span><span class="s6">200</span><span class="s3">,</span>
        <span class="s3">)</span>
</pre>
</body>
</html>