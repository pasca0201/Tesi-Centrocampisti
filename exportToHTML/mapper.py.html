<html>
<head>
<title>mapper.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
mapper.py</font>
</center></td></tr></table>
<pre><span class="s0"># orm/mapper.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: allow-untyped-defs, allow-untyped-calls</span>

<span class="s2">&quot;&quot;&quot;Logic to map Python classes to and from selectables. 
 
Defines the :class:`~sqlalchemy.orm.mapper.Mapper` class, the central 
configurational unit which associates a class with a database table. 
 
This is a semi-private module; the main configurational API of the ORM is 
available in :class:`~sqlalchemy.orm.`. 
 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">deque</span>
<span class="s3">from </span><span class="s1">functools </span><span class="s3">import </span><span class="s1">reduce</span>
<span class="s3">from </span><span class="s1">itertools </span><span class="s3">import </span><span class="s1">chain</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">threading</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">cast</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Collection</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Deque</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Dict</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">FrozenSet</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Generic</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Iterable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Iterator</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">List</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Mapping</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Optional</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Sequence</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Set</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Tuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Type</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TYPE_CHECKING</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TypeVar</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Union</span>
<span class="s3">import </span><span class="s1">weakref</span>

<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">attributes</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">exc </span><span class="s3">as </span><span class="s1">orm_exc</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">instrumentation</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">loading</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">properties</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">util </span><span class="s3">as </span><span class="s1">orm_util</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_O</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">_class_to_mapper</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">_parse_mapper_argument</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">_state_mapper</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">PassiveFlag</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">state_str</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">_MappedAttribute</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">EXT_SKIP</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">InspectionAttr</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">MapperProperty</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">ORMEntityColumnsClauseRole</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">ORMFromClauseRole</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">interfaces </span><span class="s3">import </span><span class="s1">StrategizedProperty</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">path_registry </span><span class="s3">import </span><span class="s1">PathRegistry</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">event</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">exc </span><span class="s3">as </span><span class="s1">sa_exc</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">inspection</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">log</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">schema</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">sql</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">util</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">event </span><span class="s3">import </span><span class="s1">dispatcher</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">event </span><span class="s3">import </span><span class="s1">EventTarget</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">base </span><span class="s3">as </span><span class="s1">sql_base</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">coercions</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">expression</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">operators</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">roles</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">TableClause</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">util </span><span class="s3">as </span><span class="s1">sql_util</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql </span><span class="s3">import </span><span class="s1">visitors</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">cache_key </span><span class="s3">import </span><span class="s1">MemoizedHasCacheKey</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">elements </span><span class="s3">import </span><span class="s1">KeyedColumnElement</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">schema </span><span class="s3">import </span><span class="s1">Column</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">schema </span><span class="s3">import </span><span class="s1">Table</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">selectable </span><span class="s3">import </span><span class="s1">LABEL_STYLE_TABLENAME_PLUS_COL</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">util </span><span class="s3">import </span><span class="s1">HasMemoized</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">util </span><span class="s3">import </span><span class="s1">HasMemoized_ro_memoized_attribute</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">util</span><span class="s4">.</span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Literal</span>

<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_IdentityKeyType</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_InstanceDict</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_ORMColumnExprArgument</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_RegistryType</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">decl_api </span><span class="s3">import </span><span class="s1">registry</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">dependency </span><span class="s3">import </span><span class="s1">DependencyProcessor</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">descriptor_props </span><span class="s3">import </span><span class="s1">CompositeProperty</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">descriptor_props </span><span class="s3">import </span><span class="s1">SynonymProperty</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">events </span><span class="s3">import </span><span class="s1">MapperEvents</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">instrumentation </span><span class="s3">import </span><span class="s1">ClassManager</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">path_registry </span><span class="s3">import </span><span class="s1">CachingEntityRegistry</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">properties </span><span class="s3">import </span><span class="s1">ColumnProperty</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">relationships </span><span class="s3">import </span><span class="s1">RelationshipProperty</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">state </span><span class="s3">import </span><span class="s1">InstanceState</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">util </span><span class="s3">import </span><span class="s1">ORMAdapter</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">engine </span><span class="s3">import </span><span class="s1">Row</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">engine </span><span class="s3">import </span><span class="s1">RowMapping</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_ColumnExpressionArgument</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">_EquivalentColumnMap</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">ReadOnlyColumnCollection</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">elements </span><span class="s3">import </span><span class="s1">ColumnClause</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">elements </span><span class="s3">import </span><span class="s1">ColumnElement</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">selectable </span><span class="s3">import </span><span class="s1">FromClause</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">util </span><span class="s3">import </span><span class="s1">OrderedSet</span>


<span class="s1">_T </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_T&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>
<span class="s1">_MP </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_MP&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s5">&quot;MapperProperty[Any]&quot;</span><span class="s4">)</span>
<span class="s1">_Fn </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_Fn&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s5">&quot;Callable[..., Any]&quot;</span><span class="s4">)</span>


<span class="s1">_WithPolymorphicArg </span><span class="s4">= </span><span class="s1">Union</span><span class="s4">[</span>
    <span class="s1">Literal</span><span class="s4">[</span><span class="s5">&quot;*&quot;</span><span class="s4">],</span>
    <span class="s1">Tuple</span><span class="s4">[</span>
        <span class="s1">Union</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s5">&quot;*&quot;</span><span class="s4">], </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s5">&quot;Mapper[Any]&quot;</span><span class="s4">, </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]],</span>
        <span class="s1">Optional</span><span class="s4">[</span><span class="s5">&quot;FromClause&quot;</span><span class="s4">],</span>
    <span class="s4">],</span>
    <span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s5">&quot;Mapper[Any]&quot;</span><span class="s4">, </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]],</span>
<span class="s4">]</span>


<span class="s1">_mapper_registries</span><span class="s4">: </span><span class="s1">weakref</span><span class="s4">.</span><span class="s1">WeakKeyDictionary</span><span class="s4">[</span><span class="s1">_RegistryType</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">] = (</span>
    <span class="s1">weakref</span><span class="s4">.</span><span class="s1">WeakKeyDictionary</span><span class="s4">()</span>
<span class="s4">)</span>


<span class="s3">def </span><span class="s1">_all_registries</span><span class="s4">() </span><span class="s1">-&gt; Set</span><span class="s4">[</span><span class="s1">registry</span><span class="s4">]:</span>
    <span class="s3">with </span><span class="s1">_CONFIGURE_MUTEX</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">set</span><span class="s4">(</span><span class="s1">_mapper_registries</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_unconfigured_mappers</span><span class="s4">() </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
    <span class="s3">for </span><span class="s1">reg </span><span class="s3">in </span><span class="s1">_all_registries</span><span class="s4">():</span>
        <span class="s3">yield from </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_mappers_to_configure</span><span class="s4">()</span>


<span class="s1">_already_compiling </span><span class="s4">= </span><span class="s3">False</span>


<span class="s0"># a constant returned by _get_attr_by_column to indicate</span>
<span class="s0"># this mapper is not handling an attribute for a particular</span>
<span class="s0"># column</span>
<span class="s1">NO_ATTRIBUTE </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">symbol</span><span class="s4">(</span><span class="s5">&quot;NO_ATTRIBUTE&quot;</span><span class="s4">)</span>

<span class="s0"># lock used to synchronize the &quot;mapper configure&quot; step</span>
<span class="s1">_CONFIGURE_MUTEX </span><span class="s4">= </span><span class="s1">threading</span><span class="s4">.</span><span class="s1">RLock</span><span class="s4">()</span>


<span class="s4">@</span><span class="s1">inspection</span><span class="s4">.</span><span class="s1">_self_inspects</span>
<span class="s4">@</span><span class="s1">log</span><span class="s4">.</span><span class="s1">class_logger</span>
<span class="s3">class </span><span class="s1">Mapper</span><span class="s4">(</span>
    <span class="s1">ORMFromClauseRole</span><span class="s4">,</span>
    <span class="s1">ORMEntityColumnsClauseRole</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
    <span class="s1">MemoizedHasCacheKey</span><span class="s4">,</span>
    <span class="s1">InspectionAttr</span><span class="s4">,</span>
    <span class="s1">log</span><span class="s4">.</span><span class="s1">Identified</span><span class="s4">,</span>
    <span class="s1">inspection</span><span class="s4">.</span><span class="s1">Inspectable</span><span class="s4">[</span><span class="s5">&quot;Mapper[_O]&quot;</span><span class="s4">],</span>
    <span class="s1">EventTarget</span><span class="s4">,</span>
    <span class="s1">Generic</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Defines an association between a Python class and a database table or 
    other relational structure, so that ORM operations against the class may 
    proceed. 
 
    The :class:`_orm.Mapper` object is instantiated using mapping methods 
    present on the :class:`_orm.registry` object.  For information 
    about instantiating new :class:`_orm.Mapper` objects, see 
    :ref:`orm_mapping_classes_toplevel`. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">dispatch</span><span class="s4">: </span><span class="s1">dispatcher</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]]</span>

    <span class="s1">_dispose_called </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">_configure_failed</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">_ready_for_configure </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">deprecated_params</span><span class="s4">(</span>
        <span class="s1">non_primary</span><span class="s4">=(</span>
            <span class="s5">&quot;1.3&quot;</span><span class="s4">,</span>
            <span class="s5">&quot;The :paramref:`.mapper.non_primary` parameter is deprecated, &quot;</span>
            <span class="s5">&quot;and will be removed in a future release.  The functionality &quot;</span>
            <span class="s5">&quot;of non primary mappers is now better suited using the &quot;</span>
            <span class="s5">&quot;:class:`.AliasedClass` construct, which can also be used &quot;</span>
            <span class="s5">&quot;as the target of a :func:`_orm.relationship` in 1.3.&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">class_</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
        <span class="s1">local_table</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">properties</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapping</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">primary_key</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">_ORMColumnExprArgument</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">non_primary</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">inherits</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">inherit_condition</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">_ColumnExpressionArgument</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">inherit_foreign_keys</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span>
            <span class="s1">Sequence</span><span class="s4">[</span><span class="s1">_ORMColumnExprArgument</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
        <span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">always_refresh</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">version_id_col</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">_ORMColumnExprArgument</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">version_id_generator</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span>
            <span class="s1">Union</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s3">False</span><span class="s4">], </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">Any</span><span class="s4">]]</span>
        <span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">polymorphic_on</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span>
            <span class="s1">Union</span><span class="s4">[</span><span class="s1">_ORMColumnExprArgument</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">str</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
        <span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">_polymorphic_map</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">polymorphic_identity</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">concrete</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">with_polymorphic</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">_WithPolymorphicArg</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">polymorphic_abstract</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">polymorphic_load</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s5">&quot;selectin&quot;</span><span class="s4">, </span><span class="s5">&quot;inline&quot;</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">allow_partial_pks</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">batch</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">column_prefix</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">include_properties</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">exclude_properties</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">passive_updates</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">passive_deletes</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">confirm_deleted_rows</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">eager_defaults</span><span class="s4">: </span><span class="s1">Literal</span><span class="s4">[</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s5">&quot;auto&quot;</span><span class="s4">] = </span><span class="s5">&quot;auto&quot;</span><span class="s4">,</span>
        <span class="s1">legacy_is_orphan</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">_compiled_cache_size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">100</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s2">r&quot;&quot;&quot;Direct constructor for a new :class:`_orm.Mapper` object. 
 
        The :class:`_orm.Mapper` constructor is not called directly, and 
        is normally invoked through the 
        use of the :class:`_orm.registry` object through either the 
        :ref:`Declarative &lt;orm_declarative_mapping&gt;` or 
        :ref:`Imperative &lt;orm_imperative_mapping&gt;` mapping styles. 
 
        .. versionchanged:: 2.0 The public facing ``mapper()`` function is 
           removed; for a classical mapping configuration, use the 
           :meth:`_orm.registry.map_imperatively` method. 
 
        Parameters documented below may be passed to either the 
        :meth:`_orm.registry.map_imperatively` method, or may be passed in the 
        ``__mapper_args__`` declarative class attribute described at 
        :ref:`orm_declarative_mapper_options`. 
 
        :param class\_: The class to be mapped.  When using Declarative, 
          this argument is automatically passed as the declared class 
          itself. 
 
        :param local_table: The :class:`_schema.Table` or other 
           :class:`_sql.FromClause` (i.e. selectable) to which the class is 
           mapped. May be ``None`` if this mapper inherits from another mapper 
           using single-table inheritance. When using Declarative, this 
           argument is automatically passed by the extension, based on what is 
           configured via the :attr:`_orm.DeclarativeBase.__table__` attribute 
           or via the :class:`_schema.Table` produced as a result of 
           the :attr:`_orm.DeclarativeBase.__tablename__` attribute being 
           present. 
 
        :param polymorphic_abstract: Indicates this class will be mapped in a 
            polymorphic hierarchy, but not directly instantiated. The class is 
            mapped normally, except that it has no requirement for a 
            :paramref:`_orm.Mapper.polymorphic_identity` within an inheritance 
            hierarchy. The class however must be part of a polymorphic 
            inheritance scheme which uses 
            :paramref:`_orm.Mapper.polymorphic_on` at the base. 
 
            .. versionadded:: 2.0 
 
            .. seealso:: 
 
                :ref:`orm_inheritance_abstract_poly` 
 
        :param always_refresh: If True, all query operations for this mapped 
           class will overwrite all data within object instances that already 
           exist within the session, erasing any in-memory changes with 
           whatever information was loaded from the database. Usage of this 
           flag is highly discouraged; as an alternative, see the method 
           :meth:`_query.Query.populate_existing`. 
 
        :param allow_partial_pks: Defaults to True.  Indicates that a 
           composite primary key with some NULL values should be considered as 
           possibly existing within the database. This affects whether a 
           mapper will assign an incoming row to an existing identity, as well 
           as if :meth:`.Session.merge` will check the database first for a 
           particular primary key value. A &quot;partial primary key&quot; can occur if 
           one has mapped to an OUTER JOIN, for example. 
 
        :param batch: Defaults to ``True``, indicating that save operations 
           of multiple entities can be batched together for efficiency. 
           Setting to False indicates 
           that an instance will be fully saved before saving the next 
           instance.  This is used in the extremely rare case that a 
           :class:`.MapperEvents` listener requires being called 
           in between individual row persistence operations. 
 
        :param column_prefix: A string which will be prepended 
           to the mapped attribute name when :class:`_schema.Column` 
           objects are automatically assigned as attributes to the 
           mapped class.  Does not affect :class:`.Column` objects that 
           are mapped explicitly in the :paramref:`.Mapper.properties` 
           dictionary. 
 
           This parameter is typically useful with imperative mappings 
           that keep the :class:`.Table` object separate.  Below, assuming 
           the ``user_table`` :class:`.Table` object has columns named 
           ``user_id``, ``user_name``, and ``password``:: 
 
                class User(Base): 
                    __table__ = user_table 
                    __mapper_args__ = {'column_prefix':'_'} 
 
           The above mapping will assign the ``user_id``, ``user_name``, and 
           ``password`` columns to attributes named ``_user_id``, 
           ``_user_name``, and ``_password`` on the mapped ``User`` class. 
 
           The :paramref:`.Mapper.column_prefix` parameter is uncommon in 
           modern use. For dealing with reflected tables, a more flexible 
           approach to automating a naming scheme is to intercept the 
           :class:`.Column` objects as they are reflected; see the section 
           :ref:`mapper_automated_reflection_schemes` for notes on this usage 
           pattern. 
 
        :param concrete: If True, indicates this mapper should use concrete 
           table inheritance with its parent mapper. 
 
           See the section :ref:`concrete_inheritance` for an example. 
 
        :param confirm_deleted_rows: defaults to True; when a DELETE occurs 
          of one more rows based on specific primary keys, a warning is 
          emitted when the number of rows matched does not equal the number 
          of rows expected.  This parameter may be set to False to handle the 
          case where database ON DELETE CASCADE rules may be deleting some of 
          those rows automatically.  The warning may be changed to an 
          exception in a future release. 
 
        :param eager_defaults: if True, the ORM will immediately fetch the 
          value of server-generated default values after an INSERT or UPDATE, 
          rather than leaving them as expired to be fetched on next access. 
          This can be used for event schemes where the server-generated values 
          are needed immediately before the flush completes. 
 
          The fetch of values occurs either by using ``RETURNING`` inline 
          with the ``INSERT`` or ``UPDATE`` statement, or by adding an 
          additional ``SELECT`` statement subsequent to the ``INSERT`` or 
          ``UPDATE``, if the backend does not support ``RETURNING``. 
 
          The use of ``RETURNING`` is extremely performant in particular for 
          ``INSERT`` statements where SQLAlchemy can take advantage of 
          :ref:`insertmanyvalues &lt;engine_insertmanyvalues&gt;`, whereas the use of 
          an additional ``SELECT`` is relatively poor performing, adding 
          additional SQL round trips which would be unnecessary if these new 
          attributes are not to be accessed in any case. 
 
          For this reason, :paramref:`.Mapper.eager_defaults` defaults to the 
          string value ``&quot;auto&quot;``, which indicates that server defaults for 
          INSERT should be fetched using ``RETURNING`` if the backing database 
          supports it and if the dialect in use supports &quot;insertmanyreturning&quot; 
          for an INSERT statement. If the backing database does not support 
          ``RETURNING`` or &quot;insertmanyreturning&quot; is not available, server 
          defaults will not be fetched. 
 
          .. versionchanged:: 2.0.0rc1 added the &quot;auto&quot; option for 
             :paramref:`.Mapper.eager_defaults` 
 
          .. seealso:: 
 
                :ref:`orm_server_defaults` 
 
          .. versionchanged:: 2.0.0  RETURNING now works with multiple rows 
             INSERTed at once using the 
             :ref:`insertmanyvalues &lt;engine_insertmanyvalues&gt;` feature, which 
             among other things allows the :paramref:`.Mapper.eager_defaults` 
             feature to be very performant on supporting backends. 
 
        :param exclude_properties: A list or set of string column names to 
          be excluded from mapping. 
 
          .. seealso:: 
 
            :ref:`include_exclude_cols` 
 
        :param include_properties: An inclusive list or set of string column 
          names to map. 
 
          .. seealso:: 
 
            :ref:`include_exclude_cols` 
 
        :param inherits: A mapped class or the corresponding 
          :class:`_orm.Mapper` 
          of one indicating a superclass to which this :class:`_orm.Mapper` 
          should *inherit* from.   The mapped class here must be a subclass 
          of the other mapper's class.   When using Declarative, this argument 
          is passed automatically as a result of the natural class 
          hierarchy of the declared classes. 
 
          .. seealso:: 
 
            :ref:`inheritance_toplevel` 
 
        :param inherit_condition: For joined table inheritance, a SQL 
           expression which will 
           define how the two tables are joined; defaults to a natural join 
           between the two tables. 
 
        :param inherit_foreign_keys: When ``inherit_condition`` is used and 
           the columns present are missing a :class:`_schema.ForeignKey` 
           configuration, this parameter can be used to specify which columns 
           are &quot;foreign&quot;.  In most cases can be left as ``None``. 
 
        :param legacy_is_orphan: Boolean, defaults to ``False``. 
          When ``True``, specifies that &quot;legacy&quot; orphan consideration 
          is to be applied to objects mapped by this mapper, which means 
          that a pending (that is, not persistent) object is auto-expunged 
          from an owning :class:`.Session` only when it is de-associated 
          from *all* parents that specify a ``delete-orphan`` cascade towards 
          this mapper.  The new default behavior is that the object is 
          auto-expunged when it is de-associated with *any* of its parents 
          that specify ``delete-orphan`` cascade.  This behavior is more 
          consistent with that of a persistent object, and allows behavior to 
          be consistent in more scenarios independently of whether or not an 
          orphan object has been flushed yet or not. 
 
          See the change note and example at :ref:`legacy_is_orphan_addition` 
          for more detail on this change. 
 
        :param non_primary: Specify that this :class:`_orm.Mapper` 
          is in addition 
          to the &quot;primary&quot; mapper, that is, the one used for persistence. 
          The :class:`_orm.Mapper` created here may be used for ad-hoc 
          mapping of the class to an alternate selectable, for loading 
          only. 
 
         .. seealso:: 
 
            :ref:`relationship_aliased_class` - the new pattern that removes 
            the need for the :paramref:`_orm.Mapper.non_primary` flag. 
 
        :param passive_deletes: Indicates DELETE behavior of foreign key 
           columns when a joined-table inheritance entity is being deleted. 
           Defaults to ``False`` for a base mapper; for an inheriting mapper, 
           defaults to ``False`` unless the value is set to ``True`` 
           on the superclass mapper. 
 
           When ``True``, it is assumed that ON DELETE CASCADE is configured 
           on the foreign key relationships that link this mapper's table 
           to its superclass table, so that when the unit of work attempts 
           to delete the entity, it need only emit a DELETE statement for the 
           superclass table, and not this table. 
 
           When ``False``, a DELETE statement is emitted for this mapper's 
           table individually.  If the primary key attributes local to this 
           table are unloaded, then a SELECT must be emitted in order to 
           validate these attributes; note that the primary key columns 
           of a joined-table subclass are not part of the &quot;primary key&quot; of 
           the object as a whole. 
 
           Note that a value of ``True`` is **always** forced onto the 
           subclass mappers; that is, it's not possible for a superclass 
           to specify passive_deletes without this taking effect for 
           all subclass mappers. 
 
           .. seealso:: 
 
               :ref:`passive_deletes` - description of similar feature as 
               used with :func:`_orm.relationship` 
 
               :paramref:`.mapper.passive_updates` - supporting ON UPDATE 
               CASCADE for joined-table inheritance mappers 
 
        :param passive_updates: Indicates UPDATE behavior of foreign key 
           columns when a primary key column changes on a joined-table 
           inheritance mapping.   Defaults to ``True``. 
 
           When True, it is assumed that ON UPDATE CASCADE is configured on 
           the foreign key in the database, and that the database will handle 
           propagation of an UPDATE from a source column to dependent columns 
           on joined-table rows. 
 
           When False, it is assumed that the database does not enforce 
           referential integrity and will not be issuing its own CASCADE 
           operation for an update.  The unit of work process will 
           emit an UPDATE statement for the dependent columns during a 
           primary key change. 
 
           .. seealso:: 
 
               :ref:`passive_updates` - description of a similar feature as 
               used with :func:`_orm.relationship` 
 
               :paramref:`.mapper.passive_deletes` - supporting ON DELETE 
               CASCADE for joined-table inheritance mappers 
 
        :param polymorphic_load: Specifies &quot;polymorphic loading&quot; behavior 
         for a subclass in an inheritance hierarchy (joined and single 
         table inheritance only).   Valid values are: 
 
          * &quot;'inline'&quot; - specifies this class should be part of 
            the &quot;with_polymorphic&quot; mappers, e.g. its columns will be included 
            in a SELECT query against the base. 
 
          * &quot;'selectin'&quot; - specifies that when instances of this class 
            are loaded, an additional SELECT will be emitted to retrieve 
            the columns specific to this subclass.  The SELECT uses 
            IN to fetch multiple subclasses at once. 
 
         .. versionadded:: 1.2 
 
         .. seealso:: 
 
            :ref:`with_polymorphic_mapper_config` 
 
            :ref:`polymorphic_selectin` 
 
        :param polymorphic_on: Specifies the column, attribute, or 
          SQL expression used to determine the target class for an 
          incoming row, when inheriting classes are present. 
 
          May be specified as a string attribute name, or as a SQL 
          expression such as a :class:`_schema.Column` or in a Declarative 
          mapping a :func:`_orm.mapped_column` object.  It is typically 
          expected that the SQL expression corresponds to a column in the 
          base-most mapped :class:`.Table`:: 
 
            class Employee(Base): 
                __tablename__ = 'employee' 
 
                id: Mapped[int] = mapped_column(primary_key=True) 
                discriminator: Mapped[str] = mapped_column(String(50)) 
 
                __mapper_args__ = { 
                    &quot;polymorphic_on&quot;:discriminator, 
                    &quot;polymorphic_identity&quot;:&quot;employee&quot; 
                } 
 
          It may also be specified 
          as a SQL expression, as in this example where we 
          use the :func:`.case` construct to provide a conditional 
          approach:: 
 
            class Employee(Base): 
                __tablename__ = 'employee' 
 
                id: Mapped[int] = mapped_column(primary_key=True) 
                discriminator: Mapped[str] = mapped_column(String(50)) 
 
                __mapper_args__ = { 
                    &quot;polymorphic_on&quot;:case( 
                        (discriminator == &quot;EN&quot;, &quot;engineer&quot;), 
                        (discriminator == &quot;MA&quot;, &quot;manager&quot;), 
                        else_=&quot;employee&quot;), 
                    &quot;polymorphic_identity&quot;:&quot;employee&quot; 
                } 
 
          It may also refer to any attribute using its string name, 
          which is of particular use when using annotated column 
          configurations:: 
 
                class Employee(Base): 
                    __tablename__ = 'employee' 
 
                    id: Mapped[int] = mapped_column(primary_key=True) 
                    discriminator: Mapped[str] 
 
                    __mapper_args__ = { 
                        &quot;polymorphic_on&quot;: &quot;discriminator&quot;, 
                        &quot;polymorphic_identity&quot;: &quot;employee&quot; 
                    } 
 
          When setting ``polymorphic_on`` to reference an 
          attribute or expression that's not present in the 
          locally mapped :class:`_schema.Table`, yet the value 
          of the discriminator should be persisted to the database, 
          the value of the 
          discriminator is not automatically set on new 
          instances; this must be handled by the user, 
          either through manual means or via event listeners. 
          A typical approach to establishing such a listener 
          looks like:: 
 
                from sqlalchemy import event 
                from sqlalchemy.orm import object_mapper 
 
                @event.listens_for(Employee, &quot;init&quot;, propagate=True) 
                def set_identity(instance, *arg, **kw): 
                    mapper = object_mapper(instance) 
                    instance.discriminator = mapper.polymorphic_identity 
 
          Where above, we assign the value of ``polymorphic_identity`` 
          for the mapped class to the ``discriminator`` attribute, 
          thus persisting the value to the ``discriminator`` column 
          in the database. 
 
          .. warning:: 
 
             Currently, **only one discriminator column may be set**, typically 
             on the base-most class in the hierarchy. &quot;Cascading&quot; polymorphic 
             columns are not yet supported. 
 
          .. seealso:: 
 
            :ref:`inheritance_toplevel` 
 
        :param polymorphic_identity: Specifies the value which 
          identifies this particular class as returned by the column expression 
          referred to by the :paramref:`_orm.Mapper.polymorphic_on` setting. As 
          rows are received, the value corresponding to the 
          :paramref:`_orm.Mapper.polymorphic_on` column expression is compared 
          to this value, indicating which subclass should be used for the newly 
          reconstructed object. 
 
          .. seealso:: 
 
            :ref:`inheritance_toplevel` 
 
        :param properties: A dictionary mapping the string names of object 
           attributes to :class:`.MapperProperty` instances, which define the 
           persistence behavior of that attribute.  Note that 
           :class:`_schema.Column` 
           objects present in 
           the mapped :class:`_schema.Table` are automatically placed into 
           ``ColumnProperty`` instances upon mapping, unless overridden. 
           When using Declarative, this argument is passed automatically, 
           based on all those :class:`.MapperProperty` instances declared 
           in the declared class body. 
 
           .. seealso:: 
 
               :ref:`orm_mapping_properties` - in the 
               :ref:`orm_mapping_classes_toplevel` 
 
        :param primary_key: A list of :class:`_schema.Column` 
           objects, or alternatively string names of attribute names which 
           refer to :class:`_schema.Column`, which define 
           the primary key to be used against this mapper's selectable unit. 
           This is normally simply the primary key of the ``local_table``, but 
           can be overridden here. 
 
           .. versionchanged:: 2.0.2 :paramref:`_orm.Mapper.primary_key` 
              arguments may be indicated as string attribute names as well. 
 
           .. seealso:: 
 
                :ref:`mapper_primary_key` - background and example use 
 
        :param version_id_col: A :class:`_schema.Column` 
           that will be used to keep a running version id of rows 
           in the table.  This is used to detect concurrent updates or 
           the presence of stale data in a flush.  The methodology is to 
           detect if an UPDATE statement does not match the last known 
           version id, a 
           :class:`~sqlalchemy.orm.exc.StaleDataError` exception is 
           thrown. 
           By default, the column must be of :class:`.Integer` type, 
           unless ``version_id_generator`` specifies an alternative version 
           generator. 
 
           .. seealso:: 
 
              :ref:`mapper_version_counter` - discussion of version counting 
              and rationale. 
 
        :param version_id_generator: Define how new version ids should 
          be generated.  Defaults to ``None``, which indicates that 
          a simple integer counting scheme be employed.  To provide a custom 
          versioning scheme, provide a callable function of the form:: 
 
              def generate_version(version): 
                  return next_version 
 
          Alternatively, server-side versioning functions such as triggers, 
          or programmatic versioning schemes outside of the version id 
          generator may be used, by specifying the value ``False``. 
          Please see :ref:`server_side_version_counter` for a discussion 
          of important points when using this option. 
 
          .. seealso:: 
 
             :ref:`custom_version_counter` 
 
             :ref:`server_side_version_counter` 
 
 
        :param with_polymorphic: A tuple in the form ``(&lt;classes&gt;, 
            &lt;selectable&gt;)`` indicating the default style of &quot;polymorphic&quot; 
            loading, that is, which tables are queried at once. &lt;classes&gt; is 
            any single or list of mappers and/or classes indicating the 
            inherited classes that should be loaded at once. The special value 
            ``'*'`` may be used to indicate all descending classes should be 
            loaded immediately. The second tuple argument &lt;selectable&gt; 
            indicates a selectable that will be used to query for multiple 
            classes. 
 
            The :paramref:`_orm.Mapper.polymorphic_load` parameter may be 
            preferable over the use of :paramref:`_orm.Mapper.with_polymorphic` 
            in modern mappings to indicate a per-subclass technique of 
            indicating polymorphic loading styles. 
 
            .. seealso:: 
 
                :ref:`with_polymorphic_mapper_config` 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">class_ </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">assert_arg_type</span><span class="s4">(</span><span class="s1">class_</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s5">&quot;class_&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_sort_key </span><span class="s4">= </span><span class="s5">&quot;%s.%s&quot; </span><span class="s4">% (</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__module__</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_primary_key_argument </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">primary_key</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary </span><span class="s4">= </span><span class="s1">non_primary</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">always_refresh </span><span class="s4">= </span><span class="s1">always_refresh</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">version_id_col</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_prop </span><span class="s4">= </span><span class="s1">version_id_col</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s4">= (</span>
                <span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                    <span class="s1">roles</span><span class="s4">.</span><span class="s1">ColumnArgumentOrKeyRole</span><span class="s4">,</span>
                    <span class="s1">version_id_col</span><span class="s4">,</span>
                    <span class="s1">argname</span><span class="s4">=</span><span class="s5">&quot;version_id_col&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">version_id_col </span><span class="s3">is not None</span>
                <span class="s3">else None</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">version_id_generator </span><span class="s3">is False</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_generator </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">elif </span><span class="s1">version_id_generator </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_generator </span><span class="s4">= </span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: (</span><span class="s1">x </span><span class="s3">or </span><span class="s6">0</span><span class="s4">) + </span><span class="s6">1</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_generator </span><span class="s4">= </span><span class="s1">version_id_generator</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">concrete </span><span class="s4">= </span><span class="s1">concrete</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">single </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s3">if </span><span class="s1">inherits </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits </span><span class="s4">= </span><span class="s1">_parse_mapper_argument</span><span class="s4">(</span><span class="s1">inherits</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">local_table </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s4">= </span><span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                <span class="s1">roles</span><span class="s4">.</span><span class="s1">StrictFromClauseRole</span><span class="s4">,</span>
                <span class="s1">local_table</span><span class="s4">,</span>
                <span class="s1">disable_inspection</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s1">argname</span><span class="s4">=</span><span class="s5">&quot;local_table&quot;</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">:</span>
            <span class="s0"># note this is a new flow as of 2.0 so that</span>
            <span class="s0"># .local_table need not be Optional</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">single </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">f&quot;Mapper[</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">(None)] has None for a &quot;</span>
                <span class="s5">&quot;primary table argument and does not specify 'inherits'&quot;</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">inherit_condition </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s4">= </span><span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                <span class="s1">roles</span><span class="s4">.</span><span class="s1">OnClauseRole</span><span class="s4">, </span><span class="s1">inherit_condition</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_foreign_keys </span><span class="s4">= </span><span class="s1">inherit_foreign_keys</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_init_properties </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">properties</span><span class="s4">) </span><span class="s3">if </span><span class="s1">properties </span><span class="s3">else </span><span class="s4">{}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_delete_orphans </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">batch </span><span class="s4">= </span><span class="s1">batch</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">eager_defaults </span><span class="s4">= </span><span class="s1">eager_defaults</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">column_prefix </span><span class="s4">= </span><span class="s1">column_prefix</span>

        <span class="s0"># interim - polymorphic_on is further refined in</span>
        <span class="s0"># _configure_polymorphic_setter</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= (</span>
            <span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(  </span><span class="s0"># type: ignore</span>
                <span class="s1">roles</span><span class="s4">.</span><span class="s1">ColumnArgumentOrKeyRole</span><span class="s4">,</span>
                <span class="s1">polymorphic_on</span><span class="s4">,</span>
                <span class="s1">argname</span><span class="s4">=</span><span class="s5">&quot;polymorphic_on&quot;</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">polymorphic_on </span><span class="s3">is not None</span>
            <span class="s3">else None</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_abstract </span><span class="s4">= </span><span class="s1">polymorphic_abstract</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dependency_processors </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">validators </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">EMPTY_DICT</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">passive_updates </span><span class="s4">= </span><span class="s1">passive_updates</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">passive_deletes </span><span class="s4">= </span><span class="s1">passive_deletes</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">legacy_is_orphan </span><span class="s4">= </span><span class="s1">legacy_is_orphan</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_clause_adapter </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_requires_row_aliasing </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_memoized_values </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_compiled_cache_size </span><span class="s4">= </span><span class="s1">_compiled_cache_size</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_reconstructor </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">allow_partial_pks </span><span class="s4">= </span><span class="s1">allow_partial_pks</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits </span><span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">confirm_deleted_rows </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">confirm_deleted_rows </span><span class="s4">= </span><span class="s1">confirm_deleted_rows</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_with_polymorphic</span><span class="s4">(</span><span class="s1">with_polymorphic</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">= </span><span class="s1">polymorphic_load</span>

        <span class="s0"># our 'polymorphic identity', a string name that when located in a</span>
        <span class="s0">#  result set row indicates this Mapper should be used to construct</span>
        <span class="s0"># the object instance for that row.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity </span><span class="s4">= </span><span class="s1">polymorphic_identity</span>

        <span class="s0"># a dictionary of 'polymorphic identity' names, associating those</span>
        <span class="s0"># names with Mappers that will be used to construct object instances</span>
        <span class="s0"># upon a select operation.</span>
        <span class="s3">if </span><span class="s1">_polymorphic_map </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map </span><span class="s4">= {}</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map </span><span class="s4">= </span><span class="s1">_polymorphic_map</span>

        <span class="s3">if </span><span class="s1">include_properties </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">include_properties </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_set</span><span class="s4">(</span><span class="s1">include_properties</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">include_properties </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">if </span><span class="s1">exclude_properties</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">exclude_properties </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_set</span><span class="s4">(</span><span class="s1">exclude_properties</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">exclude_properties </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s0"># prevent this mapper from being constructed</span>
        <span class="s0"># while a configure_mappers() is occurring (and defer a</span>
        <span class="s0"># configure_mappers() until construction succeeds)</span>
        <span class="s3">with </span><span class="s1">_CONFIGURE_MUTEX</span><span class="s4">:</span>
            <span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;MapperEvents&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">_events</span><span class="s4">).</span><span class="s1">_new_mapper_instance</span><span class="s4">(</span>
                <span class="s1">class_</span><span class="s4">, </span><span class="s1">self</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_inheritance</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_class_instrumentation</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_properties</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_polymorphic_setter</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_pks</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">_flag_new_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;constructed&quot;</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_expire_memoizations</span><span class="s4">()</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">after_mapper_constructed</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_prefer_eager_defaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dialect</span><span class="s4">, </span><span class="s1">table</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">eager_defaults </span><span class="s4">== </span><span class="s5">&quot;auto&quot;</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">table</span><span class="s4">.</span><span class="s1">implicit_returning</span><span class="s4">:</span>
                <span class="s3">return False</span>

            <span class="s3">return </span><span class="s4">(</span>
                <span class="s1">table </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_server_default_col_keys</span>
                <span class="s3">and </span><span class="s1">dialect</span><span class="s4">.</span><span class="s1">insert_executemany_returning</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">eager_defaults</span>

    <span class="s3">def </span><span class="s1">_gen_cache_key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">anon_map</span><span class="s4">, </span><span class="s1">bindparams</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">self</span><span class="s4">,)</span>

    <span class="s0"># ### BEGIN</span>
    <span class="s0"># ATTRIBUTE DECLARATIONS START HERE</span>

    <span class="s1">is_mapper </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s5">&quot;&quot;&quot;Part of the inspection API.&quot;&quot;&quot;</span>

    <span class="s1">represents_outer_join </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s1">registry</span><span class="s4">: </span><span class="s1">_RegistryType</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Mapper</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Part of the inspection API. 
 
        Returns self. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">entity</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">r&quot;&quot;&quot;Part of the inspection API. 
 
        Returns self.class\_. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>

    <span class="s1">class_</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]</span>
    <span class="s5">&quot;&quot;&quot;The class to which this :class:`_orm.Mapper` is mapped.&quot;&quot;&quot;</span>

    <span class="s1">_identity_class</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]</span>

    <span class="s1">_delete_orphans</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]</span>
    <span class="s1">_dependency_processors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">DependencyProcessor</span><span class="s4">]</span>
    <span class="s1">_memoized_values</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Callable</span><span class="s4">[[], </span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s1">_inheriting_mappers</span><span class="s4">: </span><span class="s1">util</span><span class="s4">.</span><span class="s1">WeakSequence</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s1">_all_tables</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">TableClause</span><span class="s4">]</span>
    <span class="s1">_polymorphic_attr_key</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]</span>

    <span class="s1">_pks_by_table</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">OrderedSet</span><span class="s4">[</span><span class="s1">ColumnClause</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]</span>
    <span class="s1">_cols_by_table</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">OrderedSet</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]</span>

    <span class="s1">_props</span><span class="s4">: </span><span class="s1">util</span><span class="s4">.</span><span class="s1">OrderedDict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s1">_init_properties</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>

    <span class="s1">_columntoproperty</span><span class="s4">: </span><span class="s1">_ColumnMapping</span>

    <span class="s1">_set_polymorphic_identity</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]], </span><span class="s3">None</span><span class="s4">]]</span>
    <span class="s1">_validate_polymorphic_identity</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span>
        <span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">], </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">], </span><span class="s1">_InstanceDict</span><span class="s4">], </span><span class="s3">None</span><span class="s4">]</span>
    <span class="s4">]</span>

    <span class="s1">tables</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">TableClause</span><span class="s4">]</span>
    <span class="s5">&quot;&quot;&quot;A sequence containing the collection of :class:`_schema.Table` 
    or :class:`_schema.TableClause` objects which this :class:`_orm.Mapper` 
    is aware of. 
 
    If the mapper is mapped to a :class:`_expression.Join`, or an 
    :class:`_expression.Alias` 
    representing a :class:`_expression.Select`, the individual 
    :class:`_schema.Table` 
    objects that comprise the full construct will be represented here. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">validators</span><span class="s4">: </span><span class="s1">util</span><span class="s4">.</span><span class="s1">immutabledict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]]]</span>
    <span class="s5">&quot;&quot;&quot;An immutable dictionary of attributes which have been decorated 
    using the :func:`_orm.validates` decorator. 
 
    The dictionary contains string attribute names as keys 
    mapped to the actual validation method. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">always_refresh</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s1">allow_partial_pks</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s1">version_id_col</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>

    <span class="s1">with_polymorphic</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span>
        <span class="s1">Tuple</span><span class="s4">[</span>
            <span class="s1">Union</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s5">&quot;*&quot;</span><span class="s4">], </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]],</span>
            <span class="s1">Optional</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">],</span>
        <span class="s4">]</span>
    <span class="s4">]</span>

    <span class="s1">version_id_generator</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s3">False</span><span class="s4">], </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">Any</span><span class="s4">]]]</span>

    <span class="s1">local_table</span><span class="s4">: </span><span class="s1">FromClause</span>
    <span class="s5">&quot;&quot;&quot;The immediate :class:`_expression.FromClause` to which this 
    :class:`_orm.Mapper` refers. 
 
    Typically is an instance of :class:`_schema.Table`, may be any 
    :class:`.FromClause`. 
 
    The &quot;local&quot; table is the 
    selectable that the :class:`_orm.Mapper` is directly responsible for 
    managing from an attribute access and flush perspective.   For 
    non-inheriting mappers, :attr:`.Mapper.local_table` will be the same 
    as :attr:`.Mapper.persist_selectable`.  For inheriting mappers, 
    :attr:`.Mapper.local_table` refers to the specific portion of 
    :attr:`.Mapper.persist_selectable` that includes the columns to which 
    this :class:`.Mapper` is loading/persisting, such as a particular 
    :class:`.Table` within a join. 
 
    .. seealso:: 
 
        :attr:`_orm.Mapper.persist_selectable`. 
 
        :attr:`_orm.Mapper.selectable`. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">persist_selectable</span><span class="s4">: </span><span class="s1">FromClause</span>
    <span class="s5">&quot;&quot;&quot;The :class:`_expression.FromClause` to which this :class:`_orm.Mapper` 
    is mapped. 
 
    Typically is an instance of :class:`_schema.Table`, may be any 
    :class:`.FromClause`. 
 
    The :attr:`_orm.Mapper.persist_selectable` is similar to 
    :attr:`.Mapper.local_table`, but represents the :class:`.FromClause` that 
    represents the inheriting class hierarchy overall in an inheritance 
    scenario. 
 
    :attr.`.Mapper.persist_selectable` is also separate from the 
    :attr:`.Mapper.selectable` attribute, the latter of which may be an 
    alternate subquery used for selecting columns. 
    :attr.`.Mapper.persist_selectable` is oriented towards columns that 
    will be written on a persist operation. 
 
    .. seealso:: 
 
        :attr:`_orm.Mapper.selectable`. 
 
        :attr:`_orm.Mapper.local_table`. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">inherits</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s5">&quot;&quot;&quot;References the :class:`_orm.Mapper` which this :class:`_orm.Mapper` 
    inherits from, if any. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">inherit_condition</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]]</span>

    <span class="s1">configured</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s5">&quot;&quot;&quot;Represent ``True`` if this :class:`_orm.Mapper` has been configured. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    .. seealso:: 
 
        :func:`.configure_mappers`. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">concrete</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s5">&quot;&quot;&quot;Represent ``True`` if this :class:`_orm.Mapper` is a concrete 
    inheritance mapper. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">primary_key</span><span class="s4">: </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], ...]</span>
    <span class="s5">&quot;&quot;&quot;An iterable containing the collection of :class:`_schema.Column` 
    objects 
    which comprise the 'primary key' of the mapped table, from the 
    perspective of this :class:`_orm.Mapper`. 
 
    This list is against the selectable in 
    :attr:`_orm.Mapper.persist_selectable`. 
    In the case of inheriting mappers, some columns may be managed by a 
    superclass mapper.  For example, in the case of a 
    :class:`_expression.Join`, the 
    primary key is determined by all of the primary key columns across all 
    tables referenced by the :class:`_expression.Join`. 
 
    The list is also not necessarily the same as the primary key column 
    collection associated with the underlying tables; the :class:`_orm.Mapper` 
    features a ``primary_key`` argument that can override what the 
    :class:`_orm.Mapper` considers as primary key columns. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">class_manager</span><span class="s4">: </span><span class="s1">ClassManager</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]</span>
    <span class="s5">&quot;&quot;&quot;The :class:`.ClassManager` which maintains event listeners 
    and class-bound descriptors for this :class:`_orm.Mapper`. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">single</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s5">&quot;&quot;&quot;Represent ``True`` if this :class:`_orm.Mapper` is a single table 
    inheritance mapper. 
 
    :attr:`_orm.Mapper.local_table` will be ``None`` if this flag is set. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">non_primary</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s5">&quot;&quot;&quot;Represent ``True`` if this :class:`_orm.Mapper` is a &quot;non-primary&quot; 
    mapper, e.g. a mapper that is used only to select rows but not for 
    persistence management. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">polymorphic_on</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s5">&quot;&quot;&quot;The :class:`_schema.Column` or SQL expression specified as the 
    ``polymorphic_on`` argument 
    for this :class:`_orm.Mapper`, within an inheritance scenario. 
 
    This attribute is normally a :class:`_schema.Column` instance but 
    may also be an expression, such as one derived from 
    :func:`.cast`. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">polymorphic_map</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s5">&quot;&quot;&quot;A mapping of &quot;polymorphic identity&quot; identifiers mapped to 
    :class:`_orm.Mapper` instances, within an inheritance scenario. 
 
    The identifiers can be of any type which is comparable to the 
    type of column represented by :attr:`_orm.Mapper.polymorphic_on`. 
 
    An inheritance chain of mappers will all reference the same 
    polymorphic map object.  The object is used to correlate incoming 
    result rows to target mappers. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">polymorphic_identity</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]</span>
    <span class="s5">&quot;&quot;&quot;Represent an identifier which is matched against the 
    :attr:`_orm.Mapper.polymorphic_on` column during result row loading. 
 
    Used only with inheritance, this object can be of any type which is 
    comparable to the type of column represented by 
    :attr:`_orm.Mapper.polymorphic_on`. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">base_mapper</span><span class="s4">: </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]</span>
    <span class="s5">&quot;&quot;&quot;The base-most :class:`_orm.Mapper` in an inheritance chain. 
 
    In a non-inheriting scenario, this attribute will always be this 
    :class:`_orm.Mapper`.   In an inheritance scenario, it references 
    the :class:`_orm.Mapper` which is parent to all other :class:`_orm.Mapper` 
    objects in the inheritance chain. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">columns</span><span class="s4">: </span><span class="s1">ReadOnlyColumnCollection</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s5">&quot;&quot;&quot;A collection of :class:`_schema.Column` or other scalar expression 
    objects maintained by this :class:`_orm.Mapper`. 
 
    The collection behaves the same as that of the ``c`` attribute on 
    any :class:`_schema.Table` object, 
    except that only those columns included in 
    this mapping are present, and are keyed based on the attribute name 
    defined in the mapping, not necessarily the ``key`` attribute of the 
    :class:`_schema.Column` itself.   Additionally, scalar expressions mapped 
    by :func:`.column_property` are also present here. 
 
    This is a *read only* attribute determined during mapper construction. 
    Behavior is undefined if directly modified. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">c</span><span class="s4">: </span><span class="s1">ReadOnlyColumnCollection</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s5">&quot;&quot;&quot;A synonym for :attr:`_orm.Mapper.columns`.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">non_memoized_property</span>
    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">deprecated</span><span class="s4">(</span><span class="s5">&quot;1.3&quot;</span><span class="s4">, </span><span class="s5">&quot;Use .persist_selectable&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">mapped_table</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">memoized_property</span>
    <span class="s3">def </span><span class="s1">_path_registry</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; CachingEntityRegistry</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">PathRegistry</span><span class="s4">.</span><span class="s1">per_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_configure_inheritance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Configure settings related to inheriting and/or inherited mappers 
        being present.&quot;&quot;&quot;</span>

        <span class="s0"># a set of all mappers which inherit from this one.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_inheriting_mappers </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">WeakSequence</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">issubclass</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                    <span class="s5">&quot;Class '%s' does not inherit from '%s'&quot;</span>
                    <span class="s4">% (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">)</span>
                <span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">_update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary </span><span class="s4">!= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">non_primary</span><span class="s4">:</span>
                <span class="s1">np </span><span class="s4">= </span><span class="s3">not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary </span><span class="s3">and </span><span class="s5">&quot;primary&quot; </span><span class="s3">or </span><span class="s5">&quot;non-primary&quot;</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                    <span class="s5">&quot;Inheritance of %s mapper for class '%s' is &quot;</span>
                    <span class="s5">&quot;only allowed from a %s mapper&quot;</span>
                    <span class="s4">% (</span><span class="s1">np</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">np</span><span class="s4">)</span>
                <span class="s4">)</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">single</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">persist_selectable</span>
            <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span>
                    <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                        <span class="s3">if </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
                            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_requires_row_aliasing </span><span class="s4">= </span><span class="s3">True</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s3">is None</span><span class="s4">:</span>
                        <span class="s0"># figure out inherit condition from our table to the</span>
                        <span class="s0"># immediate table of the inherited mapper, not its</span>
                        <span class="s0"># full table which could pull in other stuff we don't</span>
                        <span class="s0"># want (allows test/inheritance.InheritTest4 to pass)</span>
                        <span class="s3">try</span><span class="s4">:</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s4">= </span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">join_condition</span><span class="s4">(</span>
                                <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span>
                            <span class="s4">)</span>
                        <span class="s3">except </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">NoForeignKeysError </span><span class="s3">as </span><span class="s1">nfe</span><span class="s4">:</span>
                            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">NoForeignKeysError</span><span class="s4">(</span>
                                <span class="s5">&quot;Can't determine the inherit condition &quot;</span>
                                <span class="s5">&quot;between inherited table '%s' and &quot;</span>
                                <span class="s5">&quot;inheriting &quot;</span>
                                <span class="s5">&quot;table '%s'; tables have no &quot;</span>
                                <span class="s5">&quot;foreign key relationships established.  &quot;</span>
                                <span class="s5">&quot;Please ensure the inheriting table has &quot;</span>
                                <span class="s5">&quot;a foreign key relationship to the &quot;</span>
                                <span class="s5">&quot;inherited &quot;</span>
                                <span class="s5">&quot;table, or provide an &quot;</span>
                                <span class="s5">&quot;'on clause' using &quot;</span>
                                <span class="s5">&quot;the 'inherit_condition' mapper argument.&quot;</span>
                                <span class="s4">% (</span>
                                    <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                                    <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                                <span class="s4">)</span>
                            <span class="s4">) </span><span class="s3">from </span><span class="s1">nfe</span>
                        <span class="s3">except </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">AmbiguousForeignKeysError </span><span class="s3">as </span><span class="s1">afe</span><span class="s4">:</span>
                            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">AmbiguousForeignKeysError</span><span class="s4">(</span>
                                <span class="s5">&quot;Can't determine the inherit condition &quot;</span>
                                <span class="s5">&quot;between inherited table '%s' and &quot;</span>
                                <span class="s5">&quot;inheriting &quot;</span>
                                <span class="s5">&quot;table '%s'; tables have more than one &quot;</span>
                                <span class="s5">&quot;foreign key relationship established.  &quot;</span>
                                <span class="s5">&quot;Please specify the 'on clause' using &quot;</span>
                                <span class="s5">&quot;the 'inherit_condition' mapper argument.&quot;</span>
                                <span class="s4">% (</span>
                                    <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                                    <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                                <span class="s4">)</span>
                            <span class="s4">) </span><span class="s3">from </span><span class="s1">afe</span>
                    <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">is not None</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">,</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">,</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_condition</span><span class="s4">,</span>
                    <span class="s4">)</span>

                    <span class="s1">fks </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherit_foreign_keys</span><span class="s4">)</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs </span><span class="s4">= </span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">criterion_as_pairs</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">onclause</span><span class="s4">,</span>
                        <span class="s1">consider_as_foreign_keys</span><span class="s4">=</span><span class="s1">fks</span><span class="s4">,</span>
                    <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>

                <span class="s3">if </span><span class="s4">(</span>
                    <span class="s3">not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_abstract</span>
                    <span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span>
                <span class="s4">):</span>
                    <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                        <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s3">} </span><span class="s5">does not indicate a 'polymorphic_identity', &quot;</span>
                        <span class="s5">&quot;yet is part of an inheritance hierarchy that has a &quot;</span>
                        <span class="s5">f&quot;'polymorphic_on' column of &quot;</span>
                        <span class="s5">f&quot;'</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s3">}</span><span class="s5">'. &quot;</span>
                        <span class="s5">&quot;If this is an intermediary class that should not be &quot;</span>
                        <span class="s5">&quot;instantiated, the class may either be left unmapped, &quot;</span>
                        <span class="s5">&quot;or may include the 'polymorphic_abstract=True' &quot;</span>
                        <span class="s5">&quot;parameter in its Mapper arguments. To leave the &quot;</span>
                        <span class="s5">&quot;class unmapped when using Declarative, set the &quot;</span>
                        <span class="s5">&quot;'__abstract__ = True' attribute on the class.&quot;</span>
                    <span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_identity_class</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">version_id_col</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_generator </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">version_id_generator</span>
            <span class="s3">elif </span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s3">is not None</span>
                <span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">version_id_col</span>
            <span class="s4">):</span>
                <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                    <span class="s5">&quot;Inheriting version_id_col '%s' does not match inherited &quot;</span>
                    <span class="s5">&quot;version_id_col '%s' and will not automatically populate &quot;</span>
                    <span class="s5">&quot;the inherited versioning column. &quot;</span>
                    <span class="s5">&quot;version_id_col should only be specified on &quot;</span>
                    <span class="s5">&quot;the base-most mapper that includes versioning.&quot;</span>
                    <span class="s4">% (</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">version_id_col</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">polymorphic_map</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">batch </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">batch</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_inheriting_mappers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">base_mapper</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">passive_updates </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">passive_updates</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">passive_deletes </span><span class="s4">= (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">passive_deletes </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">passive_deletes</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_all_tables </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_all_tables</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">:</span>
                    <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                        <span class="s5">&quot;Reassigning polymorphic association for identity %r &quot;</span>
                        <span class="s5">&quot;from %r to %r: Check for duplicate use of %r as &quot;</span>
                        <span class="s5">&quot;value for polymorphic_identity.&quot;</span>
                        <span class="s4">% (</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">,</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">],</span>
                            <span class="s1">self</span><span class="s4">,</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">,</span>
                        <span class="s4">)</span>
                    <span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">] = </span><span class="s1">self</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                    <span class="s5">&quot;polymorphic_load is not currently supported &quot;</span>
                    <span class="s5">&quot;with concrete table inheritance&quot;</span>
                <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;inline&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_add_with_polymorphic_subclass</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;selectin&quot;</span><span class="s4">:</span>
                <span class="s3">pass</span>
            <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                    <span class="s5">&quot;unknown argument for polymorphic_load: %r&quot;</span>
                    <span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_load</span>
                <span class="s4">)</span>

        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_all_tables </span><span class="s4">= </span><span class="s1">set</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper </span><span class="s4">= </span><span class="s1">self</span>
            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">] = </span><span class="s1">self</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">&quot;Mapper '%s' does not have a persist_selectable specified.&quot;</span>
                <span class="s4">% </span><span class="s1">self</span>
            <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_with_polymorphic</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">with_polymorphic</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">_WithPolymorphicArg</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">with_polymorphic </span><span class="s4">== </span><span class="s5">&quot;*&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s4">= (</span><span class="s5">&quot;*&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">with_polymorphic</span><span class="s4">, (</span><span class="s1">tuple</span><span class="s4">, </span><span class="s1">list</span><span class="s4">)):</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], (</span><span class="s1">str</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">, </span><span class="s1">list</span><span class="s4">)):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s4">= </span><span class="s1">cast</span><span class="s4">(</span>
                    <span class="s5">&quot;&quot;&quot;Tuple[ 
                        Union[ 
                            Literal[&quot;*&quot;], 
                            Sequence[Union[&quot;Mapper[Any]&quot;, Type[Any]]], 
                        ], 
                        Optional[&quot;FromClause&quot;], 
                    ]&quot;&quot;&quot;</span><span class="s4">,</span>
                    <span class="s1">with_polymorphic</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s4">= (</span><span class="s1">with_polymorphic</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">with_polymorphic </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">f&quot;Invalid setting for with_polymorphic: </span><span class="s3">{</span><span class="s1">with_polymorphic</span><span class="s3">!r}</span><span class="s5">&quot;</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s4">= (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
                <span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                    <span class="s1">roles</span><span class="s4">.</span><span class="s1">StrictFromClauseRole</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">],</span>
                    <span class="s1">allow_select</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">),</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configured</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_expire_memoizations</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_add_with_polymorphic_subclass</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">):</span>
        <span class="s1">subcl </span><span class="s4">= </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">class_</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_with_polymorphic</span><span class="s4">((</span><span class="s1">subcl</span><span class="s4">,))</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] != </span><span class="s5">&quot;*&quot;</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">tuple</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_with_polymorphic</span><span class="s4">(</span>
                <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] + (</span><span class="s1">subcl</span><span class="s4">,), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">])</span>
            <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_concrete_base</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Set the given :class:`_orm.Mapper` as the 'inherits' for this 
        :class:`_orm.Mapper`, assuming this :class:`_orm.Mapper` is concrete 
        and does not already have an inherits.&quot;&quot;&quot;</span>

        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span>
        <span class="s3">assert not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">, </span><span class="s1">Mapper</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits </span><span class="s4">= </span><span class="s1">mapper</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_map </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">polymorphic_map</span>
        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_requires_row_aliasing </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">batch </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">batch</span>
        <span class="s3">for </span><span class="s1">mp </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">self_and_descendants</span><span class="s4">:</span>
            <span class="s1">mp</span><span class="s4">.</span><span class="s1">base_mapper </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">base_mapper</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_inheriting_mappers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">passive_updates </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">passive_updates</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_all_tables </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_all_tables</span>

        <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props </span><span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_should_exclude</span><span class="s4">(</span>
                <span class="s1">key</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">local</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">column</span><span class="s4">=</span><span class="s3">None</span>
            <span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_adapt_inherited_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_polymorphic_on</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">polymorphic_on</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= </span><span class="s1">polymorphic_on</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_polymorphic_setter</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_configure_class_instrumentation</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;If this mapper is to be a primary mapper (i.e. the 
        non_primary flag is not set), associate this Mapper with the 
        given class and entity name. 
 
        Subsequent calls to ``class_mapper()`` for the ``class_`` / ``entity`` 
        name combination will return this mapper.  Also decorate the 
        `__init__` method on the mapped class to include optional 
        auto-session attachment logic. 
 
        &quot;&quot;&quot;</span>

        <span class="s0"># we expect that declarative has applied the class manager</span>
        <span class="s0"># already and set up a registry.  if this is None,</span>
        <span class="s0"># this raises as of 2.0.</span>
        <span class="s1">manager </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">opt_manager_of_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">manager </span><span class="s3">or not </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">is_mapped</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                    <span class="s5">&quot;Class %s has no primary mapper configured.  Configure &quot;</span>
                    <span class="s5">&quot;a primary mapper first before setting up a non primary &quot;</span>
                    <span class="s5">&quot;Mapper.&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>
                <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager </span><span class="s4">= </span><span class="s1">manager</span>

            <span class="s3">assert </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">registry </span><span class="s3">is not None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">registry </span><span class="s4">= </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">registry</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class </span><span class="s4">= </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_identity_class</span>
            <span class="s1">manager</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">_add_non_primary_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
            <span class="s3">return</span>

        <span class="s3">if </span><span class="s1">manager </span><span class="s3">is None or not </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                <span class="s5">&quot;The _mapper() function and Mapper() constructor may not be &quot;</span>
                <span class="s5">&quot;invoked directly outside of a declarative registry.&quot;</span>
                <span class="s5">&quot; Please use the sqlalchemy.orm.registry.map_imperatively() &quot;</span>
                <span class="s5">&quot;function for a classical mapping.&quot;</span>
            <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">instrument_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)</span>

        <span class="s0"># this invokes the class_instrument event and sets up</span>
        <span class="s0"># the __init__ method.  documented behavior is that this must</span>
        <span class="s0"># occur after the instrument_class event above.</span>
        <span class="s0"># yes two events with the same two words reversed and different APIs.</span>
        <span class="s0"># :(</span>

        <span class="s1">manager </span><span class="s4">= </span><span class="s1">instrumentation</span><span class="s4">.</span><span class="s1">register_class</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">,</span>
            <span class="s1">mapper</span><span class="s4">=</span><span class="s1">self</span><span class="s4">,</span>
            <span class="s1">expired_attribute_loader</span><span class="s4">=</span><span class="s1">util</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                <span class="s1">loading</span><span class="s4">.</span><span class="s1">load_scalar_attributes</span><span class="s4">, </span><span class="s1">self</span>
            <span class="s4">),</span>
            <span class="s0"># finalize flag means instrument the __init__ method</span>
            <span class="s0"># and call the class_instrument event</span>
            <span class="s1">finalize</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager </span><span class="s4">= </span><span class="s1">manager</span>

        <span class="s3">assert </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">registry </span><span class="s3">is not None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">registry </span><span class="s4">= </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">registry</span>

        <span class="s0"># The remaining members can be added by any mapper,</span>
        <span class="s0"># e_name None or not.</span>
        <span class="s3">if </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s1">event</span><span class="s4">.</span><span class="s1">listen</span><span class="s4">(</span><span class="s1">manager</span><span class="s4">, </span><span class="s5">&quot;init&quot;</span><span class="s4">, </span><span class="s1">_event_on_init</span><span class="s4">, </span><span class="s1">raw</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">method </span><span class="s3">in </span><span class="s1">util</span><span class="s4">.</span><span class="s1">iterate_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s4">== </span><span class="s5">&quot;__init__&quot; </span><span class="s3">and </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s5">&quot;_sa_original_init&quot;</span><span class="s4">):</span>
                <span class="s1">method </span><span class="s4">= </span><span class="s1">method</span><span class="s4">.</span><span class="s1">_sa_original_init</span>
                <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s5">&quot;__func__&quot;</span><span class="s4">):</span>
                    <span class="s1">method </span><span class="s4">= </span><span class="s1">method</span><span class="s4">.</span><span class="s1">__func__</span>
            <span class="s3">if </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">method</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s5">&quot;__sa_reconstructor__&quot;</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_reconstructor </span><span class="s4">= </span><span class="s1">method</span>
                    <span class="s1">event</span><span class="s4">.</span><span class="s1">listen</span><span class="s4">(</span><span class="s1">manager</span><span class="s4">, </span><span class="s5">&quot;load&quot;</span><span class="s4">, </span><span class="s1">_event_on_load</span><span class="s4">, </span><span class="s1">raw</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
                <span class="s3">elif </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s5">&quot;__sa_validators__&quot;</span><span class="s4">):</span>
                    <span class="s1">validation_opts </span><span class="s4">= </span><span class="s1">method</span><span class="s4">.</span><span class="s1">__sa_validation_opts__</span>
                    <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">method</span><span class="s4">.</span><span class="s1">__sa_validators__</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">validators</span><span class="s4">:</span>
                            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                                <span class="s5">&quot;A validation function for mapped &quot;</span>
                                <span class="s5">&quot;attribute %r on mapper %s already exists.&quot;</span>
                                <span class="s4">% (</span><span class="s1">name</span><span class="s4">, </span><span class="s1">self</span><span class="s4">)</span>
                            <span class="s4">)</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">validators </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">validators</span><span class="s4">.</span><span class="s1">union</span><span class="s4">(</span>
                            <span class="s4">{</span><span class="s1">name</span><span class="s4">: (</span><span class="s1">method</span><span class="s4">, </span><span class="s1">validation_opts</span><span class="s4">)}</span>
                        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_dispose_flags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configured </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_ready_for_configure </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dispose_called </span><span class="s4">= </span><span class="s3">True</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">&quot;_configure_failed&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_str_arg_to_mapped_col</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">argname</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">f&quot;Can't determine </span><span class="s3">{</span><span class="s1">argname</span><span class="s3">} </span><span class="s5">column '</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">' - &quot;</span>
                <span class="s5">&quot;no attribute is mapped to this name.&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">expr </span><span class="s4">= </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">expression</span>
        <span class="s3">except </span><span class="s1">AttributeError </span><span class="s3">as </span><span class="s1">ae</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">f&quot;Can't determine </span><span class="s3">{</span><span class="s1">argname</span><span class="s3">} </span><span class="s5">column '</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">'; &quot;</span>
                <span class="s5">&quot;property does not refer to a single mapped Column&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">ae</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">expr</span><span class="s4">, </span><span class="s1">Column</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">f&quot;Can't determine </span><span class="s3">{</span><span class="s1">argname</span><span class="s3">} </span><span class="s5">column '</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">'; &quot;</span>
                <span class="s5">&quot;property does not refer to a single &quot;</span>
                <span class="s5">&quot;mapped Column&quot;</span>
            <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">expr</span>

    <span class="s3">def </span><span class="s1">_configure_pks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tables </span><span class="s4">= </span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">find_tables</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_all_tables</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">t </span><span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table </span><span class="s4">= {}</span>

        <span class="s1">all_cols </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">column_set</span><span class="s4">(</span>
            <span class="s1">chain</span><span class="s4">(*[</span><span class="s1">col</span><span class="s4">.</span><span class="s1">proxy_set </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">])</span>
        <span class="s4">)</span>

        <span class="s1">pk_cols </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">column_set</span><span class="s4">(</span><span class="s1">c </span><span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">all_cols </span><span class="s3">if </span><span class="s1">c</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">)</span>

        <span class="s0"># identify primary key columns which are also mapped by this mapper.</span>
        <span class="s3">for </span><span class="s1">fc </span><span class="s3">in </span><span class="s1">set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">).</span><span class="s1">union</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">]):</span>
            <span class="s3">if </span><span class="s1">fc</span><span class="s4">.</span><span class="s1">primary_key </span><span class="s3">and </span><span class="s1">pk_cols</span><span class="s4">.</span><span class="s1">issuperset</span><span class="s4">(</span><span class="s1">fc</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">):</span>
                <span class="s0"># ordering is important since it determines the ordering of</span>
                <span class="s0"># mapper.primary_key (and therefore query.get())</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">fc</span><span class="s4">] = </span><span class="s1">util</span><span class="s4">.</span><span class="s1">ordered_column_set</span><span class="s4">(  </span><span class="s0"># type: ignore  # noqa: E501</span>
                    <span class="s1">fc</span><span class="s4">.</span><span class="s1">primary_key</span>
                <span class="s4">).</span><span class="s1">intersection</span><span class="s4">(</span>
                    <span class="s1">pk_cols</span>
                <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">[</span><span class="s1">fc</span><span class="s4">] = </span><span class="s1">util</span><span class="s4">.</span><span class="s1">ordered_column_set</span><span class="s4">(</span><span class="s1">fc</span><span class="s4">.</span><span class="s1">c</span><span class="s4">).</span><span class="s1">intersection</span><span class="s4">(  </span><span class="s0"># type: ignore  # noqa: E501</span>
                <span class="s1">all_cols</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_primary_key_argument</span><span class="s4">:</span>
            <span class="s1">coerced_pk_arg </span><span class="s4">= [</span>
                <span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_str_arg_to_mapped_col</span><span class="s4">(</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s1">str</span><span class="s4">)</span>
                    <span class="s3">else </span><span class="s1">c</span>
                <span class="s4">)</span>
                <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s4">(</span>
                    <span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                        <span class="s1">roles</span><span class="s4">.</span><span class="s1">DDLConstraintColumnRole</span><span class="s4">,</span>
                        <span class="s1">coerce_pk</span><span class="s4">,</span>
                        <span class="s1">argname</span><span class="s4">=</span><span class="s5">&quot;primary_key&quot;</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">coerce_pk </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_primary_key_argument</span>
                <span class="s4">)</span>
            <span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">coerced_pk_arg </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s0"># if explicit PK argument sent, add those columns to the</span>
        <span class="s0"># primary key mappings</span>
        <span class="s3">if </span><span class="s1">coerced_pk_arg</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">coerced_pk_arg</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">k</span><span class="s4">.</span><span class="s1">table </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">k</span><span class="s4">.</span><span class="s1">table</span><span class="s4">] = </span><span class="s1">util</span><span class="s4">.</span><span class="s1">OrderedSet</span><span class="s4">()</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">k</span><span class="s4">.</span><span class="s1">table</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">k</span><span class="s4">)</span>

        <span class="s0"># otherwise, see that we got a full PK for the mapped table</span>
        <span class="s3">elif </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span>
            <span class="s3">or </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">]) == </span><span class="s6">0</span>
        <span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">&quot;Mapper %s could not assemble any primary &quot;</span>
                <span class="s5">&quot;key columns for mapped table '%s'&quot;</span>
                <span class="s4">% (</span><span class="s1">self</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">description</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">, </span><span class="s1">schema</span><span class="s4">.</span><span class="s1">Table</span>
        <span class="s4">):</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">&quot;Could not assemble any primary &quot;</span>
                <span class="s5">&quot;keys for locally mapped table '%s' - &quot;</span>
                <span class="s5">&quot;no rows will be persisted in this Table.&quot;</span>
                <span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span>
            <span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span>
            <span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_primary_key_argument</span>
        <span class="s4">):</span>
            <span class="s0"># if inheriting, the &quot;primary key&quot; for this mapper is</span>
            <span class="s0"># that of the inheriting (unless concrete or explicit)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">primary_key</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># determine primary key from argument or persist_selectable pks</span>
            <span class="s1">primary_key</span><span class="s4">: </span><span class="s1">Collection</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>

            <span class="s3">if </span><span class="s1">coerced_pk_arg</span><span class="s4">:</span>
                <span class="s1">primary_key </span><span class="s4">= [</span>
                    <span class="s1">cc </span><span class="s3">if </span><span class="s1">cc </span><span class="s3">is not None else </span><span class="s1">c</span>
                    <span class="s3">for </span><span class="s1">cc</span><span class="s4">, </span><span class="s1">c </span><span class="s3">in </span><span class="s4">(</span>
                        <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">c</span><span class="s4">), </span><span class="s1">c</span><span class="s4">)</span>
                        <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">coerced_pk_arg</span>
                    <span class="s4">)</span>
                <span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># if heuristically determined PKs, reduce to the minimal set</span>
                <span class="s0"># of columns by eliminating FK-&gt;PK pairs for a multi-table</span>
                <span class="s0"># expression.   May over-reduce for some kinds of UNIONs</span>
                <span class="s0"># / CTEs; use explicit PK argument for these special cases</span>
                <span class="s1">primary_key </span><span class="s4">= </span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">reduce_columns</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">],</span>
                    <span class="s1">ignore_nonexistent_tables</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">)</span>

            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">primary_key</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                    <span class="s5">&quot;Mapper %s could not assemble any primary &quot;</span>
                    <span class="s5">&quot;key columns for mapped table '%s'&quot;</span>
                    <span class="s4">% (</span><span class="s1">self</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">description</span><span class="s4">)</span>
                <span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">primary_key</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;Identified primary key columns: %s&quot;</span><span class="s4">, </span><span class="s1">primary_key</span><span class="s4">)</span>

        <span class="s0"># determine cols that aren't expressed within our tables; mark these</span>
        <span class="s0"># as &quot;read only&quot; properties which are refreshed upon INSERT/UPDATE</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_readonly_props </span><span class="s4">= {</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">] </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_props</span>
            <span class="s3">and </span><span class="s4">(</span>
                <span class="s3">not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s5">&quot;table&quot;</span><span class="s4">)</span>
                <span class="s3">or </span><span class="s1">col</span><span class="s4">.</span><span class="s1">table </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span>
            <span class="s4">)</span>
        <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">_configure_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">columns </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">c </span><span class="s4">= </span><span class="s1">sql_base</span><span class="s4">.</span><span class="s1">ColumnCollection</span><span class="s4">()  </span><span class="s0"># type: ignore</span>

        <span class="s0"># object attribute names mapped to MapperProperty objects</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">OrderedDict</span><span class="s4">()</span>

        <span class="s0"># table columns mapped to MapperProperty</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty </span><span class="s4">= </span><span class="s1">_ColumnMapping</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

        <span class="s1">explicit_col_props_by_column</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span>
            <span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
        <span class="s4">] = {}</span>
        <span class="s1">explicit_col_props_by_key</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = {}</span>

        <span class="s0"># step 1: go through properties that were explicitly passed</span>
        <span class="s0"># in the properties dictionary.  For Columns that are local, put them</span>
        <span class="s0"># aside in a separate collection we will reconcile with the Table</span>
        <span class="s0"># that's given.  For other properties, set them up in _props now.</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_init_properties</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop_arg </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_init_properties</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop_arg</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">):</span>
                    <span class="s1">possible_col_prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_prop_from_column</span><span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">, </span><span class="s1">prop_arg</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">possible_col_prop </span><span class="s4">= </span><span class="s1">prop_arg</span>

                <span class="s0"># issue #8705.  if the explicit property is actually a</span>
                <span class="s0"># Column that is local to the local Table, don't set it up</span>
                <span class="s0"># in ._props yet, integrate it into the order given within</span>
                <span class="s0"># the Table.</span>

                <span class="s1">_map_as_property_now </span><span class="s4">= </span><span class="s3">True</span>
                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">possible_col_prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">):</span>
                    <span class="s3">for </span><span class="s1">given_col </span><span class="s3">in </span><span class="s1">possible_col_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">contains_column</span><span class="s4">(</span><span class="s1">given_col</span><span class="s4">):</span>
                            <span class="s1">_map_as_property_now </span><span class="s4">= </span><span class="s3">False</span>
                            <span class="s1">explicit_col_props_by_key</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">possible_col_prop</span>
                            <span class="s1">explicit_col_props_by_column</span><span class="s4">[</span><span class="s1">given_col</span><span class="s4">] = (</span>
                                <span class="s1">key</span><span class="s4">,</span>
                                <span class="s1">possible_col_prop</span><span class="s4">,</span>
                            <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">_map_as_property_now</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">,</span>
                        <span class="s1">possible_col_prop</span><span class="s4">,</span>
                        <span class="s1">init</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
                    <span class="s4">)</span>

        <span class="s0"># step 2: pull properties from the inherited mapper.  reconcile</span>
        <span class="s0"># columns with those which are explicit above.  for properties that</span>
        <span class="s0"># are only in the inheriting mapper, set them up as local props</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">inherited_prop </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_should_exclude</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">local</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">column</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
                    <span class="s3">continue</span>

                <span class="s1">incoming_prop </span><span class="s4">= </span><span class="s1">explicit_col_props_by_key</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">incoming_prop</span><span class="s4">:</span>
                    <span class="s1">new_prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_reconcile_prop_with_incoming_columns</span><span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">,</span>
                        <span class="s1">inherited_prop</span><span class="s4">,</span>
                        <span class="s1">warn_only</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
                        <span class="s1">incoming_prop</span><span class="s4">=</span><span class="s1">incoming_prop</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s1">explicit_col_props_by_key</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">new_prop</span>

                    <span class="s3">for </span><span class="s1">inc_col </span><span class="s3">in </span><span class="s1">incoming_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">:</span>
                        <span class="s1">explicit_col_props_by_column</span><span class="s4">[</span><span class="s1">inc_col</span><span class="s4">] = (</span>
                            <span class="s1">key</span><span class="s4">,</span>
                            <span class="s1">new_prop</span><span class="s4">,</span>
                        <span class="s4">)</span>
                <span class="s3">elif </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_adapt_inherited_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">inherited_prop</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>

        <span class="s0"># step 3.  Iterate through all columns in the persist selectable.</span>
        <span class="s0"># this includes not only columns in the local table / fromclause,</span>
        <span class="s0"># but also those columns in the superclass table if we are joined</span>
        <span class="s0"># inh or single inh mapper.  map these columns as well. additional</span>
        <span class="s0"># reconciliation against inherited columns occurs here also.</span>

        <span class="s3">for </span><span class="s1">column </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">column </span><span class="s3">in </span><span class="s1">explicit_col_props_by_column</span><span class="s4">:</span>
                <span class="s0"># column was explicitly passed to properties; configure</span>
                <span class="s0"># it now in the order in which it corresponds to the</span>
                <span class="s0"># Table / selectable</span>
                <span class="s1">key</span><span class="s4">, </span><span class="s1">prop </span><span class="s4">= </span><span class="s1">explicit_col_props_by_column</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
                <span class="s3">continue</span>

            <span class="s3">elif </span><span class="s1">column </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">:</span>
                <span class="s3">continue</span>

            <span class="s1">column_key </span><span class="s4">= (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_prefix </span><span class="s3">or </span><span class="s5">&quot;&quot;</span><span class="s4">) + </span><span class="s1">column</span><span class="s4">.</span><span class="s1">key</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_should_exclude</span><span class="s4">(</span>
                <span class="s1">column</span><span class="s4">.</span><span class="s1">key</span><span class="s4">,</span>
                <span class="s1">column_key</span><span class="s4">,</span>
                <span class="s1">local</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">c</span><span class="s4">.</span><span class="s1">contains_column</span><span class="s4">(</span><span class="s1">column</span><span class="s4">),</span>
                <span class="s1">column</span><span class="s4">=</span><span class="s1">column</span><span class="s4">,</span>
            <span class="s4">):</span>
                <span class="s3">continue</span>

            <span class="s0"># adjust the &quot;key&quot; used for this column to that</span>
            <span class="s0"># of the inheriting mapper</span>
            <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">column </span><span class="s3">in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">:</span>
                    <span class="s1">column_key </span><span class="s4">= </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">].</span><span class="s1">key</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span>
                <span class="s1">column_key</span><span class="s4">,</span>
                <span class="s1">column</span><span class="s4">,</span>
                <span class="s1">init</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
                <span class="s1">setparent</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
            <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_configure_polymorphic_setter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">init</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Configure an attribute on the mapper representing the 
        'polymorphic_on' column, if applicable, and not 
        already generated by _configure_properties (which is typical). 
 
        Also create a setter function which will assign this 
        attribute to the value of the 'polymorphic_identity' 
        upon instance construction, also if applicable.  This 
        routine will run when an instance is created. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">setter </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">polymorphic_key</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">setter </span><span class="s4">= </span><span class="s3">True</span>

            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s0"># polymorphic_on specified as a string - link</span>
                <span class="s0"># it to mapped ColumnProperty</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">]</span>
                <span class="s3">except </span><span class="s1">KeyError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                    <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                        <span class="s5">&quot;Can't determine polymorphic_on &quot;</span>
                        <span class="s5">&quot;value '%s' - no attribute is &quot;</span>
                        <span class="s5">&quot;mapped to this name.&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                    <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">:</span>
                <span class="s0"># polymorphic_on is a column that is already mapped</span>
                <span class="s0"># to a ColumnProperty</span>
                <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">]</span>
            <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">):</span>
                <span class="s0"># polymorphic_on is directly a MapperProperty,</span>
                <span class="s0"># ensure it's a ColumnProperty</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span>
                <span class="s4">):</span>
                    <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                        <span class="s5">&quot;Only direct column-mapped &quot;</span>
                        <span class="s5">&quot;property or SQL expression &quot;</span>
                        <span class="s5">&quot;can be passed for polymorphic_on&quot;</span>
                    <span class="s4">)</span>
                <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># polymorphic_on is a Column or SQL expression and</span>
                <span class="s0"># doesn't appear to be mapped. this means it can be 1.</span>
                <span class="s0"># only present in the with_polymorphic selectable or</span>
                <span class="s0"># 2. a totally standalone SQL expression which we'd</span>
                <span class="s0"># hope is compatible with this mapper's persist_selectable</span>
                <span class="s1">col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">col </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s0"># polymorphic_on doesn't derive from any</span>
                    <span class="s0"># column/expression isn't present in the mapped</span>
                    <span class="s0"># table. we will make a &quot;hidden&quot; ColumnProperty</span>
                    <span class="s0"># for it. Just check that if it's directly a</span>
                    <span class="s0"># schema.Column and we have with_polymorphic, it's</span>
                    <span class="s0"># likely a user error if the schema.Column isn't</span>
                    <span class="s0"># represented somehow in either persist_selectable or</span>
                    <span class="s0"># with_polymorphic.   Otherwise as of 0.7.4 we</span>
                    <span class="s0"># just go with it and assume the user wants it</span>
                    <span class="s0"># that way (i.e. a CASE statement)</span>
                    <span class="s1">setter </span><span class="s4">= </span><span class="s3">False</span>
                    <span class="s1">instrument </span><span class="s4">= </span><span class="s3">False</span>
                    <span class="s1">col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s1">schema</span><span class="s4">.</span><span class="s1">Column</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s3">is None</span>
                        <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] </span><span class="s3">is None</span>
                        <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">col</span><span class="s4">)</span>
                        <span class="s3">is None</span>
                    <span class="s4">):</span>
                        <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                            <span class="s5">&quot;Could not map polymorphic_on column &quot;</span>
                            <span class="s5">&quot;'%s' to the mapped table - polymorphic &quot;</span>
                            <span class="s5">&quot;loads will not function properly&quot;</span>
                            <span class="s4">% </span><span class="s1">col</span><span class="s4">.</span><span class="s1">description</span>
                        <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s0"># column/expression that polymorphic_on derives from</span>
                    <span class="s0"># is present in our mapped table</span>
                    <span class="s0"># and is probably mapped, but polymorphic_on itself</span>
                    <span class="s0"># is not.  This happens when</span>
                    <span class="s0"># the polymorphic_on is only directly present in the</span>
                    <span class="s0"># with_polymorphic selectable, as when use</span>
                    <span class="s0"># polymorphic_union.</span>
                    <span class="s0"># we'll make a separate ColumnProperty for it.</span>
                    <span class="s1">instrument </span><span class="s4">= </span><span class="s3">True</span>
                <span class="s1">key </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s5">&quot;key&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">key</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_should_exclude</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s1">col</span><span class="s4">):</span>
                        <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                            <span class="s5">&quot;Cannot exclude or override the &quot;</span>
                            <span class="s5">&quot;discriminator column %r&quot; </span><span class="s4">% </span><span class="s1">key</span>
                        <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= </span><span class="s1">col </span><span class="s4">= </span><span class="s1">col</span><span class="s4">.</span><span class="s1">label</span><span class="s4">(</span><span class="s5">&quot;_sa_polymorphic_on&quot;</span><span class="s4">)</span>
                    <span class="s1">key </span><span class="s4">= </span><span class="s1">col</span><span class="s4">.</span><span class="s1">key</span>

                <span class="s1">prop </span><span class="s4">= </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s1">_instrument</span><span class="s4">=</span><span class="s1">instrument</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">=</span><span class="s1">init</span><span class="s4">, </span><span class="s1">setparent</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

            <span class="s0"># the actual polymorphic_on should be the first public-facing</span>
            <span class="s0"># column in the property</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s1">polymorphic_key </span><span class="s4">= </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># no polymorphic_on was set.</span>
            <span class="s0"># check inheriting mappers for one.</span>
            <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                <span class="s0"># determine if polymorphic_on of the parent</span>
                <span class="s0"># should be propagated here.   If the col</span>
                <span class="s0"># is present in our mapped table, or if our mapped</span>
                <span class="s0"># table is the same as the parent (i.e. single table</span>
                <span class="s0"># inheritance), we can use it</span>
                <span class="s3">if </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">is </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s4">= (</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span>
                        <span class="s4">).</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">)</span>
                    <span class="s0"># we can use the parent mapper's _set_polymorphic_identity</span>
                    <span class="s0"># directly; it ensures the polymorphic_identity of the</span>
                    <span class="s0"># instance's mapper is used so is portable to subclasses.</span>
                    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity </span><span class="s4">= (</span>
                            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity</span>
                        <span class="s4">)</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_attr_key </span><span class="s4">= (</span>
                            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_polymorphic_attr_key</span>
                        <span class="s4">)</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_validate_polymorphic_identity </span><span class="s4">= (</span>
                            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_validate_polymorphic_identity</span>
                        <span class="s4">)</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity </span><span class="s4">= </span><span class="s3">None</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_attr_key </span><span class="s4">= </span><span class="s3">None</span>
                    <span class="s3">return</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_abstract </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                <span class="s5">&quot;The Mapper.polymorphic_abstract parameter may only be used &quot;</span>
                <span class="s5">&quot;on a mapper hierarchy which includes the &quot;</span>
                <span class="s5">&quot;Mapper.polymorphic_on parameter at the base of the hierarchy.&quot;</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">setter</span><span class="s4">:</span>

            <span class="s3">def </span><span class="s1">_set_polymorphic_identity</span><span class="s4">(</span><span class="s1">state</span><span class="s4">):</span>
                <span class="s1">dict_ </span><span class="s4">= </span><span class="s1">state</span><span class="s4">.</span><span class="s1">dict</span>
                <span class="s0"># TODO: what happens if polymorphic_on column attribute name</span>
                <span class="s0"># does not match .key?</span>

                <span class="s1">polymorphic_identity </span><span class="s4">= (</span>
                    <span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_identity</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s4">(</span>
                    <span class="s1">polymorphic_identity </span><span class="s3">is None</span>
                    <span class="s3">and </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">polymorphic_abstract</span>
                <span class="s4">):</span>
                    <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                        <span class="s5">f&quot;Can't instantiate class for </span><span class="s3">{</span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span><span class="s3">}</span><span class="s5">; &quot;</span>
                        <span class="s5">&quot;mapper is marked polymorphic_abstract=True&quot;</span>
                    <span class="s4">)</span>

                <span class="s1">state</span><span class="s4">.</span><span class="s1">get_impl</span><span class="s4">(</span><span class="s1">polymorphic_key</span><span class="s4">).</span><span class="s1">set</span><span class="s4">(</span>
                    <span class="s1">state</span><span class="s4">,</span>
                    <span class="s1">dict_</span><span class="s4">,</span>
                    <span class="s1">polymorphic_identity</span><span class="s4">,</span>
                    <span class="s3">None</span><span class="s4">,</span>
                <span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_attr_key </span><span class="s4">= </span><span class="s1">polymorphic_key</span>

            <span class="s3">def </span><span class="s1">_validate_polymorphic_identity</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s4">(</span>
                    <span class="s1">polymorphic_key </span><span class="s3">in </span><span class="s1">dict_</span>
                    <span class="s3">and </span><span class="s1">dict_</span><span class="s4">[</span><span class="s1">polymorphic_key</span><span class="s4">]</span>
                    <span class="s3">not in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_acceptable_polymorphic_identities</span>
                <span class="s4">):</span>
                    <span class="s1">util</span><span class="s4">.</span><span class="s1">warn_limited</span><span class="s4">(</span>
                        <span class="s5">&quot;Flushing object %s with &quot;</span>
                        <span class="s5">&quot;incompatible polymorphic identity %r; the &quot;</span>
                        <span class="s5">&quot;object may not refresh and/or load correctly&quot;</span><span class="s4">,</span>
                        <span class="s4">(</span><span class="s1">state_str</span><span class="s4">(</span><span class="s1">state</span><span class="s4">), </span><span class="s1">dict_</span><span class="s4">[</span><span class="s1">polymorphic_key</span><span class="s4">]),</span>
                    <span class="s4">)</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity </span><span class="s4">= </span><span class="s1">_set_polymorphic_identity</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_validate_polymorphic_identity </span><span class="s4">= (</span>
                <span class="s1">_validate_polymorphic_identity</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_attr_key </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s1">_validate_polymorphic_identity </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_version_id_prop</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_acceptable_polymorphic_identities</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">identities </span><span class="s4">= </span><span class="s1">set</span><span class="s4">()</span>

        <span class="s1">stack </span><span class="s4">= </span><span class="s1">deque</span><span class="s4">([</span><span class="s1">self</span><span class="s4">])</span>
        <span class="s3">while </span><span class="s1">stack</span><span class="s4">:</span>
            <span class="s1">item </span><span class="s4">= </span><span class="s1">stack</span><span class="s4">.</span><span class="s1">popleft</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">item</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">is </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">:</span>
                <span class="s1">identities</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">item</span><span class="s4">.</span><span class="s1">polymorphic_identity</span><span class="s4">)</span>
                <span class="s1">stack</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">item</span><span class="s4">.</span><span class="s1">_inheriting_mappers</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">identities</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_prop_set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">frozenset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_adapt_inherited_property</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">):</span>
        <span class="s1">descriptor_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">setparent</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">:</span>
            <span class="s0"># determine if the class implements this attribute; if not,</span>
            <span class="s0"># or if it is implemented by the attribute that is handling the</span>
            <span class="s0"># given superclass-mapped property, then we need to report that we</span>
            <span class="s0"># can't use this at the instance level since we are a concrete</span>
            <span class="s0"># mapper and we don't map this.  don't trip user-defined</span>
            <span class="s0"># descriptors that might have side effects when invoked.</span>
            <span class="s1">implementing_attribute </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">.</span><span class="s1">_get_class_attr_mro</span><span class="s4">(</span>
                <span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">implementing_attribute </span><span class="s3">is </span><span class="s1">prop </span><span class="s3">or </span><span class="s4">(</span>
                <span class="s1">isinstance</span><span class="s4">(</span>
                    <span class="s1">implementing_attribute</span><span class="s4">, </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">InstrumentedAttribute</span>
                <span class="s4">)</span>
                <span class="s3">and </span><span class="s1">implementing_attribute</span><span class="s4">.</span><span class="s1">_parententity </span><span class="s3">is </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">parent</span>
            <span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span>
                    <span class="s1">key</span><span class="s4">,</span>
                    <span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">ConcreteInheritedProperty</span><span class="s4">(),</span>
                    <span class="s1">init</span><span class="s4">=</span><span class="s1">init</span><span class="s4">,</span>
                    <span class="s1">setparent</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_configure_property</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">prop_arg</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]],</span>
        <span class="s4">*,</span>
        <span class="s1">init</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">setparent</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">warn_for_existing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s1">descriptor_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span>
            <span class="s5">&quot;_configure_property(%s, %s)&quot;</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop_arg</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span>
        <span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop_arg</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">):</span>
            <span class="s1">prop</span><span class="s4">: </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_property_from_column</span><span class="s4">(</span>
                <span class="s1">key</span><span class="s4">, </span><span class="s1">prop_arg</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">prop </span><span class="s4">= </span><span class="s1">prop_arg</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">):</span>
            <span class="s1">col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>

            <span class="s0"># if the column is not present in the mapped table,</span>
            <span class="s0"># test if a column has been added after the fact to the</span>
            <span class="s0"># parent table (or their parent, etc.) [ticket:1570]</span>
            <span class="s3">if </span><span class="s1">col </span><span class="s3">is None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">:</span>
                <span class="s1">path </span><span class="s4">= [</span><span class="s1">self</span><span class="s4">]</span>
                <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                    <span class="s1">col </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
                    <span class="s3">if </span><span class="s1">col </span><span class="s3">is not None</span><span class="s4">:</span>
                        <span class="s3">for </span><span class="s1">m2 </span><span class="s3">in </span><span class="s1">path</span><span class="s4">:</span>
                            <span class="s1">m2</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">_refresh_for_new_column</span><span class="s4">(</span><span class="s1">col</span><span class="s4">)</span>
                        <span class="s1">col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span>
                            <span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
                        <span class="s4">)</span>
                        <span class="s3">break</span>
                    <span class="s1">path</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>

            <span class="s0"># subquery expression, column not present in the mapped</span>
            <span class="s0"># selectable.</span>
            <span class="s3">if </span><span class="s1">col </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">col </span><span class="s4">= </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

                <span class="s0"># column is coming in after _readonly_props was</span>
                <span class="s0"># initialized; check for 'readonly'</span>
                <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">&quot;_readonly_props&quot;</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span>
                    <span class="s3">not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s5">&quot;table&quot;</span><span class="s4">)</span>
                    <span class="s3">or </span><span class="s1">col</span><span class="s4">.</span><span class="s1">table </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span>
                <span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_readonly_props</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">)</span>

            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># if column is coming in after _cols_by_table was</span>
                <span class="s0"># initialized, ensure the col is in the right set</span>
                <span class="s3">if </span><span class="s4">(</span>
                    <span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">&quot;_cols_by_table&quot;</span><span class="s4">)</span>
                    <span class="s3">and </span><span class="s1">col</span><span class="s4">.</span><span class="s1">table </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span>
                    <span class="s3">and </span><span class="s1">col </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">[</span><span class="s1">col</span><span class="s4">.</span><span class="s1">table</span><span class="s4">]</span>
                <span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">[</span><span class="s1">col</span><span class="s4">.</span><span class="s1">table</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">col</span><span class="s4">)</span>

            <span class="s0"># if this properties.ColumnProperty represents the &quot;polymorphic</span>
            <span class="s0"># discriminator&quot; column, mark it.  We'll need this when rendering</span>
            <span class="s0"># columns in SELECT statements.</span>
            <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s5">&quot;_is_polymorphic_discriminator&quot;</span><span class="s4">):</span>
                <span class="s1">prop</span><span class="s4">.</span><span class="s1">_is_polymorphic_discriminator </span><span class="s4">= (</span>
                    <span class="s1">col </span><span class="s3">is </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                    <span class="s3">or </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">is </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                <span class="s4">)</span>

            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s1">expression</span><span class="s4">.</span><span class="s1">Label</span><span class="s4">):</span>
                <span class="s0"># new in 1.4, get column property against expressions</span>
                <span class="s0"># to be addressable in subqueries</span>
                <span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s4">= </span><span class="s1">col</span><span class="s4">.</span><span class="s1">_tq_key_label </span><span class="s4">= </span><span class="s1">key</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">col</span><span class="s4">, </span><span class="s1">key</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">proxy_col </span><span class="s3">in </span><span class="s1">col</span><span class="s4">.</span><span class="s1">proxy_set</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">proxy_col</span><span class="s4">] = </span><span class="s1">prop</span>

        <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s5">&quot;key&quot;</span><span class="s4">, </span><span class="s1">key</span><span class="s4">) != </span><span class="s1">key</span><span class="s4">:</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">f&quot;ORM mapped property </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">.</span><span class="s3">{</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s3">} </span><span class="s5">being &quot;</span>
                <span class="s5">&quot;assigned to attribute &quot;</span>
                <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">key</span><span class="s3">!r} </span><span class="s5">is already associated with &quot;</span>
                <span class="s5">f&quot;attribute </span><span class="s3">{</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s3">!r}</span><span class="s5">. The attribute will be de-associated &quot;</span>
                <span class="s5">f&quot;from </span><span class="s3">{</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s3">!r}</span><span class="s5">.&quot;</span>
            <span class="s4">)</span>

        <span class="s1">prop</span><span class="s4">.</span><span class="s1">key </span><span class="s4">= </span><span class="s1">key</span>

        <span class="s3">if </span><span class="s1">setparent</span><span class="s4">:</span>
            <span class="s1">prop</span><span class="s4">.</span><span class="s1">set_parent</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">init</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props </span><span class="s3">and </span><span class="s1">getattr</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">], </span><span class="s5">&quot;_mapped_by_synonym&quot;</span><span class="s4">, </span><span class="s3">False</span>
        <span class="s4">):</span>
            <span class="s1">syn </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">].</span><span class="s1">_mapped_by_synonym</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">&quot;Can't call map_column=True for synonym %r=%r, &quot;</span>
                <span class="s5">&quot;a ColumnProperty already exists keyed to the name &quot;</span>
                <span class="s5">&quot;%r for column %r&quot; </span><span class="s4">% (</span><span class="s1">syn</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">syn</span><span class="s4">)</span>
            <span class="s4">)</span>

        <span class="s0"># replacement cases</span>

        <span class="s0"># case one: prop is replacing a prop that we have mapped.  this is</span>
        <span class="s0"># independent of whatever might be in the actual class dictionary</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span>
            <span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">], </span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">ConcreteInheritedProperty</span>
            <span class="s4">)</span>
            <span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">SynonymProperty</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s3">if </span><span class="s1">warn_for_existing</span><span class="s4">:</span>
                <span class="s1">util</span><span class="s4">.</span><span class="s1">warn_deprecated</span><span class="s4">(</span>
                    <span class="s5">f&quot;User-placed attribute </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">.</span><span class="s3">{</span><span class="s1">key</span><span class="s3">} </span><span class="s5">on &quot;</span>
                    <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s3">} </span><span class="s5">is replacing an existing ORM-mapped attribute.  &quot;</span>
                    <span class="s5">&quot;Behavior is not fully defined in this case.  This &quot;</span>
                    <span class="s5">&quot;use is deprecated and will raise an error in a future &quot;</span>
                    <span class="s5">&quot;release&quot;</span><span class="s4">,</span>
                    <span class="s5">&quot;2.0&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s1">oldprop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_path_registry</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s1">oldprop</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s0"># case two: prop is replacing an attribute on the class of some kind.</span>
        <span class="s0"># we have to be more careful here since it's normal when using</span>
        <span class="s0"># Declarative that all the &quot;declared attributes&quot; on the class</span>
        <span class="s0"># get replaced.</span>
        <span class="s3">elif </span><span class="s4">(</span>
            <span class="s1">warn_for_existing</span>
            <span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s3">None</span><span class="s4">) </span><span class="s3">is not None</span>
            <span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">SynonymProperty</span><span class="s4">)</span>
            <span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s3">None</span><span class="s4">),</span>
                <span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">ConcreteInheritedProperty</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">warn_deprecated</span><span class="s4">(</span>
                <span class="s5">f&quot;User-placed attribute </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">.</span><span class="s3">{</span><span class="s1">key</span><span class="s3">} </span><span class="s5">on &quot;</span>
                <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s3">} </span><span class="s5">is replacing an existing class-bound &quot;</span>
                <span class="s5">&quot;attribute of the same name.  &quot;</span>
                <span class="s5">&quot;Behavior is not fully defined in this case.  This &quot;</span>
                <span class="s5">&quot;use is deprecated and will raise an error in a future &quot;</span>
                <span class="s5">&quot;release&quot;</span><span class="s4">,</span>
                <span class="s5">&quot;2.0&quot;</span><span class="s4">,</span>
            <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">prop</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary</span><span class="s4">:</span>
            <span class="s1">prop</span><span class="s4">.</span><span class="s1">instrument_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inheriting_mappers</span><span class="s4">:</span>
            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_adapt_inherited_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">init</span><span class="s4">:</span>
            <span class="s1">prop</span><span class="s4">.</span><span class="s1">init</span><span class="s4">()</span>
            <span class="s1">prop</span><span class="s4">.</span><span class="s1">post_instrument_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">configured</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_expire_memoizations</span><span class="s4">()</span>

        <span class="s3">return </span><span class="s1">prop</span>

    <span class="s3">def </span><span class="s1">_make_prop_from_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">column</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span>
            <span class="s1">Sequence</span><span class="s4">[</span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]], </span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]</span>
        <span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s1">columns </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">column</span><span class="s4">)</span>
        <span class="s1">mapped_column </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">columns</span><span class="s4">:</span>
            <span class="s1">mc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">c</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">mc </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">mc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">c</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">mc </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s0"># if the column is in the local table but not the</span>
                    <span class="s0"># mapped table, this corresponds to adding a</span>
                    <span class="s0"># column after the fact to the local table.</span>
                    <span class="s0"># [ticket:1523]</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">_refresh_for_new_column</span><span class="s4">(</span><span class="s1">mc</span><span class="s4">)</span>
                <span class="s1">mc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">corresponding_column</span><span class="s4">(</span><span class="s1">c</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">mc </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                        <span class="s5">&quot;When configuring property '%s' on %s, &quot;</span>
                        <span class="s5">&quot;column '%s' is not represented in the mapper's &quot;</span>
                        <span class="s5">&quot;table. Use the `column_property()` function to &quot;</span>
                        <span class="s5">&quot;force this column to be mapped as a read-only &quot;</span>
                        <span class="s5">&quot;attribute.&quot; </span><span class="s4">% (</span><span class="s1">key</span><span class="s4">, </span><span class="s1">self</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
                    <span class="s4">)</span>
            <span class="s1">mapped_column</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">mc</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">(*</span><span class="s1">mapped_column</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_reconcile_prop_with_incoming_columns</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">existing_prop</span><span class="s4">: </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">],</span>
        <span class="s1">warn_only</span><span class="s4">: </span><span class="s1">bool</span><span class="s4">,</span>
        <span class="s1">incoming_prop</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">single_column</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">incoming_prop </span><span class="s3">and </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">concrete</span>
            <span class="s3">or not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">existing_prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s3">return </span><span class="s1">incoming_prop</span>

        <span class="s1">existing_column </span><span class="s4">= </span><span class="s1">existing_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">incoming_prop </span><span class="s3">and </span><span class="s1">existing_column </span><span class="s3">in </span><span class="s1">incoming_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">incoming_prop</span>

        <span class="s3">if </span><span class="s1">incoming_prop </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">single_column </span><span class="s3">is not None</span>
            <span class="s1">incoming_column </span><span class="s4">= </span><span class="s1">single_column</span>
            <span class="s1">equated_pair_key </span><span class="s4">= (</span><span class="s1">existing_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">incoming_column</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">single_column </span><span class="s3">is None</span>
            <span class="s1">incoming_column </span><span class="s4">= </span><span class="s1">incoming_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s1">equated_pair_key </span><span class="s4">= (</span><span class="s1">incoming_column</span><span class="s4">, </span><span class="s1">existing_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>

        <span class="s3">if </span><span class="s4">(</span>
            <span class="s4">(</span>
                <span class="s3">not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs</span>
                <span class="s3">or </span><span class="s4">(</span><span class="s1">equated_pair_key </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs</span><span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">and not </span><span class="s1">existing_column</span><span class="s4">.</span><span class="s1">shares_lineage</span><span class="s4">(</span><span class="s1">incoming_column</span><span class="s4">)</span>
            <span class="s3">and </span><span class="s1">existing_column </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col</span>
            <span class="s3">and </span><span class="s1">incoming_column </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col</span>
        <span class="s4">):</span>
            <span class="s1">msg </span><span class="s4">= (</span>
                <span class="s5">&quot;Implicitly combining column %s with column &quot;</span>
                <span class="s5">&quot;%s under attribute '%s'.  Please configure one &quot;</span>
                <span class="s5">&quot;or more attributes for these same-named columns &quot;</span>
                <span class="s5">&quot;explicitly.&quot;</span>
                <span class="s4">% (</span>
                    <span class="s1">existing_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">],</span>
                    <span class="s1">incoming_column</span><span class="s4">,</span>
                    <span class="s1">key</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">warn_only</span><span class="s4">:</span>
                <span class="s1">util</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span><span class="s1">msg</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span><span class="s1">msg</span><span class="s4">)</span>

        <span class="s0"># existing properties.ColumnProperty from an inheriting</span>
        <span class="s0"># mapper. make a copy and append our column to it</span>
        <span class="s0"># breakpoint()</span>
        <span class="s1">new_prop </span><span class="s4">= </span><span class="s1">existing_prop</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>

        <span class="s1">new_prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">.</span><span class="s1">insert</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">incoming_column</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span>
            <span class="s5">&quot;inserting column to existing list &quot;</span>
            <span class="s5">&quot;in properties.ColumnProperty %s&quot;</span><span class="s4">,</span>
            <span class="s1">key</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">new_prop  </span><span class="s0"># type: ignore</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_property_from_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">column</span><span class="s4">: </span><span class="s1">KeyedColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;generate/update a :class:`.ColumnProperty` given a 
        :class:`_schema.Column` or other SQL expression object.&quot;&quot;&quot;</span>

        <span class="s1">descriptor_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span>

        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_reconcile_prop_with_incoming_columns</span><span class="s4">(</span>
                <span class="s1">key</span><span class="s4">,</span>
                <span class="s1">prop</span><span class="s4">,</span>
                <span class="s1">single_column</span><span class="s4">=</span><span class="s1">column</span><span class="s4">,</span>
                <span class="s1">warn_only</span><span class="s4">=</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">prop </span><span class="s3">is None or </span><span class="s1">isinstance</span><span class="s4">(</span>
            <span class="s1">prop</span><span class="s4">, </span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">ConcreteInheritedProperty</span>
        <span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_prop_from_column</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">column</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">ArgumentError</span><span class="s4">(</span>
                <span class="s5">&quot;WARNING: when configuring property '%s' on %s, &quot;</span>
                <span class="s5">&quot;column '%s' conflicts with property '%r'. &quot;</span>
                <span class="s5">&quot;To resolve this, map the column to the class under a &quot;</span>
                <span class="s5">&quot;different name in the 'properties' dictionary.  Or, &quot;</span>
                <span class="s5">&quot;to remove all awareness of the column entirely &quot;</span>
                <span class="s5">&quot;(including its availability as a foreign key), &quot;</span>
                <span class="s5">&quot;use the 'include_properties' or 'exclude_properties' &quot;</span>
                <span class="s5">&quot;mapper arguments to control specifically which table &quot;</span>
                <span class="s5">&quot;columns get mapped.&quot; </span><span class="s4">% (</span><span class="s1">key</span><span class="s4">, </span><span class="s1">self</span><span class="s4">, </span><span class="s1">column</span><span class="s4">.</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">)</span>
            <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">langhelpers</span><span class="s4">.</span><span class="s1">tag_method_for_warnings</span><span class="s4">(</span>
        <span class="s5">&quot;This warning originated from the `configure_mappers()` process, &quot;</span>
        <span class="s5">&quot;which was invoked automatically in response to a user-initiated &quot;</span>
        <span class="s5">&quot;operation.&quot;</span><span class="s4">,</span>
        <span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">SAWarning</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_check_configure</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">_new_mappers</span><span class="s4">:</span>
            <span class="s1">_configure_registries</span><span class="s4">({</span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">}, </span><span class="s1">cascade</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_post_configure_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Call the ``init()`` method on all ``MapperProperties`` 
        attached to this mapper. 
 
        This is a deferred configuration step which is intended 
        to execute once all mappers have been constructed. 
 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;_post_configure_properties() started&quot;</span><span class="s4">)</span>
        <span class="s1">l </span><span class="s4">= [(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">) </span><span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()]</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">l</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;initialize prop %s&quot;</span><span class="s4">, </span><span class="s1">key</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">is </span><span class="s1">self </span><span class="s3">and not </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">_configure_started</span><span class="s4">:</span>
                <span class="s1">prop</span><span class="s4">.</span><span class="s1">init</span><span class="s4">()</span>

            <span class="s3">if </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">_configure_finished</span><span class="s4">:</span>
                <span class="s1">prop</span><span class="s4">.</span><span class="s1">post_instrument_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;_post_configure_properties() complete&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">configured </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">def </span><span class="s1">add_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dict_of_properties</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Add the given dictionary of properties to this mapper, 
        using `add_property`. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">dict_of_properties</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">add_property</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">add_property</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Add an individual MapperProperty to this mapper. 
 
        If the mapper has not been configured yet, just adds the 
        property to the initial properties dictionary sent to the 
        constructor.  If this Mapper has already been configured, then 
        the given MapperProperty is configured immediately. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_configure_property</span><span class="s4">(</span>
            <span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">, </span><span class="s1">init</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">configured</span><span class="s4">, </span><span class="s1">warn_for_existing</span><span class="s4">=</span><span class="s3">True</span>
        <span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">MapperProperty</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_init_properties</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">prop</span>

    <span class="s3">def </span><span class="s1">_expire_memoizations</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
            <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_reset_memoizations</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">_log_desc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s5">&quot;(&quot;</span>
            <span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span>
            <span class="s4">+ </span><span class="s5">&quot;|&quot;</span>
            <span class="s4">+ (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                <span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span>
                <span class="s3">or </span><span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s4">+ (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary </span><span class="s3">and </span><span class="s5">&quot;|non-primary&quot; </span><span class="s3">or </span><span class="s5">&quot;&quot;</span><span class="s4">)</span>
            <span class="s4">+ </span><span class="s5">&quot;)&quot;</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_log</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">msg</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s5">&quot;%s &quot; </span><span class="s4">+ </span><span class="s1">msg</span><span class="s4">, *((</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_log_desc</span><span class="s4">,) + </span><span class="s1">args</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">_log_debug</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">msg</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;%s &quot; </span><span class="s4">+ </span><span class="s1">msg</span><span class="s4">, *((</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_log_desc</span><span class="s4">,) + </span><span class="s1">args</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">&quot;&lt;Mapper at 0x%x; %s&gt;&quot; </span><span class="s4">% (</span><span class="s1">id</span><span class="s4">(</span><span class="s1">self</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">&quot;Mapper[%s%s(%s)]&quot; </span><span class="s4">% (</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">non_primary </span><span class="s3">and </span><span class="s5">&quot; (non-primary)&quot; </span><span class="s3">or </span><span class="s5">&quot;&quot;</span><span class="s4">,</span>
            <span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">description</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">is not None</span>
                <span class="s3">else </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span><span class="s4">.</span><span class="s1">description</span>
            <span class="s4">),</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_is_orphan</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">: </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s1">orphan_possible </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
            <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_delete_orphans</span><span class="s4">:</span>
                <span class="s1">orphan_possible </span><span class="s4">= </span><span class="s3">True</span>

                <span class="s1">has_parent </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">manager_of_class</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">).</span><span class="s1">has_parent</span><span class="s4">(</span>
                    <span class="s1">state</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">optimistic</span><span class="s4">=</span><span class="s1">state</span><span class="s4">.</span><span class="s1">has_identity</span>
                <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">legacy_is_orphan </span><span class="s3">and </span><span class="s1">has_parent</span><span class="s4">:</span>
                    <span class="s3">return False</span>
                <span class="s3">elif not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">legacy_is_orphan </span><span class="s3">and not </span><span class="s1">has_parent</span><span class="s4">:</span>
                    <span class="s3">return True</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">legacy_is_orphan</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">orphan_possible</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">has_property</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span>

    <span class="s3">def </span><span class="s1">get_property</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">_configure_mappers</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s4">) </span><span class="s1">-&gt; MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;return a MapperProperty associated with the given key.&quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">_configure_mappers</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                <span class="s5">f&quot;Mapper '</span><span class="s3">{</span><span class="s1">self</span><span class="s3">}</span><span class="s5">' has no property '</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">'.  If this property &quot;</span>
                <span class="s5">&quot;was indicated from other mappers or configure events, ensure &quot;</span>
                <span class="s5">&quot;registry.configure() has been called.&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

    <span class="s3">def </span><span class="s1">get_property_by_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">column</span><span class="s4">: </span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; MapperProperty</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Given a :class:`_schema.Column` object, return the 
        :class:`.MapperProperty` which maps this column.&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">iterate_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;return an iterator of all MapperProperty objects.&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">_mappers_from_spec</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">spec</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">selectable</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Sequence</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;given a with_polymorphic() argument, return the set of mappers it 
        represents. 
 
        Trims the list of mappers to just those represented within the given 
        selectable, if present. This helps some more legacy-ish mappings. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">spec </span><span class="s4">== </span><span class="s5">&quot;*&quot;</span><span class="s4">:</span>
            <span class="s1">mappers </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">self_and_descendants</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">spec</span><span class="s4">:</span>
            <span class="s1">mapper_set </span><span class="s4">= </span><span class="s1">set</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">util</span><span class="s4">.</span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">):</span>
                <span class="s1">m </span><span class="s4">= </span><span class="s1">_class_to_mapper</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
                <span class="s3">if not </span><span class="s1">m</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
                    <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                        <span class="s5">&quot;%r does not inherit from %r&quot; </span><span class="s4">% (</span><span class="s1">m</span><span class="s4">, </span><span class="s1">self</span><span class="s4">)</span>
                    <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">selectable </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s1">mapper_set</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">m</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">())</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">mapper_set</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
            <span class="s1">mappers </span><span class="s4">= [</span><span class="s1">m </span><span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">self_and_descendants </span><span class="s3">if </span><span class="s1">m </span><span class="s3">in </span><span class="s1">mapper_set</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">mappers </span><span class="s4">= []</span>

        <span class="s3">if </span><span class="s1">selectable </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">tables </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span>
                <span class="s1">sql_util</span><span class="s4">.</span><span class="s1">find_tables</span><span class="s4">(</span><span class="s1">selectable</span><span class="s4">, </span><span class="s1">include_aliases</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s1">mappers </span><span class="s4">= [</span><span class="s1">m </span><span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">mappers </span><span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">in </span><span class="s1">tables</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">mappers</span>

    <span class="s3">def </span><span class="s1">_selectable_from_mappers</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">mappers</span><span class="s4">: </span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]], </span><span class="s1">innerjoin</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s4">) </span><span class="s1">-&gt; FromClause</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;given a list of mappers (assumed to be within this mapper's 
        inheritance hierarchy), construct an outerjoin amongst those mapper's 
        mapped tables. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">from_obj </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span>
        <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">mappers</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">m </span><span class="s3">is </span><span class="s1">self</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">concrete</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                    <span class="s5">&quot;'with_polymorphic()' requires 'selectable' argument &quot;</span>
                    <span class="s5">&quot;when concrete-inheriting mappers are used.&quot;</span>
                <span class="s4">)</span>
            <span class="s3">elif not </span><span class="s1">m</span><span class="s4">.</span><span class="s1">single</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">innerjoin</span><span class="s4">:</span>
                    <span class="s1">from_obj </span><span class="s4">= </span><span class="s1">from_obj</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
                        <span class="s1">m</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">inherit_condition</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">from_obj </span><span class="s4">= </span><span class="s1">from_obj</span><span class="s4">.</span><span class="s1">outerjoin</span><span class="s4">(</span>
                        <span class="s1">m</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">inherit_condition</span>
                    <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">from_obj</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_version_id_has_server_side_value</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s1">vid_col </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">version_id_col</span>

        <span class="s3">if </span><span class="s1">vid_col </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return False</span>

        <span class="s3">elif not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">vid_col</span><span class="s4">, </span><span class="s1">Column</span><span class="s4">):</span>
            <span class="s3">return True</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">vid_col</span><span class="s4">.</span><span class="s1">server_default </span><span class="s3">is not None or </span><span class="s4">(</span>
                <span class="s1">vid_col</span><span class="s4">.</span><span class="s1">default </span><span class="s3">is not None</span>
                <span class="s3">and </span><span class="s4">(</span>
                    <span class="s3">not </span><span class="s1">vid_col</span><span class="s4">.</span><span class="s1">default</span><span class="s4">.</span><span class="s1">is_scalar</span>
                    <span class="s3">and not </span><span class="s1">vid_col</span><span class="s4">.</span><span class="s1">default</span><span class="s4">.</span><span class="s1">is_callable</span>
                <span class="s4">)</span>
            <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_single_table_criterion</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">single </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">.</span><span class="s1">_annotate</span><span class="s4">(</span>
                <span class="s4">{</span><span class="s5">&quot;parententity&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">, </span><span class="s5">&quot;parentmapper&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">}</span>
            <span class="s4">).</span><span class="s1">in_</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_identity</span>
                    <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">self_and_descendants</span>
                    <span class="s3">if not </span><span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_abstract</span>
                <span class="s4">]</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_has_aliased_polymorphic_fromclause</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;return True if with_polymorphic[1] is an aliased fromclause, 
        like a subquery. 
 
        As of #8168, polymorphic adaption with ORMAdapter is used only 
        if this is present. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">],</span>
            <span class="s1">expression</span><span class="s4">.</span><span class="s1">AliasedReturnsRows</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_should_select_with_poly_adapter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;determine if _MapperEntity or _ORMColumnEntity will need to use 
        polymorphic adaption when setting up a SELECT as well as fetching 
        rows for mapped classes and subclasses against this Mapper. 
 
        moved here from context.py for #8456 to generalize the ruleset 
        for this condition. 
 
        &quot;&quot;&quot;</span>

        <span class="s0"># this has been simplified as of #8456.</span>
        <span class="s0"># rule is: if we have a with_polymorphic or a concrete-style</span>
        <span class="s0"># polymorphic selectable, *or* if the base mapper has either of those,</span>
        <span class="s0"># we turn on the adaption thing.  if not, we do *no* adaption.</span>
        <span class="s0">#</span>
        <span class="s0"># (UPDATE for #8168: the above comment was not accurate, as we were</span>
        <span class="s0"># still saying &quot;do polymorphic&quot; if we were using an auto-generated</span>
        <span class="s0"># flattened JOIN for with_polymorphic.)</span>
        <span class="s0">#</span>
        <span class="s0"># this splits the behavior among the &quot;regular&quot; joined inheritance</span>
        <span class="s0"># and single inheritance mappers, vs. the &quot;weird / difficult&quot;</span>
        <span class="s0"># concrete and joined inh mappings that use a with_polymorphic of</span>
        <span class="s0"># some kind or polymorphic_union.</span>
        <span class="s0">#</span>
        <span class="s0"># note we have some tests in test_polymorphic_rel that query against</span>
        <span class="s0"># a subclass, then refer to the superclass that has a with_polymorphic</span>
        <span class="s0"># on it (such as test_join_from_polymorphic_explicit_aliased_three).</span>
        <span class="s0"># these tests actually adapt the polymorphic selectable (like, the</span>
        <span class="s0"># UNION or the SELECT subquery with JOIN in it) to be just the simple</span>
        <span class="s0"># subclass table.   Hence even if we are a &quot;plain&quot; inheriting mapper</span>
        <span class="s0"># but our base has a wpoly on it, we turn on adaption.  This is a</span>
        <span class="s0"># legacy case we should probably disable.</span>
        <span class="s0">#</span>
        <span class="s0">#</span>
        <span class="s0"># UPDATE: simplified way more as of #8168.   polymorphic adaption</span>
        <span class="s0"># is turned off even if with_polymorphic is set, as long as there</span>
        <span class="s0"># is no user-defined aliased selectable / subquery configured.</span>
        <span class="s0"># this scales back the use of polymorphic adaption in practice</span>
        <span class="s0"># to basically no cases except for concrete inheritance with a</span>
        <span class="s0"># polymorphic base class.</span>
        <span class="s0">#</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_has_aliased_polymorphic_fromclause</span>
            <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_requires_row_aliasing</span>
            <span class="s3">or </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">_has_aliased_polymorphic_fromclause</span><span class="s4">)</span>
            <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">_requires_row_aliasing</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_with_polymorphic_mappers</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Sequence</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">[]</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_mappers_from_spec</span><span class="s4">(*</span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_post_inspect</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;This hook is invoked by attribute inspection. 
 
        E.g. when Query calls: 
 
            coercions.expect(roles.ColumnsClauseRole, ent, keep_inspect=True) 
 
        This allows the inspection process run a configure mappers hook. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">HasMemoized_ro_memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_with_polymorphic_selectable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; FromClause</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable</span>

        <span class="s1">spec</span><span class="s4">, </span><span class="s1">selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span>
        <span class="s3">if </span><span class="s1">selectable </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">selectable</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_selectable_from_mappers</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_mappers_from_spec</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">, </span><span class="s1">selectable</span><span class="s4">), </span><span class="s3">False</span>
            <span class="s4">)</span>

    <span class="s1">with_polymorphic_mappers </span><span class="s4">= </span><span class="s1">_with_polymorphic_mappers</span>
    <span class="s5">&quot;&quot;&quot;The list of :class:`_orm.Mapper` objects included in the 
    default &quot;polymorphic&quot; query. 
 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">HasMemoized_ro_memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_insert_cols_evaluating_none</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span>
                <span class="s1">col </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">columns </span><span class="s3">if </span><span class="s1">col</span><span class="s4">.</span><span class="s1">type</span><span class="s4">.</span><span class="s1">should_evaluate_none</span>
            <span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_insert_cols_as_none</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span>
                <span class="s1">col</span><span class="s4">.</span><span class="s1">key</span>
                <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">columns</span>
                <span class="s3">if not </span><span class="s1">col</span><span class="s4">.</span><span class="s1">primary_key</span>
                <span class="s3">and not </span><span class="s1">col</span><span class="s4">.</span><span class="s1">server_default</span>
                <span class="s3">and not </span><span class="s1">col</span><span class="s4">.</span><span class="s1">default</span>
                <span class="s3">and not </span><span class="s1">col</span><span class="s4">.</span><span class="s1">type</span><span class="s4">.</span><span class="s1">should_evaluate_none</span>
            <span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_propkey_to_col</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: {</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">].</span><span class="s1">key</span><span class="s4">: </span><span class="s1">col </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">columns</span><span class="s4">}</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_pk_keys_by_table</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">pks</span><span class="s4">])</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">pks </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_pk_attr_keys_by_table</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">].</span><span class="s1">key </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">pks</span><span class="s4">])</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">pks </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_server_default_cols</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Mapping</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]:</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s1">col</span>
                    <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;Iterable[Column[Any]]&quot;</span><span class="s4">, </span><span class="s1">columns</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">col</span><span class="s4">.</span><span class="s1">server_default </span><span class="s3">is not None</span>
                    <span class="s3">or </span><span class="s4">(</span>
                        <span class="s1">col</span><span class="s4">.</span><span class="s1">default </span><span class="s3">is not None</span>
                        <span class="s3">and </span><span class="s1">col</span><span class="s4">.</span><span class="s1">default</span><span class="s4">.</span><span class="s1">is_clause_element</span>
                    <span class="s4">)</span>
                <span class="s4">]</span>
            <span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_server_onupdate_default_cols</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Mapping</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">Column</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]]:</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s1">col</span>
                    <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;Iterable[Column[Any]]&quot;</span><span class="s4">, </span><span class="s1">columns</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">col</span><span class="s4">.</span><span class="s1">server_onupdate </span><span class="s3">is not None</span>
                    <span class="s3">or </span><span class="s4">(</span>
                        <span class="s1">col</span><span class="s4">.</span><span class="s1">onupdate </span><span class="s3">is not None</span>
                        <span class="s3">and </span><span class="s1">col</span><span class="s4">.</span><span class="s1">onupdate</span><span class="s4">.</span><span class="s1">is_clause_element</span>
                    <span class="s4">)</span>
                <span class="s4">]</span>
            <span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cols_by_table</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_server_default_col_keys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Mapping</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span><span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">cols </span><span class="s3">if </span><span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s3">is not None</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">cols </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_server_default_cols</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_server_onupdate_default_col_keys</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Mapping</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">, </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">table</span><span class="s4">: </span><span class="s1">frozenset</span><span class="s4">(</span><span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">cols </span><span class="s3">if </span><span class="s1">col</span><span class="s4">.</span><span class="s1">key </span><span class="s3">is not None</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">cols </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_server_onupdate_default_cols</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_server_default_plus_onupdate_propkeys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s1">result</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s1">set</span><span class="s4">()</span>

        <span class="s1">col_to_property </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span>
        <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_server_default_cols</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">result</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span>
                <span class="s1">col_to_property</span><span class="s4">[</span><span class="s1">col</span><span class="s4">].</span><span class="s1">key</span>
                <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">columns</span><span class="s4">.</span><span class="s1">intersection</span><span class="s4">(</span><span class="s1">col_to_property</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">columns </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_server_onupdate_default_cols</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">result</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span>
                <span class="s1">col_to_property</span><span class="s4">[</span><span class="s1">col</span><span class="s4">].</span><span class="s1">key</span>
                <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">columns</span><span class="s4">.</span><span class="s1">intersection</span><span class="s4">(</span><span class="s1">col_to_property</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">result</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_instancemethod</span>
    <span class="s3">def </span><span class="s1">__clause_element__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">annotations</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {</span>
            <span class="s5">&quot;entity_namespace&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
            <span class="s5">&quot;parententity&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
            <span class="s5">&quot;parentmapper&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">persist_selectable </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">:</span>
            <span class="s0"># joined table inheritance, with polymorphic selectable,</span>
            <span class="s0"># etc.</span>
            <span class="s1">annotations</span><span class="s4">[</span><span class="s5">&quot;dml_table&quot;</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">.</span><span class="s1">_annotate</span><span class="s4">(</span>
                <span class="s4">{</span>
                    <span class="s5">&quot;entity_namespace&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                    <span class="s5">&quot;parententity&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                    <span class="s5">&quot;parentmapper&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                <span class="s4">}</span>
            <span class="s4">).</span><span class="s1">_set_propagate_attrs</span><span class="s4">(</span>
                <span class="s4">{</span><span class="s5">&quot;compile_state_plugin&quot;</span><span class="s4">: </span><span class="s5">&quot;orm&quot;</span><span class="s4">, </span><span class="s5">&quot;plugin_subject&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">}</span>
            <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">selectable</span><span class="s4">.</span><span class="s1">_annotate</span><span class="s4">(</span><span class="s1">annotations</span><span class="s4">).</span><span class="s1">_set_propagate_attrs</span><span class="s4">(</span>
            <span class="s4">{</span><span class="s5">&quot;compile_state_plugin&quot;</span><span class="s4">: </span><span class="s5">&quot;orm&quot;</span><span class="s4">, </span><span class="s5">&quot;plugin_subject&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">}</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">memoized_property</span>
    <span class="s3">def </span><span class="s1">select_identity_token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">expression</span><span class="s4">.</span><span class="s1">null</span><span class="s4">()</span>
            <span class="s4">.</span><span class="s1">_annotate</span><span class="s4">(</span>
                <span class="s4">{</span>
                    <span class="s5">&quot;entity_namespace&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                    <span class="s5">&quot;parententity&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                    <span class="s5">&quot;parentmapper&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">,</span>
                    <span class="s5">&quot;identity_token&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">}</span>
            <span class="s4">)</span>
            <span class="s4">.</span><span class="s1">_set_propagate_attrs</span><span class="s4">(</span>
                <span class="s4">{</span><span class="s5">&quot;compile_state_plugin&quot;</span><span class="s4">: </span><span class="s5">&quot;orm&quot;</span><span class="s4">, </span><span class="s5">&quot;plugin_subject&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">}</span>
            <span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">selectable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; FromClause</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;The :class:`_schema.FromClause` construct this 
        :class:`_orm.Mapper` selects from by default. 
 
        Normally, this is equivalent to :attr:`.persist_selectable`, unless 
        the ``with_polymorphic`` feature is in use, in which case the 
        full &quot;polymorphic&quot; selectable is returned. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_with_polymorphic_selectable</span>

    <span class="s3">def </span><span class="s1">_with_polymorphic_args</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">spec</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">selectable</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Literal</span><span class="s4">[</span><span class="s3">False</span><span class="s4">, </span><span class="s3">None</span><span class="s4">], </span><span class="s1">FromClause</span><span class="s4">] = </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">innerjoin</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]], </span><span class="s1">FromClause</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">selectable </span><span class="s3">not in </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
            <span class="s1">selectable </span><span class="s4">= </span><span class="s1">coercions</span><span class="s4">.</span><span class="s1">expect</span><span class="s4">(</span>
                <span class="s1">roles</span><span class="s4">.</span><span class="s1">StrictFromClauseRole</span><span class="s4">, </span><span class="s1">selectable</span><span class="s4">, </span><span class="s1">allow_select</span><span class="s4">=</span><span class="s3">True</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">spec</span><span class="s4">:</span>
                <span class="s1">spec </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">selectable </span><span class="s3">is False</span><span class="s4">:</span>
                <span class="s1">selectable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_polymorphic</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
        <span class="s3">elif </span><span class="s1">selectable </span><span class="s3">is False</span><span class="s4">:</span>
            <span class="s1">selectable </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">mappers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_mappers_from_spec</span><span class="s4">(</span><span class="s1">spec</span><span class="s4">, </span><span class="s1">selectable</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">selectable </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">mappers</span><span class="s4">, </span><span class="s1">selectable</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">mappers</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_selectable_from_mappers</span><span class="s4">(</span><span class="s1">mappers</span><span class="s4">, </span><span class="s1">innerjoin</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_polymorphic_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_iterate_polymorphic_properties</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_with_polymorphic_mappers</span>
            <span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">_all_column_expressions</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">poly_properties </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_properties</span>
        <span class="s1">adapter </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_adapter</span>

        <span class="s3">return </span><span class="s4">[</span>
            <span class="s1">adapter</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] </span><span class="s3">if </span><span class="s1">adapter </span><span class="s3">else </span><span class="s1">c</span>
            <span class="s3">for </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">poly_properties</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">)</span>
            <span class="s3">and </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">_renders_in_subqueries</span>
            <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span>
        <span class="s4">]</span>

    <span class="s3">def </span><span class="s1">_columns_plus_keys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">polymorphic_mappers</span><span class="s4">=()):</span>
        <span class="s3">if </span><span class="s1">polymorphic_mappers</span><span class="s4">:</span>
            <span class="s1">poly_properties </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_iterate_polymorphic_properties</span><span class="s4">(</span>
                <span class="s1">polymorphic_mappers</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">poly_properties </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_polymorphic_properties</span>

        <span class="s3">return </span><span class="s4">[</span>
            <span class="s4">(</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
            <span class="s3">for </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">poly_properties</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">)</span>
        <span class="s4">]</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_polymorphic_adapter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">orm_util</span><span class="s4">.</span><span class="s1">ORMAdapter</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_has_aliased_polymorphic_fromclause</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">orm_util</span><span class="s4">.</span><span class="s1">ORMAdapter</span><span class="s4">(</span>
                <span class="s1">orm_util</span><span class="s4">.</span><span class="s1">_TraceAdaptRole</span><span class="s4">.</span><span class="s1">MAPPER_POLYMORPHIC_ADAPTER</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">,</span>
                <span class="s1">selectable</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">selectable</span><span class="s4">,</span>
                <span class="s1">equivalents</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_equivalent_columns</span><span class="s4">,</span>
                <span class="s1">limit_on_entity</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">_iterate_polymorphic_properties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mappers</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Return an iterator of MapperProperty objects which will render into 
        a SELECT.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">mappers </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mappers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_with_polymorphic_mappers</span>

        <span class="s3">if not </span><span class="s1">mappers</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_properties</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s1">c</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># in the polymorphic case, filter out discriminator columns</span>
            <span class="s0"># from other mappers, as these are sometimes dependent on that</span>
            <span class="s0"># mapper's polymorphic selectable (which we don't want rendered)</span>
            <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">util</span><span class="s4">.</span><span class="s1">unique_list</span><span class="s4">(</span>
                <span class="s1">chain</span><span class="s4">(</span>
                    <span class="s4">*[</span>
                        <span class="s1">list</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">iterate_properties</span><span class="s4">)</span>
                        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s4">[</span><span class="s1">self</span><span class="s4">] + </span><span class="s1">mappers</span>
                    <span class="s4">]</span>
                <span class="s4">)</span>
            <span class="s4">):</span>
                <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s5">&quot;_is_polymorphic_discriminator&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is None</span>
                    <span class="s3">or </span><span class="s1">c</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span>
                <span class="s4">):</span>
                    <span class="s3">continue</span>
                <span class="s3">yield </span><span class="s1">c</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">attrs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">MapperProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;A namespace of all :class:`.MapperProperty` objects 
        associated this mapper. 
 
        This is an object that provides each property based on 
        its key name.  For instance, the mapper for a 
        ``User`` class which has ``User.name`` attribute would 
        provide ``mapper.attrs.name``, which would be the 
        :class:`.ColumnProperty` representing the ``name`` 
        column.   The namespace object can also be iterated, 
        which would yield each :class:`.MapperProperty`. 
 
        :class:`_orm.Mapper` has several pre-filtered views 
        of this attribute which limit the types of properties 
        returned, including :attr:`.synonyms`, :attr:`.column_attrs`, 
        :attr:`.relationships`, and :attr:`.composites`. 
 
        .. warning:: 
 
            The :attr:`_orm.Mapper.attrs` accessor namespace is an 
            instance of :class:`.OrderedProperties`.  This is 
            a dictionary-like object which includes a small number of 
            named methods such as :meth:`.OrderedProperties.items` 
            and :meth:`.OrderedProperties.values`.  When 
            accessing attributes dynamically, favor using the dict-access 
            scheme, e.g. ``mapper.attrs[somename]`` over 
            ``getattr(mapper.attrs, somename)`` to avoid name collisions. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.all_orm_descriptors` 
 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">all_orm_descriptors</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">InspectionAttr</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;A namespace of all :class:`.InspectionAttr` attributes associated 
        with the mapped class. 
 
        These attributes are in all cases Python :term:`descriptors` 
        associated with the mapped class or its superclasses. 
 
        This namespace includes attributes that are mapped to the class 
        as well as attributes declared by extension modules. 
        It includes any Python descriptor type that inherits from 
        :class:`.InspectionAttr`.  This includes 
        :class:`.QueryableAttribute`, as well as extension types such as 
        :class:`.hybrid_property`, :class:`.hybrid_method` and 
        :class:`.AssociationProxy`. 
 
        To distinguish between mapped attributes and extension attributes, 
        the attribute :attr:`.InspectionAttr.extension_type` will refer 
        to a constant that distinguishes between different extension types. 
 
        The sorting of the attributes is based on the following rules: 
 
        1. Iterate through the class and its superclasses in order from 
           subclass to superclass (i.e. iterate through ``cls.__mro__``) 
 
        2. For each class, yield the attributes in the order in which they 
           appear in ``__dict__``, with the exception of those in step 
           3 below.  In Python 3.6 and above this ordering will be the 
           same as that of the class' construction, with the exception 
           of attributes that were added after the fact by the application 
           or the mapper. 
 
        3. If a certain attribute key is also in the superclass ``__dict__``, 
           then it's included in the iteration for that class, and not the 
           class in which it first appeared. 
 
        The above process produces an ordering that is deterministic in terms 
        of the order in which attributes were assigned to the class. 
 
        .. versionchanged:: 1.3.19 ensured deterministic ordering for 
           :meth:`_orm.Mapper.all_orm_descriptors`. 
 
        When dealing with a :class:`.QueryableAttribute`, the 
        :attr:`.QueryableAttribute.property` attribute refers to the 
        :class:`.MapperProperty` property, which is what you get when 
        referring to the collection of mapped properties via 
        :attr:`_orm.Mapper.attrs`. 
 
        .. warning:: 
 
            The :attr:`_orm.Mapper.all_orm_descriptors` 
            accessor namespace is an 
            instance of :class:`.OrderedProperties`.  This is 
            a dictionary-like object which includes a small number of 
            named methods such as :meth:`.OrderedProperties.items` 
            and :meth:`.OrderedProperties.values`.  When 
            accessing attributes dynamically, favor using the dict-access 
            scheme, e.g. ``mapper.all_orm_descriptors[somename]`` over 
            ``getattr(mapper.all_orm_descriptors, somename)`` to avoid name 
            collisions. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.attrs` 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">(</span>
            <span class="s1">dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">.</span><span class="s1">_all_sqla_attributes</span><span class="s4">())</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_pk_synonyms</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;return a dictionary of {syn_attribute_name: pk_attr_name} for 
        all synonyms that refer to primary key columns 
 
        &quot;&quot;&quot;</span>
        <span class="s1">descriptor_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span>

        <span class="s1">pk_keys </span><span class="s4">= {</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key </span><span class="s3">for </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_props</span><span class="s4">}</span>

        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">syn</span><span class="s4">.</span><span class="s1">key</span><span class="s4">: </span><span class="s1">syn</span><span class="s4">.</span><span class="s1">name</span>
            <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">syn </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">syn</span><span class="s4">, </span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">SynonymProperty</span><span class="s4">)</span>
            <span class="s3">and </span><span class="s1">syn</span><span class="s4">.</span><span class="s1">name </span><span class="s3">in </span><span class="s1">pk_keys</span>
        <span class="s4">}</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">synonyms</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">SynonymProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return a namespace of all :class:`.Synonym` 
        properties maintained by this :class:`_orm.Mapper`. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.attrs` - namespace of all 
            :class:`.MapperProperty` 
            objects. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">descriptor_props </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_filter_properties</span><span class="s4">(</span><span class="s1">descriptor_props</span><span class="s4">.</span><span class="s1">SynonymProperty</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">entity_namespace</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">column_attrs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">ColumnProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return a namespace of all :class:`.ColumnProperty` 
        properties maintained by this :class:`_orm.Mapper`. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.attrs` - namespace of all 
            :class:`.MapperProperty` 
            objects. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_filter_properties</span><span class="s4">(</span><span class="s1">properties</span><span class="s4">.</span><span class="s1">ColumnProperty</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.relationships&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">relationships</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">RelationshipProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;A namespace of all :class:`.Relationship` properties 
        maintained by this :class:`_orm.Mapper`. 
 
        .. warning:: 
 
            the :attr:`_orm.Mapper.relationships` accessor namespace is an 
            instance of :class:`.OrderedProperties`.  This is 
            a dictionary-like object which includes a small number of 
            named methods such as :meth:`.OrderedProperties.items` 
            and :meth:`.OrderedProperties.values`.  When 
            accessing attributes dynamically, favor using the dict-access 
            scheme, e.g. ``mapper.relationships[somename]`` over 
            ``getattr(mapper.relationships, somename)`` to avoid name 
            collisions. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.attrs` - namespace of all 
            :class:`.MapperProperty` 
            objects. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_filter_properties</span><span class="s4">(</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_relationships</span><span class="s4">.</span><span class="s1">RelationshipProperty</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.descriptor_props&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">composites</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">CompositeProperty</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return a namespace of all :class:`.Composite` 
        properties maintained by this :class:`_orm.Mapper`. 
 
        .. seealso:: 
 
            :attr:`_orm.Mapper.attrs` - namespace of all 
            :class:`.MapperProperty` 
            objects. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_filter_properties</span><span class="s4">(</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_descriptor_props</span><span class="s4">.</span><span class="s1">CompositeProperty</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_filter_properties</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">type_</span><span class="s4">: </span><span class="s1">Type</span><span class="s4">[</span><span class="s1">_MP</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">[</span><span class="s1">_MP</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">util</span><span class="s4">.</span><span class="s1">ReadOnlyProperties</span><span class="s4">(</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">OrderedDict</span><span class="s4">(</span>
                <span class="s4">(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">v</span><span class="s4">) </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">items</span><span class="s4">() </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s1">type_</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_get_clause</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;create a &quot;get clause&quot; based on the primary key.  this is used 
        by query.get() and many-to-one lazyloads to load this item 
        by primary key. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">params </span><span class="s4">= [</span>
            <span class="s4">(</span>
                <span class="s1">primary_key</span><span class="s4">,</span>
                <span class="s1">sql</span><span class="s4">.</span><span class="s1">bindparam</span><span class="s4">(</span><span class="s5">&quot;pk_%d&quot; </span><span class="s4">% </span><span class="s1">idx</span><span class="s4">, </span><span class="s1">type_</span><span class="s4">=</span><span class="s1">primary_key</span><span class="s4">.</span><span class="s1">type</span><span class="s4">),</span>
            <span class="s4">)</span>
            <span class="s3">for </span><span class="s1">idx</span><span class="s4">, </span><span class="s1">primary_key </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
        <span class="s4">]</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">sql</span><span class="s4">.</span><span class="s1">and_</span><span class="s4">(*[</span><span class="s1">k </span><span class="s4">== </span><span class="s1">v </span><span class="s3">for </span><span class="s4">(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">v</span><span class="s4">) </span><span class="s3">in </span><span class="s1">params</span><span class="s4">]),</span>
            <span class="s1">util</span><span class="s4">.</span><span class="s1">column_dict</span><span class="s4">(</span><span class="s1">params</span><span class="s4">),</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_equivalent_columns</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; _EquivalentColumnMap</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Create a map of all equivalent columns, based on 
        the determination of column pairs that are equated to 
        one another based on inherit condition.  This is designed 
        to work with the queries that util.polymorphic_union 
        comes up with, which often don't include the columns from 
        the base table directly (including the subclass table columns 
        only). 
 
        The resulting structure is a dictionary of columns mapped 
        to lists of equivalent columns, e.g.:: 
 
            { 
                tablea.col1: 
                    {tableb.col1, tablec.col1}, 
                tablea.col2: 
                    {tabled.col2} 
            } 
 
        &quot;&quot;&quot;</span>
        <span class="s1">result</span><span class="s4">: </span><span class="s1">_EquivalentColumnMap </span><span class="s4">= {}</span>

        <span class="s3">def </span><span class="s1">visit_binary</span><span class="s4">(</span><span class="s1">binary</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">binary</span><span class="s4">.</span><span class="s1">operator </span><span class="s4">== </span><span class="s1">operators</span><span class="s4">.</span><span class="s1">eq</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left </span><span class="s3">in </span><span class="s1">result</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left</span><span class="s4">] = {</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">}</span>
                <span class="s3">if </span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right </span><span class="s3">in </span><span class="s1">result</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">].</span><span class="s1">add</span><span class="s4">(</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">] = {</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left</span><span class="s4">}</span>

        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">self_and_descendants</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">visitors</span><span class="s4">.</span><span class="s1">traverse</span><span class="s4">(</span>
                    <span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherit_condition</span><span class="s4">, {}, {</span><span class="s5">&quot;binary&quot;</span><span class="s4">: </span><span class="s1">visit_binary</span><span class="s4">}</span>
                <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">result</span>

    <span class="s3">def </span><span class="s1">_is_userland_descriptor</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">assigned_name</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span>
            <span class="s1">obj</span><span class="s4">,</span>
            <span class="s4">(</span>
                <span class="s1">_MappedAttribute</span><span class="s4">,</span>
                <span class="s1">instrumentation</span><span class="s4">.</span><span class="s1">ClassManager</span><span class="s4">,</span>
                <span class="s1">expression</span><span class="s4">.</span><span class="s1">ColumnElement</span><span class="s4">,</span>
            <span class="s4">),</span>
        <span class="s4">):</span>
            <span class="s3">return False</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">assigned_name </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_dataclass_fields</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_dataclass_fields</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">f</span><span class="s4">.</span><span class="s1">name </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">util</span><span class="s4">.</span><span class="s1">dataclass_fields</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)]</span>

    <span class="s3">def </span><span class="s1">_should_exclude</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">assigned_name</span><span class="s4">, </span><span class="s1">local</span><span class="s4">, </span><span class="s1">column</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;determine whether a particular property should be implicitly 
        present on the class. 
 
        This occurs when properties are propagated from an inherited class, or 
        are applied from the columns present in the mapped table. 
 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">column </span><span class="s3">is not None and </span><span class="s1">sql_base</span><span class="s4">.</span><span class="s1">_never_select_column</span><span class="s4">(</span><span class="s1">column</span><span class="s4">):</span>
            <span class="s3">return True</span>

        <span class="s0"># check for class-bound attributes and/or descriptors,</span>
        <span class="s0"># either local or from an inherited class</span>
        <span class="s0"># ignore dataclass field default values</span>
        <span class="s3">if </span><span class="s1">local</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span>
                <span class="s1">assigned_name</span><span class="s4">, </span><span class="s3">None</span>
            <span class="s4">) </span><span class="s3">is not None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_is_userland_descriptor</span><span class="s4">(</span>
                <span class="s1">assigned_name</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">[</span><span class="s1">assigned_name</span><span class="s4">]</span>
            <span class="s4">):</span>
                <span class="s3">return True</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">attr </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">.</span><span class="s1">_get_class_attr_mro</span><span class="s4">(</span><span class="s1">assigned_name</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">attr </span><span class="s3">is not None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_is_userland_descriptor</span><span class="s4">(</span>
                <span class="s1">assigned_name</span><span class="s4">, </span><span class="s1">attr</span>
            <span class="s4">):</span>
                <span class="s3">return True</span>

        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">include_properties </span><span class="s3">is not None</span>
            <span class="s3">and </span><span class="s1">name </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">include_properties</span>
            <span class="s3">and </span><span class="s4">(</span><span class="s1">column </span><span class="s3">is None or </span><span class="s1">column </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">include_properties</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;not including property %s&quot; </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">))</span>
            <span class="s3">return True</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">exclude_properties </span><span class="s3">is not None and </span><span class="s4">(</span>
            <span class="s1">name </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">exclude_properties</span>
            <span class="s3">or </span><span class="s4">(</span><span class="s1">column </span><span class="s3">is not None and </span><span class="s1">column </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">exclude_properties</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_log</span><span class="s4">(</span><span class="s5">&quot;excluding property %s&quot; </span><span class="s4">% (</span><span class="s1">name</span><span class="s4">))</span>
            <span class="s3">return True</span>

        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">common_parent</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">: </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return true if the given mapper shares a 
        common inherited parent as this mapper.&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper </span><span class="s3">is </span><span class="s1">other</span><span class="s4">.</span><span class="s1">base_mapper</span>

    <span class="s3">def </span><span class="s1">is_sibling</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">: </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;return true if the other mapper is an inheriting sibling to this 
        one.  common parent but different branch 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper </span><span class="s3">is </span><span class="s1">other</span><span class="s4">.</span><span class="s1">base_mapper</span>
            <span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>
            <span class="s3">and not </span><span class="s1">other</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_canload</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">: </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">allow_subtypes</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s1">s </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_mapper</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None or </span><span class="s1">allow_subtypes</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">_state_mapper</span><span class="s4">(</span><span class="s1">state</span><span class="s4">).</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">s</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">_state_mapper</span><span class="s4">(</span><span class="s1">state</span><span class="s4">) </span><span class="s3">is </span><span class="s1">s</span>

    <span class="s3">def </span><span class="s1">isa</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">: </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return True if the this mapper inherits from the given mapper.&quot;&quot;&quot;</span>

        <span class="s1">m</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">self</span>
        <span class="s3">while </span><span class="s1">m </span><span class="s3">and </span><span class="s1">m </span><span class="s3">is not </span><span class="s1">other</span><span class="s4">:</span>
            <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">inherits</span>
        <span class="s3">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">iterate_to_root</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s1">m</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">self</span>
        <span class="s3">while </span><span class="s1">m</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">m</span>
            <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">inherits</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">self_and_descendants</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Sequence</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;The collection including this mapper and all descendant mappers. 
 
        This includes not just the immediately inheriting mappers but 
        all their inheriting mappers as well. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">descendants </span><span class="s4">= []</span>
        <span class="s1">stack </span><span class="s4">= </span><span class="s1">deque</span><span class="s4">([</span><span class="s1">self</span><span class="s4">])</span>
        <span class="s3">while </span><span class="s1">stack</span><span class="s4">:</span>
            <span class="s1">item </span><span class="s4">= </span><span class="s1">stack</span><span class="s4">.</span><span class="s1">popleft</span><span class="s4">()</span>
            <span class="s1">descendants</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
            <span class="s1">stack</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">item</span><span class="s4">.</span><span class="s1">_inheriting_mappers</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">util</span><span class="s4">.</span><span class="s1">WeakSequence</span><span class="s4">(</span><span class="s1">descendants</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">polymorphic_iterator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Iterate through the collection including this mapper and 
        all descendant mappers. 
 
        This includes not just the immediately inheriting mappers but 
        all their inheriting mappers as well. 
 
        To iterate through an entire hierarchy, use 
        ``mapper.base_mapper.polymorphic_iterator()``. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">self_and_descendants</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">primary_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the primary mapper corresponding to this mapper's class key 
        (class).&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">.</span><span class="s1">mapper</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">primary_base_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">base_mapper</span>

    <span class="s3">def </span><span class="s1">_result_has_identity_key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">result</span><span class="s4">, </span><span class="s1">adapter</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">pk_cols</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">ColumnClause</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span>
        <span class="s3">if </span><span class="s1">adapter</span><span class="s4">:</span>
            <span class="s1">pk_cols </span><span class="s4">= [</span><span class="s1">adapter</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] </span><span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">pk_cols</span><span class="s4">]</span>
        <span class="s1">rk </span><span class="s4">= </span><span class="s1">result</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">pk_cols</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">col </span><span class="s3">not in </span><span class="s1">rk</span><span class="s4">:</span>
                <span class="s3">return False</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">identity_key_from_row</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">row</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Row</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">RowMapping</span><span class="s4">]],</span>
        <span class="s1">identity_token</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">adapter</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ORMAdapter</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; _IdentityKeyType</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return an identity-map key for use in storing/retrieving an 
        item from the identity map. 
 
        :param row: A :class:`.Row` or :class:`.RowMapping` produced from a 
         result set that selected from the ORM mapped primary key columns. 
 
         .. versionchanged:: 2.0 
            :class:`.Row` or :class:`.RowMapping` are accepted 
            for the &quot;row&quot; argument 
 
        &quot;&quot;&quot;</span>
        <span class="s1">pk_cols</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">ColumnClause</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span>
        <span class="s3">if </span><span class="s1">adapter</span><span class="s4">:</span>
            <span class="s1">pk_cols </span><span class="s4">= [</span><span class="s1">adapter</span><span class="s4">.</span><span class="s1">columns</span><span class="s4">[</span><span class="s1">c</span><span class="s4">] </span><span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">pk_cols</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">row</span><span class="s4">, </span><span class="s5">&quot;_mapping&quot;</span><span class="s4">):</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">row</span><span class="s4">.</span><span class="s1">_mapping  </span><span class="s0"># type: ignore</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;Mapping[Any, Any]&quot;</span><span class="s4">, </span><span class="s1">row</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class</span><span class="s4">,</span>
            <span class="s1">tuple</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">column</span><span class="s4">] </span><span class="s3">for </span><span class="s1">column </span><span class="s3">in </span><span class="s1">pk_cols</span><span class="s4">),  </span><span class="s0"># type: ignore</span>
            <span class="s1">identity_token</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">identity_key_from_primary_key</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">primary_key</span><span class="s4">: </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, ...],</span>
        <span class="s1">identity_token</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; _IdentityKeyType</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return an identity-map key for use in storing/retrieving an 
        item from an identity map. 
 
        :param primary_key: A list of values indicating the identifier. 
 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class</span><span class="s4">,</span>
            <span class="s1">tuple</span><span class="s4">(</span><span class="s1">primary_key</span><span class="s4">),</span>
            <span class="s1">identity_token</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">identity_key_from_instance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">instance</span><span class="s4">: </span><span class="s1">_O</span><span class="s4">) </span><span class="s1">-&gt; _IdentityKeyType</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the identity key for the given instance, based on 
        its primary key attributes. 
 
        If the instance's state is expired, calling this method 
        will result in a database check to see if the object has been deleted. 
        If the row no longer exists, 
        :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised. 
 
        This value is typically also found on the instance state under the 
        attribute name `key`. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">state </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">instance_state</span><span class="s4">(</span><span class="s1">instance</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_from_state</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_OFF</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_identity_key_from_state</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">state</span><span class="s4">: </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
        <span class="s1">passive</span><span class="s4">: </span><span class="s1">PassiveFlag </span><span class="s4">= </span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_RETURN_NO_VALUE</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; _IdentityKeyType</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">]:</span>
        <span class="s1">dict_ </span><span class="s4">= </span><span class="s1">state</span><span class="s4">.</span><span class="s1">dict</span>
        <span class="s1">manager </span><span class="s4">= </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_class</span><span class="s4">,</span>
            <span class="s1">tuple</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s1">manager</span><span class="s4">[</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">].</span><span class="s1">impl</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">passive</span><span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_props</span>
                <span class="s4">]</span>
            <span class="s4">),</span>
            <span class="s1">state</span><span class="s4">.</span><span class="s1">identity_token</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">primary_key_from_instance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">instance</span><span class="s4">: </span><span class="s1">_O</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, ...]:</span>
        <span class="s2">&quot;&quot;&quot;Return the list of primary key values for the given 
        instance. 
 
        If the instance's state is expired, calling this method 
        will result in a database check to see if the object has been deleted. 
        If the row no longer exists, 
        :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">state </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">instance_state</span><span class="s4">(</span><span class="s1">instance</span><span class="s4">)</span>
        <span class="s1">identity_key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_from_state</span><span class="s4">(</span>
            <span class="s1">state</span><span class="s4">, </span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_OFF</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">identity_key</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_persistent_sortkey_fn</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">key_fns </span><span class="s4">= [</span><span class="s1">col</span><span class="s4">.</span><span class="s1">type</span><span class="s4">.</span><span class="s1">sort_key_function </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">set</span><span class="s4">(</span><span class="s1">key_fns</span><span class="s4">).</span><span class="s1">difference</span><span class="s4">([</span><span class="s3">None</span><span class="s4">]):</span>

            <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">state</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s1">tuple</span><span class="s4">(</span>
                    <span class="s1">key_fn</span><span class="s4">(</span><span class="s1">val</span><span class="s4">) </span><span class="s3">if </span><span class="s1">key_fn </span><span class="s3">is not None else </span><span class="s1">val</span>
                    <span class="s3">for </span><span class="s1">key_fn</span><span class="s4">, </span><span class="s1">val </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">key_fns</span><span class="s4">, </span><span class="s1">state</span><span class="s4">.</span><span class="s1">key</span><span class="s4">[</span><span class="s6">1</span><span class="s4">])</span>
                <span class="s4">)</span>

        <span class="s3">else</span><span class="s4">:</span>

            <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">state</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s1">state</span><span class="s4">.</span><span class="s1">key</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">key</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_identity_key_props</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">] </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_all_pk_cols</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">collection</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">ColumnClause</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">set</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">table </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">:</span>
            <span class="s1">collection</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pks_by_table</span><span class="s4">[</span><span class="s1">table</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">collection</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_should_undefer_in_wildcard</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">cols</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">cols</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">cols</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_primary_key_propkeys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">col</span><span class="s4">].</span><span class="s1">key </span><span class="s3">for </span><span class="s1">col </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_all_pk_cols</span><span class="s4">}</span>

    <span class="s3">def </span><span class="s1">_get_state_attr_by_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">state</span><span class="s4">: </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
        <span class="s1">dict_</span><span class="s4">: </span><span class="s1">_InstanceDict</span><span class="s4">,</span>
        <span class="s1">column</span><span class="s4">: </span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">],</span>
        <span class="s1">passive</span><span class="s4">: </span><span class="s1">PassiveFlag </span><span class="s4">= </span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_RETURN_NO_VALUE</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">[</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">].</span><span class="s1">impl</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">passive</span><span class="s4">=</span><span class="s1">passive</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_committed_state_attr_by_column</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>
        <span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">[</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">].</span><span class="s1">impl</span><span class="s4">.</span><span class="s1">set_committed_value</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_state_attr_by_column</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>
        <span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">[</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">].</span><span class="s1">impl</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_committed_attr_by_column</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">, </span><span class="s1">column</span><span class="s4">):</span>
        <span class="s1">state </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">instance_state</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">)</span>
        <span class="s1">dict_ </span><span class="s4">= </span><span class="s1">attributes</span><span class="s4">.</span><span class="s1">instance_dict</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_committed_state_attr_by_column</span><span class="s4">(</span>
            <span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">passive</span><span class="s4">=</span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_OFF</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_committed_state_attr_by_column</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">column</span><span class="s4">, </span><span class="s1">passive</span><span class="s4">=</span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_RETURN_NO_VALUE</span>
    <span class="s4">):</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">column</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">[</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">].</span><span class="s1">impl</span><span class="s4">.</span><span class="s1">get_committed_value</span><span class="s4">(</span>
            <span class="s1">state</span><span class="s4">, </span><span class="s1">dict_</span><span class="s4">, </span><span class="s1">passive</span><span class="s4">=</span><span class="s1">passive</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_optimized_get_statement</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">attribute_names</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;assemble a WHERE clause which retrieves a given state by primary 
        key, using a minimized set of tables. 
 
        Applies to a joined-table inheritance mapper where the 
        requested attribute names are only present on joined tables, 
        not the base table.  The WHERE clause attempts to include 
        only those tables to minimize joins. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">props </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_props</span>

        <span class="s1">col_attribute_names </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">attribute_names</span><span class="s4">).</span><span class="s1">intersection</span><span class="s4">(</span>
            <span class="s1">state</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">column_attrs</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()</span>
        <span class="s4">)</span>
        <span class="s1">tables</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">FromClause</span><span class="s4">] = </span><span class="s1">set</span><span class="s4">(</span>
            <span class="s1">chain</span><span class="s4">(</span>
                <span class="s4">*[</span>
                    <span class="s1">sql_util</span><span class="s4">.</span><span class="s1">find_tables</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s1">check_columns</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">col_attribute_names</span>
                    <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">].</span><span class="s1">columns</span>
                <span class="s4">]</span>
            <span class="s4">)</span>
        <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">in </span><span class="s1">tables</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">def </span><span class="s1">visit_binary</span><span class="s4">(</span><span class="s1">binary</span><span class="s4">):</span>
            <span class="s1">leftcol </span><span class="s4">= </span><span class="s1">binary</span><span class="s4">.</span><span class="s1">left</span>
            <span class="s1">rightcol </span><span class="s4">= </span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span>
            <span class="s3">if </span><span class="s1">leftcol </span><span class="s3">is None or </span><span class="s1">rightcol </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s3">return</span>

            <span class="s3">if </span><span class="s1">leftcol</span><span class="s4">.</span><span class="s1">table </span><span class="s3">not in </span><span class="s1">tables</span><span class="s4">:</span>
                <span class="s1">leftval </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_committed_state_attr_by_column</span><span class="s4">(</span>
                    <span class="s1">state</span><span class="s4">,</span>
                    <span class="s1">state</span><span class="s4">.</span><span class="s1">dict</span><span class="s4">,</span>
                    <span class="s1">leftcol</span><span class="s4">,</span>
                    <span class="s1">passive</span><span class="s4">=</span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_NO_INITIALIZE</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">leftval </span><span class="s3">in </span><span class="s1">orm_util</span><span class="s4">.</span><span class="s1">_none_set</span><span class="s4">:</span>
                    <span class="s3">raise </span><span class="s1">_OptGetColumnsNotAvailable</span><span class="s4">()</span>
                <span class="s1">binary</span><span class="s4">.</span><span class="s1">left </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">bindparam</span><span class="s4">(</span>
                    <span class="s3">None</span><span class="s4">, </span><span class="s1">leftval</span><span class="s4">, </span><span class="s1">type_</span><span class="s4">=</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">.</span><span class="s1">type</span>
                <span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">rightcol</span><span class="s4">.</span><span class="s1">table </span><span class="s3">not in </span><span class="s1">tables</span><span class="s4">:</span>
                <span class="s1">rightval </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_committed_state_attr_by_column</span><span class="s4">(</span>
                    <span class="s1">state</span><span class="s4">,</span>
                    <span class="s1">state</span><span class="s4">.</span><span class="s1">dict</span><span class="s4">,</span>
                    <span class="s1">rightcol</span><span class="s4">,</span>
                    <span class="s1">passive</span><span class="s4">=</span><span class="s1">PassiveFlag</span><span class="s4">.</span><span class="s1">PASSIVE_NO_INITIALIZE</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">rightval </span><span class="s3">in </span><span class="s1">orm_util</span><span class="s4">.</span><span class="s1">_none_set</span><span class="s4">:</span>
                    <span class="s3">raise </span><span class="s1">_OptGetColumnsNotAvailable</span><span class="s4">()</span>
                <span class="s1">binary</span><span class="s4">.</span><span class="s1">right </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">bindparam</span><span class="s4">(</span>
                    <span class="s3">None</span><span class="s4">, </span><span class="s1">rightval</span><span class="s4">, </span><span class="s1">type_</span><span class="s4">=</span><span class="s1">binary</span><span class="s4">.</span><span class="s1">right</span><span class="s4">.</span><span class="s1">type</span>
                <span class="s4">)</span>

        <span class="s1">allconds</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]] = []</span>

        <span class="s1">start </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s0"># as of #7507, from the lowest base table on upwards,</span>
        <span class="s0"># we include all intermediary tables.</span>

        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">())):</span>
            <span class="s3">if </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">local_table </span><span class="s3">in </span><span class="s1">tables</span><span class="s4">:</span>
                <span class="s1">start </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s3">elif not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">, </span><span class="s1">expression</span><span class="s4">.</span><span class="s1">TableClause</span><span class="s4">):</span>
                <span class="s3">return None</span>
            <span class="s3">if </span><span class="s1">start </span><span class="s3">and not </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">single</span><span class="s4">:</span>
                <span class="s3">assert </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherits</span>
                <span class="s3">assert not </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">concrete</span>
                <span class="s3">assert </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s3">is not None</span>
                <span class="s1">allconds</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherit_condition</span><span class="s4">)</span>
                <span class="s1">tables</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">local_table</span><span class="s4">)</span>

        <span class="s0"># only the bottom table needs its criteria to be altered to fit</span>
        <span class="s0"># the primary key ident - the rest of the tables upwards to the</span>
        <span class="s0"># descendant-most class should all be present and joined to each</span>
        <span class="s0"># other.</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">_traversed </span><span class="s4">= </span><span class="s1">visitors</span><span class="s4">.</span><span class="s1">cloned_traverse</span><span class="s4">(</span>
                <span class="s1">allconds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], {}, {</span><span class="s5">&quot;binary&quot;</span><span class="s4">: </span><span class="s1">visit_binary</span><span class="s4">}</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s1">_OptGetColumnsNotAvailable</span><span class="s4">:</span>
            <span class="s3">return None</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">allconds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">_traversed</span>

        <span class="s1">cond </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">and_</span><span class="s4">(*</span><span class="s1">allconds</span><span class="s4">)</span>

        <span class="s1">cols </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">col_attribute_names</span><span class="s4">:</span>
            <span class="s1">cols</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">props</span><span class="s4">[</span><span class="s1">key</span><span class="s4">].</span><span class="s1">columns</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">sql</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(*</span><span class="s1">cols</span><span class="s4">)</span>
            <span class="s4">.</span><span class="s1">where</span><span class="s4">(</span><span class="s1">cond</span><span class="s4">)</span>
            <span class="s4">.</span><span class="s1">set_label_style</span><span class="s4">(</span><span class="s1">LABEL_STYLE_TABLENAME_PLUS_COL</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_iterate_to_target_viawpoly</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">):</span>
            <span class="s1">prev </span><span class="s4">= </span><span class="s1">self</span>
            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                <span class="s3">yield </span><span class="s1">m</span>

                <span class="s3">if </span><span class="s1">m </span><span class="s3">is not </span><span class="s1">prev </span><span class="s3">and </span><span class="s1">prev </span><span class="s3">not in </span><span class="s1">m</span><span class="s4">.</span><span class="s1">_with_polymorphic_mappers</span><span class="s4">:</span>
                    <span class="s3">break</span>

                <span class="s1">prev </span><span class="s4">= </span><span class="s1">m</span>
                <span class="s3">if </span><span class="s1">m </span><span class="s3">is </span><span class="s1">mapper</span><span class="s4">:</span>
                    <span class="s3">break</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_would_selectinload_combinations_cache</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">{}</span>

    <span class="s3">def </span><span class="s1">_would_selectin_load_only_from_given_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">super_mapper</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;return True if this mapper would &quot;selectin&quot; polymorphic load based 
        on the given super mapper, and not from a setting from a subclass. 
 
        given:: 
 
            class A: 
                ... 
 
            class B(A): 
                __mapper_args__ = {&quot;polymorphic_load&quot;: &quot;selectin&quot;} 
 
            class C(B): 
                ... 
 
            class D(B): 
                __mapper_args__ = {&quot;polymorphic_load&quot;: &quot;selectin&quot;} 
 
        ``inspect(C)._would_selectin_load_only_from_given_mapper(inspect(B))`` 
        returns True, because C does selectin loading because of B's setting. 
 
        OTOH, ``inspect(D) 
        ._would_selectin_load_only_from_given_mapper(inspect(B))`` 
        returns False, because D does selectin loading because of its own 
        setting; when we are doing a selectin poly load from B, we want to 
        filter out D because it would already have its own selectin poly load 
        set up separately. 
 
        Added as part of #9373. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">cache </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_would_selectinload_combinations_cache</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">cache</span><span class="s4">[</span><span class="s1">super_mapper</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">pass</span>

        <span class="s0"># assert that given object is a supermapper, meaning we already</span>
        <span class="s0"># strong reference it directly or indirectly.  this allows us</span>
        <span class="s0"># to not worry that we are creating new strongrefs to unrelated</span>
        <span class="s0"># mappers or other objects.</span>
        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">super_mapper</span><span class="s4">)</span>

        <span class="s1">mapper </span><span class="s4">= </span><span class="s1">super_mapper</span>
        <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_iterate_to_target_viawpoly</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;selectin&quot;</span><span class="s4">:</span>
                <span class="s1">retval </span><span class="s4">= </span><span class="s1">m </span><span class="s3">is </span><span class="s1">super_mapper</span>
                <span class="s3">break</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">retval </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s1">cache</span><span class="s4">[</span><span class="s1">super_mapper</span><span class="s4">] = </span><span class="s1">retval</span>
        <span class="s3">return </span><span class="s1">retval</span>

    <span class="s3">def </span><span class="s1">_should_selectin_load</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">enabled_via_opt</span><span class="s4">, </span><span class="s1">polymorphic_from</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">enabled_via_opt</span><span class="s4">:</span>
            <span class="s0"># common case, takes place for all polymorphic loads</span>
            <span class="s1">mapper </span><span class="s4">= </span><span class="s1">polymorphic_from</span>
            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_iterate_to_target_viawpoly</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;selectin&quot;</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">m</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># uncommon case, selectin load options were used</span>
            <span class="s1">enabled_via_opt </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">enabled_via_opt</span><span class="s4">)</span>
            <span class="s1">enabled_via_opt_mappers </span><span class="s4">= {</span><span class="s1">e</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">: </span><span class="s1">e </span><span class="s3">for </span><span class="s1">e </span><span class="s3">in </span><span class="s1">enabled_via_opt</span><span class="s4">}</span>
            <span class="s3">for </span><span class="s1">entity </span><span class="s3">in </span><span class="s1">enabled_via_opt</span><span class="s4">.</span><span class="s1">union</span><span class="s4">([</span><span class="s1">polymorphic_from</span><span class="s4">]):</span>
                <span class="s1">mapper </span><span class="s4">= </span><span class="s1">entity</span><span class="s4">.</span><span class="s1">mapper</span>
                <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_iterate_to_target_viawpoly</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">):</span>
                    <span class="s3">if </span><span class="s4">(</span>
                        <span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;selectin&quot;</span>
                        <span class="s3">or </span><span class="s1">m </span><span class="s3">in </span><span class="s1">enabled_via_opt_mappers</span>
                    <span class="s4">):</span>
                        <span class="s3">return </span><span class="s1">enabled_via_opt_mappers</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">m</span><span class="s4">)</span>

        <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.strategy_options&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_subclass_load_via_in</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">entity</span><span class="s4">, </span><span class="s1">polymorphic_from</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Assemble a that can load the columns local to 
        this subclass as a SELECT with IN. 
 
        &quot;&quot;&quot;</span>

        <span class="s1">strategy_options </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_strategy_options</span>

        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">polymorphic_prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_columntoproperty</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">polymorphic_on</span><span class="s4">]</span>
            <span class="s1">keep_props </span><span class="s4">= </span><span class="s1">set</span><span class="s4">([</span><span class="s1">polymorphic_prop</span><span class="s4">] + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_props</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">keep_props </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_identity_key_props</span><span class="s4">)</span>

        <span class="s1">disable_opt </span><span class="s4">= </span><span class="s1">strategy_options</span><span class="s4">.</span><span class="s1">Load</span><span class="s4">(</span><span class="s1">entity</span><span class="s4">)</span>
        <span class="s1">enable_opt </span><span class="s4">= </span><span class="s1">strategy_options</span><span class="s4">.</span><span class="s1">Load</span><span class="s4">(</span><span class="s1">entity</span><span class="s4">)</span>

        <span class="s1">classes_to_include </span><span class="s4">= {</span><span class="s1">self</span><span class="s4">}</span>
        <span class="s1">m</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">inherits</span>
        <span class="s3">while </span><span class="s4">(</span>
            <span class="s1">m </span><span class="s3">is not None</span>
            <span class="s3">and </span><span class="s1">m </span><span class="s3">is not </span><span class="s1">polymorphic_from</span>
            <span class="s3">and </span><span class="s1">m</span><span class="s4">.</span><span class="s1">polymorphic_load </span><span class="s4">== </span><span class="s5">&quot;selectin&quot;</span>
        <span class="s4">):</span>
            <span class="s1">classes_to_include</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>
            <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">inherits</span>

        <span class="s3">for </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_attrs </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">relationships</span><span class="s4">:</span>
            <span class="s0"># skip prop keys that are not instrumented on the mapped class.</span>
            <span class="s0"># this is primarily the &quot;_sa_polymorphic_on&quot; property that gets</span>
            <span class="s0"># created for an ad-hoc polymorphic_on SQL expression, issue #8704</span>
            <span class="s3">if </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">class_manager</span><span class="s4">:</span>
                <span class="s3">continue</span>

            <span class="s3">if </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">in </span><span class="s1">classes_to_include </span><span class="s3">or </span><span class="s1">prop </span><span class="s3">in </span><span class="s1">keep_props</span><span class="s4">:</span>
                <span class="s0"># &quot;enable&quot; options, to turn on the properties that we want to</span>
                <span class="s0"># load by default (subject to options from the query)</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">, </span><span class="s1">StrategizedProperty</span><span class="s4">):</span>
                    <span class="s3">continue</span>

                <span class="s1">enable_opt </span><span class="s4">= </span><span class="s1">enable_opt</span><span class="s4">.</span><span class="s1">_set_generic_strategy</span><span class="s4">(</span>
                    <span class="s0"># convert string name to an attribute before passing</span>
                    <span class="s0"># to loader strategy.   note this must be in terms</span>
                    <span class="s0"># of given entity, such as AliasedClass, etc.</span>
                    <span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">entity</span><span class="s4">.</span><span class="s1">entity_namespace</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">),),</span>
                    <span class="s1">dict</span><span class="s4">(</span><span class="s1">prop</span><span class="s4">.</span><span class="s1">strategy_key</span><span class="s4">),</span>
                    <span class="s1">_reconcile_to_other</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># &quot;disable&quot; options, to turn off the properties from the</span>
                <span class="s0"># superclass that we *don't* want to load, applied after</span>
                <span class="s0"># the options from the query to override them</span>
                <span class="s1">disable_opt </span><span class="s4">= </span><span class="s1">disable_opt</span><span class="s4">.</span><span class="s1">_set_generic_strategy</span><span class="s4">(</span>
                    <span class="s0"># convert string name to an attribute before passing</span>
                    <span class="s0"># to loader strategy.   note this must be in terms</span>
                    <span class="s0"># of given entity, such as AliasedClass, etc.</span>
                    <span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">entity</span><span class="s4">.</span><span class="s1">entity_namespace</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">key</span><span class="s4">),),</span>
                    <span class="s4">{</span><span class="s5">&quot;do_nothing&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">},</span>
                    <span class="s1">_reconcile_to_other</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
                <span class="s4">)</span>

        <span class="s1">primary_key </span><span class="s4">= [</span>
            <span class="s1">sql_util</span><span class="s4">.</span><span class="s1">_deep_annotate</span><span class="s4">(</span><span class="s1">pk</span><span class="s4">, {</span><span class="s5">&quot;_orm_adapt&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">})</span>
            <span class="s3">for </span><span class="s1">pk </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">primary_key</span>
        <span class="s4">]</span>

        <span class="s1">in_expr</span><span class="s4">: </span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">primary_key</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">in_expr </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">tuple_</span><span class="s4">(*</span><span class="s1">primary_key</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">in_expr </span><span class="s4">= </span><span class="s1">primary_key</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">entity</span><span class="s4">.</span><span class="s1">is_aliased_class</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">entity</span><span class="s4">.</span><span class="s1">mapper </span><span class="s3">is </span><span class="s1">self</span>

            <span class="s1">q </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(</span><span class="s1">entity</span><span class="s4">).</span><span class="s1">set_label_style</span><span class="s4">(</span>
                <span class="s1">LABEL_STYLE_TABLENAME_PLUS_COL</span>
            <span class="s4">)</span>

            <span class="s1">in_expr </span><span class="s4">= </span><span class="s1">entity</span><span class="s4">.</span><span class="s1">_adapter</span><span class="s4">.</span><span class="s1">traverse</span><span class="s4">(</span><span class="s1">in_expr</span><span class="s4">)</span>
            <span class="s1">primary_key </span><span class="s4">= [</span><span class="s1">entity</span><span class="s4">.</span><span class="s1">_adapter</span><span class="s4">.</span><span class="s1">traverse</span><span class="s4">(</span><span class="s1">k</span><span class="s4">) </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">primary_key</span><span class="s4">]</span>
            <span class="s1">q </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">where</span><span class="s4">(</span>
                <span class="s1">in_expr</span><span class="s4">.</span><span class="s1">in_</span><span class="s4">(</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">bindparam</span><span class="s4">(</span><span class="s5">&quot;primary_keys&quot;</span><span class="s4">, </span><span class="s1">expanding</span><span class="s4">=</span><span class="s3">True</span><span class="s4">))</span>
            <span class="s4">).</span><span class="s1">order_by</span><span class="s4">(*</span><span class="s1">primary_key</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">q </span><span class="s4">= </span><span class="s1">sql</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(</span><span class="s1">self</span><span class="s4">).</span><span class="s1">set_label_style</span><span class="s4">(</span>
                <span class="s1">LABEL_STYLE_TABLENAME_PLUS_COL</span>
            <span class="s4">)</span>
            <span class="s1">q </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">where</span><span class="s4">(</span>
                <span class="s1">in_expr</span><span class="s4">.</span><span class="s1">in_</span><span class="s4">(</span><span class="s1">sql</span><span class="s4">.</span><span class="s1">bindparam</span><span class="s4">(</span><span class="s5">&quot;primary_keys&quot;</span><span class="s4">, </span><span class="s1">expanding</span><span class="s4">=</span><span class="s3">True</span><span class="s4">))</span>
            <span class="s4">).</span><span class="s1">order_by</span><span class="s4">(*</span><span class="s1">primary_key</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">q</span><span class="s4">, </span><span class="s1">enable_opt</span><span class="s4">, </span><span class="s1">disable_opt</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_subclass_load_via_in_mapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># the default is loading this mapper against the basemost mapper</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_subclass_load_via_in</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">cascade_iterator</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">type_</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">state</span><span class="s4">: </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">_O</span><span class="s4">],</span>
        <span class="s1">halt_on</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]], </span><span class="s1">bool</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span>
        <span class="s1">Tuple</span><span class="s4">[</span><span class="s1">object</span><span class="s4">, </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">_InstanceDict</span><span class="s4">]</span>
    <span class="s4">]:</span>
        <span class="s2">r&quot;&quot;&quot;Iterate each element and its mapper in an object graph, 
        for all relationships that meet the given cascade rule. 
 
        :param type\_: 
          The name of the cascade rule (i.e. ``&quot;save-update&quot;``, ``&quot;delete&quot;``, 
          etc.). 
 
          .. note::  the ``&quot;all&quot;`` cascade is not accepted here.  For a generic 
             object traversal function, see :ref:`faq_walk_objects`. 
 
        :param state: 
          The lead InstanceState.  child items will be processed per 
          the relationships defined for this object's mapper. 
 
        :return: the method yields individual object instances. 
 
        .. seealso:: 
 
            :ref:`unitofwork_cascades` 
 
            :ref:`faq_walk_objects` - illustrates a generic function to 
            traverse all objects without relying on cascades. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">visited_states</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s1">set</span><span class="s4">()</span>
        <span class="s1">prp</span><span class="s4">, </span><span class="s1">mpp </span><span class="s4">= </span><span class="s1">object</span><span class="s4">(), </span><span class="s1">object</span><span class="s4">()</span>

        <span class="s3">assert </span><span class="s1">state</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">isa</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

        <span class="s0"># this is actually a recursive structure, fully typing it seems</span>
        <span class="s0"># a little too difficult for what it's worth here</span>
        <span class="s1">visitables</span><span class="s4">: </span><span class="s1">Deque</span><span class="s4">[</span>
            <span class="s1">Tuple</span><span class="s4">[</span>
                <span class="s1">Deque</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">],</span>
                <span class="s1">object</span><span class="s4">,</span>
                <span class="s1">Optional</span><span class="s4">[</span><span class="s1">InstanceState</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]],</span>
                <span class="s1">Optional</span><span class="s4">[</span><span class="s1">_InstanceDict</span><span class="s4">],</span>
            <span class="s4">]</span>
        <span class="s4">]</span>

        <span class="s1">visitables </span><span class="s4">= </span><span class="s1">deque</span><span class="s4">(</span>
            <span class="s4">[(</span><span class="s1">deque</span><span class="s4">(</span><span class="s1">state</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()), </span><span class="s1">prp</span><span class="s4">, </span><span class="s1">state</span><span class="s4">, </span><span class="s1">state</span><span class="s4">.</span><span class="s1">dict</span><span class="s4">)]</span>
        <span class="s4">)</span>

        <span class="s3">while </span><span class="s1">visitables</span><span class="s4">:</span>
            <span class="s1">iterator</span><span class="s4">, </span><span class="s1">item_type</span><span class="s4">, </span><span class="s1">parent_state</span><span class="s4">, </span><span class="s1">parent_dict </span><span class="s4">= </span><span class="s1">visitables</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s3">if not </span><span class="s1">iterator</span><span class="s4">:</span>
                <span class="s1">visitables</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">()</span>
                <span class="s3">continue</span>

            <span class="s3">if </span><span class="s1">item_type </span><span class="s3">is </span><span class="s1">prp</span><span class="s4">:</span>
                <span class="s1">prop </span><span class="s4">= </span><span class="s1">iterator</span><span class="s4">.</span><span class="s1">popleft</span><span class="s4">()</span>
                <span class="s3">if not </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">cascade </span><span class="s3">or </span><span class="s1">type_ </span><span class="s3">not in </span><span class="s1">prop</span><span class="s4">.</span><span class="s1">cascade</span><span class="s4">:</span>
                    <span class="s3">continue</span>
                <span class="s3">assert </span><span class="s1">parent_state </span><span class="s3">is not None</span>
                <span class="s3">assert </span><span class="s1">parent_dict </span><span class="s3">is not None</span>
                <span class="s1">queue </span><span class="s4">= </span><span class="s1">deque</span><span class="s4">(</span>
                    <span class="s1">prop</span><span class="s4">.</span><span class="s1">cascade_iterator</span><span class="s4">(</span>
                        <span class="s1">type_</span><span class="s4">,</span>
                        <span class="s1">parent_state</span><span class="s4">,</span>
                        <span class="s1">parent_dict</span><span class="s4">,</span>
                        <span class="s1">visited_states</span><span class="s4">,</span>
                        <span class="s1">halt_on</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">queue</span><span class="s4">:</span>
                    <span class="s1">visitables</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">queue</span><span class="s4">, </span><span class="s1">mpp</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>
            <span class="s3">elif </span><span class="s1">item_type </span><span class="s3">is </span><span class="s1">mpp</span><span class="s4">:</span>
                <span class="s4">(</span>
                    <span class="s1">instance</span><span class="s4">,</span>
                    <span class="s1">instance_mapper</span><span class="s4">,</span>
                    <span class="s1">corresponding_state</span><span class="s4">,</span>
                    <span class="s1">corresponding_dict</span><span class="s4">,</span>
                <span class="s4">) = </span><span class="s1">iterator</span><span class="s4">.</span><span class="s1">popleft</span><span class="s4">()</span>
                <span class="s3">yield </span><span class="s4">(</span>
                    <span class="s1">instance</span><span class="s4">,</span>
                    <span class="s1">instance_mapper</span><span class="s4">,</span>
                    <span class="s1">corresponding_state</span><span class="s4">,</span>
                    <span class="s1">corresponding_dict</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s1">visitables</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                    <span class="s4">(</span>
                        <span class="s1">deque</span><span class="s4">(</span><span class="s1">instance_mapper</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()),</span>
                        <span class="s1">prp</span><span class="s4">,</span>
                        <span class="s1">corresponding_state</span><span class="s4">,</span>
                        <span class="s1">corresponding_dict</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_compiled_cache</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">util</span><span class="s4">.</span><span class="s1">LRUCache</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compiled_cache_size</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_multiple_persistence_tables</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">) &gt; </span><span class="s6">1</span>

    <span class="s4">@</span><span class="s1">HasMemoized</span><span class="s4">.</span><span class="s1">memoized_attribute</span>
    <span class="s3">def </span><span class="s1">_sorted_tables</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">table_to_mapper</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">TableClause</span><span class="s4">, </span><span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = {}</span>

        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">base_mapper</span><span class="s4">.</span><span class="s1">self_and_descendants</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">:</span>
                <span class="s1">table_to_mapper</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">)</span>

        <span class="s1">extra_dependencies </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">table</span><span class="s4">, </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">table_to_mapper</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">super_ </span><span class="s4">= </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">inherits</span>
            <span class="s3">if </span><span class="s1">super_</span><span class="s4">:</span>
                <span class="s1">extra_dependencies</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span>
                    <span class="s4">[(</span><span class="s1">super_table</span><span class="s4">, </span><span class="s1">table</span><span class="s4">) </span><span class="s3">for </span><span class="s1">super_table </span><span class="s3">in </span><span class="s1">super_</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">]</span>
                <span class="s4">)</span>

        <span class="s3">def </span><span class="s1">skip</span><span class="s4">(</span><span class="s1">fk</span><span class="s4">):</span>
            <span class="s0"># attempt to skip dependencies that are not</span>
            <span class="s0"># significant to the inheritance chain</span>
            <span class="s0"># for two tables that are related by inheritance.</span>
            <span class="s0"># while that dependency may be important, it's technically</span>
            <span class="s0"># not what we mean to sort on here.</span>
            <span class="s1">parent </span><span class="s4">= </span><span class="s1">table_to_mapper</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">fk</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">table</span><span class="s4">)</span>
            <span class="s1">dep </span><span class="s4">= </span><span class="s1">table_to_mapper</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">fk</span><span class="s4">.</span><span class="s1">column</span><span class="s4">.</span><span class="s1">table</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">parent </span><span class="s3">is not None</span>
                <span class="s3">and </span><span class="s1">dep </span><span class="s3">is not None</span>
                <span class="s3">and </span><span class="s1">dep </span><span class="s3">is not </span><span class="s1">parent</span>
                <span class="s3">and </span><span class="s1">dep</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s3">is not None</span>
            <span class="s4">):</span>
                <span class="s1">cols </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">_find_columns</span><span class="s4">(</span><span class="s1">dep</span><span class="s4">.</span><span class="s1">inherit_condition</span><span class="s4">))</span>
                <span class="s3">if </span><span class="s1">parent</span><span class="s4">.</span><span class="s1">inherit_condition </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">cols </span><span class="s4">= </span><span class="s1">cols</span><span class="s4">.</span><span class="s1">union</span><span class="s4">(</span>
                        <span class="s1">sql_util</span><span class="s4">.</span><span class="s1">_find_columns</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">inherit_condition</span><span class="s4">)</span>
                    <span class="s4">)</span>
                    <span class="s3">return </span><span class="s1">fk</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">not in </span><span class="s1">cols </span><span class="s3">and </span><span class="s1">fk</span><span class="s4">.</span><span class="s1">column </span><span class="s3">not in </span><span class="s1">cols</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">fk</span><span class="s4">.</span><span class="s1">parent </span><span class="s3">not in </span><span class="s1">cols</span>
            <span class="s3">return False</span>

        <span class="s1">sorted_ </span><span class="s4">= </span><span class="s1">sql_util</span><span class="s4">.</span><span class="s1">sort_tables</span><span class="s4">(</span>
            <span class="s1">table_to_mapper</span><span class="s4">,</span>
            <span class="s1">skip_fn</span><span class="s4">=</span><span class="s1">skip</span><span class="s4">,</span>
            <span class="s1">extra_dependencies</span><span class="s4">=</span><span class="s1">extra_dependencies</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s1">ret </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">OrderedDict</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">sorted_</span><span class="s4">:</span>
            <span class="s1">ret</span><span class="s4">[</span><span class="s1">t</span><span class="s4">] = </span><span class="s1">table_to_mapper</span><span class="s4">[</span><span class="s1">t</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">ret</span>

    <span class="s3">def </span><span class="s1">_memo</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">callable_</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[], </span><span class="s1">_T</span><span class="s4">]) </span><span class="s1">-&gt; _T</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_memoized_values</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s1">_T</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_memoized_values</span><span class="s4">[</span><span class="s1">key</span><span class="s4">])</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_memoized_values</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">value </span><span class="s4">= </span><span class="s1">callable_</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">memoized_property</span>
    <span class="s3">def </span><span class="s1">_table_to_equated</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;memoized map of tables to collections of columns to be 
        synchronized upwards to the base mapper.&quot;&quot;&quot;</span>

        <span class="s1">result</span><span class="s4">: </span><span class="s1">util</span><span class="s4">.</span><span class="s1">defaultdict</span><span class="s4">[</span>
            <span class="s1">Table</span><span class="s4">,</span>
            <span class="s1">List</span><span class="s4">[</span>
                <span class="s1">Tuple</span><span class="s4">[</span>
                    <span class="s1">Mapper</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">],</span>
                    <span class="s1">List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">ColumnElement</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]]],</span>
                <span class="s4">]</span>
            <span class="s4">],</span>
        <span class="s4">] = </span><span class="s1">util</span><span class="s4">.</span><span class="s1">defaultdict</span><span class="s4">(</span><span class="s1">list</span><span class="s4">)</span>

        <span class="s3">def </span><span class="s1">set_union</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">x</span><span class="s4">.</span><span class="s1">union</span><span class="s4">(</span><span class="s1">y</span><span class="s4">)</span>

        <span class="s3">for </span><span class="s1">table </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_sorted_tables</span><span class="s4">:</span>
            <span class="s1">cols </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">table</span><span class="s4">.</span><span class="s1">c</span><span class="s4">)</span>

            <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterate_to_root</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs </span><span class="s3">and </span><span class="s1">cols</span><span class="s4">.</span><span class="s1">intersection</span><span class="s4">(</span>
                    <span class="s1">reduce</span><span class="s4">(</span>
                        <span class="s1">set_union</span><span class="s4">,</span>
                        <span class="s4">[</span><span class="s1">l</span><span class="s4">.</span><span class="s1">proxy_set </span><span class="s3">for </span><span class="s1">l</span><span class="s4">, </span><span class="s1">r </span><span class="s3">in </span><span class="s1">m</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs</span><span class="s4">],</span>
                    <span class="s4">)</span>
                <span class="s4">):</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">table</span><span class="s4">].</span><span class="s1">append</span><span class="s4">((</span><span class="s1">m</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">_inherits_equated_pairs</span><span class="s4">))</span>

        <span class="s3">return </span><span class="s1">result</span>


<span class="s3">class </span><span class="s1">_OptGetColumnsNotAvailable</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">def </span><span class="s1">configure_mappers</span><span class="s4">() </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Initialize the inter-mapper relationships of all mappers that 
    have been constructed thus far across all :class:`_orm.registry` 
    collections. 
 
    The configure step is used to reconcile and initialize the 
    :func:`_orm.relationship` linkages between mapped classes, as well as to 
    invoke configuration events such as the 
    :meth:`_orm.MapperEvents.before_configured` and 
    :meth:`_orm.MapperEvents.after_configured`, which may be used by ORM 
    extensions or user-defined extension hooks. 
 
    Mapper configuration is normally invoked automatically, the first time 
    mappings from a particular :class:`_orm.registry` are used, as well as 
    whenever mappings are used and additional not-yet-configured mappers have 
    been constructed. The automatic configuration process however is local only 
    to the :class:`_orm.registry` involving the target mapper and any related 
    :class:`_orm.registry` objects which it may depend on; this is 
    equivalent to invoking the :meth:`_orm.registry.configure` method 
    on a particular :class:`_orm.registry`. 
 
    By contrast, the :func:`_orm.configure_mappers` function will invoke the 
    configuration process on all :class:`_orm.registry` objects that 
    exist in memory, and may be useful for scenarios where many individual 
    :class:`_orm.registry` objects that are nonetheless interrelated are 
    in use. 
 
    .. versionchanged:: 1.4 
 
        As of SQLAlchemy 1.4.0b2, this function works on a 
        per-:class:`_orm.registry` basis, locating all :class:`_orm.registry` 
        objects present and invoking the :meth:`_orm.registry.configure` method 
        on each. The :meth:`_orm.registry.configure` method may be preferred to 
        limit the configuration of mappers to those local to a particular 
        :class:`_orm.registry` and/or declarative base class. 
 
    Points at which automatic configuration is invoked include when a mapped 
    class is instantiated into an instance, as well as when ORM queries 
    are emitted using :meth:`.Session.query` or :meth:`_orm.Session.execute` 
    with an ORM-enabled statement. 
 
    The mapper configure process, whether invoked by 
    :func:`_orm.configure_mappers` or from :meth:`_orm.registry.configure`, 
    provides several event hooks that can be used to augment the mapper 
    configuration step. These hooks include: 
 
    * :meth:`.MapperEvents.before_configured` - called once before 
      :func:`.configure_mappers` or :meth:`_orm.registry.configure` does any 
      work; this can be used to establish additional options, properties, or 
      related mappings before the operation proceeds. 
 
    * :meth:`.MapperEvents.mapper_configured` - called as each individual 
      :class:`_orm.Mapper` is configured within the process; will include all 
      mapper state except for backrefs set up by other mappers that are still 
      to be configured. 
 
    * :meth:`.MapperEvents.after_configured` - called once after 
      :func:`.configure_mappers` or :meth:`_orm.registry.configure` is 
      complete; at this stage, all :class:`_orm.Mapper` objects that fall 
      within the scope of the configuration operation will be fully configured. 
      Note that the calling application may still have other mappings that 
      haven't been produced yet, such as if they are in modules as yet 
      unimported, and may also have mappings that are still to be configured, 
      if they are in other :class:`_orm.registry` collections not part of the 
      current scope of configuration. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">_configure_registries</span><span class="s4">(</span><span class="s1">_all_registries</span><span class="s4">(), </span><span class="s1">cascade</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_configure_registries</span><span class="s4">(</span>
    <span class="s1">registries</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">_RegistryType</span><span class="s4">], </span><span class="s1">cascade</span><span class="s4">: </span><span class="s1">bool</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s3">for </span><span class="s1">reg </span><span class="s3">in </span><span class="s1">registries</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_new_mappers</span><span class="s4">:</span>
            <span class="s3">break</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return</span>

    <span class="s3">with </span><span class="s1">_CONFIGURE_MUTEX</span><span class="s4">:</span>
        <span class="s3">global </span><span class="s1">_already_compiling</span>
        <span class="s3">if </span><span class="s1">_already_compiling</span><span class="s4">:</span>
            <span class="s3">return</span>
        <span class="s1">_already_compiling </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s0"># double-check inside mutex</span>
            <span class="s3">for </span><span class="s1">reg </span><span class="s3">in </span><span class="s1">registries</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_new_mappers</span><span class="s4">:</span>
                    <span class="s3">break</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return</span>

            <span class="s1">Mapper</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">_for_class</span><span class="s4">(</span><span class="s1">Mapper</span><span class="s4">).</span><span class="s1">before_configured</span><span class="s4">()  </span><span class="s0"># type: ignore # noqa: E501</span>
            <span class="s0"># initialize properties on all mappers</span>
            <span class="s0"># note that _mapper_registry is unordered, which</span>
            <span class="s0"># may randomly conceal/reveal issues related to</span>
            <span class="s0"># the order of mapper compilation</span>

            <span class="s1">_do_configure_registries</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">, </span><span class="s1">cascade</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">_already_compiling </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">Mapper</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">_for_class</span><span class="s4">(</span><span class="s1">Mapper</span><span class="s4">).</span><span class="s1">after_configured</span><span class="s4">()  </span><span class="s0"># type: ignore</span>


<span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">_do_configure_registries</span><span class="s4">(</span>
    <span class="s1">registries</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">_RegistryType</span><span class="s4">], </span><span class="s1">cascade</span><span class="s4">: </span><span class="s1">bool</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s1">registry </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_decl_api</span><span class="s4">.</span><span class="s1">registry</span>

    <span class="s1">orig </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">reg </span><span class="s3">in </span><span class="s1">registry</span><span class="s4">.</span><span class="s1">_recurse_with_dependencies</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">):</span>
        <span class="s1">has_skip </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s3">for </span><span class="s1">mapper </span><span class="s3">in </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_mappers_to_configure</span><span class="s4">():</span>
            <span class="s1">run_configure </span><span class="s4">= </span><span class="s3">None</span>

            <span class="s3">for </span><span class="s1">fn </span><span class="s3">in </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">before_mapper_configured</span><span class="s4">:</span>
                <span class="s1">run_configure </span><span class="s4">= </span><span class="s1">fn</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">run_configure </span><span class="s3">is </span><span class="s1">EXT_SKIP</span><span class="s4">:</span>
                    <span class="s1">has_skip </span><span class="s4">= </span><span class="s3">True</span>
                    <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">run_configure </span><span class="s3">is </span><span class="s1">EXT_SKIP</span><span class="s4">:</span>
                <span class="s3">continue</span>

            <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">, </span><span class="s5">&quot;_configure_failed&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
                <span class="s1">e </span><span class="s4">= </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                    <span class="s5">&quot;One or more mappers failed to initialize - &quot;</span>
                    <span class="s5">&quot;can't proceed with initialization of other &quot;</span>
                    <span class="s5">&quot;mappers. Triggering mapper: '%s'. &quot;</span>
                    <span class="s5">&quot;Original exception was: %s&quot;</span>
                    <span class="s4">% (</span><span class="s1">mapper</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_configure_failed</span><span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s1">e</span><span class="s4">.</span><span class="s1">_configure_failed </span><span class="s4">= </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_configure_failed  </span><span class="s0"># type: ignore</span>
                <span class="s3">raise </span><span class="s1">e</span>

            <span class="s3">if not </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">configured</span><span class="s4">:</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_post_configure_properties</span><span class="s4">()</span>
                    <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_expire_memoizations</span><span class="s4">()</span>
                    <span class="s1">mapper</span><span class="s4">.</span><span class="s1">dispatch</span><span class="s4">.</span><span class="s1">mapper_configured</span><span class="s4">(</span><span class="s1">mapper</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">class_</span><span class="s4">)</span>
                <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                    <span class="s1">exc </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">exc_info</span><span class="s4">()[</span><span class="s6">1</span><span class="s4">]</span>
                    <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">exc</span><span class="s4">, </span><span class="s5">&quot;_configure_failed&quot;</span><span class="s4">):</span>
                        <span class="s1">mapper</span><span class="s4">.</span><span class="s1">_configure_failed </span><span class="s4">= </span><span class="s1">exc</span>
                    <span class="s3">raise</span>
        <span class="s3">if not </span><span class="s1">has_skip</span><span class="s4">:</span>
            <span class="s1">reg</span><span class="s4">.</span><span class="s1">_new_mappers </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s3">if not </span><span class="s1">cascade </span><span class="s3">and </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_dependencies</span><span class="s4">.</span><span class="s1">difference</span><span class="s4">(</span><span class="s1">orig</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                <span class="s5">&quot;configure was called with cascade=False but &quot;</span>
                <span class="s5">&quot;additional registries remain&quot;</span>
            <span class="s4">)</span>


<span class="s4">@</span><span class="s1">util</span><span class="s4">.</span><span class="s1">preload_module</span><span class="s4">(</span><span class="s5">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">_dispose_registries</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">_RegistryType</span><span class="s4">], </span><span class="s1">cascade</span><span class="s4">: </span><span class="s1">bool</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s1">registry </span><span class="s4">= </span><span class="s1">util</span><span class="s4">.</span><span class="s1">preloaded</span><span class="s4">.</span><span class="s1">orm_decl_api</span><span class="s4">.</span><span class="s1">registry</span>

    <span class="s1">orig </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">reg </span><span class="s3">in </span><span class="s1">registry</span><span class="s4">.</span><span class="s1">_recurse_with_dependents</span><span class="s4">(</span><span class="s1">registries</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">cascade </span><span class="s3">and </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_dependents</span><span class="s4">.</span><span class="s1">difference</span><span class="s4">(</span><span class="s1">orig</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">sa_exc</span><span class="s4">.</span><span class="s1">InvalidRequestError</span><span class="s4">(</span>
                <span class="s5">&quot;Registry has dependent registries that are not disposed; &quot;</span>
                <span class="s5">&quot;pass cascade=True to clear these also&quot;</span>
            <span class="s4">)</span>

        <span class="s3">while </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_managers</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">manager</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_managers</span><span class="s4">.</span><span class="s1">popitem</span><span class="s4">()</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s0"># guard against race between while and popitem</span>
                <span class="s3">pass</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">reg</span><span class="s4">.</span><span class="s1">_dispose_manager_and_mapper</span><span class="s4">(</span><span class="s1">manager</span><span class="s4">)</span>

        <span class="s1">reg</span><span class="s4">.</span><span class="s1">_non_primary_mappers</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>
        <span class="s1">reg</span><span class="s4">.</span><span class="s1">_dependents</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">dep </span><span class="s3">in </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">_dependencies</span><span class="s4">:</span>
            <span class="s1">dep</span><span class="s4">.</span><span class="s1">_dependents</span><span class="s4">.</span><span class="s1">discard</span><span class="s4">(</span><span class="s1">reg</span><span class="s4">)</span>
        <span class="s1">reg</span><span class="s4">.</span><span class="s1">_dependencies</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>
        <span class="s0"># this wasn't done in the 1.3 clear_mappers() and in fact it</span>
        <span class="s0"># was a bug, as it could cause configure_mappers() to invoke</span>
        <span class="s0"># the &quot;before_configured&quot; event even though mappers had all been</span>
        <span class="s0"># disposed.</span>
        <span class="s1">reg</span><span class="s4">.</span><span class="s1">_new_mappers </span><span class="s4">= </span><span class="s3">False</span>


<span class="s3">def </span><span class="s1">reconstructor</span><span class="s4">(</span><span class="s1">fn</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Decorate a method as the 'reconstructor' hook. 
 
    Designates a single method as the &quot;reconstructor&quot;, an ``__init__``-like 
    method that will be called by the ORM after the instance has been 
    loaded from the database or otherwise reconstituted. 
 
    .. tip:: 
 
        The :func:`_orm.reconstructor` decorator makes use of the 
        :meth:`_orm.InstanceEvents.load` event hook, which can be 
        used directly. 
 
    The reconstructor will be invoked with no arguments.  Scalar 
    (non-collection) database-mapped attributes of the instance will 
    be available for use within the function.  Eagerly-loaded 
    collections are generally not yet available and will usually only 
    contain the first element.  ORM state changes made to objects at 
    this stage will not be recorded for the next flush() operation, so 
    the activity within a reconstructor should be conservative. 
 
    .. seealso:: 
 
        :meth:`.InstanceEvents.load` 
 
    &quot;&quot;&quot;</span>
    <span class="s1">fn</span><span class="s4">.</span><span class="s1">__sa_reconstructor__ </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s3">return </span><span class="s1">fn</span>


<span class="s3">def </span><span class="s1">validates</span><span class="s4">(</span>
    <span class="s4">*</span><span class="s1">names</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">include_removes</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">, </span><span class="s1">include_backrefs</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span>
<span class="s4">) </span><span class="s1">-&gt; Callable</span><span class="s4">[[</span><span class="s1">_Fn</span><span class="s4">], </span><span class="s1">_Fn</span><span class="s4">]:</span>
    <span class="s2">r&quot;&quot;&quot;Decorate a method as a 'validator' for one or more named properties. 
 
    Designates a method as a validator, a method which receives the 
    name of the attribute as well as a value to be assigned, or in the 
    case of a collection, the value to be added to the collection. 
    The function can then raise validation exceptions to halt the 
    process from continuing (where Python's built-in ``ValueError`` 
    and ``AssertionError`` exceptions are reasonable choices), or can 
    modify or replace the value before proceeding. The function should 
    otherwise return the given value. 
 
    Note that a validator for a collection **cannot** issue a load of that 
    collection within the validation routine - this usage raises 
    an assertion to avoid recursion overflows.  This is a reentrant 
    condition which is not supported. 
 
    :param \*names: list of attribute names to be validated. 
    :param include_removes: if True, &quot;remove&quot; events will be 
     sent as well - the validation function must accept an additional 
     argument &quot;is_remove&quot; which will be a boolean. 
 
    :param include_backrefs: defaults to ``True``; if ``False``, the 
     validation function will not emit if the originator is an attribute 
     event related via a backref.  This can be used for bi-directional 
     :func:`.validates` usage where only one validator should emit per 
     attribute operation. 
 
     .. versionchanged:: 2.0.16 This paramter inadvertently defaulted to 
        ``False`` for releases 2.0.0 through 2.0.15.  Its correct default 
        of ``True`` is restored in 2.0.16. 
 
    .. seealso:: 
 
      :ref:`simple_validators` - usage examples for :func:`.validates` 
 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">fn</span><span class="s4">: </span><span class="s1">_Fn</span><span class="s4">) </span><span class="s1">-&gt; _Fn</span><span class="s4">:</span>
        <span class="s1">fn</span><span class="s4">.</span><span class="s1">__sa_validators__ </span><span class="s4">= </span><span class="s1">names  </span><span class="s0"># type: ignore[attr-defined]</span>
        <span class="s1">fn</span><span class="s4">.</span><span class="s1">__sa_validation_opts__ </span><span class="s4">= {  </span><span class="s0"># type: ignore[attr-defined]</span>
            <span class="s5">&quot;include_removes&quot;</span><span class="s4">: </span><span class="s1">include_removes</span><span class="s4">,</span>
            <span class="s5">&quot;include_backrefs&quot;</span><span class="s4">: </span><span class="s1">include_backrefs</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s3">return </span><span class="s1">fn</span>

    <span class="s3">return </span><span class="s1">wrap</span>


<span class="s3">def </span><span class="s1">_event_on_load</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">ctx</span><span class="s4">):</span>
    <span class="s1">instrumenting_mapper </span><span class="s4">= </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span>

    <span class="s3">if </span><span class="s1">instrumenting_mapper</span><span class="s4">.</span><span class="s1">_reconstructor</span><span class="s4">:</span>
        <span class="s1">instrumenting_mapper</span><span class="s4">.</span><span class="s1">_reconstructor</span><span class="s4">(</span><span class="s1">state</span><span class="s4">.</span><span class="s1">obj</span><span class="s4">())</span>


<span class="s3">def </span><span class="s1">_event_on_init</span><span class="s4">(</span><span class="s1">state</span><span class="s4">, </span><span class="s1">args</span><span class="s4">, </span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Run init_instance hooks. 
 
    This also includes mapper compilation, normally not needed 
    here but helps with some piecemeal configuration 
    scenarios (such as in the ORM tutorial). 
 
    &quot;&quot;&quot;</span>

    <span class="s1">instrumenting_mapper </span><span class="s4">= </span><span class="s1">state</span><span class="s4">.</span><span class="s1">manager</span><span class="s4">.</span><span class="s1">mapper</span>
    <span class="s3">if </span><span class="s1">instrumenting_mapper</span><span class="s4">:</span>
        <span class="s1">instrumenting_mapper</span><span class="s4">.</span><span class="s1">_check_configure</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">instrumenting_mapper</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity</span><span class="s4">:</span>
            <span class="s1">instrumenting_mapper</span><span class="s4">.</span><span class="s1">_set_polymorphic_identity</span><span class="s4">(</span><span class="s1">state</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">_ColumnMapping</span><span class="s4">(</span><span class="s1">Dict</span><span class="s4">[</span><span class="s5">&quot;ColumnElement[Any]&quot;</span><span class="s4">, </span><span class="s5">&quot;MapperProperty[Any]&quot;</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Error reporting helper for mapper._columntoproperty.&quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= (</span><span class="s5">&quot;mapper&quot;</span><span class="s4">,)</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mapper</span><span class="s4">):</span>
        <span class="s0"># TODO: weakref would be a good idea here</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mapper </span><span class="s4">= </span><span class="s1">mapper</span>

    <span class="s3">def </span><span class="s1">__missing__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">column</span><span class="s4">):</span>
        <span class="s1">prop </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">.</span><span class="s1">_props</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">column</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">prop</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">orm_exc</span><span class="s4">.</span><span class="s1">UnmappedColumnError</span><span class="s4">(</span>
                <span class="s5">&quot;Column '%s.%s' is not available, due to &quot;</span>
                <span class="s5">&quot;conflicting property '%s':%r&quot;</span>
                <span class="s4">% (</span><span class="s1">column</span><span class="s4">.</span><span class="s1">table</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">column</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">column</span><span class="s4">.</span><span class="s1">key</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">raise </span><span class="s1">orm_exc</span><span class="s4">.</span><span class="s1">UnmappedColumnError</span><span class="s4">(</span>
            <span class="s5">&quot;No column %s is configured on mapper %s...&quot;</span>
            <span class="s4">% (</span><span class="s1">column</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapper</span><span class="s4">)</span>
        <span class="s4">)</span>
</pre>
</body>
</html>