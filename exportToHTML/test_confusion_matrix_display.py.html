<html>
<head>
<title>test_confusion_matrix_display.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_confusion_matrix_display.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">compose </span><span class="s0">import </span><span class="s1">make_column_transformer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">make_classification</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">NotFittedError</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">, </span><span class="s1">confusion_matrix</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">StandardScaler</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">svm </span><span class="s0">import </span><span class="s1">SVC</span><span class="s2">, </span><span class="s1">SVR</span>

<span class="s3"># TODO: Remove when https://github.com/numpy/numpy/issues/14397 is resolved</span>
<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">&quot;ignore:In future, it will be an error for 'np.bool_':DeprecationWarning:&quot;</span>
    <span class="s4">&quot;matplotlib.*&quot;</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_confusion_matrix_display_validation</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that we raise the proper error when validating parameters.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">SVC</span><span class="s2">(), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">regressor </span><span class="s2">= </span><span class="s1">SVR</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred_regressor </span><span class="s2">= </span><span class="s1">regressor</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_pred_classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;ConfusionMatrixDisplay.from_estimator only supports classifiers&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">regressor</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;Mix type of y not allowed, got types&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s3"># Force `y_true` to be seen as a regression problem</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y </span><span class="s2">+ </span><span class="s6">0.5</span><span class="s2">, </span><span class="s1">y_pred_classifier</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred_regressor</span><span class="s2">)</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s4">&quot;Found input variables with inconsistent numbers of samples&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred_classifier</span><span class="s2">[::</span><span class="s6">2</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;constructor_name&quot;</span><span class="s2">, [</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;with_labels&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;with_display_labels&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_confusion_matrix_display_custom_labels</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">, </span><span class="s1">constructor_name</span><span class="s2">, </span><span class="s1">with_labels</span><span class="s2">, </span><span class="s1">with_display_labels</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check the resulting plot when labels are given.&quot;&quot;&quot;</span>
    <span class="s1">n_classes </span><span class="s2">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s3"># safe guard for the binary if/else construction</span>
    <span class="s0">assert </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">labels </span><span class="s2">= [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">] </span><span class="s0">if </span><span class="s1">with_labels </span><span class="s0">else None</span>
    <span class="s1">display_labels </span><span class="s2">= [</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;f&quot;</span><span class="s2">] </span><span class="s0">if </span><span class="s1">with_display_labels </span><span class="s0">else None</span>

    <span class="s1">cm </span><span class="s2">= </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">)</span>
    <span class="s1">common_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;ax&quot;</span><span class="s2">: </span><span class="s1">ax</span><span class="s2">,</span>
        <span class="s4">&quot;display_labels&quot;</span><span class="s2">: </span><span class="s1">display_labels</span><span class="s2">,</span>
        <span class="s4">&quot;labels&quot;</span><span class="s2">: </span><span class="s1">labels</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s2">== </span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">classifier</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">confusion_matrix</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">with_display_labels</span><span class="s2">:</span>
        <span class="s1">expected_display_labels </span><span class="s2">= </span><span class="s1">display_labels</span>
    <span class="s0">elif </span><span class="s1">with_labels</span><span class="s2">:</span>
        <span class="s1">expected_display_labels </span><span class="s2">= </span><span class="s1">labels</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected_display_labels </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_classes</span><span class="s2">))</span>

    <span class="s1">expected_display_labels_str </span><span class="s2">= [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">expected_display_labels</span><span class="s2">]</span>

    <span class="s1">x_ticks </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">()]</span>
    <span class="s1">y_ticks </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_yticklabels</span><span class="s2">()]</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">display_labels</span><span class="s2">, </span><span class="s1">expected_display_labels</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_ticks</span><span class="s2">, </span><span class="s1">expected_display_labels_str</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_ticks</span><span class="s2">, </span><span class="s1">expected_display_labels_str</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;constructor_name&quot;</span><span class="s2">, [</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;normalize&quot;</span><span class="s2">, [</span><span class="s4">&quot;true&quot;</span><span class="s2">, </span><span class="s4">&quot;pred&quot;</span><span class="s2">, </span><span class="s4">&quot;all&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;include_values&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_confusion_matrix_display_plotting</span><span class="s2">(</span>
    <span class="s1">pyplot</span><span class="s2">,</span>
    <span class="s1">constructor_name</span><span class="s2">,</span>
    <span class="s1">normalize</span><span class="s2">,</span>
    <span class="s1">include_values</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check the overall plotting rendering.&quot;&quot;&quot;</span>
    <span class="s1">n_classes </span><span class="s2">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s3"># safe guard for the binary if/else construction</span>
    <span class="s0">assert </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s4">&quot;plasma&quot;</span>

    <span class="s1">cm </span><span class="s2">= </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">common_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;normalize&quot;</span><span class="s2">: </span><span class="s1">normalize</span><span class="s2">,</span>
        <span class="s4">&quot;cmap&quot;</span><span class="s2">: </span><span class="s1">cmap</span><span class="s2">,</span>
        <span class="s4">&quot;ax&quot;</span><span class="s2">: </span><span class="s1">ax</span><span class="s2">,</span>
        <span class="s4">&quot;include_values&quot;</span><span class="s2">: </span><span class="s1">include_values</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s2">== </span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">classifier</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_ </span><span class="s2">== </span><span class="s1">ax</span>

    <span class="s0">if </span><span class="s1">normalize </span><span class="s2">== </span><span class="s4">&quot;true&quot;</span><span class="s2">:</span>
        <span class="s1">cm </span><span class="s2">= </span><span class="s1">cm </span><span class="s2">/ </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s6">1</span><span class="s2">, </span><span class="s1">keepdims</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">normalize </span><span class="s2">== </span><span class="s4">&quot;pred&quot;</span><span class="s2">:</span>
        <span class="s1">cm </span><span class="s2">= </span><span class="s1">cm </span><span class="s2">/ </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">keepdims</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">normalize </span><span class="s2">== </span><span class="s4">&quot;all&quot;</span><span class="s2">:</span>
        <span class="s1">cm </span><span class="s2">= </span><span class="s1">cm </span><span class="s2">/ </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">confusion_matrix</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>
    <span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">, </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">image</span><span class="s2">.</span><span class="s1">AxesImage</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">.</span><span class="s1">get_cmap</span><span class="s2">().</span><span class="s1">name </span><span class="s2">== </span><span class="s1">cmap</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">, </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">Axes</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">figure_</span><span class="s2">, </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">Figure</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">() == </span><span class="s4">&quot;True label&quot;</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">() == </span><span class="s4">&quot;Predicted label&quot;</span>

    <span class="s1">x_ticks </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">()]</span>
    <span class="s1">y_ticks </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_yticklabels</span><span class="s2">()]</span>

    <span class="s1">expected_display_labels </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_classes</span><span class="s2">))</span>

    <span class="s1">expected_display_labels_str </span><span class="s2">= [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">expected_display_labels</span><span class="s2">]</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">display_labels</span><span class="s2">, </span><span class="s1">expected_display_labels</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_ticks</span><span class="s2">, </span><span class="s1">expected_display_labels_str</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_ticks</span><span class="s2">, </span><span class="s1">expected_display_labels_str</span><span class="s2">)</span>

    <span class="s1">image_data </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">().</span><span class="s1">data</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">image_data</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">include_values</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">)</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s4">&quot;.2g&quot;</span>
        <span class="s1">expected_text </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">format</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s4">&quot;C&quot;</span><span class="s2">)])</span>
        <span class="s1">text_text </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s4">&quot;C&quot;</span><span class="s2">)])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_text</span><span class="s2">, </span><span class="s1">text_text</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_ </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;constructor_name&quot;</span><span class="s2">, [</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_confusion_matrix_display</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">constructor_name</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check the behaviour of the default constructor without using the class 
    methods.&quot;&quot;&quot;</span>
    <span class="s1">n_classes </span><span class="s2">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s3"># safe guard for the binary if/else construction</span>
    <span class="s0">assert </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">)</span>

    <span class="s1">cm </span><span class="s2">= </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">common_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;normalize&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s4">&quot;include_values&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s4">&quot;cmap&quot;</span><span class="s2">: </span><span class="s4">&quot;viridis&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;xticks_rotation&quot;</span><span class="s2">: </span><span class="s6">45.0</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s2">== </span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">classifier</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">confusion_matrix</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">)</span>

    <span class="s1">rotations </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_rotation</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">()]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rotations</span><span class="s2">, </span><span class="s6">45.0</span><span class="s2">)</span>

    <span class="s1">image_data </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">().</span><span class="s1">data</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">image_data</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">=</span><span class="s4">&quot;plasma&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">.</span><span class="s1">get_cmap</span><span class="s2">().</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;plasma&quot;</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">include_values</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_ </span><span class="s0">is None</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">xticks_rotation</span><span class="s2">=</span><span class="s6">90.0</span><span class="s2">)</span>
    <span class="s1">rotations </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_rotation</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">()]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rotations</span><span class="s2">, </span><span class="s6">90.0</span><span class="s2">)</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">values_format</span><span class="s2">=</span><span class="s4">&quot;e&quot;</span><span class="s2">)</span>
    <span class="s1">expected_text </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">format</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s4">&quot;C&quot;</span><span class="s2">)])</span>
    <span class="s1">text_text </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s4">&quot;C&quot;</span><span class="s2">)])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_text</span><span class="s2">, </span><span class="s1">text_text</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_confusion_matrix_contrast</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that the text color is appropriate depending on background.&quot;&quot;&quot;</span>

    <span class="s1">cm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s6">2</span><span class="s2">) / </span><span class="s6">2</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">(</span><span class="s1">cm</span><span class="s2">, </span><span class="s1">display_labels</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">gray</span><span class="s2">)</span>
    <span class="s3"># diagonal text is black</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>

    <span class="s3"># off-diagonal text is white</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">gray_r</span><span class="s2">)</span>
    <span class="s3"># diagonal text is white</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>

    <span class="s3"># off-diagonal text is black</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), [</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>

    <span class="s3"># Regression test for #15920</span>
    <span class="s1">cm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">19</span><span class="s2">, </span><span class="s6">34</span><span class="s2">], [</span><span class="s6">32</span><span class="s2">, </span><span class="s6">58</span><span class="s2">]])</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">(</span><span class="s1">cm</span><span class="s2">, </span><span class="s1">display_labels</span><span class="s2">=[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>

    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">Blues</span><span class="s2">)</span>
    <span class="s1">min_color </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">Blues</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">max_color </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">cm</span><span class="s2">.</span><span class="s1">Blues</span><span class="s2">(</span><span class="s6">255</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), </span><span class="s1">max_color</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), </span><span class="s1">max_color</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), </span><span class="s1">max_color</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">(), </span><span class="s1">min_color</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;clf&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">LogisticRegression</span><span class="s2">(),</span>
        <span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">StandardScaler</span><span class="s2">(), </span><span class="s1">LogisticRegression</span><span class="s2">()),</span>
        <span class="s1">make_pipeline</span><span class="s2">(</span>
            <span class="s1">make_column_transformer</span><span class="s2">((</span><span class="s1">StandardScaler</span><span class="s2">(), [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])),</span>
            <span class="s1">LogisticRegression</span><span class="s2">(),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s4">&quot;clf&quot;</span><span class="s2">, </span><span class="s4">&quot;pipeline-clf&quot;</span><span class="s2">, </span><span class="s4">&quot;pipeline-column_transformer-clf&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_confusion_matrix_pipeline</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check the behaviour of the plotting with more complex pipeline.&quot;&quot;&quot;</span>
    <span class="s1">n_classes </span><span class="s2">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">cm </span><span class="s2">= </span><span class="s1">confusion_matrix</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">disp</span><span class="s2">.</span><span class="s1">confusion_matrix</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;constructor_name&quot;</span><span class="s2">, [</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_confusion_matrix_with_unknown_labels</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">, </span><span class="s1">constructor_name</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that when labels=None, the unique values in `y_pred` and `y_true` 
    will be used. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/pull/18405 
    &quot;&quot;&quot;</span>
    <span class="s1">n_classes </span><span class="s2">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s6">100</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s6">5</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span>
    <span class="s2">)</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s3"># create unseen labels in `y_true` not seen during fitting and not present</span>
    <span class="s3"># in 'classifier.classes_'</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s6">1</span>

    <span class="s3"># safe guard for the binary if/else construction</span>
    <span class="s0">assert </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">, </span><span class="s4">&quot;from_predictions&quot;</span><span class="s2">)</span>

    <span class="s1">common_kwargs </span><span class="s2">= {</span><span class="s4">&quot;labels&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">}</span>
    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s2">== </span><span class="s4">&quot;from_estimator&quot;</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span><span class="s1">classifier</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, **</span><span class="s1">common_kwargs</span><span class="s2">)</span>

    <span class="s1">display_labels </span><span class="s2">= [</span><span class="s1">tick</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">ax_</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">()]</span>
    <span class="s1">expected_labels </span><span class="s2">= [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_classes </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_labels</span><span class="s2">, </span><span class="s1">display_labels</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_colormap_max</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that the max color is used for the color of the text.&quot;&quot;&quot;</span>
    <span class="s1">gray </span><span class="s2">= </span><span class="s1">pyplot</span><span class="s2">.</span><span class="s1">get_cmap</span><span class="s2">(</span><span class="s4">&quot;gray&quot;</span><span class="s2">, </span><span class="s6">1024</span><span class="s2">)</span>
    <span class="s1">confusion_matrix </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">], [</span><span class="s6">0.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">]])</span>

    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">(</span><span class="s1">confusion_matrix</span><span class="s2">)</span>
    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">gray</span><span class="s2">)</span>

    <span class="s1">color </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">].</span><span class="s1">get_color</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">color</span><span class="s2">, [</span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">, </span><span class="s6">1.0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_im_kw_adjust_vmin_vmax</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that im_kw passes kwargs to imshow&quot;&quot;&quot;</span>

    <span class="s1">confusion_matrix </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s6">0.48</span><span class="s2">, </span><span class="s6">0.04</span><span class="s2">], [</span><span class="s6">0.08</span><span class="s2">, </span><span class="s6">0.4</span><span class="s2">]])</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">(</span><span class="s1">confusion_matrix</span><span class="s2">)</span>
    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">im_kw</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s6">0.8</span><span class="s2">))</span>

    <span class="s1">clim </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">im_</span><span class="s2">.</span><span class="s1">get_clim</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">clim</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">clim</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s6">0.8</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_confusion_matrix_text_kw</span><span class="s2">(</span><span class="s1">pyplot</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Check that text_kw is passed to the text call.&quot;&quot;&quot;</span>
    <span class="s1">font_size </span><span class="s2">= </span><span class="s6">15.0</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">SVC</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s3"># from_estimator passes the font size</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_estimator</span><span class="s2">(</span>
        <span class="s1">classifier</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">text_kw</span><span class="s2">={</span><span class="s4">&quot;fontsize&quot;</span><span class="s2">: </span><span class="s1">font_size</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s0">for </span><span class="s1">text </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">text</span><span class="s2">.</span><span class="s1">get_fontsize</span><span class="s2">() == </span><span class="s1">font_size</span>

    <span class="s3"># plot adjusts plot to new font size</span>
    <span class="s1">new_font_size </span><span class="s2">= </span><span class="s6">20.0</span>
    <span class="s1">disp</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">text_kw</span><span class="s2">={</span><span class="s4">&quot;fontsize&quot;</span><span class="s2">: </span><span class="s1">new_font_size</span><span class="s2">})</span>
    <span class="s0">for </span><span class="s1">text </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">text</span><span class="s2">.</span><span class="s1">get_fontsize</span><span class="s2">() == </span><span class="s1">new_font_size</span>

    <span class="s3"># from_predictions passes the font size</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">disp </span><span class="s2">= </span><span class="s1">ConfusionMatrixDisplay</span><span class="s2">.</span><span class="s1">from_predictions</span><span class="s2">(</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">text_kw</span><span class="s2">={</span><span class="s4">&quot;fontsize&quot;</span><span class="s2">: </span><span class="s1">font_size</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s0">for </span><span class="s1">text </span><span class="s0">in </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">text_</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">text</span><span class="s2">.</span><span class="s1">get_fontsize</span><span class="s2">() == </span><span class="s1">font_size</span>
</pre>
</body>
</html>