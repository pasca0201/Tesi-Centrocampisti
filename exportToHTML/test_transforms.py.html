<html>
<head>
<title>test_transforms.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_transforms.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">copy</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">,</span>
                           <span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">scale</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">patches </span><span class="s0">as </span><span class="s1">mpatches</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">as </span><span class="s1">mtransforms</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">import </span><span class="s1">Affine2D</span><span class="s2">, </span><span class="s1">Bbox</span><span class="s2">, </span><span class="s1">TransformedBbox</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">image_comparison</span><span class="s2">, </span><span class="s1">check_figures_equal</span>


<span class="s0">class </span><span class="s1">TestAffine2D</span><span class="s2">:</span>
    <span class="s1">single_point </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">multiple_points </span><span class="s2">= [[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">], [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]</span>
    <span class="s1">pivot </span><span class="s2">= </span><span class="s1">single_point</span>

    <span class="s0">def </span><span class="s1">test_init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">Affine2D</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]])</span>
        <span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]], </span><span class="s1">int</span><span class="s2">))</span>
        <span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]], </span><span class="s1">float</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">19680801</span><span class="s2">)</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(*</span><span class="s1">values</span><span class="s2">).</span><span class="s1">to_values</span><span class="s2">(), </span><span class="s1">values</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_modify_inplace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Some polar transforms require modifying the matrix in place.</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s1">mtx </span><span class="s2">= </span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()</span>
        <span class="s1">mtx</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">] = </span><span class="s3">42</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), [[</span><span class="s3">42</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">) + </span><span class="s3">5</span><span class="s2">)  </span><span class="s4"># Anything non-identity.</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_rotate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r_pi_2 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r90 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi_2</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r90</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r90</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r90</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">r_pi </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">r180 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">180</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r180</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r180</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r180</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">], [-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>

        <span class="s1">r_pi_3_2 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r270 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">270</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi_3_2</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r270</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r270</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r270</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">assert_array_equal</span><span class="s2">((</span><span class="s1">r90 </span><span class="s2">+ </span><span class="s1">r90</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r180</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">((</span><span class="s1">r90 </span><span class="s2">+ </span><span class="s1">r180</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r270</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_rotate_around</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r_pi_2 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r90 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi_2</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r90</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r90</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r90</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">r_pi </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">r180 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">180</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r180</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r180</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r180</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>

        <span class="s1">r_pi_3_2 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r270 </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">270</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">r_pi_3_2</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r270</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r270</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r270</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>

        <span class="s1">assert_array_almost_equal</span><span class="s2">((</span><span class="s1">r90 </span><span class="s2">+ </span><span class="s1">r90</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r180</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">((</span><span class="s1">r90 </span><span class="s2">+ </span><span class="s1">r180</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">r270</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_scale</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sx </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">sy </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">((</span><span class="s1">sx </span><span class="s2">+ </span><span class="s1">sy</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                           <span class="s2">[[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">, -</span><span class="s3">6</span><span class="s2">], [</span><span class="s3">12</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_skew</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">trans_rad </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">8</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">trans_deg </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">22.5</span><span class="s2">, </span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans_rad</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_deg</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s4"># Using ~atan(0.5), ~atan(0.25) produces roundish numbers on output.</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">4.5</span><span class="s2">, </span><span class="s3">3.75</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_translate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">((</span><span class="s1">tx </span><span class="s2">+ </span><span class="s1">ty</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">24</span><span class="s2">, </span><span class="s3">43</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                           <span class="s2">[[</span><span class="s3">23</span><span class="s2">, </span><span class="s3">44</span><span class="s2">], [</span><span class="s3">26</span><span class="s2">, </span><span class="s3">45</span><span class="s2">], [</span><span class="s3">27</span><span class="s2">, </span><span class="s3">42</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_rotate_plus_other</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">).</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">180</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">180</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">).</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">9</span><span class="s2">, -</span><span class="s3">6</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))  </span><span class="s4"># ~atan(0.5), ~atan(0.25)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">], [-</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">).</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">22</span><span class="s2">, </span><span class="s3">43</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">21</span><span class="s2">, </span><span class="s3">42</span><span class="s2">], [</span><span class="s3">20</span><span class="s2">, </span><span class="s3">45</span><span class="s2">], [</span><span class="s3">23</span><span class="s2">, </span><span class="s3">46</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_rotate_around_plus_other</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">).</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">180</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">180</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">).</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">6</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))  </span><span class="s4"># ~atan(0.5), ~atan(0.25)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">2.75</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">).</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">24</span><span class="s2">, </span><span class="s3">43</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">], [</span><span class="s3">22</span><span class="s2">, </span><span class="s3">45</span><span class="s2">], [</span><span class="s3">25</span><span class="s2">, </span><span class="s3">46</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_scale_plus_other</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">).</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">12</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">).</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">12</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))  </span><span class="s4"># ~atan(0.5), ~atan(0.25)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1.25</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, -</span><span class="s3">3.75</span><span class="s2">], [</span><span class="s3">12</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">).</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">26</span><span class="s2">, </span><span class="s3">40</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                           <span class="s2">[[</span><span class="s3">23</span><span class="s2">, </span><span class="s3">38</span><span class="s2">], [</span><span class="s3">32</span><span class="s2">, </span><span class="s3">36</span><span class="s2">], [</span><span class="s3">35</span><span class="s2">, </span><span class="s3">42</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_skew_plus_other</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Using ~atan(0.5), ~atan(0.25) produces roundish numbers on output.</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">).</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">3.75</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">))</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1.75</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">).</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">4.5</span><span class="s2">, -</span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">], [</span><span class="s3">13.5</span><span class="s2">, -</span><span class="s3">7.5</span><span class="s2">], [</span><span class="s3">12</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">).</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">24.5</span><span class="s2">, </span><span class="s3">43.25</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">24</span><span class="s2">, </span><span class="s3">44</span><span class="s2">], [</span><span class="s3">27.5</span><span class="s2">, </span><span class="s3">45.75</span><span class="s2">], [</span><span class="s3">27</span><span class="s2">, </span><span class="s3">43</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_translate_plus_other</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">).</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">43</span><span class="s2">, </span><span class="s3">24</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">44</span><span class="s2">, </span><span class="s3">23</span><span class="s2">], [-</span><span class="s3">45</span><span class="s2">, </span><span class="s3">26</span><span class="s2">], [-</span><span class="s3">42</span><span class="s2">, </span><span class="s3">27</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">).</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg_around</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pivot</span><span class="s2">, </span><span class="s3">90</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [-</span><span class="s3">41</span><span class="s2">, </span><span class="s3">24</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[-</span><span class="s3">42</span><span class="s2">, </span><span class="s3">23</span><span class="s2">], [-</span><span class="s3">43</span><span class="s2">, </span><span class="s3">26</span><span class="s2">], [-</span><span class="s3">40</span><span class="s2">, </span><span class="s3">27</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">).</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">trans_added </span><span class="s2">= </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">) + </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">72</span><span class="s2">, -</span><span class="s3">86</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">69</span><span class="s2">, -</span><span class="s3">88</span><span class="s2">], [</span><span class="s3">78</span><span class="s2">, -</span><span class="s3">90</span><span class="s2">], [</span><span class="s3">81</span><span class="s2">, -</span><span class="s3">84</span><span class="s2">]])</span>

        <span class="s1">trans </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))  </span><span class="s4"># ~atan(0.5), ~atan(0.25)</span>
        <span class="s1">trans_added </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">23</span><span class="s2">, </span><span class="s3">42</span><span class="s2">) +</span>
                       <span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew_deg</span><span class="s2">(</span><span class="s3">26.5650512</span><span class="s2">, </span><span class="s3">14.0362435</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">trans_added</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">single_point</span><span class="s2">), [</span><span class="s3">45.5</span><span class="s2">, </span><span class="s3">49</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiple_points</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s3">45</span><span class="s2">, </span><span class="s3">49.75</span><span class="s2">], [</span><span class="s3">48.5</span><span class="s2">, </span><span class="s3">51.5</span><span class="s2">], [</span><span class="s3">48</span><span class="s2">, </span><span class="s3">48.75</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_invalid_transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s4"># There are two different exceptions, since the wrong number of</span>
        <span class="s4"># dimensions is caught when constructing an array_view, and that</span>
        <span class="s4"># raises a ValueError, and a wrong shape with a possible number</span>
        <span class="s4"># of dimensions is caught by our CALL_CPP macro, which always</span>
        <span class="s4"># raises the less precise RuntimeError.</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[[</span><span class="s3">1</span><span class="s2">]]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
        <span class="s4"># Updating a dependee should invalidate a copy of the dependent.</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()  </span><span class="s4"># resolve it.</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s0">and not </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s0">and </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">s1</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">() == </span><span class="s1">a</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()).</span><span class="s1">all</span><span class="s2">()</span>
        <span class="s4"># Updating a copy of a dependee shouldn't invalidate a dependent.</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()  </span><span class="s4"># resolve it.</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">b1</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_deepcopy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
        <span class="s4"># Updating a dependee shouldn't invalidate a deepcopy of the dependent.</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()  </span><span class="s4"># resolve it.</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s0">and not </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s0">and not </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">get_matrix</span><span class="s2">())</span>
        <span class="s4"># Updating a deepcopy of a dependee shouldn't invalidate a dependent.</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">()  </span><span class="s4"># resolve it.</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">b1</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">_invalid</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_non_affine_caching</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">AssertingNonAffineTransform</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Transform</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        This transform raises an assertion error when called when it 
        shouldn't be and ``self.raise_on_transform`` is True. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">input_dims </span><span class="s2">= </span><span class="s1">output_dims </span><span class="s2">= </span><span class="s3">2</span>
        <span class="s1">is_affine </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">raise_on_transform </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">underlying_transform </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">transform_path_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">):</span>
            <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">raise_on_transform</span><span class="s2">, </span><span class="s1">\</span>
                <span class="s6">'Invalidated affine part of transform unnecessarily.'</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">underlying_transform</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">transform_path </span><span class="s2">= </span><span class="s1">transform_path_non_affine</span>

        <span class="s0">def </span><span class="s1">transform_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">):</span>
            <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">raise_on_transform</span><span class="s2">, </span><span class="s1">\</span>
                <span class="s6">'Invalidated affine part of transform unnecessarily.'</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">underlying_transform</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">transform </span><span class="s2">= </span><span class="s1">transform_non_affine</span>

    <span class="s1">my_trans </span><span class="s2">= </span><span class="s1">AssertingNonAffineTransform</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">my_trans </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s4"># enable the transform to raise an exception if it's non-affine transform</span>
    <span class="s4"># method is triggered again.</span>
    <span class="s1">my_trans</span><span class="s2">.</span><span class="s1">raise_on_transform </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">.</span><span class="s1">invalidate</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_external_transform_api</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">ScaledBy</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scale_factor</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_scale_factor </span><span class="s2">= </span><span class="s1">scale_factor</span>

        <span class="s0">def </span><span class="s1">_as_mpl_transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_scale_factor</span><span class="s2">)</span>
                    <span class="s2">+ </span><span class="s1">axes</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">line</span><span class="s2">, = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ScaledBy</span><span class="s2">(</span><span class="s3">10</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
    <span class="s4"># assert that the top transform of the line is the scale transform.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">_a</span><span class="s2">.</span><span class="s1">get_matrix</span><span class="s2">(),</span>
                    <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s6">'pre_transform_data'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s6">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s3">0.05</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pre_transform_plotting</span><span class="s2">():</span>
    <span class="s4"># a catch-all for as many as possible plot layouts which handle</span>
    <span class="s4"># pre-transforming the data NOTE: The axis range is important in this</span>
    <span class="s4"># plot. It should be x10 what the data suggests it should be</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">times10 </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">contourf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">48</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">7</span><span class="s2">),</span>
                  <span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">5.5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
                  <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">48</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span>
                  <span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
               <span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">20</span><span class="s2">)</span>
    <span class="s1">u </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">])</span>
    <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">])</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">streamplot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">,</span>
                  <span class="s1">linewidth</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">))</span>

    <span class="s4"># reduce the vector data down a bit for barb and quiver plotting</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">]</span>
    <span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">u</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">, ::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">v</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">, ::</span><span class="s3">3</span><span class="s2">]</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">quiver</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">barbs</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s3">3</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">, </span><span class="s1">u</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, </span><span class="s1">v</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">times10 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_contour_pre_transform_limits</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">15</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">15</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">12.4</span><span class="s2">, </span><span class="s3">12.5</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">contourf</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">xs </span><span class="s2">* </span><span class="s1">ys</span><span class="s2">),</span>
                <span class="s1">transform</span><span class="s2">=</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.24</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_pcolor_pre_transform_limits</span><span class="s2">():</span>
    <span class="s4"># Based on test_contour_pre_transform_limits()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">15</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">15</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">12.4</span><span class="s2">, </span><span class="s3">12.5</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolor</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">xs </span><span class="s2">* </span><span class="s1">ys</span><span class="s2">)[:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">1</span><span class="s2">],</span>
              <span class="s1">transform</span><span class="s2">=</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.24</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_pcolormesh_pre_transform_limits</span><span class="s2">():</span>
    <span class="s4"># Based on test_contour_pre_transform_limits()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">15</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">15</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">12.4</span><span class="s2">, </span><span class="s3">12.5</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">xs </span><span class="s2">* </span><span class="s1">ys</span><span class="s2">)[:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">1</span><span class="s2">],</span>
                  <span class="s1">transform</span><span class="s2">=</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.24</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_pcolormesh_gouraud_nans</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">19680801</span><span class="s2">)</span>

    <span class="s1">values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">180</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">radii </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">radii</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">z</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">) * </span><span class="s3">100</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">111</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s6">&quot;polar&quot;</span><span class="s2">)</span>
    <span class="s4"># Setting the limit to cause clipping of the r values causes NaN to be</span>
    <span class="s4"># introduced; these should not crash but be ignored as in other path</span>
    <span class="s4"># operations.</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_rlim</span><span class="s2">(</span><span class="s3">101</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">shading</span><span class="s2">=</span><span class="s6">&quot;gouraud&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_Affine2D_from_values</span><span class="s2">():</span>
    <span class="s1">points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">],</span>
                       <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                       <span class="s2">])</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">60</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">80</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">.</span><span class="s1">from_values</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_affine_inverted_invalidated</span><span class="s2">():</span>
    <span class="s4"># Ensure that the an affine transform is not declared valid on access</span>
    <span class="s1">point </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">point</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">point</span><span class="s2">)))</span>
    <span class="s4"># Change and access the transform</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">()</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">point</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">point</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">test_clipping_of_log</span><span class="s2">():</span>
    <span class="s4"># issue 804</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">_create_closed</span><span class="s2">([(</span><span class="s3">0.2</span><span class="s2">, -</span><span class="s3">99</span><span class="s2">), (</span><span class="s3">0.4</span><span class="s2">, -</span><span class="s3">99</span><span class="s2">), (</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">20</span><span class="s2">), (</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">20</span><span class="s2">)])</span>
    <span class="s4"># something like this happens in plotting logarithmic histograms</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">BlendedGenericTransform</span><span class="s2">(</span>
        <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">(), </span><span class="s1">scale</span><span class="s2">.</span><span class="s1">LogTransform</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s6">'clip'</span><span class="s2">))</span>
    <span class="s1">tpath </span><span class="s2">= </span><span class="s1">trans</span><span class="s2">.</span><span class="s1">transform_path_non_affine</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">tpath</span><span class="s2">.</span><span class="s1">iter_segments</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">.</span><span class="s1">get_affine</span><span class="s2">(),</span>
                                 <span class="s1">clip</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">100</span><span class="s2">),</span>
                                 <span class="s1">simplify</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">tpoints</span><span class="s2">, </span><span class="s1">tcodes </span><span class="s2">= </span><span class="s1">zip</span><span class="s2">(*</span><span class="s1">result</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tcodes</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">])  </span><span class="s4"># No longer closed.</span>


<span class="s0">class </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Transform</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    A class which looks like a non affine transform, but does whatever 
    the given transform does (even if it is affine). This is very useful 
    for testing NonAffine behaviour with a simple Affine transform. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">is_affine </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">output_dims </span><span class="s2">= </span><span class="s3">2</span>
    <span class="s1">input_dims </span><span class="s2">= </span><span class="s3">2</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">real_trans</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">real_trans </span><span class="s2">= </span><span class="s1">real_trans</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">transform_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_trans</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">transform_path_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_trans</span><span class="s2">.</span><span class="s1">transform_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBasicTransform</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'ta1'</span><span class="s2">).</span><span class="s1">rotate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'ta2'</span><span class="s2">).</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ta3 </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">(</span><span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'ta3'</span><span class="s2">).</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">= </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
                                    <span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'tn1'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tn2 </span><span class="s2">= </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
                                    <span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'tn2'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tn3 </span><span class="s2">= </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
                                    <span class="s1">shorthand_name</span><span class="s2">=</span><span class="s6">'tn3'</span><span class="s2">)</span>

        <span class="s4"># creates a transform stack which looks like ((A, (N, A)), A)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stack1 </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">)) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span>
        <span class="s4"># creates a transform stack which looks like (((A, N), A), A)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stack2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span>
        <span class="s4"># creates a transform stack which is a subset of stack2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span>

        <span class="s4"># when in debug, the transform stacks can produce dot images:</span>
<span class="s4">#        self.stack1.write_graphviz(file('stack1.dot', 'w'))</span>
<span class="s4">#        self.stack2.write_graphviz(file('stack2.dot', 'w'))</span>
<span class="s4">#        self.stack2_subset.write_graphviz(file('stack2_subset.dot', 'w'))</span>

    <span class="s0">def </span><span class="s1">test_transform_depth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">depth </span><span class="s2">== </span><span class="s3">4</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">.</span><span class="s1">depth </span><span class="s2">== </span><span class="s3">4</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">.</span><span class="s1">depth </span><span class="s2">== </span><span class="s3">3</span>

    <span class="s0">def </span><span class="s1">test_left_to_right_iteration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">stack3 </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn2</span><span class="s2">))) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span>
<span class="s4">#        stack3.write_graphviz(file('stack3.dot', 'w'))</span>

        <span class="s1">target_transforms </span><span class="s2">= [</span><span class="s1">stack3</span><span class="s2">,</span>
                             <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn2</span><span class="s2">)) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">,</span>
                             <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn2</span><span class="s2">) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">,</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">tn2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">,</span>
                             <span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">,</span>
                             <span class="s2">]</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">rh </span><span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">rh </span><span class="s0">in </span><span class="s1">stack3</span><span class="s2">.</span><span class="s1">_iter_break_from_left_to_right</span><span class="s2">()]</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">target_transforms</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">target_stack</span><span class="s2">, </span><span class="s1">stack </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">target_transforms</span><span class="s2">, </span><span class="s1">r</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">target_stack </span><span class="s2">== </span><span class="s1">stack</span>

    <span class="s0">def </span><span class="s1">test_transform_shortcuts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span>

        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2 </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">).</span><span class="s1">depth </span><span class="s2">== </span><span class="s3">1</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">stack1 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span>

        <span class="s1">aff1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>
        <span class="s1">aff2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span>

        <span class="s0">assert </span><span class="s1">aff1 </span><span class="s2">- </span><span class="s1">aff2 </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span>
        <span class="s0">assert </span><span class="s1">aff1 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">== </span><span class="s1">aff1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">()</span>

        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3 </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3 </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span>

        <span class="s0">assert </span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3 </span><span class="s2">==</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r1 </span><span class="s2">== </span><span class="s1">r2</span>
        <span class="s0">assert </span><span class="s1">r1 </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span>
        <span class="s0">assert </span><span class="s1">r1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">r1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta1</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">r1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">r1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">r1 </span><span class="s2">== </span><span class="s1">r2</span>

        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">contains_branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn1 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2</span><span class="s2">)</span>

        <span class="s1">blend </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">BlendedGenericTransform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn2</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">blend</span><span class="s2">.</span><span class="s1">contains_branch_seperately</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">)</span>
        <span class="s1">stack_blend </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tn3 </span><span class="s2">+ </span><span class="s1">blend</span>
        <span class="s1">sx</span><span class="s2">, </span><span class="s1">sy </span><span class="s2">= </span><span class="s1">stack_blend</span><span class="s2">.</span><span class="s1">contains_branch_seperately</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2_subset</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">sx </span><span class="s0">is False</span>
        <span class="s0">assert </span><span class="s1">y </span><span class="s0">is </span><span class="s1">sy </span><span class="s0">is True</span>

    <span class="s0">def </span><span class="s1">test_affine_simplification</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># tests that a transform stack only calls as much is absolutely</span>
        <span class="s4"># necessary &quot;non-affine&quot; allowing the best possible optimization with</span>
        <span class="s4"># complex transformation stacks.</span>
        <span class="s1">points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]],</span>
                          <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">na_pts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">transform_non_affine</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>
        <span class="s1">all_pts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>

        <span class="s1">na_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">], [-</span><span class="s3">19.</span><span class="s2">, </span><span class="s3">12.</span><span class="s2">],</span>
                                <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">all_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">11.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">], [-</span><span class="s3">9.</span><span class="s2">, </span><span class="s3">24.</span><span class="s2">],</span>
                                 <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s3">11.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">]],</span>
                                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s4"># check we have the expected results from doing the affine part only</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">na_pts</span><span class="s2">, </span><span class="s1">na_expected</span><span class="s2">)</span>
        <span class="s4"># check we have the expected results from a full transformation</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">all_pts</span><span class="s2">, </span><span class="s1">all_expected</span><span class="s2">)</span>
        <span class="s4"># check we have the expected results from doing the transformation in</span>
        <span class="s4"># two steps</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">transform_affine</span><span class="s2">(</span><span class="s1">na_pts</span><span class="s2">),</span>
                                  <span class="s1">all_expected</span><span class="s2">)</span>
        <span class="s4"># check that getting the affine transformation first, then fully</span>
        <span class="s4"># transforming using that yields the same result as before.</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">get_affine</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">na_pts</span><span class="s2">),</span>
                                  <span class="s1">all_expected</span><span class="s2">)</span>

        <span class="s4"># check that the affine part of stack1 &amp; stack2 are equivalent</span>
        <span class="s4"># (i.e. the optimization is working)</span>
        <span class="s1">expected_result </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ta3</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">()</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack1</span><span class="s2">.</span><span class="s1">get_affine</span><span class="s2">().</span><span class="s1">get_matrix</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_result</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack2</span><span class="s2">.</span><span class="s1">get_affine</span><span class="s2">().</span><span class="s1">get_matrix</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_result</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestTransformPlotInterface</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_line_extent_axes_coords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># a simple line in axes coordinates</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], [</span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]]))</span>

    <span class="s0">def </span><span class="s1">test_line_extent_data_coords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># a simple line in data coordinates</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], [</span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.1</span><span class="s2">,  </span><span class="s3">0.5</span><span class="s2">], [</span><span class="s3">1.2</span><span class="s2">,  </span><span class="s3">0.9</span><span class="s2">]]))</span>

    <span class="s0">def </span><span class="s1">test_line_extent_compound_coords1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># a simple line in data coordinates in the y component, and in axes</span>
        <span class="s4"># coordinates in the x</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">blended_transform_factory</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">,</span>
                                                      <span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], [</span><span class="s3">35</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">18</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">5.</span><span class="s2">],</span>
                                     <span class="s2">[-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">35.</span><span class="s2">]]))</span>

    <span class="s0">def </span><span class="s1">test_line_extent_predata_transform_coords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># a simple line in (offset + data) coordinates</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">10</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], [</span><span class="s3">35</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">18</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.</span><span class="s2">, -</span><span class="s3">50.</span><span class="s2">], [</span><span class="s3">12.</span><span class="s2">, </span><span class="s3">350.</span><span class="s2">]]))</span>

    <span class="s0">def </span><span class="s1">test_line_extent_compound_coords2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># a simple line in (offset + data) coordinates in the y component, and</span>
        <span class="s4"># in axes coordinates in the x</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">blended_transform_factory</span><span class="s2">(</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">, </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">10</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">], [</span><span class="s3">35</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">18</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">50.</span><span class="s2">], [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">350.</span><span class="s2">]]))</span>

    <span class="s0">def </span><span class="s1">test_line_extents_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">expected_data_lim </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">9.</span><span class="s2">,  </span><span class="s3">9.</span><span class="s2">]]) + </span><span class="s3">10</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), </span><span class="s1">expected_data_lim</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_line_extents_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">na_offset </span><span class="s2">= </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">na_offset </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">expected_data_lim </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">9.</span><span class="s2">,  </span><span class="s3">9.</span><span class="s2">]]) + </span><span class="s3">20</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), </span><span class="s1">expected_data_lim</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pathc_extents_non_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">na_offset </span><span class="s2">= </span><span class="s1">NonAffineForTest</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>
        <span class="s1">pth </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">patch </span><span class="s2">= </span><span class="s1">mpatches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">pth</span><span class="s2">,</span>
                                   <span class="s1">transform</span><span class="s2">=</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">na_offset </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patch</span><span class="s2">)</span>
        <span class="s1">expected_data_lim </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">10.</span><span class="s2">,  </span><span class="s3">10.</span><span class="s2">]]) + </span><span class="s3">20</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), </span><span class="s1">expected_data_lim</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pathc_extents_affine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">pth </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">patch </span><span class="s2">= </span><span class="s1">mpatches</span><span class="s2">.</span><span class="s1">PathPatch</span><span class="s2">(</span><span class="s1">pth</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_patch</span><span class="s2">(</span><span class="s1">patch</span><span class="s2">)</span>
        <span class="s1">expected_data_lim </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">10.</span><span class="s2">,  </span><span class="s3">10.</span><span class="s2">]]) + </span><span class="s3">10</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), </span><span class="s1">expected_data_lim</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_line_extents_for_non_affine_transData</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">(</span><span class="s1">projection</span><span class="s2">=</span><span class="s6">'polar'</span><span class="s2">)</span>
        <span class="s4"># add 10 to the radius of the data</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>

        <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s4"># the data lim of a polar plot is stored in coordinates</span>
        <span class="s4"># before a transData transformation, hence the data limits</span>
        <span class="s4"># are not what is being shown on the actual plot.</span>
        <span class="s1">expected_data_lim </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">9.</span><span class="s2">,  </span><span class="s3">9.</span><span class="s2">]]) + [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(), </span><span class="s1">expected_data_lim</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">bbox1</span><span class="s2">, </span><span class="s1">bbox2</span><span class="s2">):</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">bbox1</span><span class="s2">.</span><span class="s1">bounds</span><span class="s2">, </span><span class="s1">bbox2</span><span class="s2">.</span><span class="s1">bounds</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bbox_frozen_copies_minpos</span><span class="s2">():</span>
    <span class="s1">bbox </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">from_extents</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">minpos</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">frozen </span><span class="s2">= </span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">frozen</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">frozen</span><span class="s2">.</span><span class="s1">minpos</span><span class="s2">, </span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">minpos</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bbox_intersection</span><span class="s2">():</span>
    <span class="s1">bbox_from_ext </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">from_extents</span>
    <span class="s1">inter </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">intersection</span>

    <span class="s1">r1 </span><span class="s2">= </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">r3 </span><span class="s2">= </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">)</span>
    <span class="s1">r4 </span><span class="s2">= </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">)</span>
    <span class="s1">r5 </span><span class="s2">= </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># self intersection -&gt; no change</span>
    <span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">inter</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">), </span><span class="s1">r1</span><span class="s2">)</span>
    <span class="s4"># simple intersection</span>
    <span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">inter</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">), </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
    <span class="s4"># r3 contains r2</span>
    <span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">inter</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">), </span><span class="s1">r3</span><span class="s2">)</span>
    <span class="s4"># no intersection</span>
    <span class="s0">assert </span><span class="s1">inter</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r4</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s4"># single point</span>
    <span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">inter</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r5</span><span class="s2">), </span><span class="s1">bbox_from_ext</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_bbox_as_strings</span><span class="s2">():</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s3">.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">.75</span><span class="s2">, </span><span class="s3">.75</span><span class="s2">]])</span>
    <span class="s1">assert_bbox_eq</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">), {</span><span class="s6">'Bbox'</span><span class="s2">: </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">}))</span>
    <span class="s1">asdict </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">b</span><span class="s2">), {</span><span class="s6">'Bbox'</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">})</span>
    <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">asdict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s1">v</span>
    <span class="s1">fmt </span><span class="s2">= </span><span class="s6">'.1f'</span>
    <span class="s1">asdict </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">format</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">), {</span><span class="s6">'Bbox'</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">})</span>
    <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">asdict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">format</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">fmt</span><span class="s2">)) == </span><span class="s1">v</span>


<span class="s0">def </span><span class="s1">test_str_transform</span><span class="s2">():</span>
    <span class="s4"># The str here should not be considered as &quot;absolutely stable&quot;, and may be</span>
    <span class="s4"># reformatted later; this is just a smoketest for __str__.</span>
    <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot</span><span class="s2">(</span><span class="s1">projection</span><span class="s2">=</span><span class="s6">&quot;polar&quot;</span><span class="s2">).</span><span class="s1">transData</span><span class="s2">) == </span><span class="s6">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s6">CompositeGenericTransform( 
    CompositeGenericTransform( 
        CompositeGenericTransform( 
            TransformWrapper( 
                BlendedAffine2D( 
                    IdentityTransform(), 
                    IdentityTransform())), 
            CompositeAffine2D( 
                Affine2D().scale(1.0), 
                Affine2D().scale(1.0))), 
        PolarTransform( 
            PolarAxes(0.125,0.1;0.775x0.8), 
            use_rmin=True, 
            apply_theta_transforms=False)), 
    CompositeGenericTransform( 
        CompositeGenericTransform( 
            PolarAffine( 
                TransformWrapper( 
                    BlendedAffine2D( 
                        IdentityTransform(), 
                        IdentityTransform())), 
                LockableBbox( 
                    Bbox(x0=0.0, y0=0.0, x1=6.283185307179586, y1=1.0), 
                    [[-- --] 
                     [-- --]])), 
            BboxTransformFrom( 
                _WedgeBbox( 
                    (0.5, 0.5), 
                    TransformedBbox( 
                        Bbox(x0=0.0, y0=0.0, x1=6.283185307179586, y1=1.0), 
                        CompositeAffine2D( 
                            Affine2D().scale(1.0), 
                            Affine2D().scale(1.0))), 
                    LockableBbox( 
                        Bbox(x0=0.0, y0=0.0, x1=6.283185307179586, y1=1.0), 
                        [[-- --] 
                         [-- --]])))), 
        BboxTransformTo( 
            TransformedBbox( 
                Bbox(x0=0.125, y0=0.09999999999999998, x1=0.9, y1=0.9), 
                BboxTransformTo( 
                    TransformedBbox( 
                        Bbox(x0=0.0, y0=0.0, x1=8.0, y1=6.0), 
                        Affine2D().scale(80.0)))))))&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_transform_single_point</span><span class="s2">():</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform_affine</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s3">2</span><span class="s2">,)</span>


<span class="s0">def </span><span class="s1">test_log_transform</span><span class="s2">():</span>
    <span class="s4"># Tests that the last line runs without exception (previously the</span>
    <span class="s4"># transform would fail if one of the axes was logarithmic).</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s6">'log'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_nan_overlap</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]])</span>
    <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">overlaps</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transform_angles</span><span class="s2">():</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()  </span><span class="s4"># Identity transform</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">60</span><span class="s2">])</span>
    <span class="s1">points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>

    <span class="s4"># Identity transform does not change angles</span>
    <span class="s1">new_angles </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">transform_angles</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">, </span><span class="s1">points</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">, </span><span class="s1">new_angles</span><span class="s2">)</span>

    <span class="s4"># points missing a 2nd dimension</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">transform_angles</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">, </span><span class="s1">points</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s4"># Number of angles != Number of points</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">transform_angles</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">, </span><span class="s1">points</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, :])</span>


<span class="s0">def </span><span class="s1">test_nonsingular</span><span class="s2">():</span>
    <span class="s4"># test for zero-expansion type cases; other cases may be added later</span>
    <span class="s1">zero_expansion </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">0.001</span><span class="s2">, </span><span class="s3">0.001</span><span class="s2">])</span>
    <span class="s1">cases </span><span class="s2">= [(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">7.9e-317</span><span class="s2">)]</span>
    <span class="s0">for </span><span class="s1">args </span><span class="s0">in </span><span class="s1">cases</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">nonsingular</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">zero_expansion</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transformed_path</span><span class="s2">():</span>
    <span class="s1">points </span><span class="s2">= [(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)]</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">points</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
    <span class="s1">trans_path </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">TransformedPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">trans</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">trans_path</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">points</span><span class="s2">)</span>

    <span class="s4"># Changing the transform should change the result.</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s3">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">trans</span><span class="s2">.</span><span class="s1">rotate</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s3">4</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">trans_path</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span><span class="s2">,</span>
                    <span class="s2">[(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">r2</span><span class="s2">), (-</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)],</span>
                    <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>

    <span class="s4"># Changing the path does not change the result (it's cached).</span>
    <span class="s1">path</span><span class="s2">.</span><span class="s1">points </span><span class="s2">= [(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)] * </span><span class="s3">4</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">trans_path</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span><span class="s2">,</span>
                    <span class="s2">[(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">r2</span><span class="s2">), (-</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)],</span>
                    <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transformed_patch_path</span><span class="s2">():</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
    <span class="s1">patch </span><span class="s2">= </span><span class="s1">mpatches</span><span class="s2">.</span><span class="s1">Wedge</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">135</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>

    <span class="s1">tpatch </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">TransformedPatchPath</span><span class="s2">(</span><span class="s1">patch</span><span class="s2">)</span>
    <span class="s1">points </span><span class="s2">= </span><span class="s1">tpatch</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span>

    <span class="s4"># Changing the transform should change the result.</span>
    <span class="s1">trans</span><span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tpatch</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">points </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># Changing the path should change the result (and cancel out the scaling</span>
    <span class="s4"># from the transform).</span>
    <span class="s1">patch</span><span class="s2">.</span><span class="s1">set_radius</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tpatch</span><span class="s2">.</span><span class="s1">get_fully_transformed_path</span><span class="s2">().</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">points</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'locked_element'</span><span class="s2">, [</span><span class="s6">'x0'</span><span class="s2">, </span><span class="s6">'y0'</span><span class="s2">, </span><span class="s6">'x1'</span><span class="s2">, </span><span class="s6">'y1'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_lockable_bbox</span><span class="s2">(</span><span class="s1">locked_element</span><span class="s2">):</span>
    <span class="s1">other_elements </span><span class="s2">= [</span><span class="s6">'x0'</span><span class="s2">, </span><span class="s6">'y0'</span><span class="s2">, </span><span class="s6">'x1'</span><span class="s2">, </span><span class="s6">'y1'</span><span class="s2">]</span>
    <span class="s1">other_elements</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">locked_element</span><span class="s2">)</span>

    <span class="s1">orig </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">()</span>
    <span class="s1">locked </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">LockableBbox</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, **{</span><span class="s1">locked_element</span><span class="s2">: </span><span class="s3">2</span><span class="s2">})</span>

    <span class="s4"># LockableBbox should keep its locked element as specified in __init__.</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s0">for </span><span class="s1">elem </span><span class="s0">in </span><span class="s1">other_elements</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">) == </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">)</span>

    <span class="s4"># Changing underlying Bbox should update everything but locked element.</span>
    <span class="s1">orig</span><span class="s2">.</span><span class="s1">set_points</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">() + </span><span class="s3">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s0">for </span><span class="s1">elem </span><span class="s0">in </span><span class="s1">other_elements</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">) == </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">)</span>

    <span class="s4"># Unlocking element should revert values back to the underlying Bbox.</span>
    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">() == </span><span class="s1">locked</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">())</span>

    <span class="s4"># Relocking an element should change its value, but not others.</span>
    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">3</span>
    <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s6">'locked_' </span><span class="s2">+ </span><span class="s1">locked_element</span><span class="s2">) == </span><span class="s3">3</span>
    <span class="s0">for </span><span class="s1">elem </span><span class="s0">in </span><span class="s1">other_elements</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">locked</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">) == </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">elem</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transformwrapper</span><span class="s2">():</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">TransformWrapper</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span>
            <span class="s6">r&quot;The input and output dims of the new child \(1, 1\) &quot;</span>
            <span class="s6">r&quot;do not match those of current child \(2, 2\)&quot;</span><span class="s2">)):</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">.</span><span class="s1">LogTransform</span><span class="s2">(</span><span class="s3">10</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s6">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_scale_swapping</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">19680801</span><span class="s2">)</span>
    <span class="s1">samples </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">fig</span><span class="s2">, </span><span class="s1">log_state </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">hist</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">, </span><span class="s1">log</span><span class="s2">=</span><span class="s1">log_state</span><span class="s2">, </span><span class="s1">density</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">) / </span><span class="s3">2</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">))</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s6">'linear'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_offset_copy_errors</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;'fontsize' is not a valid value for units;&quot;</span>
                             <span class="s6">&quot; supported values are 'dots', 'points', 'inches'&quot;</span><span class="s2">):</span>
        <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">offset_copy</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">units</span><span class="s2">=</span><span class="s6">'fontsize'</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s6">'For units of inches or points a fig kwarg is needed'</span><span class="s2">):</span>
        <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">offset_copy</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">units</span><span class="s2">=</span><span class="s6">'inches'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transformedbbox_contains</span><span class="s2">():</span>
    <span class="s1">bb </span><span class="s2">= </span><span class="s1">TransformedBbox</span><span class="s2">(</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">(), </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">rotate_deg</span><span class="s2">(</span><span class="s3">30</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s3">.8</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(-</span><span class="s3">.4</span><span class="s2">, </span><span class="s3">.85</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s3">.9</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">)</span>
    <span class="s1">bb </span><span class="s2">= </span><span class="s1">TransformedBbox</span><span class="s2">(</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">(), </span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s3">.25</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">fully_contains</span><span class="s2">(</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">bb</span><span class="s2">.</span><span class="s1">fully_contains</span><span class="s2">(</span><span class="s3">.1</span><span class="s2">, </span><span class="s3">.1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_interval_contains</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_interval_contains_open</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">interval_contains_open</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>
</pre>
</body>
</html>