<html>
<head>
<title>test_peak_finding.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_peak_finding.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">copy</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_</span><span class="s2">,</span>
    <span class="s1">assert_equal</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises</span><span class="s2">, </span><span class="s1">warns</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_peak_finding </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">argrelmax</span><span class="s2">,</span>
    <span class="s1">argrelmin</span><span class="s2">,</span>
    <span class="s1">peak_prominences</span><span class="s2">,</span>
    <span class="s1">peak_widths</span><span class="s2">,</span>
    <span class="s1">_unpack_condition_args</span><span class="s2">,</span>
    <span class="s1">find_peaks</span><span class="s2">,</span>
    <span class="s1">find_peaks_cwt</span><span class="s2">,</span>
    <span class="s1">_identify_ridge_lines</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">windows </span><span class="s0">import </span><span class="s1">gaussian</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">.</span><span class="s1">_peak_finding_utils </span><span class="s0">import </span><span class="s1">_local_maxima_1d</span><span class="s2">, </span><span class="s1">PeakPropertyWarning</span>


<span class="s0">def </span><span class="s1">_gen_gaussians</span><span class="s2">(</span><span class="s1">center_locs</span><span class="s2">, </span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">total_length</span><span class="s2">):</span>
    <span class="s1">xdata </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">total_length</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">out_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">total_length</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ind</span><span class="s2">, </span><span class="s1">sigma </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">):</span>
        <span class="s1">tmp </span><span class="s2">= (</span><span class="s1">xdata </span><span class="s2">- </span><span class="s1">center_locs</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">]) / </span><span class="s1">sigma</span>
        <span class="s1">out_data </span><span class="s2">+= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s1">tmp</span><span class="s2">**</span><span class="s3">2</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">out_data</span>


<span class="s0">def </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">total_length</span><span class="s2">):</span>
    <span class="s1">num_peaks </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">)</span>
    <span class="s1">delta </span><span class="s2">= </span><span class="s1">total_length </span><span class="s2">/ (</span><span class="s1">num_peaks </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">center_locs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">delta</span><span class="s2">, </span><span class="s1">total_length </span><span class="s2">- </span><span class="s1">delta</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s1">num_peaks</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">out_data </span><span class="s2">= </span><span class="s1">_gen_gaussians</span><span class="s2">(</span><span class="s1">center_locs</span><span class="s2">, </span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">total_length</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">out_data</span><span class="s2">, </span><span class="s1">center_locs</span>


<span class="s0">def </span><span class="s1">_gen_ridge_line</span><span class="s2">(</span><span class="s1">start_locs</span><span class="s2">, </span><span class="s1">max_locs</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">distances</span><span class="s2">, </span><span class="s1">gaps</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Generate coordinates for a ridge line. 
 
    Will be a series of coordinates, starting a start_loc (length 2). 
    The maximum distance between any adjacent columns will be 
    `max_distance`, the max distance between adjacent rows 
    will be `map_gap'. 
 
    `max_locs` should be the size of the intended matrix. The 
    ending coordinates are guaranteed to be less than `max_locs`, 
    although they may not approach `max_locs` at all. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">keep_bounds</span><span class="s2">(</span><span class="s1">num</span><span class="s2">, </span><span class="s1">max_val</span><span class="s2">):</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">num</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">max_val</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">out</span>

    <span class="s1">gaps </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">)</span>
    <span class="s1">distances </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">)</span>

    <span class="s1">locs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s1">length</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">locs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, :] = </span><span class="s1">start_locs</span>
    <span class="s1">total_length </span><span class="s2">= </span><span class="s1">max_locs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] - </span><span class="s1">start_locs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] - </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">total_length </span><span class="s2">&lt; </span><span class="s1">length</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">'Cannot generate ridge line according to constraints'</span><span class="s2">)</span>
    <span class="s1">dist_int </span><span class="s2">= </span><span class="s1">length </span><span class="s2">/ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">gap_int </span><span class="s2">= </span><span class="s1">length </span><span class="s2">/ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">nextcol </span><span class="s2">= </span><span class="s1">locs</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">- </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">nextrow </span><span class="s2">= </span><span class="s1">locs</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">- </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">ind </span><span class="s2">% </span><span class="s1">dist_int </span><span class="s2">== </span><span class="s3">0</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">) &gt; </span><span class="s3">0</span><span class="s2">):</span>
            <span class="s1">nextcol </span><span class="s2">+= ((-</span><span class="s3">1</span><span class="s2">)**</span><span class="s1">ind</span><span class="s2">)*</span><span class="s1">distances</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">ind </span><span class="s2">% </span><span class="s1">gap_int </span><span class="s2">== </span><span class="s3">0</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) &gt; </span><span class="s3">0</span><span class="s2">):</span>
            <span class="s1">nextrow </span><span class="s2">+= </span><span class="s1">gaps</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s1">nextrow </span><span class="s2">= </span><span class="s1">keep_bounds</span><span class="s2">(</span><span class="s1">nextrow</span><span class="s2">, </span><span class="s1">max_locs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">nextcol </span><span class="s2">= </span><span class="s1">keep_bounds</span><span class="s2">(</span><span class="s1">nextcol</span><span class="s2">, </span><span class="s1">max_locs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">locs</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">, :] = [</span><span class="s1">nextrow</span><span class="s2">, </span><span class="s1">nextcol</span><span class="s2">]</span>

    <span class="s0">return </span><span class="s2">[</span><span class="s1">locs</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">locs</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">]]</span>


<span class="s0">class </span><span class="s1">TestLocalMaxima1d</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test with empty signal.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">array </span><span class="s0">in </span><span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">array</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_linear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test with linear signal.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">array </span><span class="s0">in </span><span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">array</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test with simple signal.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">50</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s3">2</span><span class="s2">::</span><span class="s3">3</span><span class="s2">] += </span><span class="s3">1</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">array </span><span class="s0">in </span><span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s6"># For plateaus of size 1, the edges are identical with the</span>
            <span class="s6"># midpoints</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">array</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_flat_maxima</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test if flat maxima are detected correctly.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2.99</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">,</span>
                      <span class="s2">-</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">])</span>
        <span class="s1">midpoints</span><span class="s2">, </span><span class="s1">left_edges</span><span class="s2">, </span><span class="s1">right_edges </span><span class="s2">= </span><span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">midpoints</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">18</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">left_edges</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">16</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">right_edges</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">20</span><span class="s2">]))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'x'</span><span class="s2">, [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">5.</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]),</span>
    <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_signal_edges</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test if behavior on signal edges is correct.&quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">array </span><span class="s0">in </span><span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">array</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test input validation and raised exceptions.&quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;wrong number of dimensions&quot;</span><span class="s2">):</span>
            <span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;expected 'const float64_t'&quot;</span><span class="s2">):</span>
            <span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;list&quot;</span><span class="s2">):</span>
            <span class="s1">_local_maxima_1d</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;'x' must not be None&quot;</span><span class="s2">):</span>
            <span class="s1">_local_maxima_1d</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRidgeLines</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_minimal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">] = </span><span class="s3">1</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, </span><span class="s3">10</span><span class="s2">] = </span><span class="s3">1</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_pass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">distances </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">gaps </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">50</span><span class="s2">]) + </span><span class="s3">1e-12</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s3">12</span>
        <span class="s1">line </span><span class="s2">= </span><span class="s1">_gen_ridge_line</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">25</span><span class="s2">], </span><span class="s1">test_matr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">distances</span><span class="s2">, </span><span class="s1">gaps</span><span class="s2">)</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s1">line</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">line</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s3">1</span>
        <span class="s1">max_distances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">))</span>
        <span class="s1">identified_lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">,</span>
                                                 <span class="s1">max_distances</span><span class="s2">,</span>
                                                 <span class="s1">max</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) + </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">identified_lines</span><span class="s2">, [</span><span class="s1">line</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_single_bigdist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">distances </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">gaps </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">50</span><span class="s2">])</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s3">12</span>
        <span class="s1">line </span><span class="s2">= </span><span class="s1">_gen_ridge_line</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">25</span><span class="s2">], </span><span class="s1">test_matr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">distances</span><span class="s2">, </span><span class="s1">gaps</span><span class="s2">)</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s1">line</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">line</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s3">1</span>
        <span class="s1">max_dist </span><span class="s2">= </span><span class="s3">3</span>
        <span class="s1">max_distances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s1">max_dist</span><span class="s2">)</span>
        <span class="s6">#This should get 2 lines, since the distance is too large</span>
        <span class="s1">identified_lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">,</span>
                                                 <span class="s1">max_distances</span><span class="s2">,</span>
                                                 <span class="s1">max</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) + </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">identified_lines</span><span class="s2">) == </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">iline </span><span class="s0">in </span><span class="s1">identified_lines</span><span class="s2">:</span>
            <span class="s1">adists </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">adists</span><span class="s2">), </span><span class="s1">max_dist</span><span class="s2">)</span>

            <span class="s1">agaps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">agaps</span><span class="s2">), </span><span class="s1">max</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) + </span><span class="s3">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_biggap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">distances </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">max_gap </span><span class="s2">= </span><span class="s3">3</span>
        <span class="s1">gaps </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">50</span><span class="s2">])</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s3">12</span>
        <span class="s1">line </span><span class="s2">= </span><span class="s1">_gen_ridge_line</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">25</span><span class="s2">], </span><span class="s1">test_matr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">distances</span><span class="s2">, </span><span class="s1">gaps</span><span class="s2">)</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s1">line</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">line</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s3">1</span>
        <span class="s1">max_dist </span><span class="s2">= </span><span class="s3">6</span>
        <span class="s1">max_distances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s1">max_dist</span><span class="s2">)</span>
        <span class="s6">#This should get 2 lines, since the gap is too large</span>
        <span class="s1">identified_lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">, </span><span class="s1">max_distances</span><span class="s2">, </span><span class="s1">max_gap</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">identified_lines</span><span class="s2">) == </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">iline </span><span class="s0">in </span><span class="s1">identified_lines</span><span class="s2">:</span>
            <span class="s1">adists </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">adists</span><span class="s2">), </span><span class="s1">max_dist</span><span class="s2">)</span>

            <span class="s1">agaps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">agaps</span><span class="s2">), </span><span class="s1">max</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) + </span><span class="s3">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_biggaps</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">distances </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">max_gap </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">gaps </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
        <span class="s1">test_matr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">50</span><span class="s2">, </span><span class="s3">50</span><span class="s2">])</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s3">30</span>
        <span class="s1">line </span><span class="s2">= </span><span class="s1">_gen_ridge_line</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">25</span><span class="s2">], </span><span class="s1">test_matr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">distances</span><span class="s2">, </span><span class="s1">gaps</span><span class="s2">)</span>
        <span class="s1">test_matr</span><span class="s2">[</span><span class="s1">line</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">line</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]] = </span><span class="s3">1</span>
        <span class="s1">max_dist </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">max_distances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">50</span><span class="s2">, </span><span class="s1">max_dist</span><span class="s2">)</span>
        <span class="s6">#This should get 3 lines, since the gaps are too large</span>
        <span class="s1">identified_lines </span><span class="s2">= </span><span class="s1">_identify_ridge_lines</span><span class="s2">(</span><span class="s1">test_matr</span><span class="s2">, </span><span class="s1">max_distances</span><span class="s2">, </span><span class="s1">max_gap</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">identified_lines</span><span class="s2">) == </span><span class="s3">3</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">iline </span><span class="s0">in </span><span class="s1">identified_lines</span><span class="s2">:</span>
            <span class="s1">adists </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">adists</span><span class="s2">), </span><span class="s1">max_dist</span><span class="s2">)</span>

            <span class="s1">agaps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">iline</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">agaps</span><span class="s2">), </span><span class="s1">max</span><span class="s2">(</span><span class="s1">gaps</span><span class="s2">) + </span><span class="s3">0.1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestArgrel</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Regression test for gh-2832.</span>
        <span class="s6"># When there are no relative extrema, make sure that</span>
        <span class="s6"># the number of empty arrays returned matches the</span>
        <span class="s6"># dimension of the input.</span>

        <span class="s1">empty_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>

        <span class="s1">z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">argrelmin</span><span class="s2">(</span><span class="s1">z1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">empty_array</span><span class="s2">)</span>

        <span class="s1">z2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmin</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">empty_array</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">empty_array</span><span class="s2">)</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmin</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">empty_array</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">empty_array</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Note: the docstrings for the argrel{min,max,extrema} functions</span>
        <span class="s6"># do not give a guarantee of the order of the indices, so we'll</span>
        <span class="s6"># sort them before testing.</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmax</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">order </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmax</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">order </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">order </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

        <span class="s1">row</span><span class="s2">, </span><span class="s1">col </span><span class="s2">= </span><span class="s1">argrelmin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">order </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">[</span><span class="s1">order</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_highorder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">order </span><span class="s2">= </span><span class="s3">2</span>
        <span class="s1">sigmas </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">15.0</span><span class="s2">]</span>
        <span class="s1">test_data</span><span class="s2">, </span><span class="s1">act_locs </span><span class="s2">= </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s3">500</span><span class="s2">)</span>
        <span class="s1">test_data</span><span class="s2">[</span><span class="s1">act_locs </span><span class="s2">+ </span><span class="s1">order</span><span class="s2">] = </span><span class="s1">test_data</span><span class="s2">[</span><span class="s1">act_locs</span><span class="s2">]*</span><span class="s3">0.99999</span>
        <span class="s1">test_data</span><span class="s2">[</span><span class="s1">act_locs </span><span class="s2">- </span><span class="s1">order</span><span class="s2">] = </span><span class="s1">test_data</span><span class="s2">[</span><span class="s1">act_locs</span><span class="s2">]*</span><span class="s3">0.99999</span>
        <span class="s1">rel_max_locs </span><span class="s2">= </span><span class="s1">argrelmax</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s1">order</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'clip'</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">rel_max_locs</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">act_locs</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">((</span><span class="s1">rel_max_locs </span><span class="s2">== </span><span class="s1">act_locs</span><span class="s2">).</span><span class="s1">all</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_2d_gaussians</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sigmas </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">]</span>
        <span class="s1">test_data</span><span class="s2">, </span><span class="s1">act_locs </span><span class="s2">= </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
        <span class="s1">rot_factor </span><span class="s2">= </span><span class="s3">20</span>
        <span class="s1">rot_range </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">)) - </span><span class="s1">rot_factor</span>
        <span class="s1">test_data_2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">test_data</span><span class="s2">[</span><span class="s1">rot_range</span><span class="s2">]])</span>
        <span class="s1">rel_max_rows</span><span class="s2">, </span><span class="s1">rel_max_cols </span><span class="s2">= </span><span class="s1">argrelmax</span><span class="s2">(</span><span class="s1">test_data_2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">rw </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">test_data_2</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">inds </span><span class="s2">= (</span><span class="s1">rel_max_rows </span><span class="s2">== </span><span class="s1">rw</span><span class="s2">)</span>

            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">rel_max_cols</span><span class="s2">[</span><span class="s1">inds</span><span class="s2">]) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">act_locs</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">((</span><span class="s1">act_locs </span><span class="s2">== (</span><span class="s1">rel_max_cols</span><span class="s2">[</span><span class="s1">inds</span><span class="s2">] - </span><span class="s1">rot_factor</span><span class="s2">*</span><span class="s1">rw</span><span class="s2">)).</span><span class="s1">all</span><span class="s2">())</span>


<span class="s0">class </span><span class="s1">TestPeakProminences</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test if an empty array is returned if no peaks are provided. 
        &quot;&quot;&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [])</span>
        <span class="s0">for </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">]):</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">([], [])</span>
        <span class="s0">for </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">]):</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test if height of prominences is correctly calculated in signal with 
        rising baseline (peak widths are 1 sample). 
        &quot;&quot;&quot;</span>
        <span class="s6"># Prepare basic signal</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">2.88</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">])</span>
        <span class="s1">peaks </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
        <span class="s1">lbases </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">rbases </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">proms </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">peaks</span><span class="s2">] - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[</span><span class="s1">lbases</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s1">rbases</span><span class="s2">]], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s6"># Test if calculation matches handcrafted result</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">proms</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">lbases</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s1">rbases</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_edge_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test edge cases. 
        &quot;&quot;&quot;</span>
        <span class="s6"># Peaks have same height, prominence and bases</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">peaks </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">proms</span><span class="s2">, </span><span class="s1">lbases</span><span class="s2">, </span><span class="s1">rbases </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">proms</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">lbases</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rbases</span><span class="s2">, [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>

        <span class="s6"># Peaks have same height &amp; prominence but different bases</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">peaks </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">proms</span><span class="s2">, </span><span class="s1">lbases</span><span class="s2">, </span><span class="s1">rbases </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">proms</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">lbases</span><span class="s2">, </span><span class="s1">peaks </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rbases</span><span class="s2">, </span><span class="s1">peaks </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_contiguous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test with non-C-contiguous input arrays. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">([-</span><span class="s3">9</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">peaks </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">proms</span><span class="s2">, </span><span class="s1">lbases</span><span class="s2">, </span><span class="s1">rbases </span><span class="s2">= </span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">], </span><span class="s1">peaks</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">proms</span><span class="s2">, [</span><span class="s3">9</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">lbases</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rbases</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_wlen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test if wlen actually shrinks the evaluation range correctly. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">peak </span><span class="s2">= [</span><span class="s3">3</span><span class="s2">]</span>
        <span class="s6"># Test rounding behavior of wlen</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peak</span><span class="s2">), [</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">wlen</span><span class="s2">, </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">7</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peak</span><span class="s2">, </span><span class="s1">wlen</span><span class="s2">), [</span><span class="s3">3. </span><span class="s2">- </span><span class="s1">i</span><span class="s2">, </span><span class="s3">0 </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">, </span><span class="s3">6 </span><span class="s2">- </span><span class="s1">i</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that exceptions and warnings are raised. 
        &quot;&quot;&quot;</span>
        <span class="s6"># x with dimension &gt; 1</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s6"># peaks with dimension &gt; 1</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
        <span class="s6"># x with dimension &lt; 1</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">,])</span>

        <span class="s6"># empty x with supplied</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'not a valid index'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">([], [</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s6"># invalid indices with non-empty x</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[-</span><span class="s3">100</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'not a valid index'</span><span class="s2">):</span>
                <span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s1">p</span><span class="s2">])</span>

        <span class="s6"># peaks is not cast-able to np.intp</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'cannot safely cast'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.3</span><span class="s2">])</span>

        <span class="s6"># wlen &lt; 3</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'wlen'</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], </span><span class="s1">wlen</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_warnings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that appropriate warnings are raised. 
        &quot;&quot;&quot;</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;some peaks have a prominence of 0&quot;</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PeakPropertyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s1">p</span><span class="s2">,])</span>
        <span class="s0">with </span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PeakPropertyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">peak_prominences</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], </span><span class="s1">wlen</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPeakWidths</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test if an empty array is returned if no peaks are provided. 
        &quot;&quot;&quot;</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">peak_widths</span><span class="s2">([], [])[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">peak_widths</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [])[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">peak_widths</span><span class="s2">([], [])</span>
        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">out</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:some peaks have a width of 0&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test a simple use case with easy to verify results at different relative 
        heights. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">prominence </span><span class="s2">= </span><span class="s3">2</span>
        <span class="s0">for </span><span class="s1">rel_height</span><span class="s2">, </span><span class="s1">width_true</span><span class="s2">, </span><span class="s1">lip_true</span><span class="s2">, </span><span class="s1">rip_true </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">),  </span><span class="s6"># raises warning</span>
            <span class="s2">(</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">6.</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">6.</span><span class="s2">)</span>
        <span class="s2">]:</span>
            <span class="s1">width_calc</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">lip_calc</span><span class="s2">, </span><span class="s1">rip_calc </span><span class="s2">= </span><span class="s1">peak_widths</span><span class="s2">(</span>
                <span class="s1">x</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">], </span><span class="s1">rel_height</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">width_calc</span><span class="s2">, </span><span class="s1">width_true</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">height</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">- </span><span class="s1">rel_height </span><span class="s2">* </span><span class="s1">prominence</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">lip_calc</span><span class="s2">, </span><span class="s1">lip_true</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rip_calc</span><span class="s2">, </span><span class="s1">rip_true</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_contiguous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test with non-C-contiguous input arrays. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">50</span><span class="s2">], </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">peaks </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">([</span><span class="s3">1</span><span class="s2">], </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[::</span><span class="s3">4</span><span class="s2">], </span><span class="s1">peaks</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, [</span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">75</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that argument validation works as intended. 
        &quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s6"># x with dimension &gt; 1</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">3</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s6"># x with dimension &lt; 1</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s6"># peaks with dimension &gt; 1</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'1-D array'</span><span class="s2">):</span>
            <span class="s6"># peaks with dimension &lt; 1</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'not a valid index'</span><span class="s2">):</span>
            <span class="s6"># peak pos exceeds x.size</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">11</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'not a valid index'</span><span class="s2">):</span>
            <span class="s6"># empty x with peaks supplied</span>
            <span class="s1">peak_widths</span><span class="s2">([], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'cannot safely cast'</span><span class="s2">):</span>
            <span class="s6"># peak cannot be safely casted to intp</span>
            <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), [</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.3</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'rel_height'</span><span class="s2">):</span>
            <span class="s6"># rel_height is &lt; 0</span>
            <span class="s1">peak_widths</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">rel_height</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'None'</span><span class="s2">):</span>
            <span class="s6"># prominence data contains None</span>
            <span class="s1">peak_widths</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">prominence_data</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_warnings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that appropriate warnings are raised. 
        &quot;&quot;&quot;</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;some peaks have a width of 0&quot;</span>
        <span class="s0">with </span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PeakPropertyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s6"># Case: rel_height is 0</span>
            <span class="s1">peak_widths</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">rel_height</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PeakPropertyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s6"># Case: prominence is 0 and bases are identical</span>
            <span class="s1">peak_widths</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">],</span>
                <span class="s1">prominence_data</span><span class="s2">=(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                                 <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">),</span>
                                 <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">))</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mismatching_prominence_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test with mismatching peak and / or prominence data.&quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">peak </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">prominences</span><span class="s2">, </span><span class="s1">left_bases</span><span class="s2">, </span><span class="s1">right_bases</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">([</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">,), (-</span><span class="s3">1</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">,)),  </span><span class="s6"># left base not in x</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">,), (</span><span class="s3">0</span><span class="s2">,), (</span><span class="s3">3</span><span class="s2">,)),  </span><span class="s6"># right base not in x</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">,), (</span><span class="s3">0</span><span class="s2">,)),  </span><span class="s6"># swapped bases same as peak</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)),  </span><span class="s6"># array shapes don't match peaks</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">,)),  </span><span class="s6"># arrays with different shapes</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">,), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">,)),  </span><span class="s6"># arrays with different shapes</span>
            <span class="s2">((</span><span class="s3">1.</span><span class="s2">,), (</span><span class="s3">0</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))  </span><span class="s6"># arrays with different shapes</span>
        <span class="s2">]):</span>
            <span class="s6"># Make sure input is matches output of signal.peak_prominences</span>
            <span class="s1">prominence_data </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">prominences</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                               <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">left_bases</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">),</span>
                               <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">right_bases</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">))</span>
            <span class="s6"># Test for correct exception</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s3">3</span><span class="s2">:</span>
                <span class="s1">match </span><span class="s2">= </span><span class="s5">&quot;prominence data is invalid for peak&quot;</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">match </span><span class="s2">= </span><span class="s5">&quot;arrays in `prominence_data` must have the same shape&quot;</span>
            <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
                <span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peak</span><span class="s2">, </span><span class="s1">prominence_data</span><span class="s2">=</span><span class="s1">prominence_data</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:some peaks have a width of 0&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_intersection_rules</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Test if x == eval_height counts as an intersection.&quot;&quot;&quot;</span>
        <span class="s6"># Flatt peak with two possible intersection points if evaluated at 1</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s6"># relative height is 0 -&gt; width is 0 as well, raises warning</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">=[</span><span class="s3">5</span><span class="s2">], </span><span class="s1">rel_height</span><span class="s2">=</span><span class="s3">0</span><span class="s2">),</span>
                        <span class="s2">[(</span><span class="s3">0.</span><span class="s2">,), (</span><span class="s3">3.</span><span class="s2">,), (</span><span class="s3">5.</span><span class="s2">,), (</span><span class="s3">5.</span><span class="s2">,)])</span>
        <span class="s6"># width_height == x counts as intersection -&gt; nearest 1 is chosen</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">peak_widths</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">=[</span><span class="s3">5</span><span class="s2">], </span><span class="s1">rel_height</span><span class="s2">=</span><span class="s3">2</span><span class="s2">/</span><span class="s3">3</span><span class="s2">),</span>
                        <span class="s2">[(</span><span class="s3">4.</span><span class="s2">,), (</span><span class="s3">1.</span><span class="s2">,), (</span><span class="s3">3.</span><span class="s2">,), (</span><span class="s3">7.</span><span class="s2">,)])</span>


<span class="s0">def </span><span class="s1">test_unpack_condition_args</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot; 
    Verify parsing of condition arguments for `scipy.signal.find_peaks` function. 
    &quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">amin_true </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">amax_true </span><span class="s2">= </span><span class="s1">amin_true </span><span class="s2">+ </span><span class="s3">10</span>
    <span class="s1">peaks </span><span class="s2">= </span><span class="s1">amin_true</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">]</span>

    <span class="s6"># Test unpacking with None or interval</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == </span><span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == </span><span class="s1">_unpack_condition_args</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == </span><span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">) == </span><span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">) == </span><span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4.5</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">))</span>

    <span class="s6"># Test if borders are correctly reduced with `peaks`</span>
    <span class="s1">amin_calc</span><span class="s2">, </span><span class="s1">amax_calc </span><span class="s2">= </span><span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s1">amin_true</span><span class="s2">, </span><span class="s1">amax_true</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">peaks</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">amin_calc</span><span class="s2">, </span><span class="s1">amin_true</span><span class="s2">[</span><span class="s1">peaks</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">amax_calc</span><span class="s2">, </span><span class="s1">amax_true</span><span class="s2">[</span><span class="s1">peaks</span><span class="s2">])</span>

    <span class="s6"># Test raises if array borders don't match x</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;array size of lower&quot;</span><span class="s2">):</span>
        <span class="s1">_unpack_condition_args</span><span class="s2">(</span><span class="s1">amin_true</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">), </span><span class="s1">peaks</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;array size of upper&quot;</span><span class="s2">):</span>
        <span class="s1">_unpack_condition_args</span><span class="s2">((</span><span class="s0">None</span><span class="s2">, </span><span class="s1">amin_true</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">), </span><span class="s1">peaks</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFindPeaks</span><span class="s2">:</span>

    <span class="s6"># Keys of optionally returned properties</span>
    <span class="s1">property_keys </span><span class="s2">= {</span><span class="s5">'peak_heights'</span><span class="s2">, </span><span class="s5">'left_thresholds'</span><span class="s2">, </span><span class="s5">'right_thresholds'</span><span class="s2">,</span>
                     <span class="s5">'prominences'</span><span class="s2">, </span><span class="s5">'left_bases'</span><span class="s2">, </span><span class="s5">'right_bases'</span><span class="s2">, </span><span class="s5">'widths'</span><span class="s2">,</span>
                     <span class="s5">'width_heights'</span><span class="s2">, </span><span class="s5">'left_ips'</span><span class="s2">, </span><span class="s5">'right_ips'</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test behavior for signal without local maxima. 
        &quot;&quot;&quot;</span>
        <span class="s1">open_interval </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">),</span>
                                  <span class="s1">height</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">,</span>
                                  <span class="s1">prominence</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">, </span><span class="s1">width</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">property_keys</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_plateau_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test plateau size condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s6"># Prepare signal with peaks with peak_height == plateau_size</span>
        <span class="s1">plateau_sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">111</span><span class="s2">])</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">plateau_sizes</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">plateau_sizes</span>
        <span class="s1">repeats </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">repeats</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">)</span>

        <span class="s6"># Test full output</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">plateau_size</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">18</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;plateau_sizes&quot;</span><span class="s2">], </span><span class="s1">plateau_sizes</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;left_edges&quot;</span><span class="s2">], </span><span class="s1">peaks </span><span class="s2">- (</span><span class="s1">plateau_sizes </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) // </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;right_edges&quot;</span><span class="s2">], </span><span class="s1">peaks </span><span class="s2">+ </span><span class="s1">plateau_sizes </span><span class="s2">// </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s6"># Test conditions</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">plateau_size</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">11</span><span class="s2">, </span><span class="s3">18</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">plateau_size</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">plateau_size</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">50</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">18</span><span class="s2">, </span><span class="s3">33</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_height_condition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test height condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= (</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'peak_heights'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_threshold_condition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test threshold condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'left_thresholds'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'right_thresholds'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s3">3.5</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>

    <span class="s0">def </span><span class="s1">test_distance_condition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test distance condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s6"># Peaks of different height with constant distance 3</span>
        <span class="s1">peaks_all </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">21</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">21</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s1">peaks_all</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">peaks_all</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>

        <span class="s6"># Test if peaks with &quot;minimal&quot; distance are still selected (distance = 3)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">distance</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">peaks_all</span><span class="s2">)</span>

        <span class="s6"># Select every second peak (distance &gt; 3)</span>
        <span class="s1">peaks_subset </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">distance</span><span class="s2">=</span><span class="s3">3.0001</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s6"># Test if peaks_subset is subset of peaks_all</span>
        <span class="s1">assert_</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">setdiff1d</span><span class="s2">(</span><span class="s1">peaks_subset</span><span class="s2">, </span><span class="s1">peaks_all</span><span class="s2">, </span><span class="s1">assume_unique</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">size </span><span class="s2">== </span><span class="s3">0</span>
        <span class="s2">)</span>
        <span class="s6"># Test if every second peak was removed</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">peaks_subset</span><span class="s2">), </span><span class="s3">6</span><span class="s2">)</span>

        <span class="s6"># Test priority of peak removal</span>
        <span class="s1">x </span><span class="s2">= [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">peaks_subset </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">distance</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]  </span><span class="s6"># use distance &gt; x size</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">peaks_subset</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s3">1 </span><span class="s0">and </span><span class="s1">peaks_subset</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_prominence_condition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test prominence condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
        <span class="s1">peaks_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">99</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">peaks_true</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s1">peaks_true</span><span class="s2">] += </span><span class="s1">offset</span>
        <span class="s1">prominences </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">peaks_true</span><span class="s2">] - </span><span class="s1">x</span><span class="s2">[</span><span class="s1">peaks_true </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">interval </span><span class="s2">= (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">)</span>
        <span class="s1">keep </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s1">interval</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] &lt;= </span><span class="s1">prominences</span><span class="s2">) &amp; (</span><span class="s1">prominences </span><span class="s2">&lt;= </span><span class="s1">interval</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]))</span>

        <span class="s1">peaks_calc</span><span class="s2">, </span><span class="s1">properties </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">prominence</span><span class="s2">=</span><span class="s1">interval</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks_calc</span><span class="s2">, </span><span class="s1">peaks_true</span><span class="s2">[</span><span class="s1">keep</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">[</span><span class="s5">'prominences'</span><span class="s2">], </span><span class="s1">prominences</span><span class="s2">[</span><span class="s1">keep</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">[</span><span class="s5">'left_bases'</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">[</span><span class="s5">'right_bases'</span><span class="s2">], </span><span class="s1">peaks_true</span><span class="s2">[</span><span class="s1">keep</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_width_condition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test width condition for peaks. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">width</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">rel_height</span><span class="s2">=</span><span class="s3">0.75</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, </span><span class="s3">7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'widths'</span><span class="s2">], </span><span class="s3">1.35</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'width_heights'</span><span class="s2">], </span><span class="s3">1.</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'left_ips'</span><span class="s2">], </span><span class="s3">6.4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">'right_ips'</span><span class="s2">], </span><span class="s3">7.75</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_properties</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test returned properties. 
        &quot;&quot;&quot;</span>
        <span class="s1">open_interval </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span>
                                  <span class="s1">height</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">,</span>
                                  <span class="s1">prominence</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">, </span><span class="s1">width</span><span class="s2">=</span><span class="s1">open_interval</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">props</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">property_keys</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">property_keys</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">props</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">size</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test exceptions raised by function. 
        &quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;1-D array&quot;</span><span class="s2">):</span>
            <span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;1-D array&quot;</span><span class="s2">):</span>
            <span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)))</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">):</span>
            <span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">distance</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:some peaks have a prominence of 0&quot;</span><span class="s2">,</span>
                                <span class="s5">&quot;ignore:some peaks have a width of 0&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_wlen_smaller_plateau</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test behavior of prominence and width calculation if the given window 
        length is smaller than a peak's plateau size. 
 
        Regression test for gh-9110. 
        &quot;&quot;&quot;</span>
        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">prominence</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                                  <span class="s1">width</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">wlen</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;prominences&quot;</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;widths&quot;</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s5">&quot;width_heights&quot;</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s2">(</span><span class="s5">&quot;left_bases&quot;</span><span class="s2">, </span><span class="s5">&quot;right_bases&quot;</span><span class="s2">, </span><span class="s5">&quot;left_ips&quot;</span><span class="s2">, </span><span class="s5">&quot;right_ips&quot;</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">peaks</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;kwargs&quot;</span><span class="s2">, [</span>
        <span class="s2">{},</span>
        <span class="s2">{</span><span class="s5">&quot;distance&quot;</span><span class="s2">: </span><span class="s3">3.0</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;prominence&quot;</span><span class="s2">: (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)},</span>
        <span class="s2">{</span><span class="s5">&quot;width&quot;</span><span class="s2">: (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)},</span>

    <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_readonly_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Test readonly arrays are accepted. 
        &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">15</span><span class="s2">)</span>
        <span class="s1">x_readonly </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">x_readonly</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">peaks</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">peaks_readonly</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">find_peaks</span><span class="s2">(</span><span class="s1">x_readonly</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">peaks</span><span class="s2">, </span><span class="s1">peaks_readonly</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFindPeaksCwt</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_exact</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Generate a series of gaussians and attempt to find the peak locations. 
        &quot;&quot;&quot;</span>
        <span class="s1">sigmas </span><span class="s2">= [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">20.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">50.0</span><span class="s2">]</span>
        <span class="s1">num_points </span><span class="s2">= </span><span class="s3">500</span>
        <span class="s1">test_data</span><span class="s2">, </span><span class="s1">act_locs </span><span class="s2">= </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">num_points</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">))</span>
        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">gap_thresh</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">min_snr</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
                                         <span class="s1">min_length</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">found_locs</span><span class="s2">, </span><span class="s1">act_locs</span><span class="s2">,</span>
                        <span class="s5">&quot;Found maximum locations did not equal those expected&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_withnoise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that peak locations are (approximately) found 
        for a series of gaussians with added noise. 
        &quot;&quot;&quot;</span>
        <span class="s1">sigmas </span><span class="s2">= [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">20.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">50.0</span><span class="s2">]</span>
        <span class="s1">num_points </span><span class="s2">= </span><span class="s3">500</span>
        <span class="s1">test_data</span><span class="s2">, </span><span class="s1">act_locs </span><span class="s2">= </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">num_points</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">))</span>
        <span class="s1">noise_amp </span><span class="s2">= </span><span class="s3">0.07</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">18181911</span><span class="s2">)</span>
        <span class="s1">test_data </span><span class="s2">+= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">num_points</span><span class="s2">) - </span><span class="s3">0.5</span><span class="s2">)*(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">noise_amp</span><span class="s2">)</span>
        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">min_length</span><span class="s2">=</span><span class="s3">15</span><span class="s2">,</span>
                                         <span class="s1">gap_thresh</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">min_snr</span><span class="s2">=</span><span class="s1">noise_amp </span><span class="s2">/ </span><span class="s3">5</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">found_locs</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">act_locs</span><span class="s2">), </span><span class="s5">'Different number' </span><span class="s2">+</span>
                                <span class="s5">'of peaks found than expected'</span><span class="s2">)</span>
        <span class="s1">diffs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">found_locs </span><span class="s2">- </span><span class="s1">act_locs</span><span class="s2">)</span>
        <span class="s1">max_diffs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">) / </span><span class="s3">5</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">diffs</span><span class="s2">, </span><span class="s1">max_diffs</span><span class="s2">, </span><span class="s5">'Maximum location differed' </span><span class="s2">+</span>
                                     <span class="s5">'by more than %s' </span><span class="s2">% (</span><span class="s1">max_diffs</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_nopeak</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that no peak is found in 
        data that's just noise. 
        &quot;&quot;&quot;</span>
        <span class="s1">noise_amp </span><span class="s2">= </span><span class="s3">1.0</span>
        <span class="s1">num_points </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">181819141</span><span class="s2">)</span>
        <span class="s1">test_data </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">num_points</span><span class="s2">) - </span><span class="s3">0.5</span><span class="s2">)*(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">noise_amp</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">50</span><span class="s2">)</span>
        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">min_snr</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">noise_perc</span><span class="s2">=</span><span class="s3">30</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">found_locs</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_with_non_default_wavelets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">gaussian</span><span class="s2">(</span><span class="s3">200</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">wavelet</span><span class="s2">=</span><span class="s1">gaussian</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">100</span><span class="s2">]), </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_window_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that window_size is passed correctly to private function and 
        affects the result. 
        &quot;&quot;&quot;</span>
        <span class="s1">sigmas </span><span class="s2">= [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]</span>
        <span class="s1">num_points </span><span class="s2">= </span><span class="s3">1000</span>
        <span class="s1">test_data</span><span class="s2">, </span><span class="s1">act_locs </span><span class="s2">= </span><span class="s1">_gen_gaussians_even</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">, </span><span class="s1">num_points</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">sigmas</span><span class="s2">), </span><span class="s3">0.2</span><span class="s2">)</span>
        <span class="s1">noise_amp </span><span class="s2">= </span><span class="s3">0.05</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">18181911</span><span class="s2">)</span>
        <span class="s1">test_data </span><span class="s2">+= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">num_points</span><span class="s2">) - </span><span class="s3">0.5</span><span class="s2">)*(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">noise_amp</span><span class="s2">)</span>

        <span class="s6"># Possibly contrived negative region to throw off peak finding</span>
        <span class="s6"># when window_size is too large</span>
        <span class="s1">test_data</span><span class="s2">[</span><span class="s3">250</span><span class="s2">:</span><span class="s3">320</span><span class="s2">] -= </span><span class="s3">1</span>

        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">gap_thresh</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">min_snr</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
                                    <span class="s1">min_length</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">window_size</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">found_locs</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">act_locs</span><span class="s2">.</span><span class="s1">size</span>

        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">, </span><span class="s1">gap_thresh</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">min_snr</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
                                    <span class="s1">min_length</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">window_size</span><span class="s2">=</span><span class="s3">20</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">found_locs</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">act_locs</span><span class="s2">.</span><span class="s1">size</span>

    <span class="s0">def </span><span class="s1">test_find_peaks_with_one_width</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Verify that the `width` argument 
        in `find_peaks_cwt` can be a float 
        &quot;&quot;&quot;</span>
        <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">)</span>
        <span class="s1">test_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">)</span>
        <span class="s1">widths </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">found_locs </span><span class="s2">= </span><span class="s1">find_peaks_cwt</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">widths</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">found_locs</span><span class="s2">, </span><span class="s3">32</span><span class="s2">)</span>
</pre>
</body>
</html>