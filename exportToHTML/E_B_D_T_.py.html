<html>
<head>
<title>E_B_D_T_.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
E_B_D_T_.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc </span><span class="s0">import </span><span class="s1">sstruct</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">textTools </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">bytechr</span><span class="s2">,</span>
    <span class="s1">byteord</span><span class="s2">,</span>
    <span class="s1">bytesjoin</span><span class="s2">,</span>
    <span class="s1">strjoin</span><span class="s2">,</span>
    <span class="s1">safeEval</span><span class="s2">,</span>
    <span class="s1">readHex</span><span class="s2">,</span>
    <span class="s1">hexStr</span><span class="s2">,</span>
    <span class="s1">deHexStr</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">BitmapGlyphMetrics </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BigGlyphMetrics</span><span class="s2">,</span>
    <span class="s1">bigGlyphMetricsFormat</span><span class="s2">,</span>
    <span class="s1">SmallGlyphMetrics</span><span class="s2">,</span>
    <span class="s1">smallGlyphMetricsFormat</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">DefaultTable</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">logging</span>


<span class="s1">log </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>

<span class="s1">ebdtTableVersionFormat </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
    &gt; # big endian 
    version: 16.16F 
&quot;&quot;&quot;</span>

<span class="s1">ebdtComponentFormat </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
    &gt; # big endian 
    glyphCode: H 
    xOffset:   b 
    yOffset:   b 
&quot;&quot;&quot;</span>


<span class="s0">class </span><span class="s1">table_E_B_D_T_</span><span class="s2">(</span><span class="s1">DefaultTable</span><span class="s2">.</span><span class="s1">DefaultTable</span><span class="s2">):</span>
    <span class="s4"># Keep a reference to the name of the data locator table.</span>
    <span class="s1">locatorName </span><span class="s2">= </span><span class="s3">&quot;EBLC&quot;</span>

    <span class="s4"># This method can be overridden in subclasses to support new formats</span>
    <span class="s4"># without changing the other implementation. Also can be used as a</span>
    <span class="s4"># convenience method for coverting a font file to an alternative format.</span>
    <span class="s0">def </span><span class="s1">getImageFormatClass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">imageFormat</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ebdt_bitmap_classes</span><span class="s2">[</span><span class="s1">imageFormat</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s4"># Get the version but don't advance the slice.</span>
        <span class="s4"># Most of the lookup for this table is done relative</span>
        <span class="s4"># to the begining so slice by the offsets provided</span>
        <span class="s4"># in the EBLC table.</span>
        <span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">ebdtTableVersionFormat</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>

        <span class="s4"># Keep a dict of glyphs that have been seen so they aren't remade.</span>
        <span class="s4"># This dict maps intervals of data to the BitmapGlyph.</span>
        <span class="s1">glyphDict </span><span class="s2">= {}</span>

        <span class="s4"># Pull out the EBLC table and loop through glyphs.</span>
        <span class="s4"># A strike is a concept that spans both tables.</span>
        <span class="s4"># The actual bitmap data is stored in the EBDT.</span>
        <span class="s1">locator </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">locatorName</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">curStrike </span><span class="s0">in </span><span class="s1">locator</span><span class="s2">.</span><span class="s1">strikes</span><span class="s2">:</span>
            <span class="s1">bitmapGlyphDict </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bitmapGlyphDict</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">indexSubTable </span><span class="s0">in </span><span class="s1">curStrike</span><span class="s2">.</span><span class="s1">indexSubTables</span><span class="s2">:</span>
                <span class="s1">dataIter </span><span class="s2">= </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">indexSubTable</span><span class="s2">.</span><span class="s1">names</span><span class="s2">, </span><span class="s1">indexSubTable</span><span class="s2">.</span><span class="s1">locations</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">curName</span><span class="s2">, </span><span class="s1">curLoc </span><span class="s0">in </span><span class="s1">dataIter</span><span class="s2">:</span>
                    <span class="s4"># Don't create duplicate data entries for the same glyphs.</span>
                    <span class="s4"># Instead just use the structures that already exist if they exist.</span>
                    <span class="s0">if </span><span class="s1">curLoc </span><span class="s0">in </span><span class="s1">glyphDict</span><span class="s2">:</span>
                        <span class="s1">curGlyph </span><span class="s2">= </span><span class="s1">glyphDict</span><span class="s2">[</span><span class="s1">curLoc</span><span class="s2">]</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">curGlyphData </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">slice</span><span class="s2">(*</span><span class="s1">curLoc</span><span class="s2">)]</span>
                        <span class="s1">imageFormatClass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getImageFormatClass</span><span class="s2">(</span>
                            <span class="s1">indexSubTable</span><span class="s2">.</span><span class="s1">imageFormat</span>
                        <span class="s2">)</span>
                        <span class="s1">curGlyph </span><span class="s2">= </span><span class="s1">imageFormatClass</span><span class="s2">(</span><span class="s1">curGlyphData</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
                        <span class="s1">glyphDict</span><span class="s2">[</span><span class="s1">curLoc</span><span class="s2">] = </span><span class="s1">curGlyph</span>
                    <span class="s1">bitmapGlyphDict</span><span class="s2">[</span><span class="s1">curName</span><span class="s2">] = </span><span class="s1">curGlyph</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">dataList </span><span class="s2">= []</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">ebdtTableVersionFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">))</span>
        <span class="s1">dataSize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dataList</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>

        <span class="s4"># Keep a dict of glyphs that have been seen so they aren't remade.</span>
        <span class="s4"># This dict maps the id of the BitmapGlyph to the interval</span>
        <span class="s4"># in the data.</span>
        <span class="s1">glyphDict </span><span class="s2">= {}</span>

        <span class="s4"># Go through the bitmap glyph data. Just in case the data for a glyph</span>
        <span class="s4"># changed the size metrics should be recalculated. There are a variety</span>
        <span class="s4"># of formats and they get stored in the EBLC table. That is why</span>
        <span class="s4"># recalculation is defered to the EblcIndexSubTable class and just</span>
        <span class="s4"># pass what is known about bitmap glyphs from this particular table.</span>
        <span class="s1">locator </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">locatorName</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">curStrike</span><span class="s2">, </span><span class="s1">curGlyphDict </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">locator</span><span class="s2">.</span><span class="s1">strikes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">curIndexSubTable </span><span class="s0">in </span><span class="s1">curStrike</span><span class="s2">.</span><span class="s1">indexSubTables</span><span class="s2">:</span>
                <span class="s1">dataLocations </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">curName </span><span class="s0">in </span><span class="s1">curIndexSubTable</span><span class="s2">.</span><span class="s1">names</span><span class="s2">:</span>
                    <span class="s4"># Handle the data placement based on seeing the glyph or not.</span>
                    <span class="s4"># Just save a reference to the location if the glyph has already</span>
                    <span class="s4"># been saved in compile. This code assumes that glyphs will only</span>
                    <span class="s4"># be referenced multiple times from indexFormat5. By luck the</span>
                    <span class="s4"># code may still work when referencing poorly ordered fonts with</span>
                    <span class="s4"># duplicate references. If there is a font that is unlucky the</span>
                    <span class="s4"># respective compile methods for the indexSubTables will fail</span>
                    <span class="s4"># their assertions. All fonts seem to follow this assumption.</span>
                    <span class="s4"># More complicated packing may be needed if a counter-font exists.</span>
                    <span class="s1">glyph </span><span class="s2">= </span><span class="s1">curGlyphDict</span><span class="s2">[</span><span class="s1">curName</span><span class="s2">]</span>
                    <span class="s1">objectId </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">glyph</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">objectId </span><span class="s0">not in </span><span class="s1">glyphDict</span><span class="s2">:</span>
                        <span class="s1">data </span><span class="s2">= </span><span class="s1">glyph</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">ttFont</span><span class="s2">)</span>
                        <span class="s1">data </span><span class="s2">= </span><span class="s1">curIndexSubTable</span><span class="s2">.</span><span class="s1">padBitmapData</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                        <span class="s1">startByte </span><span class="s2">= </span><span class="s1">dataSize</span>
                        <span class="s1">dataSize </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                        <span class="s1">endByte </span><span class="s2">= </span><span class="s1">dataSize</span>
                        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                        <span class="s1">dataLoc </span><span class="s2">= (</span><span class="s1">startByte</span><span class="s2">, </span><span class="s1">endByte</span><span class="s2">)</span>
                        <span class="s1">glyphDict</span><span class="s2">[</span><span class="s1">objectId</span><span class="s2">] = </span><span class="s1">dataLoc</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">dataLoc </span><span class="s2">= </span><span class="s1">glyphDict</span><span class="s2">[</span><span class="s1">objectId</span><span class="s2">]</span>
                    <span class="s1">dataLocations</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">dataLoc</span><span class="s2">)</span>
                <span class="s4"># Just use the new data locations in the indexSubTable.</span>
                <span class="s4"># The respective compile implementations will take care</span>
                <span class="s4"># of any of the problems in the convertion that may arise.</span>
                <span class="s1">curIndexSubTable</span><span class="s2">.</span><span class="s1">locations </span><span class="s2">= </span><span class="s1">dataLocations</span>

        <span class="s0">return </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">dataList</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s4"># When exporting to XML if one of the data export formats</span>
        <span class="s4"># requires metrics then those metrics may be in the locator.</span>
        <span class="s4"># In this case populate the bitmaps with &quot;export metrics&quot;.</span>
        <span class="s0">if </span><span class="s1">ttFont</span><span class="s2">.</span><span class="s1">bitmapGlyphDataFormat </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;row&quot;</span><span class="s2">, </span><span class="s3">&quot;bitwise&quot;</span><span class="s2">):</span>
            <span class="s1">locator </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">locatorName</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">curStrike</span><span class="s2">, </span><span class="s1">curGlyphDict </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">locator</span><span class="s2">.</span><span class="s1">strikes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">curIndexSubTable </span><span class="s0">in </span><span class="s1">curStrike</span><span class="s2">.</span><span class="s1">indexSubTables</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">curName </span><span class="s0">in </span><span class="s1">curIndexSubTable</span><span class="s2">.</span><span class="s1">names</span><span class="s2">:</span>
                        <span class="s1">glyph </span><span class="s2">= </span><span class="s1">curGlyphDict</span><span class="s2">[</span><span class="s1">curName</span><span class="s2">]</span>
                        <span class="s4"># I'm not sure which metrics have priority here.</span>
                        <span class="s4"># For now if both metrics exist go with glyph metrics.</span>
                        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">glyph</span><span class="s2">, </span><span class="s3">&quot;metrics&quot;</span><span class="s2">):</span>
                            <span class="s1">glyph</span><span class="s2">.</span><span class="s1">exportMetrics </span><span class="s2">= </span><span class="s1">glyph</span><span class="s2">.</span><span class="s1">metrics</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">glyph</span><span class="s2">.</span><span class="s1">exportMetrics </span><span class="s2">= </span><span class="s1">curIndexSubTable</span><span class="s2">.</span><span class="s1">metrics</span>
                        <span class="s1">glyph</span><span class="s2">.</span><span class="s1">exportBitDepth </span><span class="s2">= </span><span class="s1">curStrike</span><span class="s2">.</span><span class="s1">bitmapSizeTable</span><span class="s2">.</span><span class="s1">bitDepth</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s3">&quot;header&quot;</span><span class="s2">, [(</span><span class="s3">&quot;version&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)])</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">locator </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">locatorName</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">bitmapGlyphDict </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">):</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s3">&quot;strikedata&quot;</span><span class="s2">, [(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">strikeIndex</span><span class="s2">)])</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">curName</span><span class="s2">, </span><span class="s1">curBitmap </span><span class="s0">in </span><span class="s1">bitmapGlyphDict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">curBitmap</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">curName</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;strikedata&quot;</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;header&quot;</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">version </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;version&quot;</span><span class="s2">])</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;strikedata&quot;</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">&quot;strikeData&quot;</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData </span><span class="s2">= []</span>
            <span class="s1">strikeIndex </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;index&quot;</span><span class="s2">])</span>

            <span class="s1">bitmapGlyphDict </span><span class="s2">= {}</span>
            <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
                <span class="s0">if </span><span class="s1">name</span><span class="s2">[</span><span class="s5">4</span><span class="s2">:].</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">_bitmapGlyphSubclassPrefix</span><span class="s2">[</span><span class="s5">4</span><span class="s2">:]):</span>
                    <span class="s1">imageFormat </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">name</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">_bitmapGlyphSubclassPrefix</span><span class="s2">) :])</span>
                    <span class="s1">glyphName </span><span class="s2">= </span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;name&quot;</span><span class="s2">]</span>
                    <span class="s1">imageFormatClass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getImageFormatClass</span><span class="s2">(</span><span class="s1">imageFormat</span><span class="s2">)</span>
                    <span class="s1">curGlyph </span><span class="s2">= </span><span class="s1">imageFormatClass</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                    <span class="s1">curGlyph</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
                    <span class="s0">assert </span><span class="s1">glyphName </span><span class="s0">not in </span><span class="s1">bitmapGlyphDict</span><span class="s2">, (</span>
                        <span class="s3">&quot;Duplicate glyphs with the same name '%s' in the same strike.&quot;</span>
                        <span class="s2">% </span><span class="s1">glyphName</span>
                    <span class="s2">)</span>
                    <span class="s1">bitmapGlyphDict</span><span class="s2">[</span><span class="s1">glyphName</span><span class="s2">] = </span><span class="s1">curGlyph</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;%s being ignored by %s&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>

            <span class="s4"># Grow the strike data array to the appropriate size. The XML</span>
            <span class="s4"># format allows the strike index value to be out of order.</span>
            <span class="s0">if </span><span class="s1">strikeIndex </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData </span><span class="s2">+= [</span><span class="s0">None</span><span class="s2">] * (</span><span class="s1">strikeIndex </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">- </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">[</span><span class="s1">strikeIndex</span><span class="s2">] </span><span class="s0">is None</span>
            <span class="s2">), </span><span class="s3">&quot;Duplicate strike EBDT indices.&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">strikeData</span><span class="s2">[</span><span class="s1">strikeIndex</span><span class="s2">] = </span><span class="s1">bitmapGlyphDict</span>


<span class="s0">class </span><span class="s1">EbdtComponent</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s3">&quot;ebdtComponent&quot;</span><span class="s2">, [(</span><span class="s3">&quot;name&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)])</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">componentName </span><span class="s0">in </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">getformat</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">1</span><span class="s2">:]:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">componentName</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">componentName</span><span class="s2">))</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;ebdtComponent&quot;</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;name&quot;</span><span class="s2">]</span>
        <span class="s1">componentNames </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">getformat</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">1</span><span class="s2">:])</span>
        <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">componentNames</span><span class="s2">:</span>
                <span class="s1">vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;unknown name '%s' being ignored by EbdtComponent.&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>


<span class="s4"># Helper functions for dealing with binary.</span>


<span class="s0">def </span><span class="s1">_data2binary</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">numBits</span><span class="s2">):</span>
    <span class="s1">binaryList </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">curByte </span><span class="s0">in </span><span class="s1">data</span><span class="s2">:</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">byteord</span><span class="s2">(</span><span class="s1">curByte</span><span class="s2">)</span>
        <span class="s1">numBitsCut </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s5">8</span><span class="s2">, </span><span class="s1">numBits</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numBitsCut</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s5">0x1</span><span class="s2">:</span>
                <span class="s1">binaryList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;1&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">binaryList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">&quot;0&quot;</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value </span><span class="s2">&gt;&gt; </span><span class="s5">1</span>
        <span class="s1">numBits </span><span class="s2">-= </span><span class="s1">numBitsCut</span>
    <span class="s0">return </span><span class="s1">strjoin</span><span class="s2">(</span><span class="s1">binaryList</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_binary2data</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">):</span>
    <span class="s1">byteList </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">bitLoc </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">), </span><span class="s5">8</span><span class="s2">):</span>
        <span class="s1">byteString </span><span class="s2">= </span><span class="s1">binary</span><span class="s2">[</span><span class="s1">bitLoc </span><span class="s2">: </span><span class="s1">bitLoc </span><span class="s2">+ </span><span class="s5">8</span><span class="s2">]</span>
        <span class="s1">curByte </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s0">for </span><span class="s1">curBit </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">byteString</span><span class="s2">):</span>
            <span class="s1">curByte </span><span class="s2">= </span><span class="s1">curByte </span><span class="s2">&lt;&lt; </span><span class="s5">1</span>
            <span class="s0">if </span><span class="s1">curBit </span><span class="s2">== </span><span class="s3">&quot;1&quot;</span><span class="s2">:</span>
                <span class="s1">curByte </span><span class="s2">|= </span><span class="s5">1</span>
        <span class="s1">byteList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bytechr</span><span class="s2">(</span><span class="s1">curByte</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">byteList</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_memoize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s0">class </span><span class="s1">memodict</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__missing__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">int</span><span class="s2">) </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) == </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">ret</span>
            <span class="s0">return </span><span class="s1">ret</span>

    <span class="s0">return </span><span class="s1">memodict</span><span class="s2">().</span><span class="s1">__getitem__</span>


<span class="s4"># 00100111 -&gt; 11100100 per byte, not to be confused with little/big endian.</span>
<span class="s4"># Bitmap data per byte is in the order that binary is written on the page</span>
<span class="s4"># with the least significant bit as far right as possible. This is the</span>
<span class="s4"># opposite of what makes sense algorithmically and hence this function.</span>
<span class="s2">@</span><span class="s1">_memoize</span>
<span class="s0">def </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">):</span>
    <span class="s6">r&quot;&quot;&quot; 
    &gt;&gt;&gt; bin(ord(_reverseBytes(0b00100111))) 
    '0b11100100' 
    &gt;&gt;&gt; _reverseBytes(b'\x00\xf0') 
    b'\x00\x0f' 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) != </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">_reverseBytes</span><span class="s2">, </span><span class="s1">data</span><span class="s2">))</span>
    <span class="s1">byte </span><span class="s2">= </span><span class="s1">byteord</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">8</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">result </span><span class="s2">&lt;&lt; </span><span class="s5">1</span>
        <span class="s1">result </span><span class="s2">|= </span><span class="s1">byte </span><span class="s2">&amp; </span><span class="s5">1</span>
        <span class="s1">byte </span><span class="s2">= </span><span class="s1">byte </span><span class="s2">&gt;&gt; </span><span class="s5">1</span>
    <span class="s0">return </span><span class="s1">bytechr</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>


<span class="s4"># This section of code is for reading and writing image data to/from XML.</span>


<span class="s0">def </span><span class="s1">_writeRawImageData</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s3">&quot;rawimagedata&quot;</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">dumphex</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;rawimagedata&quot;</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_readRawImageData</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">readHex</span><span class="s2">(</span><span class="s1">content</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_writeRowImageData</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">metrics </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportMetrics</span>
    <span class="s0">del </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportMetrics</span>
    <span class="s1">bitDepth </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportBitDepth</span>
    <span class="s0">del </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportBitDepth</span>

    <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span>
        <span class="s3">&quot;rowimagedata&quot;</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">width</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span>
    <span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">curRow </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span><span class="s2">):</span>
        <span class="s1">rowData </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">getRow</span><span class="s2">(</span><span class="s1">curRow</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s3">&quot;row&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">hexStr</span><span class="s2">(</span><span class="s1">rowData</span><span class="s2">))</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;rowimagedata&quot;</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_readRowImageData</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">bitDepth </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;bitDepth&quot;</span><span class="s2">])</span>
    <span class="s1">metrics </span><span class="s2">= </span><span class="s1">SmallGlyphMetrics</span><span class="s2">()</span>
    <span class="s1">metrics</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;width&quot;</span><span class="s2">])</span>
    <span class="s1">metrics</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;height&quot;</span><span class="s2">])</span>

    <span class="s1">dataRows </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s0">continue</span>
        <span class="s1">name</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
        <span class="s4"># Chop off 'imagedata' from the tag to get just the option.</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;row&quot;</span><span class="s2">:</span>
            <span class="s1">dataRows</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">deHexStr</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">]))</span>
    <span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">setRows</span><span class="s2">(</span><span class="s1">dataRows</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_writeBitwiseImageData</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">metrics </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportMetrics</span>
    <span class="s0">del </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportMetrics</span>
    <span class="s1">bitDepth </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportBitDepth</span>
    <span class="s0">del </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">exportBitDepth</span>

    <span class="s4"># A dict for mapping binary to more readable/artistic ASCII characters.</span>
    <span class="s1">binaryConv </span><span class="s2">= {</span><span class="s3">&quot;0&quot;</span><span class="s2">: </span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s3">&quot;1&quot;</span><span class="s2">: </span><span class="s3">&quot;@&quot;</span><span class="s2">}</span>

    <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span>
        <span class="s3">&quot;bitwiseimagedata&quot;</span><span class="s2">,</span>
        <span class="s1">bitDepth</span><span class="s2">=</span><span class="s1">bitDepth</span><span class="s2">,</span>
        <span class="s1">width</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">width</span><span class="s2">,</span>
        <span class="s1">height</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">curRow </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span><span class="s2">):</span>
        <span class="s1">rowData </span><span class="s2">= </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">getRow</span><span class="s2">(</span>
            <span class="s1">curRow</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">rowData </span><span class="s2">= </span><span class="s1">_data2binary</span><span class="s2">(</span><span class="s1">rowData</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)</span>
        <span class="s4"># Make the output a readable ASCII art form.</span>
        <span class="s1">rowData </span><span class="s2">= </span><span class="s1">strjoin</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">binaryConv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">, </span><span class="s1">rowData</span><span class="s2">))</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s3">&quot;row&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">rowData</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;bitwiseimagedata&quot;</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_readBitwiseImageData</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">bitDepth </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;bitDepth&quot;</span><span class="s2">])</span>
    <span class="s1">metrics </span><span class="s2">= </span><span class="s1">SmallGlyphMetrics</span><span class="s2">()</span>
    <span class="s1">metrics</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;width&quot;</span><span class="s2">])</span>
    <span class="s1">metrics</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;height&quot;</span><span class="s2">])</span>

    <span class="s4"># A dict for mapping from ASCII to binary. All characters are considered</span>
    <span class="s4"># a '1' except space, period and '0' which maps to '0'.</span>
    <span class="s1">binaryConv </span><span class="s2">= {</span><span class="s3">&quot; &quot;</span><span class="s2">: </span><span class="s3">&quot;0&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">: </span><span class="s3">&quot;0&quot;</span><span class="s2">, </span><span class="s3">&quot;0&quot;</span><span class="s2">: </span><span class="s3">&quot;0&quot;</span><span class="s2">}</span>

    <span class="s1">dataRows </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s0">continue</span>
        <span class="s1">name</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;row&quot;</span><span class="s2">:</span>
            <span class="s1">mapParams </span><span class="s2">= </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">], </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s3">&quot;1&quot;</span><span class="s2">))</span>
            <span class="s1">rowData </span><span class="s2">= </span><span class="s1">strjoin</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">starmap</span><span class="s2">(</span><span class="s1">binaryConv</span><span class="s2">.</span><span class="s1">get</span><span class="s2">, </span><span class="s1">mapParams</span><span class="s2">))</span>
            <span class="s1">dataRows</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">_binary2data</span><span class="s2">(</span><span class="s1">rowData</span><span class="s2">))</span>

    <span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">setRows</span><span class="s2">(</span>
        <span class="s1">dataRows</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s1">metrics</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_writeExtFileImageData</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">folder </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">.</span><span class="s1">file</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
        <span class="s4"># fall back to current directory if output file's directory isn't found</span>
        <span class="s1">folder </span><span class="s2">= </span><span class="s3">&quot;.&quot;</span>
    <span class="s1">folder </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">, </span><span class="s3">&quot;bitmaps&quot;</span><span class="s2">)</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">glyphName </span><span class="s2">+ </span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">fileExtension</span>
    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">):</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">)</span>
    <span class="s1">folder </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">, </span><span class="s3">&quot;strike%d&quot; </span><span class="s2">% </span><span class="s1">strikeIndex</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">):</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">)</span>

    <span class="s1">fullPath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s3">&quot;extfileimagedata&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">fullPath</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fullPath</span><span class="s2">, </span><span class="s3">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s1">file</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_readExtFileImageData</span><span class="s2">(</span><span class="s1">bitmapObject</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
    <span class="s1">fullPath </span><span class="s2">= </span><span class="s1">attrs</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fullPath</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s1">bitmapObject</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>


<span class="s4"># End of XML writing code.</span>

<span class="s4"># Important information about the naming scheme. Used for identifying formats</span>
<span class="s4"># in XML.</span>
<span class="s1">_bitmapGlyphSubclassPrefix </span><span class="s2">= </span><span class="s3">&quot;ebdt_bitmap_format_&quot;</span>


<span class="s0">class </span><span class="s1">BitmapGlyph</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s4"># For the external file format. This can be changed in subclasses. This way</span>
    <span class="s4"># when the extfile option is turned on files have the form: glyphName.ext</span>
    <span class="s4"># The default is just a flat binary file with no meaning.</span>
    <span class="s1">fileExtension </span><span class="s2">= </span><span class="s3">&quot;.bin&quot;</span>

    <span class="s4"># Keep track of reading and writing of various forms.</span>
    <span class="s1">xmlDataFunctions </span><span class="s2">= {</span>
        <span class="s3">&quot;raw&quot;</span><span class="s2">: (</span><span class="s1">_writeRawImageData</span><span class="s2">, </span><span class="s1">_readRawImageData</span><span class="s2">),</span>
        <span class="s3">&quot;row&quot;</span><span class="s2">: (</span><span class="s1">_writeRowImageData</span><span class="s2">, </span><span class="s1">_readRowImageData</span><span class="s2">),</span>
        <span class="s3">&quot;bitwise&quot;</span><span class="s2">: (</span><span class="s1">_writeBitwiseImageData</span><span class="s2">, </span><span class="s1">_readBitwiseImageData</span><span class="s2">),</span>
        <span class="s3">&quot;extfile&quot;</span><span class="s2">: (</span><span class="s1">_writeExtFileImageData</span><span class="s2">, </span><span class="s1">_readExtFileImageData</span><span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ttFont </span><span class="s2">= </span><span class="s1">ttFont</span>
        <span class="s4"># TODO Currently non-lazy decompilation is untested here...</span>
        <span class="s4"># if not ttFont.lazy:</span>
        <span class="s4">#   self.decompile()</span>
        <span class="s4">#   del self.data</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s4"># Allow lazy decompile.</span>
        <span class="s0">if </span><span class="s1">attr</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">] == </span><span class="s3">&quot;__&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">attr </span><span class="s2">== </span><span class="s3">&quot;data&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">()</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">ensureDecompiled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">recurse</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">()</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s4"># Not a fan of this but it is needed for safer safety checking.</span>
    <span class="s0">def </span><span class="s1">getFormat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">_bitmapGlyphSubclassPrefix</span><span class="s2">) :])</span>

    <span class="s0">def </span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, [(</span><span class="s3">&quot;name&quot;</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">)])</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeMetrics</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
        <span class="s4"># Use the internal write method to write using the correct output format.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">readMetrics</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s1">name</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
            <span class="s0">if not </span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">&quot;imagedata&quot;</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s4"># Chop off 'imagedata' from the tag to get just the option.</span>
            <span class="s1">option </span><span class="s2">= </span><span class="s1">name</span><span class="s2">[: -</span><span class="s1">len</span><span class="s2">(</span><span class="s3">&quot;imagedata&quot;</span><span class="s2">)]</span>
            <span class="s0">assert </span><span class="s1">option </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">xmlDataFunctions</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">readData</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>

    <span class="s4"># Some of the glyphs have the metrics. This allows for metrics to be</span>
    <span class="s4"># added if the glyph format has them. Default behavior is to do nothing.</span>
    <span class="s0">def </span><span class="s1">writeMetrics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s4"># The opposite of write metrics.</span>
    <span class="s0">def </span><span class="s1">readMetrics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">writeFunc</span><span class="s2">, </span><span class="s1">readFunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">xmlDataFunctions</span><span class="s2">[</span>
                <span class="s1">ttFont</span><span class="s2">.</span><span class="s1">bitmapGlyphDataFormat</span>
            <span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s1">writeFunc </span><span class="s2">= </span><span class="s1">_writeRawImageData</span>
        <span class="s1">writeFunc</span><span class="s2">(</span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">readData</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s4"># Chop off 'imagedata' from the tag to get just the option.</span>
        <span class="s1">option </span><span class="s2">= </span><span class="s1">name</span><span class="s2">[: -</span><span class="s1">len</span><span class="s2">(</span><span class="s3">&quot;imagedata&quot;</span><span class="s2">)]</span>
        <span class="s1">writeFunc</span><span class="s2">, </span><span class="s1">readFunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">xmlDataFunctions</span><span class="s2">[</span><span class="s1">option</span><span class="s2">]</span>
        <span class="s1">readFunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>


<span class="s4"># A closure for creating a mixin for the two types of metrics handling.</span>
<span class="s4"># Most of the code is very similar so its easier to deal with here.</span>
<span class="s4"># Everything works just by passing the class that the mixin is for.</span>
<span class="s0">def </span><span class="s1">_createBitmapPlusMetricsMixin</span><span class="s2">(</span><span class="s1">metricsClass</span><span class="s2">):</span>
    <span class="s4"># Both metrics names are listed here to make meaningful error messages.</span>
    <span class="s1">metricStrings </span><span class="s2">= [</span><span class="s1">BigGlyphMetrics</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">SmallGlyphMetrics</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">]</span>
    <span class="s1">curMetricsName </span><span class="s2">= </span><span class="s1">metricsClass</span><span class="s2">.</span><span class="s1">__name__</span>
    <span class="s4"># Find which metrics this is for and determine the opposite name.</span>
    <span class="s1">metricsId </span><span class="s2">= </span><span class="s1">metricStrings</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">curMetricsName</span><span class="s2">)</span>
    <span class="s1">oppositeMetricsName </span><span class="s2">= </span><span class="s1">metricStrings</span><span class="s2">[</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">metricsId</span><span class="s2">]</span>

    <span class="s0">class </span><span class="s1">BitmapPlusMetricsMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">writeMetrics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">readMetrics</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
                <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">curMetricsName</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">metricsClass</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s1">oppositeMetricsName</span><span class="s2">:</span>
                    <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                        <span class="s3">&quot;Warning: %s being ignored in format %d.&quot;</span><span class="s2">,</span>
                        <span class="s1">oppositeMetricsName</span><span class="s2">,</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">getFormat</span><span class="s2">(),</span>
                    <span class="s2">)</span>

    <span class="s0">return </span><span class="s1">BitmapPlusMetricsMixin</span>


<span class="s4"># Since there are only two types of mixin's just create them here.</span>
<span class="s1">BitmapPlusBigMetricsMixin </span><span class="s2">= </span><span class="s1">_createBitmapPlusMetricsMixin</span><span class="s2">(</span><span class="s1">BigGlyphMetrics</span><span class="s2">)</span>
<span class="s1">BitmapPlusSmallMetricsMixin </span><span class="s2">= </span><span class="s1">_createBitmapPlusMetricsMixin</span><span class="s2">(</span><span class="s1">SmallGlyphMetrics</span><span class="s2">)</span>


<span class="s4"># Data that is bit aligned can be tricky to deal with. These classes implement</span>
<span class="s4"># helper functionality for dealing with the data and getting a particular row</span>
<span class="s4"># of bitwise data. Also helps implement fancy data export/import in XML.</span>
<span class="s0">class </span><span class="s1">BitAlignedBitmapMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_getBitRange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">):</span>
        <span class="s1">rowBits </span><span class="s2">= </span><span class="s1">bitDepth </span><span class="s2">* </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">bitOffset </span><span class="s2">= </span><span class="s1">row </span><span class="s2">* </span><span class="s1">rowBits</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">bitOffset</span><span class="s2">, </span><span class="s1">bitOffset </span><span class="s2">+ </span><span class="s1">rowBits</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getRow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">metrics </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">metrics </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span>
        <span class="s0">assert </span><span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">row </span><span class="s0">and </span><span class="s1">row </span><span class="s2">&lt; </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span><span class="s2">, </span><span class="s3">&quot;Illegal row access in bitmap&quot;</span>

        <span class="s4"># Loop through each byte. This can cover two bytes in the original data or</span>
        <span class="s4"># a single byte if things happen to be aligned. The very last entry might</span>
        <span class="s4"># not be aligned so take care to trim the binary data to size and pad with</span>
        <span class="s4"># zeros in the row data. Bit aligned data is somewhat tricky.</span>
        <span class="s4">#</span>
        <span class="s4"># Example of data cut. Data cut represented in x's.</span>
        <span class="s4"># '|' represents byte boundary.</span>
        <span class="s4"># data = ...0XX|XXXXXX00|000... =&gt; XXXXXXXX</span>
        <span class="s4">#       or</span>
        <span class="s4"># data = ...0XX|XXXX0000|000... =&gt; XXXXXX00</span>
        <span class="s4">#   or</span>
        <span class="s4"># data = ...000|XXXXXXXX|000... =&gt; XXXXXXXX</span>
        <span class="s4">#   or</span>
        <span class="s4"># data = ...000|00XXXX00|000... =&gt; XXXX0000</span>
        <span class="s4">#</span>
        <span class="s1">dataList </span><span class="s2">= []</span>
        <span class="s1">bitRange </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getBitRange</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">stepRange </span><span class="s2">= </span><span class="s1">bitRange </span><span class="s2">+ (</span><span class="s5">8</span><span class="s2">,)</span>
        <span class="s0">for </span><span class="s1">curBit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(*</span><span class="s1">stepRange</span><span class="s2">):</span>
            <span class="s1">endBit </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">curBit </span><span class="s2">+ </span><span class="s5">8</span><span class="s2">, </span><span class="s1">bitRange</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
            <span class="s1">numBits </span><span class="s2">= </span><span class="s1">endBit </span><span class="s2">- </span><span class="s1">curBit</span>
            <span class="s1">cutPoint </span><span class="s2">= </span><span class="s1">curBit </span><span class="s2">% </span><span class="s5">8</span>
            <span class="s1">firstByteLoc </span><span class="s2">= </span><span class="s1">curBit </span><span class="s2">// </span><span class="s5">8</span>
            <span class="s1">secondByteLoc </span><span class="s2">= </span><span class="s1">endBit </span><span class="s2">// </span><span class="s5">8</span>
            <span class="s0">if </span><span class="s1">firstByteLoc </span><span class="s2">&lt; </span><span class="s1">secondByteLoc</span><span class="s2">:</span>
                <span class="s1">numBitsCut </span><span class="s2">= </span><span class="s5">8 </span><span class="s2">- </span><span class="s1">cutPoint</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">numBitsCut </span><span class="s2">= </span><span class="s1">endBit </span><span class="s2">- </span><span class="s1">curBit</span>
            <span class="s1">curByte </span><span class="s2">= </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">[</span><span class="s1">firstByteLoc</span><span class="s2">])</span>
            <span class="s1">firstHalf </span><span class="s2">= </span><span class="s1">byteord</span><span class="s2">(</span><span class="s1">curByte</span><span class="s2">) &gt;&gt; </span><span class="s1">cutPoint</span>
            <span class="s1">firstHalf </span><span class="s2">= ((</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">numBitsCut</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">) &amp; </span><span class="s1">firstHalf</span>
            <span class="s1">newByte </span><span class="s2">= </span><span class="s1">firstHalf</span>
            <span class="s0">if </span><span class="s1">firstByteLoc </span><span class="s2">&lt; </span><span class="s1">secondByteLoc </span><span class="s0">and </span><span class="s1">secondByteLoc </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">):</span>
                <span class="s1">curByte </span><span class="s2">= </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">[</span><span class="s1">secondByteLoc</span><span class="s2">])</span>
                <span class="s1">secondHalf </span><span class="s2">= </span><span class="s1">byteord</span><span class="s2">(</span><span class="s1">curByte</span><span class="s2">) &lt;&lt; </span><span class="s1">numBitsCut</span>
                <span class="s1">newByte </span><span class="s2">= (</span><span class="s1">firstHalf </span><span class="s2">| </span><span class="s1">secondHalf</span><span class="s2">) &amp; ((</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">numBits</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bytechr</span><span class="s2">(</span><span class="s1">newByte</span><span class="s2">))</span>

        <span class="s4"># The way the data is kept is opposite the algorithm used.</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">dataList</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">reverseBytes</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">setRows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dataRows</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">metrics </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">metrics </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span>
        <span class="s0">if not </span><span class="s1">reverseBytes</span><span class="s2">:</span>
            <span class="s1">dataRows </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">_reverseBytes</span><span class="s2">, </span><span class="s1">dataRows</span><span class="s2">))</span>

        <span class="s4"># Keep track of a list of ordinal values as they are easier to modify</span>
        <span class="s4"># than a list of strings. Map to actual strings later.</span>
        <span class="s1">numBytes </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getBitRange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">dataRows</span><span class="s2">), </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">] + </span><span class="s5">7</span><span class="s2">) // </span><span class="s5">8</span>
        <span class="s1">ordDataList </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">] * </span><span class="s1">numBytes</span>
        <span class="s0">for </span><span class="s1">row</span><span class="s2">, </span><span class="s1">data </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">dataRows</span><span class="s2">):</span>
            <span class="s1">bitRange </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getBitRange</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">)</span>
            <span class="s1">stepRange </span><span class="s2">= </span><span class="s1">bitRange </span><span class="s2">+ (</span><span class="s5">8</span><span class="s2">,)</span>
            <span class="s0">for </span><span class="s1">curBit</span><span class="s2">, </span><span class="s1">curByte </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(*</span><span class="s1">stepRange</span><span class="s2">), </span><span class="s1">data</span><span class="s2">):</span>
                <span class="s1">endBit </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">curBit </span><span class="s2">+ </span><span class="s5">8</span><span class="s2">, </span><span class="s1">bitRange</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
                <span class="s1">cutPoint </span><span class="s2">= </span><span class="s1">curBit </span><span class="s2">% </span><span class="s5">8</span>
                <span class="s1">firstByteLoc </span><span class="s2">= </span><span class="s1">curBit </span><span class="s2">// </span><span class="s5">8</span>
                <span class="s1">secondByteLoc </span><span class="s2">= </span><span class="s1">endBit </span><span class="s2">// </span><span class="s5">8</span>
                <span class="s0">if </span><span class="s1">firstByteLoc </span><span class="s2">&lt; </span><span class="s1">secondByteLoc</span><span class="s2">:</span>
                    <span class="s1">numBitsCut </span><span class="s2">= </span><span class="s5">8 </span><span class="s2">- </span><span class="s1">cutPoint</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">numBitsCut </span><span class="s2">= </span><span class="s1">endBit </span><span class="s2">- </span><span class="s1">curBit</span>
                <span class="s1">curByte </span><span class="s2">= </span><span class="s1">byteord</span><span class="s2">(</span><span class="s1">curByte</span><span class="s2">)</span>
                <span class="s1">firstByte </span><span class="s2">= </span><span class="s1">curByte </span><span class="s2">&amp; ((</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">numBitsCut</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">ordDataList</span><span class="s2">[</span><span class="s1">firstByteLoc</span><span class="s2">] |= </span><span class="s1">firstByte </span><span class="s2">&lt;&lt; </span><span class="s1">cutPoint</span>
                <span class="s0">if </span><span class="s1">firstByteLoc </span><span class="s2">&lt; </span><span class="s1">secondByteLoc </span><span class="s0">and </span><span class="s1">secondByteLoc </span><span class="s2">&lt; </span><span class="s1">numBytes</span><span class="s2">:</span>
                    <span class="s1">secondByte </span><span class="s2">= (</span><span class="s1">curByte </span><span class="s2">&gt;&gt; </span><span class="s1">numBitsCut</span><span class="s2">) &amp; ((</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s5">8 </span><span class="s2">- </span><span class="s1">numBitsCut</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">)</span>
                    <span class="s1">ordDataList</span><span class="s2">[</span><span class="s1">secondByteLoc</span><span class="s2">] |= </span><span class="s1">secondByte</span>

        <span class="s4"># Save the image data with the bits going the correct way.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">bytechr</span><span class="s2">, </span><span class="s1">ordDataList</span><span class="s2">)))</span>


<span class="s0">class </span><span class="s1">ByteAlignedBitmapMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_getByteRange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">):</span>
        <span class="s1">rowBytes </span><span class="s2">= (</span><span class="s1">bitDepth </span><span class="s2">* </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">width </span><span class="s2">+ </span><span class="s5">7</span><span class="s2">) // </span><span class="s5">8</span>
        <span class="s1">byteOffset </span><span class="s2">= </span><span class="s1">row </span><span class="s2">* </span><span class="s1">rowBytes</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">byteOffset</span><span class="s2">, </span><span class="s1">byteOffset </span><span class="s2">+ </span><span class="s1">rowBytes</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getRow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">metrics </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">metrics </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span>
        <span class="s0">assert </span><span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">row </span><span class="s0">and </span><span class="s1">row </span><span class="s2">&lt; </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">height</span><span class="s2">, </span><span class="s3">&quot;Illegal row access in bitmap&quot;</span>
        <span class="s1">byteRange </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_getByteRange</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span><span class="s2">[</span><span class="s1">slice</span><span class="s2">(*</span><span class="s1">byteRange</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">reverseBytes</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">_reverseBytes</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">setRows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dataRows</span><span class="s2">, </span><span class="s1">bitDepth</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metrics</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">reverseBytes</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">metrics </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">metrics </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span>
        <span class="s0">if </span><span class="s1">reverseBytes</span><span class="s2">:</span>
            <span class="s1">dataRows </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">_reverseBytes</span><span class="s2">, </span><span class="s1">dataRows</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">dataRows</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_1</span><span class="s2">(</span>
    <span class="s1">ByteAlignedBitmapMixin</span><span class="s2">, </span><span class="s1">BitmapPlusSmallMetricsMixin</span><span class="s2">, </span><span class="s1">BitmapGlyph</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">SmallGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_2</span><span class="s2">(</span>
    <span class="s1">BitAlignedBitmapMixin</span><span class="s2">, </span><span class="s1">BitmapPlusSmallMetricsMixin</span><span class="s2">, </span><span class="s1">BitmapGlyph</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">SmallGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_5</span><span class="s2">(</span><span class="s1">BitAlignedBitmapMixin</span><span class="s2">, </span><span class="s1">BitmapGlyph</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_6</span><span class="s2">(</span>
    <span class="s1">ByteAlignedBitmapMixin</span><span class="s2">, </span><span class="s1">BitmapPlusBigMetricsMixin</span><span class="s2">, </span><span class="s1">BitmapGlyph</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">BigGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_7</span><span class="s2">(</span>
    <span class="s1">BitAlignedBitmapMixin</span><span class="s2">, </span><span class="s1">BitmapPlusBigMetricsMixin</span><span class="s2">, </span><span class="s1">BitmapGlyph</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">BigGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">imageData </span><span class="s2">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">imageData</span>


<span class="s0">class </span><span class="s1">ComponentBitmapGlyph</span><span class="s2">(</span><span class="s1">BitmapGlyph</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strikeIndex</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, [(</span><span class="s3">&quot;name&quot;</span><span class="s2">, </span><span class="s1">glyphName</span><span class="s2">)])</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeMetrics</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s3">&quot;components&quot;</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">curComponent </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">:</span>
            <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s3">&quot;components&quot;</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">readMetrics</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s1">name</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;components&quot;</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">compElement </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
                    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">compElement</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                        <span class="s0">continue</span>
                    <span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">compElement</span>
                    <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;ebdtComponent&quot;</span><span class="s2">:</span>
                        <span class="s1">curComponent </span><span class="s2">= </span><span class="s1">EbdtComponent</span><span class="s2">()</span>
                        <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;'%s' being ignored in component array.&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_8</span><span class="s2">(</span><span class="s1">BitmapPlusSmallMetricsMixin</span><span class="s2">, </span><span class="s1">ComponentBitmapGlyph</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">SmallGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>

        <span class="s2">(</span><span class="s1">numComponents</span><span class="s2">,) = </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&gt;H&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numComponents</span><span class="s2">):</span>
            <span class="s1">curComponent </span><span class="s2">= </span><span class="s1">EbdtComponent</span><span class="s2">()</span>
            <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">curComponent</span><span class="s2">)</span>
            <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ttFont</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">.</span><span class="s1">glyphCode</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">dataList </span><span class="s2">= []</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">smallGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">))</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\0</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">&quot;&gt;H&quot;</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">)))</span>
        <span class="s0">for </span><span class="s1">curComponent </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">:</span>
            <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">glyphCode </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">, </span><span class="s1">curComponent</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">dataList</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ebdt_bitmap_format_9</span><span class="s2">(</span><span class="s1">BitmapPlusBigMetricsMixin</span><span class="s2">, </span><span class="s1">ComponentBitmapGlyph</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metrics </span><span class="s2">= </span><span class="s1">BigGlyphMetrics</span><span class="s2">()</span>
        <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">numComponents</span><span class="s2">,) = </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&gt;H&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numComponents</span><span class="s2">):</span>
            <span class="s1">curComponent </span><span class="s2">= </span><span class="s1">EbdtComponent</span><span class="s2">()</span>
            <span class="s1">dummy</span><span class="s2">, </span><span class="s1">data </span><span class="s2">= </span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">unpack2</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">curComponent</span><span class="s2">)</span>
            <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ttFont</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">.</span><span class="s1">glyphCode</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ttFont</span><span class="s2">):</span>
        <span class="s1">dataList </span><span class="s2">= []</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">bigGlyphMetricsFormat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">))</span>
        <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">&quot;&gt;H&quot;</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">)))</span>
        <span class="s0">for </span><span class="s1">curComponent </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">componentArray</span><span class="s2">:</span>
            <span class="s1">curComponent</span><span class="s2">.</span><span class="s1">glyphCode </span><span class="s2">= </span><span class="s1">ttFont</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">curComponent</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">dataList</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sstruct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s1">ebdtComponentFormat</span><span class="s2">, </span><span class="s1">curComponent</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">dataList</span><span class="s2">)</span>


<span class="s4"># Dictionary of bitmap formats to the class representing that format</span>
<span class="s4"># currently only the ones listed in this map are the ones supported.</span>
<span class="s1">ebdt_bitmap_classes </span><span class="s2">= {</span>
    <span class="s5">1</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_1</span><span class="s2">,</span>
    <span class="s5">2</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_2</span><span class="s2">,</span>
    <span class="s5">5</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_5</span><span class="s2">,</span>
    <span class="s5">6</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_6</span><span class="s2">,</span>
    <span class="s5">7</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_7</span><span class="s2">,</span>
    <span class="s5">8</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_8</span><span class="s2">,</span>
    <span class="s5">9</span><span class="s2">: </span><span class="s1">ebdt_bitmap_format_9</span><span class="s2">,</span>
<span class="s2">}</span>
</pre>
</body>
</html>