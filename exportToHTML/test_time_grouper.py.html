<html>
<head>
<title>test_time_grouper.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_time_grouper.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">operator </span><span class="s0">import </span><span class="s1">methodcaller</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">.</span><span class="s1">grouper </span><span class="s0">import </span><span class="s1">Grouper</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">indexes</span><span class="s2">.</span><span class="s1">datetimes </span><span class="s0">import </span><span class="s1">date_range</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">test_series</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s3">1000</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;1/1/2000&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply</span><span class="s2">(</span><span class="s1">test_series</span><span class="s2">):</span>
    <span class="s1">grouper </span><span class="s2">= </span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;YE&quot;</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">)</span>

    <span class="s1">grouped </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">grouper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">()[-</span><span class="s3">3</span><span class="s2">:]</span>

    <span class="s1">applied </span><span class="s2">= </span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">year</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">applied</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">applied</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">droplevel</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">droplevel</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">applied</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_count</span><span class="s2">(</span><span class="s1">test_series</span><span class="s2">):</span>
    <span class="s1">test_series</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">year</span><span class="s2">).</span><span class="s1">count</span><span class="s2">()</span>

    <span class="s1">grouper </span><span class="s2">= </span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;YE&quot;</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">grouper</span><span class="s2">).</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s4">&quot;YE&quot;</span><span class="s2">).</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_numpy_reduction</span><span class="s2">(</span><span class="s1">test_series</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s4">&quot;YE&quot;</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;right&quot;</span><span class="s2">).</span><span class="s1">prod</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;using SeriesGroupBy.prod&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">test_series</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">year</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_iteration</span><span class="s2">():</span>
    <span class="s5"># #2300</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s3">1000</span>
    <span class="s1">ind </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;open&quot;</span><span class="s2">: </span><span class="s3">1</span><span class="s2">, </span><span class="s4">&quot;close&quot;</span><span class="s2">: </span><span class="s3">2</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">ind</span><span class="s2">)</span>
    <span class="s1">tg </span><span class="s2">= </span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;ME&quot;</span><span class="s2">)</span>

    <span class="s1">grouper</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">tg</span><span class="s2">.</span><span class="s1">_get_grouper</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># Errors</span>
    <span class="s1">grouped </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">grouper</span><span class="s2">, </span><span class="s1">group_keys</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">df</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;close&quot;</span><span class="s2">] / </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;open&quot;</span><span class="s2">]</span>

    <span class="s5"># it works!</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;index&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">Index</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]),</span>
        <span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]),</span>
        <span class="s1">Index</span><span class="s2">([</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.2</span><span class="s2">]),</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">]]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fails_on_no_datetime_index</span><span class="s2">(</span><span class="s1">index</span><span class="s2">):</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">index</span><span class="s2">).</span><span class="s1">__name__</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">index</span><span class="s2">))}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only valid with DatetimeIndex, TimedeltaIndex &quot;</span>
        <span class="s4">f&quot;or PeriodIndex, but got an instance of '</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">'&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_aaa_group_order</span><span class="s2">():</span>
    <span class="s5"># GH 12840</span>
    <span class="s5"># check TimeGrouper perform stable sorts</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">20</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">),</span>
    <span class="s2">] * </span><span class="s3">4</span>
    <span class="s1">grouped </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">get_group</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)), </span><span class="s1">df</span><span class="s2">[::</span><span class="s3">5</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">get_group</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)), </span><span class="s1">df</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">5</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">get_group</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)), </span><span class="s1">df</span><span class="s2">[</span><span class="s3">2</span><span class="s2">::</span><span class="s3">5</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">get_group</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)), </span><span class="s1">df</span><span class="s2">[</span><span class="s3">3</span><span class="s2">::</span><span class="s3">5</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">grouped</span><span class="s2">.</span><span class="s1">get_group</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)), </span><span class="s1">df</span><span class="s2">[</span><span class="s3">4</span><span class="s2">::</span><span class="s3">5</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_aggregate_normal</span><span class="s2">(</span><span class="s1">resample_method</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check TimeGrouper's aggregation is identical as normal groupby.&quot;&quot;&quot;</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s3">20</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">normal_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">normal_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">] * </span><span class="s3">4</span>

    <span class="s1">dt_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = </span><span class="s1">Index</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s2">* </span><span class="s3">4</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">normal_grouped </span><span class="s2">= </span><span class="s1">normal_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">dt_grouped </span><span class="s2">= </span><span class="s1">dt_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">normal_grouped</span><span class="s2">, </span><span class="s1">resample_method</span><span class="s2">)()</span>
    <span class="s1">dt_result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dt_grouped</span><span class="s2">, </span><span class="s1">resample_method</span><span class="s2">)()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;2013-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dt_result</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;if TimeGrouper is used included, 'nth' doesn't work yet&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_aggregate_nth</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check TimeGrouper's aggregation is identical as normal groupby.&quot;&quot;&quot;</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s3">20</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">normal_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">normal_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">] * </span><span class="s3">4</span>

    <span class="s1">dt_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">),</span>
    <span class="s2">] * </span><span class="s3">4</span>

    <span class="s1">normal_grouped </span><span class="s2">= </span><span class="s1">normal_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">dt_grouped </span><span class="s2">= </span><span class="s1">dt_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">normal_grouped</span><span class="s2">.</span><span class="s1">nth</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;2013-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">dt_result </span><span class="s2">= </span><span class="s1">dt_grouped</span><span class="s2">.</span><span class="s1">nth</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dt_result</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;method, method_args, unit&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {}, </span><span class="s3">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">}, </span><span class="s3">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {}, </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">}, </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_resample_entirely_nat_window</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">method_args</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">0</span><span class="s2">] * </span><span class="s3">2 </span><span class="s2">+ [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2017&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">methodcaller</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, **</span><span class="s1">method_args</span><span class="s2">)(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s4">&quot;2d&quot;</span><span class="s2">))</span>

    <span class="s1">exp_dti </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s4">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s4">&quot;2017-01-03&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;2D&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">exp_dti</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;func, fill_value&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s4">&quot;min&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), (</span><span class="s4">&quot;max&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), (</span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s4">&quot;prod&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_aggregate_with_nat</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">):</span>
    <span class="s5"># check TimeGrouper's aggregation is identical as normal groupby</span>
    <span class="s5"># if NaT is included, 'var', 'std', 'mean', 'first','last'</span>
    <span class="s5"># and 'nth' doesn't work yet</span>

    <span class="s1">n </span><span class="s2">= </span><span class="s3">20</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">normal_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">normal_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">] * </span><span class="s3">4</span>

    <span class="s1">dt_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = </span><span class="s1">Index</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">,</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s2">* </span><span class="s3">4</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">normal_grouped </span><span class="s2">= </span><span class="s1">normal_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">dt_grouped </span><span class="s2">= </span><span class="s1">dt_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>

    <span class="s1">normal_result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">normal_grouped</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)()</span>
    <span class="s1">dt_result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dt_grouped</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)()</span>

    <span class="s1">pad </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s1">fill_value</span><span class="s2">] * </span><span class="s3">4</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">3</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">normal_result</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">()</span>
    <span class="s1">dti </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span>
        <span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;2013-01-01&quot;</span><span class="s2">,</span>
        <span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">,</span>
        <span class="s1">periods</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">,</span>
        <span class="s1">unit</span><span class="s2">=</span><span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">].</span><span class="s1">_values</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">dti</span><span class="s2">.</span><span class="s1">_with_freq</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)  </span><span class="s5"># TODO: is this desired?</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dt_result</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dt_result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;key&quot;</span>


<span class="s0">def </span><span class="s1">test_aggregate_with_nat_size</span><span class="s2">():</span>
    <span class="s5"># GH 9925</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">20</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">normal_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">normal_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">] * </span><span class="s3">4</span>

    <span class="s1">dt_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">])</span>
    <span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">] = </span><span class="s1">Index</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">),</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">,</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s3">2013</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s2">* </span><span class="s3">4</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">normal_grouped </span><span class="s2">= </span><span class="s1">normal_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">&quot;key&quot;</span><span class="s2">)</span>
    <span class="s1">dt_grouped </span><span class="s2">= </span><span class="s1">dt_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">))</span>

    <span class="s1">normal_result </span><span class="s2">= </span><span class="s1">normal_grouped</span><span class="s2">.</span><span class="s1">size</span><span class="s2">()</span>
    <span class="s1">dt_result </span><span class="s2">= </span><span class="s1">dt_grouped</span><span class="s2">.</span><span class="s1">size</span><span class="s2">()</span>

    <span class="s1">pad </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">3</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">normal_result</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span>
        <span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;2013-01-01&quot;</span><span class="s2">,</span>
        <span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;D&quot;</span><span class="s2">,</span>
        <span class="s1">periods</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;key&quot;</span><span class="s2">,</span>
        <span class="s1">unit</span><span class="s2">=</span><span class="s1">dt_df</span><span class="s2">[</span><span class="s4">&quot;key&quot;</span><span class="s2">].</span><span class="s1">_values</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">_with_freq</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dt_result</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dt_result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;key&quot;</span>


<span class="s0">def </span><span class="s1">test_repr</span><span class="s2">():</span>
    <span class="s5"># GH18203</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;h&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s4">&quot;TimeGrouper(key='A', freq=&lt;Hour&gt;, axis=0, sort=True, dropna=True, &quot;</span>
        <span class="s4">&quot;closed='left', label='left', how='mean', &quot;</span>
        <span class="s4">&quot;convention='e', origin='start_day')&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;h&quot;</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s4">&quot;2000-01-01&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s4">&quot;TimeGrouper(key='A', freq=&lt;Hour&gt;, axis=0, sort=True, dropna=True, &quot;</span>
        <span class="s4">&quot;closed='left', label='left', how='mean', &quot;</span>
        <span class="s4">&quot;convention='e', origin=Timestamp('2000-01-01 00:00:00'))&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;method, method_args, expected_values&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;sum&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">2</span><span class="s2">}, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, [</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s4">&quot;prod&quot;</span><span class="s2">, {</span><span class="s4">&quot;min_count&quot;</span><span class="s2">: </span><span class="s3">2</span><span class="s2">}, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_upsample_sum</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">method_args</span><span class="s2">, </span><span class="s1">expected_values</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2017&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;h&quot;</span><span class="s2">))</span>
    <span class="s1">resampled </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s4">&quot;30min&quot;</span><span class="s2">)</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">&quot;2017-01-01T00:00:00&quot;</span><span class="s2">, </span><span class="s4">&quot;2017-01-01T00:30:00&quot;</span><span class="s2">, </span><span class="s4">&quot;2017-01-01T01:00:00&quot;</span><span class="s2">],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">,</span>
        <span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;30min&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">methodcaller</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, **</span><span class="s1">method_args</span><span class="s2">)(</span><span class="s1">resampled</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">expected_values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_interpolate</span><span class="s2">():</span>
    <span class="s5"># GH 35325</span>
    <span class="s1">d </span><span class="s2">= {</span><span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], </span><span class="s4">&quot;volume&quot;</span><span class="s2">: [</span><span class="s3">50</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">50</span><span class="s2">]}</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;week_starting&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;01/01/2018&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;W&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= (</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s4">&quot;week_starting&quot;</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s4">&quot;volume&quot;</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s4">&quot;1D&quot;</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">interpolate</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;linear&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">volume </span><span class="s2">= [</span><span class="s3">50</span><span class="s2">] * </span><span class="s3">15 </span><span class="s2">+ [</span><span class="s3">60</span><span class="s2">]</span>
    <span class="s1">week_starting </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2018-01-07&quot;</span><span class="s2">, </span><span class="s4">&quot;2018-01-21&quot;</span><span class="s2">)) + [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2018-01-14&quot;</span><span class="s2">)</span>
    <span class="s2">]</span>
    <span class="s1">expected_ind </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">volume</span><span class="s2">, </span><span class="s1">week_starting</span><span class="s2">],</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;volume&quot;</span><span class="s2">, </span><span class="s4">&quot;week_starting&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span>
                <span class="s3">10.0</span><span class="s2">,</span>
                <span class="s3">9.928571428571429</span><span class="s2">,</span>
                <span class="s3">9.857142857142858</span><span class="s2">,</span>
                <span class="s3">9.785714285714286</span><span class="s2">,</span>
                <span class="s3">9.714285714285714</span><span class="s2">,</span>
                <span class="s3">9.642857142857142</span><span class="s2">,</span>
                <span class="s3">9.571428571428571</span><span class="s2">,</span>
                <span class="s3">9.5</span><span class="s2">,</span>
                <span class="s3">9.428571428571429</span><span class="s2">,</span>
                <span class="s3">9.357142857142858</span><span class="s2">,</span>
                <span class="s3">9.285714285714286</span><span class="s2">,</span>
                <span class="s3">9.214285714285714</span><span class="s2">,</span>
                <span class="s3">9.142857142857142</span><span class="s2">,</span>
                <span class="s3">9.071428571428571</span><span class="s2">,</span>
                <span class="s3">9.0</span><span class="s2">,</span>
                <span class="s3">11.0</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;volume&quot;</span><span class="s2">: [</span><span class="s3">50.0</span><span class="s2">] * </span><span class="s3">15 </span><span class="s2">+ [</span><span class="s3">60</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">expected_ind</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>