<html>
<head>
<title>config.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
config.py</font>
</center></td></tr></table>
<pre><span class="s0"># testing/config.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: ignore-errors</span>


<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">from </span><span class="s1">argparse </span><span class="s2">import </span><span class="s1">Namespace</span>
<span class="s2">import </span><span class="s1">collections</span>
<span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">import </span><span class="s1">typing</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Callable</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Iterable</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">NoReturn</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Optional</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Tuple</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">TypeVar</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Union</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">mock</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">requirements </span><span class="s2">as </span><span class="s1">_requirements</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s1">fail</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">util</span>

<span class="s0"># default requirements; this is replaced by plugin_base when pytest</span>
<span class="s0"># is run</span>
<span class="s1">requirements </span><span class="s3">= </span><span class="s1">_requirements</span><span class="s3">.</span><span class="s1">SuiteRequirements</span><span class="s3">()</span>

<span class="s1">db </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">db_url </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">db_opts </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">file_config </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">test_schema </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">test_schema_2 </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">any_async </span><span class="s3">= </span><span class="s2">False</span>
<span class="s1">_current </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">ident </span><span class="s3">= </span><span class="s4">&quot;main&quot;</span>
<span class="s1">options</span><span class="s3">: </span><span class="s1">Namespace </span><span class="s3">= </span><span class="s2">None  </span><span class="s0"># type: ignore</span>

<span class="s2">if </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s3">.</span><span class="s1">plugin</span><span class="s3">.</span><span class="s1">plugin_base </span><span class="s2">import </span><span class="s1">FixtureFunctions</span>

    <span class="s1">_fixture_functions</span><span class="s3">: </span><span class="s1">FixtureFunctions</span>
<span class="s2">else</span><span class="s3">:</span>

    <span class="s2">class </span><span class="s1">_NullFixtureFunctions</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">_null_decorator</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">go</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">fn</span>

            <span class="s2">return </span><span class="s1">go</span>

        <span class="s2">def </span><span class="s1">skip_test_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">arg</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Exception</span><span class="s3">()</span>

        <span class="s3">@</span><span class="s1">property</span>
        <span class="s2">def </span><span class="s1">add_to_marker</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">Mock</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">mark_base_test_class</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_null_decorator</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">combinations</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">arg_sets</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_null_decorator</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">param_ident</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">parameters</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_null_decorator</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">arg</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_null_decorator</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">get_current_test_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return None</span>

        <span class="s2">def </span><span class="s1">async_test</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">fn</span>

    <span class="s0"># default fixture functions; these are replaced by plugin_base when</span>
    <span class="s0"># pytest runs</span>
    <span class="s1">_fixture_functions </span><span class="s3">= </span><span class="s1">_NullFixtureFunctions</span><span class="s3">()</span>


<span class="s1">_FN </span><span class="s3">= </span><span class="s1">TypeVar</span><span class="s3">(</span><span class="s4">&quot;_FN&quot;</span><span class="s3">, </span><span class="s1">bound</span><span class="s3">=</span><span class="s1">Callable</span><span class="s3">[..., </span><span class="s1">Any</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">combinations</span><span class="s3">(</span>
    <span class="s3">*</span><span class="s1">comb</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">, ...]],</span>
    <span class="s1">argnames</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">id_</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">**</span><span class="s1">kw</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; Callable</span><span class="s3">[[</span><span class="s1">_FN</span><span class="s3">], </span><span class="s1">_FN</span><span class="s3">]:</span>
    <span class="s5">r&quot;&quot;&quot;Deliver multiple versions of a test based on positional combinations. 
 
    This is a facade over pytest.mark.parametrize. 
 
 
    :param \*comb: argument combinations.  These are tuples that will be passed 
     positionally to the decorated function. 
 
    :param argnames: optional list of argument names.   These are the names 
     of the arguments in the test function that correspond to the entries 
     in each argument tuple.   pytest.mark.parametrize requires this, however 
     the combinations function will derive it automatically if not present 
     by using ``inspect.getfullargspec(fn).args[1:]``.  Note this assumes the 
     first argument is &quot;self&quot; which is discarded. 
 
    :param id\_: optional id template.  This is a string template that 
     describes how the &quot;id&quot; for each parameter set should be defined, if any. 
     The number of characters in the template should match the number of 
     entries in each argument tuple.   Each character describes how the 
     corresponding entry in the argument tuple should be handled, as far as 
     whether or not it is included in the arguments passed to the function, as 
     well as if it is included in the tokens used to create the id of the 
     parameter set. 
 
     If omitted, the argument combinations are passed to parametrize as is.  If 
     passed, each argument combination is turned into a pytest.param() object, 
     mapping the elements of the argument tuple to produce an id based on a 
     character value in the same position within the string template using the 
     following scheme:: 
 
        i - the given argument is a string that is part of the id only, don't 
            pass it as an argument 
 
        n - the given argument should be passed and it should be added to the 
            id by calling the .__name__ attribute 
 
        r - the given argument should be passed and it should be added to the 
            id by calling repr() 
 
        s - the given argument should be passed and it should be added to the 
            id by calling str() 
 
        a - (argument) the given argument should be passed and it should not 
            be used to generated the id 
 
     e.g.:: 
 
        @testing.combinations( 
            (operator.eq, &quot;eq&quot;), 
            (operator.ne, &quot;ne&quot;), 
            (operator.gt, &quot;gt&quot;), 
            (operator.lt, &quot;lt&quot;), 
            id_=&quot;na&quot; 
        ) 
        def test_operator(self, opfunc, name): 
            pass 
 
    The above combination will call ``.__name__`` on the first member of 
    each tuple and use that as the &quot;id&quot; to pytest.param(). 
 
 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">*</span><span class="s1">comb</span><span class="s3">, </span><span class="s1">id_</span><span class="s3">=</span><span class="s1">id_</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s1">argnames</span><span class="s3">, **</span><span class="s1">kw</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">combinations_list</span><span class="s3">(</span><span class="s1">arg_iterable</span><span class="s3">: </span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">, ...]], **</span><span class="s1">kw</span><span class="s3">):</span>
    <span class="s5">&quot;As combination, but takes a single iterable&quot;</span>
    <span class="s2">return </span><span class="s1">combinations</span><span class="s3">(*</span><span class="s1">arg_iterable</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Variation</span><span class="s3">:</span>
    <span class="s1">__slots__ </span><span class="s3">= (</span><span class="s4">&quot;_name&quot;</span><span class="s3">, </span><span class="s4">&quot;_argname&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">case</span><span class="s3">, </span><span class="s1">argname</span><span class="s3">, </span><span class="s1">case_names</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_name </span><span class="s3">= </span><span class="s1">case</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_argname </span><span class="s3">= </span><span class="s1">argname</span>
        <span class="s2">for </span><span class="s1">casename </span><span class="s2">in </span><span class="s1">case_names</span><span class="s3">:</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">casename</span><span class="s3">, </span><span class="s1">casename </span><span class="s3">== </span><span class="s1">case</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>

        <span class="s2">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">: ...</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_name</span>

    <span class="s2">def </span><span class="s1">__bool__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_name </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_argname</span>

    <span class="s2">def </span><span class="s1">__nonzero__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__bool__</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_argname</span><span class="s2">}</span><span class="s4">=</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_name</span><span class="s2">!r}</span><span class="s4">&quot;</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">fail</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; NoReturn</span><span class="s3">:</span>
        <span class="s1">fail</span><span class="s3">(</span><span class="s4">f&quot;Unknown </span><span class="s2">{</span><span class="s1">self</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">idfn</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">variation</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">variation</span><span class="s3">.</span><span class="s1">name</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">generate_cases</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">argname</span><span class="s3">, </span><span class="s1">cases</span><span class="s3">):</span>
        <span class="s1">case_names </span><span class="s3">= [</span>
            <span class="s1">argname </span><span class="s2">if </span><span class="s1">c </span><span class="s2">is True else </span><span class="s4">&quot;not_&quot; </span><span class="s3">+ </span><span class="s1">argname </span><span class="s2">if </span><span class="s1">c </span><span class="s2">is False else </span><span class="s1">c</span>
            <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cases</span>
        <span class="s3">]</span>

        <span class="s1">typ </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span>
            <span class="s1">argname</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">Variation</span><span class="s3">,),</span>
            <span class="s3">{</span>
                <span class="s4">&quot;__slots__&quot;</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">case_names</span><span class="s3">),</span>
            <span class="s3">},</span>
        <span class="s3">)</span>

        <span class="s2">return </span><span class="s3">[</span><span class="s1">typ</span><span class="s3">(</span><span class="s1">casename</span><span class="s3">, </span><span class="s1">argname</span><span class="s3">, </span><span class="s1">case_names</span><span class="s3">) </span><span class="s2">for </span><span class="s1">casename </span><span class="s2">in </span><span class="s1">case_names</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">variation</span><span class="s3">(</span><span class="s1">argname_or_fn</span><span class="s3">, </span><span class="s1">cases</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;a helper around testing.combinations that provides a single namespace 
    that can be used as a switch. 
 
    e.g.:: 
 
        @testing.variation(&quot;querytyp&quot;, [&quot;select&quot;, &quot;subquery&quot;, &quot;legacy_query&quot;]) 
        @testing.variation(&quot;lazy&quot;, [&quot;select&quot;, &quot;raise&quot;, &quot;raise_on_sql&quot;]) 
        def test_thing( 
            self, 
            querytyp, 
            lazy, 
            decl_base 
        ): 
            class Thing(decl_base): 
                __tablename__ = 'thing' 
 
                # use name directly 
                rel = relationship(&quot;Rel&quot;, lazy=lazy.name) 
 
            # use as a switch 
            if querytyp.select: 
                stmt = select(Thing) 
            elif querytyp.subquery: 
                stmt = select(Thing).subquery() 
            elif querytyp.legacy_query: 
                stmt = Session.query(Thing) 
            else: 
                querytyp.fail() 
 
 
    The variable provided is a slots object of boolean variables, as well 
    as the name of the case itself under the attribute &quot;.name&quot; 
 
    &quot;&quot;&quot;</span>

    <span class="s2">if </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">argname_or_fn</span><span class="s3">):</span>
        <span class="s1">argname </span><span class="s3">= </span><span class="s1">argname_or_fn</span><span class="s3">.</span><span class="s1">__name__</span>
        <span class="s1">cases </span><span class="s3">= </span><span class="s1">argname_or_fn</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

        <span class="s3">@</span><span class="s1">variation_fixture</span><span class="s3">(</span><span class="s1">argname</span><span class="s3">, </span><span class="s1">cases</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">go</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span>

        <span class="s2">return </span><span class="s1">go</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">argname </span><span class="s3">= </span><span class="s1">argname_or_fn</span>
    <span class="s1">cases_plus_limitations </span><span class="s3">= [</span>
        <span class="s3">(</span>
            <span class="s1">entry</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">) </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">) == </span><span class="s6">2</span><span class="s3">)</span>
            <span class="s2">else </span><span class="s3">(</span><span class="s1">entry</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">cases</span>
    <span class="s3">]</span>

    <span class="s1">variations </span><span class="s3">= </span><span class="s1">Variation</span><span class="s3">.</span><span class="s1">generate_cases</span><span class="s3">(</span>
        <span class="s1">argname</span><span class="s3">, [</span><span class="s1">c </span><span class="s2">for </span><span class="s1">c</span><span class="s3">, </span><span class="s1">l </span><span class="s2">in </span><span class="s1">cases_plus_limitations</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">*[</span>
            <span class="s3">(</span>
                <span class="s3">(</span><span class="s1">variation</span><span class="s3">.</span><span class="s1">_name</span><span class="s3">, </span><span class="s1">variation</span><span class="s3">, </span><span class="s1">limitation</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">limitation </span><span class="s2">is not None</span>
                <span class="s2">else </span><span class="s3">(</span><span class="s1">variation</span><span class="s3">.</span><span class="s1">_name</span><span class="s3">, </span><span class="s1">variation</span><span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">variation</span><span class="s3">, (</span><span class="s1">case</span><span class="s3">, </span><span class="s1">limitation</span><span class="s3">) </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span>
                <span class="s1">variations</span><span class="s3">, </span><span class="s1">cases_plus_limitations</span>
            <span class="s3">)</span>
        <span class="s3">],</span>
        <span class="s1">id_</span><span class="s3">=</span><span class="s4">&quot;ia&quot;</span><span class="s3">,</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s1">argname</span><span class="s3">,</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">variation_fixture</span><span class="s3">(</span><span class="s1">argname</span><span class="s3">, </span><span class="s1">cases</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">=</span><span class="s4">&quot;function&quot;</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">fixture</span><span class="s3">(</span>
        <span class="s1">params</span><span class="s3">=</span><span class="s1">Variation</span><span class="s3">.</span><span class="s1">generate_cases</span><span class="s3">(</span><span class="s1">argname</span><span class="s3">, </span><span class="s1">cases</span><span class="s3">),</span>
        <span class="s1">ids</span><span class="s3">=</span><span class="s1">Variation</span><span class="s3">.</span><span class="s1">idfn</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">scope</span><span class="s3">,</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">fixture</span><span class="s3">(*</span><span class="s1">arg</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(*</span><span class="s1">arg</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">get_current_test_name</span><span class="s3">() </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">get_current_test_name</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">mark_base_test_class</span><span class="s3">() </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">mark_base_test_class</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">_AddToMarker</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">add_to_marker</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>


<span class="s1">add_to_marker </span><span class="s3">= </span><span class="s1">_AddToMarker</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">Config</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">db_opts</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">file_config</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_name</span><span class="s3">(</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">db </span><span class="s3">= </span><span class="s1">db</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">db_opts </span><span class="s3">= </span><span class="s1">db_opts</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">options </span><span class="s3">= </span><span class="s1">options</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">file_config </span><span class="s3">= </span><span class="s1">file_config</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s3">= </span><span class="s4">&quot;test_schema&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">test_schema_2 </span><span class="s3">= </span><span class="s4">&quot;test_schema_2&quot;</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">is_async </span><span class="s3">= </span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">is_async </span><span class="s2">and not </span><span class="s1">util</span><span class="s3">.</span><span class="s1">asbool</span><span class="s3">(</span>
            <span class="s1">db</span><span class="s3">.</span><span class="s1">url</span><span class="s3">.</span><span class="s1">query</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;async_fallback&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s1">_stack </span><span class="s3">= </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">deque</span><span class="s3">()</span>
    <span class="s1">_configs </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_set_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">db</span><span class="s3">):</span>
        <span class="s1">suffix </span><span class="s3">= </span><span class="s4">&quot;_async&quot; </span><span class="s2">if </span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">is_async </span><span class="s2">else </span><span class="s4">&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">server_version_info</span><span class="s3">:</span>
            <span class="s1">svi </span><span class="s3">= </span><span class="s4">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">tok</span><span class="s3">) </span><span class="s2">for </span><span class="s1">tok </span><span class="s2">in </span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">server_version_info</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;%s+%s%s_[%s]&quot; </span><span class="s3">% (</span><span class="s1">db</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">db</span><span class="s3">.</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">, </span><span class="s1">svi</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;%s+%s%s&quot; </span><span class="s3">% (</span><span class="s1">db</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">db</span><span class="s3">.</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">register</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">db_opts</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">file_config</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;add a config as one of the global configs. 
 
        If there are no configs set up yet, this config also 
        gets set as the &quot;_current&quot;. 
        &quot;&quot;&quot;</span>
        <span class="s2">global </span><span class="s1">any_async</span>

        <span class="s1">cfg </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">(</span><span class="s1">db</span><span class="s3">, </span><span class="s1">db_opts</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">file_config</span><span class="s3">)</span>

        <span class="s0"># if any backends include an async driver, then ensure</span>
        <span class="s0"># all setup/teardown and tests are wrapped in the maybe_async()</span>
        <span class="s0"># decorator that will set up a greenlet context for async drivers.</span>
        <span class="s1">any_async </span><span class="s3">= </span><span class="s1">any_async </span><span class="s2">or </span><span class="s1">cfg</span><span class="s3">.</span><span class="s1">is_async</span>

        <span class="s1">cls</span><span class="s3">.</span><span class="s1">_configs</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">cfg</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">cfg</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">set_as_current</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">config</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">):</span>
        <span class="s2">global </span><span class="s1">db</span><span class="s3">, </span><span class="s1">_current</span><span class="s3">, </span><span class="s1">db_url</span><span class="s3">, </span><span class="s1">test_schema</span><span class="s3">, </span><span class="s1">test_schema_2</span><span class="s3">, </span><span class="s1">db_opts</span>
        <span class="s1">_current </span><span class="s3">= </span><span class="s1">config</span>
        <span class="s1">db_url </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">url</span>
        <span class="s1">db_opts </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db_opts</span>
        <span class="s1">test_schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s1">test_schema_2 </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema_2</span>
        <span class="s1">namespace</span><span class="s3">.</span><span class="s1">db </span><span class="s3">= </span><span class="s1">db </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">push_engine</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">db</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">_current</span><span class="s3">, </span><span class="s4">&quot;Can't push without a default Config set up&quot;</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span>
            <span class="s1">Config</span><span class="s3">(</span>
                <span class="s1">db</span><span class="s3">, </span><span class="s1">_current</span><span class="s3">.</span><span class="s1">db_opts</span><span class="s3">, </span><span class="s1">_current</span><span class="s3">.</span><span class="s1">options</span><span class="s3">, </span><span class="s1">_current</span><span class="s3">.</span><span class="s1">file_config</span>
            <span class="s3">),</span>
            <span class="s1">namespace</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">push</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">config</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">_current</span><span class="s3">)</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">set_as_current</span><span class="s3">(</span><span class="s1">config</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">pop</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">:</span>
            <span class="s0"># a failed test w/ -x option can call reset() ahead of time</span>
            <span class="s1">_current </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">del </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">set_as_current</span><span class="s3">(</span><span class="s1">_current</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">reset</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">namespace</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">set_as_current</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">namespace</span><span class="s3">)</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">all_configs</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_configs</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">all_dbs</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">cfg </span><span class="s2">in </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">all_configs</span><span class="s3">():</span>
            <span class="s2">yield </span><span class="s1">cfg</span><span class="s3">.</span><span class="s1">db</span>

    <span class="s2">def </span><span class="s1">skip_test</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">skip_test</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">skip_test</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">):</span>
    <span class="s2">raise </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">skip_test_exception</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">async_test</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">_fixture_functions</span><span class="s3">.</span><span class="s1">async_test</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
</pre>
</body>
</html>