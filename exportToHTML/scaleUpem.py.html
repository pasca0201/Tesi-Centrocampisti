<html>
<head>
<title>scaleUpem.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
scaleUpem.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Change the units-per-EM of a font. 
 
AAT and Graphite tables are not supported. CFF/CFF2 fonts 
are de-subroutinized.&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">ttVisitor </span><span class="s2">import </span><span class="s1">TTVisitor</span>
<span class="s2">import </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">ttLib </span><span class="s2">as </span><span class="s1">ttLib</span>
<span class="s2">import </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">otBase </span><span class="s2">as </span><span class="s1">otBase</span>
<span class="s2">import </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">otTables </span><span class="s2">as </span><span class="s1">otTables</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">cffLib </span><span class="s2">import </span><span class="s1">VarStoreData</span>
<span class="s2">import </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">cffLib</span><span class="s3">.</span><span class="s1">specializer </span><span class="s2">as </span><span class="s1">cffSpecializer</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">varLib </span><span class="s2">import </span><span class="s1">builder  </span><span class="s4"># for VarData.calculateNumShorts</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">varLib</span><span class="s3">.</span><span class="s1">multiVarStore </span><span class="s2">import </span><span class="s1">OnlineMultiVarStoreBuilder</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">vector </span><span class="s2">import </span><span class="s1">Vector</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">fixedTools </span><span class="s2">import </span><span class="s1">otRound</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">iterTools </span><span class="s2">import </span><span class="s1">batched</span>


<span class="s1">__all__ </span><span class="s3">= [</span><span class="s5">&quot;scale_upem&quot;</span><span class="s3">, </span><span class="s5">&quot;ScalerVisitor&quot;</span><span class="s3">]</span>


<span class="s2">class </span><span class="s1">ScalerVisitor</span><span class="s3">(</span><span class="s1">TTVisitor</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">scaleFactor</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scaleFactor </span><span class="s3">= </span><span class="s1">scaleFactor</span>

    <span class="s2">def </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">v</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">otRound</span><span class="s3">(</span><span class="s1">v </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scaleFactor</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attrs</span><span class="s3">(</span>
    <span class="s3">(</span>
        <span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;head&quot;</span><span class="s3">), (</span><span class="s5">&quot;unitsPerEm&quot;</span><span class="s3">, </span><span class="s5">&quot;xMin&quot;</span><span class="s3">, </span><span class="s5">&quot;yMin&quot;</span><span class="s3">, </span><span class="s5">&quot;xMax&quot;</span><span class="s3">, </span><span class="s5">&quot;yMax&quot;</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;post&quot;</span><span class="s3">), (</span><span class="s5">&quot;underlinePosition&quot;</span><span class="s3">, </span><span class="s5">&quot;underlineThickness&quot;</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;VORG&quot;</span><span class="s3">), (</span><span class="s5">&quot;defaultVertOriginY&quot;</span><span class="s3">)),</span>
        <span class="s3">(</span>
            <span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;hhea&quot;</span><span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">&quot;ascent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;descent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;lineGap&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;advanceWidthMax&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;minLeftSideBearing&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;minRightSideBearing&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;xMaxExtent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;caretOffset&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;vhea&quot;</span><span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">&quot;ascent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;descent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;lineGap&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;advanceHeightMax&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;minTopSideBearing&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;minBottomSideBearing&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;yMaxExtent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;caretOffset&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;OS/2&quot;</span><span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">&quot;xAvgCharWidth&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySubscriptXSize&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySubscriptYSize&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySubscriptXOffset&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySubscriptYOffset&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySuperscriptXSize&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySuperscriptYSize&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySuperscriptXOffset&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;ySuperscriptYOffset&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;yStrikeoutSize&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;yStrikeoutPosition&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;sTypoAscender&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;sTypoDescender&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;sTypoLineGap&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;usWinAscent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;usWinDescent&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;sxHeight&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;sCapHeight&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">otTables</span><span class="s3">.</span><span class="s1">ValueRecord</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s5">&quot;XAdvance&quot;</span><span class="s3">, </span><span class="s5">&quot;YAdvance&quot;</span><span class="s3">, </span><span class="s5">&quot;XPlacement&quot;</span><span class="s3">, </span><span class="s5">&quot;YPlacement&quot;</span><span class="s3">),</span>
        <span class="s3">),  </span><span class="s4"># GPOS</span>
        <span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">Anchor</span><span class="s3">, (</span><span class="s5">&quot;XCoordinate&quot;</span><span class="s3">, </span><span class="s5">&quot;YCoordinate&quot;</span><span class="s3">)),  </span><span class="s4"># GPOS</span>
        <span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">CaretValue</span><span class="s3">, (</span><span class="s5">&quot;Coordinate&quot;</span><span class="s3">)),  </span><span class="s4"># GDEF</span>
        <span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">BaseCoord</span><span class="s3">, (</span><span class="s5">&quot;Coordinate&quot;</span><span class="s3">)),  </span><span class="s4"># BASE</span>
        <span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">MathValueRecord</span><span class="s3">, (</span><span class="s5">&quot;Value&quot;</span><span class="s3">)),  </span><span class="s4"># MATH</span>
        <span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">ClipBox</span><span class="s3">, (</span><span class="s5">&quot;xMin&quot;</span><span class="s3">, </span><span class="s5">&quot;yMin&quot;</span><span class="s3">, </span><span class="s5">&quot;xMax&quot;</span><span class="s3">, </span><span class="s5">&quot;yMax&quot;</span><span class="s3">)),  </span><span class="s4"># COLR</span>
    <span class="s3">)</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;hmtx&quot;</span><span class="s3">), </span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;vmtx&quot;</span><span class="s3">)), </span><span class="s5">&quot;metrics&quot;</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">metrics</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">metrics</span><span class="s3">:</span>
        <span class="s1">advance</span><span class="s3">, </span><span class="s1">lsb </span><span class="s3">= </span><span class="s1">metrics</span><span class="s3">[</span><span class="s1">g</span><span class="s3">]</span>
        <span class="s1">metrics</span><span class="s3">[</span><span class="s1">g</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">advance</span><span class="s3">), </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">lsb</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;VMTX&quot;</span><span class="s3">), </span><span class="s5">&quot;VOriginRecords&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">VOriginRecords</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">VOriginRecords</span><span class="s3">:</span>
        <span class="s1">VOriginRecords</span><span class="s3">[</span><span class="s1">g</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">VOriginRecords</span><span class="s3">[</span><span class="s1">g</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;glyf&quot;</span><span class="s3">), </span><span class="s5">&quot;glyphs&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">glyphs</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">glyphs</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
        <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;xMin&quot;</span><span class="s3">, </span><span class="s5">&quot;xMax&quot;</span><span class="s3">, </span><span class="s5">&quot;yMin&quot;</span><span class="s3">, </span><span class="s5">&quot;yMax&quot;</span><span class="s3">):</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">g</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">v </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">setattr</span><span class="s3">(</span><span class="s1">g</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">g</span><span class="s3">.</span><span class="s1">isComposite</span><span class="s3">():</span>
            <span class="s2">for </span><span class="s1">component </span><span class="s2">in </span><span class="s1">g</span><span class="s3">.</span><span class="s1">components</span><span class="s3">:</span>
                <span class="s1">component</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">component</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
                <span class="s1">component</span><span class="s3">.</span><span class="s1">y </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">component</span><span class="s3">.</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s2">continue</span>

        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">g</span><span class="s3">, </span><span class="s5">&quot;coordinates&quot;</span><span class="s3">):</span>
            <span class="s1">coordinates </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">coordinates</span>
            <span class="s2">for </span><span class="s1">i</span><span class="s3">, (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">coordinates</span><span class="s3">):</span>
                <span class="s1">coordinates</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;gvar&quot;</span><span class="s3">), </span><span class="s5">&quot;variations&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">variations</span><span class="s3">):</span>
    <span class="s1">glyfTable </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">font</span><span class="s3">[</span><span class="s5">&quot;glyf&quot;</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">glyphName</span><span class="s3">, </span><span class="s1">varlist </span><span class="s2">in </span><span class="s1">variations</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">glyph </span><span class="s3">= </span><span class="s1">glyfTable</span><span class="s3">[</span><span class="s1">glyphName</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">var </span><span class="s2">in </span><span class="s1">varlist</span><span class="s3">:</span>
            <span class="s1">coordinates </span><span class="s3">= </span><span class="s1">var</span><span class="s3">.</span><span class="s1">coordinates</span>
            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xy </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">coordinates</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">xy </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s1">coordinates</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]), </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;VARC&quot;</span><span class="s3">), </span><span class="s5">&quot;table&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">varc</span><span class="s3">):</span>
    <span class="s4"># VarComposite variations are a pain</span>

    <span class="s1">fvar </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">font</span><span class="s3">[</span><span class="s5">&quot;fvar&quot;</span><span class="s3">]</span>
    <span class="s1">fvarAxes </span><span class="s3">= [</span><span class="s1">a</span><span class="s3">.</span><span class="s1">axisTag </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">fvar</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">]</span>

    <span class="s1">store </span><span class="s3">= </span><span class="s1">varc</span><span class="s3">.</span><span class="s1">MultiVarStore</span>
    <span class="s1">storeBuilder </span><span class="s3">= </span><span class="s1">OnlineMultiVarStoreBuilder</span><span class="s3">(</span><span class="s1">fvarAxes</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">varc</span><span class="s3">.</span><span class="s1">VarCompositeGlyphs</span><span class="s3">.</span><span class="s1">VarCompositeGlyph</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">component </span><span class="s2">in </span><span class="s1">g</span><span class="s3">.</span><span class="s1">components</span><span class="s3">:</span>
            <span class="s1">t </span><span class="s3">= </span><span class="s1">component</span><span class="s3">.</span><span class="s1">transform</span>
            <span class="s1">t</span><span class="s3">.</span><span class="s1">translateX </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">translateX</span><span class="s3">)</span>
            <span class="s1">t</span><span class="s3">.</span><span class="s1">translateY </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">translateY</span><span class="s3">)</span>
            <span class="s1">t</span><span class="s3">.</span><span class="s1">tCenterX </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">tCenterX</span><span class="s3">)</span>
            <span class="s1">t</span><span class="s3">.</span><span class="s1">tCenterY </span><span class="s3">= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">tCenterY</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">component</span><span class="s3">.</span><span class="s1">axisValuesVarIndex </span><span class="s3">!= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span><span class="s3">:</span>
                <span class="s1">varIdx </span><span class="s3">= </span><span class="s1">component</span><span class="s3">.</span><span class="s1">axisValuesVarIndex</span>
                <span class="s4"># TODO Move this code duplicated below to MultiVarStore.__getitem__,</span>
                <span class="s4"># or a getDeltasAndSupports().</span>
                <span class="s2">if </span><span class="s1">varIdx </span><span class="s3">!= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span><span class="s3">:</span>
                    <span class="s1">major </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&gt;&gt; </span><span class="s6">16</span>
                    <span class="s1">minor </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&amp; </span><span class="s6">0xFFFF</span>
                    <span class="s1">varData </span><span class="s3">= </span><span class="s1">store</span><span class="s3">.</span><span class="s1">MultiVarData</span><span class="s3">[</span><span class="s1">major</span><span class="s3">]</span>
                    <span class="s1">vec </span><span class="s3">= </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">Item</span><span class="s3">[</span><span class="s1">minor</span><span class="s3">]</span>
                    <span class="s1">storeBuilder</span><span class="s3">.</span><span class="s1">setSupports</span><span class="s3">(</span><span class="s1">store</span><span class="s3">.</span><span class="s1">get_supports</span><span class="s3">(</span><span class="s1">major</span><span class="s3">, </span><span class="s1">fvar</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">))</span>
                    <span class="s2">if </span><span class="s1">vec</span><span class="s3">:</span>
                        <span class="s1">m </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">) // </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">VarRegionCount</span>
                        <span class="s1">vec </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">batched</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
                        <span class="s1">vec </span><span class="s3">= [</span><span class="s1">Vector</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">vec</span><span class="s3">]</span>
                        <span class="s1">component</span><span class="s3">.</span><span class="s1">axisValuesVarIndex </span><span class="s3">= </span><span class="s1">storeBuilder</span><span class="s3">.</span><span class="s1">storeDeltas</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">component</span><span class="s3">.</span><span class="s1">axisValuesVarIndex </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span>

            <span class="s2">if </span><span class="s1">component</span><span class="s3">.</span><span class="s1">transformVarIndex </span><span class="s3">!= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span><span class="s3">:</span>
                <span class="s1">varIdx </span><span class="s3">= </span><span class="s1">component</span><span class="s3">.</span><span class="s1">transformVarIndex</span>
                <span class="s2">if </span><span class="s1">varIdx </span><span class="s3">!= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span><span class="s3">:</span>
                    <span class="s1">major </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&gt;&gt; </span><span class="s6">16</span>
                    <span class="s1">minor </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&amp; </span><span class="s6">0xFFFF</span>
                    <span class="s1">vec </span><span class="s3">= </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">Item</span><span class="s3">[</span><span class="s1">varIdx </span><span class="s3">&amp; </span><span class="s6">0xFFFF</span><span class="s3">]</span>
                    <span class="s1">major </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&gt;&gt; </span><span class="s6">16</span>
                    <span class="s1">minor </span><span class="s3">= </span><span class="s1">varIdx </span><span class="s3">&amp; </span><span class="s6">0xFFFF</span>
                    <span class="s1">varData </span><span class="s3">= </span><span class="s1">store</span><span class="s3">.</span><span class="s1">MultiVarData</span><span class="s3">[</span><span class="s1">major</span><span class="s3">]</span>
                    <span class="s1">vec </span><span class="s3">= </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">Item</span><span class="s3">[</span><span class="s1">minor</span><span class="s3">]</span>
                    <span class="s1">storeBuilder</span><span class="s3">.</span><span class="s1">setSupports</span><span class="s3">(</span><span class="s1">store</span><span class="s3">.</span><span class="s1">get_supports</span><span class="s3">(</span><span class="s1">major</span><span class="s3">, </span><span class="s1">fvar</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">))</span>
                    <span class="s2">if </span><span class="s1">vec</span><span class="s3">:</span>
                        <span class="s1">m </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">) // </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">VarRegionCount</span>
                        <span class="s1">flags </span><span class="s3">= </span><span class="s1">component</span><span class="s3">.</span><span class="s1">flags</span>
                        <span class="s1">vec </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">batched</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
                        <span class="s1">newVec </span><span class="s3">= []</span>
                        <span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">vec</span><span class="s3">:</span>
                            <span class="s1">v </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
                            <span class="s1">i </span><span class="s3">= </span><span class="s6">0</span>
                            <span class="s4">## Scale translate &amp; tCenter</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_TRANSLATE_X</span><span class="s3">:</span>
                                <span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_TRANSLATE_Y</span><span class="s3">:</span>
                                <span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_ROTATION</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_SCALE_X</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_SCALE_Y</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_SKEW_X</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_SKEW_Y</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_TCENTER_X</span><span class="s3">:</span>
                                <span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>
                            <span class="s2">if </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarComponentFlags</span><span class="s3">.</span><span class="s1">HAVE_TCENTER_Y</span><span class="s3">:</span>
                                <span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
                                <span class="s1">i </span><span class="s3">+= </span><span class="s6">1</span>

                            <span class="s1">newVec</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">Vector</span><span class="s3">(</span><span class="s1">v</span><span class="s3">))</span>
                        <span class="s1">vec </span><span class="s3">= </span><span class="s1">newVec</span>

                        <span class="s1">component</span><span class="s3">.</span><span class="s1">transformVarIndex </span><span class="s3">= </span><span class="s1">storeBuilder</span><span class="s3">.</span><span class="s1">storeDeltas</span><span class="s3">(</span><span class="s1">vec</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">component</span><span class="s3">.</span><span class="s1">transformVarIndex </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">NO_VARIATION_INDEX</span>

    <span class="s1">varc</span><span class="s3">.</span><span class="s1">MultiVarStore </span><span class="s3">= </span><span class="s1">storeBuilder</span><span class="s3">.</span><span class="s1">finish</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;kern&quot;</span><span class="s3">), </span><span class="s5">&quot;kernTables&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">kernTables</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">table </span><span class="s2">in </span><span class="s1">kernTables</span><span class="s3">:</span>
        <span class="s1">kernTable </span><span class="s3">= </span><span class="s1">table</span><span class="s3">.</span><span class="s1">kernTable</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">kernTable</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s1">kernTable</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">kernTable</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">_cff_scale</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                <span class="s1">args</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">num_blends </span><span class="s3">= </span><span class="s1">arg</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s1">_cff_scale</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>
            <span class="s1">arg</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">] = </span><span class="s1">num_blends</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register_attr</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;CFF &quot;</span><span class="s3">), </span><span class="s1">ttLib</span><span class="s3">.</span><span class="s1">getTableClass</span><span class="s3">(</span><span class="s5">&quot;CFF2&quot;</span><span class="s3">)), </span><span class="s5">&quot;cff&quot;</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">cff</span><span class="s3">):</span>
    <span class="s1">cff</span><span class="s3">.</span><span class="s1">desubroutinize</span><span class="s3">()</span>
    <span class="s1">topDict </span><span class="s3">= </span><span class="s1">cff</span><span class="s3">.</span><span class="s1">topDictIndex</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
    <span class="s1">varStore </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">topDict</span><span class="s3">, </span><span class="s5">&quot;VarStore&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">getNumRegions </span><span class="s3">= </span><span class="s1">varStore</span><span class="s3">.</span><span class="s1">getNumRegions </span><span class="s2">if </span><span class="s1">varStore </span><span class="s2">is not None else None</span>
    <span class="s1">privates </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">fontname </span><span class="s2">in </span><span class="s1">cff</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
        <span class="s1">font </span><span class="s3">= </span><span class="s1">cff</span><span class="s3">[</span><span class="s1">fontname</span><span class="s3">]</span>
        <span class="s1">cs </span><span class="s3">= </span><span class="s1">font</span><span class="s3">.</span><span class="s1">CharStrings</span>
        <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">font</span><span class="s3">.</span><span class="s1">charset</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">cs</span><span class="s3">.</span><span class="s1">getItemAndSelector</span><span class="s3">(</span><span class="s1">g</span><span class="s3">)</span>
            <span class="s1">privates</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">private</span><span class="s3">)</span>

            <span class="s1">commands </span><span class="s3">= </span><span class="s1">cffSpecializer</span><span class="s3">.</span><span class="s1">programToCommands</span><span class="s3">(</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">program</span><span class="s3">, </span><span class="s1">getNumRegions</span><span class="s3">=</span><span class="s1">getNumRegions</span>
            <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">op</span><span class="s3">, </span><span class="s1">args </span><span class="s2">in </span><span class="s1">commands</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">op </span><span class="s3">== </span><span class="s5">&quot;vsindex&quot;</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s1">_cff_scale</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">program</span><span class="s3">[:] = </span><span class="s1">cffSpecializer</span><span class="s3">.</span><span class="s1">commandsToProgram</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">)</span>

        <span class="s4"># Annoying business of scaling numbers that do not matter whatsoever</span>

        <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s3">(</span>
            <span class="s5">&quot;UnderlinePosition&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;UnderlineThickness&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;FontBBox&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;StrokeWidth&quot;</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">topDict</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">value </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s1">_cff_scale</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">setattr</span><span class="s3">(</span><span class="s1">topDict</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">6</span><span class="s3">):</span>
            <span class="s1">topDict</span><span class="s3">.</span><span class="s1">FontMatrix</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] /= </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scaleFactor</span>

        <span class="s2">for </span><span class="s1">private </span><span class="s2">in </span><span class="s1">privates</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s3">(</span>
                <span class="s5">&quot;BlueValues&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;OtherBlues&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;FamilyBlues&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;FamilyOtherBlues&quot;</span><span class="s3">,</span>
                <span class="s4"># &quot;BlueScale&quot;,</span>
                <span class="s4"># &quot;BlueShift&quot;,</span>
                <span class="s4"># &quot;BlueFuzz&quot;,</span>
                <span class="s5">&quot;StdHW&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;StdVW&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;StemSnapH&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;StemSnapV&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;defaultWidthX&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;nominalWidthX&quot;</span><span class="s3">,</span>
            <span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">private</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">value </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                    <span class="s1">_cff_scale</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">private</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>


<span class="s4"># ItemVariationStore</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">VarData</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">varData</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">varData</span><span class="s3">.</span><span class="s1">Item</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">item</span><span class="s3">):</span>
            <span class="s1">item</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
    <span class="s1">varData</span><span class="s3">.</span><span class="s1">calculateNumShorts</span><span class="s3">()</span>


<span class="s4"># COLRv1</span>


<span class="s2">def </span><span class="s1">_setup_scale_paint</span><span class="s3">(</span><span class="s1">paint</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s3">-</span><span class="s6">2 </span><span class="s3">&lt;= </span><span class="s1">scale </span><span class="s3">&lt;= </span><span class="s6">2 </span><span class="s3">- (</span><span class="s6">1 </span><span class="s3">&gt;&gt; </span><span class="s6">14</span><span class="s3">):</span>
        <span class="s1">paint</span><span class="s3">.</span><span class="s1">Format </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">PaintFormat</span><span class="s3">.</span><span class="s1">PaintScaleUniform</span>
        <span class="s1">paint</span><span class="s3">.</span><span class="s1">scale </span><span class="s3">= </span><span class="s1">scale</span>
        <span class="s2">return</span>

    <span class="s1">transform </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">Affine2x3</span><span class="s3">()</span>
    <span class="s1">transform</span><span class="s3">.</span><span class="s1">populateDefaults</span><span class="s3">()</span>
    <span class="s1">transform</span><span class="s3">.</span><span class="s1">xy </span><span class="s3">= </span><span class="s1">transform</span><span class="s3">.</span><span class="s1">yx </span><span class="s3">= </span><span class="s1">transform</span><span class="s3">.</span><span class="s1">dx </span><span class="s3">= </span><span class="s1">transform</span><span class="s3">.</span><span class="s1">dy </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s1">transform</span><span class="s3">.</span><span class="s1">xx </span><span class="s3">= </span><span class="s1">transform</span><span class="s3">.</span><span class="s1">yy </span><span class="s3">= </span><span class="s1">scale</span>

    <span class="s1">paint</span><span class="s3">.</span><span class="s1">Format </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">PaintFormat</span><span class="s3">.</span><span class="s1">PaintTransform</span>
    <span class="s1">paint</span><span class="s3">.</span><span class="s1">Transform </span><span class="s3">= </span><span class="s1">transform</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">BaseGlyphPaintRecord</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">record</span><span class="s3">):</span>
    <span class="s1">oldPaint </span><span class="s3">= </span><span class="s1">record</span><span class="s3">.</span><span class="s1">Paint</span>

    <span class="s1">scale </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">Paint</span><span class="s3">()</span>
    <span class="s1">_setup_scale_paint</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">, </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scaleFactor</span><span class="s3">)</span>
    <span class="s1">scale</span><span class="s3">.</span><span class="s1">Paint </span><span class="s3">= </span><span class="s1">oldPaint</span>

    <span class="s1">record</span><span class="s3">.</span><span class="s1">Paint </span><span class="s3">= </span><span class="s1">scale</span>

    <span class="s2">return True</span>


<span class="s3">@</span><span class="s1">ScalerVisitor</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">Paint</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">visitor</span><span class="s3">, </span><span class="s1">paint</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Format </span><span class="s3">!= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">PaintFormat</span><span class="s3">.</span><span class="s1">PaintGlyph</span><span class="s3">:</span>
        <span class="s2">return True</span>

    <span class="s1">newPaint </span><span class="s3">= </span><span class="s1">otTables</span><span class="s3">.</span><span class="s1">Paint</span><span class="s3">()</span>
    <span class="s1">newPaint</span><span class="s3">.</span><span class="s1">Format </span><span class="s3">= </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Format</span>
    <span class="s1">newPaint</span><span class="s3">.</span><span class="s1">Paint </span><span class="s3">= </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Paint</span>
    <span class="s1">newPaint</span><span class="s3">.</span><span class="s1">Glyph </span><span class="s3">= </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Glyph</span>
    <span class="s2">del </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Paint</span>
    <span class="s2">del </span><span class="s1">paint</span><span class="s3">.</span><span class="s1">Glyph</span>

    <span class="s1">_setup_scale_paint</span><span class="s3">(</span><span class="s1">paint</span><span class="s3">, </span><span class="s6">1 </span><span class="s3">/ </span><span class="s1">visitor</span><span class="s3">.</span><span class="s1">scaleFactor</span><span class="s3">)</span>
    <span class="s1">paint</span><span class="s3">.</span><span class="s1">Paint </span><span class="s3">= </span><span class="s1">newPaint</span>

    <span class="s1">visitor</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">newPaint</span><span class="s3">.</span><span class="s1">Paint</span><span class="s3">)</span>

    <span class="s2">return False</span>


<span class="s2">def </span><span class="s1">scale_upem</span><span class="s3">(</span><span class="s1">font</span><span class="s3">, </span><span class="s1">new_upem</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Change the units-per-EM of font to the new value.&quot;&quot;&quot;</span>
    <span class="s1">upem </span><span class="s3">= </span><span class="s1">font</span><span class="s3">[</span><span class="s5">&quot;head&quot;</span><span class="s3">].</span><span class="s1">unitsPerEm</span>
    <span class="s1">visitor </span><span class="s3">= </span><span class="s1">ScalerVisitor</span><span class="s3">(</span><span class="s1">new_upem </span><span class="s3">/ </span><span class="s1">upem</span><span class="s3">)</span>
    <span class="s1">visitor</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">font</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">main</span><span class="s3">(</span><span class="s1">args</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Change the units-per-EM of fonts&quot;&quot;&quot;</span>

    <span class="s2">if </span><span class="s1">args </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">import </span><span class="s1">sys</span>

        <span class="s1">args </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">argv</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:]</span>

    <span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">ttLib </span><span class="s2">import </span><span class="s1">TTFont</span>
    <span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">cliTools </span><span class="s2">import </span><span class="s1">makeOutputFileName</span>
    <span class="s2">import </span><span class="s1">argparse</span>

    <span class="s1">parser </span><span class="s3">= </span><span class="s1">argparse</span><span class="s3">.</span><span class="s1">ArgumentParser</span><span class="s3">(</span>
        <span class="s5">&quot;fonttools ttLib.scaleUpem&quot;</span><span class="s3">, </span><span class="s1">description</span><span class="s3">=</span><span class="s5">&quot;Change the units-per-EM of fonts&quot;</span>
    <span class="s3">)</span>
    <span class="s1">parser</span><span class="s3">.</span><span class="s1">add_argument</span><span class="s3">(</span><span class="s5">&quot;font&quot;</span><span class="s3">, </span><span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;font&quot;</span><span class="s3">, </span><span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Font file.&quot;</span><span class="s3">)</span>
    <span class="s1">parser</span><span class="s3">.</span><span class="s1">add_argument</span><span class="s3">(</span>
        <span class="s5">&quot;new_upem&quot;</span><span class="s3">, </span><span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;new-upem&quot;</span><span class="s3">, </span><span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;New units-per-EM integer value.&quot;</span>
    <span class="s3">)</span>
    <span class="s1">parser</span><span class="s3">.</span><span class="s1">add_argument</span><span class="s3">(</span>
        <span class="s5">&quot;--output-file&quot;</span><span class="s3">, </span><span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;path&quot;</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Output file.&quot;</span>
    <span class="s3">)</span>

    <span class="s1">options </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">parse_args</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s1">font </span><span class="s3">= </span><span class="s1">TTFont</span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">font</span><span class="s3">)</span>
    <span class="s1">new_upem </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">new_upem</span><span class="s3">)</span>
    <span class="s1">output_file </span><span class="s3">= (</span>
        <span class="s1">options</span><span class="s3">.</span><span class="s1">output_file</span>
        <span class="s2">if </span><span class="s1">options</span><span class="s3">.</span><span class="s1">output_file </span><span class="s2">is not None</span>
        <span class="s2">else </span><span class="s1">makeOutputFileName</span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">font</span><span class="s3">, </span><span class="s1">overWrite</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">=</span><span class="s5">&quot;-scaled&quot;</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">scale_upem</span><span class="s3">(</span><span class="s1">font</span><span class="s3">, </span><span class="s1">new_upem</span><span class="s3">)</span>

    <span class="s1">print</span><span class="s3">(</span><span class="s5">&quot;Writing %s&quot; </span><span class="s3">% </span><span class="s1">output_file</span><span class="s3">)</span>
    <span class="s1">font</span><span class="s3">.</span><span class="s1">save</span><span class="s3">(</span><span class="s1">output_file</span><span class="s3">)</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s5">&quot;__main__&quot;</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">sys</span>

    <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s1">main</span><span class="s3">())</span>
</pre>
</body>
</html>