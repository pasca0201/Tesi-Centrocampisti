<html>
<head>
<title>test_recfunctions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_recfunctions.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">ma </span><span class="s0">as </span><span class="s1">ma</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">mrecords </span><span class="s0">import </span><span class="s1">MaskedRecords</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">testutils </span><span class="s0">import </span><span class="s1">assert_equal</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">drop_fields</span><span class="s2">, </span><span class="s1">rename_fields</span><span class="s2">, </span><span class="s1">get_fieldstructure</span><span class="s2">, </span><span class="s1">recursive_fill_fields</span><span class="s2">,</span>
    <span class="s1">find_duplicates</span><span class="s2">, </span><span class="s1">merge_arrays</span><span class="s2">, </span><span class="s1">append_fields</span><span class="s2">, </span><span class="s1">stack_arrays</span><span class="s2">, </span><span class="s1">join_by</span><span class="s2">,</span>
    <span class="s1">repack_fields</span><span class="s2">, </span><span class="s1">unstructured_to_structured</span><span class="s2">, </span><span class="s1">structured_to_unstructured</span><span class="s2">,</span>
    <span class="s1">apply_along_fields</span><span class="s2">, </span><span class="s1">require_fields</span><span class="s2">, </span><span class="s1">assign_fields_by_name</span><span class="s2">)</span>
<span class="s1">get_fieldspec </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions</span><span class="s2">.</span><span class="s1">_get_fieldspec</span>
<span class="s1">get_names </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions</span><span class="s2">.</span><span class="s1">get_names</span>
<span class="s1">get_names_flat </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions</span><span class="s2">.</span><span class="s1">get_names_flat</span>
<span class="s1">zip_descr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions</span><span class="s2">.</span><span class="s1">_zip_descr</span>
<span class="s1">zip_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">recfunctions</span><span class="s2">.</span><span class="s1">_zip_dtype</span>


<span class="s0">class </span><span class="s1">TestRecFunctions</span><span class="s2">:</span>
    <span class="s3"># Misc tests</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, ])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">)), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zip_descr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test zip_descr</span>
        <span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

        <span class="s3"># Std array</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]))</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]))</span>

        <span class="s3"># Std &amp; flexible-dtype</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]))</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                               <span class="s2">(</span><span class="s5">''</span><span class="s2">, [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])]))</span>

        <span class="s3"># Standard &amp; nested dtype</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                               <span class="s2">(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                               <span class="s2">(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]))</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">zip_descr</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">,</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                               <span class="s2">(</span><span class="s5">''</span><span class="s2">, [(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                     <span class="s2">(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])]))</span>

    <span class="s0">def </span><span class="s1">test_drop_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test drop_fields</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">)), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>

        <span class="s3"># A basic field</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">drop_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">'a'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">),), ((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">),)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s3"># Another basic field (but nesting two fields)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">drop_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,), (</span><span class="s4">4</span><span class="s2">,)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s3"># A nested sub-field</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">drop_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">'ba'</span><span class="s2">, ])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">3.0</span><span class="s2">,)), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">6.0</span><span class="s2">,))],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s3"># All the nested sub-field from a field: zap that field</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">drop_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s5">'bb'</span><span class="s2">])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,), (</span><span class="s4">4</span><span class="s2">,)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s3"># dropping all fields results in an array with no fields</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">drop_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(), ()], </span><span class="s1">dtype</span><span class="s2">=[])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rename_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test rename fields</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, [</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">])), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, [</span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">60.</span><span class="s2">]))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, (</span><span class="s1">float</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">rename_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'bb'</span><span class="s2">: </span><span class="s5">'BB'</span><span class="s2">})</span>
        <span class="s1">newdtype </span><span class="s2">= [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'BB'</span><span class="s2">, (</span><span class="s1">float</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))])]</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">newdtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">newdtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_get_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test get_names</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'a'</span><span class="s2">, (</span><span class="s5">'b'</span><span class="s2">, (</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s5">'bb'</span><span class="s2">))))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'a'</span><span class="s2">, (</span><span class="s5">'b'</span><span class="s2">, ())))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_get_names_flat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test get_names_flat</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names_flat</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names_flat</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'ba'</span><span class="s2">, </span><span class="s5">'bb'</span><span class="s2">))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names_flat</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">))</span>

        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_names_flat</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_get_fieldstructure</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test get_fieldstructure</span>

        <span class="s3"># No nested fields</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_fieldstructure</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, {</span><span class="s5">'A'</span><span class="s2">: [], </span><span class="s5">'B'</span><span class="s2">: []})</span>

        <span class="s3"># One 1-nested field</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, [(</span><span class="s5">'BA'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'BB'</span><span class="s2">, </span><span class="s5">'|S1'</span><span class="s2">)])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_fieldstructure</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, {</span><span class="s5">'A'</span><span class="s2">: [], </span><span class="s5">'B'</span><span class="s2">: [], </span><span class="s5">'BA'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">, ], </span><span class="s5">'BB'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">]})</span>

        <span class="s3"># One 2-nested fields</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                           <span class="s2">(</span><span class="s5">'B'</span><span class="s2">, [(</span><span class="s5">'BA'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'BB'</span><span class="s2">, [(</span><span class="s5">'BBA'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'BBB'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_fieldstructure</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= {</span><span class="s5">'A'</span><span class="s2">: [], </span><span class="s5">'B'</span><span class="s2">: [], </span><span class="s5">'BA'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">], </span><span class="s5">'BB'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">],</span>
                   <span class="s5">'BBA'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">, </span><span class="s5">'BB'</span><span class="s2">], </span><span class="s5">'BBB'</span><span class="s2">: [</span><span class="s5">'B'</span><span class="s2">, </span><span class="s5">'BB'</span><span class="s2">]}</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s3"># 0 fields</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">get_fieldstructure</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, {})</span>

    <span class="s0">def </span><span class="s1">test_find_duplicates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test find_duplicates</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">)), (</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">)), (</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">)),</span>
                      <span class="s2">(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">)), (</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">)), (</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">))],</span>
                     <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)),</span>
                           <span class="s2">(</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, [(</span><span class="s5">'BA'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'BB'</span><span class="s2">, </span><span class="s5">'|S1'</span><span class="s2">)])])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">ignoremask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s5">'BA'</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s5">'BB'</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_find_duplicates_ignoremask</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test the ignoremask option of find_duplicates</span>
        <span class="s1">ndtype </span><span class="s2">= [(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                     <span class="s1">mask</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">ignoremask</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">find_duplicates</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">ignoremask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">return_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">test</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_repack_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'u1,f4,i8'</span><span class="s2">, </span><span class="s1">align</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repack_fields</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'u1,f4,i8'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repack_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s4">13</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repack_fields</span><span class="s2">(</span><span class="s1">repack_fields</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">align</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s3"># make sure type is preserved</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">repack_fields</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">type </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_structured_to_unstructured</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4,u2'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">4</span><span class="s2">,</span><span class="s4">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">'f8'</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8 </span><span class="s2">,</span><span class="s4">11</span><span class="s2">), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'y'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'z'</span><span class="s2">, </span><span class="s5">'f8'</span><span class="s2">)])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">b</span><span class="s2">[[</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'z'</span><span class="s2">]]), </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([ </span><span class="s4">3. </span><span class="s2">,  </span><span class="s4">5.5</span><span class="s2">,  </span><span class="s4">9. </span><span class="s2">, </span><span class="s4">11. </span><span class="s2">]))</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">b</span><span class="s2">[[</span><span class="s5">'x'</span><span class="s2">]]), </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([ </span><span class="s4">1. </span><span class="s2">,  </span><span class="s4">4. </span><span class="s2">,  </span><span class="s4">7. </span><span class="s2">, </span><span class="s4">10. </span><span class="s2">]))</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">4</span><span class="s2">,</span><span class="s4">5</span><span class="s2">))</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">want </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([( </span><span class="s4">0</span><span class="s2">, ( </span><span class="s4">1.</span><span class="s2">,  </span><span class="s4">2</span><span class="s2">), [ </span><span class="s4">3.</span><span class="s2">,  </span><span class="s4">4.</span><span class="s2">]),</span>
                         <span class="s2">( </span><span class="s4">5</span><span class="s2">, ( </span><span class="s4">6.</span><span class="s2">,  </span><span class="s4">7</span><span class="s2">), [ </span><span class="s4">8.</span><span class="s2">,  </span><span class="s4">9.</span><span class="s2">]),</span>
                         <span class="s2">(</span><span class="s4">10</span><span class="s2">, (</span><span class="s4">11.</span><span class="s2">, </span><span class="s4">12</span><span class="s2">), [</span><span class="s4">13.</span><span class="s2">, </span><span class="s4">14.</span><span class="s2">]),</span>
                         <span class="s2">(</span><span class="s4">15</span><span class="s2">, (</span><span class="s4">16.</span><span class="s2">, </span><span class="s4">17</span><span class="s2">), [</span><span class="s4">18.</span><span class="s2">, </span><span class="s4">19.</span><span class="s2">])],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s5">'u2'</span><span class="s2">)]),</span>
                            <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">,))])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">want</span><span class="s2">)</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8 </span><span class="s2">,</span><span class="s4">11</span><span class="s2">), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'y'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'z'</span><span class="s2">, </span><span class="s5">'f8'</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">apply_along_fields</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">d</span><span class="s2">),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([ </span><span class="s4">8.0</span><span class="s2">/</span><span class="s4">3</span><span class="s2">,  </span><span class="s4">16.0</span><span class="s2">/</span><span class="s4">3</span><span class="s2">,  </span><span class="s4">26.0</span><span class="s2">/</span><span class="s4">3</span><span class="s2">, </span><span class="s4">11. </span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">apply_along_fields</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">d</span><span class="s2">[[</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'z'</span><span class="s2">]]),</span>
                     <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([ </span><span class="s4">3. </span><span class="s2">,  </span><span class="s4">5.5</span><span class="s2">,  </span><span class="s4">9. </span><span class="s2">, </span><span class="s4">11. </span><span class="s2">]))</span>

        <span class="s3"># check that for uniform field dtypes we get a view, not a copy:</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8 </span><span class="s2">,</span><span class="s4">11</span><span class="s2">), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'x'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'y'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'z'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">)])</span>
        <span class="s1">dd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">ddd </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>

        <span class="s3"># check that reversing the order of attributes works</span>
        <span class="s1">dd_attrib_rev </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[[</span><span class="s5">'z'</span><span class="s2">, </span><span class="s5">'x'</span><span class="s2">]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd_attrib_rev</span><span class="s2">, [[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">dd_attrib_rev</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>

        <span class="s3"># including uniform fields with subarrays unpacked</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">,  </span><span class="s4">3</span><span class="s2">], [[ </span><span class="s4">4</span><span class="s2">,  </span><span class="s4">5</span><span class="s2">], [ </span><span class="s4">6</span><span class="s2">,  </span><span class="s4">7</span><span class="s2">]]),</span>
                      <span class="s2">(</span><span class="s4">8</span><span class="s2">, [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">], [[</span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">], [</span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">]])],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'x0'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'x1'</span><span class="s2">, (</span><span class="s5">'i4'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)),</span>
                            <span class="s2">(</span><span class="s5">'x2'</span><span class="s2">, (</span><span class="s5">'i4'</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)))])</span>
        <span class="s1">dd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">ddd </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>

        <span class="s3"># check that reversing with sub-arrays works as expected</span>
        <span class="s1">d_rev </span><span class="s2">= </span><span class="s1">d</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">dd_rev </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d_rev</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd_rev</span><span class="s2">, [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">],</span>
                              <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>

        <span class="s3"># check that sub-arrays keep the order of their values</span>
        <span class="s1">d_attrib_rev </span><span class="s2">= </span><span class="s1">d</span><span class="s2">[[</span><span class="s5">'x2'</span><span class="s2">, </span><span class="s5">'x1'</span><span class="s2">, </span><span class="s5">'x0'</span><span class="s2">]]</span>
        <span class="s1">dd_attrib_rev </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d_attrib_rev</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd_attrib_rev</span><span class="s2">, [[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]])</span>

        <span class="s3"># with ignored field at the end</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">,  </span><span class="s4">3</span><span class="s2">], [[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]], </span><span class="s4">32</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s4">8</span><span class="s2">, [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">], [[</span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">], [</span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">]], </span><span class="s4">64</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'x0'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'x1'</span><span class="s2">, (</span><span class="s5">'i4'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)),</span>
                            <span class="s2">(</span><span class="s5">'x2'</span><span class="s2">, (</span><span class="s5">'i4'</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))), (</span><span class="s5">'ignored'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])</span>
        <span class="s1">dd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[[</span><span class="s5">'x0'</span><span class="s2">, </span><span class="s5">'x1'</span><span class="s2">, </span><span class="s5">'x2'</span><span class="s2">]])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">]])</span>

        <span class="s3"># test that nested fields with identical names don't break anything</span>
        <span class="s1">point </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'x'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'y'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">triangle </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">point</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">point</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">point</span><span class="s2">)])</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">triangle</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">6</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">))</span>


        <span class="s3"># test nested combinations of subarrays and structured arrays, gh-13333</span>
        <span class="s0">def </span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">((</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">))</span>

        <span class="s0">def </span><span class="s1">structured</span><span class="s2">(*</span><span class="s1">dts</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'x{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">dt</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">dts</span><span class="s2">)])</span>

        <span class="s0">def </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((), </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">backarr </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">ret</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">ret</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">backarr</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">structured</span><span class="s2">(</span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">structured</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), ((</span><span class="s4">6</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">structured</span><span class="s2">(</span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), ((</span><span class="s4">4</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">structured</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), ((</span><span class="s4">1</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">structured</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">subarray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), ((</span><span class="s4">5</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">structured</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">structured_to_unstructured</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s3"># these currently don't work, but we may make it work in the future</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">structured_to_unstructured</span><span class="s2">,</span>
                                           <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">unstructured_to_structured</span><span class="s2">,</span>
                                           <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">3</span><span class="s2">,</span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>

        <span class="s3"># test supported ndarray subclasses</span>
        <span class="s1">d_plain </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">)])</span>
        <span class="s1">dd_expected </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d_plain</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s3"># recarray</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">d_plain</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s1">dd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ddd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">dd</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">) </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">) </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">dd_expected</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">, </span><span class="s1">dd_expected</span><span class="s2">)</span>

        <span class="s3"># memmap</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">memmap</span><span class="s2">(</span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s5">'memmap'</span><span class="s2">,</span>
                      <span class="s1">mode</span><span class="s2">=</span><span class="s5">'w+'</span><span class="s2">,</span>
                      <span class="s1">dtype</span><span class="s2">=</span><span class="s1">d_plain</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">,</span>
                      <span class="s1">shape</span><span class="s2">=</span><span class="s1">d_plain</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">d</span><span class="s2">[:] = </span><span class="s1">d_plain</span>
        <span class="s1">dd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ddd </span><span class="s2">= </span><span class="s1">structured_to_unstructured</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">dd</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">) </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">memmap</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">) </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">memmap</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dd</span><span class="s2">, </span><span class="s1">dd_expected</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ddd</span><span class="s2">, </span><span class="s1">dd_expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unstructured_to_structured</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test if dtype is the args of np.dtype</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">test_dtype_args </span><span class="s2">= [(</span><span class="s5">'x'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'y'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">test_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">test_dtype_args</span><span class="s2">)</span>
        <span class="s1">field1 </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">test_dtype_args</span><span class="s2">)  </span><span class="s3"># now</span>
        <span class="s1">field2 </span><span class="s2">= </span><span class="s1">unstructured_to_structured</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">test_dtype</span><span class="s2">)  </span><span class="s3"># before</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">field1</span><span class="s2">, </span><span class="s1">field2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_field_assignment_by_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f8'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])</span>
        <span class="s1">newdt </span><span class="s2">= [(</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)]</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">require_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">newdt</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">newdt</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">,</span><span class="s4">4</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">newdt</span><span class="s2">)</span>
        <span class="s1">assign_fields_by_name</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">zero_unassigned</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">),(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">3</span><span class="s2">,</span><span class="s4">4</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assign_fields_by_name</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">),(</span><span class="s4">0</span><span class="s2">,</span><span class="s4">3</span><span class="s2">,</span><span class="s4">4</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s3"># test nested fields</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, [(</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f8'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])])</span>
        <span class="s1">newdt </span><span class="s2">= [(</span><span class="s5">'a'</span><span class="s2">, [(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">require_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">newdt</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">newdt</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([((</span><span class="s4">2</span><span class="s2">,),), ((</span><span class="s4">3</span><span class="s2">,),)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">newdt</span><span class="s2">)</span>
        <span class="s1">assign_fields_by_name</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">zero_unassigned</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([((</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">),), ((</span><span class="s4">1</span><span class="s2">,</span><span class="s4">3</span><span class="s2">),)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assign_fields_by_name</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">2</span><span class="s2">),), ((</span><span class="s4">0</span><span class="s2">,</span><span class="s4">3</span><span class="s2">),)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s3"># test unstructured code path for 0d arrays</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assign_fields_by_name</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">[()], </span><span class="s4">3</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRecursiveFillFields</span><span class="s2">:</span>
    <span class="s3"># Test recursive_fill_fields.</span>
    <span class="s0">def </span><span class="s1">test_simple_flexible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test recursive_fill_fields on flexible-array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">recursive_fill_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_masked_flexible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test recursive_fill_fields on masked flexible-array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">)], </span><span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">recursive_fill_fields</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMergeArrays</span><span class="s2">:</span>
    <span class="s3"># Test merge_arrays</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, ])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, ())), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, ()))],</span>
            <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'bc'</span><span class="s2">, [])])])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_solo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test merge_arrays on a single array.</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,), (</span><span class="s4">2</span><span class="s2">,)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_solo_w_flatten</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test merge_arrays on a single array w &amp; w/o flattening</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_standard</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test standard &amp; standard</span>
        <span class="s3"># Test merge arrays</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_flatten</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test standard &amp; flexible</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">)), (</span><span class="s4">2</span><span class="s2">, (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">))],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'f1'</span><span class="s2">, [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_flatten_wflexible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test flatten standard &amp; nested</span>
        <span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">flatten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">controldtype </span><span class="s2">= [(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                <span class="s2">(</span><span class="s5">'f1'</span><span class="s2">, [(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                        <span class="s2">(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'bc'</span><span class="s2">, [])])])]</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1.</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, ()))), (</span><span class="s4">2</span><span class="s2">, (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, ())))],</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">controldtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wmasked_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test merge_arrays masked arrays</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">mx </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">mx</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">mx</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">asrecarray</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">MaskedRecords</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_w_singlefield</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test single field</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10.</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">])),)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_w_shorter_flex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test merge_arrays w/ a shorter flexndarray.</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s3"># Fixme, this test looks incomplete and broken</span>
        <span class="s3">#test = merge_arrays((z, np.array([10, 20, 30]).view([('C', int)])))</span>
        <span class="s3">#control = np.array([('A', 1., 10), ('B', 2., 20), ('-1', -1, 20)],</span>
        <span class="s3">#                   dtype=[('A', '|S3'), ('B', float), ('C', int)])</span>
        <span class="s3">#assert_equal(test, control)</span>

        <span class="s3"># Hack to avoid pyflakes warnings about unused variables</span>
        <span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">([(</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), (</span><span class="s5">'-1'</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)],</span>
                 <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_singlerecord</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">merge_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">z</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'f1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'f2'</span><span class="s2">, [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAppendFields</span><span class="s2">:</span>
    <span class="s3"># Test append_fields</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, ])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">)), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_append_single</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test simple case</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">append_fields</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">=[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)],)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_append_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test simple case</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">append_fields</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">), </span><span class="s1">data</span><span class="s2">=[[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">], [</span><span class="s4">100</span><span class="s2">, </span><span class="s4">200</span><span class="s2">]])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">200</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)],)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_append_on_flex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test append_fields on flexible type arrays</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">append_fields</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">=[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)],)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_append_on_nested</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test append_fields on nested fields</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">append_fields</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">=[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">), </span><span class="s4">10</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">), </span><span class="s4">20</span><span class="s2">),</span>
                            <span class="s2">(-</span><span class="s4">1</span><span class="s2">, (-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">), </span><span class="s4">30</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span>
                               <span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]),</span>
                                  <span class="s2">(</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)],)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestStackArrays</span><span class="s2">:</span>
    <span class="s3"># Test stack_arrays</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, ])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">)), (</span><span class="s4">4</span><span class="s2">, (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">))],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [(</span><span class="s5">'ba'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'bb'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_solo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test stack_arrays on single arrays</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">test </span><span class="s0">is </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">test </span><span class="s0">is </span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unnamed_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Tests combinations of arrays w/o named fields</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unnamed_and_named_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test combination of arrays w/ &amp; w/o named fields</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">z</span><span class="s2">))</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'f0'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), ],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'f2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), ],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'f2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_matching_named_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test combination of arrays w/ matching field names</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">100.</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">200.</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">, </span><span class="s4">300.</span><span class="s2">)],</span>
                      <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">))</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span>
                                <span class="s5">'a'</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">100.</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">200.</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">, </span><span class="s4">300.</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">ndtype </span><span class="s2">= [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'f3'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">100.</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">200.</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">, </span><span class="s4">300.</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">ndtype</span><span class="s2">,</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_defaults</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test defaults: no exception raised if keys of defaults are not fields.</span>
        <span class="s2">(</span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">z</span><span class="s2">) = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">100.</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">200.</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">, </span><span class="s4">300.</span><span class="s2">)],</span>
                      <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">defaults </span><span class="s2">= {</span><span class="s5">'A'</span><span class="s2">: </span><span class="s5">'???'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">: -</span><span class="s4">999.</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">: -</span><span class="s4">9999.</span><span class="s2">, </span><span class="s5">'D'</span><span class="s2">: -</span><span class="s4">99999.</span><span class="s2">}</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">), </span><span class="s1">defaults</span><span class="s2">=</span><span class="s1">defaults</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">9999.</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">9999.</span><span class="s2">),</span>
                            <span class="s2">(</span>
                                <span class="s5">'a'</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">100.</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">200.</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s4">30.</span><span class="s2">, </span><span class="s4">300.</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_autoconversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Tests autoconversion</span>
        <span class="s1">adtype </span><span class="s2">= [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)], </span><span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">adtype</span><span class="s2">)</span>
        <span class="s1">bdtype </span><span class="s2">= [(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bdtype</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)], </span><span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">bdtype</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">autoconvert</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">autoconvert</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_checktitles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test using titles in the field names</span>
        <span class="s1">adtype </span><span class="s2">= [((</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">), </span><span class="s1">int</span><span class="s2">), ((</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">), </span><span class="s1">bool</span><span class="s2">), ((</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">), </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)], </span><span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">adtype</span><span class="s2">)</span>
        <span class="s1">bdtype </span><span class="s2">= [((</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">), </span><span class="s1">int</span><span class="s2">), ((</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'B'</span><span class="s2">), </span><span class="s1">bool</span><span class="s2">), ((</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">), </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bdtype</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)], </span><span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">bdtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subdtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s2">], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">,))])</span>
        <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s5">'a'</span><span class="s2">, [</span><span class="s4">10.</span><span class="s2">], </span><span class="s4">100.</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, [</span><span class="s4">20.</span><span class="s2">], </span><span class="s4">200.</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, [</span><span class="s4">30.</span><span class="s2">], </span><span class="s4">300.</span><span class="s2">)</span>
        <span class="s2">], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s5">'|S3'</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">,)), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stack_arrays</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">=[</span>
                <span class="s2">(</span><span class="s6">b'A'</span><span class="s2">, [</span><span class="s4">1.0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s6">b'B'</span><span class="s2">, [</span><span class="s4">2.0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s6">b'a'</span><span class="s2">, [</span><span class="s4">10.0</span><span class="s2">], </span><span class="s4">100.0</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s6">b'b'</span><span class="s2">, [</span><span class="s4">20.0</span><span class="s2">], </span><span class="s4">200.0</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s6">b'c'</span><span class="s2">, [</span><span class="s4">30.0</span><span class="s2">], </span><span class="s4">300.0</span><span class="s2">)],</span>
            <span class="s1">mask</span><span class="s2">=[</span>
                <span class="s2">(</span><span class="s0">False</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">],  </span><span class="s0">True</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s0">False</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">],  </span><span class="s0">True</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s0">False</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">], </span><span class="s0">False</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s0">False</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">], </span><span class="s0">False</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s0">False</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">], </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">zz</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestJoinBy</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">, </span><span class="s4">60</span><span class="s2">),</span>
                                   <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">110</span><span class="s2">))),</span>
                          <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">15</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">65</span><span class="s2">, </span><span class="s4">75</span><span class="s2">),</span>
                                   <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">110</span><span class="s2">))),</span>
                          <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_inner_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Basic test of join_by</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">jointype</span><span class="s2">=</span><span class="s5">'inner'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">66</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">101</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">67</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, </span><span class="s4">102</span><span class="s2">), (</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">68</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">103</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">69</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, </span><span class="s4">104</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s3"># Fixme, this test is broken</span>
        <span class="s3">#test = join_by(('a', 'b'), a, b)</span>
        <span class="s3">#control = np.array([(5, 55, 105, 100), (6, 56, 106, 101),</span>
        <span class="s3">#                    (7, 57, 107, 102), (8, 58, 108, 103),</span>
        <span class="s3">#                    (9, 59, 109, 104)],</span>
        <span class="s3">#                   dtype=[('a', int), ('b', int),</span>
        <span class="s3">#                          ('c', int), ('d', int)])</span>
        <span class="s3">#assert_equal(test, control)</span>

        <span class="s3"># Hack to avoid pyflakes unused variable warnings</span>
        <span class="s1">join_by</span><span class="s2">((</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">), </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">101</span><span class="s2">),</span>
                  <span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, </span><span class="s4">102</span><span class="s2">), (</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">103</span><span class="s2">),</span>
                  <span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, </span><span class="s4">104</span><span class="s2">)],</span>
                  <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                         <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_join_subdtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># tests the bug in https://stackoverflow.com/q/44769632/102441</span>
        <span class="s1">foo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,)],</span>
                       <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">bar </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">,</span><span class="s4">3</span><span class="s2">]))],</span>
                       <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'value'</span><span class="s2">, </span><span class="s5">'uint16'</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s1">foo</span><span class="s2">, </span><span class="s1">bar</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">bar</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">MaskedArray</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_outer_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">((</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">), </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s5">'outer'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s4">101</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">102</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">53</span><span class="s2">, </span><span class="s4">103</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">54</span><span class="s2">, </span><span class="s4">104</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">66</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">101</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s4">67</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">102</span><span class="s2">), (</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s4">68</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">103</span><span class="s2">), (</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">69</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">104</span><span class="s2">), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">70</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">105</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">11</span><span class="s2">, </span><span class="s4">71</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">106</span><span class="s2">), (</span><span class="s4">12</span><span class="s2">, </span><span class="s4">72</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">107</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">13</span><span class="s2">, </span><span class="s4">73</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">108</span><span class="s2">), (</span><span class="s4">14</span><span class="s2">, </span><span class="s4">74</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">109</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_leftouter_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">((</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">), </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s5">'leftouter'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s4">101</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">102</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">53</span><span class="s2">, </span><span class="s4">103</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">54</span><span class="s2">, </span><span class="s4">104</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), (</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)],</span>
                           <span class="s1">mask</span><span class="s2">=[(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                                 <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_different_field_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># gh-8940</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">)])</span>
        <span class="s3"># this should not give a FutureWarning:</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">([</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">], </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">jointype</span><span class="s2">=</span><span class="s5">'inner'</span><span class="s2">, </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">names</span><span class="s2">, [</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'a1'</span><span class="s2">, </span><span class="s5">'a2'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_duplicate_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s5">'u1'</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'i4'</span><span class="s2">)])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">join_by</span><span class="s2">, [</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">], </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_same_name_different_dtypes_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'S5'</span><span class="s2">), (</span><span class="s5">'value'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">b_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'S10'</span><span class="s2">), (</span><span class="s5">'value'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">expected_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'S10'</span><span class="s2">), (</span><span class="s5">'value1'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">), (</span><span class="s5">'value2'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'Sarah'</span><span class="s2">,  </span><span class="s4">8.0</span><span class="s2">), (</span><span class="s5">'John'</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'Sarah'</span><span class="s2">, </span><span class="s4">10.0</span><span class="s2">), (</span><span class="s5">'John'</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">b_dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected_dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_same_name_different_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># gh-9338</span>
        <span class="s1">a_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'S10'</span><span class="s2">), (</span><span class="s5">'value'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">b_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'S10'</span><span class="s2">), (</span><span class="s5">'value'</span><span class="s2">, </span><span class="s5">'&lt;f8'</span><span class="s2">)])</span>
        <span class="s1">expected_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s5">'|S10'</span><span class="s2">), (</span><span class="s5">'value1'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">), (</span><span class="s5">'value2'</span><span class="s2">, </span><span class="s5">'&lt;f8'</span><span class="s2">)])</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'Sarah'</span><span class="s2">,  </span><span class="s4">8.0</span><span class="s2">), (</span><span class="s5">'John'</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">'Sarah'</span><span class="s2">, </span><span class="s4">10.0</span><span class="s2">), (</span><span class="s5">'John'</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">b_dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'key'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected_dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subarray_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'pos'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s5">'f'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">), ([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">0.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_dtype</span><span class="s2">)</span>

        <span class="s1">b_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'pos'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s5">'g'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s4">3</span><span class="s2">), ([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s4">0.0</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">b_dtype</span><span class="s2">)</span>

        <span class="s1">expected_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s5">'pos'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s5">'f'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">), (</span><span class="s5">'g'</span><span class="s2">, </span><span class="s5">'&lt;f4'</span><span class="s2">)])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">expected_dtype</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'pos'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected_dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_padded_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'i1,f4'</span><span class="s2">, </span><span class="s1">align</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">dt</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= (</span><span class="s5">'k'</span><span class="s2">, </span><span class="s5">'v'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">descr</span><span class="s2">), </span><span class="s4">3</span><span class="s2">)  </span><span class="s3"># padding field is inserted</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s3"># no padding fields remain</span>
        <span class="s1">expected_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s5">'k'</span><span class="s2">, </span><span class="s5">'i1'</span><span class="s2">), (</span><span class="s5">'v1'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">), (</span><span class="s5">'v2'</span><span class="s2">, </span><span class="s5">'f4'</span><span class="s2">)</span>
        <span class="s2">])</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected_dtype</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestJoinBy2</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">, </span><span class="s4">60</span><span class="s2">),</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">110</span><span class="s2">))),</span>
                         <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">65</span><span class="s2">, </span><span class="s4">75</span><span class="s2">),</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">110</span><span class="s2">))),</span>
                         <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_no_r1postfix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Basic test of join_by no_r1postfix</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span>
            <span class="s5">'a'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">r1postfix</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">r2postfix</span><span class="s2">=</span><span class="s5">'2'</span><span class="s2">, </span><span class="s1">jointype</span><span class="s2">=</span><span class="s5">'inner'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s4">66</span><span class="s2">, </span><span class="s4">101</span><span class="s2">, </span><span class="s4">101</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">67</span><span class="s2">, </span><span class="s4">102</span><span class="s2">, </span><span class="s4">102</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">53</span><span class="s2">, </span><span class="s4">68</span><span class="s2">, </span><span class="s4">103</span><span class="s2">, </span><span class="s4">103</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">54</span><span class="s2">, </span><span class="s4">69</span><span class="s2">, </span><span class="s4">104</span><span class="s2">, </span><span class="s4">104</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">70</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">105</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">71</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">106</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">72</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, </span><span class="s4">107</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">73</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">108</span><span class="s2">), (</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">74</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, </span><span class="s4">109</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_no_postfix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">join_by</span><span class="s2">, </span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">,</span>
                      <span class="s1">r1postfix</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">r2postfix</span><span class="s2">=</span><span class="s5">''</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_no_r2postfix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Basic test of join_by no_r2postfix</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span>
            <span class="s5">'a'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">r1postfix</span><span class="s2">=</span><span class="s5">'1'</span><span class="s2">, </span><span class="s1">r2postfix</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">jointype</span><span class="s2">=</span><span class="s5">'inner'</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s4">66</span><span class="s2">, </span><span class="s4">101</span><span class="s2">, </span><span class="s4">101</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">67</span><span class="s2">, </span><span class="s4">102</span><span class="s2">, </span><span class="s4">102</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">53</span><span class="s2">, </span><span class="s4">68</span><span class="s2">, </span><span class="s4">103</span><span class="s2">, </span><span class="s4">103</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">54</span><span class="s2">, </span><span class="s4">69</span><span class="s2">, </span><span class="s4">104</span><span class="s2">, </span><span class="s4">104</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">70</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">105</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">71</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">106</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">72</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, </span><span class="s4">107</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">73</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">108</span><span class="s2">), (</span><span class="s4">9</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">74</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, </span><span class="s4">109</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'d'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_two_keys_two_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], </span><span class="s4">5</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s4">2</span><span class="s2">),</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">, </span><span class="s4">60</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">))),</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'k'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], </span><span class="s4">5</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s4">2</span><span class="s2">),</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">65</span><span class="s2">, </span><span class="s4">75</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))),</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'k'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>

        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">11</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s4">66</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">67</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">11</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">53</span><span class="s2">, </span><span class="s4">68</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">3</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">54</span><span class="s2">, </span><span class="s4">69</span><span class="s2">, </span><span class="s4">14</span><span class="s2">, </span><span class="s4">4</span><span class="s2">), (</span><span class="s4">11</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">70</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">5</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">71</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">6</span><span class="s2">), (</span><span class="s4">11</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">72</span><span class="s2">, </span><span class="s4">17</span><span class="s2">, </span><span class="s4">7</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">58</span><span class="s2">, </span><span class="s4">73</span><span class="s2">, </span><span class="s4">18</span><span class="s2">, </span><span class="s4">8</span><span class="s2">), (</span><span class="s4">11</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">74</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'k'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'b1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s5">'b2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c1'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s5">'c2'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">join_by</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'k'</span><span class="s2">], </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">r1postfix</span><span class="s2">=</span><span class="s5">'1'</span><span class="s2">, </span><span class="s1">r2postfix</span><span class="s2">=</span><span class="s5">'2'</span><span class="s2">, </span><span class="s1">jointype</span><span class="s2">=</span><span class="s5">'inner'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">control</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestAppendFieldsObj</span><span class="s2">:</span>
    <span class="s7">&quot;&quot;&quot; 
    Test append_fields with arrays containing objects 
    &quot;&quot;&quot;</span>
    <span class="s3"># https://github.com/numpy/numpy/issues/2346</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">date</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">=</span><span class="s1">date</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_append_to_objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s7">&quot;Test append_fields when the base array contains objects&quot;</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s5">'obj'</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">), (</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">)],</span>
                      <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">object</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">test </span><span class="s2">= </span><span class="s1">append_fields</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">=</span><span class="s1">y</span><span class="s2">, </span><span class="s1">usemask</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">control </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)],</span>
                           <span class="s1">dtype</span><span class="s2">=[(</span><span class="s5">'A'</span><span class="s2">, </span><span class="s1">object</span><span class="s2">), (</span><span class="s5">'B'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">control</span><span class="s2">)</span>
</pre>
</body>
</html>