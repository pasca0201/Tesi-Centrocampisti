<html>
<head>
<title>textpath.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
textpath.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">OrderedDict</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_text_helpers</span><span class="s2">, </span><span class="s1">dviread</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">font_manager </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">FontProperties</span><span class="s2">, </span><span class="s1">get_font</span><span class="s2">, </span><span class="s1">fontManager </span><span class="s0">as </span><span class="s1">_fontManager</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">ft2font </span><span class="s0">import </span><span class="s1">LOAD_NO_HINTING</span><span class="s2">, </span><span class="s1">LOAD_TARGET_LIGHT</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">mathtext </span><span class="s0">import </span><span class="s1">MathTextParser</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">texmanager </span><span class="s0">import </span><span class="s1">TexManager</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">import </span><span class="s1">Affine2D</span>

<span class="s1">_log </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TextToPath</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot;A class that converts strings to paths.&quot;&quot;&quot;</span>

    <span class="s1">FONT_SCALE </span><span class="s2">= </span><span class="s4">100.</span>
    <span class="s1">DPI </span><span class="s2">= </span><span class="s4">72</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mathtext_parser </span><span class="s2">= </span><span class="s1">MathTextParser</span><span class="s2">(</span><span class="s5">'path'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_texmanager </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">_get_font</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Find the `FT2Font` matching font properties *prop*, with its size set. 
        &quot;&quot;&quot;</span>
        <span class="s1">filenames </span><span class="s2">= </span><span class="s1">_fontManager</span><span class="s2">.</span><span class="s1">_find_fonts_by_props</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">)</span>
        <span class="s1">font </span><span class="s2">= </span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">filenames</span><span class="s2">)</span>
        <span class="s1">font</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DPI</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">font</span>

    <span class="s0">def </span><span class="s1">_get_hinting_flag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">LOAD_NO_HINTING</span>

    <span class="s0">def </span><span class="s1">_get_char_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">ccode</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Return a unique id for the given font and character-code set. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">.</span><span class="s1">quote</span><span class="s2">(</span><span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">font</span><span class="s2">.</span><span class="s1">postscript_name</span><span class="s0">}</span><span class="s5">-</span><span class="s0">{</span><span class="s1">ccode</span><span class="s0">:</span><span class="s5">x</span><span class="s0">}</span><span class="s5">&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_text_width_height_descent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">, </span><span class="s1">ismath</span><span class="s2">):</span>
        <span class="s1">fontsize </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">.</span><span class="s1">get_size_in_points</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">ismath </span><span class="s2">== </span><span class="s5">&quot;TeX&quot;</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">TexManager</span><span class="s2">().</span><span class="s1">get_text_width_height_descent</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">)</span>

        <span class="s1">scale </span><span class="s2">= </span><span class="s1">fontsize </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span>

        <span class="s0">if </span><span class="s1">ismath</span><span class="s2">:</span>
            <span class="s1">prop </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">prop</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">)</span>
            <span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">descent</span><span class="s2">, *</span><span class="s1">_ </span><span class="s2">= </span><span class="s1">\</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">mathtext_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s4">72</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">width </span><span class="s2">* </span><span class="s1">scale</span><span class="s2">, </span><span class="s1">height </span><span class="s2">* </span><span class="s1">scale</span><span class="s2">, </span><span class="s1">descent </span><span class="s2">* </span><span class="s1">scale</span>

        <span class="s1">font </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_font</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">)</span>
        <span class="s1">font</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">LOAD_NO_HINTING</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_width_height</span><span class="s2">()</span>
        <span class="s1">w </span><span class="s2">/= </span><span class="s4">64.0  </span><span class="s6"># convert from subpixels</span>
        <span class="s1">h </span><span class="s2">/= </span><span class="s4">64.0</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_descent</span><span class="s2">()</span>
        <span class="s1">d </span><span class="s2">/= </span><span class="s4">64.0</span>
        <span class="s0">return </span><span class="s1">w </span><span class="s2">* </span><span class="s1">scale</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s1">scale</span><span class="s2">, </span><span class="s1">d </span><span class="s2">* </span><span class="s1">scale</span>

    <span class="s0">def </span><span class="s1">get_text_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">ismath</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Convert text *s* to path (a tuple of vertices and codes for 
        matplotlib.path.Path). 
 
        Parameters 
        ---------- 
        prop : `~matplotlib.font_manager.FontProperties` 
            The font properties for the text. 
        s : str 
            The text to be converted. 
        ismath : {False, True, &quot;TeX&quot;} 
            If True, use mathtext parser.  If &quot;TeX&quot;, use tex for rendering. 
 
        Returns 
        ------- 
        verts : list 
            A list of arrays containing the (x, y) coordinates of the vertices. 
        codes : list 
            A list of path codes. 
 
        Examples 
        -------- 
        Create a list of vertices and codes from a text, and create a `.Path` 
        from those:: 
 
            from matplotlib.path import Path 
            from matplotlib.text import TextToPath 
            from matplotlib.font_manager import FontProperties 
 
            fp = FontProperties(family=&quot;Comic Neue&quot;, style=&quot;italic&quot;) 
            verts, codes = TextToPath().get_text_path(fp, &quot;ABC&quot;) 
            path = Path(verts, codes, closed=False) 
 
        Also see `TextPath` for a more direct way to create a path from a text. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">ismath </span><span class="s2">== </span><span class="s5">&quot;TeX&quot;</span><span class="s2">:</span>
            <span class="s1">glyph_info</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">, </span><span class="s1">rects </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_glyphs_tex</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">ismath</span><span class="s2">:</span>
            <span class="s1">font </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_font</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">)</span>
            <span class="s1">glyph_info</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">, </span><span class="s1">rects </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_glyphs_with_font</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">glyph_info</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">, </span><span class="s1">rects </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_glyphs_mathtext</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>

        <span class="s1">verts</span><span class="s2">, </span><span class="s1">codes </span><span class="s2">= [], []</span>
        <span class="s0">for </span><span class="s1">glyph_id</span><span class="s2">, </span><span class="s1">xposition</span><span class="s2">, </span><span class="s1">yposition</span><span class="s2">, </span><span class="s1">scale </span><span class="s0">in </span><span class="s1">glyph_info</span><span class="s2">:</span>
            <span class="s1">verts1</span><span class="s2">, </span><span class="s1">codes1 </span><span class="s2">= </span><span class="s1">glyph_map</span><span class="s2">[</span><span class="s1">glyph_id</span><span class="s2">]</span>
            <span class="s1">verts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">verts1 </span><span class="s2">* </span><span class="s1">scale </span><span class="s2">+ [</span><span class="s1">xposition</span><span class="s2">, </span><span class="s1">yposition</span><span class="s2">])</span>
            <span class="s1">codes</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">codes1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">verts1</span><span class="s2">, </span><span class="s1">codes1 </span><span class="s0">in </span><span class="s1">rects</span><span class="s2">:</span>
            <span class="s1">verts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">verts1</span><span class="s2">)</span>
            <span class="s1">codes</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">codes1</span><span class="s2">)</span>

        <span class="s6"># Make sure an empty string or one with nothing to print</span>
        <span class="s6"># (e.g. only spaces &amp; newlines) will be valid/empty path</span>
        <span class="s0">if not </span><span class="s1">verts</span><span class="s2">:</span>
            <span class="s1">verts </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">verts</span><span class="s2">, </span><span class="s1">codes</span>

    <span class="s0">def </span><span class="s1">get_glyphs_with_font</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                             <span class="s1">return_new_glyphs_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Convert string *s* to vertices and codes using the provided ttf font. 
        &quot;&quot;&quot;</span>

        <span class="s0">if </span><span class="s1">glyph_map </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">glyph_map </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">return_new_glyphs_only</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">glyph_map</span>

        <span class="s1">xpositions </span><span class="s2">= []</span>
        <span class="s1">glyph_ids </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">_text_helpers</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
            <span class="s1">char_id </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_char_id</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">ft_object</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">char</span><span class="s2">))</span>
            <span class="s1">glyph_ids</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">char_id</span><span class="s2">)</span>
            <span class="s1">xpositions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">char_id </span><span class="s0">not in </span><span class="s1">glyph_map</span><span class="s2">:</span>
                <span class="s1">glyph_map_new</span><span class="s2">[</span><span class="s1">char_id</span><span class="s2">] = </span><span class="s1">item</span><span class="s2">.</span><span class="s1">ft_object</span><span class="s2">.</span><span class="s1">get_path</span><span class="s2">()</span>

        <span class="s1">ypositions </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xpositions</span><span class="s2">)</span>
        <span class="s1">sizes </span><span class="s2">= [</span><span class="s4">1.</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xpositions</span><span class="s2">)</span>

        <span class="s1">rects </span><span class="s2">= []</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">glyph_ids</span><span class="s2">, </span><span class="s1">xpositions</span><span class="s2">, </span><span class="s1">ypositions</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">)),</span>
                <span class="s1">glyph_map_new</span><span class="s2">, </span><span class="s1">rects</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_glyphs_mathtext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                            <span class="s1">return_new_glyphs_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Parse mathtext string *s* and convert it to a (vertices, codes) pair. 
        &quot;&quot;&quot;</span>

        <span class="s1">prop </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">prop</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">)</span>

        <span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">descent</span><span class="s2">, </span><span class="s1">glyphs</span><span class="s2">, </span><span class="s1">rects </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mathtext_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span>
            <span class="s1">s</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DPI</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">glyph_map</span><span class="s2">:</span>
            <span class="s1">glyph_map </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">return_new_glyphs_only</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">glyph_map</span>

        <span class="s1">xpositions </span><span class="s2">= []</span>
        <span class="s1">ypositions </span><span class="s2">= []</span>
        <span class="s1">glyph_ids </span><span class="s2">= []</span>
        <span class="s1">sizes </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">font</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">, </span><span class="s1">ccode</span><span class="s2">, </span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy </span><span class="s0">in </span><span class="s1">glyphs</span><span class="s2">:</span>
            <span class="s1">char_id </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_char_id</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">ccode</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">char_id </span><span class="s0">not in </span><span class="s1">glyph_map</span><span class="s2">:</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DPI</span><span class="s2">)</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">load_char</span><span class="s2">(</span><span class="s1">ccode</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">LOAD_NO_HINTING</span><span class="s2">)</span>
                <span class="s1">glyph_map_new</span><span class="s2">[</span><span class="s1">char_id</span><span class="s2">] = </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_path</span><span class="s2">()</span>

            <span class="s1">xpositions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ox</span><span class="s2">)</span>
            <span class="s1">ypositions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">oy</span><span class="s2">)</span>
            <span class="s1">glyph_ids</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">char_id</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">fontsize </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span>
            <span class="s1">sizes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>

        <span class="s1">myrects </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s0">in </span><span class="s1">rects</span><span class="s2">:</span>
            <span class="s1">vert1 </span><span class="s2">= [(</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy </span><span class="s2">+ </span><span class="s1">h</span><span class="s2">), (</span><span class="s1">ox </span><span class="s2">+ </span><span class="s1">w</span><span class="s2">, </span><span class="s1">oy </span><span class="s2">+ </span><span class="s1">h</span><span class="s2">),</span>
                     <span class="s2">(</span><span class="s1">ox </span><span class="s2">+ </span><span class="s1">w</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]</span>
            <span class="s1">code1 </span><span class="s2">= [</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">,</span>
                     <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
                     <span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">]</span>
            <span class="s1">myrects</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">vert1</span><span class="s2">, </span><span class="s1">code1</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">glyph_ids</span><span class="s2">, </span><span class="s1">xpositions</span><span class="s2">, </span><span class="s1">ypositions</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">)),</span>
                <span class="s1">glyph_map_new</span><span class="s2">, </span><span class="s1">myrects</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_glyphs_tex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">glyph_map</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                       <span class="s1">return_new_glyphs_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Convert the string *s* to vertices and codes using usetex mode.&quot;&quot;&quot;</span>
        <span class="s6"># Mostly borrowed from pdf backend.</span>

        <span class="s1">dvifile </span><span class="s2">= </span><span class="s1">TexManager</span><span class="s2">().</span><span class="s1">make_dvi</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">dviread</span><span class="s2">.</span><span class="s1">Dvi</span><span class="s2">(</span><span class="s1">dvifile</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DPI</span><span class="s2">) </span><span class="s0">as </span><span class="s1">dvi</span><span class="s2">:</span>
            <span class="s1">page</span><span class="s2">, = </span><span class="s1">dvi</span>

        <span class="s0">if </span><span class="s1">glyph_map </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">glyph_map </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">return_new_glyphs_only</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">OrderedDict</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">glyph_map_new </span><span class="s2">= </span><span class="s1">glyph_map</span>

        <span class="s1">glyph_ids</span><span class="s2">, </span><span class="s1">xpositions</span><span class="s2">, </span><span class="s1">ypositions</span><span class="s2">, </span><span class="s1">sizes </span><span class="s2">= [], [], [], []</span>

        <span class="s6"># Gather font information and do some setup for combining</span>
        <span class="s6"># characters into strings.</span>
        <span class="s0">for </span><span class="s1">text </span><span class="s0">in </span><span class="s1">page</span><span class="s2">.</span><span class="s1">text</span><span class="s2">:</span>
            <span class="s1">font </span><span class="s2">= </span><span class="s1">get_font</span><span class="s2">(</span><span class="s1">text</span><span class="s2">.</span><span class="s1">font_path</span><span class="s2">)</span>
            <span class="s1">char_id </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_char_id</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">text</span><span class="s2">.</span><span class="s1">glyph</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">char_id </span><span class="s0">not in </span><span class="s1">glyph_map</span><span class="s2">:</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DPI</span><span class="s2">)</span>
                <span class="s1">glyph_name_or_index </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">glyph_name_or_index</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">glyph_name_or_index</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                    <span class="s1">index </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_name_index</span><span class="s2">(</span><span class="s1">glyph_name_or_index</span><span class="s2">)</span>
                    <span class="s1">font</span><span class="s2">.</span><span class="s1">load_glyph</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">LOAD_TARGET_LIGHT</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">glyph_name_or_index</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_select_native_charmap</span><span class="s2">(</span><span class="s1">font</span><span class="s2">)</span>
                    <span class="s1">font</span><span class="s2">.</span><span class="s1">load_char</span><span class="s2">(</span>
                        <span class="s1">glyph_name_or_index</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">LOAD_TARGET_LIGHT</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:  </span><span class="s6"># Should not occur.</span>
                    <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s5">f&quot;Glyph spec of unexpected type: &quot;</span>
                                    <span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">glyph_name_or_index</span><span class="s0">!r}</span><span class="s5">&quot;</span><span class="s2">)</span>
                <span class="s1">glyph_map_new</span><span class="s2">[</span><span class="s1">char_id</span><span class="s2">] = </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_path</span><span class="s2">()</span>

            <span class="s1">glyph_ids</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">char_id</span><span class="s2">)</span>
            <span class="s1">xpositions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">text</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">ypositions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">text</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">sizes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">text</span><span class="s2">.</span><span class="s1">font_size </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">)</span>

        <span class="s1">myrects </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">w </span><span class="s0">in </span><span class="s1">page</span><span class="s2">.</span><span class="s1">boxes</span><span class="s2">:</span>
            <span class="s1">vert1 </span><span class="s2">= [(</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s1">ox </span><span class="s2">+ </span><span class="s1">w</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s1">ox </span><span class="s2">+ </span><span class="s1">w</span><span class="s2">, </span><span class="s1">oy </span><span class="s2">+ </span><span class="s1">h</span><span class="s2">),</span>
                     <span class="s2">(</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy </span><span class="s2">+ </span><span class="s1">h</span><span class="s2">), (</span><span class="s1">ox</span><span class="s2">, </span><span class="s1">oy</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]</span>
            <span class="s1">code1 </span><span class="s2">= [</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">MOVETO</span><span class="s2">,</span>
                     <span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">.</span><span class="s1">LINETO</span><span class="s2">,</span>
                     <span class="s1">Path</span><span class="s2">.</span><span class="s1">CLOSEPOLY</span><span class="s2">]</span>
            <span class="s1">myrects</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">vert1</span><span class="s2">, </span><span class="s1">code1</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">glyph_ids</span><span class="s2">, </span><span class="s1">xpositions</span><span class="s2">, </span><span class="s1">ypositions</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">)),</span>
                <span class="s1">glyph_map_new</span><span class="s2">, </span><span class="s1">myrects</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_select_native_charmap</span><span class="s2">(</span><span class="s1">font</span><span class="s2">):</span>
        <span class="s6"># Select the native charmap. (we can't directly identify it but it's</span>
        <span class="s6"># typically an Adobe charmap).</span>
        <span class="s0">for </span><span class="s1">charmap_code </span><span class="s0">in </span><span class="s2">[</span>
                <span class="s4">1094992451</span><span class="s2">,  </span><span class="s6"># ADOBE_CUSTOM.</span>
                <span class="s4">1094995778</span><span class="s2">,  </span><span class="s6"># ADOBE_STANDARD.</span>
        <span class="s2">]:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">font</span><span class="s2">.</span><span class="s1">select_charmap</span><span class="s2">(</span><span class="s1">charmap_code</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">):</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s5">&quot;No supported encoding in font (%s).&quot;</span><span class="s2">, </span><span class="s1">font</span><span class="s2">.</span><span class="s1">fname</span><span class="s2">)</span>


<span class="s1">text_to_path </span><span class="s2">= </span><span class="s1">TextToPath</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TextPath</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Create a path from the text. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xy</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">_interpolation_steps</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">usetex</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s3">r&quot;&quot;&quot; 
        Create a path from the text. Note that it simply is a path, 
        not an artist. You need to use the `.PathPatch` (or other artists) 
        to draw this path onto the canvas. 
 
        Parameters 
        ---------- 
        xy : tuple or array of two float values 
            Position of the text. For no offset, use ``xy=(0, 0)``. 
 
        s : str 
            The text to convert to a path. 
 
        size : float, optional 
            Font size in points. Defaults to the size specified via the font 
            properties *prop*. 
 
        prop : `~matplotlib.font_manager.FontProperties`, optional 
            Font property. If not provided, will use a default 
            `.FontProperties` with parameters from the 
            :ref:`rcParams&lt;customizing-with-dynamic-rc-settings&gt;`. 
 
        _interpolation_steps : int, optional 
            (Currently ignored) 
 
        usetex : bool, default: False 
            Whether to use tex rendering. 
 
        Examples 
        -------- 
        The following creates a path from the string &quot;ABC&quot; with Helvetica 
        font face; and another path from the latex fraction 1/2:: 
 
            from matplotlib.text import TextPath 
            from matplotlib.font_manager import FontProperties 
 
            fp = FontProperties(family=&quot;Helvetica&quot;, style=&quot;italic&quot;) 
            path1 = TextPath((12, 12), &quot;ABC&quot;, size=12, prop=fp) 
            path2 = TextPath((0, 0), r&quot;$\frac{1}{2}$&quot;, size=12, usetex=True) 
 
        Also see :doc:`/gallery/text_labels_and_annotations/demo_text_path`. 
        &quot;&quot;&quot;</span>
        <span class="s6"># Circular import.</span>
        <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s1">Text</span>

        <span class="s1">prop </span><span class="s2">= </span><span class="s1">FontProperties</span><span class="s2">.</span><span class="s1">_from_any</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">size </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">.</span><span class="s1">get_size_in_points</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_xy </span><span class="s2">= </span><span class="s1">xy</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cached_vertices </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">s</span><span class="s2">, </span><span class="s1">ismath </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">(</span><span class="s1">usetex</span><span class="s2">=</span><span class="s1">usetex</span><span class="s2">).</span><span class="s1">_preprocess_math</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s2">*</span><span class="s1">text_to_path</span><span class="s2">.</span><span class="s1">get_text_path</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">ismath</span><span class="s2">=</span><span class="s1">ismath</span><span class="s2">),</span>
            <span class="s1">_interpolation_steps</span><span class="s2">=</span><span class="s1">_interpolation_steps</span><span class="s2">,</span>
            <span class="s1">readonly</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_should_simplify </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Set the text size.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_size </span><span class="s2">= </span><span class="s1">size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">get_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Get the text size.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_size</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">vertices</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Return the cached path after updating it if necessary. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_revalidate_path</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cached_vertices</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">codes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Return the codes 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_codes</span>

    <span class="s0">def </span><span class="s1">_revalidate_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot; 
        Update the path if necessary. 
 
        The path for the text is initially create with the font size of 
        `.FONT_SCALE`, and this path is rescaled to other size when necessary. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cached_vertices </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">tr </span><span class="s2">= (</span><span class="s1">Affine2D</span><span class="s2">()</span>
                  <span class="s2">.</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_size </span><span class="s2">/ </span><span class="s1">text_to_path</span><span class="s2">.</span><span class="s1">FONT_SCALE</span><span class="s2">)</span>
                  <span class="s2">.</span><span class="s1">translate</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_xy</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cached_vertices </span><span class="s2">= </span><span class="s1">tr</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_vertices</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cached_vertices</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_invalid </span><span class="s2">= </span><span class="s0">False</span>
</pre>
</body>
</html>