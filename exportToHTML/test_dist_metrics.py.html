<html>
<head>
<title>test_dist_metrics.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_dist_metrics.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">pickle</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">spatial</span><span class="s2">.</span><span class="s1">distance </span><span class="s0">import </span><span class="s1">cdist</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">DistanceMetric</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">_dist_metrics </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BOOL_METRICS</span><span class="s2">,</span>
    <span class="s1">DistanceMetric32</span><span class="s2">,</span>
    <span class="s1">DistanceMetric64</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">check_random_state</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">create_memmap_backed_data</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span><span class="s2">, </span><span class="s1">parse_version</span><span class="s2">, </span><span class="s1">sp_version</span>


<span class="s0">def </span><span class="s1">dist_func</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x2</span><span class="s2">) ** </span><span class="s1">p</span><span class="s2">) ** (</span><span class="s3">1.0 </span><span class="s2">/ </span><span class="s1">p</span><span class="s2">)</span>


<span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
<span class="s1">d </span><span class="s2">= </span><span class="s3">4</span>
<span class="s1">n1 </span><span class="s2">= </span><span class="s3">20</span>
<span class="s1">n2 </span><span class="s2">= </span><span class="s3">25</span>
<span class="s1">X64 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s1">n1</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
<span class="s1">Y64 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s1">n2</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
<span class="s1">X32 </span><span class="s2">= </span><span class="s1">X64</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;float32&quot;</span><span class="s2">)</span>
<span class="s1">Y32 </span><span class="s2">= </span><span class="s1">Y64</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;float32&quot;</span><span class="s2">)</span>

<span class="s2">[</span><span class="s1">X_mmap</span><span class="s2">, </span><span class="s1">Y_mmap</span><span class="s2">] = </span><span class="s1">create_memmap_backed_data</span><span class="s2">([</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">Y64</span><span class="s2">])</span>

<span class="s5"># make boolean arrays: ones and zeros</span>
<span class="s1">X_bool </span><span class="s2">= (</span><span class="s1">X64 </span><span class="s2">&lt; </span><span class="s3">0.3</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)  </span><span class="s5"># quite sparse</span>
<span class="s1">Y_bool </span><span class="s2">= (</span><span class="s1">Y64 </span><span class="s2">&lt; </span><span class="s3">0.7</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)  </span><span class="s5"># not too sparse</span>

<span class="s2">[</span><span class="s1">X_bool_mmap</span><span class="s2">, </span><span class="s1">Y_bool_mmap</span><span class="s2">] = </span><span class="s1">create_memmap_backed_data</span><span class="s2">([</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">])</span>


<span class="s1">V </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s1">d</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>
<span class="s1">VI </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">V</span><span class="s2">, </span><span class="s1">V</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

<span class="s1">METRICS_DEFAULT_PARAMS </span><span class="s2">= [</span>
    <span class="s2">(</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;cityblock&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;minkowski&quot;</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))),</span>
    <span class="s2">(</span><span class="s4">&quot;chebyshev&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;seuclidean&quot;</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">V</span><span class="s2">=(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">d</span><span class="s2">),))),</span>
    <span class="s2">(</span><span class="s4">&quot;mahalanobis&quot;</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">VI</span><span class="s2">=(</span><span class="s1">VI</span><span class="s2">,))),</span>
    <span class="s2">(</span><span class="s4">&quot;hamming&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;canberra&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;braycurtis&quot;</span><span class="s2">, {}),</span>
    <span class="s2">(</span><span class="s4">&quot;minkowski&quot;</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s1">w</span><span class="s2">=(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">d</span><span class="s2">),))),</span>
<span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;metric_param_grid&quot;</span><span class="s2">, </span><span class="s1">METRICS_DEFAULT_PARAMS</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">params</span><span class="s2">: </span><span class="s1">params</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X, Y&quot;</span><span class="s2">, [(</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">Y64</span><span class="s2">), (</span><span class="s1">X32</span><span class="s2">, </span><span class="s1">Y32</span><span class="s2">), (</span><span class="s1">X_mmap</span><span class="s2">, </span><span class="s1">Y_mmap</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cdist</span><span class="s2">(</span><span class="s1">metric_param_grid</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">metric</span><span class="s2">, </span><span class="s1">param_grid </span><span class="s2">= </span><span class="s1">metric_param_grid</span>
    <span class="s1">keys </span><span class="s2">= </span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
    <span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()):</span>
        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">rtol_dict </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;mahalanobis&quot; </span><span class="s0">and </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
            <span class="s5"># Computation of mahalanobis differs between</span>
            <span class="s5"># the scipy and scikit-learn implementation.</span>
            <span class="s5"># Hence, we increase the relative tolerance.</span>
            <span class="s5"># TODO: Inspect slight numerical discrepancy</span>
            <span class="s5"># with scipy</span>
            <span class="s1">rtol_dict </span><span class="s2">= {</span><span class="s4">&quot;rtol&quot;</span><span class="s2">: </span><span class="s3">1e-6</span><span class="s2">}</span>

        <span class="s5"># TODO: Remove when scipy minimum version &gt;= 1.7.0</span>
        <span class="s5"># scipy supports 0&lt;p&lt;1 for minkowski metric &gt;= 1.7.0</span>
        <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;minkowski&quot;</span><span class="s2">:</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;p&quot;</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s4">&quot;1.7.0&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;scipy does not support 0&lt;p&lt;1 for minkowski metric &lt; 1.7.0&quot;</span><span class="s2">)</span>

        <span class="s1">D_scipy_cdist </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s5"># DistanceMetric.pairwise must be consistent for all</span>
        <span class="s5"># combinations of formats in {sparse, dense}.</span>
        <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>

        <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>

        <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>

        <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">BOOL_METRICS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;X_bool, Y_bool&quot;</span><span class="s2">, [(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">), (</span><span class="s1">X_bool_mmap</span><span class="s2">, </span><span class="s1">Y_bool_mmap</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cdist_bool_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">D_scipy_cdist </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">)</span>

    <span class="s5"># DistanceMetric.pairwise must be consistent</span>
    <span class="s5"># on all combinations of format in {sparse, dense}Â².</span>
    <span class="s1">X_bool_csr</span><span class="s2">, </span><span class="s1">Y_bool_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">), </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y_bool</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool_csr</span><span class="s2">, </span><span class="s1">Y_bool_csr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">Y_bool_csr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool_csr</span><span class="s2">, </span><span class="s1">Y_bool</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_cdist</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;metric_param_grid&quot;</span><span class="s2">, </span><span class="s1">METRICS_DEFAULT_PARAMS</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">params</span><span class="s2">: </span><span class="s1">params</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X&quot;</span><span class="s2">, [</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">X32</span><span class="s2">, </span><span class="s1">X_mmap</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pdist</span><span class="s2">(</span><span class="s1">metric_param_grid</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">metric</span><span class="s2">, </span><span class="s1">param_grid </span><span class="s2">= </span><span class="s1">metric_param_grid</span>
    <span class="s1">keys </span><span class="s2">= </span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()):</span>
        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">rtol_dict </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;mahalanobis&quot; </span><span class="s0">and </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
            <span class="s5"># Computation of mahalanobis differs between</span>
            <span class="s5"># the scipy and scikit-learn implementation.</span>
            <span class="s5"># Hence, we increase the relative tolerance.</span>
            <span class="s5"># TODO: Inspect slight numerical discrepancy</span>
            <span class="s5"># with scipy</span>
            <span class="s1">rtol_dict </span><span class="s2">= {</span><span class="s4">&quot;rtol&quot;</span><span class="s2">: </span><span class="s3">1e-6</span><span class="s2">}</span>

        <span class="s5"># TODO: Remove when scipy minimum version &gt;= 1.7.0</span>
        <span class="s5"># scipy supports 0&lt;p&lt;1 for minkowski metric &gt;= 1.7.0</span>
        <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;minkowski&quot;</span><span class="s2">:</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;p&quot;</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s4">&quot;1.7.0&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">p </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;scipy does not support 0&lt;p&lt;1 for minkowski metric &lt; 1.7.0&quot;</span><span class="s2">)</span>
        <span class="s1">D_scipy_pdist </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_pdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>

        <span class="s1">D_sklearn_csr </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn_csr</span><span class="s2">, </span><span class="s1">D_scipy_pdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>

        <span class="s1">D_sklearn_csr </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn_csr</span><span class="s2">, </span><span class="s1">D_scipy_pdist</span><span class="s2">, **</span><span class="s1">rtol_dict</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;metric_param_grid&quot;</span><span class="s2">, </span><span class="s1">METRICS_DEFAULT_PARAMS</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">params</span><span class="s2">: </span><span class="s1">params</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_distance_metrics_dtype_consistency</span><span class="s2">(</span><span class="s1">metric_param_grid</span><span class="s2">):</span>
    <span class="s5"># DistanceMetric must return similar distances for both float32 and float64</span>
    <span class="s5"># input data.</span>
    <span class="s1">metric</span><span class="s2">, </span><span class="s1">param_grid </span><span class="s2">= </span><span class="s1">metric_param_grid</span>
    <span class="s1">keys </span><span class="s2">= </span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>

    <span class="s5"># Choose rtol to make sure that this test is robust to changes in the random</span>
    <span class="s5"># seed in the module-level test data generation code.</span>
    <span class="s1">rtol </span><span class="s2">= </span><span class="s3">1e-5</span>

    <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()):</span>
        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">dm64 </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">dm32 </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">D64 </span><span class="s2">= </span><span class="s1">dm64</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X64</span><span class="s2">)</span>
        <span class="s1">D32 </span><span class="s2">= </span><span class="s1">dm32</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X32</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">D64</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
        <span class="s0">assert </span><span class="s1">D32</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>

        <span class="s5"># assert_allclose introspects the dtype of the input arrays to decide</span>
        <span class="s5"># which rtol value to use by default but in this case we know that D32</span>
        <span class="s5"># is not computed with the same precision so we set rtol manually.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D64</span><span class="s2">, </span><span class="s1">D32</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>

        <span class="s1">D64 </span><span class="s2">= </span><span class="s1">dm64</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">Y64</span><span class="s2">)</span>
        <span class="s1">D32 </span><span class="s2">= </span><span class="s1">dm32</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X32</span><span class="s2">, </span><span class="s1">Y32</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D64</span><span class="s2">, </span><span class="s1">D32</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">BOOL_METRICS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X_bool&quot;</span><span class="s2">, [</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">X_bool_mmap</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pdist_bool_metrics</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">D_scipy_pdist </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_pdist</span><span class="s2">)</span>

    <span class="s1">X_bool_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">)</span>
    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool_csr</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_scipy_pdist</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;writable_kwargs&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;metric_param_grid&quot;</span><span class="s2">, </span><span class="s1">METRICS_DEFAULT_PARAMS</span><span class="s2">, </span><span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">params</span><span class="s2">: </span><span class="s1">params</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X&quot;</span><span class="s2">, [</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">X32</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pickle</span><span class="s2">(</span><span class="s1">writable_kwargs</span><span class="s2">, </span><span class="s1">metric_param_grid</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
    <span class="s1">metric</span><span class="s2">, </span><span class="s1">param_grid </span><span class="s2">= </span><span class="s1">metric_param_grid</span>
    <span class="s1">keys </span><span class="s2">= </span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">param_grid</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()):</span>
        <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">vals</span><span class="s2">):</span>
            <span class="s1">vals </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">vals</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
                    <span class="s1">val</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s1">writable_kwargs</span><span class="s2">)</span>
        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>
        <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">D1 </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">dm2 </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">dm</span><span class="s2">))</span>
        <span class="s1">D2 </span><span class="s2">= </span><span class="s1">dm2</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D1</span><span class="s2">, </span><span class="s1">D2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">BOOL_METRICS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X_bool&quot;</span><span class="s2">, [</span><span class="s1">X_bool</span><span class="s2">, </span><span class="s1">X_bool_mmap</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pickle_bool_metrics</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">X_bool</span><span class="s2">):</span>
    <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s1">D1 </span><span class="s2">= </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">)</span>
    <span class="s1">dm2 </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">dm</span><span class="s2">))</span>
    <span class="s1">D2 </span><span class="s2">= </span><span class="s1">dm2</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_bool</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D1</span><span class="s2">, </span><span class="s1">D2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;X, Y&quot;</span><span class="s2">, [(</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">Y64</span><span class="s2">), (</span><span class="s1">X32</span><span class="s2">, </span><span class="s1">Y32</span><span class="s2">), (</span><span class="s1">X_mmap</span><span class="s2">, </span><span class="s1">Y_mmap</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_haversine_metric</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s5"># The Haversine DistanceMetric only works on 2 features.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, :</span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">[:, :</span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s5"># Haversine is not supported by scipy.special.distance.{cdist,pdist}</span>
    <span class="s5"># So we reimplement it to have a reference.</span>
    <span class="s0">def </span><span class="s1">haversine_slow</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">* (</span><span class="s1">x1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] - </span><span class="s1">x2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])) ** </span><span class="s3">2</span>
                <span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">* (</span><span class="s1">x1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] - </span><span class="s1">x2</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])) ** </span><span class="s3">2</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">D_reference </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">Y_csr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]))</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">xi </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">X</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">yj </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">):</span>
            <span class="s1">D_reference</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">haversine_slow</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">yj</span><span class="s2">)</span>

    <span class="s1">haversine </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;haversine&quot;</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">haversine</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">haversine</span><span class="s2">.</span><span class="s1">dist_to_rdist</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">D_reference</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-6</span>
    <span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_reference</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">haversine</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_reference</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">haversine</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_reference</span><span class="s2">)</span>

    <span class="s1">D_sklearn </span><span class="s2">= </span><span class="s1">haversine</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">D_sklearn</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D_sklearn</span><span class="s2">, </span><span class="s1">D_reference</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pyfunc_metric</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>

    <span class="s1">euclidean </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
    <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;pyfunc&quot;</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s1">dist_func</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s5"># Check if both callable metric and predefined metric initialized</span>
    <span class="s5"># DistanceMetric object is picklable</span>
    <span class="s1">euclidean_pkl </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">euclidean</span><span class="s2">))</span>
    <span class="s1">pyfunc_pkl </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">))</span>

    <span class="s1">D1 </span><span class="s2">= </span><span class="s1">euclidean</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">D2 </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">D1_pkl </span><span class="s2">= </span><span class="s1">euclidean_pkl</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">D2_pkl </span><span class="s2">= </span><span class="s1">pyfunc_pkl</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D1</span><span class="s2">, </span><span class="s1">D2</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">D1_pkl</span><span class="s2">, </span><span class="s1">D2_pkl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_input_data_size</span><span class="s2">():</span>
    <span class="s5"># Regression test for #6288</span>
    <span class="s5"># Previously, a metric requiring a particular input dimension would fail</span>
    <span class="s0">def </span><span class="s1">custom_metric</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s3">3</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">x </span><span class="s2">- </span><span class="s1">y</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;pyfunc&quot;</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s1">custom_metric</span><span class="s2">)</span>
    <span class="s1">eucl </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">eucl</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_readonly_kwargs</span><span class="s2">():</span>
    <span class="s5"># Non-regression test for:</span>
    <span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/21685</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s1">weights </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">100</span><span class="s2">)</span>
    <span class="s1">VI </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">weights</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">VI</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s5"># Those distances metrics have to support readonly buffers.</span>
    <span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;seuclidean&quot;</span><span class="s2">, </span><span class="s1">V</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">)</span>
    <span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;mahalanobis&quot;</span><span class="s2">, </span><span class="s1">VI</span><span class="s2">=</span><span class="s1">VI</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;w, err_type, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, -</span><span class="s3">13</span><span class="s2">]), </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;w cannot contain negative weights&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]), </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;w contains NaN&quot;</span><span class="s2">),</span>
        <span class="s2">*[</span>
            <span class="s2">(</span>
                <span class="s1">csr_container</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]),</span>
                <span class="s1">TypeError</span><span class="s2">,</span>
                <span class="s4">&quot;Sparse data was passed for w, but dense data is required&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">csr_container </span><span class="s0">in </span><span class="s1">CSR_CONTAINERS</span>
        <span class="s2">],</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">]), </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;could not convert string to float&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;a minimum of 1 is required&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_minkowski_metric_validate_weights_values</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;minkowski&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">w</span><span class="s2">=</span><span class="s1">w</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_minkowski_metric_validate_weights_size</span><span class="s2">():</span>
    <span class="s1">w2 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">d </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">dm </span><span class="s2">= </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;minkowski&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">w</span><span class="s2">=</span><span class="s1">w2</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;MinkowskiDistance: the size of w must match &quot;</span>
        <span class="s4">f&quot;the number of features </span><span class="s0">\\</span><span class="s4">(</span><span class="s0">{</span><span class="s1">X64</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span><span class="s0">}\\</span><span class="s4">). &quot;</span>
        <span class="s4">f&quot;Currently len</span><span class="s0">\\</span><span class="s4">(w</span><span class="s0">\\</span><span class="s4">)=</span><span class="s0">{</span><span class="s1">w2</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span><span class="s0">}</span><span class="s4">.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">dm</span><span class="s2">.</span><span class="s1">pairwise</span><span class="s2">(</span><span class="s1">X64</span><span class="s2">, </span><span class="s1">Y64</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric, metric_kwargs&quot;</span><span class="s2">, </span><span class="s1">METRICS_DEFAULT_PARAMS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_get_metric_dtype</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">specialized_cls </span><span class="s2">= {</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">: </span><span class="s1">DistanceMetric32</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">: </span><span class="s1">DistanceMetric64</span><span class="s2">,</span>
    <span class="s2">}[</span><span class="s1">dtype</span><span class="s2">]</span>

    <span class="s5"># We don't need the entire grid, just one for a sanity check</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span><span class="s1">k</span><span class="s2">: </span><span class="s1">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">metric_kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>
    <span class="s1">generic_type </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, **</span><span class="s1">metric_kwargs</span><span class="s2">))</span>
    <span class="s1">specialized_type </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">specialized_cls</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">metric_kwargs</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">generic_type </span><span class="s0">is </span><span class="s1">specialized_type</span>


<span class="s0">def </span><span class="s1">test_get_metric_bad_dtype</span><span class="s2">():</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">r&quot;Unexpected dtype .* provided. Please select a dtype from&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;manhattan&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_minkowski_metric_validate_bad_p_parameter</span><span class="s2">():</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;p must be greater than 0&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s4">&quot;minkowski&quot;</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
</pre>
</body>
</html>