<html>
<head>
<title>test_decomp_update.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_decomp_update.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">linalg</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_decomp_update </span><span class="s0">as </span><span class="s1">_decomp_update</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_decomp_update </span><span class="s0">import </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">qr_insert</span>

<span class="s0">def </span><span class="s1">assert_unitary</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">rtol </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">rtol </span><span class="s2">= </span><span class="s3">10.0 </span><span class="s2">** -(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">precision</span><span class="s2">-</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">atol </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s3">10</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>

    <span class="s0">if </span><span class="s1">assert_sqr</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s4">'unitary matrices must be square'</span><span class="s2">)</span>
    <span class="s1">aTa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">aTa</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">assert_upper_tri</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">rtol </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">rtol </span><span class="s2">= </span><span class="s3">10.0 </span><span class="s2">** -(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">precision</span><span class="s2">-</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">atol </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tri</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">], </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
    <span class="s1">assert_unitary</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
    <span class="s1">assert_upper_tri</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">make_strided</span><span class="s2">(</span><span class="s1">arrs</span><span class="s2">):</span>
    <span class="s1">strides </span><span class="s2">= [(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)]</span>
    <span class="s1">kmax </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">strides</span><span class="s2">)</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s1">ret </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">strides</span><span class="s2">[</span><span class="s1">k </span><span class="s2">% </span><span class="s1">kmax</span><span class="s2">]</span>
            <span class="s1">k </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">base </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]*</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]+</span><span class="s1">s</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">view </span><span class="s2">= </span><span class="s1">base</span><span class="s2">[</span><span class="s1">s</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]::</span><span class="s1">s</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]]</span>
            <span class="s1">view</span><span class="s2">[...] = </span><span class="s1">a</span>
        <span class="s0">elif </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">strides</span><span class="s2">[</span><span class="s1">k </span><span class="s2">% </span><span class="s1">kmax</span><span class="s2">]</span>
            <span class="s1">t </span><span class="s2">= </span><span class="s1">strides</span><span class="s2">[(</span><span class="s1">k</span><span class="s2">+</span><span class="s3">1</span><span class="s2">) % </span><span class="s1">kmax</span><span class="s2">]</span>
            <span class="s1">k </span><span class="s2">+= </span><span class="s3">2</span>
            <span class="s1">base </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">s</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]*</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]+</span><span class="s1">s</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]*</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]+</span><span class="s1">t</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]),</span>
                            <span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">view </span><span class="s2">= </span><span class="s1">base</span><span class="s2">[</span><span class="s1">s</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]::</span><span class="s1">s</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]::</span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]]</span>
            <span class="s1">view</span><span class="s2">[...] = </span><span class="s1">a</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">'make_strided only works for ndim = 1 or'</span>
                             <span class="s4">' 2 arrays'</span><span class="s2">)</span>
        <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">negate_strides</span><span class="s2">(</span><span class="s1">arrs</span><span class="s2">):</span>
    <span class="s1">ret </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">b</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">, ::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">b</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">'negate_strides only works for ndim = 1 or'</span>
                             <span class="s4">' 2 arrays'</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">[...] = </span><span class="s1">a</span>
        <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">nonitemsize_strides</span><span class="s2">(</span><span class="s1">arrs</span><span class="s2">):</span>
    <span class="s1">out </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
        <span class="s1">a_dtype </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, [(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">a_dtype</span><span class="s2">), (</span><span class="s4">'junk'</span><span class="s2">, </span><span class="s4">'S1'</span><span class="s2">)])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getfield</span><span class="s2">(</span><span class="s1">a_dtype</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">[...] = </span><span class="s1">a</span>
        <span class="s1">out</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">out</span>


<span class="s0">def </span><span class="s1">make_nonnative</span><span class="s2">(</span><span class="s1">arrs</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">BaseQRdeltas</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rtol </span><span class="s2">= </span><span class="s3">10.0 </span><span class="s2">** -(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">precision</span><span class="s2">-</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">atol </span><span class="s2">= </span><span class="s3">10 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>

    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">29382</span><span class="s2">)</span>
        <span class="s1">shape </span><span class="s2">= {</span><span class="s4">'sqr'</span><span class="s2">: (</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), </span><span class="s4">'tall'</span><span class="s2">: (</span><span class="s3">12</span><span class="s2">, </span><span class="s3">7</span><span class="s2">), </span><span class="s4">'fat'</span><span class="s2">: (</span><span class="s3">7</span><span class="s2">, </span><span class="s3">12</span><span class="s2">),</span>
                 <span class="s4">'Mx1'</span><span class="s2">: (</span><span class="s3">8</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s4">'1xN'</span><span class="s2">: (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), </span><span class="s4">'1x1'</span><span class="s2">: (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)}[</span><span class="s1">type</span><span class="s2">]</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iscomplexobj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">b</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span>

<span class="s0">class </span><span class="s1">BaseQRdelete</span><span class="s2">(</span><span class="s1">BaseQRdeltas</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_sqr_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">,</span>
                                   <span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">col</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">,</span>
                                   <span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">col</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">,</span>
                                   <span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">col</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># this test always starts and ends with an economic decomp.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s5"># for economic row deletes</span>
    <span class="s5"># eco - prow = eco</span>
    <span class="s5"># eco - prow = sqr</span>
    <span class="s5"># eco - prow = fat</span>
    <span class="s0">def </span><span class="s1">base_economic_p_row_xxx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_row_economic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># (12, 7) - (3, 7) = (9,7) --&gt; stays economic</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_row_xxx</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_row_sqr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># (12, 7) - (5, 7) = (7, 7) --&gt; becomes square</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_row_xxx</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_row_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># (12, 7) - (7,7) = (5, 7) --&gt; becomes fat</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_row_xxx</span><span class="s2">(</span><span class="s3">7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">,</span>
                                   <span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">col</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">,</span>
                                   <span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">col</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ndel </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s1">ndel</span><span class="s2">):</span>
                <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">ndel</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">row</span><span class="s2">+</span><span class="s1">ndel</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_delete_last_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># full and eco are the same for 1xN</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_delete_last_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_delete_last_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_unitary</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_delete_last_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_unitary</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_delete_1x1_row_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_unitary</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s5"># all full qr, row deletes and single column deletes should be able to</span>
    <span class="s5"># handle any non negative strides. (only row and column vector</span>
    <span class="s5"># operations are used.) p column delete require fortran ordered</span>
    <span class="s5"># Q and R and will make a copy as necessary.  Economic qr row deletes</span>
    <span class="s5"># require a contiguous q.</span>

    <span class="s0">def </span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">adjust_strides</span><span class="s2">, </span><span class="s1">ks</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">,</span>
                                <span class="s1">overwriteable</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row'</span><span class="s2">:</span>
            <span class="s1">qind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">))</span>
            <span class="s1">rind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">qind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">))</span>
            <span class="s1">rind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">,-</span><span class="s1">p</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">type</span><span class="s2">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">([</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'fat'</span><span class="s2">], </span><span class="s1">ks</span><span class="s2">):</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s1">type</span><span class="s2">)</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">s </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">k</span><span class="s2">,</span><span class="s1">k</span><span class="s2">+</span><span class="s1">p</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">k </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">s </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">k </span><span class="s2">+ </span><span class="s1">p </span><span class="s2">+</span>
                              <span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]))</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>

            <span class="s5"># for each variable, q, r we try with it strided and</span>
            <span class="s5"># overwrite=False. Then we try with overwrite=True, and make</span>
            <span class="s5"># sure that q and r are still overwritten.</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q1o</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">[</span><span class="s1">qind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r1o</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s1">rind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2o</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s1">qind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2o</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">[</span><span class="s1">rind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s5"># since some of these were consumed above</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2o</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">[</span><span class="s1">qind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r3o</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">[</span><span class="s1">rind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemize_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemize_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemize_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemize_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">], </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_k</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">w </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">([-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s4">'row'</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">]):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">overwrite_qr</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">w </span><span class="s2">== </span><span class="s4">'row'</span><span class="s2">:</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">k</span><span class="s2">+</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">k</span><span class="s2">+</span><span class="s1">p</span><span class="s2">+</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">k</span><span class="s2">+</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">k</span><span class="s2">+</span><span class="s1">p</span><span class="s2">+</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]), </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">test_C</span><span class="s2">, </span><span class="s1">test_F</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">):</span>
        <span class="s1">assert_sqr </span><span class="s2">= </span><span class="s0">True if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">'full' </span><span class="s0">else False</span>
        <span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row'</span><span class="s2">:</span>
            <span class="s1">qind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">))</span>
            <span class="s1">rind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s1">p</span><span class="s2">,</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">qind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">))</span>
            <span class="s1">rind </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">), </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">,-</span><span class="s1">p</span><span class="s2">))</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">+</span><span class="s1">p</span><span class="s2">), </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s5"># don't overwrite</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">test_F</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s5"># verify the overwriting</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s1">qind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s1">rind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">test_C</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_delete</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s1">qind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s1">rind</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qr_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># any positively strided q and r.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_economic_qr_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Any contiguous q and positively strided r.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qr_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># any positively strided q and r.</span>
        <span class="s5"># full and eco share code paths</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'col'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qr_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># any positively strided q and r.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_economic_qr_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># any contiguous q and positively strided r</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qr_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># only F ordered q and r can be overwritten for cols</span>
        <span class="s5"># full and eco share code paths</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_overwrite_qr</span><span class="s2">(</span><span class="s4">'col'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_which</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'foo'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_k</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, -</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, -</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s5"># p must be positive</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

        <span class="s5"># and nonzero</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

        <span class="s5"># must have at least k+p rows or cols, depending.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]-</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]-</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty_q</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s5"># same code path for 'row' and 'col'</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty_r</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s5"># same code path for 'row' and 'col'</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mismatched_q_and_r</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unsupported_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dts </span><span class="s2">= [</span><span class="s4">'int8'</span><span class="s2">, </span><span class="s4">'int16'</span><span class="s2">, </span><span class="s4">'int32'</span><span class="s2">, </span><span class="s4">'int64'</span><span class="s2">,</span>
               <span class="s4">'uint8'</span><span class="s2">, </span><span class="s4">'uint16'</span><span class="s2">, </span><span class="s4">'uint32'</span><span class="s2">, </span><span class="s4">'uint64'</span><span class="s2">,</span>
               <span class="s4">'float16'</span><span class="s2">, </span><span class="s4">'longdouble'</span><span class="s2">, </span><span class="s4">'clongdouble'</span><span class="s2">,</span>
               <span class="s4">'bool'</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">dts</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a0</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_qr_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_delete</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRdelete_f</span><span class="s2">(</span><span class="s1">BaseQRdelete</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRdelete_F</span><span class="s2">(</span><span class="s1">BaseQRdelete</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRdelete_d</span><span class="s2">(</span><span class="s1">BaseQRdelete</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'d'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRdelete_D</span><span class="s2">(</span><span class="s1">BaseQRdelete</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'D'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">BaseQRinsert</span><span class="s2">(</span><span class="s1">BaseQRdeltas</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">generate</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">p </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s5"># super call set the seed...</span>
        <span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">p</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]))</span>
        <span class="s0">elif </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'col'</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">p</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ValueError</span><span class="s2">(</span><span class="s4">'which should be either &quot;row&quot; or &quot;col&quot;'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iscomplexobj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u </span><span class="s2">+ </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">b</span>

        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span>

    <span class="s0">def </span><span class="s1">test_sqr_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># sqr + rows --&gt; fat always</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># sqr + cols --&gt; fat always</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># tall + rows --&gt; tall always</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s5"># for column adds to tall matrices there are three cases to test</span>
    <span class="s5"># tall + pcol --&gt; tall</span>
    <span class="s5"># tall + pcol --&gt; sqr</span>
    <span class="s5"># tall + pcol --&gt; fat</span>
    <span class="s0">def </span><span class="s1">base_tall_p_col_xxx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_col_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x3 = 12x10 --&gt; stays tall</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_tall_p_col_xxx</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_col_sqr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x5 = 12x12 --&gt; becomes sqr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_tall_p_col_xxx</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_p_col_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x7 = 12x14 --&gt; becomes fat</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_tall_p_col_xxx</span><span class="s2">(</span><span class="s3">7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s5"># for row adds to fat matrices there are three cases to test</span>
    <span class="s5"># fat + prow --&gt; fat</span>
    <span class="s5"># fat + prow --&gt; sqr</span>
    <span class="s5"># fat + prow --&gt; tall</span>
    <span class="s0">def </span><span class="s1">base_fat_p_row_xxx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_row_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 7x12 + 3x12 = 10x12 --&gt; stays fat</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_fat_p_row_xxx</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_row_sqr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 7x12 + 5x12 = 12x12 --&gt; becomes sqr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_fat_p_row_xxx</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_row_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 7x12 + 7x12 = 14x12 --&gt; becomes tall</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_fat_p_row_xxx</span><span class="s2">(</span><span class="s3">7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># fat + cols --&gt; fat always</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># tall + rows --&gt; tall always</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_1_col_bad_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># When the column to be added lies in the span of Q, the update is</span>
        <span class="s5"># not meaningful.  This is detected, and a LinAlgError is issued.</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s5"># for column adds to economic matrices there are three cases to test</span>
    <span class="s5"># eco + pcol --&gt; eco</span>
    <span class="s5"># eco + pcol --&gt; sqr</span>
    <span class="s5"># eco + pcol --&gt; fat</span>
    <span class="s0">def </span><span class="s1">base_economic_p_col_xxx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_col_eco</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x3 = 12x10 --&gt; stays eco</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_col_xxx</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_col_sqr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x5 = 12x12 --&gt; becomes sqr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_col_xxx</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_p_col_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 12x7 + 12x7 = 12x14 --&gt; becomes fat</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_economic_p_col_xxx</span><span class="s2">(</span><span class="s3">7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">row</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_1_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">adjust_strides</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">which</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">type </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'fat'</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s1">which</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">ai </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">ai </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">),</span>
                        <span class="s1">u0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s1">u0</span><span class="s2">,</span>
                        <span class="s3">0 </span><span class="s0">if </span><span class="s1">which </span><span class="s2">== </span><span class="s4">'row' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)</span>

            <span class="s5"># for each variable, q, r, u we try with it strided and</span>
            <span class="s5"># overwrite=False. Then we try with overwrite=True. Nothing</span>
            <span class="s5"># is checked to see if it can be overwritten, since only</span>
            <span class="s5"># F ordered Q can be overwritten when adding columns.</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s5"># since some of these were consumed above</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">))</span>
            <span class="s1">q5</span><span class="s2">, </span><span class="s1">r5 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q5</span><span class="s2">, </span><span class="s1">r5</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
            <span class="s1">q5o</span><span class="s2">, </span><span class="s1">r5o </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">which</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q5o</span><span class="s2">, </span><span class="s1">r5o</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_1_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_p_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_1_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_p_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qu_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when inserting rows, the size of both Q and R change, so only</span>
        <span class="s5"># column inserts can overwrite q. Only complex column inserts</span>
        <span class="s5"># with C ordered Q overwrite u. Any contiguous Q is overwritten</span>
        <span class="s5"># when inserting 1 column</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">u0 </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s5"># don't overwrite</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s5"># try overwriting</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s5"># verify the overwriting</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s5"># now try with a fortran ordered Q</span>
        <span class="s1">qF </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u1 </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qF</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">qF</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s5"># try overwriting</span>
        <span class="s1">q4</span><span class="s2">, </span><span class="s1">r4 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">qF</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q4</span><span class="s2">, </span><span class="s1">r4</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q4</span><span class="s2">, </span><span class="s1">qF</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qu_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when inserting rows, the size of both Q and R change, so only</span>
        <span class="s5"># column inserts can potentially overwrite Q.  In practice, only</span>
        <span class="s5"># F ordered Q are overwritten with a rank p update.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s5"># don't overwrite</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s5"># try overwriting</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_insert</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">, </span><span class="s1">overwrite_qru</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty_inputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mismatched_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[:-</span><span class="s3">2</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[:-</span><span class="s3">2</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unsupported_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dts </span><span class="s2">= [</span><span class="s4">'int8'</span><span class="s2">, </span><span class="s4">'int16'</span><span class="s2">, </span><span class="s4">'int32'</span><span class="s2">, </span><span class="s4">'int64'</span><span class="s2">,</span>
               <span class="s4">'uint8'</span><span class="s2">, </span><span class="s4">'uint16'</span><span class="s2">, </span><span class="s4">'uint32'</span><span class="s2">, </span><span class="s4">'uint64'</span><span class="s2">,</span>
               <span class="s4">'float16'</span><span class="s2">, </span><span class="s4">'longdouble'</span><span class="s2">, </span><span class="s4">'clongdouble'</span><span class="s2">,</span>
               <span class="s4">'bool'</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">dts</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a0</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">=</span><span class="s4">'row'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'row'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_insert</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'col'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRinsert_f</span><span class="s2">(</span><span class="s1">BaseQRinsert</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRinsert_F</span><span class="s2">(</span><span class="s1">BaseQRinsert</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRinsert_d</span><span class="s2">(</span><span class="s1">BaseQRinsert</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'d'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRinsert_D</span><span class="s2">(</span><span class="s1">BaseQRinsert</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'D'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">BaseQRupdate</span><span class="s2">(</span><span class="s1">BaseQRdeltas</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">generate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'full'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">generate</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>

        <span class="s5"># super call set the seed...</span>
        <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">p</span><span class="s2">))</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">p</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iscomplexobj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u </span><span class="s2">+ </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">b</span>

            <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v </span><span class="s2">+ </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">c</span>

        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span>

    <span class="s0">def </span><span class="s1">test_sqr_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqr_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test ndim = 2, rank 1 updates here too</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tall_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fat_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'fat'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when M or N == 1, only a rank 1 update is allowed. This isn't</span>
        <span class="s5"># fundamental limitation, but the code does not support it.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_Mx1_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when M or N == 1, only a rank 1 update is allowed. This isn't</span>
        <span class="s5"># fundamental limitation, but the code does not support it.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'Mx1'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1xN_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when M or N == 1, only a rank 1 update is allowed. This isn't</span>
        <span class="s5"># fundamental limitation, but the code does not support it.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1xN'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># when M or N == 1, only a rank 1 update is allowed. This isn't</span>
        <span class="s5"># fundamental limitation, but the code does not support it.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1x1_rank_1_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'1x1'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">adjust_strides</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">overwriteable</span><span class="s2">):</span>
        <span class="s1">assert_sqr </span><span class="s2">= </span><span class="s0">False if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">'economic' </span><span class="s0">else True</span>
        <span class="s0">for </span><span class="s1">type </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'fat'</span><span class="s2">]:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">vs </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">p </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">aup </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">aup </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>

            <span class="s5"># for each variable, q, r, u, v we try with it strided and</span>
            <span class="s5"># overwrite=False. Then we try with overwrite=True, and make</span>
            <span class="s5"># sure that if p == 1, r and v are still overwritten.</span>
            <span class="s5"># a strided q and u must always be copied.</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1o</span><span class="s2">, </span><span class="s1">r1o</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r1o</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2o</span><span class="s2">, </span><span class="s1">r2o</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2o</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3o</span><span class="s2">, </span><span class="s1">r3o</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r3o</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">q4</span><span class="s2">, </span><span class="s1">r4 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">vs</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q4</span><span class="s2">, </span><span class="s1">r4</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">q4o</span><span class="s2">, </span><span class="s1">r4o </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">vs</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q4o</span><span class="s2">, </span><span class="s1">r4o</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r4o</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">vs</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s5"># since some of these were consumed above</span>
            <span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">vs </span><span class="s2">= </span><span class="s1">adjust_strides</span><span class="s2">((</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">))</span>
            <span class="s1">q5</span><span class="s2">, </span><span class="s1">r5 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">vs</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q5</span><span class="s2">, </span><span class="s1">r5</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s1">q5o</span><span class="s2">, </span><span class="s1">r5o </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">qs</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">vs</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q5o</span><span class="s2">, </span><span class="s1">r5o</span><span class="s2">, </span><span class="s1">aup</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">assert_sqr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">overwriteable</span><span class="s2">:</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r5o</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">vs</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unit_strides_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_strided</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_strides_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">negate_strides</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_itemsize_strides_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">nonitemsize_strides</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_economic_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s4">'full'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_native_byte_order_economic_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">base_non_simple_strides</span><span class="s2">(</span><span class="s1">make_nonnative</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qruv_rank_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Any positive strided q, r, u, and v can be overwritten for a rank 1</span>
        <span class="s5"># update, only checking C and F contiguous.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>

        <span class="s5"># don't overwrite</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s5"># verify the overwriting, no good way to check u and v.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qruv_rank_1_economic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># updating economic decompositions can overwrite any contiguous r,</span>
        <span class="s5"># and positively strided r and u. V is only ever read.</span>
        <span class="s5"># only checking C and F contiguous.</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s4">'economic'</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>

        <span class="s5"># don't overwrite</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s5"># verify the overwriting, no good way to check u and v.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_overwrite_qruv_rank_p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># for rank p updates, q r must be F contiguous, v must be C (v.T --&gt; F)</span>
        <span class="s5"># and u can be C or F, but is only overwritten if Q is C and complex</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'sqr'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'C'</span><span class="s2">)</span>

        <span class="s5"># don't overwrite</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s5"># verify the overwriting, no good way to check u and v.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty_inputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]), </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>

    <span class="s0">def </span><span class="s1">test_mismatched_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">[:-</span><span class="s3">2</span><span class="s2">], </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:])</span>

    <span class="s0">def </span><span class="s1">test_unsupported_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dts </span><span class="s2">= [</span><span class="s4">'int8'</span><span class="s2">, </span><span class="s4">'int16'</span><span class="s2">, </span><span class="s4">'int32'</span><span class="s2">, </span><span class="s4">'int64'</span><span class="s2">,</span>
               <span class="s4">'uint8'</span><span class="s2">, </span><span class="s4">'uint16'</span><span class="s2">, </span><span class="s4">'uint32'</span><span class="s2">, </span><span class="s4">'uint64'</span><span class="s2">,</span>
               <span class="s4">'float16'</span><span class="s2">, </span><span class="s4">'longdouble'</span><span class="s2">, </span><span class="s4">'clongdouble'</span><span class="s2">,</span>
               <span class="s4">'bool'</span><span class="s2">]</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">dts</span><span class="s2">:</span>
            <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">real</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_integer_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">16</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">q</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()  </span><span class="s5"># doesn't matter</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">q</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, :].</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a0</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_economic_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a0</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generate</span><span class="s2">(</span><span class="s4">'tall'</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">'economic'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">q0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">r0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u0</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">u </span><span class="s2">= </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">u</span><span class="s2">[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v0</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v0</span><span class="s2">)</span>

        <span class="s1">v </span><span class="s2">= </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s1">v</span><span class="s2">[</span><span class="s3">0</span><span class="s2">,</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">], </span><span class="s1">v</span><span class="s2">[:,</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qr_update</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">, </span><span class="s1">r0</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_u_exactly_in_span_q</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">q1</span><span class="s2">, </span><span class="s1">r1 </span><span class="s2">= </span><span class="s1">qr_update</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">())</span>
        <span class="s1">check_qr</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRupdate_f</span><span class="s2">(</span><span class="s1">BaseQRupdate</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRupdate_F</span><span class="s2">(</span><span class="s1">BaseQRupdate</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'F'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRupdate_d</span><span class="s2">(</span><span class="s1">BaseQRupdate</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'d'</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestQRupdate_D</span><span class="s2">(</span><span class="s1">BaseQRupdate</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'D'</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_form_qTu</span><span class="s2">():</span>
    <span class="s5"># We want to ensure that all of the code paths through this function are</span>
    <span class="s5"># tested. Most of them should be hit with the rest of test suite, but</span>
    <span class="s5"># explicit tests make clear precisely what is being tested.</span>
    <span class="s5">#</span>
    <span class="s5"># This function expects that Q is either C or F contiguous and square.</span>
    <span class="s5"># Economic mode decompositions (Q is (M, N), M != N) do not go through this</span>
    <span class="s5"># function. U may have any positive strides.</span>
    <span class="s5">#</span>
    <span class="s5"># Some of these test are duplicates, since contiguous 1d arrays are both C</span>
    <span class="s5"># and F.</span>

    <span class="s1">q_order </span><span class="s2">= [</span><span class="s4">'F'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">]</span>
    <span class="s1">q_shape </span><span class="s2">= [(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), ]</span>
    <span class="s1">u_order </span><span class="s2">= [</span><span class="s4">'F'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">, </span><span class="s4">'A'</span><span class="s2">]  </span><span class="s5"># here A means is not F not C</span>
    <span class="s1">u_shape </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
    <span class="s1">dtype </span><span class="s2">= [</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'F'</span><span class="s2">, </span><span class="s4">'D'</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">qo</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">, </span><span class="s1">uo</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s1">d </span><span class="s0">in </span><span class="s1">\</span>
            <span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">q_order</span><span class="s2">, </span><span class="s1">q_shape</span><span class="s2">, </span><span class="s1">u_order</span><span class="s2">, </span><span class="s1">u_shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">us </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">check_form_qTu</span><span class="s2">(</span><span class="s1">qo</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">, </span><span class="s1">uo</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
            <span class="s1">check_form_qTu</span><span class="s2">(</span><span class="s1">qo</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">, </span><span class="s1">uo</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">check_form_qTu</span><span class="s2">(</span><span class="s1">qo</span><span class="s2">, </span><span class="s1">qs</span><span class="s2">, </span><span class="s1">uo</span><span class="s2">, </span><span class="s1">us</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">check_form_qTu</span><span class="s2">(</span><span class="s1">q_order</span><span class="s2">, </span><span class="s1">q_shape</span><span class="s2">, </span><span class="s1">u_order</span><span class="s2">, </span><span class="s1">u_shape</span><span class="s2">, </span><span class="s1">u_ndim</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">47</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">u_shape </span><span class="s2">== </span><span class="s3">1 </span><span class="s0">and </span><span class="s1">u_ndim </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
        <span class="s1">u_shape </span><span class="s2">= (</span><span class="s1">q_shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">],)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">u_shape </span><span class="s2">= (</span><span class="s1">q_shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">u_shape</span><span class="s2">)</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char </span><span class="s0">in </span><span class="s4">'fd'</span><span class="s2">:</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">q_shape</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">u_shape</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char </span><span class="s0">in </span><span class="s4">'FD'</span><span class="s2">:</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">q_shape</span><span class="s2">) + </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">q_shape</span><span class="s2">)</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">u_shape</span><span class="s2">) + </span><span class="s3">1j</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">u_shape</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;form_qTu doesn't support this dtype&quot;</span><span class="s2">)</span>

    <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">require</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">q_order</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">u_order </span><span class="s2">!= </span><span class="s4">'A'</span><span class="s2">:</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">require</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">u_order</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">u</span><span class="s2">, = </span><span class="s1">make_strided</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">),))</span>

    <span class="s1">rtol </span><span class="s2">= </span><span class="s3">10.0 </span><span class="s2">** -(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">precision</span><span class="s2">-</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">u</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">_decomp_update</span><span class="s2">.</span><span class="s1">_form_qTu</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">u</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
</pre>
</body>
</html>