<html>
<head>
<title>test_column_transformer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_column_transformer.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test the ColumnTransformer. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">pickle</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">mock </span><span class="s2">import </span><span class="s1">Mock</span>

<span class="s2">import </span><span class="s1">joblib</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">assert_allclose</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">sparse</span>

<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">BaseEstimator</span><span class="s3">, </span><span class="s1">TransformerMixin</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">compose </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ColumnTransformer</span><span class="s3">,</span>
    <span class="s1">make_column_selector</span><span class="s3">,</span>
    <span class="s1">make_column_transformer</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">compose</span><span class="s3">.</span><span class="s1">_column_transformer </span><span class="s2">import </span><span class="s1">_RemainderColsList</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">NotFittedError</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">feature_selection </span><span class="s2">import </span><span class="s1">VarianceThreshold</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">FunctionTransformer</span><span class="s3">,</span>
    <span class="s1">Normalizer</span><span class="s3">,</span>
    <span class="s1">OneHotEncoder</span><span class="s3">,</span>
    <span class="s1">StandardScaler</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">metadata_routing_common </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ConsumingTransformer</span><span class="s3">,</span>
    <span class="s1">_Registry</span><span class="s3">,</span>
    <span class="s1">check_recorded_metadata</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_indexing </span><span class="s2">import </span><span class="s1">_safe_indexing</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_convert_container</span><span class="s3">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">CSR_CONTAINERS</span><span class="s3">, </span><span class="s1">parse_version</span>


<span class="s2">class </span><span class="s1">Trans</span><span class="s3">(</span><span class="s1">TransformerMixin</span><span class="s3">, </span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s4"># 1D Series -&gt; 2D DataFrame</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s5">&quot;to_frame&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">X</span><span class="s3">.</span><span class="s1">to_frame</span><span class="s3">()</span>
        <span class="s4"># 1D array -&gt; 2D array</span>
        <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s5">&quot;ndim&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">DoubleTrans</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">SparseMatrixTrans</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">csr_container </span><span class="s3">= </span><span class="s1">csr_container</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TransNo2D</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">TransRaise</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;specific message&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;specific message&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">X_res_first1D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])</span>
    <span class="s1">X_res_second1D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">])</span>
    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">X_res_first1D</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s1">cases </span><span class="s3">= [</span>
        <span class="s4"># single column 1D / 2D</span>
        <span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s4"># list-like</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># slice</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># boolean mask</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s1">X_res_both</span><span class="s3">),</span>
    <span class="s3">]</span>

    <span class="s2">for </span><span class="s1">selection</span><span class="s3">, </span><span class="s1">res </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">selection</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

        <span class="s4"># callable that returns any of the allowed specifiers</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">selection</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>

    <span class="s4"># test with transformer_weights</span>
    <span class="s1">transformer_weights </span><span class="s3">= {</span><span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">, </span><span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">}</span>
    <span class="s1">both </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])],</span>
        <span class="s1">transformer_weights</span><span class="s3">=</span><span class="s1">transformer_weights</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s1">transformer_weights</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">] * </span><span class="s1">X_res_first1D</span><span class="s3">,</span>
            <span class="s1">transformer_weights</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">] * </span><span class="s1">X_res_second1D</span><span class="s3">,</span>
        <span class="s3">]</span>
    <span class="s3">).</span><span class="s1">T</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>

    <span class="s1">both </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">1</span>


<span class="s2">def </span><span class="s1">test_column_transformer_tuple_transformers_parameter</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">transformers </span><span class="s3">= [(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])]</span>

    <span class="s1">ct_with_list </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span><span class="s1">transformers</span><span class="s3">)</span>
    <span class="s1">ct_with_tuple </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">transformers</span><span class="s3">))</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">ct_with_list</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">ct_with_tuple</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">ct_with_list</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">),</span>
        <span class="s1">ct_with_tuple</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">),</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;constructor_name&quot;</span><span class="s3">, [</span><span class="s5">&quot;dataframe&quot;</span><span class="s3">, </span><span class="s5">&quot;polars&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_dataframe</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s3">== </span><span class="s5">&quot;dataframe&quot;</span><span class="s3">:</span>
        <span class="s1">dataframe_lib </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">dataframe_lib </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">)</span>

    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span>
        <span class="s1">X_array</span><span class="s3">, </span><span class="s1">constructor_name</span><span class="s3">, </span><span class="s1">columns_name</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s1">cases </span><span class="s3">= [</span>
        <span class="s4"># String keys: label based</span>
        <span class="s4"># list</span>
        <span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">], </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">], </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># slice</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># int keys: positional</span>
        <span class="s4"># list</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># slice</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">),</span>
        <span class="s4"># boolean mask</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), </span><span class="s1">X_res_first</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], </span><span class="s1">X_res_first</span><span class="s3">),</span>
    <span class="s3">]</span>
    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s3">== </span><span class="s5">&quot;dataframe&quot;</span><span class="s3">:</span>
        <span class="s4"># Scalars are only supported for pandas dataframes.</span>
        <span class="s1">cases</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s4"># scalar</span>
                <span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">X_res_first</span><span class="s3">),</span>
                <span class="s3">(</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s1">X_res_first</span><span class="s3">),</span>
                <span class="s3">(</span>
                    <span class="s1">dataframe_lib</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
                    <span class="s1">X_res_first</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">]</span>
        <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">selection</span><span class="s3">, </span><span class="s1">res </span><span class="s2">in </span><span class="s1">cases</span><span class="s3">:</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">selection</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

        <span class="s4"># callable that returns any of the allowed specifiers</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s2">lambda </span><span class="s1">X</span><span class="s3">: </span><span class="s1">selection</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;first&quot;</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;second&quot;</span><span class="s3">])]</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s4"># test with transformer_weights</span>
    <span class="s1">transformer_weights </span><span class="s3">= {</span><span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">, </span><span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">}</span>
    <span class="s1">both </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;first&quot;</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;second&quot;</span><span class="s3">])],</span>
        <span class="s1">transformer_weights</span><span class="s3">=</span><span class="s1">transformer_weights</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s1">transformer_weights</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">] * </span><span class="s1">X_df</span><span class="s3">[</span><span class="s5">&quot;first&quot;</span><span class="s3">],</span>
            <span class="s1">transformer_weights</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">] * </span><span class="s1">X_df</span><span class="s3">[</span><span class="s5">&quot;second&quot;</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">).</span><span class="s1">T</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s4"># test multiple columns</span>
    <span class="s1">both </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">1</span>
    <span class="s2">assert </span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s1">both </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s6">0.1 </span><span class="s3">* </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">1</span>
    <span class="s2">assert </span><span class="s1">both</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s4"># ensure pandas object is passed through</span>

    <span class="s2">class </span><span class="s1">TransAssert</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">expected_type_transform</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">expected_type_transform </span><span class="s3">= </span><span class="s1">expected_type_transform</span>

        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">expected_type_transform</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dataframe_lib</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">):</span>
                <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">to_frame</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;trans&quot;</span><span class="s3">,</span>
                <span class="s1">TransAssert</span><span class="s3">(</span><span class="s1">expected_type_transform</span><span class="s3">=</span><span class="s1">dataframe_lib</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">),</span>
                <span class="s3">[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">],</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s3">== </span><span class="s5">&quot;dataframe&quot;</span><span class="s3">:</span>
        <span class="s4"># DataFrame protocol does not have 1d columns, so we only test on Pandas</span>
        <span class="s4"># dataframes.</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span>
                    <span class="s5">&quot;trans&quot;</span><span class="s3">,</span>
                    <span class="s1">TransAssert</span><span class="s3">(</span><span class="s1">expected_type_transform</span><span class="s3">=</span><span class="s1">dataframe_lib</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">),</span>
                    <span class="s5">&quot;first&quot;</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>

        <span class="s4"># Only test on pandas because the dataframe protocol requires string column</span>
        <span class="s4"># names</span>
        <span class="s4"># integer column spec + integer column names -&gt; still use positional</span>
        <span class="s1">X_df2 </span><span class="s3">= </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">X_df2</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s6">0</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df2</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df2</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df2</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
        <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
        <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">] == </span><span class="s5">&quot;drop&quot;</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], </span><span class="s1">ids</span><span class="s3">=[</span><span class="s5">&quot;pandas&quot;</span><span class="s3">, </span><span class="s5">&quot;numpy&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;column_selection&quot;</span><span class="s3">,</span>
    <span class="s3">[[], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s5">&quot;list&quot;</span><span class="s3">, </span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;bool_int&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;callable_column&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_empty_columns</span><span class="s3">(</span><span class="s1">pandas</span><span class="s3">, </span><span class="s1">column_selection</span><span class="s3">, </span><span class="s1">callable_column</span><span class="s3">):</span>
    <span class="s4"># test case that ensures that the column transformer does also work when</span>
    <span class="s4"># a given transformer doesn't have any columns to work on</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s2">if </span><span class="s1">pandas</span><span class="s3">:</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s2">if </span><span class="s1">callable_column</span><span class="s3">:</span>
        <span class="s1">column </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">X</span><span class="s3">: </span><span class="s1">column_selection  </span><span class="s4"># noqa</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">column </span><span class="s3">= </span><span class="s1">column_selection</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), </span><span class="s1">column</span><span class="s3">)]</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">TransRaise</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), </span><span class="s1">column</span><span class="s3">), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])]</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">TransRaise</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), </span><span class="s1">column</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2  </span><span class="s4"># including remainder</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">TransRaise</span><span class="s3">)</span>

    <span class="s1">fixture </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[], [], []])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), </span><span class="s1">column</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">fixture</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">fixture</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2  </span><span class="s4"># including remainder</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">TransRaise</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_output_indices</span><span class="s3">():</span>
    <span class="s4"># Checks for the output_indices_ attribute</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">6</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">]])</span>

    <span class="s4"># test with transformer_weights and multiple columns</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;remainder&quot;</span><span class="s3">]])</span>

    <span class="s4"># test case that ensures that the attribute does also work when</span>
    <span class="s4"># a given transformer doesn't have any columns to work on</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), [])])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;remainder&quot;</span><span class="s3">]])</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), [])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span><span class="s5">&quot;trans&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), </span><span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;remainder&quot;</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_output_indices_df</span><span class="s3">():</span>
    <span class="s4"># Checks for the output_indices_ attribute with data frames</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">6</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;first&quot;</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;second&quot;</span><span class="s3">])]</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;remainder&quot;</span><span class="s3">]])</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_ </span><span class="s3">== {</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, []], </span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">output_indices_</span><span class="s3">[</span><span class="s5">&quot;remainder&quot;</span><span class="s3">]])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_sparse_array</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">))</span>

    <span class="s4"># no distinction between 1D and 2D</span>
    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">X_sparse</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">]]</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_sparse</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s3">[(</span><span class="s6">0</span><span class="s3">,), [</span><span class="s6">0</span><span class="s3">], </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)]:</span>
        <span class="s2">for </span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">res </span><span class="s2">in </span><span class="s3">[(</span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s1">X_res_first</span><span class="s3">), (</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">X_res_both</span><span class="s3">)]:</span>
            <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">col</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.8</span>
            <span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">))</span>
            <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>
            <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">), </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s3">[[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)]:</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">col</span><span class="s3">)], </span><span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.8</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">))</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_list</span><span class="s3">():</span>
    <span class="s1">X_list </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s5">&quot;nan&quot;</span><span class="s3">), </span><span class="s5">&quot;a&quot;</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]]</span>
    <span class="s1">expected_result </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s5">&quot;nan&quot;</span><span class="s3">), </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">&quot;numerical&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;categorical&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_list</span><span class="s3">), </span><span class="s1">expected_result</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_list</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_list</span><span class="s3">), </span><span class="s1">expected_result</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_sparse_stacking</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">SparseMatrixTrans</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">), </span><span class="s6">1</span><span class="s3">)],</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.8</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()[:, </span><span class="s6">1</span><span class="s3">:], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]))</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">SparseMatrixTrans</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">), </span><span class="s6">1</span><span class="s3">)],</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s6">1</span><span class="s3">:], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]))</span>


<span class="s2">def </span><span class="s1">test_column_transformer_mixed_cols_sparse</span><span class="s3">():</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], [</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;O&quot;</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]), </span><span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">1.0</span>
    <span class="s3">)</span>

    <span class="s4"># this shouldn't fail, since boolean can be coerced into a numeric</span>
    <span class="s4"># See: https://github.com/scikit-learn/scikit-learn/issues/11912</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">getformat</span><span class="s3">() == </span><span class="s5">&quot;csr&quot;</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]]))</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">]), </span><span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">1.0</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;For a sparse output, all columns should&quot;</span><span class="s3">):</span>
        <span class="s4"># this fails since strings `a` and `b` cannot be</span>
        <span class="s4"># coerced into a numeric.</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_sparse_threshold</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], [</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;B&quot;</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">).</span><span class="s1">T</span>
    <span class="s4"># above data has sparsity of 4 / 8 = 0.5</span>

    <span class="s4"># apply threshold even if all sparse</span>
    <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])],</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.2</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">sparse_output_</span>

    <span class="s4"># mixed -&gt; sparsity of (4 + 2) / 8 = 0.75</span>
    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s3">[</span><span class="s6">0.75001</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]:</span>
        <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), [</span><span class="s6">0</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s1">thres</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">sparse_output_</span>

    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s3">[</span><span class="s6">0.75</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]:</span>
        <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), [</span><span class="s6">0</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s1">thres</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">sparse_output_</span>

    <span class="s4"># if nothing is sparse -&gt; no sparse</span>
    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s3">[</span><span class="s6">0.33</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]:</span>
        <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), [</span><span class="s6">0</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s1">thres</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">sparse_output_</span>


<span class="s2">def </span><span class="s1">test_column_transformer_error_msg_1D</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), </span><span class="s6">0</span><span class="s3">)])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;1D data passed to a transformer&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>

    <span class="s1">col_trans </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">TransRaise</span><span class="s3">(), </span><span class="s6">0</span><span class="s3">)])</span>
    <span class="s2">for </span><span class="s1">func </span><span class="s2">in </span><span class="s3">[</span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">, </span><span class="s1">col_trans</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">]:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;specific message&quot;</span><span class="s3">):</span>
            <span class="s1">func</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_2D_transformer_output</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s4"># if one transformer is dropped, test that name is still correct</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">TransNo2D</span><span class="s3">(), </span><span class="s6">1</span><span class="s3">)])</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;the 'trans2' transformer should be 2D&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s4"># because fit is also doing transform, this raises already on fit</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_2D_transformer_output_pandas</span><span class="s3">():</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">])</span>

    <span class="s4"># if one transformer is dropped, test that name is still correct</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">TransNo2D</span><span class="s3">(), </span><span class="s5">&quot;col1&quot;</span><span class="s3">)])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;the 'trans1' transformer should be 2D&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s4"># because fit is also doing transform, this raises already on fit</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_invalid_columns</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s4"># general invalid</span>
    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s3">[</span><span class="s6">1.5</span><span class="s3">, [</span><span class="s5">&quot;string&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s5">&quot;s&quot;</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">])]:</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">col</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;No valid specification&quot;</span><span class="s3">):</span>
            <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>

    <span class="s4"># invalid for arrays</span>
    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s3">[</span><span class="s5">&quot;string&quot;</span><span class="s3">, [</span><span class="s5">&quot;string&quot;</span><span class="s3">, </span><span class="s5">&quot;other&quot;</span><span class="s3">], </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">)]:</span>
        <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">col</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;Specifying the columns&quot;</span><span class="s3">):</span>
            <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>

    <span class="s4"># transformed n_features does not match fitted n_features</span>
    <span class="s1">col </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">col</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">X_array_more </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">9</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;X has 3 features, but ColumnTransformer is expecting 2 features as input.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array_more</span><span class="s3">)</span>
    <span class="s1">X_array_fewer </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">).</span><span class="s1">T</span>
    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s5">&quot;X has 1 features, but ColumnTransformer is expecting 2 features as input.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array_fewer</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_invalid_transformer</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">NoTrans</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">NoTrans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;All estimators should implement fit and transform&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer</span><span class="s3">():</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">norm </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">scaler</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">), (</span><span class="s1">norm</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">]))</span>
    <span class="s1">names</span><span class="s3">, </span><span class="s1">transformers</span><span class="s3">, </span><span class="s1">columns </span><span class="s3">= </span><span class="s1">zip</span><span class="s3">(*</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names </span><span class="s3">== (</span><span class="s5">&quot;standardscaler&quot;</span><span class="s3">, </span><span class="s5">&quot;normalizer&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">transformers </span><span class="s3">== (</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">columns </span><span class="s3">== (</span><span class="s5">&quot;first&quot;</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_pandas</span><span class="s3">():</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>
    <span class="s1">norm </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">()</span>
    <span class="s1">ct1 </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;norm&quot;</span><span class="s3">, </span><span class="s1">Normalizer</span><span class="s3">(), </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)])</span>
    <span class="s1">ct2 </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">))</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">ct1</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">ct2</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_kwargs</span><span class="s3">():</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">norm </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">norm</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">3</span><span class="s3">,</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s3">(</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span>
        <span class="s3">== </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">scaler</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">), (</span><span class="s1">norm</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">])).</span><span class="s1">transformers</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">n_jobs </span><span class="s3">== </span><span class="s6">3</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">remainder </span><span class="s3">== </span><span class="s5">&quot;drop&quot;</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">sparse_threshold </span><span class="s3">== </span><span class="s6">0.5</span>
    <span class="s4"># invalid keyword parameters should raise an error message</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s5">&quot;make_column_transformer() got an unexpected &quot;</span>
        <span class="s5">&quot;keyword argument 'transformer_weights'&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">make_column_transformer</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">norm</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
            <span class="s1">transformer_weights</span><span class="s3">={</span><span class="s5">&quot;pca&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">, </span><span class="s5">&quot;Transf&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">},</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_remainder_transformer</span><span class="s3">():</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">norm </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">()</span>
    <span class="s1">remainder </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">), (</span><span class="s1">norm</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">]), </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">remainder </span><span class="s3">== </span><span class="s1">remainder</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_set_params</span><span class="s3">():</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])]</span>
    <span class="s3">)</span>

    <span class="s1">exp </span><span class="s3">= {</span>
        <span class="s5">&quot;n_jobs&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;sparse_threshold&quot;</span><span class="s3">: </span><span class="s6">0.3</span><span class="s3">,</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s5">&quot;trans1__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans1__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans1__with_std&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s5">&quot;trans2__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans2__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans2__with_std&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;transformers&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">,</span>
        <span class="s5">&quot;transformer_weights&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;verbose_feature_names_out&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;verbose&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s5">&quot;force_int_remainder_cols&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">() == </span><span class="s1">exp</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">trans1__with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">()[</span><span class="s5">&quot;trans1__with_mean&quot;</span><span class="s3">]</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">trans1</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">exp </span><span class="s3">= {</span>
        <span class="s5">&quot;n_jobs&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;sparse_threshold&quot;</span><span class="s3">: </span><span class="s6">0.3</span><span class="s3">,</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;trans2&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s5">&quot;trans2__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans2__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans2__with_std&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;transformers&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">,</span>
        <span class="s5">&quot;transformer_weights&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;verbose_feature_names_out&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;verbose&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s5">&quot;force_int_remainder_cols&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">() == </span><span class="s1">exp</span>


<span class="s2">def </span><span class="s1">test_column_transformer_named_estimators</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">, </span><span class="s5">&quot;transformers_&quot;</span><span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">, </span><span class="s5">&quot;transformers_&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">[</span><span class="s5">&quot;trans1&quot;</span><span class="s3">], </span><span class="s1">StandardScaler</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">.</span><span class="s1">trans1</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">[</span><span class="s5">&quot;trans2&quot;</span><span class="s3">], </span><span class="s1">StandardScaler</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">.</span><span class="s1">trans2</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">.</span><span class="s1">trans2</span><span class="s3">.</span><span class="s1">with_std</span>
    <span class="s4"># check it are fitted transformers</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">.</span><span class="s1">trans1</span><span class="s3">.</span><span class="s1">mean_ </span><span class="s3">== </span><span class="s6">1.0</span>


<span class="s2">def </span><span class="s1">test_column_transformer_cloning</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;mean_&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;mean_&quot;</span><span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;mean_&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;mean_&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_feature_names</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s4"># raise correct error when not fitted</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s4"># raise correct error when no feature names are available</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s5">&quot;Transformer trans (type Trans) does not provide get_feature_names_out&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_column_transformer_special_strings</span><span class="s3">():</span>
    <span class="s4"># one 'drop' -&gt; ignore</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">1.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s4"># all 'drop' -&gt; return shape 0 array</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>

    <span class="s4"># 'passthrough'</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">6.0</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s1">X_array</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>


<span class="s2">def </span><span class="s1">test_column_transformer_remainder</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">X_res_second </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s4"># default drop</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">] == </span><span class="s5">&quot;drop&quot;</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">])</span>

    <span class="s4"># specify passthrough</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">FunctionTransformer</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">])</span>

    <span class="s4"># column order is not preserved (passed through added to end)</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">[:, ::-</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">[:, ::-</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">FunctionTransformer</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">])</span>

    <span class="s4"># passthrough when all actual transformers are skipped</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_second</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_second</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">FunctionTransformer</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">])</span>

    <span class="s4"># check default for make_column_transformer</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]))</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">remainder </span><span class="s3">== </span><span class="s5">&quot;drop&quot;</span>


<span class="s4"># TODO(1.7): check for deprecated force_int_remainder_cols</span>
<span class="s4"># TODO(1.9): remove force_int but keep the test</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;cols1, cols2&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]),  </span><span class="s4"># mix types</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]),  </span><span class="s4"># ints</span>
        <span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">]),  </span><span class="s4"># callables</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;force_int&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_dtypes_ints</span><span class="s3">(</span><span class="s1">force_int</span><span class="s3">, </span><span class="s1">cols1</span><span class="s3">, </span><span class="s1">cols2</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that the remainder columns are always stored as indices when 
    other columns are not all specified as column names or masks, regardless of 
    `force_int_remainder_cols`. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">cols1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">cols2</span><span class="s3">),</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s1">force_int</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s6">2</span>


<span class="s4"># TODO(1.7): check for deprecated force_int_remainder_cols</span>
<span class="s4"># TODO(1.9): remove force_int but keep the test</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;force_int, cols1, cols2, expected_cols&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, [</span><span class="s5">&quot;A&quot;</span><span class="s3">], [</span><span class="s5">&quot;B&quot;</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, [</span><span class="s5">&quot;A&quot;</span><span class="s3">], [</span><span class="s5">&quot;B&quot;</span><span class="s3">], [</span><span class="s5">&quot;C&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_dtypes</span><span class="s3">(</span><span class="s1">force_int</span><span class="s3">, </span><span class="s1">cols1</span><span class="s3">, </span><span class="s1">cols2</span><span class="s3">, </span><span class="s1">expected_cols</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that the remainder columns format matches the format of the other 
    columns when they're all strings or masks, unless `force_int = True`. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cols1</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;B&quot;</span><span class="s3">, </span><span class="s5">&quot;C&quot;</span><span class="s3">])</span>

    <span class="s4"># if inputs are column names store remainder columns as column names unless</span>
    <span class="s4"># force_int_remainder_cols is True</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">cols1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">cols2</span><span class="s3">),</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s1">force_int</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">force_int</span><span class="s3">:</span>
        <span class="s4"># If we forced using ints and we access the remainder columns a warning is shown</span>
        <span class="s1">match </span><span class="s3">= </span><span class="s5">&quot;The format of the columns of the 'remainder' transformer&quot;</span>
        <span class="s1">cols </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
            <span class="s1">cols</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
            <span class="s1">cols </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s1">cols</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s2">assert </span><span class="s1">cols </span><span class="s3">== </span><span class="s1">expected_cols</span>


<span class="s2">def </span><span class="s1">test_remainder_list_repr</span><span class="s3">():</span>
    <span class="s1">cols </span><span class="s3">= </span><span class="s1">_RemainderColsList</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">warning_enabled</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">) == </span><span class="s5">&quot;[0, 1]&quot;</span>
    <span class="s2">assert </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">) == </span><span class="s5">&quot;[0, 1]&quot;</span>
    <span class="s1">mock </span><span class="s3">= </span><span class="s1">Mock</span><span class="s3">()</span>
    <span class="s1">cols</span><span class="s3">.</span><span class="s1">_repr_pretty_</span><span class="s3">(</span><span class="s1">mock</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">mock</span><span class="s3">.</span><span class="s1">text</span><span class="s3">.</span><span class="s1">assert_called_once_with</span><span class="s3">(</span><span class="s5">&quot;[0, 1]&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;key, expected_cols&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">]), [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_numpy</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">expected_cols</span><span class="s3">):</span>
    <span class="s4"># test different ways that columns are specified with passthrough</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">key</span><span class="s3">)],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">FunctionTransformer</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == </span><span class="s1">expected_cols</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;key, expected_cols&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]),</span>
        <span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">], [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s5">&quot;pd-index&quot;</span><span class="s3">, [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">]), [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">), [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">), [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">), [</span><span class="s5">&quot;second&quot;</span><span class="s3">]),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_pandas</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">expected_cols</span><span class="s3">):</span>
    <span class="s4"># test different ways that columns are specified with passthrough</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">and </span><span class="s1">key </span><span class="s3">== </span><span class="s5">&quot;pd-index&quot;</span><span class="s3">:</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;first&quot;</span><span class="s3">])</span>

    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">key</span><span class="s3">)],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">FunctionTransformer</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == </span><span class="s1">expected_cols</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;key, expected_cols&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">]), [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_transformer</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">expected_cols</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s1">X_array</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

    <span class="s4"># second and third columns are doubled when remainder = DoubleTrans</span>
    <span class="s1">X_res_both</span><span class="s3">[:, </span><span class="s6">1</span><span class="s3">:</span><span class="s6">3</span><span class="s3">] *= </span><span class="s6">2</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">key</span><span class="s3">)],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">DoubleTrans</span><span class="s3">(),</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">DoubleTrans</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == </span><span class="s1">expected_cols</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_remaining_remainder_transformer</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">DoubleTrans</span><span class="s3">())</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">1</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] != </span><span class="s5">&quot;remainder&quot;</span>


<span class="s2">def </span><span class="s1">test_column_transformer_drops_all_remainder_transformer</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s4"># columns are doubled when remainder = DoubleTrans</span>
    <span class="s1">X_res_both </span><span class="s3">= </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">X_array</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()[:, </span><span class="s6">1</span><span class="s3">:</span><span class="s6">3</span><span class="s3">]</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">DoubleTrans</span><span class="s3">())</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_both</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">DoubleTrans</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_sparse_remainder_transformer</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">SparseMatrixTrans</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">),</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.8</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s4"># SparseMatrixTrans creates 3 features for each column. There is</span>
    <span class="s4"># one column in ``transformers``, thus:</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">)</span>

    <span class="s1">exp_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">X_array</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">].</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">exp_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">SparseMatrixTrans</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_drop_all_sparse_remainder_transformer</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">SparseMatrixTrans</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">),</span>
        <span class="s1">sparse_threshold</span><span class="s3">=</span><span class="s6">0.8</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>

    <span class="s4">#  SparseMatrixTrans creates 3 features for each column, thus:</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s6">3</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">2</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">1</span><span class="s3">], </span><span class="s1">SparseMatrixTrans</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_set_params_with_remainder</span><span class="s3">():</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s3">)</span>

    <span class="s1">exp </span><span class="s3">= {</span>
        <span class="s5">&quot;n_jobs&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__with_std&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;sparse_threshold&quot;</span><span class="s3">: </span><span class="s6">0.3</span><span class="s3">,</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s5">&quot;trans1__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans1__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;trans1__with_std&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;transformers&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">,</span>
        <span class="s5">&quot;transformer_weights&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;verbose_feature_names_out&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;verbose&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s5">&quot;force_int_remainder_cols&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">() == </span><span class="s1">exp</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">remainder__with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">()[</span><span class="s5">&quot;remainder__with_std&quot;</span><span class="s3">]</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">trans1</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">exp </span><span class="s3">= {</span>
        <span class="s5">&quot;n_jobs&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;remainder&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__copy&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__with_mean&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__with_std&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s5">&quot;sparse_threshold&quot;</span><span class="s3">: </span><span class="s6">0.3</span><span class="s3">,</span>
        <span class="s5">&quot;trans1&quot;</span><span class="s3">: </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;transformers&quot;</span><span class="s3">: </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">,</span>
        <span class="s5">&quot;transformer_weights&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s5">&quot;verbose_feature_names_out&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s5">&quot;verbose&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s5">&quot;force_int_remainder_cols&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">() == </span><span class="s1">exp</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_estimators</span><span class="s3">():</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">&quot;float&quot;</span><span class="s3">).</span><span class="s1">T</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">StandardScaler</span><span class="s3">())</span>

    <span class="s1">params </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">params</span><span class="s3">[</span><span class="s5">&quot;remainder__with_mean&quot;</span><span class="s3">]</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">X_array</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">) == </span><span class="s6">1</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">[</span><span class="s5">&quot;est&quot;</span><span class="s3">, </span><span class="s5">&quot;pattern&quot;</span><span class="s3">],</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])],</span>
                <span class="s1">remainder</span><span class="s3">=</span><span class="s1">DoubleTrans</span><span class="s3">(),</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])],</span>
                <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])],</span>
                <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])],</span>
                <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">(</span>
                <span class="s3">[(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;trans2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s5">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing trans2.* total=.*\n$&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">),</span>
            <span class="s5">r&quot;\[ColumnTransformer\].*\(1 of 1\) Processing trans1.* total=.*\n$&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;fit&quot;</span><span class="s3">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_verbose</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">capsys</span><span class="s3">):</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">func </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
    <span class="s1">est</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">func</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">().</span><span class="s1">out</span><span class="s3">, </span><span class="s5">&quot;Got output for verbose=False&quot;</span>

    <span class="s1">est</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">func</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">()[</span><span class="s6">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_estimators_set_params</span><span class="s3">():</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([]).</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">n_jobs </span><span class="s3">== </span><span class="s6">2</span>


<span class="s2">def </span><span class="s1">test_column_transformer_callable_specifier</span><span class="s3">():</span>
    <span class="s4"># assert that function gets the full array</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_array</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">func</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">2</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == [</span><span class="s6">0</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_column_transformer_callable_specifier_dataframe</span><span class="s3">():</span>
    <span class="s4"># assert that function gets the full dataframe</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_res_first </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]]).</span><span class="s1">T</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">values</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s5">&quot;first&quot;</span><span class="s3">]</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">func</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">X_res_first</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">2</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transformers_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == [</span><span class="s5">&quot;first&quot;</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_column_transformer_negative_column_indexes</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s1">X_categories </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">]])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_categories</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s1">ohe </span><span class="s3">= </span><span class="s1">OneHotEncoder</span><span class="s3">()</span>

    <span class="s1">tf_1 </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">ohe</span><span class="s3">, [-</span><span class="s6">1</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">tf_2 </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">ohe</span><span class="s3">, [</span><span class="s6">2</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">tf_1</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">tf_2</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;array_type&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">, *</span><span class="s1">CSR_CONTAINERS</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_mask_indexing</span><span class="s3">(</span><span class="s1">array_type</span><span class="s3">):</span>
    <span class="s4"># Regression test for #14510</span>
    <span class="s4"># Boolean array-like does not behave as boolean array with sparse matrices.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">array_type</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">column_transformer </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;identity&quot;</span><span class="s3">, </span><span class="s1">FunctionTransformer</span><span class="s3">(), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])]</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">column_transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_n_features_in</span><span class="s3">():</span>
    <span class="s4"># make sure n_features_in is what is passed as input to the column</span>
    <span class="s4"># transformer.</span>

    <span class="s1">X </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s1">DoubleTrans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">]), (</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s1">DoubleTrans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])])</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">, </span><span class="s5">&quot;n_features_in_&quot;</span><span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s6">2</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;cols, pattern, include, exclude&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">object</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, [</span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_str&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, [</span><span class="s1">object</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_str&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s1">object</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_float&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_float&quot;</span><span class="s3">], </span><span class="s5">&quot;at$&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, [</span><span class="s1">int</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">], </span><span class="s5">&quot;^col_int&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">], </span><span class="s5">&quot;float|str&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_str&quot;</span><span class="s3">], </span><span class="s5">&quot;^col_s&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, [</span><span class="s1">int</span><span class="s3">]),</span>
        <span class="s3">([], </span><span class="s5">&quot;str$&quot;</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">, </span><span class="s1">object</span><span class="s3">], </span><span class="s2">None</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_make_column_selector_with_select_dtypes</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">include</span><span class="s3">, </span><span class="s1">exclude</span><span class="s3">):</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;col_int&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">),</span>
            <span class="s5">&quot;col_float&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">),</span>
            <span class="s5">&quot;col_str&quot;</span><span class="s3">: [</span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;three&quot;</span><span class="s3">],</span>
        <span class="s3">},</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>

    <span class="s1">selector </span><span class="s3">= </span><span class="s1">make_column_selector</span><span class="s3">(</span>
        <span class="s1">dtype_include</span><span class="s3">=</span><span class="s1">include</span><span class="s3">, </span><span class="s1">dtype_exclude</span><span class="s3">=</span><span class="s1">exclude</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">=</span><span class="s1">pattern</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">selector</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">cols</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_with_make_column_selector</span><span class="s3">():</span>
    <span class="s4"># Functional test for column transformer + column selector</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;col_int&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">),</span>
            <span class="s5">&quot;col_float&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">),</span>
            <span class="s5">&quot;col_cat&quot;</span><span class="s3">: [</span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;col_str&quot;</span><span class="s3">: [</span><span class="s5">&quot;low&quot;</span><span class="s3">, </span><span class="s5">&quot;middle&quot;</span><span class="s3">, </span><span class="s5">&quot;high&quot;</span><span class="s3">],</span>
        <span class="s3">},</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_cat&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">X_df</span><span class="s3">[</span><span class="s5">&quot;col_str&quot;</span><span class="s3">] = </span><span class="s1">X_df</span><span class="s3">[</span><span class="s5">&quot;col_str&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">&quot;category&quot;</span><span class="s3">)</span>

    <span class="s1">cat_selector </span><span class="s3">= </span><span class="s1">make_column_selector</span><span class="s3">(</span><span class="s1">dtype_include</span><span class="s3">=[</span><span class="s5">&quot;category&quot;</span><span class="s3">, </span><span class="s1">object</span><span class="s3">])</span>
    <span class="s1">num_selector </span><span class="s3">= </span><span class="s1">make_column_selector</span><span class="s3">(</span><span class="s1">dtype_include</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">)</span>

    <span class="s1">ohe </span><span class="s3">= </span><span class="s1">OneHotEncoder</span><span class="s3">()</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>

    <span class="s1">ct_selector </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">ohe</span><span class="s3">, </span><span class="s1">cat_selector</span><span class="s3">), (</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">num_selector</span><span class="s3">))</span>
    <span class="s1">ct_direct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">ohe</span><span class="s3">, [</span><span class="s5">&quot;col_cat&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">]), (</span><span class="s1">scaler</span><span class="s3">, [</span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_int&quot;</span><span class="s3">])</span>
    <span class="s3">)</span>

    <span class="s1">X_selector </span><span class="s3">= </span><span class="s1">ct_selector</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s1">X_direct </span><span class="s3">= </span><span class="s1">ct_direct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_selector</span><span class="s3">, </span><span class="s1">X_direct</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_column_selector_error</span><span class="s3">():</span>
    <span class="s1">selector </span><span class="s3">= </span><span class="s1">make_column_selector</span><span class="s3">(</span><span class="s1">dtype_include</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">number</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.2</span><span class="s3">]])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;make_column_selector can only be applied to pandas dataframes&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">selector</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_column_selector_pickle</span><span class="s3">():</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;col_int&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">),</span>
            <span class="s5">&quot;col_float&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">),</span>
            <span class="s5">&quot;col_str&quot;</span><span class="s3">: [</span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;three&quot;</span><span class="s3">],</span>
        <span class="s3">},</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;col_int&quot;</span><span class="s3">, </span><span class="s5">&quot;col_float&quot;</span><span class="s3">, </span><span class="s5">&quot;col_str&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>

    <span class="s1">selector </span><span class="s3">= </span><span class="s1">make_column_selector</span><span class="s3">(</span><span class="s1">dtype_include</span><span class="s3">=[</span><span class="s1">object</span><span class="s3">])</span>
    <span class="s1">selector_picked </span><span class="s3">= </span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">loads</span><span class="s3">(</span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span><span class="s1">selector</span><span class="s3">))</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">selector</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">), </span><span class="s1">selector_picked</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;empty_col&quot;</span><span class="s3">,</span>
    <span class="s3">[[], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: []],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s5">&quot;list&quot;</span><span class="s3">, </span><span class="s5">&quot;array&quot;</span><span class="s3">, </span><span class="s5">&quot;callable&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_empty_columns</span><span class="s3">(</span><span class="s1">empty_col</span><span class="s3">):</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], </span><span class="s5">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">]})</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[</span>
            <span class="s3">(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), [</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;empty_features&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), </span><span class="s1">empty_col</span><span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(), [</span><span class="s5">&quot;ohe__col1_a&quot;</span><span class="s3">, </span><span class="s5">&quot;ohe__col1_b&quot;</span><span class="s3">, </span><span class="s5">&quot;ohe__col2_z&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;selector&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">[</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s5">&quot;col2&quot;</span><span class="s3">],</span>
        <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s5">&quot;col2&quot;</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">],</span>
        <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">],</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_out_pandas</span><span class="s3">(</span><span class="s1">selector</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Checks name when selecting only the second column&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], </span><span class="s5">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">]})</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), </span><span class="s1">selector</span><span class="s3">)])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(), [</span><span class="s5">&quot;ohe__col2_z&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;selector&quot;</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_out_non_pandas</span><span class="s3">(</span><span class="s1">selector</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Checks name when selecting the second column with numpy array&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">], [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">], [</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">]]</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">OneHotEncoder</span><span class="s3">(), </span><span class="s1">selector</span><span class="s3">)])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(), [</span><span class="s5">&quot;ohe__x1_z&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s4"># remainder='passthrough' or an estimator will be shown in repr_html</span>
    <span class="s1">ohe </span><span class="s3">= </span><span class="s1">OneHotEncoder</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">ohe</span><span class="s3">, [</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span>
    <span class="s3">)</span>
    <span class="s1">visual_block </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">_sk_visual_block_</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== (</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">name_details </span><span class="s3">== ([</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">], </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">estimators </span><span class="s3">== (</span><span class="s1">ohe</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_drop</span><span class="s3">():</span>
    <span class="s4"># remainder='drop' is not shown in repr_html</span>
    <span class="s1">ohe </span><span class="s3">= </span><span class="s1">OneHotEncoder</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span><span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">ohe</span><span class="s3">, [</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">])])</span>
    <span class="s1">visual_block </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">_sk_visual_block_</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== (</span><span class="s5">&quot;ohe&quot;</span><span class="s3">,)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">name_details </span><span class="s3">== ([</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">],)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">estimators </span><span class="s3">== (</span><span class="s1">ohe</span><span class="s3">,)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_fitted_pandas</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s4"># Remainder shows the columns after fitting</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">ohe </span><span class="s3">= </span><span class="s1">OneHotEncoder</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s1">ohe</span><span class="s3">, [</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">force_int_remainder_cols</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;col1&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;col2&quot;</span><span class="s3">: [</span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">, </span><span class="s5">&quot;z&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;col3&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">],</span>
            <span class="s5">&quot;col4&quot;</span><span class="s3">: [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">],</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">visual_block </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">_sk_visual_block_</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== (</span><span class="s5">&quot;ohe&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">name_details </span><span class="s3">== ([</span><span class="s5">&quot;col1&quot;</span><span class="s3">, </span><span class="s5">&quot;col2&quot;</span><span class="s3">], [</span><span class="s5">&quot;col3&quot;</span><span class="s3">, </span><span class="s5">&quot;col4&quot;</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">estimators </span><span class="s3">== (</span><span class="s1">ohe</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_fitted_numpy</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s4"># Remainder shows the indices after fitting</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;scale&quot;</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">visual_block </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">_sk_visual_block_</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== (</span><span class="s5">&quot;scale&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">name_details </span><span class="s3">== ([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">visual_block</span><span class="s3">.</span><span class="s1">estimators </span><span class="s3">== (</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;explicit_colname&quot;</span><span class="s3">, [</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s1">Trans</span><span class="s3">(), </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_reordered_column_names_remainder</span><span class="s3">(</span>
    <span class="s1">explicit_colname</span><span class="s3">, </span><span class="s1">remainder</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test the interaction between remainder and column transformer&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_fit_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_fit_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_fit_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s5">&quot;second&quot;</span><span class="s3">])</span>

    <span class="s1">X_trans_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">X_trans_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_trans_array</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;second&quot;</span><span class="s3">, </span><span class="s5">&quot;first&quot;</span><span class="s3">])</span>

    <span class="s1">tf </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;bycol&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), </span><span class="s1">explicit_colname</span><span class="s3">)], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">)</span>

    <span class="s1">tf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_fit_df</span><span class="s3">)</span>
    <span class="s1">X_fit_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_fit_df</span><span class="s3">)</span>

    <span class="s4"># Changing the order still works</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_trans_df</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_fit_trans</span><span class="s3">)</span>

    <span class="s4"># extra columns are ignored</span>
    <span class="s1">X_extended_df </span><span class="s3">= </span><span class="s1">X_fit_df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">X_extended_df</span><span class="s3">[</span><span class="s5">&quot;third&quot;</span><span class="s3">] = [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">9</span><span class="s3">]</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_extended_df</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_fit_trans</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">explicit_colname</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s4"># Raise error if columns are specified by names but input only allows</span>
        <span class="s4"># to specify by position, e.g. numpy array instead of a pandas df.</span>
        <span class="s1">X_array </span><span class="s3">= </span><span class="s1">X_fit_array</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;Specifying the columns&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
            <span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_name_validation_missing_columns_drop_passthough</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test the interaction between {'drop', 'passthrough'} and 
    missing column names.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>

    <span class="s1">df_dropped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s4"># with remainder='passthrough', all columns seen during `fit` must be</span>
    <span class="s4"># present</span>
    <span class="s1">tf </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;bycol&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">tf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">r&quot;columns are missing: {'c'}&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df_dropped</span><span class="s3">)</span>

    <span class="s4"># with remainder='drop', it is allowed to have column 'c' missing</span>
    <span class="s1">tf </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;bycol&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">tf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">df_dropped_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df_dropped</span><span class="s3">)</span>
    <span class="s1">df_fit_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">df_dropped_trans</span><span class="s3">, </span><span class="s1">df_fit_trans</span><span class="s3">)</span>

    <span class="s4"># bycol drops 'c', thus it is allowed for 'c' to be missing</span>
    <span class="s1">tf </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;bycol&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;c&quot;</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">tf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">df_dropped_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df_dropped</span><span class="s3">)</span>
    <span class="s1">df_fit_trans </span><span class="s3">= </span><span class="s1">tf</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">df_dropped_trans</span><span class="s3">, </span><span class="s1">df_fit_trans</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_names_in_</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Feature names are stored in column transformer. 
 
    Column transformer deliberately does not check for column name consistency. 
    It only checks that the non-dropped names seen in `fit` are seen 
    in `transform`. This behavior is already tested in 
    `test_feature_name_validation_missing_columns_drop_passthough`&quot;&quot;&quot;</span>

    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">feature_names </span><span class="s3">= [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">feature_names</span><span class="s3">)</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;bycol&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])], </span><span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">)</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">, </span><span class="s1">feature_names</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ct</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">object</span>


<span class="s2">class </span><span class="s1">TransWithNames</span><span class="s3">(</span><span class="s1">Trans</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">feature_names_out</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">feature_names_out </span><span class="s3">= </span><span class="s1">feature_names_out</span>

    <span class="s2">def </span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input_features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">feature_names_out </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">feature_names_out</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">input_features</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;transformers, remainder, expected_names&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__d&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__c&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol2__d&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__a&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__d&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__c&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol2__d&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__a&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;pca1&quot;</span><span class="s3">, </span><span class="s5">&quot;pca2&quot;</span><span class="s3">]), [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__pca1&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__pca2&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__a&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol2__b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s5">&quot;bycol1__pca0&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol1__pca1&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol2__pca0&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol2__pca1&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;remainder__a&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;remainder__c&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;remainder__d&quot;</span><span class="s3">,</span>
            <span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__a&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__d&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__c&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol2__d&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__a&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;bycol1__c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;bycol1__b&quot;</span><span class="s3">, </span><span class="s5">&quot;remainder__a&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s5">&quot;bycol1__d&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol1__c&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol2__c&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;bycol2__d&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;remainder__a&quot;</span><span class="s3">,</span>
                <span class="s5">&quot;remainder__b&quot;</span><span class="s3">,</span>
            <span class="s3">],</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_true</span><span class="s3">(</span><span class="s1">transformers</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">expected_names</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=True (default)&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">,</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">names </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">object</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, </span><span class="s1">expected_names</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;transformers, remainder, expected_names&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">]), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;pca1&quot;</span><span class="s3">, </span><span class="s5">&quot;pca2&quot;</span><span class="s3">]), [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;pca1&quot;</span><span class="s3">, </span><span class="s5">&quot;pca2&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]), [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;kpca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;pca0&quot;</span><span class="s3">, </span><span class="s5">&quot;pca1&quot;</span><span class="s3">, </span><span class="s5">&quot;kpca0&quot;</span><span class="s3">, </span><span class="s5">&quot;kpca1&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;d&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">)),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;d&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_false</span><span class="s3">(</span><span class="s1">transformers</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">expected_names</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=False&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">,</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">names </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">object</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, </span><span class="s1">expected_names</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;transformers, remainder, colliding_columns&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['c']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;drop&quot;</span><span class="s3">, [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['b', 'c']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a', 'b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">6</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">6</span><span class="s3">)]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['pca0', 'pca1', 'pca2', 'pca3', 'pca4', ...]&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a', 'b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a', 'b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a', 'b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">(</span><span class="s5">&quot;bycol1&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol2&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">)),</span>
                <span class="s3">(</span><span class="s5">&quot;bycol3&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">([</span><span class="s5">&quot;b&quot;</span><span class="s3">]), [</span><span class="s5">&quot;c&quot;</span><span class="s3">]),</span>
            <span class="s3">],</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;['a', 'b']&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_false_errors</span><span class="s3">(</span>
    <span class="s1">transformers</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">colliding_columns</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=False&quot;&quot;&quot;</span>

    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">,</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s5">f&quot;Output feature names: </span><span class="s2">{</span><span class="s1">colliding_columns</span><span class="s2">} </span><span class="s5">are not unique. Please set &quot;</span>
        <span class="s5">&quot;verbose_feature_names_out=True to add prefixes to feature names&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;verbose_feature_names_out&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_set_output</span><span class="s3">(</span><span class="s1">verbose_feature_names_out</span><span class="s3">, </span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check column transformer behavior with set_output.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s6">10</span><span class="s3">])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;first&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]), (</span><span class="s5">&quot;second&quot;</span><span class="s3">, </span><span class="s1">TransWithNames</span><span class="s3">(), [</span><span class="s5">&quot;d&quot;</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s1">verbose_feature_names_out</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">df_test </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=[</span><span class="s6">20</span><span class="s3">])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df_test</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>

    <span class="s1">feature_names_out </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">feature_names_out</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">df_test</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;fit_transform&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transform_set_output_mixed</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">, </span><span class="s1">fit_transform</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check ColumnTransformer outputs mixed types correctly.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;pet&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">&quot;dog&quot;</span><span class="s3">, </span><span class="s5">&quot;cat&quot;</span><span class="s3">, </span><span class="s5">&quot;snake&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;category&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;color&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">&quot;green&quot;</span><span class="s3">, </span><span class="s5">&quot;blue&quot;</span><span class="s3">, </span><span class="s5">&quot;red&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;object&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;age&quot;</span><span class="s3">: [</span><span class="s6">1.4</span><span class="s3">, </span><span class="s6">2.1</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">],</span>
            <span class="s5">&quot;height&quot;</span><span class="s3">: [</span><span class="s6">20</span><span class="s3">, </span><span class="s6">40</span><span class="s3">, </span><span class="s6">10</span><span class="s3">],</span>
            <span class="s5">&quot;distance&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">20</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NA</span><span class="s3">, </span><span class="s6">100</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Int32&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;color_encode&quot;</span><span class="s3">,</span>
                <span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;int8&quot;</span><span class="s3">),</span>
                <span class="s3">[</span><span class="s5">&quot;color&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
            <span class="s3">(</span><span class="s5">&quot;age&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s5">&quot;age&quot;</span><span class="s3">]),</span>
        <span class="s3">],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_transform</span><span class="s3">:</span>
        <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s1">expected_dtypes </span><span class="s3">= {</span>
        <span class="s5">&quot;color_blue&quot;</span><span class="s3">: </span><span class="s5">&quot;int8&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;color_green&quot;</span><span class="s3">: </span><span class="s5">&quot;int8&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;color_red&quot;</span><span class="s3">: </span><span class="s5">&quot;int8&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;age&quot;</span><span class="s3">: </span><span class="s5">&quot;float64&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;pet&quot;</span><span class="s3">: </span><span class="s5">&quot;category&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;height&quot;</span><span class="s3">: </span><span class="s5">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;distance&quot;</span><span class="s3">: </span><span class="s5">&quot;Int32&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s2">for </span><span class="s1">col</span><span class="s3">, </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">assert </span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">expected_dtypes</span><span class="s3">[</span><span class="s1">col</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;remainder&quot;</span><span class="s3">, [</span><span class="s5">&quot;drop&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transform_set_output_after_fitting</span><span class="s3">(</span><span class="s1">remainder</span><span class="s3">):</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;pet&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">&quot;dog&quot;</span><span class="s3">, </span><span class="s5">&quot;cat&quot;</span><span class="s3">, </span><span class="s5">&quot;snake&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;category&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;age&quot;</span><span class="s3">: [</span><span class="s6">1.4</span><span class="s3">, </span><span class="s6">2.1</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">],</span>
            <span class="s5">&quot;height&quot;</span><span class="s3">: [</span><span class="s6">20</span><span class="s3">, </span><span class="s6">40</span><span class="s3">, </span><span class="s6">10</span><span class="s3">],</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;color_encode&quot;</span><span class="s3">,</span>
                <span class="s1">OneHotEncoder</span><span class="s3">(</span><span class="s1">sparse_output</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;int16&quot;</span><span class="s3">),</span>
                <span class="s3">[</span><span class="s5">&quot;pet&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
            <span class="s3">(</span><span class="s5">&quot;age&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s5">&quot;age&quot;</span><span class="s3">]),</span>
        <span class="s3">],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">remainder</span><span class="s3">,</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s4"># fit without calling set_output</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s5">&quot;float64&quot;</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_trans_df </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">expected_dtypes </span><span class="s3">= {</span>
        <span class="s5">&quot;pet_cat&quot;</span><span class="s3">: </span><span class="s5">&quot;int16&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;pet_dog&quot;</span><span class="s3">: </span><span class="s5">&quot;int16&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;pet_snake&quot;</span><span class="s3">: </span><span class="s5">&quot;int16&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;height&quot;</span><span class="s3">: </span><span class="s5">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;age&quot;</span><span class="s3">: </span><span class="s5">&quot;float64&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s2">for </span><span class="s1">col</span><span class="s3">, </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">X_trans_df</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">assert </span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">expected_dtypes</span><span class="s3">[</span><span class="s1">col</span><span class="s3">]</span>


<span class="s4"># PandasOutTransformer that does not define get_feature_names_out and always expects</span>
<span class="s4"># the input to be a DataFrame.</span>
<span class="s2">class </span><span class="s1">PandasOutTransformer</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">offset </span><span class="s3">= </span><span class="s1">offset</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">X </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">offset</span>

    <span class="s2">def </span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">transform</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s4"># This transformer will always output a DataFrame regardless of the</span>
        <span class="s4"># configuration.</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;trans_1, expected_verbose_names, expected_non_verbose_names&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s1">PandasOutTransformer</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">=</span><span class="s6">2.0</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s5">&quot;trans_0__feat1&quot;</span><span class="s3">, </span><span class="s5">&quot;trans_1__feat0&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">&quot;feat1&quot;</span><span class="s3">, </span><span class="s5">&quot;feat0&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">&quot;drop&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;trans_0__feat1&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">&quot;feat1&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s5">&quot;trans_0__feat1&quot;</span><span class="s3">, </span><span class="s5">&quot;trans_1__feat0&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">&quot;feat1&quot;</span><span class="s3">, </span><span class="s5">&quot;feat0&quot;</span><span class="s3">],</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_transformers_with_pandas_out_but_not_feature_names_out</span><span class="s3">(</span>
    <span class="s1">trans_1</span><span class="s3">, </span><span class="s1">expected_verbose_names</span><span class="s3">, </span><span class="s1">expected_non_verbose_names</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that set_config(transform=&quot;pandas&quot;) is compatible with more transformers. 
 
    Specifically, if transformers returns a DataFrame, but does not define 
    `get_feature_names_out`. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;feat0&quot;</span><span class="s3">: [</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">], </span><span class="s5">&quot;feat1&quot;</span><span class="s3">: [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">4.0</span><span class="s3">]})</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">&quot;trans_0&quot;</span><span class="s3">, </span><span class="s1">PandasOutTransformer</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">=</span><span class="s6">3.0</span><span class="s3">), [</span><span class="s5">&quot;feat1&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;trans_1&quot;</span><span class="s3">, </span><span class="s1">trans_1</span><span class="s3">, [</span><span class="s5">&quot;feat0&quot;</span><span class="s3">]),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">X_trans_np </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans_np</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>

    <span class="s4"># `ct` does not have `get_feature_names_out` because `PandasOutTransformer` does</span>
    <span class="s4"># not define the method.</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;not provide get_feature_names_out&quot;</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>

    <span class="s4"># The feature names are prefixed because verbose_feature_names_out=True is default</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_trans_df0 </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans_df0</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">expected_verbose_names</span><span class="s3">)</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_trans_df1 </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans_df1</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">expected_non_verbose_names</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;empty_selection&quot;</span><span class="s3">,</span>
    <span class="s3">[[], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s5">&quot;list&quot;</span><span class="s3">, </span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;bool_int&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_empty_selection_pandas_output</span><span class="s3">(</span><span class="s1">empty_selection</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that pandas output works when there is an empty selection. 
 
    Non-regression test for gh-25487 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">], [</span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">&quot;categorical&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s1">empty_selection</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">&quot;numerical&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
        <span class="s3">],</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_out </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_out</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, [</span><span class="s5">&quot;numerical__a&quot;</span><span class="s3">, </span><span class="s5">&quot;numerical__b&quot;</span><span class="s3">])</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_out </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_out</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_raise_error_if_index_not_aligned</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check column transformer raises error if indices are not aligned. 
 
    Non-regression test for gh-26210. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">], [</span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s6">8</span><span class="s3">, </span><span class="s6">3</span><span class="s3">])</span>
    <span class="s1">reset_index_transformer </span><span class="s3">= </span><span class="s1">FunctionTransformer</span><span class="s3">(</span>
        <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">(</span><span class="s1">drop</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), </span><span class="s1">feature_names_out</span><span class="s3">=</span><span class="s5">&quot;one-to-one&quot;</span>
    <span class="s3">)</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">&quot;num1&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;num2&quot;</span><span class="s3">, </span><span class="s1">reset_index_transformer</span><span class="s3">, [</span><span class="s5">&quot;b&quot;</span><span class="s3">]),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s5">&quot;Concatenating DataFrames from the transformer's output lead to&quot;</span>
        <span class="s5">&quot; an inconsistent number of samples. The output may have Pandas&quot;</span>
        <span class="s5">&quot; Indexes that do not match.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_remainder_set_output</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that the output is set for the remainder. 
 
    Non-regression test for #26306. 
    &quot;&quot;&quot;</span>

    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s5">&quot;b&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]})</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">VarianceThreshold</span><span class="s3">(), </span><span class="s1">make_column_selector</span><span class="s3">(</span><span class="s1">dtype_include</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)),</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">VarianceThreshold</span><span class="s3">(),</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;default&quot;</span><span class="s3">)</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>


<span class="s4"># TODO(1.6): replace the warning by a ValueError exception</span>
<span class="s2">def </span><span class="s1">test_transform_pd_na</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check behavior when a tranformer's output contains pandas.NA 
 
    It should emit a warning unless the output config is set to 'pandas'. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">, </span><span class="s5">&quot;Float64Dtype&quot;</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span>
            <span class="s5">&quot;The issue with pd.NA tested here does not happen in old versions that do&quot;</span>
            <span class="s5">&quot; not have the extension dtypes&quot;</span>
        <span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1.5</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]})</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;a&quot;</span><span class="s3">]))</span>
    <span class="s4"># No warning with non-extension dtypes and np.nan</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">convert_dtypes</span><span class="s3">()</span>
    <span class="s4"># Error with extension dtype and pd.NA</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">r&quot;set_output\(transform='pandas'\)&quot;</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s4"># No warning when output is set to pandas</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s5">&quot;default&quot;</span><span class="s3">)</span>
    <span class="s4"># No warning when there are no pd.NA</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">fillna</span><span class="s3">(-</span><span class="s6">1.0</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_dataframe_different_dataframe_libraries</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check fitting and transforming on pandas and polars dataframes.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">pl </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;polars&quot;</span><span class="s3">)</span>
    <span class="s1">X_train_np </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]])</span>
    <span class="s1">X_test_np </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]])</span>

    <span class="s4"># Fit on pandas and transform on polars</span>
    <span class="s1">X_train_pd </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_train_np</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">X_test_pl </span><span class="s3">= </span><span class="s1">pl</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_test_np</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>

    <span class="s1">ct </span><span class="s3">= </span><span class="s1">make_column_transformer</span><span class="s3">((</span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train_pd</span><span class="s3">)</span>

    <span class="s1">out_pl_in </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test_pl</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">out_pl_in</span><span class="s3">, </span><span class="s1">X_test_np</span><span class="s3">)</span>

    <span class="s4"># Fit on polars and transform on pandas</span>
    <span class="s1">X_train_pl </span><span class="s3">= </span><span class="s1">pl</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_train_np</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">X_test_pd </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_test_np</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train_pl</span><span class="s3">)</span>

    <span class="s1">out_pd_in </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test_pd</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">out_pd_in</span><span class="s3">, </span><span class="s1">X_test_np</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer__getitem__</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check __getitem__ for ColumnTransformer.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">]])</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;t1&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), (</span><span class="s5">&quot;t2&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])])</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;ColumnTransformer is subscriptable after it is fitted&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">[</span><span class="s5">&quot;t1&quot;</span><span class="s3">]</span>

    <span class="s1">ct</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">[</span><span class="s5">&quot;t1&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">[</span><span class="s5">&quot;t1&quot;</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">ct</span><span class="s3">[</span><span class="s5">&quot;t2&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">named_transformers_</span><span class="s3">[</span><span class="s5">&quot;t2&quot;</span><span class="s3">]</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;'does_not_exist' is not a valid transformer name&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ct</span><span class="s3">[</span><span class="s5">&quot;does_not_exist&quot;</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;transform_output&quot;</span><span class="s3">, [</span><span class="s5">&quot;default&quot;</span><span class="s3">, </span><span class="s5">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_passthrough_naming_consistency</span><span class="s3">(</span><span class="s1">transform_output</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that when `remainder=&quot;passthrough&quot;`, inconsistent naming is handled 
    correctly by the underlying `FunctionTransformer`. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/28232 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))</span>

    <span class="s1">preprocessor </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;scaler&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s5">&quot;passthrough&quot;</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s1">transform_output</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">preprocessor</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span>

    <span class="s1">expected_column_names </span><span class="s3">= [</span>
        <span class="s5">&quot;scaler__x0&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;scaler__x1&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__x2&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;remainder__x3&quot;</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s5">&quot;columns&quot;</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == </span><span class="s1">expected_column_names</span>
    <span class="s2">assert </span><span class="s1">preprocessor</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">().</span><span class="s1">tolist</span><span class="s3">() == </span><span class="s1">expected_column_names</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;dataframe_lib&quot;</span><span class="s3">, [</span><span class="s5">&quot;pandas&quot;</span><span class="s3">, </span><span class="s5">&quot;polars&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_column_renaming</span><span class="s3">(</span><span class="s1">dataframe_lib</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we properly rename columns when using `ColumnTransformer` and 
    selected columns are redundant between transformers. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/28260 
    &quot;&quot;&quot;</span>
    <span class="s1">lib </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s1">dataframe_lib</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">lib</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;x1&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s5">&quot;x2&quot;</span><span class="s3">: [</span><span class="s6">10</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s6">30</span><span class="s3">], </span><span class="s5">&quot;x3&quot;</span><span class="s3">: [</span><span class="s6">100</span><span class="s3">, </span><span class="s6">200</span><span class="s3">, </span><span class="s6">300</span><span class="s3">]})</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[</span>
            <span class="s3">(</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;B&quot;</span><span class="s3">, </span><span class="s1">FunctionTransformer</span><span class="s3">(), [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;C&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">]),</span>
            <span class="s4"># special case of a transformer returning 0-columns, e.g feature selector</span>
            <span class="s3">(</span>
                <span class="s5">&quot;D&quot;</span><span class="s3">,</span>
                <span class="s1">FunctionTransformer</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">_safe_indexing</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)),</span>
                <span class="s3">[</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
        <span class="s3">],</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s1">dataframe_lib</span><span class="s3">)</span>
    <span class="s1">df_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">list</span><span class="s3">(</span><span class="s1">df_trans</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">) == [</span>
        <span class="s5">&quot;A__x1&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;A__x2&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;A__x3&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;B__x1&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;B__x2&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;C__x1&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;C__x3&quot;</span><span class="s3">,</span>
    <span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;dataframe_lib&quot;</span><span class="s3">, [</span><span class="s5">&quot;pandas&quot;</span><span class="s3">, </span><span class="s5">&quot;polars&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_error_with_duplicated_columns</span><span class="s3">(</span><span class="s1">dataframe_lib</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise an error when using `ColumnTransformer` and 
    the columns names are duplicated between transformers.&quot;&quot;&quot;</span>
    <span class="s1">lib </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s1">dataframe_lib</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">lib</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;x1&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s5">&quot;x2&quot;</span><span class="s3">: [</span><span class="s6">10</span><span class="s3">, </span><span class="s6">20</span><span class="s3">, </span><span class="s6">30</span><span class="s3">], </span><span class="s5">&quot;x3&quot;</span><span class="s3">: [</span><span class="s6">100</span><span class="s3">, </span><span class="s6">200</span><span class="s3">, </span><span class="s6">300</span><span class="s3">]})</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[</span>
            <span class="s3">(</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;B&quot;</span><span class="s3">, </span><span class="s1">FunctionTransformer</span><span class="s3">(), [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">]),</span>
            <span class="s3">(</span><span class="s5">&quot;C&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">]),</span>
            <span class="s4"># special case of a transformer returning 0-columns, e.g feature selector</span>
            <span class="s3">(</span>
                <span class="s5">&quot;D&quot;</span><span class="s3">,</span>
                <span class="s1">FunctionTransformer</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">_safe_indexing</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)),</span>
                <span class="s3">[</span><span class="s5">&quot;x1&quot;</span><span class="s3">, </span><span class="s5">&quot;x2&quot;</span><span class="s3">, </span><span class="s5">&quot;x3&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
        <span class="s3">],</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s1">dataframe_lib</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s5">&quot;Duplicated feature names found before concatenating the outputs of the &quot;</span>
        <span class="s5">&quot;transformers: ['x1', 'x2', 'x3'].</span><span class="s2">\n</span><span class="s5">&quot;</span>
        <span class="s5">&quot;Transformer A has conflicting columns names: ['x1', 'x2', 'x3'].</span><span class="s2">\n</span><span class="s5">&quot;</span>
        <span class="s5">&quot;Transformer B has conflicting columns names: ['x1', 'x2'].</span><span class="s2">\n</span><span class="s5">&quot;</span>
        <span class="s5">&quot;Transformer C has conflicting columns names: ['x1', 'x3'].</span><span class="s2">\n</span><span class="s5">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span>
    <span class="s1">parse_version</span><span class="s3">(</span><span class="s1">joblib</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &lt; </span><span class="s1">parse_version</span><span class="s3">(</span><span class="s5">&quot;1.3&quot;</span><span class="s3">),</span>
    <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;requires joblib &gt;= 1.3&quot;</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_auto_memmap</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that ColumnTransformer works in parallel with joblib's auto-memmapping. 
 
    non-regression test for issue #28781 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">).</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s1">transformers</span><span class="s3">=[(</span><span class="s5">&quot;scaler&quot;</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">])],</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">2</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">joblib</span><span class="s3">.</span><span class="s1">parallel_backend</span><span class="s3">(</span><span class="s5">&quot;loky&quot;</span><span class="s3">, </span><span class="s1">max_nbytes</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
        <span class="s1">Xt </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xt</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">]]))</span>


<span class="s4"># Metadata Routing Tests</span>
<span class="s4"># ======================</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_routing_passed_metadata_not_supported</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that the right error message is raised when metadata is passed while 
    not supported when `enable_metadata_routing=False`.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">trs </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">Trans</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])]).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
        <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;is only supported if enable_metadata_routing=True&quot;</span>
    <span class="s3">):</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)([[</span><span class="s6">1</span><span class="s3">]], </span><span class="s1">sample_weight</span><span class="s3">=[</span><span class="s6">1</span><span class="s3">], </span><span class="s1">prop</span><span class="s3">=</span><span class="s5">&quot;a&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_metadata_routing_for_column_transformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that metadata is routed correctly for column transformer.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">registry </span><span class="s3">= </span><span class="s1">_Registry</span><span class="s3">()</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;a&quot;</span>
    <span class="s1">trs </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;trans&quot;</span><span class="s3">,</span>
                <span class="s1">ConsumingTransformer</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">registry</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s3">[</span><span class="s6">0</span><span class="s3">],</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;transform&quot;</span><span class="s3">:</span>
        <span class="s1">trs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">trs</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">_trs </span><span class="s2">in </span><span class="s1">registry</span><span class="s3">:</span>
        <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
            <span class="s1">obj</span><span class="s3">=</span><span class="s1">_trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_metadata_routing_no_fit_transform</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test metadata routing when the sub-estimator doesn't implement 
    ``fit_transform``.&quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">NoFitTransform</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">sample_weight</span>
            <span class="s2">assert </span><span class="s1">metadata</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">sample_weight</span>
            <span class="s2">assert </span><span class="s1">metadata</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;a&quot;</span>
    <span class="s1">trs </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;trans&quot;</span><span class="s3">,</span>
                <span class="s1">NoFitTransform</span><span class="s3">()</span>
                <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s3">[</span><span class="s6">0</span><span class="s3">],</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">trs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>
    <span class="s1">trs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s3">, </span><span class="s5">&quot;fit&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_metadata_routing_error_for_column_transformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that the right error is raised when metadata is not requested.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;a&quot;</span>
    <span class="s1">trs </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">ConsumingTransformer</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>

    <span class="s1">error_message </span><span class="s3">= (</span>
        <span class="s5">&quot;[sample_weight, metadata] are passed but are not explicitly set as requested&quot;</span>
        <span class="s5">f&quot; or not requested for ConsumingTransformer.</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s5">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">error_message</span><span class="s3">)):</span>
        <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;transform&quot;</span><span class="s3">:</span>
            <span class="s1">trs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">trs</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_get_metadata_routing_works_without_fit</span><span class="s3">():</span>
    <span class="s4"># Regression test for https://github.com/scikit-learn/scikit-learn/issues/28186</span>
    <span class="s4"># Make sure ct.get_metadata_routing() works w/o having called fit.</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">([(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">ConsumingTransformer</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])])</span>
    <span class="s1">ct</span><span class="s3">.</span><span class="s1">get_metadata_routing</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_remainder_request_always_present</span><span class="s3">():</span>
    <span class="s4"># Test that remainder request is always present.</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s5">&quot;trans&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">(), [</span><span class="s6">0</span><span class="s3">])],</span>
        <span class="s1">remainder</span><span class="s3">=</span><span class="s1">ConsumingTransformer</span><span class="s3">()</span>
        <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s1">router </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_metadata_routing</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">router</span><span class="s3">.</span><span class="s1">consumes</span><span class="s3">(</span><span class="s5">&quot;fit&quot;</span><span class="s3">, [</span><span class="s5">&quot;metadata&quot;</span><span class="s3">]) == </span><span class="s1">set</span><span class="s3">([</span><span class="s5">&quot;metadata&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s5">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_unused_transformer_request_present</span><span class="s3">():</span>
    <span class="s4"># Test that the request of a transformer is always present even when not</span>
    <span class="s4"># used due to no selected columns.</span>
    <span class="s1">ct </span><span class="s3">= </span><span class="s1">ColumnTransformer</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s5">&quot;trans&quot;</span><span class="s3">,</span>
                <span class="s1">ConsumingTransformer</span><span class="s3">()</span>
                <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s2">lambda </span><span class="s1">X</span><span class="s3">: [],</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">router </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">get_metadata_routing</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">router</span><span class="s3">.</span><span class="s1">consumes</span><span class="s3">(</span><span class="s5">&quot;fit&quot;</span><span class="s3">, [</span><span class="s5">&quot;metadata&quot;</span><span class="s3">]) == </span><span class="s1">set</span><span class="s3">([</span><span class="s5">&quot;metadata&quot;</span><span class="s3">])</span>


<span class="s4"># End of Metadata Routing Tests</span>
<span class="s4"># =============================</span>
</pre>
</body>
</html>