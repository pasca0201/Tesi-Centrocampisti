<html>
<head>
<title>hb.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
hb.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Implementation of Harwell-Boeing read/write. 
 
At the moment not the full Harwell-Boeing format is supported. Supported 
features are: 
 
    - assembled, non-symmetric, real matrices 
    - integer for pointer/indices 
    - exponential format for float values, and int format 
 
&quot;&quot;&quot;</span>
<span class="s2"># TODO:</span>
<span class="s2">#   - Add more support (symmetric/complex matrices, non-assembled matrices ?)</span>

<span class="s2"># XXX: reading is reasonably efficient (&gt;= 85 % is in numpy.fromstring), but</span>
<span class="s2"># takes a lot of memory. Being faster would require compiled code.</span>
<span class="s2"># write is not efficient. Although not a terribly exciting task,</span>
<span class="s2"># having reusable facilities to efficiently read/write fortran-formatted files</span>
<span class="s2"># would be useful outside this module.</span>

<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">scipy</span><span class="s4">.</span><span class="s1">sparse </span><span class="s3">import </span><span class="s1">csc_matrix</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_fortran_format_parser </span><span class="s3">import </span><span class="s1">FortranFormatParser</span><span class="s4">, </span><span class="s1">IntFormat</span><span class="s4">, </span><span class="s1">ExpFormat</span>

<span class="s1">__all__ </span><span class="s4">= [</span><span class="s5">&quot;hb_read&quot;</span><span class="s4">, </span><span class="s5">&quot;hb_write&quot;</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">MalformedHeader</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">LineOverflow</span><span class="s4">(</span><span class="s1">Warning</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">def </span><span class="s1">_nbytes_full</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">, </span><span class="s1">nlines</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Return the number of bytes to read to get every full lines for the 
    given parsed fortran format.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat </span><span class="s4">* </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">width </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">) * (</span><span class="s1">nlines </span><span class="s4">- </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">HBInfo</span><span class="s4">:</span>
    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">from_data</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">title</span><span class="s4">=</span><span class="s5">&quot;Default title&quot;</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s5">&quot;0&quot;</span><span class="s4">, </span><span class="s1">mxtype</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Create a HBInfo instance from an existing sparse matrix. 
 
        Parameters 
        ---------- 
        m : sparse matrix 
            the HBInfo instance will derive its parameters from m 
        title : str 
            Title to put in the HB header 
        key : str 
            Key 
        mxtype : HBMatrixType 
            type of the input matrix 
        fmt : dict 
            not implemented 
 
        Returns 
        ------- 
        hb_info : HBInfo instance 
        &quot;&quot;&quot;</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">tocsc</span><span class="s4">(</span><span class="s1">copy</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

        <span class="s1">pointer </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">indptr</span>
        <span class="s1">indices </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">indices</span>
        <span class="s1">values </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">data</span>

        <span class="s1">nrows</span><span class="s4">, </span><span class="s1">ncols </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">shape</span>
        <span class="s1">nnon_zeros </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">nnz</span>

        <span class="s3">if </span><span class="s1">fmt </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s2"># +1 because HB use one-based indexing (Fortran), and we will write</span>
            <span class="s2"># the indices /pointer as such</span>
            <span class="s1">pointer_fmt </span><span class="s4">= </span><span class="s1">IntFormat</span><span class="s4">.</span><span class="s1">from_number</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">pointer</span><span class="s4">+</span><span class="s6">1</span><span class="s4">))</span>
            <span class="s1">indices_fmt </span><span class="s4">= </span><span class="s1">IntFormat</span><span class="s4">.</span><span class="s1">from_number</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">indices</span><span class="s4">+</span><span class="s6">1</span><span class="s4">))</span>

            <span class="s3">if </span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">kind </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">typecodes</span><span class="s4">[</span><span class="s5">&quot;AllFloat&quot;</span><span class="s4">]:</span>
                <span class="s1">values_fmt </span><span class="s4">= </span><span class="s1">ExpFormat</span><span class="s4">.</span><span class="s1">from_number</span><span class="s4">(-</span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">values</span><span class="s4">)))</span>
            <span class="s3">elif </span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">kind </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">typecodes</span><span class="s4">[</span><span class="s5">&quot;AllInteger&quot;</span><span class="s4">]:</span>
                <span class="s1">values_fmt </span><span class="s4">= </span><span class="s1">IntFormat</span><span class="s4">.</span><span class="s1">from_number</span><span class="s4">(-</span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">values</span><span class="s4">)))</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">message </span><span class="s4">= </span><span class="s5">f&quot;type </span><span class="s3">{</span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">kind</span><span class="s3">} </span><span class="s5">not implemented yet&quot;</span>
                <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s1">message</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s5">&quot;fmt argument not supported yet.&quot;</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">mxtype </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">np</span><span class="s4">.</span><span class="s1">isrealobj</span><span class="s4">(</span><span class="s1">values</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Complex values not supported yet&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">kind </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">typecodes</span><span class="s4">[</span><span class="s5">&quot;AllInteger&quot;</span><span class="s4">]:</span>
                <span class="s1">tp </span><span class="s4">= </span><span class="s5">&quot;integer&quot;</span>
            <span class="s3">elif </span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">.</span><span class="s1">kind </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">typecodes</span><span class="s4">[</span><span class="s5">&quot;AllFloat&quot;</span><span class="s4">]:</span>
                <span class="s1">tp </span><span class="s4">= </span><span class="s5">&quot;real&quot;</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s5">&quot;type %s for values not implemented&quot;</span>
                                          <span class="s4">% </span><span class="s1">values</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
            <span class="s1">mxtype </span><span class="s4">= </span><span class="s1">HBMatrixType</span><span class="s4">(</span><span class="s1">tp</span><span class="s4">, </span><span class="s5">&quot;unsymmetric&quot;</span><span class="s4">, </span><span class="s5">&quot;assembled&quot;</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;mxtype argument not handled yet.&quot;</span><span class="s4">)</span>

        <span class="s3">def </span><span class="s1">_nlines</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">, </span><span class="s1">size</span><span class="s4">):</span>
            <span class="s1">nlines </span><span class="s4">= </span><span class="s1">size </span><span class="s4">// </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat</span>
            <span class="s3">if </span><span class="s1">nlines </span><span class="s4">* </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat </span><span class="s4">!= </span><span class="s1">size</span><span class="s4">:</span>
                <span class="s1">nlines </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">return </span><span class="s1">nlines</span>

        <span class="s1">pointer_nlines </span><span class="s4">= </span><span class="s1">_nlines</span><span class="s4">(</span><span class="s1">pointer_fmt</span><span class="s4">, </span><span class="s1">pointer</span><span class="s4">.</span><span class="s1">size</span><span class="s4">)</span>
        <span class="s1">indices_nlines </span><span class="s4">= </span><span class="s1">_nlines</span><span class="s4">(</span><span class="s1">indices_fmt</span><span class="s4">, </span><span class="s1">indices</span><span class="s4">.</span><span class="s1">size</span><span class="s4">)</span>
        <span class="s1">values_nlines </span><span class="s4">= </span><span class="s1">_nlines</span><span class="s4">(</span><span class="s1">values_fmt</span><span class="s4">, </span><span class="s1">values</span><span class="s4">.</span><span class="s1">size</span><span class="s4">)</span>

        <span class="s1">total_nlines </span><span class="s4">= </span><span class="s1">pointer_nlines </span><span class="s4">+ </span><span class="s1">indices_nlines </span><span class="s4">+ </span><span class="s1">values_nlines</span>

        <span class="s3">return </span><span class="s1">cls</span><span class="s4">(</span><span class="s1">title</span><span class="s4">, </span><span class="s1">key</span><span class="s4">,</span>
            <span class="s1">total_nlines</span><span class="s4">, </span><span class="s1">pointer_nlines</span><span class="s4">, </span><span class="s1">indices_nlines</span><span class="s4">, </span><span class="s1">values_nlines</span><span class="s4">,</span>
            <span class="s1">mxtype</span><span class="s4">, </span><span class="s1">nrows</span><span class="s4">, </span><span class="s1">ncols</span><span class="s4">, </span><span class="s1">nnon_zeros</span><span class="s4">,</span>
            <span class="s1">pointer_fmt</span><span class="s4">.</span><span class="s1">fortran_format</span><span class="s4">, </span><span class="s1">indices_fmt</span><span class="s4">.</span><span class="s1">fortran_format</span><span class="s4">,</span>
            <span class="s1">values_fmt</span><span class="s4">.</span><span class="s1">fortran_format</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">from_file</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">fid</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Create a HBInfo instance from a file object containing a matrix in the 
        HB format. 
 
        Parameters 
        ---------- 
        fid : file-like matrix 
            File or file-like object containing a matrix in the HB format. 
 
        Returns 
        ------- 
        hb_info : HBInfo instance 
        &quot;&quot;&quot;</span>
        <span class="s2"># First line</span>
        <span class="s1">line </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">().</span><span class="s1">strip</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) &gt; </span><span class="s6">72</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected at least 72 characters for first line, &quot;</span>
                             <span class="s5">&quot;got: </span><span class="s3">\n</span><span class="s5">%s&quot; </span><span class="s4">% </span><span class="s1">line</span><span class="s4">)</span>
        <span class="s1">title </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">72</span><span class="s4">]</span>
        <span class="s1">key </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">72</span><span class="s4">:]</span>

        <span class="s2"># Second line</span>
        <span class="s1">line </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">().</span><span class="s1">strip</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">()) &gt;= </span><span class="s6">56</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected at least 56 characters for second line, &quot;</span>
                             <span class="s5">&quot;got: </span><span class="s3">\n</span><span class="s5">%s&quot; </span><span class="s4">% </span><span class="s1">line</span><span class="s4">)</span>
        <span class="s1">total_nlines </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[:</span><span class="s6">14</span><span class="s4">])</span>
        <span class="s1">pointer_nlines </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">14</span><span class="s4">:</span><span class="s6">28</span><span class="s4">])</span>
        <span class="s1">indices_nlines </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">28</span><span class="s4">:</span><span class="s6">42</span><span class="s4">])</span>
        <span class="s1">values_nlines </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">42</span><span class="s4">:</span><span class="s6">56</span><span class="s4">])</span>

        <span class="s1">rhs_nlines </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">56</span><span class="s4">:</span><span class="s6">72</span><span class="s4">].</span><span class="s1">strip</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">rhs_nlines </span><span class="s4">== </span><span class="s5">''</span><span class="s4">:</span>
            <span class="s1">rhs_nlines </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">rhs_nlines </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">rhs_nlines</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">rhs_nlines </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Only files without right hand side supported for &quot;</span>
                             <span class="s5">&quot;now.&quot;</span><span class="s4">)</span>

        <span class="s2"># Third line</span>
        <span class="s1">line </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">().</span><span class="s1">strip</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) &gt;= </span><span class="s6">70</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected at least 72 character for third line, got:</span><span class="s3">\n</span><span class="s5">&quot;</span>
                             <span class="s5">&quot;%s&quot; </span><span class="s4">% </span><span class="s1">line</span><span class="s4">)</span>

        <span class="s1">mxtype_s </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">].</span><span class="s1">upper</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mxtype_s</span><span class="s4">) == </span><span class="s6">3</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;mxtype expected to be 3 characters long&quot;</span><span class="s4">)</span>

        <span class="s1">mxtype </span><span class="s4">= </span><span class="s1">HBMatrixType</span><span class="s4">.</span><span class="s1">from_fortran</span><span class="s4">(</span><span class="s1">mxtype_s</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">value_type </span><span class="s3">not in </span><span class="s4">[</span><span class="s5">&quot;real&quot;</span><span class="s4">, </span><span class="s5">&quot;integer&quot;</span><span class="s4">]:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Only real or integer matrices supported for &quot;</span>
                             <span class="s5">&quot;now (detected %s)&quot; </span><span class="s4">% </span><span class="s1">mxtype</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">structure </span><span class="s4">== </span><span class="s5">&quot;unsymmetric&quot;</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Only unsymmetric matrices supported for &quot;</span>
                             <span class="s5">&quot;now (detected %s)&quot; </span><span class="s4">% </span><span class="s1">mxtype</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">storage </span><span class="s4">== </span><span class="s5">&quot;assembled&quot;</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Only assembled matrices supported for now&quot;</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">line</span><span class="s4">[</span><span class="s6">3</span><span class="s4">:</span><span class="s6">14</span><span class="s4">] == </span><span class="s5">&quot; &quot; </span><span class="s4">* </span><span class="s6">11</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Malformed data for third line: %s&quot; </span><span class="s4">% </span><span class="s1">line</span><span class="s4">)</span>

        <span class="s1">nrows </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">14</span><span class="s4">:</span><span class="s6">28</span><span class="s4">])</span>
        <span class="s1">ncols </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">28</span><span class="s4">:</span><span class="s6">42</span><span class="s4">])</span>
        <span class="s1">nnon_zeros </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">42</span><span class="s4">:</span><span class="s6">56</span><span class="s4">])</span>
        <span class="s1">nelementals </span><span class="s4">= </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">56</span><span class="s4">:</span><span class="s6">70</span><span class="s4">])</span>
        <span class="s3">if not </span><span class="s1">nelementals </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Unexpected value %d for nltvl (last entry of line 3)&quot;</span>
                             <span class="s4">% </span><span class="s1">nelementals</span><span class="s4">)</span>

        <span class="s2"># Fourth line</span>
        <span class="s1">line </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">().</span><span class="s1">strip</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>

        <span class="s1">ct </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">split</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">ct</span><span class="s4">) == </span><span class="s6">3</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected 3 formats, got %s&quot; </span><span class="s4">% </span><span class="s1">ct</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">cls</span><span class="s4">(</span><span class="s1">title</span><span class="s4">, </span><span class="s1">key</span><span class="s4">,</span>
                   <span class="s1">total_nlines</span><span class="s4">, </span><span class="s1">pointer_nlines</span><span class="s4">, </span><span class="s1">indices_nlines</span><span class="s4">, </span><span class="s1">values_nlines</span><span class="s4">,</span>
                   <span class="s1">mxtype</span><span class="s4">, </span><span class="s1">nrows</span><span class="s4">, </span><span class="s1">ncols</span><span class="s4">, </span><span class="s1">nnon_zeros</span><span class="s4">,</span>
                   <span class="s1">ct</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">ct</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">ct</span><span class="s4">[</span><span class="s6">2</span><span class="s4">],</span>
                   <span class="s1">rhs_nlines</span><span class="s4">, </span><span class="s1">nelementals</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">title</span><span class="s4">, </span><span class="s1">key</span><span class="s4">,</span>
            <span class="s1">total_nlines</span><span class="s4">, </span><span class="s1">pointer_nlines</span><span class="s4">, </span><span class="s1">indices_nlines</span><span class="s4">, </span><span class="s1">values_nlines</span><span class="s4">,</span>
            <span class="s1">mxtype</span><span class="s4">, </span><span class="s1">nrows</span><span class="s4">, </span><span class="s1">ncols</span><span class="s4">, </span><span class="s1">nnon_zeros</span><span class="s4">,</span>
            <span class="s1">pointer_format_str</span><span class="s4">, </span><span class="s1">indices_format_str</span><span class="s4">, </span><span class="s1">values_format_str</span><span class="s4">,</span>
            <span class="s1">right_hand_sides_nlines</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">nelementals</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Do not use this directly, but the class ctrs (from_* functions).&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">title </span><span class="s4">= </span><span class="s1">title</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">key </span><span class="s4">= </span><span class="s1">key</span>
        <span class="s3">if </span><span class="s1">title </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">title </span><span class="s4">= </span><span class="s5">&quot;No Title&quot;</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">title</span><span class="s4">) &gt; </span><span class="s6">72</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;title cannot be &gt; 72 characters&quot;</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">key </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s5">&quot;|No Key&quot;</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">key</span><span class="s4">) &gt; </span><span class="s6">8</span><span class="s4">:</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span><span class="s5">&quot;key is &gt; 8 characters (key is %s)&quot; </span><span class="s4">% </span><span class="s1">key</span><span class="s4">,</span>
                          <span class="s1">LineOverflow</span><span class="s4">, </span><span class="s1">stacklevel</span><span class="s4">=</span><span class="s6">3</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">total_nlines </span><span class="s4">= </span><span class="s1">total_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_nlines </span><span class="s4">= </span><span class="s1">pointer_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_nlines </span><span class="s4">= </span><span class="s1">indices_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">values_nlines </span><span class="s4">= </span><span class="s1">values_nlines</span>

        <span class="s1">parser </span><span class="s4">= </span><span class="s1">FortranFormatParser</span><span class="s4">()</span>
        <span class="s1">pointer_format </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">(</span><span class="s1">pointer_format_str</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">pointer_format</span><span class="s4">, </span><span class="s1">IntFormat</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected int format for pointer format, got %s&quot;</span>
                             <span class="s4">% </span><span class="s1">pointer_format</span><span class="s4">)</span>

        <span class="s1">indices_format </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">(</span><span class="s1">indices_format_str</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">indices_format</span><span class="s4">, </span><span class="s1">IntFormat</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Expected int format for indices format, got %s&quot; </span><span class="s4">%</span>
                             <span class="s1">indices_format</span><span class="s4">)</span>

        <span class="s1">values_format </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">(</span><span class="s1">values_format_str</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">values_format</span><span class="s4">, </span><span class="s1">ExpFormat</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">value_type </span><span class="s3">not in </span><span class="s4">[</span><span class="s5">&quot;real&quot;</span><span class="s4">, </span><span class="s5">&quot;complex&quot;</span><span class="s4">]:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;Inconsistency between matrix type </span><span class="s3">{</span><span class="s1">mxtype</span><span class="s3">} </span><span class="s5">and &quot;</span>
                                 <span class="s5">f&quot;value type </span><span class="s3">{</span><span class="s1">values_format</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s1">values_dtype </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">values_format</span><span class="s4">, </span><span class="s1">IntFormat</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">value_type </span><span class="s3">not in </span><span class="s4">[</span><span class="s5">&quot;integer&quot;</span><span class="s4">]:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;Inconsistency between matrix type </span><span class="s3">{</span><span class="s1">mxtype</span><span class="s3">} </span><span class="s5">and &quot;</span>
                                 <span class="s5">f&quot;value type </span><span class="s3">{</span><span class="s1">values_format</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s2"># XXX: fortran int -&gt; dtype association ?</span>
            <span class="s1">values_dtype </span><span class="s4">= </span><span class="s1">int</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;Unsupported format for values </span><span class="s3">{</span><span class="s1">values_format</span><span class="s3">!r}</span><span class="s5">&quot;</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_format </span><span class="s4">= </span><span class="s1">pointer_format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_format </span><span class="s4">= </span><span class="s1">indices_format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">values_format </span><span class="s4">= </span><span class="s1">values_format</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_dtype </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_dtype </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">values_dtype </span><span class="s4">= </span><span class="s1">values_dtype</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_nlines </span><span class="s4">= </span><span class="s1">pointer_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_nbytes_full </span><span class="s4">= </span><span class="s1">_nbytes_full</span><span class="s4">(</span><span class="s1">pointer_format</span><span class="s4">, </span><span class="s1">pointer_nlines</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_nlines </span><span class="s4">= </span><span class="s1">indices_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_nbytes_full </span><span class="s4">= </span><span class="s1">_nbytes_full</span><span class="s4">(</span><span class="s1">indices_format</span><span class="s4">, </span><span class="s1">indices_nlines</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">values_nlines </span><span class="s4">= </span><span class="s1">values_nlines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">values_nbytes_full </span><span class="s4">= </span><span class="s1">_nbytes_full</span><span class="s4">(</span><span class="s1">values_format</span><span class="s4">, </span><span class="s1">values_nlines</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">nrows </span><span class="s4">= </span><span class="s1">nrows</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ncols </span><span class="s4">= </span><span class="s1">ncols</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nnon_zeros </span><span class="s4">= </span><span class="s1">nnon_zeros</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nelementals </span><span class="s4">= </span><span class="s1">nelementals</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mxtype </span><span class="s4">= </span><span class="s1">mxtype</span>

    <span class="s3">def </span><span class="s1">dump</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Gives the header corresponding to this instance as a string.&quot;&quot;&quot;</span>
        <span class="s1">header </span><span class="s4">= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">title</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">72</span><span class="s4">) + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">key</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">8</span><span class="s4">)]</span>

        <span class="s1">header</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s5">&quot;%14d%14d%14d%14d&quot; </span><span class="s4">%</span>
                      <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">total_nlines</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_nlines</span><span class="s4">,</span>
                       <span class="s1">self</span><span class="s4">.</span><span class="s1">indices_nlines</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">values_nlines</span><span class="s4">))</span>
        <span class="s1">header</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s5">&quot;%14s%14d%14d%14d%14d&quot; </span><span class="s4">%</span>
                      <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">fortran_format</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">14</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nrows</span><span class="s4">,</span>
                       <span class="s1">self</span><span class="s4">.</span><span class="s1">ncols</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nnon_zeros</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>

        <span class="s1">pffmt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pointer_format</span><span class="s4">.</span><span class="s1">fortran_format</span>
        <span class="s1">iffmt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indices_format</span><span class="s4">.</span><span class="s1">fortran_format</span>
        <span class="s1">vffmt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">values_format</span><span class="s4">.</span><span class="s1">fortran_format</span>
        <span class="s1">header</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s5">&quot;%16s%16s%20s&quot; </span><span class="s4">%</span>
                      <span class="s4">(</span><span class="s1">pffmt</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">16</span><span class="s4">), </span><span class="s1">iffmt</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">16</span><span class="s4">), </span><span class="s1">vffmt</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">20</span><span class="s4">)))</span>
        <span class="s3">return </span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">header</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_expect_int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">msg</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">ValueError </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">msg </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;Expected an int, got %s&quot;</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s1">msg </span><span class="s4">% </span><span class="s1">value</span><span class="s4">) </span><span class="s3">from </span><span class="s1">e</span>


<span class="s3">def </span><span class="s1">_read_hb_data</span><span class="s4">(</span><span class="s1">content</span><span class="s4">, </span><span class="s1">header</span><span class="s4">):</span>
    <span class="s2"># XXX: look at a way to reduce memory here (big string creation)</span>
    <span class="s1">ptr_string </span><span class="s4">= </span><span class="s5">&quot;&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">([</span><span class="s1">content</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">header</span><span class="s4">.</span><span class="s1">pointer_nbytes_full</span><span class="s4">),</span>
                           <span class="s1">content</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">()])</span>
    <span class="s1">ptr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">fromstring</span><span class="s4">(</span><span class="s1">ptr_string</span><span class="s4">,</span>
            <span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">sep</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>

    <span class="s1">ind_string </span><span class="s4">= </span><span class="s5">&quot;&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">([</span><span class="s1">content</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">header</span><span class="s4">.</span><span class="s1">indices_nbytes_full</span><span class="s4">),</span>
                       <span class="s1">content</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">()])</span>
    <span class="s1">ind </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">fromstring</span><span class="s4">(</span><span class="s1">ind_string</span><span class="s4">,</span>
            <span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">, </span><span class="s1">sep</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>

    <span class="s1">val_string </span><span class="s4">= </span><span class="s5">&quot;&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">([</span><span class="s1">content</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">header</span><span class="s4">.</span><span class="s1">values_nbytes_full</span><span class="s4">),</span>
                          <span class="s1">content</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">()])</span>
    <span class="s1">val </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">fromstring</span><span class="s4">(</span><span class="s1">val_string</span><span class="s4">,</span>
            <span class="s1">dtype</span><span class="s4">=</span><span class="s1">header</span><span class="s4">.</span><span class="s1">values_dtype</span><span class="s4">, </span><span class="s1">sep</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>

    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">csc_matrix</span><span class="s4">((</span><span class="s1">val</span><span class="s4">, </span><span class="s1">ind</span><span class="s4">-</span><span class="s6">1</span><span class="s4">, </span><span class="s1">ptr</span><span class="s4">-</span><span class="s6">1</span><span class="s4">),</span>
                          <span class="s1">shape</span><span class="s4">=(</span><span class="s1">header</span><span class="s4">.</span><span class="s1">nrows</span><span class="s4">, </span><span class="s1">header</span><span class="s4">.</span><span class="s1">ncols</span><span class="s4">))</span>
    <span class="s3">except </span><span class="s1">ValueError </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">e</span>


<span class="s3">def </span><span class="s1">_write_data</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">fid</span><span class="s4">, </span><span class="s1">header</span><span class="s4">):</span>
    <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">tocsc</span><span class="s4">(</span><span class="s1">copy</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">write_array</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">ar</span><span class="s4">, </span><span class="s1">nlines</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">):</span>
        <span class="s2"># ar_nlines is the number of full lines, n is the number of items per</span>
        <span class="s2"># line, ffmt the fortran format</span>
        <span class="s1">pyfmt </span><span class="s4">= </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">python_format</span>
        <span class="s1">pyfmt_full </span><span class="s4">= </span><span class="s1">pyfmt </span><span class="s4">* </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat</span>

        <span class="s2"># for each array to write, we first write the full lines, and special</span>
        <span class="s2"># case for partial line</span>
        <span class="s1">full </span><span class="s4">= </span><span class="s1">ar</span><span class="s4">[:(</span><span class="s1">nlines </span><span class="s4">- </span><span class="s6">1</span><span class="s4">) * </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">full</span><span class="s4">.</span><span class="s1">reshape</span><span class="s4">((</span><span class="s1">nlines</span><span class="s4">-</span><span class="s6">1</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">repeat</span><span class="s4">)):</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">pyfmt_full </span><span class="s4">% </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">row</span><span class="s4">) + </span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s1">nremain </span><span class="s4">= </span><span class="s1">ar</span><span class="s4">.</span><span class="s1">size </span><span class="s4">- </span><span class="s1">full</span><span class="s4">.</span><span class="s1">size</span>
        <span class="s3">if </span><span class="s1">nremain </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">((</span><span class="s1">pyfmt </span><span class="s4">* </span><span class="s1">nremain</span><span class="s4">) % </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">ar</span><span class="s4">[</span><span class="s1">ar</span><span class="s4">.</span><span class="s1">size </span><span class="s4">- </span><span class="s1">nremain</span><span class="s4">:]) + </span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>

    <span class="s1">fid</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">header</span><span class="s4">.</span><span class="s1">dump</span><span class="s4">())</span>
    <span class="s1">fid</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
    <span class="s2"># +1 is for Fortran one-based indexing</span>
    <span class="s1">write_array</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">indptr</span><span class="s4">+</span><span class="s6">1</span><span class="s4">, </span><span class="s1">header</span><span class="s4">.</span><span class="s1">pointer_nlines</span><span class="s4">,</span>
                <span class="s1">header</span><span class="s4">.</span><span class="s1">pointer_format</span><span class="s4">)</span>
    <span class="s1">write_array</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">indices</span><span class="s4">+</span><span class="s6">1</span><span class="s4">, </span><span class="s1">header</span><span class="s4">.</span><span class="s1">indices_nlines</span><span class="s4">,</span>
                <span class="s1">header</span><span class="s4">.</span><span class="s1">indices_format</span><span class="s4">)</span>
    <span class="s1">write_array</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">, </span><span class="s1">m</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">header</span><span class="s4">.</span><span class="s1">values_nlines</span><span class="s4">,</span>
                <span class="s1">header</span><span class="s4">.</span><span class="s1">values_format</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">HBMatrixType</span><span class="s4">:</span>
    <span class="s0">&quot;&quot;&quot;Class to hold the matrix type.&quot;&quot;&quot;</span>
    <span class="s2"># q2f* translates qualified names to Fortran character</span>
    <span class="s1">_q2f_type </span><span class="s4">= {</span>
        <span class="s5">&quot;real&quot;</span><span class="s4">: </span><span class="s5">&quot;R&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;complex&quot;</span><span class="s4">: </span><span class="s5">&quot;C&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;pattern&quot;</span><span class="s4">: </span><span class="s5">&quot;P&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;integer&quot;</span><span class="s4">: </span><span class="s5">&quot;I&quot;</span><span class="s4">,</span>
    <span class="s4">}</span>
    <span class="s1">_q2f_structure </span><span class="s4">= {</span>
            <span class="s5">&quot;symmetric&quot;</span><span class="s4">: </span><span class="s5">&quot;S&quot;</span><span class="s4">,</span>
            <span class="s5">&quot;unsymmetric&quot;</span><span class="s4">: </span><span class="s5">&quot;U&quot;</span><span class="s4">,</span>
            <span class="s5">&quot;hermitian&quot;</span><span class="s4">: </span><span class="s5">&quot;H&quot;</span><span class="s4">,</span>
            <span class="s5">&quot;skewsymmetric&quot;</span><span class="s4">: </span><span class="s5">&quot;Z&quot;</span><span class="s4">,</span>
            <span class="s5">&quot;rectangular&quot;</span><span class="s4">: </span><span class="s5">&quot;R&quot;</span>
    <span class="s4">}</span>
    <span class="s1">_q2f_storage </span><span class="s4">= {</span>
        <span class="s5">&quot;assembled&quot;</span><span class="s4">: </span><span class="s5">&quot;A&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;elemental&quot;</span><span class="s4">: </span><span class="s5">&quot;E&quot;</span><span class="s4">,</span>
    <span class="s4">}</span>

    <span class="s1">_f2q_type </span><span class="s4">= {</span><span class="s1">j</span><span class="s4">: </span><span class="s1">i </span><span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">j </span><span class="s3">in </span><span class="s1">_q2f_type</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()}</span>
    <span class="s1">_f2q_structure </span><span class="s4">= {</span><span class="s1">j</span><span class="s4">: </span><span class="s1">i </span><span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">j </span><span class="s3">in </span><span class="s1">_q2f_structure</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()}</span>
    <span class="s1">_f2q_storage </span><span class="s4">= {</span><span class="s1">j</span><span class="s4">: </span><span class="s1">i </span><span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">j </span><span class="s3">in </span><span class="s1">_q2f_storage</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()}</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">from_fortran</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">) == </span><span class="s6">3</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Fortran format for matrix type should be 3 &quot;</span>
                             <span class="s5">&quot;characters long&quot;</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">value_type </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">_f2q_type</span><span class="s4">[</span><span class="s1">fmt</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]]</span>
            <span class="s1">structure </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">_f2q_structure</span><span class="s4">[</span><span class="s1">fmt</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]]</span>
            <span class="s1">storage </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">_f2q_storage</span><span class="s4">[</span><span class="s1">fmt</span><span class="s4">[</span><span class="s6">2</span><span class="s4">]]</span>
            <span class="s3">return </span><span class="s1">cls</span><span class="s4">(</span><span class="s1">value_type</span><span class="s4">, </span><span class="s1">structure</span><span class="s4">, </span><span class="s1">storage</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyError </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Unrecognized format %s&quot; </span><span class="s4">% </span><span class="s1">fmt</span><span class="s4">) </span><span class="s3">from </span><span class="s1">e</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value_type</span><span class="s4">, </span><span class="s1">structure</span><span class="s4">, </span><span class="s1">storage</span><span class="s4">=</span><span class="s5">&quot;assembled&quot;</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">value_type </span><span class="s4">= </span><span class="s1">value_type</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">structure </span><span class="s4">= </span><span class="s1">structure</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">storage </span><span class="s4">= </span><span class="s1">storage</span>

        <span class="s3">if </span><span class="s1">value_type </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_type</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Unrecognized type %s&quot; </span><span class="s4">% </span><span class="s1">value_type</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">structure </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_structure</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Unrecognized structure %s&quot; </span><span class="s4">% </span><span class="s1">structure</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">storage </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_storage</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Unrecognized storage %s&quot; </span><span class="s4">% </span><span class="s1">storage</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">fortran_format</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_type</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">value_type</span><span class="s4">] + </span><span class="s1">\</span>
               <span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_structure</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">structure</span><span class="s4">] + </span><span class="s1">\</span>
               <span class="s1">self</span><span class="s4">.</span><span class="s1">_q2f_storage</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">storage</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">f&quot;HBMatrixType(</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">value_type</span><span class="s3">}</span><span class="s5">, </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">structure</span><span class="s3">}</span><span class="s5">, </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">storage</span><span class="s3">}</span><span class="s5">)&quot;</span>


<span class="s3">class </span><span class="s1">HBFile</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">file</span><span class="s4">, </span><span class="s1">hb_info</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Create a HBFile instance. 
 
        Parameters 
        ---------- 
        file : file-object 
            StringIO work as well 
        hb_info : HBInfo, optional 
            Should be given as an argument for writing, in which case the file 
            should be writable. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_fid </span><span class="s4">= </span><span class="s1">file</span>
        <span class="s3">if </span><span class="s1">hb_info </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info </span><span class="s4">= </span><span class="s1">HBInfo</span><span class="s4">.</span><span class="s1">from_file</span><span class="s4">(</span><span class="s1">file</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s2">#raise OSError(&quot;file %s is not writable, and hb_info &quot;</span>
            <span class="s2">#              &quot;was given.&quot; % file)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info </span><span class="s4">= </span><span class="s1">hb_info</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">title</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">.</span><span class="s1">title</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">.</span><span class="s1">key</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">.</span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">value_type</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">structure</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">.</span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">structure</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">storage</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">.</span><span class="s1">mxtype</span><span class="s4">.</span><span class="s1">storage</span>

    <span class="s3">def </span><span class="s1">read_matrix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_read_hb_data</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fid</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">write_matrix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">m</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_write_data</span><span class="s4">(</span><span class="s1">m</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fid</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hb_info</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">hb_read</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Read HB-format file. 
 
    Parameters 
    ---------- 
    path_or_open_file : path-like or file-like 
        If a file-like object, it is used as-is. Otherwise, it is opened 
        before reading. 
 
    Returns 
    ------- 
    data : scipy.sparse.csc_matrix instance 
        The data read from the HB file as a sparse matrix. 
 
    Notes 
    ----- 
    At the moment not the full Harwell-Boeing format is supported. Supported 
    features are: 
 
        - assembled, non-symmetric, real matrices 
        - integer for pointer/indices 
        - exponential format for float values, and int format 
 
    Examples 
    -------- 
    We can read and write a harwell-boeing format file: 
 
    &gt;&gt;&gt; from scipy.io import hb_read, hb_write 
    &gt;&gt;&gt; from scipy.sparse import csr_array, eye 
    &gt;&gt;&gt; data = csr_array(eye(3))  # create a sparse array 
    &gt;&gt;&gt; hb_write(&quot;data.hb&quot;, data)  # write a hb file 
    &gt;&gt;&gt; print(hb_read(&quot;data.hb&quot;))  # read a hb file 
    &lt;Compressed Sparse Column sparse matrix of dtype 'float64' 
        with 3 stored elements and shape (3, 3)&gt; 
        Coords  Values 
        (0, 0)  1.0 
        (1, 1)  1.0 
        (2, 2)  1.0 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_get_matrix</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">):</span>
        <span class="s1">hb </span><span class="s4">= </span><span class="s1">HBFile</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">hb</span><span class="s4">.</span><span class="s1">read_matrix</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">, </span><span class="s5">'read'</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_get_matrix</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">_get_matrix</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">hb_write</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">, </span><span class="s1">m</span><span class="s4">, </span><span class="s1">hb_info</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Write HB-format file. 
 
    Parameters 
    ---------- 
    path_or_open_file : path-like or file-like 
        If a file-like object, it is used as-is. Otherwise, it is opened 
        before writing. 
    m : sparse-matrix 
        the sparse matrix to write 
    hb_info : HBInfo 
        contains the meta-data for write 
 
    Returns 
    ------- 
    None 
 
    Notes 
    ----- 
    At the moment not the full Harwell-Boeing format is supported. Supported 
    features are: 
 
        - assembled, non-symmetric, real matrices 
        - integer for pointer/indices 
        - exponential format for float values, and int format 
 
    Examples 
    -------- 
    We can read and write a harwell-boeing format file: 
 
    &gt;&gt;&gt; from scipy.io import hb_read, hb_write 
    &gt;&gt;&gt; from scipy.sparse import csr_array, eye 
    &gt;&gt;&gt; data = csr_array(eye(3))  # create a sparse array 
    &gt;&gt;&gt; hb_write(&quot;data.hb&quot;, data)  # write a hb file 
    &gt;&gt;&gt; print(hb_read(&quot;data.hb&quot;))  # read a hb file 
    &lt;Compressed Sparse Column sparse matrix of dtype 'float64' 
        with 3 stored elements and shape (3, 3)&gt; 
        Coords  Values 
        (0, 0)  1.0 
        (1, 1)  1.0 
        (2, 2)  1.0 
    &quot;&quot;&quot;</span>
    <span class="s1">m </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">tocsc</span><span class="s4">(</span><span class="s1">copy</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">hb_info </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">hb_info </span><span class="s4">= </span><span class="s1">HBInfo</span><span class="s4">.</span><span class="s1">from_data</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_set_matrix</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">):</span>
        <span class="s1">hb </span><span class="s4">= </span><span class="s1">HBFile</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">, </span><span class="s1">hb_info</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">hb</span><span class="s4">.</span><span class="s1">write_matrix</span><span class="s4">(</span><span class="s1">m</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">, </span><span class="s5">'write'</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_set_matrix</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">path_or_open_file</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">_set_matrix</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
</pre>
</body>
</html>