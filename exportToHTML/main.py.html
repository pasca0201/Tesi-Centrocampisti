<html>
<head>
<title>main.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Bounds</span><span class="s2">,</span>
    <span class="s1">LinearConstraint</span><span class="s2">,</span>
    <span class="s1">NonlinearConstraint</span><span class="s2">,</span>
    <span class="s1">OptimizeResult</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">framework </span><span class="s0">import </span><span class="s1">TrustRegion</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">problem </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ObjectiveFunction</span><span class="s2">,</span>
    <span class="s1">BoundConstraints</span><span class="s2">,</span>
    <span class="s1">LinearConstraints</span><span class="s2">,</span>
    <span class="s1">NonlinearConstraints</span><span class="s2">,</span>
    <span class="s1">Problem</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">MaxEvalError</span><span class="s2">,</span>
    <span class="s1">TargetSuccess</span><span class="s2">,</span>
    <span class="s1">CallbackSuccess</span><span class="s2">,</span>
    <span class="s1">FeasibleSuccess</span><span class="s2">,</span>
    <span class="s1">exact_1d_array</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">settings </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ExitStatus</span><span class="s2">,</span>
    <span class="s1">Options</span><span class="s2">,</span>
    <span class="s1">Constants</span><span class="s2">,</span>
    <span class="s1">DEFAULT_OPTIONS</span><span class="s2">,</span>
    <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">,</span>
    <span class="s1">PRINT_OPTIONS</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">minimize</span><span class="s2">(</span>
    <span class="s1">fun</span><span class="s2">,</span>
    <span class="s1">x0</span><span class="s2">,</span>
    <span class="s1">args</span><span class="s2">=(),</span>
    <span class="s1">bounds</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">constraints</span><span class="s2">=(),</span>
    <span class="s1">callback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">options</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s3">r&quot;&quot;&quot; 
    Minimize a scalar function using the COBYQA method. 
 
    The Constrained Optimization BY Quadratic Approximations (COBYQA) method is 
    a derivative-free optimization method designed to solve general nonlinear 
    optimization problems. A complete description of COBYQA is given in [3]_. 
 
    Parameters 
    ---------- 
    fun : {callable, None} 
        Objective function to be minimized. 
 
            ``fun(x, *args) -&gt; float`` 
 
        where ``x`` is an array with shape (n,) and `args` is a tuple. If `fun` 
        is ``None``, the objective function is assumed to be the zero function, 
        resulting in a feasibility problem. 
    x0 : array_like, shape (n,) 
        Initial guess. 
    args : tuple, optional 
        Extra arguments passed to the objective function. 
    bounds : {`scipy.optimize.Bounds`, array_like, shape (n, 2)}, optional 
        Bound constraints of the problem. It can be one of the cases below. 
 
        #. An instance of `scipy.optimize.Bounds`. For the time being, the 
           argument ``keep_feasible`` is disregarded, and all the constraints 
           are considered unrelaxable and will be enforced. 
        #. An array with shape (n, 2). The bound constraints for ``x[i]`` are 
           ``bounds[i][0] &lt;= x[i] &lt;= bounds[i][1]``. Set ``bounds[i][0]`` to 
           :math:`-\infty` if there is no lower bound, and set ``bounds[i][1]`` 
           to :math:`\infty` if there is no upper bound. 
 
        The COBYQA method always respect the bound constraints. 
    constraints : {Constraint, list}, optional 
        General constraints of the problem. It can be one of the cases below. 
 
        #. An instance of `scipy.optimize.LinearConstraint`. The argument 
           ``keep_feasible`` is disregarded. 
        #. An instance of `scipy.optimize.NonlinearConstraint`. The arguments 
           ``jac``, ``hess``, ``keep_feasible``, ``finite_diff_rel_step``, and 
           ``finite_diff_jac_sparsity`` are disregarded. 
 
        #. A list, each of whose elements are described in the cases above. 
 
    callback : callable, optional 
        A callback executed at each objective function evaluation. The method 
        terminates if a ``StopIteration`` exception is raised by the callback 
        function. Its signature can be one of the following: 
 
            ``callback(intermediate_result)`` 
 
        where ``intermediate_result`` is a keyword parameter that contains an 
        instance of `scipy.optimize.OptimizeResult`, with attributes ``x`` 
        and ``fun``, being the point at which the objective function is 
        evaluated and the value of the objective function, respectively. The 
        name of the parameter must be ``intermediate_result`` for the callback 
        to be passed an instance of `scipy.optimize.OptimizeResult`. 
 
        Alternatively, the callback function can have the signature: 
 
            ``callback(xk)`` 
 
        where ``xk`` is the point at which the objective function is evaluated. 
        Introspection is used to determine which of the signatures to invoke. 
    options : dict, optional 
        Options passed to the solver. Accepted keys are: 
 
            disp : bool, optional 
                Whether to print information about the optimization procedure. 
            maxfev : int, optional 
                Maximum number of function evaluations. 
            maxiter : int, optional 
                Maximum number of iterations. 
            target : float, optional 
                Target on the objective function value. The optimization 
                procedure is terminated when the objective function value of a 
                feasible point is less than or equal to this target. 
            feasibility_tol : float, optional 
                Tolerance on the constraint violation. If the maximum 
                constraint violation at a point is less than or equal to this 
                tolerance, the point is considered feasible. 
            radius_init : float, optional 
                Initial trust-region radius. Typically, this value should be in 
                the order of one tenth of the greatest expected change to `x0`. 
            radius_final : float, optional 
                Final trust-region radius. It should indicate the accuracy 
                required in the final values of the variables. 
            nb_points : int, optional 
                Number of interpolation points used to build the quadratic 
                models of the objective and constraint functions. 
            scale : bool, optional 
                Whether to scale the variables according to the bounds. 
            filter_size : int, optional 
                Maximum number of points in the filter. The filter is used to 
                select the best point returned by the optimization procedure. 
            store_history : bool, optional 
                Whether to store the history of the function evaluations. 
            history_size : int, optional 
                Maximum number of function evaluations to store in the history. 
            debug : bool, optional 
                Whether to perform additional checks during the optimization 
                procedure. This option should be used only for debugging 
                purposes and is highly discouraged to general users. 
 
        Other constants (from the keyword arguments) are described below. They 
        are not intended to be changed by general users. They should only be 
        changed by users with a deep understanding of the algorithm, who want 
        to experiment with different settings. 
 
    Returns 
    ------- 
    `scipy.optimize.OptimizeResult` 
        Result of the optimization procedure, with the following fields: 
 
            message : str 
                Description of the cause of the termination. 
            success : bool 
                Whether the optimization procedure terminated successfully. 
            status : int 
                Termination status of the optimization procedure. 
            x : `numpy.ndarray`, shape (n,) 
                Solution point. 
            fun : float 
                Objective function value at the solution point. 
            maxcv : float 
                Maximum constraint violation at the solution point. 
            nfev : int 
                Number of function evaluations. 
            nit : int 
                Number of iterations. 
 
        If ``store_history`` is True, the result also has the following fields: 
 
            fun_history : `numpy.ndarray`, shape (nfev,) 
                History of the objective function values. 
            maxcv_history : `numpy.ndarray`, shape (nfev,) 
                History of the maximum constraint violations. 
 
        A description of the termination statuses is given below. 
 
        .. list-table:: 
            :widths: 25 75 
            :header-rows: 1 
 
            * - Exit status 
              - Description 
            * - 0 
              - The lower bound for the trust-region radius has been reached. 
            * - 1 
              - The target objective function value has been reached. 
            * - 2 
              - All variables are fixed by the bound constraints. 
            * - 3 
              - The callback requested to stop the optimization procedure. 
            * - 4 
              - The feasibility problem received has been solved successfully. 
            * - 5 
              - The maximum number of function evaluations has been exceeded. 
            * - 6 
              - The maximum number of iterations has been exceeded. 
            * - -1 
              - The bound constraints are infeasible. 
            * - -2 
              - A linear algebra error occurred. 
 
    Other Parameters 
    ---------------- 
    decrease_radius_factor : float, optional 
        Factor by which the trust-region radius is reduced when the reduction 
        ratio is low or negative. 
    increase_radius_factor : float, optional 
        Factor by which the trust-region radius is increased when the reduction 
        ratio is large. 
    increase_radius_threshold : float, optional 
        Threshold that controls the increase of the trust-region radius when 
        the reduction ratio is large. 
    decrease_radius_threshold : float, optional 
        Threshold used to determine whether the trust-region radius should be 
        reduced to the resolution. 
    decrease_resolution_factor : float, optional 
        Factor by which the resolution is reduced when the current value is far 
        from its final value. 
    large_resolution_threshold : float, optional 
        Threshold used to determine whether the resolution is far from its 
        final value. 
    moderate_resolution_threshold : float, optional 
        Threshold used to determine whether the resolution is close to its 
        final value. 
    low_ratio : float, optional 
        Threshold used to determine whether the reduction ratio is low. 
    high_ratio : float, optional 
        Threshold used to determine whether the reduction ratio is high. 
    very_low_ratio : float, optional 
        Threshold used to determine whether the reduction ratio is very low. 
        This is used to determine whether the models should be reset. 
    penalty_increase_threshold : float, optional 
        Threshold used to determine whether the penalty parameter should be 
        increased. 
    penalty_increase_factor : float, optional 
        Factor by which the penalty parameter is increased. 
    short_step_threshold : float, optional 
        Factor used to determine whether the trial step is too short. 
    low_radius_factor : float, optional 
        Factor used to determine which interpolation point should be removed 
        from the interpolation set at each iteration. 
    byrd_omojokun_factor : float, optional 
        Factor by which the trust-region radius is reduced for the computations 
        of the normal step in the Byrd-Omojokun composite-step approach. 
    threshold_ratio_constraints : float, optional 
        Threshold used to determine which constraints should be taken into 
        account when decreasing the penalty parameter. 
    large_shift_factor : float, optional 
        Factor used to determine whether the point around which the quadratic 
        models are built should be updated. 
    large_gradient_factor : float, optional 
        Factor used to determine whether the models should be reset. 
    resolution_factor : float, optional 
        Factor by which the resolution is decreased. 
    improve_tcg : bool, optional 
        Whether to improve the steps computed by the truncated conjugate 
        gradient method when the trust-region boundary is reached. 
 
    References 
    ---------- 
    .. [1] J. Nocedal and S. J. Wright. *Numerical Optimization*. Springer Ser. 
       Oper. Res. Financ. Eng. Springer, New York, NY, USA, second edition, 
       2006. `doi:10.1007/978-0-387-40065-5 
       &lt;https://doi.org/10.1007/978-0-387-40065-5&gt;`_. 
    .. [2] M. J. D. Powell. A direct search optimization method that models the 
       objective and constraint functions by linear interpolation. In S. Gomez 
       and J.-P. Hennart, editors, *Advances in Optimization and Numerical 
       Analysis*, volume 275 of Math. Appl., pages 51--67. Springer, Dordrecht, 
       Netherlands, 1994. `doi:10.1007/978-94-015-8330-5_4 
       &lt;https://doi.org/10.1007/978-94-015-8330-5_4&gt;`_. 
    .. [3] T. M. Ragonneau. *Model-Based Derivative-Free Optimization Methods 
       and Software*. PhD thesis, Department of Applied Mathematics, The Hong 
       Kong Polytechnic University, Hong Kong, China, 2022. URL: 
       https://theses.lib.polyu.edu.hk/handle/200/12294. 
 
    Examples 
    -------- 
    To demonstrate how to use `minimize`, we first minimize the Rosenbrock 
    function implemented in `scipy.optimize` in an unconstrained setting. 
 
    .. testsetup:: 
 
        import numpy as np 
        np.set_printoptions(precision=3, suppress=True) 
 
    &gt;&gt;&gt; from cobyqa import minimize 
    &gt;&gt;&gt; from scipy.optimize import rosen 
 
    To solve the problem using COBYQA, run: 
 
    &gt;&gt;&gt; x0 = [1.3, 0.7, 0.8, 1.9, 1.2] 
    &gt;&gt;&gt; res = minimize(rosen, x0) 
    &gt;&gt;&gt; res.x 
    array([1., 1., 1., 1., 1.]) 
 
    To see how bound and constraints are handled using `minimize`, we solve 
    Example 16.4 of [1]_, defined as 
 
    .. math:: 
 
        \begin{aligned} 
            \min_{x \in \mathbb{R}^2}   &amp; \quad (x_1 - 1)^2 + (x_2 - 2.5)^2\\ 
            \text{s.t.}                 &amp; \quad -x_1 + 2x_2 \le 2,\\ 
                                        &amp; \quad x_1 + 2x_2 \le 6,\\ 
                                        &amp; \quad x_1 - 2x_2 \le 2,\\ 
                                        &amp; \quad x_1 \ge 0,\\ 
                                        &amp; \quad x_2 \ge 0. 
        \end{aligned} 
 
    &gt;&gt;&gt; import numpy as np 
    &gt;&gt;&gt; from scipy.optimize import Bounds, LinearConstraint 
 
    Its objective function can be implemented as: 
 
    &gt;&gt;&gt; def fun(x): 
    ...     return (x[0] - 1.0)**2 + (x[1] - 2.5)**2 
 
    This problem can be solved using `minimize` as: 
 
    &gt;&gt;&gt; x0 = [2.0, 0.0] 
    &gt;&gt;&gt; bounds = Bounds([0.0, 0.0], np.inf) 
    &gt;&gt;&gt; constraints = LinearConstraint([ 
    ...     [-1.0, 2.0], 
    ...     [1.0, 2.0], 
    ...     [1.0, -2.0], 
    ... ], -np.inf, [2.0, 6.0, 2.0]) 
    &gt;&gt;&gt; res = minimize(fun, x0, bounds=bounds, constraints=constraints) 
    &gt;&gt;&gt; res.x 
    array([1.4, 1.7]) 
 
    To see how nonlinear constraints are handled, we solve Problem (F) of [2]_, 
    defined as 
 
    .. math:: 
 
        \begin{aligned} 
            \min_{x \in \mathbb{R}^2}   &amp; \quad -x_1 - x_2\\ 
            \text{s.t.}                 &amp; \quad x_1^2 - x_2 \le 0,\\ 
                                        &amp; \quad x_1^2 + x_2^2 \le 1. 
        \end{aligned} 
 
    &gt;&gt;&gt; from scipy.optimize import NonlinearConstraint 
 
    Its objective and constraint functions can be implemented as: 
 
    &gt;&gt;&gt; def fun(x): 
    ...     return -x[0] - x[1] 
    &gt;&gt;&gt; 
    &gt;&gt;&gt; def cub(x): 
    ...     return [x[0]**2 - x[1], x[0]**2 + x[1]**2] 
 
    This problem can be solved using `minimize` as: 
 
    &gt;&gt;&gt; x0 = [1.0, 1.0] 
    &gt;&gt;&gt; constraints = NonlinearConstraint(cub, -np.inf, [0.0, 1.0]) 
    &gt;&gt;&gt; res = minimize(fun, x0, constraints=constraints) 
    &gt;&gt;&gt; res.x 
    array([0.707, 0.707]) 
 
    Finally, to see how to supply linear and nonlinear constraints 
    simultaneously, we solve Problem (G) of [2]_, defined as 
 
    .. math:: 
 
        \begin{aligned} 
            \min_{x \in \mathbb{R}^3}   &amp; \quad x_3\\ 
            \text{s.t.}                 &amp; \quad 5x_1 - x_2 + x_3 \ge 0,\\ 
                                        &amp; \quad -5x_1 - x_2 + x_3 \ge 0,\\ 
                                        &amp; \quad x_1^2 + x_2^2 + 4x_2 \le x_3. 
        \end{aligned} 
 
    Its objective and nonlinear constraint functions can be implemented as: 
 
    &gt;&gt;&gt; def fun(x): 
    ...     return x[2] 
    &gt;&gt;&gt; 
    &gt;&gt;&gt; def cub(x): 
    ...     return x[0]**2 + x[1]**2 + 4.0*x[1] - x[2] 
 
    This problem can be solved using `minimize` as: 
 
    &gt;&gt;&gt; x0 = [1.0, 1.0, 1.0] 
    &gt;&gt;&gt; constraints = [ 
    ...     LinearConstraint( 
    ...         [[5.0, -1.0, 1.0], [-5.0, -1.0, 1.0]], 
    ...         [0.0, 0.0], 
    ...         np.inf, 
    ...     ), 
    ...     NonlinearConstraint(cub, -np.inf, 0.0), 
    ... ] 
    &gt;&gt;&gt; res = minimize(fun, x0, constraints=constraints) 
    &gt;&gt;&gt; res.x 
    array([ 0., -3., -3.]) 
    &quot;&quot;&quot;</span>
    <span class="s4"># Get basic options that are needed for the initialization.</span>
    <span class="s0">if </span><span class="s1">options </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">options </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">options </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">options</span><span class="s2">)</span>
    <span class="s1">verbose </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">])</span>
    <span class="s1">verbose </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">verbose</span><span class="s2">)</span>
    <span class="s1">feasibility_tol </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">feasibility_tol </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">feasibility_tol</span><span class="s2">)</span>
    <span class="s1">scale </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">])</span>
    <span class="s1">scale </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">)</span>
    <span class="s1">store_history </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">store_history </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">store_history</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">] &lt;= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The size of the history must be positive.&quot;</span><span class="s2">)</span>
    <span class="s1">history_size </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">history_size </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">history_size</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">] &lt;= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The size of the filter must be positive.&quot;</span><span class="s2">)</span>
    <span class="s1">filter_size </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">filter_size </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">filter_size</span><span class="s2">)</span>
    <span class="s1">debug </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">])</span>
    <span class="s1">debug </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">debug</span><span class="s2">)</span>

    <span class="s4"># Initialize the objective function.</span>
    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">,)</span>
    <span class="s1">obj </span><span class="s2">= </span><span class="s1">ObjectiveFunction</span><span class="s2">(</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">)</span>

    <span class="s4"># Initialize the bound constraints.</span>
    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s6">&quot;__len__&quot;</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [</span><span class="s1">x0</span><span class="s2">]</span>
    <span class="s1">n_orig </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">)</span>
    <span class="s1">bounds </span><span class="s2">= </span><span class="s1">BoundConstraints</span><span class="s2">(</span><span class="s1">_get_bounds</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">, </span><span class="s1">n_orig</span><span class="s2">))</span>

    <span class="s4"># Initialize the constraints.</span>
    <span class="s1">linear_constraints</span><span class="s2">, </span><span class="s1">nonlinear_constraints </span><span class="s2">= </span><span class="s1">_get_constraints</span><span class="s2">(</span><span class="s1">constraints</span><span class="s2">)</span>
    <span class="s1">linear </span><span class="s2">= </span><span class="s1">LinearConstraints</span><span class="s2">(</span><span class="s1">linear_constraints</span><span class="s2">, </span><span class="s1">n_orig</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">)</span>
    <span class="s1">nonlinear </span><span class="s2">= </span><span class="s1">NonlinearConstraints</span><span class="s2">(</span><span class="s1">nonlinear_constraints</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">, </span><span class="s1">debug</span><span class="s2">)</span>

    <span class="s4"># Initialize the problem (and remove the fixed variables).</span>
    <span class="s1">pb </span><span class="s2">= </span><span class="s1">Problem</span><span class="s2">(</span>
        <span class="s1">obj</span><span class="s2">,</span>
        <span class="s1">x0</span><span class="s2">,</span>
        <span class="s1">bounds</span><span class="s2">,</span>
        <span class="s1">linear</span><span class="s2">,</span>
        <span class="s1">nonlinear</span><span class="s2">,</span>
        <span class="s1">callback</span><span class="s2">,</span>
        <span class="s1">feasibility_tol</span><span class="s2">,</span>
        <span class="s1">scale</span><span class="s2">,</span>
        <span class="s1">store_history</span><span class="s2">,</span>
        <span class="s1">history_size</span><span class="s2">,</span>
        <span class="s1">filter_size</span><span class="s2">,</span>
        <span class="s1">debug</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s4"># Set the default options.</span>
    <span class="s1">_set_default_options</span><span class="s2">(</span><span class="s1">options</span><span class="s2">, </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">constants </span><span class="s2">= </span><span class="s1">_set_default_constants</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s4"># Initialize the models and skip the computations whenever possible.</span>
    <span class="s0">if not </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">bounds</span><span class="s2">.</span><span class="s1">is_feasible</span><span class="s2">:</span>
        <span class="s4"># The bound constraints are infeasible.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">INFEASIBLE_ERROR</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">n </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s4"># All variables are fixed by the bound constraints.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">True</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FIXED_SUCCESS</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">verbose</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;Starting the optimization procedure.&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Initial trust-region radius: </span><span class="s0">{</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">]</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Final trust-region radius: </span><span class="s0">{</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">]</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span>
            <span class="s6">f&quot;Maximum number of function evaluations: &quot;</span>
            <span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">]</span><span class="s0">}</span><span class="s6">.&quot;</span>
        <span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Maximum number of iterations: </span><span class="s0">{</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">]</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">()</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">framework </span><span class="s2">= </span><span class="s1">TrustRegion</span><span class="s2">(</span><span class="s1">pb</span><span class="s2">, </span><span class="s1">options</span><span class="s2">, </span><span class="s1">constants</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TargetSuccess</span><span class="s2">:</span>
        <span class="s4"># The target on the objective function value has been reached</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">True</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">CallbackSuccess</span><span class="s2">:</span>
        <span class="s4"># The callback raised a StopIteration exception.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">True</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">CALLBACK_SUCCESS</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">FeasibleSuccess</span><span class="s2">:</span>
        <span class="s4"># The feasibility problem has been solved successfully.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">True</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">MaxEvalError</span><span class="s2">:</span>
        <span class="s4"># The maximum number of function evaluations has been exceeded.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_ITER_WARNING</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
        <span class="s4"># The construction of the initial interpolation set failed.</span>
        <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s5">0.0</span><span class="s2">,</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span><span class="s2">,</span>
            <span class="s5">0</span><span class="s2">,</span>
            <span class="s1">options</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s4"># Start the optimization procedure.</span>
    <span class="s1">success </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">n_iter </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">k_new </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">n_short_steps </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">n_very_short_steps </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">n_alt_models </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">while True</span><span class="s2">:</span>
        <span class="s4"># Stop the optimization procedure if the maximum number of iterations</span>
        <span class="s4"># has been exceeded. We do not write the main loop as a for loop</span>
        <span class="s4"># because we want to access the number of iterations outside the loop.</span>
        <span class="s0">if </span><span class="s1">n_iter </span><span class="s2">&gt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">]:</span>
            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_ITER_WARNING</span>
            <span class="s0">break</span>
        <span class="s1">n_iter </span><span class="s2">+= </span><span class="s5">1</span>

        <span class="s4"># Update the point around which the quadratic models are built.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span>
                <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">- </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">interpolation</span><span class="s2">.</span><span class="s1">x_base</span>
            <span class="s2">)</span>
            <span class="s2">&gt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">] * </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">radius</span>
        <span class="s2">):</span>
            <span class="s1">framework</span><span class="s2">.</span><span class="s1">shift_x_base</span><span class="s2">(</span><span class="s1">options</span><span class="s2">)</span>

        <span class="s4"># Evaluate the trial step.</span>
        <span class="s1">radius_save </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">radius</span>
        <span class="s1">normal_step</span><span class="s2">, </span><span class="s1">tangential_step </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_trust_region_step</span><span class="s2">(</span><span class="s1">options</span><span class="s2">)</span>
        <span class="s1">step </span><span class="s2">= </span><span class="s1">normal_step </span><span class="s2">+ </span><span class="s1">tangential_step</span>
        <span class="s1">s_norm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>

        <span class="s4"># If the trial step is too short, we do not attempt to evaluate the</span>
        <span class="s4"># objective and constraint functions. Instead, we reduce the</span>
        <span class="s4"># trust-region radius and check whether the resolution should be</span>
        <span class="s4"># enhanced and whether the geometry of the interpolation set should be</span>
        <span class="s4"># improved. Otherwise, we entertain a classical iteration. The</span>
        <span class="s4"># criterion for performing an exceptional jump is taken from NEWUOA.</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">s_norm</span>
            <span class="s2">&lt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">] * </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span>
        <span class="s2">):</span>
            <span class="s1">framework</span><span class="s2">.</span><span class="s1">radius </span><span class="s2">*= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">radius_save </span><span class="s2">&gt; </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">:</span>
                <span class="s1">n_short_steps </span><span class="s2">= </span><span class="s5">0</span>
                <span class="s1">n_very_short_steps </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">n_short_steps </span><span class="s2">+= </span><span class="s5">1</span>
                <span class="s1">n_very_short_steps </span><span class="s2">+= </span><span class="s5">1</span>
                <span class="s0">if </span><span class="s1">s_norm </span><span class="s2">&gt; </span><span class="s5">0.1 </span><span class="s2">* </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">:</span>
                    <span class="s1">n_very_short_steps </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">enhance_resolution </span><span class="s2">= </span><span class="s1">n_short_steps </span><span class="s2">&gt;= </span><span class="s5">5 </span><span class="s0">or </span><span class="s1">n_very_short_steps </span><span class="s2">&gt;= </span><span class="s5">3</span>
            <span class="s0">if </span><span class="s1">enhance_resolution</span><span class="s2">:</span>
                <span class="s1">n_short_steps </span><span class="s2">= </span><span class="s5">0</span>
                <span class="s1">n_very_short_steps </span><span class="s2">= </span><span class="s5">0</span>
                <span class="s1">improve_geometry </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">k_new</span><span class="s2">, </span><span class="s1">dist_new </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_index_to_remove</span><span class="s2">()</span>
                <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                    <span class="s0">break</span>
                <span class="s1">improve_geometry </span><span class="s2">= </span><span class="s1">dist_new </span><span class="s2">&gt; </span><span class="s1">max</span><span class="s2">(</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">radius</span><span class="s2">,</span>
                    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">]</span>
                    <span class="s2">* </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">,</span>
                <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Increase the penalty parameter if necessary.</span>
            <span class="s1">same_best_point </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">increase_penalty</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">same_best_point</span><span class="s2">:</span>
                <span class="s4"># Evaluate the objective and constraint functions.</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val </span><span class="s2">= </span><span class="s1">_eval</span><span class="s2">(</span>
                        <span class="s1">pb</span><span class="s2">,</span>
                        <span class="s1">framework</span><span class="s2">,</span>
                        <span class="s1">step</span><span class="s2">,</span>
                        <span class="s1">options</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s0">except </span><span class="s1">TargetSuccess</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span>
                    <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s0">break</span>
                <span class="s0">except </span><span class="s1">FeasibleSuccess</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span>
                    <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s0">break</span>
                <span class="s0">except </span><span class="s1">CallbackSuccess</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">CALLBACK_SUCCESS</span>
                    <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s0">break</span>
                <span class="s0">except </span><span class="s1">MaxEvalError</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_EVAL_WARNING</span>
                    <span class="s0">break</span>

                <span class="s4"># Perform a second-order correction step if necessary.</span>
                <span class="s1">merit_old </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">merit</span><span class="s2">(</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best</span><span class="s2">,</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">fun_best</span><span class="s2">,</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">cub_best</span><span class="s2">,</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">ceq_best</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">merit_new </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">merit</span><span class="s2">(</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">, </span><span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val</span>
                <span class="s2">)</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">pb</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s6">&quot;nonlinearly constrained&quot;</span>
                    <span class="s0">and </span><span class="s1">merit_new </span><span class="s2">&gt; </span><span class="s1">merit_old</span>
                    <span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">normal_step</span><span class="s2">)</span>
                    <span class="s2">&gt; </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">] ** </span><span class="s5">2.0</span>
                    <span class="s2">* </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">radius</span>
                <span class="s2">):</span>
                    <span class="s1">soc_step </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_second_order_correction_step</span><span class="s2">(</span>
                        <span class="s1">step</span><span class="s2">, </span><span class="s1">options</span>
                    <span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">soc_step</span><span class="s2">) &gt; </span><span class="s5">0.0</span><span class="s2">:</span>
                        <span class="s1">step </span><span class="s2">+= </span><span class="s1">soc_step</span>

                        <span class="s4"># Evaluate the objective and constraint functions.</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val </span><span class="s2">= </span><span class="s1">_eval</span><span class="s2">(</span>
                                <span class="s1">pb</span><span class="s2">,</span>
                                <span class="s1">framework</span><span class="s2">,</span>
                                <span class="s1">step</span><span class="s2">,</span>
                                <span class="s1">options</span><span class="s2">,</span>
                            <span class="s2">)</span>
                        <span class="s0">except </span><span class="s1">TargetSuccess</span><span class="s2">:</span>
                            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span>
                            <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                            <span class="s0">break</span>
                        <span class="s0">except </span><span class="s1">FeasibleSuccess</span><span class="s2">:</span>
                            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span>
                            <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                            <span class="s0">break</span>
                        <span class="s0">except </span><span class="s1">CallbackSuccess</span><span class="s2">:</span>
                            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">CALLBACK_SUCCESS</span>
                            <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                            <span class="s0">break</span>
                        <span class="s0">except </span><span class="s1">MaxEvalError</span><span class="s2">:</span>
                            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_EVAL_WARNING</span>
                            <span class="s0">break</span>

                <span class="s4"># Calculate the reduction ratio.</span>
                <span class="s1">ratio </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_reduction_ratio</span><span class="s2">(</span>
                    <span class="s1">step</span><span class="s2">,</span>
                    <span class="s1">fun_val</span><span class="s2">,</span>
                    <span class="s1">cub_val</span><span class="s2">,</span>
                    <span class="s1">ceq_val</span><span class="s2">,</span>
                <span class="s2">)</span>

                <span class="s4"># Choose an interpolation point to remove.</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">k_new </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_index_to_remove</span><span class="s2">(</span>
                        <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span>
                    <span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                    <span class="s0">break</span>

                <span class="s4"># Update the interpolation set.</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">ill_conditioned </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">update_interpolation</span><span class="s2">(</span>
                        <span class="s1">k_new</span><span class="s2">, </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">, </span><span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">,</span>
                        <span class="s1">ceq_val</span>
                    <span class="s2">)</span>
                <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                    <span class="s0">break</span>
                <span class="s1">framework</span><span class="s2">.</span><span class="s1">set_best_index</span><span class="s2">()</span>

                <span class="s4"># Update the trust-region radius.</span>
                <span class="s1">framework</span><span class="s2">.</span><span class="s1">update_radius</span><span class="s2">(</span><span class="s1">step</span><span class="s2">, </span><span class="s1">ratio</span><span class="s2">)</span>

                <span class="s4"># Attempt to replace the models by the alternative ones.</span>
                <span class="s0">if </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">radius </span><span class="s2">&lt;= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">ratio </span><span class="s2">&gt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">]:</span>
                        <span class="s1">n_alt_models </span><span class="s2">= </span><span class="s5">0</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">n_alt_models </span><span class="s2">+= </span><span class="s5">1</span>
                        <span class="s1">grad </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">fun_grad</span><span class="s2">(</span><span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best</span><span class="s2">)</span>
                        <span class="s0">try</span><span class="s2">:</span>
                            <span class="s1">grad_alt </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">fun_alt_grad</span><span class="s2">(</span>
                                <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best</span>
                            <span class="s2">)</span>
                        <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                            <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                            <span class="s0">break</span>
                        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">grad</span><span class="s2">) &lt; </span><span class="s1">constants</span><span class="s2">[</span>
                            <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span>
                        <span class="s2">] * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">grad_alt</span><span class="s2">):</span>
                            <span class="s1">n_alt_models </span><span class="s2">= </span><span class="s5">0</span>
                        <span class="s0">if </span><span class="s1">n_alt_models </span><span class="s2">&gt;= </span><span class="s5">3</span><span class="s2">:</span>
                            <span class="s0">try</span><span class="s2">:</span>
                                <span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">reset_models</span><span class="s2">()</span>
                            <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                                <span class="s0">break</span>
                            <span class="s1">n_alt_models </span><span class="s2">= </span><span class="s5">0</span>

                <span class="s4"># Update the Lagrange multipliers.</span>
                <span class="s1">framework</span><span class="s2">.</span><span class="s1">set_multipliers</span><span class="s2">(</span><span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">)</span>

                <span class="s4"># Check whether the resolution should be enhanced.</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">k_new</span><span class="s2">, </span><span class="s1">dist_new </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_index_to_remove</span><span class="s2">()</span>
                <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                    <span class="s0">break</span>
                <span class="s1">improve_geometry </span><span class="s2">= (</span>
                    <span class="s1">ill_conditioned</span>
                    <span class="s0">or </span><span class="s1">ratio </span><span class="s2">&lt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">]</span>
                    <span class="s0">and </span><span class="s1">dist_new</span>
                    <span class="s2">&gt; </span><span class="s1">max</span><span class="s2">(</span>
                        <span class="s1">framework</span><span class="s2">.</span><span class="s1">radius</span><span class="s2">,</span>
                        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">]</span>
                        <span class="s2">* </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s2">)</span>
                <span class="s1">enhance_resolution </span><span class="s2">= (</span>
                    <span class="s1">radius_save </span><span class="s2">&lt;= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span>
                    <span class="s0">and </span><span class="s1">ratio </span><span class="s2">&lt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">]</span>
                    <span class="s0">and not </span><span class="s1">improve_geometry</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># When increasing the penalty parameter, the best point so far</span>
                <span class="s4"># may change. In this case, we restart the iteration.</span>
                <span class="s1">enhance_resolution </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s1">improve_geometry </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s4"># Reduce the resolution if necessary.</span>
        <span class="s0">if </span><span class="s1">enhance_resolution</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">&lt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">]:</span>
                <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">RADIUS_SUCCESS</span>
                <span class="s0">break</span>
            <span class="s1">framework</span><span class="s2">.</span><span class="s1">enhance_resolution</span><span class="s2">(</span><span class="s1">options</span><span class="s2">)</span>
            <span class="s1">framework</span><span class="s2">.</span><span class="s1">decrease_penalty</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">verbose</span><span class="s2">:</span>
                <span class="s1">maxcv_val </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">maxcv</span><span class="s2">(</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best</span><span class="s2">, </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">cub_best</span><span class="s2">, </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">ceq_best</span>
                <span class="s2">)</span>
                <span class="s1">_print_step</span><span class="s2">(</span>
                    <span class="s6">f&quot;New trust-region radius: </span><span class="s0">{</span><span class="s1">framework</span><span class="s2">.</span><span class="s1">resolution</span><span class="s0">}</span><span class="s6">&quot;</span><span class="s2">,</span>
                    <span class="s1">pb</span><span class="s2">,</span>
                    <span class="s1">pb</span><span class="s2">.</span><span class="s1">build_x</span><span class="s2">(</span><span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best</span><span class="s2">),</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">fun_best</span><span class="s2">,</span>
                    <span class="s1">maxcv_val</span><span class="s2">,</span>
                    <span class="s1">pb</span><span class="s2">.</span><span class="s1">n_eval</span><span class="s2">,</span>
                    <span class="s1">n_iter</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">print</span><span class="s2">()</span>

        <span class="s4"># Improve the geometry of the interpolation set if necessary.</span>
        <span class="s0">if </span><span class="s1">improve_geometry</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">step </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">get_geometry_step</span><span class="s2">(</span><span class="s1">k_new</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                <span class="s0">break</span>

            <span class="s4"># Evaluate the objective and constraint functions.</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val </span><span class="s2">= </span><span class="s1">_eval</span><span class="s2">(</span><span class="s1">pb</span><span class="s2">, </span><span class="s1">framework</span><span class="s2">, </span><span class="s1">step</span><span class="s2">, </span><span class="s1">options</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">TargetSuccess</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span>
                <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">FeasibleSuccess</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span>
                <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">CallbackSuccess</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">CALLBACK_SUCCESS</span>
                <span class="s1">success </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">MaxEvalError</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_EVAL_WARNING</span>
                <span class="s0">break</span>

            <span class="s4"># Update the interpolation set.</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">framework</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">update_interpolation</span><span class="s2">(</span>
                    <span class="s1">k_new</span><span class="s2">,</span>
                    <span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span><span class="s2">,</span>
                    <span class="s1">fun_val</span><span class="s2">,</span>
                    <span class="s1">cub_val</span><span class="s2">,</span>
                    <span class="s1">ceq_val</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span>
                <span class="s0">break</span>
            <span class="s1">framework</span><span class="s2">.</span><span class="s1">set_best_index</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">_build_result</span><span class="s2">(</span>
        <span class="s1">pb</span><span class="s2">,</span>
        <span class="s1">framework</span><span class="s2">.</span><span class="s1">penalty</span><span class="s2">,</span>
        <span class="s1">success</span><span class="s2">,</span>
        <span class="s1">status</span><span class="s2">,</span>
        <span class="s1">n_iter</span><span class="s2">,</span>
        <span class="s1">options</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_bounds</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Uniformize the bounds. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">bounds </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">, </span><span class="s1">Bounds</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">bounds</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">!= (</span><span class="s1">n</span><span class="s2">,) </span><span class="s0">or </span><span class="s1">bounds</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">!= (</span><span class="s1">n</span><span class="s2">,):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">f&quot;The bounds must have </span><span class="s0">{</span><span class="s1">n</span><span class="s0">} </span><span class="s6">elements.&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bounds</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">, </span><span class="s6">&quot;__len__&quot;</span><span class="s2">):</span>
        <span class="s1">bounds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">bounds</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">!= (</span><span class="s1">n</span><span class="s2">, </span><span class="s5">2</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The shape of the bounds is not compatible with &quot;</span>
                <span class="s6">&quot;the number of variables.&quot;</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">bounds</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">bounds</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span>
            <span class="s6">&quot;The bounds must be an instance of &quot;</span>
            <span class="s6">&quot;scipy.optimize.Bounds or an array-like object.&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_constraints</span><span class="s2">(</span><span class="s1">constraints</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Extract the linear and nonlinear constraints. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">constraints</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">) </span><span class="s0">or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">constraints</span><span class="s2">, </span><span class="s6">&quot;__len__&quot;</span><span class="s2">):</span>
        <span class="s1">constraints </span><span class="s2">= (</span><span class="s1">constraints</span><span class="s2">,)</span>

    <span class="s4"># Extract the linear and nonlinear constraints.</span>
    <span class="s1">linear_constraints </span><span class="s2">= []</span>
    <span class="s1">nonlinear_constraints </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">constraint </span><span class="s0">in </span><span class="s1">constraints</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">, </span><span class="s1">LinearConstraint</span><span class="s2">):</span>
            <span class="s1">lb </span><span class="s2">= </span><span class="s1">exact_1d_array</span><span class="s2">(</span>
                <span class="s1">constraint</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">,</span>
                <span class="s6">&quot;The lower bound of the linear constraints must be a vector.&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">ub </span><span class="s2">= </span><span class="s1">exact_1d_array</span><span class="s2">(</span>
                <span class="s1">constraint</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">,</span>
                <span class="s6">&quot;The upper bound of the linear constraints must be a vector.&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">linear_constraints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s1">LinearConstraint</span><span class="s2">(</span>
                    <span class="s1">constraint</span><span class="s2">.</span><span class="s1">A</span><span class="s2">,</span>
                    <span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_arrays</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">),</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">, </span><span class="s1">NonlinearConstraint</span><span class="s2">):</span>
            <span class="s1">lb </span><span class="s2">= </span><span class="s1">exact_1d_array</span><span class="s2">(</span>
                <span class="s1">constraint</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">,</span>
                <span class="s6">&quot;The lower bound of the &quot;</span>
                <span class="s6">&quot;nonlinear constraints must be a &quot;</span>
                <span class="s6">&quot;vector.&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">ub </span><span class="s2">= </span><span class="s1">exact_1d_array</span><span class="s2">(</span>
                <span class="s1">constraint</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">,</span>
                <span class="s6">&quot;The upper bound of the &quot;</span>
                <span class="s6">&quot;nonlinear constraints must be a &quot;</span>
                <span class="s6">&quot;vector.&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">nonlinear_constraints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s1">NonlinearConstraint</span><span class="s2">(</span>
                    <span class="s1">constraint</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">,</span>
                    <span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_arrays</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">),</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s6">&quot;type&quot; </span><span class="s0">not in </span><span class="s1">constraint </span><span class="s0">or </span><span class="s1">constraint</span><span class="s2">[</span><span class="s6">&quot;type&quot;</span><span class="s2">] </span><span class="s0">not in </span><span class="s2">(</span>
                <span class="s6">&quot;eq&quot;</span><span class="s2">,</span>
                <span class="s6">&quot;ineq&quot;</span><span class="s2">,</span>
            <span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">'The constraint type must be &quot;eq&quot; or &quot;ineq&quot;.'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s6">&quot;fun&quot; </span><span class="s0">not in </span><span class="s1">constraint </span><span class="s0">or not </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">[</span><span class="s6">&quot;fun&quot;</span><span class="s2">]):</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The constraint function must be callable.&quot;</span><span class="s2">)</span>
            <span class="s1">nonlinear_constraints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s6">&quot;fun&quot;</span><span class="s2">: </span><span class="s1">constraint</span><span class="s2">[</span><span class="s6">&quot;fun&quot;</span><span class="s2">],</span>
                    <span class="s6">&quot;type&quot;</span><span class="s2">: </span><span class="s1">constraint</span><span class="s2">[</span><span class="s6">&quot;type&quot;</span><span class="s2">],</span>
                    <span class="s6">&quot;args&quot;</span><span class="s2">: </span><span class="s1">constraint</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s6">&quot;args&quot;</span><span class="s2">, ()),</span>
                <span class="s2">}</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span>
                <span class="s6">&quot;The constraints must be instances of &quot;</span>
                <span class="s6">&quot;scipy.optimize.LinearConstraint, &quot;</span>
                <span class="s6">&quot;scipy.optimize.NonlinearConstraint, or dict.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">linear_constraints</span><span class="s2">, </span><span class="s1">nonlinear_constraints</span>


<span class="s0">def </span><span class="s1">_set_default_options</span><span class="s2">(</span><span class="s1">options</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Set the default options. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">] &lt;= </span><span class="s5">0.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The initial trust-region radius must be positive.&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">] &lt; </span><span class="s5">0.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The final trust-region radius must be nonnegative.&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">] &lt; </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">]:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The initial trust-region radius must be greater &quot;</span>
                <span class="s6">&quot;than or equal to the final trust-region radius.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">],</span>
                <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">],</span>
                <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">]</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">]</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOBEG</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">RHOEND</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">] &lt;= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The number of interpolation points must be &quot;</span>
                         <span class="s6">&quot;positive.&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT </span><span class="s0">in </span><span class="s1">options</span>
        <span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">] &gt; ((</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">)) // </span><span class="s5">2</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">f&quot;The number of interpolation points must be at most &quot;</span>
            <span class="s6">f&quot;</span><span class="s0">{</span><span class="s2">((</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">)) // </span><span class="s5">2</span><span class="s0">}</span><span class="s6">.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">](</span><span class="s1">n</span><span class="s2">))</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">] &lt;= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The maximum number of function evaluations must be positive.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">](</span><span class="s1">n</span><span class="s2">),</span>
                <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">NPT</span><span class="s2">] + </span><span class="s5">1</span><span class="s2">,</span>
            <span class="s2">]</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER </span><span class="s0">in </span><span class="s1">options </span><span class="s0">and </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">] &lt;= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The maximum number of iterations must be positive.&quot;</span><span class="s2">)</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">](</span><span class="s1">n</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_ITER</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">TARGET</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">TARGET</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">TARGET</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">TARGET</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">SCALE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FILTER_SIZE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">HISTORY_SIZE</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">DEFAULT_OPTIONS</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">])</span>
    <span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">DEBUG</span><span class="s2">])</span>

    <span class="s4"># Check whether they are any unknown options.</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">Options</span><span class="s2">.</span><span class="s1">__members__</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">f&quot;Unknown option: </span><span class="s0">{</span><span class="s1">key</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_set_default_constants</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Set the default constants. 
    &quot;&quot;&quot;</span>
    <span class="s1">constants </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_FACTOR</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant decrease_radius_factor must be in the interval &quot;</span>
            <span class="s6">&quot;(0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_THRESHOLD</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_THRESHOLD</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_THRESHOLD</span><span class="s2">] &lt;= </span><span class="s5">1.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant increase_radius_threshold must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant increase_radius_factor must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">] &lt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant decrease_radius_threshold must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
    <span class="s2">):</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">]</span>
            <span class="s2">&gt;= </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The constant decrease_radius_threshold must be &quot;</span>
                <span class="s6">&quot;less than increase_radius_factor.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">],</span>
                <span class="s5">0.5 </span><span class="s2">* (</span><span class="s5">1.0 </span><span class="s2">+ </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">]),</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">],</span>
                <span class="s5">2.0 </span><span class="s2">* </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span>
            <span class="s1">Constants</span><span class="s2">.</span><span class="s1">INCREASE_RADIUS_FACTOR</span>
        <span class="s2">]</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = (</span>
            <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RADIUS_THRESHOLD</span><span class="s2">])</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">DECREASE_RESOLUTION_FACTOR</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant decrease_resolution_factor must be in the interval &quot;</span>
            <span class="s6">&quot;(0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">] &lt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant large_resolution_threshold must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">] &lt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant moderate_resolution_threshold must be greater than &quot;</span>
            <span class="s6">&quot;1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
    <span class="s2">):</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">]</span>
            <span class="s2">&gt; </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The constant moderate_resolution_threshold &quot;</span>
                <span class="s6">&quot;must be at most large_resolution_threshold.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = (</span>
            <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_RESOLUTION_THRESHOLD</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = (</span>
            <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">MODERATE_RESOLUTION_THRESHOLD</span><span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO </span><span class="s0">in </span><span class="s1">constants </span><span class="s0">and </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant low_ratio must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO </span><span class="s0">in </span><span class="s1">constants </span><span class="s0">and </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant high_ratio must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO </span><span class="s0">in </span><span class="s1">constants </span><span class="s0">and </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">] &gt; </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">]:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The constant low_ratio must be at most high_ratio.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span>
            <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RATIO</span>
        <span class="s2">]</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span>
            <span class="s1">Constants</span><span class="s2">.</span><span class="s1">HIGH_RATIO</span>
        <span class="s2">]</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">VERY_LOW_RATIO</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant very_low_ratio must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">] &lt; </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant penalty_increase_threshold must be &quot;</span>
            <span class="s6">&quot;greater than or equal to 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant penalty_increase_factor must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span>
        <span class="s0">and </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR </span><span class="s0">in </span><span class="s1">constants</span>
    <span class="s2">):</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">]</span>
            <span class="s2">&lt; </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s6">&quot;The constant penalty_increase_factor must be &quot;</span>
                <span class="s6">&quot;greater than or equal to &quot;</span>
                <span class="s6">&quot;penalty_increase_threshold.&quot;</span>
            <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR </span><span class="s0">in </span><span class="s1">constants</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">],</span>
                <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = (</span>
            <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_THRESHOLD</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span>
            <span class="s1">Constants</span><span class="s2">.</span><span class="s1">PENALTY_INCREASE_FACTOR</span>
        <span class="s2">]</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">SHORT_STEP_THRESHOLD</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant short_step_threshold must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LOW_RADIUS_FACTOR</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant low_radius_factor must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">0.0</span>
        <span class="s0">or </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">BYRD_OMOJOKUN_FACTOR</span><span class="s2">] &gt;= </span><span class="s5">1.0</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant byrd_omojokun_factor must be in the interval (0, 1).&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">THRESHOLD_RATIO_CONSTRAINTS</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">THRESHOLD_RATIO_CONSTRAINTS</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">THRESHOLD_RATIO_CONSTRAINTS</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">THRESHOLD_RATIO_CONSTRAINTS</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">THRESHOLD_RATIO_CONSTRAINTS</span><span class="s2">] &lt;= </span><span class="s5">1.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant threshold_ratio_constraints must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_SHIFT_FACTOR</span><span class="s2">] &lt; </span><span class="s5">0.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">&quot;The constant large_shift_factor must be &quot;</span>
                         <span class="s6">&quot;nonnegative.&quot;</span><span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">LARGE_GRADIENT_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">1.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant large_gradient_factor must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">float</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">RESOLUTION_FACTOR</span><span class="s2">] &lt;= </span><span class="s5">1.0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s6">&quot;The constant resolution_factor must be greater than 1.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span>
        <span class="s1">Constants</span><span class="s2">.</span><span class="s1">IMPROVE_TCG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
        <span class="s1">DEFAULT_CONSTANTS</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">IMPROVE_TCG</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">IMPROVE_TCG</span><span class="s2">.</span><span class="s1">value</span><span class="s2">] = </span><span class="s1">bool</span><span class="s2">(</span>
        <span class="s1">constants</span><span class="s2">[</span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">IMPROVE_TCG</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s4"># Check whether they are any unknown options.</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">Constants</span><span class="s2">.</span><span class="s1">__members__</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s6">f&quot;Unknown constant: </span><span class="s0">{</span><span class="s1">key</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">constants</span>


<span class="s0">def </span><span class="s1">_eval</span><span class="s2">(</span><span class="s1">pb</span><span class="s2">, </span><span class="s1">framework</span><span class="s2">, </span><span class="s1">step</span><span class="s2">, </span><span class="s1">options</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Evaluate the objective and constraint functions. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">n_eval </span><span class="s2">&gt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">MAX_EVAL</span><span class="s2">]:</span>
        <span class="s0">raise </span><span class="s1">MaxEvalError</span>
    <span class="s1">x_eval </span><span class="s2">= </span><span class="s1">framework</span><span class="s2">.</span><span class="s1">x_best </span><span class="s2">+ </span><span class="s1">step</span>
    <span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">(</span><span class="s1">x_eval</span><span class="s2">)</span>
    <span class="s1">r_val </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">maxcv</span><span class="s2">(</span><span class="s1">x_eval</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">fun_val </span><span class="s2">&lt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">TARGET</span><span class="s2">]</span>
        <span class="s0">and </span><span class="s1">r_val </span><span class="s2">&lt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">]</span>
    <span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">TargetSuccess</span>
    <span class="s0">if </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">is_feasibility </span><span class="s0">and </span><span class="s1">r_val </span><span class="s2">&lt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">]:</span>
        <span class="s0">raise </span><span class="s1">FeasibleSuccess</span>
    <span class="s0">return </span><span class="s1">fun_val</span><span class="s2">, </span><span class="s1">cub_val</span><span class="s2">, </span><span class="s1">ceq_val</span>


<span class="s0">def </span><span class="s1">_build_result</span><span class="s2">(</span><span class="s1">pb</span><span class="s2">, </span><span class="s1">penalty</span><span class="s2">, </span><span class="s1">success</span><span class="s2">, </span><span class="s1">status</span><span class="s2">, </span><span class="s1">n_iter</span><span class="s2">, </span><span class="s1">options</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Build the result of the optimization process. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Build the result.</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">fun</span><span class="s2">, </span><span class="s1">maxcv </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">best_eval</span><span class="s2">(</span><span class="s1">penalty</span><span class="s2">)</span>
    <span class="s1">success </span><span class="s2">= </span><span class="s1">success </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">fun</span><span class="s2">) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">maxcv</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">status </span><span class="s0">not in </span><span class="s2">[</span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span><span class="s2">, </span><span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span><span class="s2">]:</span>
        <span class="s1">success </span><span class="s2">= </span><span class="s1">success </span><span class="s0">and </span><span class="s1">maxcv </span><span class="s2">&lt;= </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">FEASIBILITY_TOL</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">OptimizeResult</span><span class="s2">()</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">message </span><span class="s2">= {</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">RADIUS_SUCCESS</span><span class="s2">: </span><span class="s6">&quot;The lower bound for the trust-region &quot;</span>
                                   <span class="s6">&quot;radius has been reached&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">TARGET_SUCCESS</span><span class="s2">: </span><span class="s6">&quot;The target objective function value has &quot;</span>
                                   <span class="s6">&quot;been reached&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FIXED_SUCCESS</span><span class="s2">: </span><span class="s6">&quot;All variables are fixed by the bound &quot;</span>
                                  <span class="s6">&quot;constraints&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">CALLBACK_SUCCESS</span><span class="s2">: </span><span class="s6">&quot;The callback requested to stop the &quot;</span>
                                     <span class="s6">&quot;optimization procedure&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">FEASIBLE_SUCCESS</span><span class="s2">: </span><span class="s6">&quot;The feasibility problem received has &quot;</span>
                                     <span class="s6">&quot;been solved successfully&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_EVAL_WARNING</span><span class="s2">: </span><span class="s6">&quot;The maximum number of function &quot;</span>
                                     <span class="s6">&quot;evaluations has been exceeded&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">MAX_ITER_WARNING</span><span class="s2">: </span><span class="s6">&quot;The maximum number of iterations has &quot;</span>
                                     <span class="s6">&quot;been exceeded&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">INFEASIBLE_ERROR</span><span class="s2">: </span><span class="s6">&quot;The bound constraints are infeasible&quot;</span><span class="s2">,</span>
        <span class="s1">ExitStatus</span><span class="s2">.</span><span class="s1">LINALG_ERROR</span><span class="s2">: </span><span class="s6">&quot;A linear algebra error occurred&quot;</span><span class="s2">,</span>
    <span class="s2">}.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">status</span><span class="s2">, </span><span class="s6">&quot;Unknown exit status&quot;</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">success </span><span class="s2">= </span><span class="s1">success</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">status </span><span class="s2">= </span><span class="s1">status</span><span class="s2">.</span><span class="s1">value</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">build_x</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">= </span><span class="s1">fun</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">maxcv </span><span class="s2">= </span><span class="s1">maxcv</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">n_eval</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">nit </span><span class="s2">= </span><span class="s1">n_iter</span>
    <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">STORE_HISTORY</span><span class="s2">]:</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">fun_history </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">fun_history</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">maxcv_history </span><span class="s2">= </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">maxcv_history</span>

    <span class="s4"># Print the result if requested.</span>
    <span class="s0">if </span><span class="s1">options</span><span class="s2">[</span><span class="s1">Options</span><span class="s2">.</span><span class="s1">VERBOSE</span><span class="s2">]:</span>
        <span class="s1">_print_step</span><span class="s2">(</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">message</span><span class="s2">,</span>
            <span class="s1">pb</span><span class="s2">,</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">x</span><span class="s2">,</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">,</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">maxcv</span><span class="s2">,</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">,</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">_print_step</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">pb</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">fun_val</span><span class="s2">, </span><span class="s1">r_val</span><span class="s2">, </span><span class="s1">n_eval</span><span class="s2">, </span><span class="s1">n_iter</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Print information about the current state of the optimization process. 
    &quot;&quot;&quot;</span>
    <span class="s1">print</span><span class="s2">()</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">message</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Number of function evaluations: </span><span class="s0">{</span><span class="s1">n_eval</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Number of iterations: </span><span class="s0">{</span><span class="s1">n_iter</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">pb</span><span class="s2">.</span><span class="s1">is_feasibility</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Least value of </span><span class="s0">{</span><span class="s1">pb</span><span class="s2">.</span><span class="s1">fun_name</span><span class="s0">}</span><span class="s6">: </span><span class="s0">{</span><span class="s1">fun_val</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Maximum constraint violation: </span><span class="s0">{</span><span class="s1">r_val</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">printoptions</span><span class="s2">(**</span><span class="s1">PRINT_OPTIONS</span><span class="s2">):</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s6">f&quot;Corresponding point: </span><span class="s0">{</span><span class="s1">x</span><span class="s0">}</span><span class="s6">.&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>