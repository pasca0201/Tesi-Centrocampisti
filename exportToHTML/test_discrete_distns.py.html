<html>
<head>
<title>test_discrete_distns.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_discrete_distns.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats </span><span class="s0">import </span><span class="s2">(</span><span class="s1">betabinom</span><span class="s2">, </span><span class="s1">betanbinom</span><span class="s2">, </span><span class="s1">hypergeom</span><span class="s2">, </span><span class="s1">nhypergeom</span><span class="s2">,</span>
                         <span class="s1">bernoulli</span><span class="s2">, </span><span class="s1">boltzmann</span><span class="s2">, </span><span class="s1">skellam</span><span class="s2">, </span><span class="s1">zipf</span><span class="s2">, </span><span class="s1">zipfian</span><span class="s2">, </span><span class="s1">binom</span><span class="s2">,</span>
                         <span class="s1">nbinom</span><span class="s2">, </span><span class="s1">nchypergeom_fisher</span><span class="s2">, </span><span class="s1">nchypergeom_wallenius</span><span class="s2">,</span>
                         <span class="s1">randint</span><span class="s2">)</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_almost_equal</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">suppress_warnings</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">special </span><span class="s0">import </span><span class="s1">binom </span><span class="s0">as </span><span class="s1">special_binom</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize </span><span class="s0">import </span><span class="s1">root_scalar</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">integrate </span><span class="s0">import </span><span class="s1">quad</span>


<span class="s3"># The expected values were computed with Wolfram Alpha, using</span>
<span class="s3"># the expression CDF[HypergeometricDistribution[N, n, M], k].</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'k, M, n, N, expected, rtol'</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">,</span>
                           <span class="s5">0.9761904761904762</span><span class="s2">, </span><span class="s5">1e-15</span><span class="s2">),</span>
                          <span class="s2">(</span><span class="s5">107</span><span class="s2">, </span><span class="s5">10000</span><span class="s2">, </span><span class="s5">3000</span><span class="s2">, </span><span class="s5">215</span><span class="s2">,</span>
                           <span class="s5">0.9999999997226765</span><span class="s2">, </span><span class="s5">1e-15</span><span class="s2">),</span>
                          <span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10000</span><span class="s2">, </span><span class="s5">3000</span><span class="s2">, </span><span class="s5">215</span><span class="s2">,</span>
                           <span class="s5">2.681682217692179e-21</span><span class="s2">, </span><span class="s5">5e-11</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_hypergeom_cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">):</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>


<span class="s3"># The expected values were computed with Wolfram Alpha, using</span>
<span class="s3"># the expression SurvivalFunction[HypergeometricDistribution[N, n, M], k].</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'k, M, n, N, expected, rtol'</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s5">25</span><span class="s2">, </span><span class="s5">10000</span><span class="s2">, </span><span class="s5">3000</span><span class="s2">, </span><span class="s5">215</span><span class="s2">,</span>
                           <span class="s5">0.9999999999052958</span><span class="s2">, </span><span class="s5">1e-15</span><span class="s2">),</span>
                          <span class="s2">(</span><span class="s5">125</span><span class="s2">, </span><span class="s5">10000</span><span class="s2">, </span><span class="s5">3000</span><span class="s2">, </span><span class="s5">215</span><span class="s2">,</span>
                           <span class="s5">1.4416781705752128e-18</span><span class="s2">, </span><span class="s5">5e-11</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_hypergeom_sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">):</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_hypergeom_logpmf</span><span class="s2">():</span>
    <span class="s3"># symmetries test</span>
    <span class="s3"># f(k,N,K,n) = f(n-k,N,N-K,n) = f(K-k,N,K,N-n) = f(k,N,n,K)</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s5">50</span>
    <span class="s1">K </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">logpmf1 </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">logpmf2 </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">n </span><span class="s2">- </span><span class="s1">k</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">N </span><span class="s2">- </span><span class="s1">K</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">logpmf3 </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">K </span><span class="s2">- </span><span class="s1">k</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">N </span><span class="s2">- </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">logpmf4 </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">K</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">logpmf1</span><span class="s2">, </span><span class="s1">logpmf2</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">logpmf1</span><span class="s2">, </span><span class="s1">logpmf3</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">logpmf1</span><span class="s2">, </span><span class="s1">logpmf4</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>

    <span class="s3"># test related distribution</span>
    <span class="s3"># Bernoulli distribution if n = 1</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">K </span><span class="s2">= </span><span class="s5">7</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">hypergeom_logpmf </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">K</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">bernoulli_logpmf </span><span class="s2">= </span><span class="s1">bernoulli</span><span class="s2">.</span><span class="s1">logpmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">K</span><span class="s2">/</span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">hypergeom_logpmf</span><span class="s2">, </span><span class="s1">bernoulli_logpmf</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nhypergeom_pmf</span><span class="s2">():</span>
    <span class="s3"># test with hypergeom</span>
    <span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s5">45</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">8</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">6</span>
    <span class="s1">NHG </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
    <span class="s1">HG </span><span class="s2">= </span><span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">+</span><span class="s1">r</span><span class="s2">-</span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">M </span><span class="s2">- </span><span class="s1">n </span><span class="s2">- (</span><span class="s1">r</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)) / (</span><span class="s1">M </span><span class="s2">- (</span><span class="s1">k</span><span class="s2">+</span><span class="s1">r</span><span class="s2">-</span><span class="s5">1</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">HG</span><span class="s2">, </span><span class="s1">NHG</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-10</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nhypergeom_pmfcdf</span><span class="s2">():</span>
    <span class="s3"># test pmf and cdf with arbitrary values.</span>
    <span class="s1">M </span><span class="s2">= </span><span class="s5">8</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s5">4</span>
    <span class="s1">support </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">pmf </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">support</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
    <span class="s1">cdf </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">support</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">5</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">5</span><span class="s2">/</span><span class="s5">14</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cdf</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">4</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">9</span><span class="s2">/</span><span class="s5">14</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nhypergeom_r0</span><span class="s2">():</span>
    <span class="s3"># test with `r = 0`.</span>
    <span class="s1">M </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">pmf </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]], </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nhypergeom_rvs_shape</span><span class="s2">():</span>
    <span class="s3"># Check that when given a size with more dimensions than the</span>
    <span class="s3"># dimensions of the broadcast parameters, rvs returns an array</span>
    <span class="s3"># with the correct shape.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s5">22</span><span class="s2">, [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">], [[</span><span class="s5">12</span><span class="s2">], [</span><span class="s5">13</span><span class="s2">]], </span><span class="s1">size</span><span class="s2">=(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nhypergeom_accuracy</span><span class="s2">():</span>
    <span class="s3"># Check that nhypergeom.rvs post-gh-13431 gives the same values as</span>
    <span class="s3"># inverse transform sampling</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s5">22</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">nhypergeom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s5">22</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_boltzmann_upper_bound</span><span class="s2">():</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>

    <span class="s1">N </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">boltzmann</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s5">0.123</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">k </span><span class="s2">== </span><span class="s5">0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">lam </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">boltzmann</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">lam</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">/</span><span class="s5">7</span><span class="s2">, </span><span class="s5">2</span><span class="s2">/</span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s2">/</span><span class="s5">7</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>

    <span class="s1">c </span><span class="s2">= </span><span class="s1">boltzmann</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">lam</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">/</span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">/</span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_betabinom_a_and_b_unity</span><span class="s2">():</span>
    <span class="s3"># test limiting case that betabinom(n, 1, 1) is a discrete uniform</span>
    <span class="s3"># distribution from 0 to n</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">betabinom</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">).</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s5">1 </span><span class="s2">/ (</span><span class="s1">n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">), </span><span class="s1">n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtypes'</span><span class="s2">, </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*[(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_betabinom_stats_a_and_b_integers_gh18026</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">):</span>
    <span class="s3"># gh-18026 reported that `betabinom` kurtosis calculation fails when some</span>
    <span class="s3"># parameters are integers. Check that this is resolved.</span>
    <span class="s1">n_type</span><span class="s2">, </span><span class="s1">a_type</span><span class="s2">, </span><span class="s1">b_type </span><span class="s2">= </span><span class="s1">dtypes</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">n_type</span><span class="s2">(</span><span class="s5">10</span><span class="s2">), </span><span class="s1">a_type</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s1">b_type</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">betabinom</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'k'</span><span class="s2">), -</span><span class="s5">0.6904761904761907</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_betabinom_bernoulli</span><span class="s2">():</span>
    <span class="s3"># test limiting case that betabinom(1, a, b) = bernoulli(a / (a + b))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s5">2.3</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s5">0.63</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">betabinom</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">).</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">bernoulli</span><span class="s2">(</span><span class="s1">a </span><span class="s2">/ (</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">)).</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_10317</span><span class="s2">():</span>
    <span class="s1">alpha</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">nbinom</span><span class="s2">.</span><span class="s1">interval</span><span class="s2">(</span><span class="s1">confidence</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_issue_11134</span><span class="s2">():</span>
    <span class="s1">alpha</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">0.95</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">interval</span><span class="s2">(</span><span class="s1">confidence</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_issue_7406</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">), </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># Also check that endpoints (q=0, q=1) are correct</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">), -</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_5122</span><span class="s2">():</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">ppf </span><span class="s2">= </span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ppf</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.99</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">ppf </span><span class="s2">= </span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ppf</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">ppf </span><span class="s2">= </span><span class="s1">binom</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ppf</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_1603</span><span class="s2">():</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logspace</span><span class="s2">(-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">100</span><span class="s2">)).</span><span class="s1">ppf</span><span class="s2">(</span><span class="s5">0.01</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_5503</span><span class="s2">():</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s5">0.5</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logspace</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">12</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'x, n, p, cdf_desired'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s5">300</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.51559351981411995636</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">3000</span><span class="s2">, </span><span class="s5">10000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.50493298381929698016</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">30000</span><span class="s2">, </span><span class="s5">100000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.50156000591726422864</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">300000</span><span class="s2">, </span><span class="s5">1000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.50049331906666960038</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">3000000</span><span class="s2">, </span><span class="s5">10000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.50015600124585261196</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">30000000</span><span class="s2">, </span><span class="s5">100000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.50004933192735230102</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">30010000</span><span class="s2">, </span><span class="s5">100000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.98545384016570790717</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">29990000</span><span class="s2">, </span><span class="s5">100000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.01455017177985268670</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s5">29950000</span><span class="s2">, </span><span class="s5">100000000</span><span class="s2">, </span><span class="s5">3</span><span class="s2">/</span><span class="s5">10</span><span class="s2">, </span><span class="s5">5.02250963487432024943e-28</span><span class="s2">),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_issue_5503pt2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">cdf_desired</span><span class="s2">):</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">cdf_desired</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_5503pt3</span><span class="s2">():</span>
    <span class="s3"># From Wolfram Alpha: CDF[BinomialDistribution[1e12, 1e-12], 2]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">**</span><span class="s5">12</span><span class="s2">, </span><span class="s5">10</span><span class="s2">**-</span><span class="s5">12</span><span class="s2">), </span><span class="s5">0.91969860292869777384</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_6682</span><span class="s2">():</span>
    <span class="s3"># Reference value from R:</span>
    <span class="s3"># options(digits=16)</span>
    <span class="s3"># print(pnbinom(250, 50, 32/63, lower.tail=FALSE))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nbinom</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s5">250</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">32.</span><span class="s2">/</span><span class="s5">63.</span><span class="s2">), </span><span class="s5">1.460458510976452e-35</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_issue_19747</span><span class="s2">():</span>
    <span class="s3"># test that negative k does not raise an error in nbinom.logcdf</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">nbinom</span><span class="s2">.</span><span class="s1">logcdf</span><span class="s2">([</span><span class="s5">5</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s5">5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">reference </span><span class="s2">= [-</span><span class="s5">0.47313352</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s5">2.21297293</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">reference</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_boost_divide_by_zero_issue_15101</span><span class="s2">():</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s5">1000</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s5">0.01</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">996</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">binom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s5">0.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_skellam_gh11474</span><span class="s2">():</span>
    <span class="s3"># test issue reported in gh-11474 caused by `cdfchn`</span>
    <span class="s1">mu </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">5000</span><span class="s2">, </span><span class="s5">5050</span><span class="s2">, </span><span class="s5">5100</span><span class="s2">, </span><span class="s5">5250</span><span class="s2">, </span><span class="s5">6000</span><span class="s2">]</span>
    <span class="s1">cdf </span><span class="s2">= </span><span class="s1">skellam</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">mu</span><span class="s2">, </span><span class="s1">mu</span><span class="s2">)</span>
    <span class="s3"># generated in R</span>
    <span class="s3"># library(skellam)</span>
    <span class="s3"># options(digits = 16)</span>
    <span class="s3"># mu = c(1, 10, 100, 1000, 5000, 5050, 5100, 5250, 6000)</span>
    <span class="s3"># pskellam(0, mu, mu, TRUE)</span>
    <span class="s1">cdf_expected </span><span class="s2">= [</span><span class="s5">0.6542541612768356</span><span class="s2">, </span><span class="s5">0.5448901559424127</span><span class="s2">, </span><span class="s5">0.5141135799745580</span><span class="s2">,</span>
                    <span class="s5">0.5044605891382528</span><span class="s2">, </span><span class="s5">0.5019947363350450</span><span class="s2">, </span><span class="s5">0.5019848365953181</span><span class="s2">,</span>
                    <span class="s5">0.5019750827993392</span><span class="s2">, </span><span class="s5">0.5019466621805060</span><span class="s2">, </span><span class="s5">0.5018209330219539</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cdf</span><span class="s2">, </span><span class="s1">cdf_expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestZipfian</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_zipfian_asymptotic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test limiting case that zipfian(a, n) -&gt; zipf(a) as n-&gt; oo</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s5">6.5</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s5">10000000</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">21</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipf</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipf</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipf</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'msvk'</span><span class="s2">),</span>
                        <span class="s1">zipf</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'msvk'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_zipfian_continuity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that zipfian(0.999999, n) ~ zipfian(1.000001, n)</span>
        <span class="s3"># (a = 1 switches between methods of calculating harmonic sum)</span>
        <span class="s1">alt1</span><span class="s2">, </span><span class="s1">agt1 </span><span class="s2">= </span><span class="s5">0.99999999</span><span class="s2">, </span><span class="s5">1.00000001</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s5">30</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">N </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">alt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">agt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">),</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">alt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">agt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">),</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">alt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">sf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">agt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">),</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">alt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'msvk'</span><span class="s2">),</span>
                        <span class="s1">zipfian</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">agt1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'msvk'</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zipfian_R</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test against R VGAM package</span>
        <span class="s3"># library(VGAM)</span>
        <span class="s3"># k &lt;- c(13, 16,  1,  4,  4,  8, 10, 19,  5,  7)</span>
        <span class="s3"># a &lt;- c(1.56712977, 3.72656295, 5.77665117, 9.12168729, 5.79977172,</span>
        <span class="s3">#        4.92784796, 9.36078764, 4.3739616 , 7.48171872, 4.6824154)</span>
        <span class="s3"># n &lt;- c(70, 80, 48, 65, 83, 89, 50, 30, 20, 20)</span>
        <span class="s3"># pmf &lt;- dzipf(k, N = n, shape = a)</span>
        <span class="s3"># cdf &lt;- pzipf(k, N = n, shape = a)</span>
        <span class="s3"># print(pmf)</span>
        <span class="s3"># print(cdf)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)*</span><span class="s5">10 </span><span class="s2">+ </span><span class="s5">1</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">pmf </span><span class="s2">= [</span><span class="s5">8.076972e-03</span><span class="s2">, </span><span class="s5">2.950214e-05</span><span class="s2">, </span><span class="s5">9.799333e-01</span><span class="s2">, </span><span class="s5">3.216601e-06</span><span class="s2">,</span>
               <span class="s5">3.158895e-04</span><span class="s2">, </span><span class="s5">3.412497e-05</span><span class="s2">, </span><span class="s5">4.350472e-10</span><span class="s2">, </span><span class="s5">2.405773e-06</span><span class="s2">,</span>
               <span class="s5">5.860662e-06</span><span class="s2">, </span><span class="s5">1.053948e-04</span><span class="s2">]</span>
        <span class="s1">cdf </span><span class="s2">= [</span><span class="s5">0.8964133</span><span class="s2">, </span><span class="s5">0.9998666</span><span class="s2">, </span><span class="s5">0.9799333</span><span class="s2">, </span><span class="s5">0.9999995</span><span class="s2">, </span><span class="s5">0.9998584</span><span class="s2">,</span>
               <span class="s5">0.9999458</span><span class="s2">, </span><span class="s5">1.0000000</span><span class="s2">, </span><span class="s5">0.9999920</span><span class="s2">, </span><span class="s5">0.9999977</span><span class="s2">, </span><span class="s5">0.9998498</span><span class="s2">]</span>
        <span class="s3"># skip the first point; zipUC is not accurate for low a, n</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">pmf</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">cdf</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-5</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">naive_tests </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logspace</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">),</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">40</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))).</span><span class="s1">T</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;a, n&quot;</span><span class="s2">, </span><span class="s1">naive_tests</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_zipfian_naive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s3"># test against bare-bones implementation</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">Hns</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">s</span><span class="s2">):</span>
            <span class="s6">&quot;&quot;&quot;Naive implementation of harmonic sum&quot;&quot;&quot;</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s5">1</span><span class="s2">/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">+</span><span class="s5">1</span><span class="s2">)**</span><span class="s1">s</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">pzip</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
            <span class="s6">&quot;&quot;&quot;Naive implementation of zipfian pmf&quot;&quot;&quot;</span>
            <span class="s0">if </span><span class="s1">k </span><span class="s2">&lt; </span><span class="s5">1 </span><span class="s0">or </span><span class="s1">k </span><span class="s2">&gt; </span><span class="s1">n</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">0.</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">1 </span><span class="s2">/ </span><span class="s1">k</span><span class="s2">**</span><span class="s1">a </span><span class="s2">/ </span><span class="s1">Hns</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">pmf </span><span class="s2">= </span><span class="s1">pzip</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">cdf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">var </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">((</span><span class="s1">k </span><span class="s2">- </span><span class="s1">mean</span><span class="s2">)**</span><span class="s5">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">std </span><span class="s2">= </span><span class="s1">var</span><span class="s2">**</span><span class="s5">0.5</span>
        <span class="s1">skew </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(((</span><span class="s1">k</span><span class="s2">-</span><span class="s1">mean</span><span class="s2">)/</span><span class="s1">std</span><span class="s2">)**</span><span class="s5">3</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">kurtosis </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(((</span><span class="s1">k</span><span class="s2">-</span><span class="s1">mean</span><span class="s2">)/</span><span class="s1">std</span><span class="s2">)**</span><span class="s5">4</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">pmf</span><span class="s2">) - </span><span class="s5">3</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">cdf</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">zipfian</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">&quot;mvsk&quot;</span><span class="s2">),</span>
                        <span class="s2">[</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">var</span><span class="s2">, </span><span class="s1">skew</span><span class="s2">, </span><span class="s1">kurtosis</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_pmf_integer_k</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">)</span>
        <span class="s1">k_int32 </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">zipfian</span><span class="s2">(</span><span class="s5">111</span><span class="s2">, </span><span class="s5">22</span><span class="s2">)</span>
        <span class="s1">pmf </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">pmf_k_int32 </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k_int32</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">, </span><span class="s1">pmf_k_int32</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestNCH</span><span class="s2">:</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)  </span><span class="s3"># seeds 0 and 1 had some xl = xu; randint failed</span>
    <span class="s1">shape </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">max_m </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">m1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">max_m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">)    </span><span class="s3"># red balls</span>
    <span class="s1">m2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">max_m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">)    </span><span class="s3"># white balls</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s1">m1 </span><span class="s2">+ </span><span class="s1">m2                                     </span><span class="s3"># total balls</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">randint</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">N</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)             </span><span class="s3"># number of draws</span>
    <span class="s1">xl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">-</span><span class="s1">m2</span><span class="s2">)                        </span><span class="s3"># lower bound of support</span>
    <span class="s1">xu </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">)                          </span><span class="s3"># upper bound of support</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">randint</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">xl</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">odds </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)*</span><span class="s5">2</span>

    <span class="s3"># test output is more readable when function names (strings) are passed</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dist_name'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s4">'nchypergeom_fisher'</span><span class="s2">, </span><span class="s4">'nchypergeom_wallenius'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nch_hypergeom</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">):</span>
        <span class="s3"># Both noncentral hypergeometric distributions reduce to the</span>
        <span class="s3"># hypergeometric distribution when odds = 1</span>
        <span class="s1">dists </span><span class="s2">= {</span><span class="s4">'nchypergeom_fisher'</span><span class="s2">: </span><span class="s1">nchypergeom_fisher</span><span class="s2">,</span>
                 <span class="s4">'nchypergeom_wallenius'</span><span class="s2">: </span><span class="s1">nchypergeom_wallenius</span><span class="s2">}</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">dists</span><span class="s2">[</span><span class="s1">dist_name</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">N</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">=</span><span class="s5">1</span><span class="s2">),</span>
                        <span class="s1">hypergeom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_nchypergeom_fisher_naive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test against a very simple implementation</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">N</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">odds</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">pmf_mean_var</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s3"># simple implementation of nchypergeom_fisher pmf</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">xl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">-</span><span class="s1">m2</span><span class="s2">)</span>
            <span class="s1">xu </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
                <span class="s1">t1 </span><span class="s2">= </span><span class="s1">special_binom</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">t2 </span><span class="s2">= </span><span class="s1">special_binom</span><span class="s2">(</span><span class="s1">m2</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">t1 </span><span class="s2">* </span><span class="s1">t2 </span><span class="s2">* </span><span class="s1">w</span><span class="s2">**</span><span class="s1">x</span>

            <span class="s0">def </span><span class="s1">P</span><span class="s2">(</span><span class="s1">k</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)*</span><span class="s1">y</span><span class="s2">**</span><span class="s1">k </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">))</span>

            <span class="s1">P0 </span><span class="s2">= </span><span class="s1">P</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
            <span class="s1">P1 </span><span class="s2">= </span><span class="s1">P</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">P2 </span><span class="s2">= </span><span class="s1">P</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
            <span class="s1">pmf </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) / </span><span class="s1">P0</span>
            <span class="s1">mean </span><span class="s2">= </span><span class="s1">P1 </span><span class="s2">/ </span><span class="s1">P0</span>
            <span class="s1">var </span><span class="s2">= </span><span class="s1">P2 </span><span class="s2">/ </span><span class="s1">P0 </span><span class="s2">- (</span><span class="s1">P1 </span><span class="s2">/ </span><span class="s1">P0</span><span class="s2">)**</span><span class="s5">2</span>
            <span class="s0">return </span><span class="s1">pmf</span><span class="s2">, </span><span class="s1">mean</span><span class="s2">, </span><span class="s1">var</span>

        <span class="s1">pmf</span><span class="s2">, </span><span class="s1">mean</span><span class="s2">, </span><span class="s1">var </span><span class="s2">= </span><span class="s1">pmf_mean_var</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_fisher</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">), </span><span class="s1">pmf</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_fisher</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'m'</span><span class="s2">),</span>
                        <span class="s1">mean</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_fisher</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'v'</span><span class="s2">),</span>
                        <span class="s1">var</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nchypergeom_wallenius_naive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test against a very simple implementation</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">max_m </span><span class="s2">= </span><span class="s5">100</span>
        <span class="s1">m1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">max_m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">m2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">max_m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s1">m1 </span><span class="s2">+ </span><span class="s1">m2</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">randint</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">N</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">-</span><span class="s1">m2</span><span class="s2">)</span>
        <span class="s1">xu </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">randint</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">xl</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)*</span><span class="s5">2</span>

        <span class="s0">def </span><span class="s1">support</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">xl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">-</span><span class="s1">m2</span><span class="s2">)</span>
            <span class="s1">xu </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">mean</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">xl</span><span class="s2">, </span><span class="s1">xu </span><span class="s2">= </span><span class="s1">support</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">fun</span><span class="s2">(</span><span class="s1">u</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">u</span><span class="s2">/</span><span class="s1">m1 </span><span class="s2">+ (</span><span class="s5">1 </span><span class="s2">- (</span><span class="s1">n</span><span class="s2">-</span><span class="s1">u</span><span class="s2">)/</span><span class="s1">m2</span><span class="s2">)**</span><span class="s1">w </span><span class="s2">- </span><span class="s5">1</span>

            <span class="s0">return </span><span class="s1">root_scalar</span><span class="s2">(</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">bracket</span><span class="s2">=(</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu</span><span class="s2">)).</span><span class="s1">root</span>

        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">,</span>
                       <span class="s1">message</span><span class="s2">=</span><span class="s4">&quot;invalid value encountered in mean&quot;</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">),</span>
                            <span class="s1">mean</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">2e-2</span><span class="s2">)</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">variance</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">u </span><span class="s2">= </span><span class="s1">mean</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">u </span><span class="s2">* (</span><span class="s1">m1 </span><span class="s2">- </span><span class="s1">u</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= (</span><span class="s1">n</span><span class="s2">-</span><span class="s1">u</span><span class="s2">)*(</span><span class="s1">u </span><span class="s2">+ </span><span class="s1">m2 </span><span class="s2">- </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">N</span><span class="s2">*</span><span class="s1">a</span><span class="s2">*</span><span class="s1">b </span><span class="s2">/ ((</span><span class="s1">N</span><span class="s2">-</span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">m1</span><span class="s2">*</span><span class="s1">b </span><span class="s2">+ </span><span class="s1">m2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">,</span>
                       <span class="s1">message</span><span class="s2">=</span><span class="s4">&quot;invalid value encountered in mean&quot;</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">'v'</span><span class="s2">),</span>
                <span class="s1">variance</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">),</span>
                <span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-2</span>
            <span class="s2">)</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">xl</span><span class="s2">, </span><span class="s1">xu </span><span class="s2">= </span><span class="s1">support</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">integrand</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
                <span class="s1">D </span><span class="s2">= </span><span class="s1">w</span><span class="s2">*(</span><span class="s1">m1 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">) + (</span><span class="s1">m2 </span><span class="s2">- (</span><span class="s1">n</span><span class="s2">-</span><span class="s1">x</span><span class="s2">))</span>
                <span class="s1">res </span><span class="s2">= (</span><span class="s5">1</span><span class="s2">-</span><span class="s1">t</span><span class="s2">**(</span><span class="s1">w</span><span class="s2">/</span><span class="s1">D</span><span class="s2">))**</span><span class="s1">x </span><span class="s2">* (</span><span class="s5">1</span><span class="s2">-</span><span class="s1">t</span><span class="s2">**(</span><span class="s5">1</span><span class="s2">/</span><span class="s1">D</span><span class="s2">))**(</span><span class="s1">n</span><span class="s2">-</span><span class="s1">x</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">res</span>

            <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
                <span class="s1">t1 </span><span class="s2">= </span><span class="s1">special_binom</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">t2 </span><span class="s2">= </span><span class="s1">special_binom</span><span class="s2">(</span><span class="s1">m2</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">the_integral </span><span class="s2">= </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">integrand</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">,</span>
                                    <span class="s1">epsrel</span><span class="s2">=</span><span class="s5">1e-16</span><span class="s2">, </span><span class="s1">epsabs</span><span class="s2">=</span><span class="s5">1e-16</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">t1 </span><span class="s2">* </span><span class="s1">t2 </span><span class="s2">* </span><span class="s1">the_integral</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

            <span class="s0">return </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">pmf0 </span><span class="s2">= </span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>
        <span class="s1">pmf1 </span><span class="s2">= </span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

        <span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol </span><span class="s2">= </span><span class="s5">1e-6</span><span class="s2">, </span><span class="s5">1e-6</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pmf1 </span><span class="s2">- </span><span class="s1">pmf0</span><span class="s2">) &lt; </span><span class="s1">atol </span><span class="s2">+ </span><span class="s1">rtol</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pmf0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">i</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() &gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) / </span><span class="s5">2  </span><span class="s3"># works at least half the time</span>

        <span class="s3"># for those that fail, discredit the naive implementation</span>
        <span class="s0">for </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">N</span><span class="s2">[~</span><span class="s1">i</span><span class="s2">], </span><span class="s1">m1</span><span class="s2">[~</span><span class="s1">i</span><span class="s2">], </span><span class="s1">n</span><span class="s2">[~</span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[~</span><span class="s1">i</span><span class="s2">]):</span>
            <span class="s3"># get the support</span>
            <span class="s1">m2 </span><span class="s2">= </span><span class="s1">N </span><span class="s2">- </span><span class="s1">m1</span>
            <span class="s1">xl</span><span class="s2">, </span><span class="s1">xu </span><span class="s2">= </span><span class="s1">support</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xu </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>

            <span class="s3"># calculate sum of pmf over the support</span>
            <span class="s3"># the naive implementation is very wrong in these cases</span>
            <span class="s0">assert </span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">() &lt; </span><span class="s5">.5</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">m1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">w</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wallenius_against_mpmath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># precompute data with mpmath since naive implementation above</span>
        <span class="s3"># is not reliable. See source code in gh-13330.</span>
        <span class="s1">M </span><span class="s2">= </span><span class="s5">50</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s5">30</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s5">20</span>
        <span class="s1">odds </span><span class="s2">= </span><span class="s5">2.25</span>
        <span class="s3"># Expected results, computed with mpmath.</span>
        <span class="s1">sup </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">21</span><span class="s2">)</span>
        <span class="s1">pmf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3.699003068656875e-20</span><span class="s2">,</span>
                        <span class="s5">5.89398584245431e-17</span><span class="s2">,</span>
                        <span class="s5">2.1594437742911123e-14</span><span class="s2">,</span>
                        <span class="s5">3.221458044649955e-12</span><span class="s2">,</span>
                        <span class="s5">2.4658279241205077e-10</span><span class="s2">,</span>
                        <span class="s5">1.0965862603981212e-08</span><span class="s2">,</span>
                        <span class="s5">3.057890479665704e-07</span><span class="s2">,</span>
                        <span class="s5">5.622818831643761e-06</span><span class="s2">,</span>
                        <span class="s5">7.056482841531681e-05</span><span class="s2">,</span>
                        <span class="s5">0.000618899425358671</span><span class="s2">,</span>
                        <span class="s5">0.003854172932571669</span><span class="s2">,</span>
                        <span class="s5">0.01720592676256026</span><span class="s2">,</span>
                        <span class="s5">0.05528844897093792</span><span class="s2">,</span>
                        <span class="s5">0.12772363313574242</span><span class="s2">,</span>
                        <span class="s5">0.21065898367825722</span><span class="s2">,</span>
                        <span class="s5">0.24465958845359234</span><span class="s2">,</span>
                        <span class="s5">0.1955114898110033</span><span class="s2">,</span>
                        <span class="s5">0.10355390084949237</span><span class="s2">,</span>
                        <span class="s5">0.03414490375225675</span><span class="s2">,</span>
                        <span class="s5">0.006231989845775931</span><span class="s2">,</span>
                        <span class="s5">0.0004715577304677075</span><span class="s2">])</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s5">14.808018384813426</span>
        <span class="s1">var </span><span class="s2">= </span><span class="s5">2.6085975877923717</span>

        <span class="s3"># nchypergeom_wallenius.pmf returns 0 for pmf(0) and pmf(1), and pmf(2)</span>
        <span class="s3"># has only three digits of accuracy (~ 2.1511e-14).</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">), </span><span class="s1">pmf</span><span class="s2">,</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">),</span>
                        <span class="s1">mean</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nchypergeom_wallenius</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">M</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">, </span><span class="s1">odds</span><span class="s2">),</span>
                        <span class="s1">var</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-11</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dist_name'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s4">'nchypergeom_fisher'</span><span class="s2">, </span><span class="s4">'nchypergeom_wallenius'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_rvs_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">):</span>
        <span class="s3"># Check that when given a size with more dimensions than the</span>
        <span class="s3"># dimensions of the broadcast parameters, rvs returns an array</span>
        <span class="s3"># with the correct shape.</span>
        <span class="s1">dists </span><span class="s2">= {</span><span class="s4">'nchypergeom_fisher'</span><span class="s2">: </span><span class="s1">nchypergeom_fisher</span><span class="s2">,</span>
                 <span class="s4">'nchypergeom_wallenius'</span><span class="s2">: </span><span class="s1">nchypergeom_wallenius</span><span class="s2">}</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">dists</span><span class="s2">[</span><span class="s1">dist_name</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s5">50</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, [[</span><span class="s5">10</span><span class="s2">], [</span><span class="s5">20</span><span class="s2">]], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;mu, q, expected&quot;</span><span class="s2">,</span>
                         <span class="s2">[[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">120</span><span class="s2">, -</span><span class="s5">1.240089881791596e-38</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s5">1500</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">86.61466680572661</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_nbinom_11465</span><span class="s2">(</span><span class="s1">mu</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s3"># test nbinom.logcdf at extreme tails</span>
    <span class="s1">size </span><span class="s2">= </span><span class="s5">20</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">size</span><span class="s2">, </span><span class="s1">size</span><span class="s2">/(</span><span class="s1">size</span><span class="s2">+</span><span class="s1">mu</span><span class="s2">)</span>
    <span class="s3"># In R:</span>
    <span class="s3"># options(digits=16)</span>
    <span class="s3"># pnbinom(mu=10, size=20, q=120, log.p=TRUE)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nbinom</span><span class="s2">.</span><span class="s1">logcdf</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gh_17146</span><span class="s2">():</span>
    <span class="s3"># Check that discrete distributions return PMF of zero at non-integral x.</span>
    <span class="s3"># See gh-17146.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">11</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s5">0.8</span>
    <span class="s1">pmf </span><span class="s2">= </span><span class="s1">bernoulli</span><span class="s2">(</span><span class="s1">p</span><span class="s2">).</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">% </span><span class="s5">1 </span><span class="s2">== </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s5">1</span><span class="s2">-</span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">[~</span><span class="s1">i</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBetaNBinom</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'x, n, a, b, ref'</span><span class="s2">,</span>
                            <span class="s2">[[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5e6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">1.1520944824139114e-107</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s5">100</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">0.002855762954310226</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s5">10000</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">1.9648515726019154e-05</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_betanbinom_pmf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
        <span class="s3"># test that PMF stays accurate in the distribution tails</span>
        <span class="s3"># reference values computed with mpmath</span>
        <span class="s3"># from mpmath import mp</span>
        <span class="s3"># mp.dps = 500</span>
        <span class="s3"># def betanbinom_pmf(k, n, a, b):</span>
        <span class="s3">#     k = mp.mpf(k)</span>
        <span class="s3">#     a = mp.mpf(a)</span>
        <span class="s3">#     b = mp.mpf(b)</span>
        <span class="s3">#     n = mp.mpf(n)</span>
        <span class="s3">#     return float(mp.binomial(n + k - mp.one, k)</span>
        <span class="s3">#                  * mp.beta(a + n, b + k) / mp.beta(a, b))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">betanbinom</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-10</span><span class="s2">)</span>


    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'n, a, b, ref'</span><span class="s2">,</span>
                            <span class="s2">[[</span><span class="s5">10000</span><span class="s2">, </span><span class="s5">5000</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">0.12841520515722202</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">7.9224400871459695</span><span class="s2">],</span>
                            <span class="s2">[</span><span class="s5">100</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">1.5849602176622748</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_betanbinom_kurtosis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
        <span class="s3"># reference values were computed via mpmath</span>
        <span class="s3"># from mpmath import mp</span>
        <span class="s3"># def kurtosis_betanegbinom(n, a, b):</span>
        <span class="s3">#     n = mp.mpf(n)</span>
        <span class="s3">#     a = mp.mpf(a)</span>
        <span class="s3">#     b = mp.mpf(b)</span>
        <span class="s3">#     four = mp.mpf(4.)</span>
        <span class="s3">#     mean = n * b / (a - mp.one)</span>
        <span class="s3">#     var = (n * b * (n + a - 1.) * (a + b - 1.)</span>
        <span class="s3">#            / ((a - 2.) * (a - 1.)**2.))</span>
        <span class="s3">#     def f(k):</span>
        <span class="s3">#         return (mp.binomial(n + k - mp.one, k)</span>
        <span class="s3">#                 * mp.beta(a + n, b + k) / mp.beta(a, b)</span>
        <span class="s3">#                 * (k - mean)**four)</span>
        <span class="s3">#      fourth_moment = mp.nsum(f, [0, mp.inf])</span>
        <span class="s3">#      return float(fourth_moment/var**2 - 3.)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">betanbinom</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">moments</span><span class="s2">=</span><span class="s4">&quot;k&quot;</span><span class="s2">),</span>
                        <span class="s1">ref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">3e-15</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestZipf</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_gh20692</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that int32 data for k generates same output as double</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">)</span>
        <span class="s1">k_int32 </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">zipf</span><span class="s2">(</span><span class="s5">9</span><span class="s2">)</span>
        <span class="s1">pmf </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">pmf_k_int32 </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pmf</span><span class="s2">(</span><span class="s1">k_int32</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">pmf</span><span class="s2">, </span><span class="s1">pmf_k_int32</span><span class="s2">)</span></pre>
</body>
</html>