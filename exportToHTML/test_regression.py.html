<html>
<head>
<title>test_regression.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_regression.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">optimize</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">special </span><span class="s0">import </span><span class="s1">factorial</span><span class="s2">, </span><span class="s1">xlogy</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">dummy </span><span class="s0">import </span><span class="s1">DummyRegressor</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">UndefinedMetricWarning</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">d2_absolute_error_score</span><span class="s2">,</span>
    <span class="s1">d2_pinball_score</span><span class="s2">,</span>
    <span class="s1">d2_tweedie_score</span><span class="s2">,</span>
    <span class="s1">explained_variance_score</span><span class="s2">,</span>
    <span class="s1">make_scorer</span><span class="s2">,</span>
    <span class="s1">max_error</span><span class="s2">,</span>
    <span class="s1">mean_absolute_error</span><span class="s2">,</span>
    <span class="s1">mean_absolute_percentage_error</span><span class="s2">,</span>
    <span class="s1">mean_pinball_loss</span><span class="s2">,</span>
    <span class="s1">mean_squared_error</span><span class="s2">,</span>
    <span class="s1">mean_squared_log_error</span><span class="s2">,</span>
    <span class="s1">mean_tweedie_deviance</span><span class="s2">,</span>
    <span class="s1">median_absolute_error</span><span class="s2">,</span>
    <span class="s1">r2_score</span><span class="s2">,</span>
    <span class="s1">root_mean_squared_error</span><span class="s2">,</span>
    <span class="s1">root_mean_squared_log_error</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">_regression </span><span class="s0">import </span><span class="s1">_check_reg_targets</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">GridSearchCV</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_regression_metrics</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s3">50</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">y_true </span><span class="s2">+ </span><span class="s3">1</span>
    <span class="s1">y_pred_2 </span><span class="s2">= </span><span class="s1">y_true </span><span class="s2">- </span><span class="s3">1</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_squared_log_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">),</span>
        <span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_true</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_pred</span><span class="s2">)),</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred_2</span><span class="s2">), </span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.4</span><span class="s2">), </span><span class="s3">0.6</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred_2</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.4</span><span class="s2">), </span><span class="s3">0.4</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">median_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">mape </span><span class="s2">= </span><span class="s1">mean_absolute_percentage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">mape</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mape </span><span class="s2">&gt; </span><span class="s3">1e6</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">max_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">0.995</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s3">0.995</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s3">1.0</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">0</span><span class="s2">),</span>
        <span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">0</span><span class="s2">), </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">dev_median </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_true </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">median</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_absolute_error_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">),</span>
        <span class="s3">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_true </span><span class="s2">- </span><span class="s1">y_pred</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">() / </span><span class="s1">dev_median</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s3">0.2</span>
    <span class="s1">pinball_loss </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">: </span><span class="s1">alpha </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span>
        <span class="s1">y_true </span><span class="s2">- </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s3">0</span>
    <span class="s2">) + (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">alpha</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">y_pred </span><span class="s2">- </span><span class="s1">y_true</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">y_quantile </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">percentile</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">q</span><span class="s2">=</span><span class="s1">alpha </span><span class="s2">* </span><span class="s3">100</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">),</span>
        <span class="s3">1</span>
        <span class="s2">- </span><span class="s1">pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s2">/ </span><span class="s1">pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_quantile</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(),</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_absolute_error_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">),</span>
        <span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s4"># Tweedie deviance needs positive y_pred, except for p=0,</span>
    <span class="s4"># p&gt;=2 needs positive y_true</span>
    <span class="s4"># results evaluated by sympy</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">y_true</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">n_samples</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">),</span>
        <span class="s3">5 </span><span class="s2">/ </span><span class="s3">12 </span><span class="s2">* </span><span class="s1">n </span><span class="s2">* (</span><span class="s1">n</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), (</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">) * (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">2</span><span class="s2">))</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2</span><span class="s2">), </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">2</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">3 </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">),</span>
        <span class="s2">((</span><span class="s3">6 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2</span><span class="s2">) - </span><span class="s3">8</span><span class="s2">) / </span><span class="s1">n</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(),</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">/ </span><span class="s1">y_true</span><span class="s2">) / (</span><span class="s3">4 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">dev_mean </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">xlogy</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">y_true </span><span class="s2">/ (</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)))</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">1</span><span class="s2">),</span>
        <span class="s3">1 </span><span class="s2">- (</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">) * (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)) / </span><span class="s1">dev_mean</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">dev_mean </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">((</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">) / </span><span class="s3">2</span><span class="s2">) - </span><span class="s3">2 </span><span class="s2">/ </span><span class="s1">n </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">factorial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2</span><span class="s2">), </span><span class="s3">1 </span><span class="s2">- (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">2</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">) / </span><span class="s1">dev_mean</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_root_mean_squared_error_multioutput_raw_value</span><span class="s2">():</span>
    <span class="s4"># non-regression test for</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/pull/16323</span>
    <span class="s1">mse </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">10</span><span class="s2">]], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">rmse </span><span class="s2">= </span><span class="s1">root_mean_squared_error</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">10</span><span class="s2">]], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">mse</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">rmse</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multioutput_regression</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, (</span><span class="s3">1.0 </span><span class="s2">/ </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">2.0 </span><span class="s2">/ </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">2.0 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">) / </span><span class="s3">4.0</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">root_mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">0.454</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">mean_squared_log_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">0.200</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">root_mean_squared_log_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">0.315</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># mean_absolute_error and mean_squared_error are equal because</span>
    <span class="s4"># it is a binary problem.</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, (</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">2.0 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">) / </span><span class="s3">4.0</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, (</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">2.0 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">) / </span><span class="s3">8.0</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">around</span><span class="s2">(</span><span class="s1">mean_absolute_percentage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s1">decimals</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">error</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">error </span><span class="s2">&gt; </span><span class="s3">1e6</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">median_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, (</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">1.0</span><span class="s2">) / </span><span class="s3">4.0</span><span class="s2">)</span>

    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">1.0 </span><span class="s2">- </span><span class="s3">5.0 </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, -</span><span class="s3">0.875</span><span class="s2">)</span>

    <span class="s1">score </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">raw_expected_score </span><span class="s2">= [</span>
        <span class="s3">1</span>
        <span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">] - </span><span class="s1">y_pred</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">]).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">] - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">median</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])).</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s2">]</span>
    <span class="s4"># in the last case, the denominator vanishes and hence we get nan,</span>
    <span class="s4"># but since the numerator vanishes as well the expected score is 1.0</span>
    <span class="s1">raw_expected_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">raw_expected_score</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s1">raw_expected_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">score</span><span class="s2">, </span><span class="s1">raw_expected_score</span><span class="s2">)</span>

    <span class="s1">score </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">score</span><span class="s2">, </span><span class="s1">raw_expected_score</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">())</span>
    <span class="s4"># constant `y_true` with force_finite=True leads to 1. or 0.</span>
    <span class="s1">yc </span><span class="s2">= [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">]</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">yc</span><span class="s2">, [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">yc</span><span class="s2">, [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">5.1</span><span class="s2">], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">)</span>

    <span class="s4"># Setting force_finite=False results in the nan for 4th output propagating</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

    <span class="s4"># Dropping the 4th output to check `force_finite=False` for nominal</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">[:, :-</span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">y_pred</span><span class="s2">[:, :-</span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">)</span>
    <span class="s1">error2 </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">error2</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">)</span>
    <span class="s1">error2 </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">error2</span><span class="s2">)</span>

    <span class="s4"># constant `y_true` with force_finite=False leads to NaN or -Inf.</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span>
        <span class="s1">yc</span><span class="s2">, [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">error </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span>
        <span class="s1">yc</span><span class="s2">, [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;variance_weighted&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_regression_metrics_at_limits</span><span class="s2">():</span>
    <span class="s4"># Single-sample case</span>
    <span class="s4"># Note: for r2 and d2_tweedie see also test_regression_single_sample</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">root_mean_squared_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_squared_log_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_absolute_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_pinball_loss</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_absolute_percentage_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">median_absolute_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">max_error</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">explained_variance_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">]), </span><span class="s3">1.0</span><span class="s2">)</span>

    <span class="s4"># Perfect cases</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">r2_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]), </span><span class="s3">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">d2_pinball_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]), </span><span class="s3">1.0</span><span class="s2">)</span>

    <span class="s4"># Non-finite cases</span>
    <span class="s4"># R² and explained variance have a fix by default for non-finite cases</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s2">(</span><span class="s1">r2_score</span><span class="s2">, </span><span class="s1">explained_variance_score</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]), </span><span class="s3">0.0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]), </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Mean Squared Logarithmic Error cannot be used when targets &quot;</span>
        <span class="s5">&quot;contain negative values.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_squared_log_error</span><span class="s2">([-</span><span class="s3">1.0</span><span class="s2">], [-</span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Mean Squared Logarithmic Error cannot be used when targets &quot;</span>
        <span class="s5">&quot;contain negative values.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_squared_log_error</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Mean Squared Logarithmic Error cannot be used when targets &quot;</span>
        <span class="s5">&quot;contain negative values.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_squared_log_error</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Root Mean Squared Logarithmic Error cannot be used when targets &quot;</span>
        <span class="s5">&quot;contain negative values.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">root_mean_squared_log_error</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])</span>

    <span class="s4"># Tweedie deviance error</span>
    <span class="s1">power </span><span class="s2">= -</span><span class="s3">1.2</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">), </span><span class="s3">2 </span><span class="s2">/ (</span><span class="s3">2 </span><span class="s2">- </span><span class="s1">power</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-3</span>
    <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;can only be used on strictly positive y_pred.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s3">0</span><span class="s2">), </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">power </span><span class="s2">= </span><span class="s3">1.0</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;only be used on non-negative y and strictly positive y_pred.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>

    <span class="s1">power </span><span class="s2">= </span><span class="s3">1.5</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">), </span><span class="s3">2 </span><span class="s2">/ (</span><span class="s3">2 </span><span class="s2">- </span><span class="s1">power</span><span class="s2">))</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;only be used on non-negative y and strictly positive y_pred.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>

    <span class="s1">power </span><span class="s2">= </span><span class="s3">2.0</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">), </span><span class="s3">0.00</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;can only be used on strictly positive y and y_pred.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>

    <span class="s1">power </span><span class="s2">= </span><span class="s3">3.0</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">), </span><span class="s3">0.00</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;can only be used on strictly positive y and y_pred.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">d2_tweedie_score</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s1">power</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__check_reg_targets</span><span class="s2">():</span>
    <span class="s4"># All of length 3</span>
    <span class="s1">EXAMPLES </span><span class="s2">= [</span>
        <span class="s2">(</span><span class="s5">&quot;continuous&quot;</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;continuous&quot;</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">]], </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;continuous-multioutput&quot;</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s3">2</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;continuous-multioutput&quot;</span><span class="s2">, [[</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s3">2</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;continuous-multioutput&quot;</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s3">3</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s2">(</span><span class="s1">type1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">n_out1</span><span class="s2">), (</span><span class="s1">type2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">n_out2</span><span class="s2">) </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">EXAMPLES</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s3">2</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">type1 </span><span class="s2">== </span><span class="s1">type2 </span><span class="s0">and </span><span class="s1">n_out1 </span><span class="s2">== </span><span class="s1">n_out2</span><span class="s2">:</span>
            <span class="s1">y_type</span><span class="s2">, </span><span class="s1">y_check1</span><span class="s2">, </span><span class="s1">y_check2</span><span class="s2">, </span><span class="s1">multioutput </span><span class="s2">= </span><span class="s1">_check_reg_targets</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">type1 </span><span class="s2">== </span><span class="s1">y_type</span>
            <span class="s0">if </span><span class="s1">type1 </span><span class="s2">== </span><span class="s5">&quot;continuous&quot;</span><span class="s2">:</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_check1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, (-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_check2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">, (-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_check1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_check2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s1">_check_reg_targets</span><span class="s2">(</span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__check_reg_targets_exception</span><span class="s2">():</span>
    <span class="s1">invalid_multioutput </span><span class="s2">= </span><span class="s5">&quot;this_value_is_not_valid&quot;</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s5">&quot;Allowed 'multioutput' string values are.+You provided multioutput={!r}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
            <span class="s1">invalid_multioutput</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">_check_reg_targets</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">]], </span><span class="s1">invalid_multioutput</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_regression_multioutput_array</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">4.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">]]</span>
    <span class="s1">y_pred </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6.5</span><span class="s2">]]</span>

    <span class="s1">mse </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>

    <span class="s1">pbl </span><span class="s2">= </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">mape </span><span class="s2">= </span><span class="s1">mean_absolute_percentage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">evs </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">d2ps </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">evs2 </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mse</span><span class="s2">, [</span><span class="s3">0.125</span><span class="s2">, </span><span class="s3">0.5625</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mae</span><span class="s2">, [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.625</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">pbl</span><span class="s2">, [</span><span class="s3">0.25 </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.625 </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mape</span><span class="s2">, [</span><span class="s3">0.0778</span><span class="s2">, </span><span class="s3">0.2262</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0.95</span><span class="s2">, </span><span class="s3">0.93</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs</span><span class="s2">, [</span><span class="s3">0.95</span><span class="s2">, </span><span class="s3">0.93</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">d2ps</span><span class="s2">, [</span><span class="s3">0.833</span><span class="s2">, </span><span class="s3">0.722</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs2</span><span class="s2">, [</span><span class="s3">0.95</span><span class="s2">, </span><span class="s3">0.93</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># mean_absolute_error and mean_squared_error are equal because</span>
    <span class="s4"># it is a binary problem.</span>
    <span class="s1">y_true </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]] * </span><span class="s3">4</span>
    <span class="s1">y_pred </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]] * </span><span class="s3">4</span>
    <span class="s1">mse </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">mae </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">pbl </span><span class="s2">= </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">d2ps </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mse</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mae</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">pbl</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">d2ps</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">r </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">3.5</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">r2_score</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span>
    <span class="s2">)</span>
    <span class="s1">evs </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1.25</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">evs2 </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]],</span>
        <span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">,</span>
        <span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs2</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.25</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># Checking for the condition in which both numerator and denominator is</span>
    <span class="s4"># zero.</span>
    <span class="s1">y_true </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">y_pred </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) == </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">)</span>
    <span class="s1">r22 </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r22</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r22</span><span class="s2">),</span>
        <span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;uniform_average&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s1">evs </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">evs</span><span class="s2">) == </span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">d2ps </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">d2ps</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">evs2 </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evs2</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">evs2</span><span class="s2">), </span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s4"># Handling msle separately as it does not accept negative inputs.</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">]])</span>
    <span class="s1">msle </span><span class="s2">= </span><span class="s1">mean_squared_log_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">msle2 </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_true</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">msle</span><span class="s2">, </span><span class="s1">msle2</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_regression_custom_weights</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">4.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">]]</span>
    <span class="s1">y_pred </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6.5</span><span class="s2">]]</span>

    <span class="s1">msew </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">rmsew </span><span class="s2">= </span><span class="s1">root_mean_squared_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">maew </span><span class="s2">= </span><span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">mapew </span><span class="s2">= </span><span class="s1">mean_absolute_percentage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">rw </span><span class="s2">= </span><span class="s1">r2_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">evsw </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">d2psw </span><span class="s2">= </span><span class="s1">d2_pinball_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">])</span>
    <span class="s1">evsw2 </span><span class="s2">= </span><span class="s1">explained_variance_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">], </span><span class="s1">force_finite</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">msew</span><span class="s2">, </span><span class="s3">0.39</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">rmsew</span><span class="s2">, </span><span class="s3">0.59</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">maew</span><span class="s2">, </span><span class="s3">0.475</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">mapew</span><span class="s2">, </span><span class="s3">0.1668</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">rw</span><span class="s2">, </span><span class="s3">0.94</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">evsw</span><span class="s2">, </span><span class="s3">0.94</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">d2psw</span><span class="s2">, </span><span class="s3">0.766</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">evsw2</span><span class="s2">, </span><span class="s3">0.94</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># Handling msle separately as it does not accept negative inputs.</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">]])</span>
    <span class="s1">msle </span><span class="s2">= </span><span class="s1">mean_squared_log_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">])</span>
    <span class="s1">msle2 </span><span class="s2">= </span><span class="s1">mean_squared_error</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_true</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">y_pred</span><span class="s2">), </span><span class="s1">multioutput</span><span class="s2">=[</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">msle</span><span class="s2">, </span><span class="s1">msle2</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;metric&quot;</span><span class="s2">, [</span><span class="s1">r2_score</span><span class="s2">, </span><span class="s1">d2_tweedie_score</span><span class="s2">, </span><span class="s1">d2_pinball_score</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_regression_single_sample</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y_pred </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">warning_msg </span><span class="s2">= </span><span class="s5">&quot;not well-defined with less than two samples.&quot;</span>

    <span class="s4"># Trigger the warning</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warning_msg</span><span class="s2">):</span>
        <span class="s1">score </span><span class="s2">= </span><span class="s1">metric</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tweedie_deviance_continuity</span><span class="s2">():</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">100</span>

    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">).</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">) + </span><span class="s3">0.1</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">) + </span><span class="s3">0.1</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">0 </span><span class="s2">- </span><span class="s3">1e-10</span><span class="s2">),</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">0</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s4"># Ws we get closer to the limit, with 1e-12 difference the absolute</span>
    <span class="s4"># tolerance to pass the below check increases. There are likely</span>
    <span class="s4"># numerical precision issues on the edges of different definition</span>
    <span class="s4"># regions.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1e-10</span><span class="s2">),</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">1</span><span class="s2">),</span>
        <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1e-10</span><span class="s2">),</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2</span><span class="s2">),</span>
        <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1e-10</span><span class="s2">),</span>
        <span class="s1">mean_tweedie_deviance</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">power</span><span class="s2">=</span><span class="s3">2</span><span class="s2">),</span>
        <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mean_absolute_percentage_error</span><span class="s2">():</span>
    <span class="s1">random_number_generator </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">random_number_generator</span><span class="s2">.</span><span class="s1">exponential</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s3">100</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s3">1.2 </span><span class="s2">* </span><span class="s1">y_true</span>
    <span class="s0">assert </span><span class="s1">mean_absolute_percentage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;distribution&quot;</span><span class="s2">, [</span><span class="s5">&quot;normal&quot;</span><span class="s2">, </span><span class="s5">&quot;lognormal&quot;</span><span class="s2">, </span><span class="s5">&quot;exponential&quot;</span><span class="s2">, </span><span class="s5">&quot;uniform&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;target_quantile&quot;</span><span class="s2">, [</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_mean_pinball_loss_on_constant_predictions</span><span class="s2">(</span><span class="s1">distribution</span><span class="s2">, </span><span class="s1">target_quantile</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s5">&quot;quantile&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
            <span class="s5">&quot;This test requires a more recent version of numpy &quot;</span>
            <span class="s5">&quot;with support for np.quantile.&quot;</span>
        <span class="s2">)</span>

    <span class="s4"># Check that the pinball loss is minimized by the empirical quantile.</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">3000</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">distribution</span><span class="s2">)(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s4"># Compute the best possible pinball loss for any constant predictor:</span>
    <span class="s1">best_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">quantile</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">target_quantile</span><span class="s2">)</span>
    <span class="s1">best_constant_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">best_pred</span><span class="s2">)</span>
    <span class="s1">best_pbl </span><span class="s2">= </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">best_constant_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">target_quantile</span><span class="s2">)</span>

    <span class="s4"># Evaluate the loss on a grid of quantiles</span>
    <span class="s1">candidate_predictions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">quantile</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">100</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">pred </span><span class="s0">in </span><span class="s1">candidate_predictions</span><span class="s2">:</span>
        <span class="s4"># Compute the pinball loss of a constant predictor:</span>
        <span class="s1">constant_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">)</span>
        <span class="s1">pbl </span><span class="s2">= </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">constant_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">target_quantile</span><span class="s2">)</span>

        <span class="s4"># Check that the loss of this constant predictor is greater or equal</span>
        <span class="s4"># than the loss of using the optimal quantile (up to machine</span>
        <span class="s4"># precision):</span>
        <span class="s0">assert </span><span class="s1">pbl </span><span class="s2">&gt;= </span><span class="s1">best_pbl </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">best_pbl</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>

        <span class="s4"># Check that the value of the pinball loss matches the analytical</span>
        <span class="s4"># formula.</span>
        <span class="s1">expected_pbl </span><span class="s2">= (</span><span class="s1">pred </span><span class="s2">- </span><span class="s1">data</span><span class="s2">[</span><span class="s1">data </span><span class="s2">&lt; </span><span class="s1">pred</span><span class="s2">]).</span><span class="s1">sum</span><span class="s2">() * (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">target_quantile</span><span class="s2">) + (</span>
            <span class="s1">data</span><span class="s2">[</span><span class="s1">data </span><span class="s2">&gt;= </span><span class="s1">pred</span><span class="s2">] - </span><span class="s1">pred</span>
        <span class="s2">).</span><span class="s1">sum</span><span class="s2">() * </span><span class="s1">target_quantile</span>
        <span class="s1">expected_pbl </span><span class="s2">/= </span><span class="s1">n_samples</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">expected_pbl</span><span class="s2">, </span><span class="s1">pbl</span><span class="s2">)</span>

    <span class="s4"># Check that we can actually recover the target_quantile by minimizing the</span>
    <span class="s4"># pinball loss w.r.t. the constant prediction quantile.</span>
    <span class="s0">def </span><span class="s1">objective_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">constant_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">constant_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">target_quantile</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">minimize</span><span class="s2">(</span><span class="s1">objective_func</span><span class="s2">, </span><span class="s1">data</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">method</span><span class="s2">=</span><span class="s5">&quot;Nelder-Mead&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">success</span>
    <span class="s4"># The minimum is not unique with limited data, hence the large tolerance.</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">best_pred</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">best_pbl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dummy_quantile_parameter_tuning</span><span class="s2">():</span>
    <span class="s4"># Integration test to check that it is possible to use the pinball loss to</span>
    <span class="s4"># tune the hyperparameter of a quantile regressor. This is conceptually</span>
    <span class="s4"># similar to the previous test but using the scikit-learn estimator and</span>
    <span class="s4"># scoring API instead.</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">1000</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))  </span><span class="s4"># Ignored</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">exponential</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s1">all_quantiles </span><span class="s2">= [</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">0.95</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">alpha </span><span class="s0">in </span><span class="s1">all_quantiles</span><span class="s2">:</span>
        <span class="s1">neg_mean_pinball_loss </span><span class="s2">= </span><span class="s1">make_scorer</span><span class="s2">(</span>
            <span class="s1">mean_pinball_loss</span><span class="s2">,</span>
            <span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">greater_is_better</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">regressor </span><span class="s2">= </span><span class="s1">DummyRegressor</span><span class="s2">(</span><span class="s1">strategy</span><span class="s2">=</span><span class="s5">&quot;quantile&quot;</span><span class="s2">, </span><span class="s1">quantile</span><span class="s2">=</span><span class="s3">0.25</span><span class="s2">)</span>
        <span class="s1">grid_search </span><span class="s2">= </span><span class="s1">GridSearchCV</span><span class="s2">(</span>
            <span class="s1">regressor</span><span class="s2">,</span>
            <span class="s1">param_grid</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">quantile</span><span class="s2">=</span><span class="s1">all_quantiles</span><span class="s2">),</span>
            <span class="s1">scoring</span><span class="s2">=</span><span class="s1">neg_mean_pinball_loss</span><span class="s2">,</span>
        <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">grid_search</span><span class="s2">.</span><span class="s1">best_params_</span><span class="s2">[</span><span class="s5">&quot;quantile&quot;</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pinball_loss_relation_with_mae</span><span class="s2">():</span>
    <span class="s4"># Test that mean_pinball loss with alpha=0.5 if half of mean absolute error</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">714</span><span class="s2">)</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">100</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">() + </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">mean_absolute_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
        <span class="s2">== </span><span class="s1">mean_pinball_loss</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">) * </span><span class="s3">2</span>
    <span class="s2">)</span>


<span class="s4"># TODO(1.6): remove this test</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;metric&quot;</span><span class="s2">, [</span><span class="s1">mean_squared_error</span><span class="s2">, </span><span class="s1">mean_squared_log_error</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_mean_squared_deprecation_squared</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the deprecation warning of the squared parameter&quot;&quot;&quot;</span>
    <span class="s1">depr_msg </span><span class="s2">= </span><span class="s5">&quot;'squared' is deprecated in version 1.4 and will be removed in 1.6.&quot;</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">depr_msg</span><span class="s2">):</span>
        <span class="s1">metric</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s4"># TODO(1.6): remove this test</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:'squared' is deprecated&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;old_func, new_func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">mean_squared_error</span><span class="s2">, </span><span class="s1">root_mean_squared_error</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">mean_squared_log_error</span><span class="s2">, </span><span class="s1">root_mean_squared_log_error</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rmse_rmsle_parameter</span><span class="s2">(</span><span class="s1">old_func</span><span class="s2">, </span><span class="s1">new_func</span><span class="s2">):</span>
    <span class="s4"># Check that the new rmse/rmsle function is equivalent to</span>
    <span class="s4"># the old mse/msle + squared=False function.</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">]])</span>
    <span class="s1">sw </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">))</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">old_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">new_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">old_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">new_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">old_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">new_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">old_func</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">, </span><span class="s1">squared</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">new_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw</span><span class="s2">, </span><span class="s1">multioutput</span><span class="s2">=</span><span class="s5">&quot;raw_values&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>
</pre>
</body>
</html>