<html>
<head>
<title>optionfiles.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
optionfiles.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2014, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s0"># mypy: disable-error-code=&quot;attr-defined&quot;</span>

<span class="s2">&quot;&quot;&quot;Implements parser to parse MySQL option files.&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">codecs</span>
<span class="s3">import </span><span class="s1">io</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>

<span class="s3">from </span><span class="s1">configparser </span><span class="s3">import </span><span class="s1">ConfigParser </span><span class="s3">as </span><span class="s1">SafeConfigParser</span><span class="s4">, </span><span class="s1">MissingSectionHeaderError</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">constants </span><span class="s3">import </span><span class="s1">CNX_POOL_ARGS</span><span class="s4">, </span><span class="s1">DEFAULT_CONFIGURATION</span>

<span class="s1">DEFAULT_EXTENSIONS</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, ...]] = {</span>
    <span class="s5">&quot;nt&quot;</span><span class="s4">: (</span><span class="s5">&quot;ini&quot;</span><span class="s4">, </span><span class="s5">&quot;cnf&quot;</span><span class="s4">),</span>
    <span class="s5">&quot;posix&quot;</span><span class="s4">: (</span><span class="s5">&quot;cnf&quot;</span><span class="s4">,),</span>
<span class="s4">}</span>


<span class="s3">def </span><span class="s1">read_option_files</span><span class="s4">(**</span><span class="s1">config</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]]) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot; 
    Read option files for connection parameters. 
 
    Checks if connection arguments contain option file arguments, and then 
    reads option files accordingly. 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s5">&quot;option_files&quot; </span><span class="s3">in </span><span class="s1">config</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_groups&quot;</span><span class="s4">], </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_groups&quot;</span><span class="s4">] = [</span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_groups&quot;</span><span class="s4">]]</span>
            <span class="s1">groups </span><span class="s4">= </span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_groups&quot;</span><span class="s4">]</span>
            <span class="s3">del </span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_groups&quot;</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s1">groups </span><span class="s4">= [</span><span class="s5">&quot;client&quot;</span><span class="s4">, </span><span class="s5">&quot;connector_python&quot;</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_files&quot;</span><span class="s4">], </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_files&quot;</span><span class="s4">] = [</span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_files&quot;</span><span class="s4">]]</span>
        <span class="s1">option_parser </span><span class="s4">= </span><span class="s1">MySQLOptionsParser</span><span class="s4">(</span>
            <span class="s1">list</span><span class="s4">(</span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_files&quot;</span><span class="s4">]), </span><span class="s1">keep_dashes</span><span class="s4">=</span><span class="s3">False</span>
        <span class="s4">)</span>
        <span class="s3">del </span><span class="s1">config</span><span class="s4">[</span><span class="s5">&quot;option_files&quot;</span><span class="s4">]</span>

        <span class="s1">config_from_file </span><span class="s4">= </span><span class="s1">option_parser</span><span class="s4">.</span><span class="s1">get_groups_as_dict_with_priority</span><span class="s4">(*</span><span class="s1">groups</span><span class="s4">)</span>
        <span class="s1">config_options</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]] = {}</span>
        <span class="s3">for </span><span class="s1">group </span><span class="s3">in </span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">option</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">config_from_file</span><span class="s4">[</span><span class="s1">group</span><span class="s4">].</span><span class="s1">items</span><span class="s4">():</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">option </span><span class="s4">== </span><span class="s5">&quot;socket&quot;</span><span class="s4">:</span>
                            <span class="s1">option </span><span class="s4">= </span><span class="s5">&quot;unix_socket&quot;</span>

                        <span class="s3">if </span><span class="s1">option </span><span class="s3">not in </span><span class="s1">CNX_POOL_ARGS </span><span class="s3">and </span><span class="s1">option </span><span class="s4">!= </span><span class="s5">&quot;failover&quot;</span><span class="s4">:</span>
                            <span class="s1">_ </span><span class="s4">= </span><span class="s1">DEFAULT_CONFIGURATION</span><span class="s4">[</span><span class="s1">option</span><span class="s4">]</span>

                        <span class="s3">if </span><span class="s4">(</span>
                            <span class="s1">option </span><span class="s3">not in </span><span class="s1">config_options</span>
                            <span class="s3">or </span><span class="s1">config_options</span><span class="s4">[</span><span class="s1">option</span><span class="s4">][</span><span class="s6">1</span><span class="s4">] &lt;= </span><span class="s1">value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
                        <span class="s4">):</span>
                            <span class="s1">config_options</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">value</span>
                    <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">group </span><span class="s4">== </span><span class="s5">&quot;connector_python&quot;</span><span class="s4">:</span>
                            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span>
                                <span class="s5">f&quot;Unsupported argument '</span><span class="s3">{</span><span class="s1">option</span><span class="s3">}</span><span class="s5">'&quot;</span>
                            <span class="s4">) </span><span class="s3">from None</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s3">continue</span>

        <span class="s1">not_evaluate </span><span class="s4">= (</span><span class="s5">&quot;password&quot;</span><span class="s4">, </span><span class="s5">&quot;passwd&quot;</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">option</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">config_options</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">option </span><span class="s3">not in </span><span class="s1">config</span><span class="s4">:</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">option </span><span class="s3">in </span><span class="s1">not_evaluate</span><span class="s4">:</span>
                        <span class="s1">config</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">config</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">eval</span><span class="s4">(</span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])  </span><span class="s0"># pylint: disable=eval-used</span>
                <span class="s3">except </span><span class="s4">(</span><span class="s1">NameError</span><span class="s4">, </span><span class="s1">SyntaxError</span><span class="s4">):</span>
                    <span class="s1">config</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">config</span>


<span class="s3">class </span><span class="s1">MySQLOptionsParser</span><span class="s4">(</span><span class="s1">SafeConfigParser</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;This class implements methods to parse MySQL option files&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">files</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">, </span><span class="s1">keep_dashes</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Initialize 
 
        If defaults is True, default option files are read first 
 
        Raises ValueError if defaults is set to True but defaults files 
        cannot be found. 
        &quot;&quot;&quot;</span>

        <span class="s0"># Regular expression to allow options with no value(For Python v2.6)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">optcre</span><span class="s4">: </span><span class="s1">re</span><span class="s4">.</span><span class="s1">Pattern </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span>
            <span class="s5">r&quot;(?P&lt;option&gt;[^:=\s][^:=]*)&quot;</span>
            <span class="s5">r&quot;\s*(?:&quot;</span>
            <span class="s5">r&quot;(?P&lt;vi&gt;[:=])\s*&quot;</span>
            <span class="s5">r&quot;(?P&lt;value&gt;.*))?$&quot;</span>
        <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]]] = {}</span>

        <span class="s1">SafeConfigParser</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">strict</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">default_extension</span><span class="s4">: </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, ...] = </span><span class="s1">DEFAULT_EXTENSIONS</span><span class="s4">[</span><span class="s1">os</span><span class="s4">.</span><span class="s1">name</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keep_dashes</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s1">keep_dashes</span>

        <span class="s3">if not </span><span class="s1">files</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;files argument should be given&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">files</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = [</span><span class="s1">files</span><span class="s4">] </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">files</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">else </span><span class="s1">files</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_parse_options</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">files</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_sections</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_groups_as_dict</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">optionxform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">optionstr</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Converts option strings 
 
        Converts option strings to lower case and replaces dashes(-) with 
        underscores(_) if keep_dashes variable is set. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keep_dashes</span><span class="s4">:</span>
            <span class="s1">optionstr </span><span class="s4">= </span><span class="s1">optionstr</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;-&quot;</span><span class="s4">, </span><span class="s5">&quot;_&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">optionstr</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_parse_options</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">files</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Parse options from files given as arguments. 
         This method checks for !include or !inculdedir directives and if there 
         is any, those files included by these directives are also parsed 
         for options. 
 
        Raises ValueError if any of the included or file given in arguments 
        is not readable. 
        &quot;&quot;&quot;</span>
        <span class="s1">initial_files </span><span class="s4">= </span><span class="s1">files</span><span class="s4">[:]</span>
        <span class="s1">files </span><span class="s4">= []</span>
        <span class="s1">index </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">err_msg </span><span class="s4">= </span><span class="s5">&quot;Option file '{0}' being included again in file '{1}'&quot;</span>

        <span class="s3">for </span><span class="s1">file_ </span><span class="s3">in </span><span class="s1">initial_files</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">file_ </span><span class="s3">in </span><span class="s1">initial_files</span><span class="s4">[</span><span class="s1">index </span><span class="s4">+ </span><span class="s6">1 </span><span class="s4">:]:</span>
                    <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                        <span class="s5">f&quot;Same option file '</span><span class="s3">{</span><span class="s1">file_</span><span class="s3">}</span><span class="s5">' occurring more &quot;</span>
                        <span class="s5">&quot;than once in the list&quot;</span>
                    <span class="s4">)</span>
                <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">file_</span><span class="s4">, </span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">op_file</span><span class="s4">:</span>
                    <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">op_file</span><span class="s4">.</span><span class="s1">readlines</span><span class="s4">():</span>
                        <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!includedir&quot;</span><span class="s4">):</span>
                            <span class="s1">_</span><span class="s4">, </span><span class="s1">dir_path </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
                            <span class="s1">dir_path </span><span class="s4">= </span><span class="s1">dir_path</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>
                            <span class="s3">for </span><span class="s1">entry </span><span class="s3">in </span><span class="s1">os</span><span class="s4">.</span><span class="s1">listdir</span><span class="s4">(</span><span class="s1">dir_path</span><span class="s4">):</span>
                                <span class="s1">entry </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">dir_path</span><span class="s4">, </span><span class="s1">entry</span><span class="s4">)</span>
                                <span class="s3">if </span><span class="s1">entry </span><span class="s3">in </span><span class="s1">files</span><span class="s4">:</span>
                                    <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s1">err_msg</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">entry</span><span class="s4">, </span><span class="s1">file_</span><span class="s4">))</span>
                                <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isfile</span><span class="s4">(</span><span class="s1">entry</span><span class="s4">) </span><span class="s3">and </span><span class="s1">entry</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span>
                                    <span class="s1">self</span><span class="s4">.</span><span class="s1">default_extension</span>
                                <span class="s4">):</span>
                                    <span class="s1">files</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">entry</span><span class="s4">)</span>

                        <span class="s3">elif </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!include&quot;</span><span class="s4">):</span>
                            <span class="s1">_</span><span class="s4">, </span><span class="s1">filename </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
                            <span class="s1">filename </span><span class="s4">= </span><span class="s1">filename</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>
                            <span class="s3">if </span><span class="s1">filename </span><span class="s3">in </span><span class="s1">files</span><span class="s4">:</span>
                                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s1">err_msg</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">file_</span><span class="s4">))</span>
                            <span class="s1">files</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>

                    <span class="s1">index </span><span class="s4">+= </span><span class="s6">1</span>
                    <span class="s1">files</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">file_</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">IOError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;Failed reading file '</span><span class="s3">{</span><span class="s1">file_</span><span class="s3">}</span><span class="s5">': </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">read_files </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">files</span><span class="s4">)</span>
        <span class="s1">not_read_files </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">files</span><span class="s4">) - </span><span class="s1">set</span><span class="s4">(</span><span class="s1">read_files</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">not_read_files</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;File(s) </span><span class="s3">{</span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">not_read_files</span><span class="s4">)</span><span class="s3">} </span><span class="s5">could not be read.&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">read</span><span class="s4">(  </span><span class="s0"># type: ignore[override]</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">filenames</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]], </span><span class="s1">encoding</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Read and parse a filename or a list of filenames. 
 
        Overridden from ConfigParser and modified so as to allow options 
        which are not inside any section header 
 
        Return list of successfully read files. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">filenames</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">filenames </span><span class="s4">= [</span><span class="s1">filenames</span><span class="s4">]</span>
        <span class="s1">read_ok </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">priority</span><span class="s4">, </span><span class="s1">filename </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">filenames</span><span class="s4">):</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">out_file </span><span class="s4">= </span><span class="s1">io</span><span class="s4">.</span><span class="s1">StringIO</span><span class="s4">()</span>
                <span class="s3">with </span><span class="s1">codecs</span><span class="s4">.</span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">in_file</span><span class="s4">:</span>
                    <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">in_file</span><span class="s4">:</span>
                        <span class="s1">line </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>
                        <span class="s0"># Skip lines that begin with &quot;!includedir&quot; or &quot;!include&quot;</span>
                        <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!include&quot;</span><span class="s4">):</span>
                            <span class="s3">continue</span>

                        <span class="s1">match_obj </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">optcre</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>
                        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">SECTCRE</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) </span><span class="s3">and </span><span class="s1">match_obj</span><span class="s4">:</span>
                            <span class="s1">optname</span><span class="s4">, </span><span class="s1">delimiter</span><span class="s4">, </span><span class="s1">optval </span><span class="s4">= </span><span class="s1">match_obj</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span>
                                <span class="s5">&quot;option&quot;</span><span class="s4">, </span><span class="s5">&quot;vi&quot;</span><span class="s4">, </span><span class="s5">&quot;value&quot;</span>
                            <span class="s4">)</span>
                            <span class="s3">if </span><span class="s1">optname </span><span class="s3">and not </span><span class="s1">optval </span><span class="s3">and not </span><span class="s1">delimiter</span><span class="s4">:</span>
                                <span class="s1">out_file</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">line</span><span class="s3">}</span><span class="s5">=</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
                            <span class="s3">else</span><span class="s4">:</span>
                                <span class="s1">out_file</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">line</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
                        <span class="s3">else</span><span class="s4">:</span>
                            <span class="s1">out_file</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">line</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
                <span class="s1">out_file</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">IOError</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_read</span><span class="s4">(</span><span class="s1">out_file</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">)</span>
                <span class="s3">for </span><span class="s1">group </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_sections</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">():</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">]</span>
                    <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">] = {}</span>
                    <span class="s3">for </span><span class="s1">option</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_sections</span><span class="s4">[</span><span class="s1">group</span><span class="s4">].</span><span class="s1">items</span><span class="s4">():</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">][</span><span class="s1">option</span><span class="s4">] = (</span><span class="s1">value</span><span class="s4">, </span><span class="s1">priority</span><span class="s4">)</span>

                <span class="s1">self</span><span class="s4">.</span><span class="s1">_sections </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_dict</span><span class="s4">()</span>

            <span class="s3">except </span><span class="s1">MissingSectionHeaderError</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_read</span><span class="s4">(</span><span class="s1">out_file</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">)</span>
            <span class="s1">out_file</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
            <span class="s1">read_ok</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">read_ok</span>

    <span class="s3">def </span><span class="s1">get_groups</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Returns options as a dictionary. 
 
        Returns options from all the groups specified as arguments, returns 
        the options from all groups if no argument provided. Options are 
        overridden when they are found in the next group. 
 
        Returns a dictionary 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s1">args </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>

        <span class="s1">options </span><span class="s4">= {}</span>
        <span class="s1">priority</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">] = {}</span>
        <span class="s3">for </span><span class="s1">group </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">option</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s4">[</span>
                    <span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">,</span>
                        <span class="s1">value</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">].</span><span class="s1">items</span><span class="s4">()</span>
                    <span class="s3">if </span><span class="s1">key </span><span class="s4">!= </span><span class="s5">&quot;__name__&quot; </span><span class="s3">and not </span><span class="s1">key</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!&quot;</span><span class="s4">)</span>
                <span class="s4">]:</span>
                    <span class="s3">if </span><span class="s1">option </span><span class="s3">not in </span><span class="s1">options </span><span class="s3">or </span><span class="s1">priority</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] &lt;= </span><span class="s1">value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:</span>
                        <span class="s1">priority</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">value</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
                        <span class="s1">options</span><span class="s4">[</span><span class="s1">option</span><span class="s4">] = </span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s3">pass</span>

        <span class="s3">return </span><span class="s1">options</span>

    <span class="s3">def </span><span class="s1">get_groups_as_dict_with_priority</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]]]:</span>
        <span class="s2">&quot;&quot;&quot;Returns options as dictionary of dictionaries. 
 
        Returns options from all the groups specified as arguments. For each 
        group the option are contained in a dictionary. The order in which 
        the groups are specified is unimportant. Also options are not 
        overridden in between the groups. 
 
        The value is a tuple with two elements, first being the actual value 
        and second is the priority of the value which is higher for a value 
        read from a higher priority file. 
 
        Returns an dictionary of dictionaries 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s1">args </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>

        <span class="s1">options </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">group </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">options</span><span class="s4">[</span><span class="s1">group</span><span class="s4">] = </span><span class="s1">dict</span><span class="s4">(</span>
                    <span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">,</span>
                        <span class="s1">value</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">].</span><span class="s1">items</span><span class="s4">()</span>
                    <span class="s3">if </span><span class="s1">key </span><span class="s4">!= </span><span class="s5">&quot;__name__&quot; </span><span class="s3">and not </span><span class="s1">key</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!&quot;</span><span class="s4">)</span>
                <span class="s4">)</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s3">pass</span>
        <span class="s3">return </span><span class="s1">options</span>

    <span class="s3">def </span><span class="s1">get_groups_as_dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Returns options as dictionary of dictionaries. 
 
        Returns options from all the groups specified as arguments. For each 
        group the option are contained in a dictionary. The order in which 
        the groups are specified is unimportant. Also options are not 
        overridden in between the groups. 
 
        Returns an dictionary of dictionaries 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s1">args </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>

        <span class="s1">options </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">group </span><span class="s3">in </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">options</span><span class="s4">[</span><span class="s1">group</span><span class="s4">] = </span><span class="s1">dict</span><span class="s4">(</span>
                    <span class="s4">(</span>
                        <span class="s1">key</span><span class="s4">,</span>
                        <span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
                    <span class="s4">)</span>
                    <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_options_dict</span><span class="s4">[</span><span class="s1">group</span><span class="s4">].</span><span class="s1">items</span><span class="s4">()</span>
                    <span class="s3">if </span><span class="s1">key </span><span class="s4">!= </span><span class="s5">&quot;__name__&quot; </span><span class="s3">and not </span><span class="s1">key</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;!&quot;</span><span class="s4">)</span>
                <span class="s4">)</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s3">pass</span>

        <span class="s3">return </span><span class="s1">options</span>
</pre>
</body>
</html>