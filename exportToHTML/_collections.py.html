<html>
<head>
<title>_collections.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_collections.py</font>
</center></td></tr></table>
<pre><span class="s0"># util/_collections.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: allow-untyped-defs, allow-untyped-calls</span>

<span class="s2">&quot;&quot;&quot;Collection classes and helpers.&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">import </span><span class="s1">operator</span>
<span class="s3">import </span><span class="s1">threading</span>
<span class="s3">import </span><span class="s1">types</span>
<span class="s3">import </span><span class="s1">typing</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">cast</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Container</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Dict</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">FrozenSet</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Generic</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Iterable</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Iterator</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">List</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Mapping</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">NoReturn</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Optional</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">overload</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Sequence</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Set</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Tuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TypeVar</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Union</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">ValuesView</span>
<span class="s3">import </span><span class="s1">weakref</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">_has_cy </span><span class="s3">import </span><span class="s1">HAS_CYEXTENSION</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">typing </span><span class="s3">import </span><span class="s1">is_non_string_iterable</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Literal</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Protocol</span>

<span class="s3">if </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">TYPE_CHECKING </span><span class="s3">or not </span><span class="s1">HAS_CYEXTENSION</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">immutabledict </span><span class="s3">as </span><span class="s1">immutabledict</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">IdentitySet </span><span class="s3">as </span><span class="s1">IdentitySet</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">ReadOnlyContainer </span><span class="s3">as </span><span class="s1">ReadOnlyContainer</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">ImmutableDictBase </span><span class="s3">as </span><span class="s1">ImmutableDictBase</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">OrderedSet </span><span class="s3">as </span><span class="s1">OrderedSet</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">_py_collections </span><span class="s3">import </span><span class="s1">unique_list </span><span class="s3">as </span><span class="s1">unique_list</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">immutabledict </span><span class="s3">import </span><span class="s4">(</span>
        <span class="s1">ReadOnlyContainer </span><span class="s3">as </span><span class="s1">ReadOnlyContainer</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">immutabledict </span><span class="s3">import </span><span class="s4">(</span>
        <span class="s1">ImmutableDictBase </span><span class="s3">as </span><span class="s1">ImmutableDictBase</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">immutabledict </span><span class="s3">import </span><span class="s4">(</span>
        <span class="s1">immutabledict </span><span class="s3">as </span><span class="s1">immutabledict</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">collections </span><span class="s3">import </span><span class="s1">IdentitySet </span><span class="s3">as </span><span class="s1">IdentitySet</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">collections </span><span class="s3">import </span><span class="s1">OrderedSet </span><span class="s3">as </span><span class="s1">OrderedSet</span>
    <span class="s3">from </span><span class="s1">sqlalchemy</span><span class="s4">.</span><span class="s1">cyextension</span><span class="s4">.</span><span class="s1">collections </span><span class="s3">import </span><span class="s4">(  </span><span class="s0"># noqa</span>
        <span class="s1">unique_list </span><span class="s3">as </span><span class="s1">unique_list</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s1">_T </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_T&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>
<span class="s1">_KT </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_KT&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>
<span class="s1">_VT </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_VT&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>
<span class="s1">_T_co </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_T_co&quot;</span><span class="s4">, </span><span class="s1">covariant</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

<span class="s1">EMPTY_SET</span><span class="s4">: </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">frozenset</span><span class="s4">()</span>
<span class="s1">NONE_SET</span><span class="s4">: </span><span class="s1">FrozenSet</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s3">None</span><span class="s4">])</span>


<span class="s3">def </span><span class="s1">merge_lists_w_ordering</span><span class="s4">(</span><span class="s1">a</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">b</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;merge two lists, maintaining ordering as much as possible. 
 
    this is to reconcile vars(cls) with cls.__annotations__. 
 
    Example:: 
 
        &gt;&gt;&gt; a = ['__tablename__', 'id', 'x', 'created_at'] 
        &gt;&gt;&gt; b = ['id', 'name', 'data', 'y', 'created_at'] 
        &gt;&gt;&gt; merge_lists_w_ordering(a, b) 
        ['__tablename__', 'id', 'name', 'data', 'y', 'x', 'created_at'] 
 
    This is not necessarily the ordering that things had on the class, 
    in this case the class is:: 
 
        class User(Base): 
            __tablename__ = &quot;users&quot; 
 
            id: Mapped[int] = mapped_column(primary_key=True) 
            name: Mapped[str] 
            data: Mapped[Optional[str]] 
            x = Column(Integer) 
            y: Mapped[int] 
            created_at: Mapped[datetime.datetime] = mapped_column() 
 
    But things are *mostly* ordered. 
 
    The algorithm could also be done by creating a partial ordering for 
    all items in both lists and then using topological_sort(), but that 
    is too much overhead. 
 
    Background on how I came up with this is at: 
    https://gist.github.com/zzzeek/89de958cf0803d148e74861bd682ebae 
 
    &quot;&quot;&quot;</span>
    <span class="s1">overlap </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">a</span><span class="s4">).</span><span class="s1">intersection</span><span class="s4">(</span><span class="s1">b</span><span class="s4">)</span>

    <span class="s1">result </span><span class="s4">= []</span>

    <span class="s1">current</span><span class="s4">, </span><span class="s1">other </span><span class="s4">= </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">a</span><span class="s4">), </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">b</span><span class="s4">)</span>

    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">current</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">element </span><span class="s3">in </span><span class="s1">overlap</span><span class="s4">:</span>
                <span class="s1">overlap</span><span class="s4">.</span><span class="s1">discard</span><span class="s4">(</span><span class="s1">element</span><span class="s4">)</span>
                <span class="s1">other</span><span class="s4">, </span><span class="s1">current </span><span class="s4">= </span><span class="s1">current</span><span class="s4">, </span><span class="s1">other</span>
                <span class="s3">break</span>

            <span class="s1">result</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">element</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">result</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>
            <span class="s3">break</span>

    <span class="s3">return </span><span class="s1">result</span>


<span class="s3">def </span><span class="s1">coerce_to_immutabledict</span><span class="s4">(</span><span class="s1">d</span><span class="s4">: </span><span class="s1">Mapping</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]) </span><span class="s1">-&gt; immutabledict</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]:</span>
    <span class="s3">if not </span><span class="s1">d</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">EMPTY_DICT</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">immutabledict</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">d</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">immutabledict</span><span class="s4">(</span><span class="s1">d</span><span class="s4">)</span>


<span class="s1">EMPTY_DICT</span><span class="s4">: </span><span class="s1">immutabledict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">immutabledict</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">FacadeDict</span><span class="s4">(</span><span class="s1">ImmutableDictBase</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;A dictionary that is not publicly mutable.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; FacadeDict</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s1">new </span><span class="s4">= </span><span class="s1">ImmutableDictBase</span><span class="s4">.</span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">new</span>

    <span class="s3">def </span><span class="s1">copy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; NoReturn</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span>
            <span class="s5">&quot;an immutabledict shouldn't need to be copied.  use dict(d) &quot;</span>
            <span class="s5">&quot;if you need a mutable dictionary.&quot;</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__reduce__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">FacadeDict</span><span class="s4">, (</span><span class="s1">dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">),)</span>

    <span class="s3">def </span><span class="s1">_insert_item</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">_VT</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;insert an item into the dictionary directly.&quot;&quot;&quot;</span>
        <span class="s1">dict</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">&quot;FacadeDict(%s)&quot; </span><span class="s4">% </span><span class="s1">dict</span><span class="s4">.</span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>


<span class="s1">_DT </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_DT&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>

<span class="s1">_F </span><span class="s4">= </span><span class="s1">TypeVar</span><span class="s4">(</span><span class="s5">&quot;_F&quot;</span><span class="s4">, </span><span class="s1">bound</span><span class="s4">=</span><span class="s1">Any</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">Properties</span><span class="s4">(</span><span class="s1">Generic</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Provide a __getattr__/__setattr__ interface over a dict.&quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= (</span><span class="s5">&quot;_data&quot;</span><span class="s4">,)</span>

    <span class="s1">_data</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]):</span>
        <span class="s1">object</span><span class="s4">.</span><span class="s1">__setattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">&quot;_data&quot;</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__len__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()))</span>

    <span class="s3">def </span><span class="s1">__dir__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">dir</span><span class="s4">(</span><span class="s1">super</span><span class="s4">()) + [</span><span class="s1">str</span><span class="s4">(</span><span class="s1">k</span><span class="s4">) </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()]</span>

    <span class="s3">def </span><span class="s1">__add__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">: </span><span class="s1">Properties</span><span class="s4">[</span><span class="s1">_F</span><span class="s4">]) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">, </span><span class="s1">_F</span><span class="s4">]]:</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) + </span><span class="s1">list</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">: </span><span class="s1">_T</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">obj</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; _T</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__delitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__setattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">: </span><span class="s1">_T</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">obj</span>

    <span class="s3">def </span><span class="s1">__getstate__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s4">{</span><span class="s5">&quot;_data&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">}</span>

    <span class="s3">def </span><span class="s1">__setstate__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">state</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">object</span><span class="s4">.</span><span class="s1">__setattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">&quot;_data&quot;</span><span class="s4">, </span><span class="s1">state</span><span class="s4">[</span><span class="s5">&quot;_data&quot;</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; _T</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__contains__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span>

    <span class="s3">def </span><span class="s1">as_readonly</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; ReadOnlyProperties</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return an immutable proxy for this :class:`.Properties`.&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">ReadOnlyProperties</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">overload</span>
    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]: ...</span>

    <span class="s4">@</span><span class="s1">overload</span>
    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_DT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">_DT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]: ...</span>

    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">default</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_DT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">, </span><span class="s1">_DT</span><span class="s4">]]:</span>
        <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">default</span>

    <span class="s3">def </span><span class="s1">keys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">values</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">items</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]]:</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">has_key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span>

    <span class="s3">def </span><span class="s1">clear</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">OrderedProperties</span><span class="s4">(</span><span class="s1">Properties</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Provide a __getattr__/__setattr__ interface with an OrderedDict 
    as backing store.&quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= ()</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">Properties</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">OrderedDict</span><span class="s4">())</span>


<span class="s3">class </span><span class="s1">ReadOnlyProperties</span><span class="s4">(</span><span class="s1">ReadOnlyContainer</span><span class="s4">, </span><span class="s1">Properties</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Provide immutable dict/object attribute to an underlying dictionary.&quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= ()</span>


<span class="s3">def </span><span class="s1">_ordered_dictionary_sort</span><span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Sort an OrderedDict in-place.&quot;&quot;&quot;</span>

    <span class="s1">items </span><span class="s4">= [(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">d</span><span class="s4">[</span><span class="s1">k</span><span class="s4">]) </span><span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s1">key</span><span class="s4">)]</span>

    <span class="s1">d</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>

    <span class="s1">d</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">items</span><span class="s4">)</span>


<span class="s1">OrderedDict </span><span class="s4">= </span><span class="s1">dict</span>
<span class="s1">sort_dictionary </span><span class="s4">= </span><span class="s1">_ordered_dictionary_sort</span>


<span class="s3">class </span><span class="s1">WeakSequence</span><span class="s4">(</span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">__elements</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">] = ()):</span>
        <span class="s0"># adapted from weakref.WeakKeyDictionary, prevent reference</span>
        <span class="s0"># cycles in the collection itself</span>
        <span class="s3">def </span><span class="s1">_remove</span><span class="s4">(</span><span class="s1">item</span><span class="s4">, </span><span class="s1">selfref</span><span class="s4">=</span><span class="s1">weakref</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)):</span>
            <span class="s1">self </span><span class="s4">= </span><span class="s1">selfref</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">self </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_storage</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_remove </span><span class="s4">= </span><span class="s1">_remove</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_storage </span><span class="s4">= [</span>
            <span class="s1">weakref</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">(</span><span class="s1">element</span><span class="s4">, </span><span class="s1">_remove</span><span class="s4">) </span><span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">__elements</span>
        <span class="s4">]</span>

    <span class="s3">def </span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_storage</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">weakref</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">(</span><span class="s1">item</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_remove</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">__len__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_storage</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">(</span>
            <span class="s1">obj </span><span class="s3">for </span><span class="s1">obj </span><span class="s3">in </span><span class="s4">(</span><span class="s1">ref</span><span class="s4">() </span><span class="s3">for </span><span class="s1">ref </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_storage</span><span class="s4">) </span><span class="s3">if </span><span class="s1">obj </span><span class="s3">is not None</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">index</span><span class="s4">):</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">obj </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_storage</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">IndexError</span><span class="s4">(</span><span class="s5">&quot;Index %s out of range&quot; </span><span class="s4">% </span><span class="s1">index</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">obj</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">OrderedIdentitySet</span><span class="s4">(</span><span class="s1">IdentitySet</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">iterable</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">IdentitySet</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_members </span><span class="s4">= </span><span class="s1">OrderedDict</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">iterable</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">o </span><span class="s3">in </span><span class="s1">iterable</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">o</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">PopulateDict</span><span class="s4">(</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;A dict which populates missing values via a creation function. 
 
    Note the creation function takes a key, unlike 
    collections.defaultdict. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">creator</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">_KT</span><span class="s4">], </span><span class="s1">_VT</span><span class="s4">]):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">creator </span><span class="s4">= </span><span class="s1">creator</span>

    <span class="s3">def </span><span class="s1">__missing__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">val </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">creator</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">val</span>


<span class="s3">class </span><span class="s1">WeakPopulateDict</span><span class="s4">(</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Like PopulateDict, but assumes a self + a method and does not create 
    a reference cycle. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">creator_method</span><span class="s4">: </span><span class="s1">types</span><span class="s4">.</span><span class="s1">MethodType</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">creator </span><span class="s4">= </span><span class="s1">creator_method</span><span class="s4">.</span><span class="s1">__func__</span>
        <span class="s1">weakself </span><span class="s4">= </span><span class="s1">creator_method</span><span class="s4">.</span><span class="s1">__self__</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">weakself </span><span class="s4">= </span><span class="s1">weakref</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">(</span><span class="s1">weakself</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__missing__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">val </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">creator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">weakself</span><span class="s4">(), </span><span class="s1">key</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">val</span>


<span class="s0"># Define collections that are capable of storing</span>
<span class="s0"># ColumnElement objects as hashable keys/elements.</span>
<span class="s0"># At this point, these are mostly historical, things</span>
<span class="s0"># used to be more complicated.</span>
<span class="s1">column_set </span><span class="s4">= </span><span class="s1">set</span>
<span class="s1">column_dict </span><span class="s4">= </span><span class="s1">dict</span>
<span class="s1">ordered_column_set </span><span class="s4">= </span><span class="s1">OrderedSet</span>


<span class="s3">class </span><span class="s1">UniqueAppender</span><span class="s4">(</span><span class="s1">Generic</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Appends items to a collection ensuring uniqueness. 
 
    Additional appends() of the same object are ignored.  Membership is 
    determined by identity (``is a``) not equality (``==``). 
    &quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= </span><span class="s5">&quot;data&quot;</span><span class="s4">, </span><span class="s5">&quot;_data_appender&quot;</span><span class="s4">, </span><span class="s5">&quot;_unique&quot;</span>

    <span class="s1">data</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">], </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">], </span><span class="s1">List</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]]</span>
    <span class="s1">_data_appender</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">_T</span><span class="s4">], </span><span class="s3">None</span><span class="s4">]</span>
    <span class="s1">_unique</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">Literal</span><span class="s4">[</span><span class="s3">True</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">data</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">], </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">], </span><span class="s1">List</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]],</span>
        <span class="s1">via</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_unique </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">via</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_data_appender </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">via</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s5">&quot;append&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_data_appender </span><span class="s4">= </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;List[_T]&quot;</span><span class="s4">, </span><span class="s1">data</span><span class="s4">).</span><span class="s1">append</span>
        <span class="s3">elif </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s5">&quot;add&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_data_appender </span><span class="s4">= </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;Set[_T]&quot;</span><span class="s4">, </span><span class="s1">data</span><span class="s4">).</span><span class="s1">add</span>

    <span class="s3">def </span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">item</span><span class="s4">: </span><span class="s1">_T</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">id_ </span><span class="s4">= </span><span class="s1">id</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">id_ </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_unique</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_data_appender</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_unique</span><span class="s4">[</span><span class="s1">id_</span><span class="s4">] = </span><span class="s3">True</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">coerce_generator_arg</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">) == </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">types</span><span class="s4">.</span><span class="s1">GeneratorType</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;List[Any]&quot;</span><span class="s4">, </span><span class="s1">arg</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">x</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">default</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
    <span class="s3">if </span><span class="s1">x </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">default  </span><span class="s0"># type: ignore</span>
    <span class="s3">if not </span><span class="s1">is_non_string_iterable</span><span class="s4">(</span><span class="s1">x</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">x</span><span class="s4">]</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">list</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">x</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">list</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">has_intersection</span><span class="s4">(</span><span class="s1">set_</span><span class="s4">: </span><span class="s1">Container</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">], </span><span class="s1">iterable</span><span class="s4">: </span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
    <span class="s2">r&quot;&quot;&quot;return True if any items of set\_ are present in iterable. 
 
    Goes through special effort to ensure __hash__ is not called 
    on items in iterable that don't support it. 
 
    &quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">any</span><span class="s4">(</span><span class="s1">i </span><span class="s3">in </span><span class="s1">set_ </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">iterable </span><span class="s3">if </span><span class="s1">i</span><span class="s4">.</span><span class="s1">__hash__</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">to_set</span><span class="s4">(</span><span class="s1">x</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">x </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">set</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">set</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">set</span><span class="s4">(</span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">x</span>


<span class="s3">def </span><span class="s1">to_column_set</span><span class="s4">(</span><span class="s1">x</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Set</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]:</span>
    <span class="s3">if </span><span class="s1">x </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">column_set</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">column_set</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">column_set</span><span class="s4">(</span><span class="s1">to_list</span><span class="s4">(</span><span class="s1">x</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">x</span>


<span class="s3">def </span><span class="s1">update_copy</span><span class="s4">(</span><span class="s1">d</span><span class="s4">, </span><span class="s1">_new</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Copy the given dict and update with the given values.&quot;&quot;&quot;</span>

    <span class="s1">d </span><span class="s4">= </span><span class="s1">d</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">_new</span><span class="s4">:</span>
        <span class="s1">d</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">_new</span><span class="s4">)</span>
    <span class="s1">d</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(**</span><span class="s1">kw</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">d</span>


<span class="s3">def </span><span class="s1">flatten_iterator</span><span class="s4">(</span><span class="s1">x</span><span class="s4">: </span><span class="s1">Iterable</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Given an iterator of which further sub-elements may also be 
    iterators, flatten the sub-elements into a single iterator. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">elem</span><span class="s4">: </span><span class="s1">_T</span>
    <span class="s3">for </span><span class="s1">elem </span><span class="s3">in </span><span class="s1">x</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">elem</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">elem</span><span class="s4">, </span><span class="s5">&quot;__iter__&quot;</span><span class="s4">):</span>
            <span class="s3">yield from </span><span class="s1">flatten_iterator</span><span class="s4">(</span><span class="s1">elem</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">elem</span>


<span class="s3">class </span><span class="s1">LRUCache</span><span class="s4">(</span><span class="s1">typing</span><span class="s4">.</span><span class="s1">MutableMapping</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;Dictionary with 'squishy' removal of least 
    recently used items. 
 
    Note that either get() or [] should be used here, but 
    generally its not safe to do an &quot;in&quot; check first as the dictionary 
    can change subsequent to that call. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= (</span>
        <span class="s5">&quot;capacity&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;threshold&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;size_alert&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;_data&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;_counter&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;_mutex&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">capacity</span><span class="s4">: </span><span class="s1">int</span>
    <span class="s1">threshold</span><span class="s4">: </span><span class="s1">float</span>
    <span class="s1">size_alert</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">LRUCache</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">]], </span><span class="s3">None</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">capacity</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">100</span><span class="s4">,</span>
        <span class="s1">threshold</span><span class="s4">: </span><span class="s1">float </span><span class="s4">= </span><span class="s6">0.5</span><span class="s4">,</span>
        <span class="s1">size_alert</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Callable</span><span class="s4">[..., </span><span class="s3">None</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">= </span><span class="s1">capacity</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">threshold </span><span class="s4">= </span><span class="s1">threshold</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">size_alert </span><span class="s4">= </span><span class="s1">size_alert</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_counter </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_mutex </span><span class="s4">= </span><span class="s1">threading</span><span class="s4">.</span><span class="s1">Lock</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">_VT</span><span class="s4">, </span><span class="s1">List</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]]] = {}</span>

    <span class="s3">def </span><span class="s1">_inc_counter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_counter </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_counter</span>

    <span class="s4">@</span><span class="s1">overload</span>
    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">]: ...</span>

    <span class="s4">@</span><span class="s1">overload</span>
    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">default</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]: ...</span>

    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">default</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">, </span><span class="s1">_T</span><span class="s4">]]:</span>
        <span class="s1">item </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">item </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">item</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inc_counter</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s1">item</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">default</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">) </span><span class="s1">-&gt; _VT</span><span class="s4">:</span>
        <span class="s1">item </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
        <span class="s1">item</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inc_counter</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">item</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">_KT</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__len__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">values</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; ValuesView</span><span class="s4">[</span><span class="s1">_VT</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">typing</span><span class="s4">.</span><span class="s1">ValuesView</span><span class="s4">({</span><span class="s1">k</span><span class="s4">: </span><span class="s1">i</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">i </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()})</span>

    <span class="s3">def </span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">_VT</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = (</span><span class="s1">key</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_inc_counter</span><span class="s4">()])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_manage_size</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">__delitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">__v</span><span class="s4">: </span><span class="s1">_KT</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">__v</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">size_threshold</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; float</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">* </span><span class="s1">self</span><span class="s4">.</span><span class="s1">threshold</span>

    <span class="s3">def </span><span class="s1">_manage_size</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_mutex</span><span class="s4">.</span><span class="s1">acquire</span><span class="s4">(</span><span class="s3">False</span><span class="s4">):</span>
            <span class="s3">return</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">size_alert </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">size_alert</span><span class="s4">)</span>
            <span class="s3">while </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) &gt; </span><span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">* </span><span class="s1">self</span><span class="s4">.</span><span class="s1">threshold</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">size_alert</span><span class="s4">:</span>
                    <span class="s1">size_alert </span><span class="s4">= </span><span class="s3">False</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">size_alert</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)  </span><span class="s0"># type: ignore</span>
                <span class="s1">by_counter </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">.</span><span class="s1">values</span><span class="s4">(),</span>
                    <span class="s1">key</span><span class="s4">=</span><span class="s1">operator</span><span class="s4">.</span><span class="s1">itemgetter</span><span class="s4">(</span><span class="s6">2</span><span class="s4">),</span>
                    <span class="s1">reverse</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">by_counter</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">capacity </span><span class="s4">:]:</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">item</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]]</span>
                    <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                        <span class="s0"># deleted elsewhere; skip</span>
                        <span class="s3">continue</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_mutex</span><span class="s4">.</span><span class="s1">release</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">_CreateFuncType</span><span class="s4">(</span><span class="s1">Protocol</span><span class="s4">[</span><span class="s1">_T_co</span><span class="s4">]):</span>
    <span class="s3">def </span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; _T_co</span><span class="s4">: ...</span>


<span class="s3">class </span><span class="s1">_ScopeFuncType</span><span class="s4">(</span><span class="s1">Protocol</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">: ...</span>


<span class="s3">class </span><span class="s1">ScopedRegistry</span><span class="s4">(</span><span class="s1">Generic</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;A Registry that can store one or multiple instances of a single 
    class on the basis of a &quot;scope&quot; function. 
 
    The object implements ``__call__`` as the &quot;getter&quot;, so by 
    calling ``myregistry()`` the contained object is returned 
    for the current scope. 
 
    :param createfunc: 
      a callable that returns a new object to be placed in the registry 
 
    :param scopefunc: 
      a callable that will return a key to store/retrieve an object. 
    &quot;&quot;&quot;</span>

    <span class="s1">__slots__ </span><span class="s4">= </span><span class="s5">&quot;createfunc&quot;</span><span class="s4">, </span><span class="s5">&quot;scopefunc&quot;</span><span class="s4">, </span><span class="s5">&quot;registry&quot;</span>

    <span class="s1">createfunc</span><span class="s4">: </span><span class="s1">_CreateFuncType</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]</span>
    <span class="s1">scopefunc</span><span class="s4">: </span><span class="s1">_ScopeFuncType</span>
    <span class="s1">registry</span><span class="s4">: </span><span class="s1">Any</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">createfunc</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[], </span><span class="s1">_T</span><span class="s4">], </span><span class="s1">scopefunc</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[], </span><span class="s1">Any</span><span class="s4">]</span>
    <span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Construct a new :class:`.ScopedRegistry`. 
 
        :param createfunc:  A creation function that will generate 
          a new value for the current scope, if none is present. 
 
        :param scopefunc:  A function that returns a hashable 
          token representing the current scope (such as, current 
          thread identifier). 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">createfunc </span><span class="s4">= </span><span class="s1">createfunc</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">scopefunc </span><span class="s4">= </span><span class="s1">scopefunc</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">registry </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; _T</span><span class="s4">:</span>
        <span class="s1">key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scopefunc</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]  </span><span class="s0"># type: ignore[no-any-return]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">createfunc</span><span class="s4">())  </span><span class="s0"># type: ignore[no-any-return] # noqa: E501</span>

    <span class="s3">def </span><span class="s1">has</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return True if an object is present in the current scope.&quot;&quot;&quot;</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scopefunc</span><span class="s4">() </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span>

    <span class="s3">def </span><span class="s1">set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">: </span><span class="s1">_T</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Set the value for the current scope.&quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scopefunc</span><span class="s4">()] = </span><span class="s1">obj</span>

    <span class="s3">def </span><span class="s1">clear</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Clear the current scope, if any.&quot;&quot;&quot;</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scopefunc</span><span class="s4">()]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">ThreadLocalRegistry</span><span class="s4">(</span><span class="s1">ScopedRegistry</span><span class="s4">[</span><span class="s1">_T</span><span class="s4">]):</span>
    <span class="s2">&quot;&quot;&quot;A :class:`.ScopedRegistry` that uses a ``threading.local()`` 
    variable for storage. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">createfunc</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[[], </span><span class="s1">_T</span><span class="s4">]):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">createfunc </span><span class="s4">= </span><span class="s1">createfunc</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">registry </span><span class="s4">= </span><span class="s1">threading</span><span class="s4">.</span><span class="s1">local</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; _T</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">value  </span><span class="s0"># type: ignore[no-any-return]</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s1">val </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">value </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">createfunc</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s1">val</span>

    <span class="s3">def </span><span class="s1">has</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">, </span><span class="s5">&quot;value&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">: </span><span class="s1">_T</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">value </span><span class="s4">= </span><span class="s1">obj</span>

    <span class="s3">def </span><span class="s1">clear</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">registry</span><span class="s4">.</span><span class="s1">value</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s3">pass</span>


<span class="s3">def </span><span class="s1">has_dupes</span><span class="s4">(</span><span class="s1">sequence</span><span class="s4">, </span><span class="s1">target</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Given a sequence and search object, return True if there's more 
    than one, False if zero or one of them. 
 
 
    &quot;&quot;&quot;</span>
    <span class="s0"># compare to .index version below, this version introduces less function</span>
    <span class="s0"># overhead and is usually the same speed.  At 15000 items (way bigger than</span>
    <span class="s0"># a relationship-bound collection in memory usually is) it begins to</span>
    <span class="s0"># fall behind the other version only by microseconds.</span>
    <span class="s1">c </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">sequence</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">item </span><span class="s3">is </span><span class="s1">target</span><span class="s4">:</span>
            <span class="s1">c </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">if </span><span class="s1">c </span><span class="s4">&gt; </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s3">return True</span>
    <span class="s3">return False</span>


<span class="s0"># .index version.  the two __contains__ calls as well</span>
<span class="s0"># as .index() and isinstance() slow this down.</span>
<span class="s0"># def has_dupes(sequence, target):</span>
<span class="s0">#    if target not in sequence:</span>
<span class="s0">#        return False</span>
<span class="s0">#    elif not isinstance(sequence, collections_abc.Sequence):</span>
<span class="s0">#        return False</span>
<span class="s0">#</span>
<span class="s0">#    idx = sequence.index(target)</span>
<span class="s0">#    return target in sequence[idx + 1:]</span>
</pre>
</body>
</html>