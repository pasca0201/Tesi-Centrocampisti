<html>
<head>
<title>test_resampler_grouper.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_resampler_grouper.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">dedent</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">compat </span><span class="s0">import </span><span class="s1">is_platform_windows</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">TimedeltaIndex</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">indexes</span><span class="s2">.</span><span class="s1">datetimes </span><span class="s0">import </span><span class="s1">date_range</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">test_frame</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s4">2</span><span class="s2">] * </span><span class="s4">12 </span><span class="s2">+ [</span><span class="s4">3</span><span class="s2">] * </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">40</span><span class="s2">)},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2000&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;s&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">40</span><span class="s2">),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tab_complete_ipython6_warning</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">IPython</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">completer </span><span class="s0">import </span><span class="s1">provisionalcompleter</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s1">dedent</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot;</span><span class="s0">\ 
    </span><span class="s3">import numpy as np 
    from pandas import Series, date_range 
    data = np.arange(10, dtype=np.float64) 
    index = date_range(&quot;2020-01-01&quot;, periods=len(data)) 
    s = Series(data, index=index) 
    rs = s.resample(&quot;D&quot;) 
    &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s1">ip</span><span class="s2">.</span><span class="s1">run_cell</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

    <span class="s5"># GH 31324 newer jedi version raises Deprecation warning;</span>
    <span class="s5">#  appears resolved 2021-02-02</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">raise_on_extra_warnings</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">provisionalcompleter</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">.</span><span class="s1">Completer</span><span class="s2">.</span><span class="s1">completions</span><span class="s2">(</span><span class="s3">&quot;rs.&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_deferred_with_groupby</span><span class="s2">():</span>
    <span class="s5"># GH 12486</span>
    <span class="s5"># support deferred resample ops with groupby</span>
    <span class="s1">data </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-02&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-05&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-10&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-13&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-03&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-04&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-11&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;2010-01-14&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;date&quot;</span><span class="s2">, </span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s3">&quot;score&quot;</span><span class="s2">])</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">date </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">date</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f_0</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">).</span><span class="s1">asfreq</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f_0</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">).</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">).</span><span class="s1">asfreq</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;W&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f_1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;1D&quot;</span><span class="s2">).</span><span class="s1">ffill</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f_1</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;1D&quot;</span><span class="s2">).</span><span class="s1">ffill</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_getitem</span><span class="s2">(</span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">test_frame</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">B</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">())</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">B</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">B</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">().</span><span class="s1">B</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_getitem_multiple</span><span class="s2">():</span>
    <span class="s5"># GH 13174</span>
    <span class="s5"># multiple calls after selection causing an issue with aliasing</span>
    <span class="s1">data </span><span class="s2">= [{</span><span class="s3">&quot;id&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;buyer&quot;</span><span class="s2">: </span><span class="s3">&quot;A&quot;</span><span class="s2">}, {</span><span class="s3">&quot;id&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;buyer&quot;</span><span class="s2">: </span><span class="s3">&quot;B&quot;</span><span class="s2">}]</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;1D&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">r</span><span class="s2">[</span><span class="s3">&quot;buyer&quot;</span><span class="s2">].</span><span class="s1">count</span><span class="s2">()</span>

    <span class="s1">exp_mi </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">], </span><span class="s1">names</span><span class="s2">=(</span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">exp_mi</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;buyer&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">r</span><span class="s2">[</span><span class="s3">&quot;buyer&quot;</span><span class="s2">].</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_on_api_with_getitem</span><span class="s2">():</span>
    <span class="s5"># GH 17813</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;id&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aabbb&quot;</span><span class="s2">), </span><span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1-1-2016&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">), </span><span class="s3">&quot;data&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">).</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">)[</span><span class="s3">&quot;data&quot;</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;id&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">)[</span><span class="s3">&quot;data&quot;</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_with_origin</span><span class="s2">():</span>
    <span class="s5"># GH 31809</span>

    <span class="s1">freq </span><span class="s2">= </span><span class="s3">&quot;1399min&quot;  </span><span class="s5"># prime number that is smaller than 24h</span>
    <span class="s1">start</span><span class="s2">, </span><span class="s1">end </span><span class="s2">= </span><span class="s3">&quot;1/1/2000 00:00:00&quot;</span><span class="s2">, </span><span class="s3">&quot;1/31/2000 00:00&quot;</span>
    <span class="s1">middle </span><span class="s2">= </span><span class="s3">&quot;1/15/2000 00:00:00&quot;</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1231min&quot;</span><span class="s2">)  </span><span class="s5"># prime number</span>
    <span class="s1">ts </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">)), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">ts2 </span><span class="s2">= </span><span class="s1">ts</span><span class="s2">[</span><span class="s1">middle</span><span class="s2">:</span><span class="s1">end</span><span class="s2">]</span>

    <span class="s5"># proves that grouper without a fixed origin does not work</span>
    <span class="s5"># when dealing with unusual frequencies</span>
    <span class="s1">simple_grouper </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s1">freq</span><span class="s2">)</span>
    <span class="s1">count_ts </span><span class="s2">= </span><span class="s1">ts</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">simple_grouper</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">count_ts </span><span class="s2">= </span><span class="s1">count_ts</span><span class="s2">[</span><span class="s1">middle</span><span class="s2">:</span><span class="s1">end</span><span class="s2">]</span>
    <span class="s1">count_ts2 </span><span class="s2">= </span><span class="s1">ts2</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">simple_grouper</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Index are different&quot;</span><span class="s2">):</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">count_ts</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">count_ts2</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s5"># test origin on 1970-01-01 00:00:00</span>
    <span class="s1">origin </span><span class="s2">= </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">adjusted_grouper </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s1">freq</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">origin</span><span class="s2">)</span>
    <span class="s1">adjusted_count_ts </span><span class="s2">= </span><span class="s1">ts</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">adjusted_grouper</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">adjusted_count_ts </span><span class="s2">= </span><span class="s1">adjusted_count_ts</span><span class="s2">[</span><span class="s1">middle</span><span class="s2">:</span><span class="s1">end</span><span class="s2">]</span>
    <span class="s1">adjusted_count_ts2 </span><span class="s2">= </span><span class="s1">ts2</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">adjusted_grouper</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">adjusted_count_ts</span><span class="s2">, </span><span class="s1">adjusted_count_ts2</span><span class="s2">)</span>

    <span class="s5"># test origin on 2049-10-18 20:00:00</span>
    <span class="s1">origin_future </span><span class="s2">= </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) + </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1399min&quot;</span><span class="s2">) * </span><span class="s4">30_000</span>
    <span class="s1">adjusted_grouper2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s1">freq</span><span class="s2">, </span><span class="s1">origin</span><span class="s2">=</span><span class="s1">origin_future</span><span class="s2">)</span>
    <span class="s1">adjusted2_count_ts </span><span class="s2">= </span><span class="s1">ts</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">adjusted_grouper2</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">adjusted2_count_ts </span><span class="s2">= </span><span class="s1">adjusted2_count_ts</span><span class="s2">[</span><span class="s1">middle</span><span class="s2">:</span><span class="s1">end</span><span class="s2">]</span>
    <span class="s1">adjusted2_count_ts2 </span><span class="s2">= </span><span class="s1">ts2</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">adjusted_grouper2</span><span class="s2">).</span><span class="s1">agg</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">adjusted2_count_ts</span><span class="s2">, </span><span class="s1">adjusted2_count_ts2</span><span class="s2">)</span>

    <span class="s5"># both grouper use an adjusted timestamp that is a multiple of 1399 min</span>
    <span class="s5"># they should be equals even if the adjusted_timestamp is in the future</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">adjusted_count_ts</span><span class="s2">, </span><span class="s1">adjusted2_count_ts2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nearest</span><span class="s2">():</span>
    <span class="s5"># GH 17496</span>
    <span class="s5"># Resample nearest</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2000&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;min&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;20s&quot;</span><span class="s2">).</span><span class="s1">nearest</span><span class="s2">()</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s3">&quot;2000-01-01 00:00:00&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:00:20&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:00:40&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:01:00&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:01:20&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:01:40&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2000-01-01 00:02:00&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s2">,</span>
            <span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;20s&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;f&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s3">&quot;first&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;last&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;median&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;sem&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;sum&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;mean&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;min&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;max&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;size&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;count&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;nearest&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;bfill&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ffill&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;asfreq&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ohlc&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_methods</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">test_frame</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">), </span><span class="s1">f</span><span class="s2">)())</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_methods_nunique</span><span class="s2">(</span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s5"># series only</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">test_frame</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">B</span><span class="s2">.</span><span class="s1">nunique</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">B</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">nunique</span><span class="s2">())</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;f&quot;</span><span class="s2">, [</span><span class="s3">&quot;std&quot;</span><span class="s2">, </span><span class="s3">&quot;var&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_methods_std_var</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">test_frame</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)(</span><span class="s1">ddof</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">), </span><span class="s1">f</span><span class="s2">)(</span><span class="s1">ddof</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply</span><span class="s2">(</span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">test_frame</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">r </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">)</span>

    <span class="s5"># reduction</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">f_0</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f_0</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f_1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">y</span><span class="s2">: </span><span class="s1">y</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">())</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f_1</span><span class="s2">)</span>
    <span class="s5"># y.sum() results in int64 instead of int32 on 32-bit architectures</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_with_mutated_index</span><span class="s2">():</span>
    <span class="s5"># GH 15169</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1-1-2015&quot;</span><span class="s2">, </span><span class="s3">&quot;12-31-15&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">index</span><span class="s2">))}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">s</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;ME&quot;</span><span class="s2">)).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;ME&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s5"># A case for series</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;col1&quot;</span><span class="s2">].</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;ME&quot;</span><span class="s2">), </span><span class="s1">group_keys</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;col1&quot;</span><span class="s2">].</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;ME&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_columns_multilevel</span><span class="s2">():</span>
    <span class="s5"># GH 16231</span>
    <span class="s1">cols </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">([(</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">), (</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">)])</span>
    <span class="s1">ind </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;15Min&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">] * </span><span class="s4">16</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">ind</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">cols</span><span class="s2">)</span>
    <span class="s1">agg_dict </span><span class="s2">= {</span><span class="s1">col</span><span class="s2">: (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum </span><span class="s0">if </span><span class="s1">col</span><span class="s2">[</span><span class="s4">3</span><span class="s2">] == </span><span class="s3">&quot;one&quot; </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">}</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;h&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">agg_dict</span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">](</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s4">2 </span><span class="s2">* [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2017-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1h&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">2</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">), (</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">)]</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_non_naive_index</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">weighted_quantile</span><span class="s2">(</span><span class="s1">series</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">, </span><span class="s1">q</span><span class="s2">):</span>
        <span class="s1">series </span><span class="s2">= </span><span class="s1">series</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">()</span>
        <span class="s1">cumsum </span><span class="s2">= </span><span class="s1">weights</span><span class="s2">.</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">series</span><span class="s2">.</span><span class="s1">index</span><span class="s2">).</span><span class="s1">fillna</span><span class="s2">(</span><span class="s4">0</span><span class="s2">).</span><span class="s1">cumsum</span><span class="s2">()</span>
        <span class="s1">cutoff </span><span class="s2">= </span><span class="s1">cumsum</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] * </span><span class="s1">q</span>
        <span class="s0">return </span><span class="s1">series</span><span class="s2">[</span><span class="s1">cumsum </span><span class="s2">&gt;= </span><span class="s1">cutoff</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s1">times </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2017-6-23 18:00&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;15min&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">times</span><span class="s2">)</span>
    <span class="s1">weights </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">160.0</span><span class="s2">, </span><span class="s4">91</span><span class="s2">, </span><span class="s4">65</span><span class="s2">, </span><span class="s4">43</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">times</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">weighted_quantile</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">q</span><span class="s2">=</span><span class="s4">0.5</span><span class="s2">)</span>
    <span class="s1">ind </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span>
        <span class="s3">&quot;2017-06-23 00:00:00+00:00&quot;</span><span class="s2">, </span><span class="s3">&quot;2017-06-23 00:00:00+00:00&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">ind</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_resample_groupby_with_label</span><span class="s2">(</span><span class="s1">unit</span><span class="s2">):</span>
    <span class="s5"># GH 13235</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;2D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">data</span><span class="s2">={</span><span class="s3">&quot;col0&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]})</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;col0&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;1W&quot;</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s3">&quot;left&quot;</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s1">mi </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s3">&quot;1999-12-26&quot;</span><span class="s2">, </span><span class="s3">&quot;2000-01-02&quot;</span><span class="s2">, </span><span class="s3">&quot;2000-01-02&quot;</span><span class="s2">, </span><span class="s3">&quot;2000-01-02&quot;</span><span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s3">f&quot;M8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">mindex </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span><span class="s1">mi</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;col0&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span><span class="s3">&quot;col0&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">mindex</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_consistency_with_window</span><span class="s2">(</span><span class="s1">test_frame</span><span class="s2">):</span>
    <span class="s5"># consistent return values with window</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">test_frame</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2s&quot;</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">nlevels </span><span class="s2">== </span><span class="s4">2</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">levels</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">).</span><span class="s1">rolling</span><span class="s2">(</span><span class="s4">20</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">nlevels </span><span class="s2">== </span><span class="s4">2</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">levels</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_median_duplicate_columns</span><span class="s2">():</span>
    <span class="s5"># GH 14233</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aaa&quot;</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df2</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;5s&quot;</span><span class="s2">).</span><span class="s1">median</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;5s&quot;</span><span class="s2">).</span><span class="s1">median</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_to_one_column_of_df</span><span class="s2">():</span>
    <span class="s5"># GH: 36951</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;col&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;20min&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s5"># access &quot;col&quot; via getattr -&gt; make sure we handle AttributeError</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;h&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">group</span><span class="s2">: </span><span class="s1">group</span><span class="s2">.</span><span class="s1">col</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">())</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;h&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s5"># access &quot;col&quot; via _getitem__ -&gt; make sure we handle KeyErrpr</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;h&quot;</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">group</span><span class="s2">: </span><span class="s1">group</span><span class="s2">[</span><span class="s3">&quot;col&quot;</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">())</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_resample_groupby_agg</span><span class="s2">():</span>
    <span class="s5"># GH: 33548</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;cat&quot;</span><span class="s2">: [</span>
                <span class="s3">&quot;cat_1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;cat_1&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s3">&quot;num&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">50</span><span class="s2">],</span>
            <span class="s3">&quot;date&quot;</span><span class="s2">: [</span>
                <span class="s3">&quot;2019-2-1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2018-02-03&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2020-3-11&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2019-2-2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2019-2-2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2018-12-4&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2020-3-11&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;2020-12-12&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">])</span>

    <span class="s1">resampled </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;cat&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;YE&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">resampled</span><span class="s2">[[</span><span class="s3">&quot;num&quot;</span><span class="s2">]].</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">resampled</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">({</span><span class="s3">&quot;num&quot;</span><span class="s2">: </span><span class="s3">&quot;sum&quot;</span><span class="s2">})</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_resample_groupby_agg_listlike</span><span class="s2">():</span>
    <span class="s5"># GH 42905</span>
    <span class="s1">ts </span><span class="s2">= </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2021-02-28 00:00:00&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;class&quot;</span><span class="s2">: [</span><span class="s3">&quot;beta&quot;</span><span class="s2">], </span><span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s4">69</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s1">ts</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">))</span>
    <span class="s1">resampled </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;class&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;ME&quot;</span><span class="s2">)[</span><span class="s3">&quot;value&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">resampled</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s3">&quot;sum&quot;</span><span class="s2">, </span><span class="s3">&quot;size&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">69</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">([(</span><span class="s3">&quot;beta&quot;</span><span class="s2">, </span><span class="s1">ts</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;class&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">]),</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;sum&quot;</span><span class="s2">, </span><span class="s3">&quot;size&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;keys&quot;</span><span class="s2">, [[</span><span class="s3">&quot;a&quot;</span><span class="s2">], [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">):</span>
    <span class="s5"># GH 26411</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">TimedeltaIndex</span><span class="s2">([]))</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">rule</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s3">&quot;00:00:01&quot;</span><span class="s2">)).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">TimedeltaIndex</span><span class="s2">([]), </span><span class="s1">append</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">:</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">keys</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;consolidate&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_resample_groupby_agg_object_dtype_all_nan</span><span class="s2">(</span><span class="s1">consolidate</span><span class="s2">):</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/39329</span>

    <span class="s1">dates </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">15</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">)</span>
    <span class="s1">df1 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;key&quot;</span><span class="s2">: </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">, </span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">15</span><span class="s2">), </span><span class="s3">&quot;col_object&quot;</span><span class="s2">: </span><span class="s3">&quot;val&quot;</span><span class="s2">})</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;key&quot;</span><span class="s2">: </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">, </span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">15</span><span class="s2">)})</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">], </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">consolidate</span><span class="s2">:</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_consolidate</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">([</span><span class="s3">&quot;key&quot;</span><span class="s2">]).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;W&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">).</span><span class="s1">min</span><span class="s2">()</span>
    <span class="s1">idx </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s3">&quot;B&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">,</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2020-01-05&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-12&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-19&quot;</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">).</span><span class="s1">as_unit</span><span class="s2">(</span>
                <span class="s3">&quot;ns&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s3">&quot;A&quot;</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s3">&quot;B&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">,</span>
            <span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">12</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">,</span>
            <span class="s3">&quot;col_object&quot;</span><span class="s2">: [</span><span class="s3">&quot;val&quot;</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">idx</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_with_list_of_keys</span><span class="s2">():</span>
    <span class="s5"># GH 47362</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">),</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">)[[</span><span class="s3">&quot;val&quot;</span><span class="s2">]].</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s1">mi_exp </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">].</span><span class="s1">_values</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;group&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">mi_exp</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;keys&quot;</span><span class="s2">, [[</span><span class="s3">&quot;a&quot;</span><span class="s2">], [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_resample_no_index</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">):</span>
    <span class="s5"># GH 47705</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">])</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">])</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">rule</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s3">&quot;00:00:01&quot;</span><span class="s2">)).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">]).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;date&quot;</span><span class="s2">, </span><span class="s1">append</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">:</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">keys</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_resample_no_columns</span><span class="s2">():</span>
    <span class="s5"># GH#52484</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s3">&quot;2018-01-01 00:00:00&quot;</span><span class="s2">, </span><span class="s3">&quot;2018-01-01 12:00:00&quot;</span><span class="s2">, </span><span class="s3">&quot;2018-01-02 00:00:00&quot;</span><span class="s2">]</span>
            <span class="s2">),</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]).</span><span class="s1">resample</span><span class="s2">(</span><span class="s1">rule</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s3">&quot;06:00:00&quot;</span><span class="s2">)).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s3">&quot;2018-01-01 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;2018-01-01 06:00:00&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;2018-01-01 12:00:00&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;2018-01-02 00:00:00&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">(</span>
            <span class="s1">levels</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">), </span><span class="s1">index</span><span class="s2">],</span>
            <span class="s1">codes</span><span class="s2">=[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]],</span>
            <span class="s1">names</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s5"># GH#52710 - Index comes out as 32-bit on 64-bit Windows</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">not </span><span class="s1">is_platform_windows</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_size_all_index_same</span><span class="s2">():</span>
    <span class="s5"># GH 46826</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s4">2</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s4">1</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s4">2</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">)},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;31/12/2000 18:00&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;h&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">12</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;DataFrameGroupBy.resample operated on the grouping columns&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">).</span><span class="s1">size</span><span class="s2">()</span>

    <span class="s1">mi_exp </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2000-12-31&quot;</span><span class="s2">, </span><span class="s3">&quot;2001-01-01&quot;</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;M8[ns]&quot;</span><span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s4">3</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">mi_exp</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_on_index_with_list_of_keys</span><span class="s2">():</span>
    <span class="s5"># GH 50840</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">)[[</span><span class="s3">&quot;val&quot;</span><span class="s2">]].</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s1">mi_exp </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;group&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">mi_exp</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_on_index_with_list_of_keys_multi_columns</span><span class="s2">():</span>
    <span class="s5"># GH 50876</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s3">&quot;first_val&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s3">&quot;second_val&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
            <span class="s3">&quot;third_val&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">).</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">)[[</span><span class="s3">&quot;first_val&quot;</span><span class="s2">, </span><span class="s3">&quot;second_val&quot;</span><span class="s2">]].</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s1">mi_exp </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;group&quot;</span><span class="s2">, </span><span class="s3">&quot;date&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;first_val&quot;</span><span class="s2">: [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">],</span>
            <span class="s3">&quot;second_val&quot;</span><span class="s2">: [</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">mi_exp</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_resample_on_index_with_list_of_keys_missing_column</span><span class="s2">():</span>
    <span class="s5"># GH 50876</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">={</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s3">&quot;val&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">8</span><span class="s2">),</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">gb </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">)</span>
    <span class="s1">rs </span><span class="s2">= </span><span class="s1">gb</span><span class="s2">.</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;2D&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Columns not found&quot;</span><span class="s2">):</span>
        <span class="s1">rs</span><span class="s2">[[</span><span class="s3">&quot;val_not_in_dataframe&quot;</span><span class="s2">]]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;kind&quot;</span><span class="s2">, [</span><span class="s3">&quot;datetime&quot;</span><span class="s2">, </span><span class="s3">&quot;period&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_groupby_resample_kind</span><span class="s2">(</span><span class="s1">kind</span><span class="s2">):</span>
    <span class="s5"># GH 24103</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;datetime&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s3">&quot;20181101 1100&quot;</span><span class="s2">, </span><span class="s3">&quot;20181101 1200&quot;</span><span class="s2">, </span><span class="s3">&quot;20181102 1300&quot;</span><span class="s2">, </span><span class="s3">&quot;20181102 1400&quot;</span><span class="s2">]</span>
            <span class="s2">),</span>
            <span class="s3">&quot;group&quot;</span><span class="s2">: [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
            <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;datetime&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;group&quot;</span><span class="s2">)[</span><span class="s3">&quot;value&quot;</span><span class="s2">].</span><span class="s1">resample</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s1">kind</span><span class="s2">).</span><span class="s1">last</span><span class="s2">()</span>

    <span class="s1">dt_level </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2018-11-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2018-11-02&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;period&quot;</span><span class="s2">:</span>
        <span class="s1">dt_level </span><span class="s2">= </span><span class="s1">dt_level</span><span class="s2">.</span><span class="s1">to_period</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">)</span>
    <span class="s1">expected_index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], </span><span class="s1">dt_level</span><span class="s2">],</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;group&quot;</span><span class="s2">, </span><span class="s3">&quot;datetime&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">expected_index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;value&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>