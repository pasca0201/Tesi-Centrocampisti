<html>
<head>
<title>test_pls.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pls.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cross_decomposition </span><span class="s0">import </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">PLSRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cross_decomposition</span><span class="s2">.</span><span class="s1">_pls </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_center_scale_xy</span><span class="s2">,</span>
    <span class="s1">_get_first_singular_vectors_power_method</span><span class="s2">,</span>
    <span class="s1">_get_first_singular_vectors_svd</span><span class="s2">,</span>
    <span class="s1">_svd_flip_1d</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">load_linnerud</span><span class="s2">, </span><span class="s1">make_regression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s1">VotingRegressor</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ConvergenceWarning</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LinearRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">check_random_state</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">extmath </span><span class="s0">import </span><span class="s1">svd_flip</span>


<span class="s0">def </span><span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">M</span><span class="s2">):</span>
    <span class="s1">K </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">M</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">M</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">K</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">K</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">test_pls_canonical_basics</span><span class="s2">():</span>
    <span class="s3"># Basic checks for PLSCanonical</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSCanonical</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_y_scores</span><span class="s2">)</span>

    <span class="s3"># Check X = TP' and Y = UQ'</span>
    <span class="s1">T </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span>
    <span class="s1">P </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_</span>
    <span class="s1">U </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_y_scores</span>
    <span class="s1">Q </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_</span>
    <span class="s3"># Need to scale first</span>
    <span class="s1">Xc</span><span class="s2">, </span><span class="s1">Yc</span><span class="s2">, </span><span class="s1">x_mean</span><span class="s2">, </span><span class="s1">y_mean</span><span class="s2">, </span><span class="s1">x_std</span><span class="s2">, </span><span class="s1">y_std </span><span class="s2">= </span><span class="s1">_center_scale_xy</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">scale</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xc</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">T</span><span class="s2">, </span><span class="s1">P</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Yc</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">U</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>

    <span class="s3"># Check that rotations on training data lead to scores</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">, </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span><span class="s2">)</span>
    <span class="s1">Xt</span><span class="s2">, </span><span class="s1">Yt </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">, </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Yt</span><span class="s2">, </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_y_scores</span><span class="s2">)</span>

    <span class="s3"># Check that inverse_transform works</span>
    <span class="s1">X_back </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_back</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">Y_back </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">, </span><span class="s1">Yt</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Y_back</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sanity_check_pls_regression</span><span class="s2">():</span>
    <span class="s3"># Sanity check for PLSRegression</span>
    <span class="s3"># The results were checked against the R-packages plspm, misOmics and pls</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">X_trans</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s3"># FIXME: one would expect y_trans == pls.y_scores_ but this is not</span>
    <span class="s3"># the case.</span>
    <span class="s3"># xref: https://github.com/scikit-learn/scikit-learn/issues/22420</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_scores_</span><span class="s2">)</span>

    <span class="s1">expected_x_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.61330704</span><span class="s2">, -</span><span class="s4">0.00443647</span><span class="s2">, </span><span class="s4">0.78983213</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.74697144</span><span class="s2">, -</span><span class="s4">0.32172099</span><span class="s2">, -</span><span class="s4">0.58183269</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.25668686</span><span class="s2">, </span><span class="s4">0.94682413</span><span class="s2">, -</span><span class="s4">0.19399983</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_x_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.61470416</span><span class="s2">, -</span><span class="s4">0.24574278</span><span class="s2">, </span><span class="s4">0.78983213</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.65625755</span><span class="s2">, -</span><span class="s4">0.14396183</span><span class="s2">, -</span><span class="s4">0.58183269</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.51733059</span><span class="s2">, </span><span class="s4">1.00609417</span><span class="s2">, -</span><span class="s4">0.19399983</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[+</span><span class="s4">0.32456184</span><span class="s2">, </span><span class="s4">0.29892183</span><span class="s2">, </span><span class="s4">0.20316322</span><span class="s2">],</span>
            <span class="s2">[+</span><span class="s4">0.42439636</span><span class="s2">, </span><span class="s4">0.61970543</span><span class="s2">, </span><span class="s4">0.19320542</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.13143144</span><span class="s2">, -</span><span class="s4">0.26348971</span><span class="s2">, -</span><span class="s4">0.17092916</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[+</span><span class="s4">0.32456184</span><span class="s2">, </span><span class="s4">0.29892183</span><span class="s2">, </span><span class="s4">0.20316322</span><span class="s2">],</span>
            <span class="s2">[+</span><span class="s4">0.42439636</span><span class="s2">, </span><span class="s4">0.61970543</span><span class="s2">, </span><span class="s4">0.19320542</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.13143144</span><span class="s2">, -</span><span class="s4">0.26348971</span><span class="s2">, -</span><span class="s4">0.17092916</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_loadings</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_weights</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_loadings</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_weights</span><span class="s2">))</span>

    <span class="s3"># The R / Python difference in the signs should be consistent across</span>
    <span class="s3"># loadings, weights, etc.</span>
    <span class="s1">x_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_ </span><span class="s2">/ </span><span class="s1">expected_x_loadings</span><span class="s2">)</span>
    <span class="s1">x_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_ </span><span class="s2">/ </span><span class="s1">expected_x_weights</span><span class="s2">)</span>
    <span class="s1">y_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_ </span><span class="s2">/ </span><span class="s1">expected_y_weights</span><span class="s2">)</span>
    <span class="s1">y_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_ </span><span class="s2">/ </span><span class="s1">expected_y_loadings</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x_loadings_sign_flip</span><span class="s2">, </span><span class="s1">x_weights_sign_flip</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_loadings_sign_flip</span><span class="s2">, </span><span class="s1">y_weights_sign_flip</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sanity_check_pls_regression_constant_column_Y</span><span class="s2">():</span>
    <span class="s3"># Check behavior when the first column of Y is constant</span>
    <span class="s3"># The results are checked against a modified version of plsreg2</span>
    <span class="s3"># from the R-package plsdepot</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">Y</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">1</span>
    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">expected_x_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.6273573</span><span class="s2">, </span><span class="s4">0.007081799</span><span class="s2">, </span><span class="s4">0.7786994</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.7493417</span><span class="s2">, -</span><span class="s4">0.277612681</span><span class="s2">, -</span><span class="s4">0.6011807</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.2119194</span><span class="s2">, </span><span class="s4">0.960666981</span><span class="s2">, -</span><span class="s4">0.1794690</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_x_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.6273512</span><span class="s2">, -</span><span class="s4">0.22464538</span><span class="s2">, </span><span class="s4">0.7786994</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.6643156</span><span class="s2">, -</span><span class="s4">0.09871193</span><span class="s2">, -</span><span class="s4">0.6011807</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.5125877</span><span class="s2">, </span><span class="s4">1.01407380</span><span class="s2">, -</span><span class="s4">0.1794690</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0.0000000</span><span class="s2">, </span><span class="s4">0.0000000</span><span class="s2">, </span><span class="s4">0.0000000</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.4357300</span><span class="s2">, </span><span class="s4">0.5828479</span><span class="s2">, </span><span class="s4">0.2174802</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.1353739</span><span class="s2">, -</span><span class="s4">0.2486423</span><span class="s2">, -</span><span class="s4">0.1810386</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_weights</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_loadings</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_</span><span class="s2">))</span>
    <span class="s3"># For the PLSRegression with default parameters, y_loadings == y_weights</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_loadings</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_loadings</span><span class="s2">))</span>

    <span class="s1">x_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">expected_x_loadings </span><span class="s2">/ </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_</span><span class="s2">)</span>
    <span class="s1">x_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">expected_x_weights </span><span class="s2">/ </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">)</span>
    <span class="s3"># we ignore the first full-zeros row for y</span>
    <span class="s1">y_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">expected_y_loadings</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] / </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:])</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_loadings_sign_flip</span><span class="s2">, </span><span class="s1">x_weights_sign_flip</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_loadings_sign_flip</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:], </span><span class="s1">y_loadings_sign_flip</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sanity_check_pls_canonical</span><span class="s2">():</span>
    <span class="s3"># Sanity check for PLSCanonical</span>
    <span class="s3"># The results were checked against the R-package plspm</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSCanonical</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">expected_x_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.61330704</span><span class="s2">, </span><span class="s4">0.25616119</span><span class="s2">, -</span><span class="s4">0.74715187</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.74697144</span><span class="s2">, </span><span class="s4">0.11930791</span><span class="s2">, </span><span class="s4">0.65406368</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.25668686</span><span class="s2">, -</span><span class="s4">0.95924297</span><span class="s2">, -</span><span class="s4">0.11817271</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_x_rotations </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s4">0.61330704</span><span class="s2">, </span><span class="s4">0.41591889</span><span class="s2">, -</span><span class="s4">0.62297525</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.74697144</span><span class="s2">, </span><span class="s4">0.31388326</span><span class="s2">, </span><span class="s4">0.77368233</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.25668686</span><span class="s2">, -</span><span class="s4">0.89237972</span><span class="s2">, -</span><span class="s4">0.24121788</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[+</span><span class="s4">0.58989127</span><span class="s2">, </span><span class="s4">0.7890047</span><span class="s2">, </span><span class="s4">0.1717553</span><span class="s2">],</span>
            <span class="s2">[+</span><span class="s4">0.77134053</span><span class="s2">, -</span><span class="s4">0.61351791</span><span class="s2">, </span><span class="s4">0.16920272</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.23887670</span><span class="s2">, -</span><span class="s4">0.03267062</span><span class="s2">, </span><span class="s4">0.97050016</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_rotations </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[+</span><span class="s4">0.58989127</span><span class="s2">, </span><span class="s4">0.7168115</span><span class="s2">, </span><span class="s4">0.30665872</span><span class="s2">],</span>
            <span class="s2">[+</span><span class="s4">0.77134053</span><span class="s2">, -</span><span class="s4">0.70791757</span><span class="s2">, </span><span class="s4">0.19786539</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.23887670</span><span class="s2">, -</span><span class="s4">0.00343595</span><span class="s2">, </span><span class="s4">0.94162826</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_rotations_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_rotations</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_weights</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_rotations_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_rotations</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_weights</span><span class="s2">))</span>

    <span class="s1">x_rotations_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_rotations_ </span><span class="s2">/ </span><span class="s1">expected_x_rotations</span><span class="s2">)</span>
    <span class="s1">x_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_ </span><span class="s2">/ </span><span class="s1">expected_x_weights</span><span class="s2">)</span>
    <span class="s1">y_rotations_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_rotations_ </span><span class="s2">/ </span><span class="s1">expected_y_rotations</span><span class="s2">)</span>
    <span class="s1">y_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_ </span><span class="s2">/ </span><span class="s1">expected_y_weights</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x_rotations_sign_flip</span><span class="s2">, </span><span class="s1">x_weights_sign_flip</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_rotations_sign_flip</span><span class="s2">, </span><span class="s1">y_weights_sign_flip</span><span class="s2">)</span>

    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">)</span>

    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_y_scores</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sanity_check_pls_canonical_random</span><span class="s2">():</span>
    <span class="s3"># Sanity check for PLSCanonical on random data</span>
    <span class="s3"># The results were checked against the R-package plspm</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s4">500</span>
    <span class="s1">p_noise </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">q_noise </span><span class="s2">= </span><span class="s4">5</span>
    <span class="s3"># 2 latents vars:</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s4">11</span><span class="s2">)</span>
    <span class="s1">l1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">l2 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">latents </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">l1</span><span class="s2">, </span><span class="s1">l1</span><span class="s2">, </span><span class="s1">l2</span><span class="s2">, </span><span class="s1">l2</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">latents </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">latents </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">p_noise </span><span class="s2">* </span><span class="s1">n</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p_noise</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">q_noise </span><span class="s2">* </span><span class="s1">n</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">q_noise</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSCanonical</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">expected_x_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0.65803719</span><span class="s2">, </span><span class="s4">0.19197924</span><span class="s2">, </span><span class="s4">0.21769083</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.7009113</span><span class="s2">, </span><span class="s4">0.13303969</span><span class="s2">, -</span><span class="s4">0.15376699</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.13528197</span><span class="s2">, -</span><span class="s4">0.68636408</span><span class="s2">, </span><span class="s4">0.13856546</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.16854574</span><span class="s2">, -</span><span class="s4">0.66788088</span><span class="s2">, -</span><span class="s4">0.12485304</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.03232333</span><span class="s2">, -</span><span class="s4">0.04189855</span><span class="s2">, </span><span class="s4">0.40690153</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.1148816</span><span class="s2">, -</span><span class="s4">0.09643158</span><span class="s2">, </span><span class="s4">0.1613305</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.04792138</span><span class="s2">, -</span><span class="s4">0.02384992</span><span class="s2">, </span><span class="s4">0.17175319</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.06781</span><span class="s2">, -</span><span class="s4">0.01666137</span><span class="s2">, -</span><span class="s4">0.18556747</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.00266945</span><span class="s2">, -</span><span class="s4">0.00160224</span><span class="s2">, </span><span class="s4">0.11893098</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.00849528</span><span class="s2">, -</span><span class="s4">0.07706095</span><span class="s2">, </span><span class="s4">0.1570547</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.00949471</span><span class="s2">, -</span><span class="s4">0.02964127</span><span class="s2">, </span><span class="s4">0.34657036</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.03572177</span><span class="s2">, </span><span class="s4">0.0945091</span><span class="s2">, </span><span class="s4">0.3414855</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.05584937</span><span class="s2">, -</span><span class="s4">0.02028961</span><span class="s2">, -</span><span class="s4">0.57682568</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.05744254</span><span class="s2">, -</span><span class="s4">0.01482333</span><span class="s2">, -</span><span class="s4">0.17431274</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_x_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0.65649254</span><span class="s2">, </span><span class="s4">0.1847647</span><span class="s2">, </span><span class="s4">0.15270699</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.67554234</span><span class="s2">, </span><span class="s4">0.15237508</span><span class="s2">, -</span><span class="s4">0.09182247</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.19219925</span><span class="s2">, -</span><span class="s4">0.67750975</span><span class="s2">, </span><span class="s4">0.08673128</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.2133631</span><span class="s2">, -</span><span class="s4">0.67034809</span><span class="s2">, -</span><span class="s4">0.08835483</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.03178912</span><span class="s2">, -</span><span class="s4">0.06668336</span><span class="s2">, </span><span class="s4">0.43395268</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.15684588</span><span class="s2">, -</span><span class="s4">0.13350241</span><span class="s2">, </span><span class="s4">0.20578984</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.03337736</span><span class="s2">, -</span><span class="s4">0.03807306</span><span class="s2">, </span><span class="s4">0.09871553</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.06199844</span><span class="s2">, </span><span class="s4">0.01559854</span><span class="s2">, -</span><span class="s4">0.1881785</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.00406146</span><span class="s2">, -</span><span class="s4">0.00587025</span><span class="s2">, </span><span class="s4">0.16413253</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.00374239</span><span class="s2">, -</span><span class="s4">0.05848466</span><span class="s2">, </span><span class="s4">0.19140336</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.00139214</span><span class="s2">, -</span><span class="s4">0.01033161</span><span class="s2">, </span><span class="s4">0.32239136</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.05292828</span><span class="s2">, </span><span class="s4">0.0953533</span><span class="s2">, </span><span class="s4">0.31916881</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.04031924</span><span class="s2">, -</span><span class="s4">0.01961045</span><span class="s2">, -</span><span class="s4">0.65174036</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.06172484</span><span class="s2">, -</span><span class="s4">0.06597366</span><span class="s2">, -</span><span class="s4">0.1244497</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0.66101097</span><span class="s2">, </span><span class="s4">0.18672553</span><span class="s2">, </span><span class="s4">0.22826092</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.69347861</span><span class="s2">, </span><span class="s4">0.18463471</span><span class="s2">, -</span><span class="s4">0.23995597</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.14462724</span><span class="s2">, -</span><span class="s4">0.66504085</span><span class="s2">, </span><span class="s4">0.17082434</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.22247955</span><span class="s2">, -</span><span class="s4">0.6932605</span><span class="s2">, -</span><span class="s4">0.09832993</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.07035859</span><span class="s2">, </span><span class="s4">0.00714283</span><span class="s2">, </span><span class="s4">0.67810124</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.07765351</span><span class="s2">, -</span><span class="s4">0.0105204</span><span class="s2">, -</span><span class="s4">0.44108074</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.00917056</span><span class="s2">, </span><span class="s4">0.04322147</span><span class="s2">, </span><span class="s4">0.10062478</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.01909512</span><span class="s2">, </span><span class="s4">0.06182718</span><span class="s2">, </span><span class="s4">0.28830475</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.01756709</span><span class="s2">, </span><span class="s4">0.04797666</span><span class="s2">, </span><span class="s4">0.32225745</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">expected_y_loadings </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0.68568625</span><span class="s2">, </span><span class="s4">0.1674376</span><span class="s2">, </span><span class="s4">0.0969508</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.68782064</span><span class="s2">, </span><span class="s4">0.20375837</span><span class="s2">, -</span><span class="s4">0.1164448</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.11712173</span><span class="s2">, -</span><span class="s4">0.68046903</span><span class="s2">, </span><span class="s4">0.12001505</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.17860457</span><span class="s2">, -</span><span class="s4">0.6798319</span><span class="s2">, -</span><span class="s4">0.05089681</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.06265739</span><span class="s2">, -</span><span class="s4">0.0277703</span><span class="s2">, </span><span class="s4">0.74729584</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.0914178</span><span class="s2">, </span><span class="s4">0.00403751</span><span class="s2">, -</span><span class="s4">0.5135078</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.02196918</span><span class="s2">, -</span><span class="s4">0.01377169</span><span class="s2">, </span><span class="s4">0.09564505</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s4">0.03288952</span><span class="s2">, </span><span class="s4">0.09039729</span><span class="s2">, </span><span class="s4">0.31858973</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0.04287624</span><span class="s2">, </span><span class="s4">0.05254676</span><span class="s2">, </span><span class="s4">0.27836841</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_loadings</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_x_weights</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_loadings</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">expected_y_weights</span><span class="s2">))</span>

    <span class="s1">x_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_loadings_ </span><span class="s2">/ </span><span class="s1">expected_x_loadings</span><span class="s2">)</span>
    <span class="s1">x_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_ </span><span class="s2">/ </span><span class="s1">expected_x_weights</span><span class="s2">)</span>
    <span class="s1">y_weights_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_ </span><span class="s2">/ </span><span class="s1">expected_y_weights</span><span class="s2">)</span>
    <span class="s1">y_loadings_sign_flip </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_loadings_ </span><span class="s2">/ </span><span class="s1">expected_y_loadings</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">x_loadings_sign_flip</span><span class="s2">, </span><span class="s1">x_weights_sign_flip</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_loadings_sign_flip</span><span class="s2">, </span><span class="s1">y_weights_sign_flip</span><span class="s2">)</span>

    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">)</span>

    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_x_scores</span><span class="s2">)</span>
    <span class="s1">assert_matrix_orthogonal</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">_y_scores</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_convergence_fail</span><span class="s2">():</span>
    <span class="s3"># Make sure ConvergenceWarning is raised if max_iter is too small</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">pls_nipals </span><span class="s2">= </span><span class="s1">PLSCanonical</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">ConvergenceWarning</span><span class="s2">):</span>
        <span class="s1">pls_nipals</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Est&quot;</span><span class="s2">, (</span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_attibutes_shapes</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">):</span>
    <span class="s3"># Make sure attributes are of the correct shape depending on n_components</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s4">2</span>
    <span class="s1">pls </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">)</span>
    <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span>
        <span class="s1">attr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">n_components </span><span class="s0">for </span><span class="s1">attr </span><span class="s0">in </span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">, </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">y_weights_</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Est&quot;</span><span class="s2">, (</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_univariate_equivalence</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">):</span>
    <span class="s3"># Ensure 2D Y with 1 column is equivalent to 1D Y</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">one_d_coeff </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]).</span><span class="s1">coef_</span>
    <span class="s1">two_d_coeff </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">[:, :</span><span class="s4">1</span><span class="s2">]).</span><span class="s1">coef_</span>

    <span class="s0">assert </span><span class="s1">one_d_coeff</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">two_d_coeff</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">one_d_coeff</span><span class="s2">, </span><span class="s1">two_d_coeff</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Est&quot;</span><span class="s2">, (</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">):</span>
    <span class="s3"># check that the &quot;copy&quot; keyword works</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">X_orig </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s3"># copy=True won't modify inplace</span>
    <span class="s1">pls </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_orig</span><span class="s2">)</span>

    <span class="s3"># copy=False will modify inplace</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">Est</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_orig</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">Est </span><span class="s0">is </span><span class="s1">PLSSVD</span><span class="s2">:</span>
        <span class="s0">return  </span><span class="s3"># PLSSVD does not support copy param in predict or transform</span>

    <span class="s1">X_orig </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">pls</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_orig</span><span class="s2">)</span>

    <span class="s1">X_orig </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">pls</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_orig</span><span class="s2">)</span>

    <span class="s3"># Make sure copy=True gives same transform and predictions as predict=False</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">pls</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">pls</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_generate_test_scale_and_stability_datasets</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Generate dataset for test_scale_and_stability&quot;&quot;&quot;</span>
    <span class="s3"># dataset for non-regression 7818</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s4">1000</span>
    <span class="s1">n_targets </span><span class="s2">= </span><span class="s4">5</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">Q </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_targets</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">) + </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) + </span><span class="s4">1</span>
    <span class="s1">X </span><span class="s2">*= </span><span class="s4">1000</span>
    <span class="s0">yield </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span>

    <span class="s3"># Data set where one of the features is constraint</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s3"># causes X[:, -1].std() to be zero</span>
    <span class="s1">X</span><span class="s2">[:, -</span><span class="s4">1</span><span class="s2">] = </span><span class="s4">1.0</span>
    <span class="s0">yield </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">], [</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">]])</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.1</span><span class="s2">, -</span><span class="s4">0.2</span><span class="s2">], [</span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">], [</span><span class="s4">6.2</span><span class="s2">, </span><span class="s4">5.9</span><span class="s2">], [</span><span class="s4">11.9</span><span class="s2">, </span><span class="s4">12.3</span><span class="s2">]])</span>
    <span class="s0">yield </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span>

    <span class="s3"># Seeds that provide a non-regression test for #18746, where CCA fails</span>
    <span class="s1">seeds </span><span class="s2">= [</span><span class="s4">530</span><span class="s2">, </span><span class="s4">741</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">seed </span><span class="s0">in </span><span class="s1">seeds</span><span class="s2">:</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">yield </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Est&quot;</span><span class="s2">, (</span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;X, Y&quot;</span><span class="s2">, </span><span class="s1">_generate_test_scale_and_stability_datasets</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_scale_and_stability</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;scale=True is equivalent to scale=False on centered/scaled data 
    This allows to check numerical stability over platforms as well&quot;&quot;&quot;</span>

    <span class="s1">X_s</span><span class="s2">, </span><span class="s1">Y_s</span><span class="s2">, *</span><span class="s1">_ </span><span class="s2">= </span><span class="s1">_center_scale_xy</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">X_score</span><span class="s2">, </span><span class="s1">Y_score </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">X_s_score</span><span class="s2">, </span><span class="s1">Y_s_score </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_s</span><span class="s2">, </span><span class="s1">Y_s</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_s_score</span><span class="s2">, </span><span class="s1">X_score</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Y_s_score</span><span class="s2">, </span><span class="s1">Y_score</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Estimator&quot;</span><span class="s2">, (</span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_n_components_upper_bounds</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the validation of `n_components` upper bounds for `PLS` regressors.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s5">&quot;`n_components` upper bound is .*. Got 10 instead. Reduce `n_components`.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_samples, n_features&quot;</span><span class="s2">, [(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">100</span><span class="s2">, </span><span class="s4">200</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_singular_value_helpers</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s3"># Make sure SVD and power method give approximately the same results</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">make_regression</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span>
    <span class="s2">)</span>
    <span class="s1">u1</span><span class="s2">, </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">_get_first_singular_vectors_power_method</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">norm_y_weights</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">u2</span><span class="s2">, </span><span class="s1">v2 </span><span class="s2">= </span><span class="s1">_get_first_singular_vectors_svd</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">_svd_flip_1d</span><span class="s2">(</span><span class="s1">u1</span><span class="s2">, </span><span class="s1">v1</span><span class="s2">)</span>
    <span class="s1">_svd_flip_1d</span><span class="s2">(</span><span class="s1">u2</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">)</span>

    <span class="s1">rtol </span><span class="s2">= </span><span class="s4">1e-3</span>
    <span class="s3"># Setting atol because some coordinates are very close to zero</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u1</span><span class="s2">, </span><span class="s1">u2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">u2</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() * </span><span class="s1">rtol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">v2</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() * </span><span class="s1">rtol</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_component_equivalence</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s3"># PLSSVD, PLSRegression and PLSCanonical should all be equivalent when</span>
    <span class="s3"># n_components is 1</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">make_regression</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">svd </span><span class="s2">= </span><span class="s1">PLSSVD</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">reg </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">canonical </span><span class="s2">= </span><span class="s1">PLSCanonical</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">rtol </span><span class="s2">= </span><span class="s4">1e-3</span>
    <span class="s3"># Setting atol because some entries are very close to zero</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">svd</span><span class="s2">, </span><span class="s1">reg</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">reg</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() * </span><span class="s1">rtol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">svd</span><span class="s2">, </span><span class="s1">canonical</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">canonical</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() * </span><span class="s1">rtol</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_svd_flip_1d</span><span class="s2">():</span>
    <span class="s3"># Make sure svd_flip_1d is equivalent to svd_flip</span>
    <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>

    <span class="s1">u_expected</span><span class="s2">, </span><span class="s1">v_expected </span><span class="s2">= </span><span class="s1">svd_flip</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">v</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">_svd_flip_1d</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)  </span><span class="s3"># inplace</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u_expected</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">])</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">v_expected</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_loadings_converges</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that CCA converges. Non-regression test for #19549.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_regression</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">200</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">n_targets</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span>
    <span class="s2">)</span>

    <span class="s1">cca </span><span class="s2">= </span><span class="s1">CCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">500</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s5">&quot;error&quot;</span><span class="s2">, </span><span class="s1">ConvergenceWarning</span><span class="s2">)</span>

        <span class="s1">cca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s3"># Loadings converges to reasonable values</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">cca</span><span class="s2">.</span><span class="s1">x_loadings_</span><span class="s2">) &lt; </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pls_constant_y</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Checks warning when y is constant. Non-regression test for #19831&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">42</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;y residual is constant at iteration&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">pls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">x_rotations_</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;PLSEstimator&quot;</span><span class="s2">, [</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_coef_shape</span><span class="s2">(</span><span class="s1">PLSEstimator</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the shape of `coef_` attribute. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/12410 
    &quot;&quot;&quot;</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSEstimator</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">n_targets</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_targets</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;scale&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;PLSEstimator&quot;</span><span class="s2">, [</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_prediction</span><span class="s2">(</span><span class="s1">PLSEstimator</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of the prediction function.&quot;&quot;&quot;</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSEstimator</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">scale</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">Y_pred </span><span class="s2">= </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">y_mean </span><span class="s2">= </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">X </span><span class="s2">- </span><span class="s1">X</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">intercept_</span><span class="s2">, </span><span class="s1">y_mean</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Y_pred</span><span class="s2">, </span><span class="s1">X_trans </span><span class="s2">@ </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">.</span><span class="s1">T </span><span class="s2">+ </span><span class="s1">pls</span><span class="s2">.</span><span class="s1">intercept_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Klass&quot;</span><span class="s2">, [</span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_feature_names_out</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check `get_feature_names_out` cross_decomposition module.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">names_out </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>

    <span class="s1">class_name_lower </span><span class="s2">= </span><span class="s1">Klass</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
    <span class="s1">expected_names_out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">class_name_lower</span><span class="s0">}{</span><span class="s1">i</span><span class="s0">}</span><span class="s5">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">est</span><span class="s2">.</span><span class="s1">x_weights_</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">names_out</span><span class="s2">, </span><span class="s1">expected_names_out</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Klass&quot;</span><span class="s2">, [</span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_set_output</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check `set_output` in cross_decomposition module.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">as_frame</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">Klass</span><span class="s2">().</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;pandas&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">X_trans</span><span class="s2">, </span><span class="s1">y_trans </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">y_trans</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">est</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_pls_regression_fit_1d_y</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that when fitting with 1d `y`, prediction should also be 1d. 
 
    Non-regression test for Issue #26549. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">16</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">25</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">36</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">42</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">plsr </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">plsr</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s3"># Check that it works in VotingRegressor</span>
    <span class="s1">lr </span><span class="s2">= </span><span class="s1">LinearRegression</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">vr </span><span class="s2">= </span><span class="s1">VotingRegressor</span><span class="s2">([(</span><span class="s5">&quot;lr&quot;</span><span class="s2">, </span><span class="s1">lr</span><span class="s2">), (</span><span class="s5">&quot;plsr&quot;</span><span class="s2">, </span><span class="s1">plsr</span><span class="s2">)])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">vr</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pls_regression_scaling_coef</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that when using `scale=True`, the coefficients are using the std. dev. from 
    both `X` and `Y`. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/27964 
    &quot;&quot;&quot;</span>
    <span class="s3"># handcrafted data where we can predict Y from X with an additional scaling factor</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">coef </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">30</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))  </span><span class="s3"># add a std of 10</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">X </span><span class="s2">@ </span><span class="s1">coef</span><span class="s2">.</span><span class="s1">T</span>

    <span class="s3"># we need to make sure that the dimension of the latent space is large enough to</span>
    <span class="s3"># perfectly predict `Y` from `X` (no information loss)</span>
    <span class="s1">pls </span><span class="s2">= </span><span class="s1">PLSRegression</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">coef</span><span class="s2">)</span>

    <span class="s3"># we therefore should be able to predict `Y` from `X`</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pls</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s3"># TODO(1.7): Remove</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Klass&quot;</span><span class="s2">, [</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_fit_warning_on_deprecated_Y_argument</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">):</span>
    <span class="s3"># Test warning message is shown when using Y instead of y</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;`Y` is deprecated in 1.5 and will be removed in 1.7. Use `y` instead.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">err_msg1 </span><span class="s2">= </span><span class="s5">&quot;Cannot use both `y` and `Y`. Use only `y` as `Y` is deprecated.&quot;</span>
    <span class="s0">with </span><span class="s2">(</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg1</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">err_msg2 </span><span class="s2">= </span><span class="s5">&quot;y is required.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg2</span><span class="s2">):</span>
        <span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s3"># TODO(1.7): Remove</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Klass&quot;</span><span class="s2">, [</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSSVD</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_transform_warning_on_deprecated_Y_argument</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">):</span>
    <span class="s3"># Test warning message is shown when using Y instead of y</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">plsr </span><span class="s2">= </span><span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;`Y` is deprecated in 1.5 and will be removed in 1.7. Use `y` instead.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">plsr</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">err_msg1 </span><span class="s2">= </span><span class="s5">&quot;Cannot use both `y` and `Y`. Use only `y` as `Y` is deprecated.&quot;</span>
    <span class="s0">with </span><span class="s2">(</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg1</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">plsr</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s3"># TODO(1.7): Remove</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Klass&quot;</span><span class="s2">, [</span><span class="s1">PLSRegression</span><span class="s2">, </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pls_inverse_transform_warning_on_deprecated_Y_argument</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">):</span>
    <span class="s3"># Test warning message is shown when using Y instead of y</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">load_linnerud</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">plsr </span><span class="s2">= </span><span class="s1">Klass</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_transformed</span><span class="s2">, </span><span class="s1">y_transformed </span><span class="s2">= </span><span class="s1">plsr</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;`Y` is deprecated in 1.5 and will be removed in 1.7. Use `y` instead.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">plsr</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X_transformed</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">y_transformed</span><span class="s2">)</span>

    <span class="s1">err_msg1 </span><span class="s2">= </span><span class="s5">&quot;Cannot use both `y` and `Y`. Use only `y` as `Y` is deprecated.&quot;</span>
    <span class="s0">with </span><span class="s2">(</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg1</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">plsr</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X_transformed</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y_transformed</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">y_transformed</span><span class="s2">)</span>
</pre>
</body>
</html>